{
    "document_name": "33503-i10.docx",
    "content": [
        {
            "title": "Foreword",
            "description": "This Technical Specification has been produced by the 3rd Generation Partnership Project (3GPP).\nThe contents of the present document are subject to continuing work within the TSG and may change following formal TSG approval. Should the TSG modify the contents of the present document, it will be re-released by the TSG with an identifying change of release date and an increase in version number as follows:\nVersion x.y.z\nwhere:\nx\tthe first digit:\n1\tpresented to TSG for information;\n2\tpresented to TSG for approval;\n3\tor greater indicates TSG approved document under change control.\ny\tthe second digit is incremented for all changes of substance, i.e. technical enhancements, corrections, updates, etc.\nz\tthe third digit is incremented when editorial only changes have been incorporated in the document.\nIn the present document, modal verbs have the following meanings:\nshall\tindicates a mandatory requirement to do something\nshall not\tindicates an interdiction (prohibition) to do something\nThe constructions \"shall\" and \"shall not\" are confined to the context of normative provisions, and do not appear in Technical Reports.\nThe constructions \"must\" and \"must not\" are not used as substitutes for \"shall\" and \"shall not\". Their use is avoided insofar as possible, and they are not used in a normative context except in a direct citation from an external, referenced, non-3GPP document, or so as to maintain continuity of style when extending or modifying the provisions of such a referenced document.\nshould\tindicates a recommendation to do something\nshould not\tindicates a recommendation not to do something\nmay\tindicates permission to do something\nneed not\tindicates permission not to do something\nThe construction \"may not\" is ambiguous and is not used in normative elements. The unambiguous constructions \"might not\" or \"shall not\" are used instead, depending upon the meaning intended.\ncan\tindicates that something is possible\ncannot\tindicates that something is impossible\nThe constructions \"can\" and \"cannot\" are not substitutes for \"may\" and \"need not\".\nwill\tindicates that something is certain or expected to happen as a result of action taken by an agency the behaviour of which is outside the scope of the present document\nwill not\tindicates that something is certain or expected not to happen as a result of action taken by an agency the behaviour of which is outside the scope of the present document\nmight\tindicates a likelihood that something will happen as a result of action taken by some agency the behaviour of which is outside the scope of the present document\nmight not\tindicates a likelihood that something will not happen as a result of action taken by some agency the behaviour of which is outside the scope of the present document\nIn addition:\nis\t(or any other verb in the indicative mood) indicates a statement of fact\nis not\t(or any other negative verb in the indicative mood) indicates a statement of fact\nThe constructions \"is\" and \"is not\" do not indicate requirements.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "1\tScope",
            "description": "The present document specifies the security and privacy aspects of the Proximity based Services (ProSe) in the 5G System (5GS). 5G ProSe security features include: 5G ProSe Direct Discovery security, 5G ProSe Direct communication security, 5G ProSe UE-to-Network Relay security, 5G ProSe UE-to-UE Relay security and security of emergency services for 5G ProSe Remote UE via 5G ProSe UE-to-Network Relay.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "2\tReferences",
            "description": "The following documents contain provisions which, through reference in this text, constitute provisions of the present document.\n-\tReferences are either specific (identified by date of publication, edition number, version number, etc.) or non-specific.\n-\tFor a specific reference, subsequent revisions do not apply.\n-\tFor a non-specific reference, the latest version applies. In the case of a reference to a 3GPP document (including a GSM document), a non-specific reference implicitly refers to the latest version of that document in the same Release as the present document.\n[1]\t3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".\n[2]\t3GPP TS 23.304: \"Proximity based Services (ProSe) in the 5G System (5GS)\".\n[3]\t3GPP TS 33.501: \"Security architecture and procedures for 5G system\".\n[4]\t3GPP TS 33.303: \"Proximity-based Services (ProSe); Security aspects\".\n[5]\t3GPP TS 33.535: \"Authentication and Key Management for Applications (AKMA) based on 3GPP credentials in the 5G System (5GS)\".\n[6]\t3GPP TS 33.536: \"Security aspects of 3GPP support for advanced Vehicle-to-Everything (V2X) services\".\n[7]\t3GPP TS 23.503: \"Policy and charging control framework for the 5G System (5GS); Stage 2\".\n[8]\t3GPP TS 33.220: \"Generic Authentication Architecture (GAA); Generic Bootstrapping Architecture (GBA)\".\n[9]\t3GPP TS 33.223: \"Generic Authentication Architecture (GAA); Generic Bootstrapping Architecture (GBA) Push function\".\n[10]\t3GPP TS 23.502: \"Procedures for the 5G System\".\n[11]\t3GPP TS 33.102: \"3G security; Security architecture\".\n[12]\tVoid\n[13]\tVoid\n[14]\tIETF RFC 7542: \"The Network Access Identifier\".\n[15]\tIETF RFC 9048: \" Improved Extensible Authentication Protocol Method for 3rd Generation Authentication and Key Agreement (EAP-AKA')\".\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "3\tDefinitions of terms, symbols and abbreviations",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "3.1\tTerms",
                    "description": "",
                    "summary": "",
                    "text_content": "For the purposes of the present document, the terms given in 3GPP TR 21.905 [1] and the following apply. A term defined in the present document takes precedence over the definition of the same term, if any, in 3GPP TR 21.905 [1].\nFor the purposes of the present document, the following terms given in 3GPP TS 23.304 [2] apply:\n5G ProSe Direct Communication\n5G ProSe Direct Discover\n5G ProSe-enabled UE\n5G ProSe End UE\n5G ProSe Remote UE\n5G ProSe UE-to-Network Relay\n5G ProSe UE-to-UE Relay\nDirect Network Communication\nDiscovery Filter\nDiscovery Query Filter\nDiscovery Response Filter\nIndirect Network Communication\nMode of communication\nModel A\nModel B\nOpen ProSe Discovery\nProSe Application Code\nProSe Application ID\nProSe Application Mask\nProSe Query Code\nProSe Response Code\nProSe Restricted Code\nRestricted ProSe Application User ID\nRestricted ProSe Discovery\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "3.2\tSymbols",
                    "description": "",
                    "summary": "",
                    "text_content": "Void.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "3.3\tAbbreviations",
                    "description": "",
                    "summary": "",
                    "text_content": "For the purposes of the present document, the abbreviations given in TR 21.905 [1] and the following apply. An abbreviation defined in the present document takes precedence over the definition of the same abbreviation, if any, in TR 21.905 [1].\n5G DDNMF\t5G Direct Discovery Name Management Function\n5G PKMF\t5G ProSe Key Management Function\nCP-PRUK\tControl Plane ProSe Remote User Key\nAF\tApplication Function\nAKMA\tAuthentication and Key Management for Applications\nAV\tAuthentication Vector\nBSF\tBootstrapping Server Function\nCP\tControl Plane\nDCR\tDirect Communication Request\nDUCK\tDiscovery User Confidentiality Key\nDUIK\tDiscovery User Integrity Key\nDUSK\tDiscovery User Scrambling Key\nGBA\tGeneric Bootstrapping Architecture\nGPI\tGBA Push Info\nGPS\tGlobal Positioning System\nMIC\tMessage Integrity Check\nNAI\tNetwork Access Identifier\nNITZ\tNetwork Identity and Time Zone\nNRPEK\tNR PC5 Encryption Key\nNRPIK\tNR PC5 Integrity Key\nNTP\tNetwork Time Protocol\nPAnF\tProse Anchor Function\nProSe\tProximity-based Services\nRPAUID\tRestricted ProSe Application User ID\nRSC\tRelay Service Code\nSBI\tService Based Interface\nUP\tUser Plane\nUP-PRUK\tUser Plane Prose Remote User Key\nUTC\tUniversal Time Coordinated\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "4\tOverview",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "4.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The overall architecture for 5G ProSe is given in TS 23.304 [2]. 5G ProSe includes several features that may be deployed independently of each other. For this reason, no overall security architecture is provided and each feature describes its own architecture.\nSecurity for the 5G ProSe common procedures is described in clause 5, while the overall security of the 5G ProSe features is described in clause 6.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "4.2\tReference points and functional entities",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "4.2.1\tFunctional entities",
                            "text_content": "Architectural reference model is specified in clause 4.2.1, 4.2.2, 4.2.3, 4.2.7, and 4.2.8 of TS 23.304 [2].\nIn addition to the architectural reference model specified in TS 23.304 [2], the architectural reference model shall support the functional entity 5G ProSe Key Management Function (5G PKMF) which is the logical function handling network related actions required for the key management and the security material for discovery of a 5G ProSe UE-to-Network Relay by a 5G ProSe Remote UE, for establishing a secure PC5 communication link between a 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay, for discovery of a 5G ProSe UE-to-UE Relay by a 5G ProSe End UE, and for establishing a secure PC5 communication link between a 5G ProSe End UE and a 5G ProSe UE-to-UE Relay.\nFor 5G ProSe UE-to-Network Relay discovery and communication, the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay know from which 5G ProSe Key Management Function(s) to get the needed discovery security materials for protecting discovery messages and UP-PRUK(s) for establishing a secure PC5 link between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay as the address of the 5G PKMF(s) is either pre-provisioned or provided by the 5G DDNMF (or the PCF) in the HPLMN of the 5G ProSe Remote UE to the 5G ProSe Remote UE, and by the 5G DDNMF (or the PCF) in the HPLMN of the 5G ProSe UE-to-Network Relay to the 5G ProSe UE-to-Network Relay.\nThe 5G PKMF of the 5G ProSe Remote UE shall request the discovery security materials from the 5G PKMFs of the potential 5G ProSe UE-to-Network Relays from which the 5G ProSe Remote UE gets the relay services.\nThe 5G PKMF of the 5G ProSe UE-to-Network Relay shall request the security materials (e.g. Knrp and Knrp freshness parameter) from the 5G PKMF of the 5G ProSe Remote UE for PC5 communication.\nFor 5G ProSe UE-to-UE Relay discovery and communication, the 5G ProSe End UE plays the role of the 5G ProSe Remote UE, and the 5G ProSe UE-to-UE Relay plays the role of the 5G ProSe UE-to-Network Relay.\nThe 5G PKMF interacts with the 5G ProSe-enabled UE using procedures over PC8 reference point defined in clause 4.2.2. The protection for the key request/response messages are described in clause 5.2.5.\nIn addition to the architectural reference model specified in TS 23.304 [2], the architectural reference model shall support the functional entity Prose Anchor Function (PAnF) which is the logical function handling network related actions required for the key management and the security material for establishing a secure PC5 communication link between a 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay over Control Plane, and for establishing a secure PC5 communication link between a 5G ProSe End UE and a 5G ProSe UE-to-UE Relay over Control Plane.\nThe PAnF shall store the Prose context info (i.e. SUPI, RSC, CP-PRUK, CP-PRUK ID) for a 5G ProSe Remote UE and the Prose context info for a 5G Prose End UE.\nThe PAnF interacts with AUSF using procedures over Npc11 reference point defined in clause 4.2.2. The PAnF interacts with UDM using procedures over Npc12 reference point defined in clause 4.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "4.2.2\tReference points",
                            "text_content": "In addition to the reference points are specified in clause 4.2.5 of TS 23.304 [2], the 5G Prose architectural reference model shall support the following reference points:\nPC8:\tThe reference point between the UE and the 5G ProSe Key Management Function (5G PKMF). PC8 relies on 5GC user plane for transport (i.e. an \"over IP\" reference point). It is used to transport security material to UEs for 5G ProSe UE-to-Network Relay discovery and communication, and to transport security material to UEs for 5G ProSe UE-to-UE Relay discovery and communication.\nNpc9:\tThe reference point between the 5G PKMF of the 5G ProSe Remote UE and the 5G PKMF of the 5G ProSe UE-to-Network Relay, and between the 5G PKMF of the 5G ProSe End UE and the 5G PKMF of the 5G ProSe UE-to-UE Relay. It is used to transport security material between two 5G PKMFs.\nNpc10:\tThe reference point between the UDM and the 5G PKMF. It is used to de-conceal SUCI to gain SUPI, obtain a GBA Authentication Vector (AV) for a UE, or request relay service authorization information from the UDM.\nNpc11:\tThe reference point between the AUSF and Prose Anchor Function (PAnF). It is used to store the Prose context info for a 5G ProSe Remote UE, and to store the Prose context info for a 5G ProSe End UE.\nNpc12:\tThe reference point between the PAnF and UDM. It is used to check with the UDM whether the Remote UE is authorized to use the UE-to-Network Relay service, and to check with the UDM whether the End UE is authorized to use the UE-to-UE Relay service.\nNpc13:\tThe reference point between the SMF and PKMF. It is used to obtain the SUPI of Remote UE from PKMF.\nNpc14:\tThe reference point between the SMF and PAnF. It is used to obtain the SUPI of Remote UE from PAnF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "5\tCommon security procedures",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "5.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause describes the security requirements and procedures that are commonly applied to different modes of ProSe communication, including unicast mode ProSe Direct Network Communication and unicast mode ProSe Indirect Network Communication via the 5G ProSe UE-to-Network Relay.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.2\tNetwork domain security",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.2.1\tGeneral",
                            "text_content": "5G Prose uses several interfaces between network entities, e.g. Npc4 between the 5G DDNMF and the UDM, Npc8 between the 5G DDNMF and the PCF (see TS 23.304 [2]). This clause describes the security for those interfaces.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.2\tSecurity of Npc2 reference point",
                            "text_content": "Npc2 is the reference point between the ProSe Application Server and the 5G DDNMF as specified in clause 4 of TS 23.304 [2]. When the ProSe Application Server is in a 3rd party's network, the Npc2 comprises two interfaces, i.e. the service-based interface between the 5G DDNMF and the NEF, and the N33 interface between the NEF and the Prose Application Server. When the Prose Application Server is in a MNO's network, the Npc2 is a purely service-based interface.\nWhen the ProSe Application Server is controlled by a 3rd party, requirements on security aspects of NEF are captured in clause 5.9.2.3 of TS 33.501 [3].\nWhen the ProSe Application Server is controlled by a 3rd party, security procedures specified in clause 12 of TS 33.501 [3] is applicable.\nWhen the Prose Application Server is controlled by a MNO, security procedures specified in clause 13 of TS 33.501 [3] is applicable.\nAs specified in TS 23.304 [2], the 5G System architecture supports the service based Npc2 interface between 5G DDNMF and ProSe Application Server and optionally supports PC2 interface between the 5G DDNMF and the ProSe Application Server. The security of PC2 reference point specified in TS 33.303 [4] shall be reused.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.3\tSecurity of UE - 5G DDNMF interface",
                            "text_content": "PC3a is the reference point between the 5G Prose-enabled UE and the 5G DDNMF as specified in clause 4.2.5 of TS 23.304 [2].\n3rd parties shall not be allowed to provide configuration data impacting the 5G ProSe-related network operations to the 5G ProSe-enabled UE. The 5G ProSe-enabled UE and the 5G DDNMF shall mutually authenticate each other.\nThe transmission of the material for 5G Prose discovery between the 5G DDNMF and the 5G ProSe-enabled UE shall be integrity protected.\nThe transmission of the material for 5G Prose discovery between the 5G DDNMF and the 5G ProSe-enabled UE shall be confidentiality protected.\nThe transmission of the material for 5G Prose discovery between the 5G DDNMF and the 5G ProSe-enabled UE shall be protected from replays.\nSee clause 5.3.3.1 in TS 33.303 [4].\nFor the security procedures for protecting data transfer between the UE and the 5G DDNMF on the PC3a interface, the use of either TLS v1.2 or TLS v. 1.3, as described in clause 5.3.3.2 in TS 33.303 [4] applies with the following modifications:\n-\tThe ProSe function is replaced by the 5G DDNMF.\n-\tConfidentiality protection shall be enabled.\nSecurity procedures specified in clause B.1.3.2 of TS 33.535 [5] is applicable with the additional changes:\n-\tThe 5G DDNMF takes the role of AF.\n-\tConfidentiality protection shall be enabled.\nPC3a interface will be used to transfer the configuration data that is used to perform 5G ProSe Direct Discovery. According to clause 6.3.1.4 of TS 23.304 [2], the UE identity is included in the Discovery Request message. Privacy of UE identity is ensured by the confidentiality protection over PC3a interface.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.4\tSecurity of service-based interfaces used in 5G Prose",
                            "text_content": "The 5G Prose network entities shall be able to authenticate the source of the received data communications.\nThe transmission of data between 5G Prose network entities shall be integrity protected.\nThe transmission of data between 5G Prose network entities shall be confidentiality protected.\nThe transmission of data between 5G Prose network entities shall be protected from replays.\nNpc4, Npc6, Npc7, Npc8, Npc9 and Npc10 specified in clause 4.2.5 of TS 23.304 [2], Npc11 and Npc12 specified in clause 4.2.2 are realized by corresponding NF service-based interfaces, therefore security procedures specified in clause 13 of TS 33.501 [3] apply to these interfaces.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.5\tSecurity for UE - 5G PKMF interface",
                            "text_content": "The 5G ProSe-enabled UEs have interactions with the 5G PKMF over the PC8 interface in the ProSe features described in clause 4.2.2.\nThe 5G PKMF for commercial services and for public safety services provides the security keys and security material affecting the 5G ProSe-related network operations to the 5G ProSe-enabled UE for discovery of a 5G ProSe UE-to-Network Relay, PC5 communication with a 5G ProSe UE-to-Network Relay, discovery of a 5G ProSe UE-to-UE Relay, and PC5 communication with a 5G ProSe UE-to-UE Relay.\nThe 5G ProSe-enabled UE and the 5G PKMF shall mutually authenticate each other.\nThe 5G System shall support that the transmission of the security keys and security material between the 5G PKMF and the 5G ProSe-enabled UE shall be integrity protected.\nThe 5G System shall support that the transmission of the security keys and security material between the 5G PKMF and the 5G ProSe-enabled UE shall be confidentiality protected.\nThe 5G System shall support that the transmission of the security keys and security material between the 5G PKMF and the 5G ProSe-enabled UE shall be protected from replays.\nThe 5G System shall support that the transmission of the UE identity on the PC8 interface shall be confidentiality protected.\nFor the security procedures for protecting data transfer between the UE and the 5G PKMF on the PC8 interface, the use of either TLS v1.2 or TLS v. 1.3, as described in clause 5.3.3.2 of TS 33.303 [4] applies with the following modifications:\n-\tThe ProSe function is replaced by the 5G PKMF.\n-\tConfidentiality protection shall be enabled.\nSecurity procedures specified in clause B.1.3.2 of TS 33.535 [5] is applicable with the additional change:\n-\tThe 5G PKMF takes the role of AF.\n-\tConfidentiality protection shall be enabled.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "6\tSecurity for 5G ProSe features",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "6.1\tSecurity for 5G ProSe Discovery",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.1.1\tGeneral",
                            "text_content": "This clause describes the security requirements and procedures that are specifically applied to 5G ProSe Discovery defined in TS 23.304[2].\nThe security requirements for 5G ProSe Discovery are defined in clause 6.1.2.\nThe security procedures for open 5G ProSe Direct Discovery are defined in clause 6.1.3.1, the security procedures for restricted 5G ProSe Direct Discovery are defined in clause 6.1.3.2, the security procedures for 5G ProSe UE-to-UE Relay Discovery are defined in clause 6.1.3.3.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "61.2\tSecurity requirements",
                            "text_content": "The 5G System shall support integrity protection and replay protection of discovery messages in open 5G ProSe Direct Discovery.\nThe 5G System shall support confidentiality protection, integrity protection and replay protection of discovery messages in restricted 5G ProSe Direct Discovery.\nThe 5G System shall support a method to verify source authenticity of discovery messages.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.1.3\tSecurity procedures",
                            "text_content": "The open 5G ProSe Direct Discovery security procedure is described as follows.\nFigure 6.1.3.1-1 illustrates the Open 5G ProSe Direct Discovery security procedure, which involves the authentication and authorization of devices within a 5G network. The figure showcases the process of device registration, where a new device connects to the network and authenticates itself to the network operator. The operator then verifies the device's identity and grants it access to the network. This process ensures that only authorized devices can connect to the 5G network, enhancing security and privacy. The figure also highlights the use of cryptographic techniques, such as encryption and digital signatures, to protect the data transmitted over the network.\nFigure 6.1.3.1-1: Open 5G ProSe Direct Discovery security procedure\n1.\tThe Announcing UE sends a Discovery Request message containing the ProSe Application ID to the 5G DDNMF in its HPLMN in order to be allowed to announce a code on its serving PLMN (either VPLMN or HPLMN).\n2.\tIf the Announcing UE wants to send announcements in the VPLMN, it needs to be authorized from the VPLMN 5G DDNMF. The 5G DDNMF in the HPLMN requests authorization from the VPLMN 5G DDNMF by sending Announce Auth.() message.\n3.\tVPLMN 5G DDNMF responds with an Announce Auth. Ack () message, if authorization is granted. There are no changes to these messages for the purpose of protecting the transmitted code for open 5G ProSe Direct Discovery. If the Announcing UE is not roaming, these steps do not take place.\n4.\tThe 5G DDNMF in HPLMN of the Announcing UE returns the ProSe Application Code that the Announcing UE can announce and a Discovery Key associated with it. The 5G DDNMF stores the Discovery Key with the ProSe Application Code. In addition, the 5G DDNMF provides the UE with a CURRENT_TIME parameter, which contains the current UTC-based time at the 5G DDNMF, a MAX_OFFSET parameter, and a Validity Timer. The UE sets a clock which is used for ProSe authentication (i.e. ProSe clock) to the value of CURRENT_TIME and the UE stores the MAX_OFFSET parameter, overwriting any previous values. The Announcing UE obtains a value for a UTC-based counter associated with a discovery slot based on UTC time. The counter is set to a value of UTC time in a granularity of seconds. The UE may obtain UTC time from any sources available, e.g. the RAN via SIB9, NITZ, NTP, GPS, via Ub interface (in GBA) (depending on which is available).\nNOTE 1:\tThe UE may use unprotected time to obtain the UTC-based counter associated with a discovery slot. This means that the discovery message could be successfully replayed if a UE is fooled into using a time different to the current time. The MAX_OFFSET parameter is used to limit the ability of an attacker to successfully replay discovery messages or obtain correctly MICed discovery message for later use. This is achieved by using MAX_OFFSET as a maximum difference between the UTC-based counter associated with the discovery slot and the ProSe clock held by the UE.\nNOTE 2:\tA discovery slot is the time at which an Announcing UE sends the announcement.\n5.\tThe Announcing UE starts announcing, if the difference between UTC-based counter provided by the system associated with the discovery slot and the UE's ProSe clock is not greater than the MAX_OFFSET and if the Validity Timer has not expired. For each discovery slot it uses to announce, the Announcing UE calculates a 32-bit Message Integrity Check (MIC) to include with the ProSe Application Code in the discovery message. Four least significant bits of UTC-based counter are transmitted along with the discovery message. The MIC is calculated as described in clause  A.6 using the Discovery Key and the UTC-based counter associated with the discovery slot.\n6.\tThe Monitoring UE sends a Discovery Request message containing the ProSe Application ID to the 5G DDNMF in its HPLMN in order to get the Discovery Filters that it wants to listen for.\n7.\tThe 5G DDNMF in the HPLMN of the Monitoring UE sends Monitor Req. message to the 5G DDNMF in the HPLMN of the Announcing UE.\n8.\tThe 5G DDNMF in the HPLMN of the Announcing UE sends Monitor Resp. message to the 5G DDNMF in the HPLMN of the Monitoring UE.\n9.\tThe 5G DDNMF returns the Discovery Filter containing either the ProSe Application Code(s), the ProSe Application Mask(s) or both along with the CURRENT_TIME and the MAX_OFFSET parameters. The Monitoring UE sets its ProSe clock to CURRENT_TIME and stores the MAX_OFFSET parameter, overwriting any previous values. The Monitoring UE obtains a value for a UTC-based counter associated with a discovery slot based on UTC time. The counter is set to a value of UTC time in a granularity of seconds. The Monitoring UE may obtain UTC time from any sources available, e.g. the RAN via SIB9, NITZ, NTP, GPS (depending on which is available).\n10.\tThe Monitoring UE listens for a discovery message that satisfies its Discovery Filter, if the difference between UTC-based counter associated with that discovery slot and UE's ProSe clock is not greater than the MAX_OFFSET of the Monitoring UE's ProSe clock.\n11.\tOn hearing such a discovery message, and if the UE has either not checked the MIC for the discovered ProSe App Code via Match Report previously or has checked a MIC for the ProSe App Code via Match Report and the associated Match Report refresh timer (see steps 14 and 15 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], the Monitoring UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe App Code and MIC. If a Match Report is not required, the Monitoring UE shall locally process the discovery message and the rest of the procedure is not performed.\n12.\tThe 5G DDNMF in the HPLMN of the Monitoring UE passes the discovery message parameters including the ProSe Application Code and MIC and associated counter parameter to the 5G DDNMF in the HPLMN of the Announcing UE in the Match Report message.\n13.\tThe 5G DDNMF in the HPLMN of the Announcing UE shall check the MIC is valid. The relevant Discovery Key is identified by the ProSe Application Code.\n14.\tThe 5G DDNMF in the HPLMN of the Announcing UE shall acknowledge a successful check of the MIC to the 5G DDNMF in the HPLMN of the Monitoring UE via the Match Report Ack message. The 5G DDNMF in the HPLMN of the Announcing UE include a Match Report refresh timer in the Match Report Ack message. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Application Code.\n15.\tThe 5G DDNMF in the HPLMN of the Monitoring UE acknowledges the MIC check result to the Monitoring UE. The 5G DDNMF returns the parameter ProSe Application ID to the UE. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Monitoring UE may optionally modify the received Match Report refresh timer based on local policy and then include the Match Report refresh timer in the message to the Monitoring UE.\nThe security for both models of restricted 5G ProSe Direct Discovery is similar to that of open 5G ProSe Direct Discovery described in clause 6.1.3.1. Both models also use a UTC-based counter (see step 9 in clause 6.1.3.1) to provide freshness for the protection of the restricted 5G ProSe Direct Discovery message on the PC5 interface. The parameters CURRENT_TIME and MAX_OFFSET are also provided to the UE from the 5G DDNMF in its HPLMN to ensure that the obtained UTC-based counter is sufficiently close to real time to protect against replays.\nThe major differences are that restricted 5G ProSe Direct Discovery requires confidentiality protection of the discovery messages (e.g. to ensure a UE's privacy is not disclosed to unauthorized parties or tracked due to constantly sending the same ProSe Restricted/Response Code in the clear) and that the MIC checking may be performed by the receiving UE (if allowed by the 5G DDNMF).\nThe security parameters needed by a sending UE to protect a discovery message (i.e. in Model A the Announcing UE and in Model B the Discoverer UE sending the ProSe Query Code and the Discoveree UE sending the ProSe Response Code) are provided in the Code-Sending Security Parameters. Similarly, the security parameters needed by a UE receiving a discovery message (i.e. in Model A the Monitoring UE and in Model B the Discoverer UE receiving a ProSe Response Code and the Discoveree receiving a ProSe Query Code) are provided in the Code-Receiving Security Parameters.\nIn addition to clause 6.1.3.4.1 in TS 33.303 [4], 5G Prose introduced two new features:\n-\tDuring the discovery request procedure, 5G DDNMF may optionally provide the PC5 security policies to the UEs.\n-\tA ciphering algorithm for message-specific confidentiality is configured at the UE during the Discovery Request procedure.\n5G ProSe UE-to-Network Relay discovery is different from 5G ProSe Restricted Direct Discovery. In 5G ProSe UE-to-Network Relay discovery, the discovery security materials are provided by the PKMF for RSC(s)  representing user-plane based security procedure, and by the DDNMF or the PCF for RSC(s) with Control Plane Security Indicator set representing  control-plane based security procedure. The 5G ProSe UE-to-Network Relay discovery procedures described in clause 6.1.3.2.2.1 and clause 6.1.3.2.2.2 apply with adjustment when 5G DDNMF or 5G PKMF is used for 5G ProSe UE-to-Network Relay discovery.\nThe security procedure for restricted 5G ProSe Direct Discovery Model A is described as follows.\nFigure 6.1.3.2.2.1-1 illustrates a security procedure for restricted 5G ProSe Direct Discovery Model A, detailing the steps and protocols involved in ensuring secure communication and data exchange within the 5G network. The figure outlines the authentication and authorization processes, encryption methods, and monitoring mechanisms to prevent unauthorized access and potential security threats. Key components include the 5G network infrastructure, end devices, and security management systems, emphasizing the importance of secure communication in the rapidly evolving 5G ecosystem.\nFigure 6.1.3.2.2.1-1: Security procedure for restricted 5G ProSe Direct Discovery Model A\nNOTE 1: When the user-plane based security procedure for the UE-to-Network Relay is used, the 5G PKMF takes the role of the 5G DDNMF as described in clause 6.3.3.2 of the present document.\nSteps 1-4 refer to an Announcing UE:\n1.\tAnnouncing UE sends a Discovery Request message containing the Restricted ProSe Application User ID (RPAUID) to the 5G DDNMF in its HPLMN in order to get the ProSe Code to announce and to get the associated security material. In addition, the Announcing UE shall include its PC5 UE security capability that contains the list of supported ciphering algorithms by the UE in the Discovery Request message.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G ProSe UE-to-Network Relay plays the role of the Announcing UE and sends a Relay Discovery Key Request instead of a Discovery Request. The Relay Discovery Key Request message includes the Relay Service Code (RSC) and the 5G ProSe UE-to-Network Relay's PC5 security capability.\n2.\tThe 5G DDNMF may check for the announce authorization with the ProSe Application Server.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF may check with the UDM whether the UE-to-Network relay is authorized to announce UE-to-Network relay discovery message.\n3.\tIf the Announcing UE is roaming, the 5G DDNMFs in the HPLMN and VPLMN of the Announcing UE exchange Announce Auth.\nFor 5G ProSe UE-to-Network Relay discovery, Npkmf_Discovery_AnnounceAuthorize service operation is used to obtain the authorization from the 5G PKMF for announcing in the PLMN.\n4.\tThe 5G DDNMF in the HPLMN of the Announcing UE returns the ProSe Restricted Code and the corresponding Code-Sending Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The Code-Sending Security Parameters provide the necessary information for the Announcing UE to protect the transmission of the ProSe Restricted Code and are stored with the ProSe Restricted Code. The Announcing UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of clause 6.1.3.1 of the present document. The 5G DDNMF in the HPLMN of the Announcing UE shall include the chosen PC5 ciphering algorithm in the Discovery Response message. The 5G DDNMF determines the chosen PC5 ciphering algorithm based on the ProSe Restricted Code and the received PC5 UE security capability in step 1. The UE stores the chosen PC5 ciphering algorithm together with the ProSe Restricted Code.\nIn addition, the 5G DDNMF in the HPLMN of the Announcing UE may associate the ProSe Restricted Code with the PC5 security policies and include the PC5 security policies in the Discovery Response message.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.\nNOTE 2:\t5G DDNMF may get the PC5 security policies in different ways (e.g. from PCF, from ProSe Application Server, or based on local configuration).\nSteps 5-10 refer to a Monitoring UE:\n5.\tThe Monitoring UE sends a Discovery Request message containing the RPAUID and its PC5 UE security capability to the 5G DDNMF in its HPLMN in order to be allowed to monitor for one or more Restricted ProSe Application User IDs.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G ProSe Remote UE plays the role of the Monitoring UE and sends a Relay Discovery Key Request instead of the Discovery Request. The Relay Discovery Key Request message includes the RSC and the 5G ProSe Remote UE's PC5 security capability. The Remote UE may provide a list of PLMNs in which the UE is authorized to use a 5G ProSe U2N Relay. in the Relay Discovery Key Request.\n6.\tThe 5G DDNMF in the HPLMN of the Monitoring UE sends an authorization request to the ProSe Application Server. If, based on the permission settings, the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF of the Remote UE may check with the UDM whether the Remote UE is authorized to monitor UE-to-Network relay discovery.\n7.\tIf the Discovery Request is authorized, the 5G DDNMF in the HPLMN of the Monitoring UE contacts the 5G DDNMF in the HPLMN of the Announcing UE by sending a Monitor Request message, as specified in clause 6.3 of TS 23.304 [2], including the PC5 UE security capability received in step 5.\nFor 5G ProSe UE-to-Network Relay Discovery, Relay Discovery Key Request and RSC are used instead of Discovery Request and RPAUID. The 5G DDNMF of the remote UE discovers 5G DDNMF(s) of the potential 5G ProSe UE-to-Network relay(s) supporting the RSC based on HPLMNs of the potential 5G ProSe UE-to-Network relay(s) mapping to the RSC. Npkmf_Discovery_MonitorKey service operation is used to obtain the discovery key from the 5G PKMF for monitoring in the PLMN.\nNOTE 2a:\t5G DDNMF may get the HPLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).\n8.\tThe 5G DDNMF in the HPLMN of the Announcing UE may exchange authorization messages with the ProSe Application Server.\nFor 5G ProSe UE-to-Network Relay discovery, this step is skipped.\n9.\tIf the PC5 UE security capability in step 5 includes the chosen PC5 ciphering algorithm, the 5G DDNMF in the HPLMN of the Announcing UE responds to the 5G DDNMF in the HPLMN of the Monitoring UE with a Monitor Response message including the ProSe Restricted Code, the corresponding Code-Receiving Security Parameters, an optional Discovery User Integrity Key (DUIK), and the chosen PC5 ciphering algorithm (based on the information/keys stored in step 4). The Code-Receiving Security Parameters provide the information needed by the Monitoring UE to undo the protection applied by the Announcing UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Monitoring UE use Match Reports for MIC checking. The 5G DDNMF in the HPLMN of the Monitoring UE stores the ProSe Restricted Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters).\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Monitor Response, and the RSC is used instead of the ProSe Restricted Code. Npkmf_Discovery_MonitorKey service operation is used to obtain the discovery key from the 5G PKMF for monitoring in the PLMN.\nThe 5G DDNMF in the HPLMN of the Announcing UE may send the PC5 security policies associated with the ProSe Restricted Code to the 5G DDNMF in the HPLMN of the Monitoring UE.\nNOTE 3:\tFor 5G ProSe Direct Discovery, there are two possible configurations for integrity checking, namely, MIC checked by the 5G DDNMF of the Monitoring UE, and MIC checked at the Monitoring UE side. Which configuration to use is decided by the 5G DDNMF, which assigns the monitored ProSe Restricted Code and signals the Monitoring UE in the Code-Receiving Security Parameters.\nFor 5G ProSe UE-to-Network Relay discovery, MIC checking is performed only at the Remote UE and the 5G DDNMF of the Remote UE does not need to configure integrity checking for UE-to-Network Relay discovery.\nNOTE 4:\tThe chosen PC5 ciphering algorithm is associated with the ProSe Restricted Code.\n10.\tThe 5G DDNMF in the HPLMN of the Monitoring UE returns the Discovery Filter and the Code-Receiving Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Monitoring UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of clause 6.1.3.1 of the present document. The UE stores the Discovery Filter, Code-Receiving Security Parameters, and the chosen PC5 ciphering algorithm together with the ProSe Restricted Code.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is returned instead of the Discovery Response, and the RSC is included instead of the ProSe Restricted Code. The response message contains the discovery security materials as contained in step 9.\nIf the 5G DDNMF in the HPLMN of the Monitoring UE receives the PC5 security policies associated with the ProSe Restricted Code in step 9, the Monitoring UE's 5G DDNMF forwards the PC5 security policies to the Monitoring UE.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.\nSteps 11 and 12 occur over PC5:\n11.\tThe UE starts announcing, if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the Announcing UE's ProSe clock and if the Validity Timer has not expired. The UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.\n12.\tThe Monitoring UE listens for a discovery message that satisfies its Discovery Filter if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the monitoring UE's ProSe clock. In order to find such a matching message, it processes the message. If the Monitoring UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 13.\nNOTE 5:\tThe UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.304 [2]. If such a Match Report is sent, then there is no security functionality involved.\nSteps 13-16 refer to a Monitoring UE that has encountered a match:\nNOTE 6:\tFor 5G ProSe UE-to-Network Relay discovery, the steps 13-16 are skipped.\n13.\tIf the UE has either not had the 5G DDNMF check the MIC for the discovered ProSe Restricted Code previously or the 5G DDNMF has checked a MIC for the ProSe Restricted Code and the associated Match Report refresh timer (see step 15 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], then the Monitoring UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Monitoring UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Monitoring UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Restricted Code and MIC. The 5G DDNMF checks the MIC.\n14.\tThe 5G DDNMF in the HPLMN of the Monitoring UE may exchange an Auth Req/Auth Resp with the ProSe Application Server to ensure that Monitoring UE is authorized to discover the Announcing UE.\n15.\tThe 5G DDNMF in the HPLMN of the Monitoring UE returns to the Monitoring UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Monitoring UE included the Match Report refresh timer in the message to the Monitoring UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Restricted Code.\n16.\tThe 5G DDNMF in the HPLMN of the Monitoring UE may send a Match Report Info message to the 5G DDNMF in the HPLMN of the Announcing UE.\nThe security procedure for restricted 5G ProSe Direct Discovery Model B is described as follows.\nFigure 6.1.3.2.2.2-1 illustrates the security procedure for restricted 5G ProSe Direct Discovery Model B, detailing the steps and protocols involved in ensuring secure communication and data transmission within the 5G network. The figure outlines the authentication and authorization processes, as well as the encryption methods used to protect sensitive information. It also highlights the role of network elements such as the eNB, MME, and PDN Gateway in maintaining secure communication channels. The figure emphasizes the importance of adhering to strict security measures to prevent unauthorized access and potential security breaches in the 5G network.\nFigure 6.1.3.2.2.2-1: Security procedure for restricted 5G ProSe Direct Discovery Model B\nNOTE 1:\tWhen the user-plane based security procedure for the UE-to-Network Relay is used, the 5G PKMF takes the role of the 5G DDNMF as described in clause 6.3.3.2 of the present document.\nSteps 1-4 refer to a Discoveree UE:\n1.\tDiscoveree UE sends a Discovery Request message containing the RPAUID to the 5G DDNMF in its HPLMN in order to get Discovery Query Filter(s) to monitor a query, the ProSe Response Code to announce and associated security materials. The command indicates that this is for ProSe Response (Model B) operation, i.e. for a Discoveree UE. In addition, the Discoveree UE shall include its PC5 UE security capability that contains the list of supported ciphering algorithms by the UE in the Discovery Request message.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G ProSe UE-to-Network Relay plays the role of the Discoveree UE and sends a Relay Discovery Key Request instead of a Discovery Request. The Relay Discovery Key Request message includes the Relay Service Code (RSC) and the 5G ProSe UE-to-Network Relay's PC5 security capabilities.\n2.\tThe 5G DDNMF may check for the announce authorization with the ProSe Application Server depending on 5G DDNMF configuration.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF may check with the UDM whether the UE-to-Network relay is authorized to announce UE-to-Network relay discovery.\n3.\tThe 5G DDNMFs in the HPLMN and VPLMN of the Discoveree UE exchange Announce Auth. Messages. If the Discoveree UE is not roaming, these steps do not take place.\nFor 5G ProSe UE-to-Network Relay discovery, Npkmf_Discovery_AnnounceAuthorize service operation is used to obtain the authorization from the 5G PKMF for announcing in the PLMN.\n4.\tThe 5G DDNMF in the HPLMN of the Discoveree UE returns the ProSe Response Code and the Code-Sending Security Parameters, Discovery Query Filter(s), Code-Receiving Security Parameters corresponding to each discovery filter along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Code-Sending Security Parameters provide the necessary information for the Discoveree UE to protect the transmission of the ProSe Response Code and are stored with the ProSe Response Code. The Code-Receiving Security Parameters provide the information needed by the Discoveree UE to undo the protection applied to the ProSe Query Code by the Discoverer UE. The Code-Receiving Security Parameters indicate a Match Report will not be used for MIC checking. The UE stores each Discovery Filter with its associated Code-Receiving Security Parameters. The Discoveree UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in step 4 of clause 6.1.3.1 of the present document. The 5G DDNMF in the HPLMN of the Discoveree UE shall include the chosen PC5 ciphering algorithm in the Discovery Response message. The 5G DDNMF determines the chosen PC5 ciphering algorithm based on the ProSe Response Code and the received PC5 UE security capability in step 1. The UE stores the chosen PC5 ciphering algorithm together with the ProSe Response Code.\nIn addition, the 5G DDNMF in the HPLMN of the Discoveree UE may associate the ProSe Response Code with the PC5 security policies and include the PC5 security policies in the Discovery Response message.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of ProSe Query Code and ProSe Response Code.\nNOTE 2:\t5G DDNMF may get the PC5 security policies in different ways (e.g. from PCF, from ProSe Application Server, or based on local configuration).\nSteps 5-10 refer to a Discoverer UE:\n5.\tThe Discoverer UE sends a Discovery Request message containing the RPAUID and its PC5 UE security capability to the 5G DDNMF in its HPLMN in order to be allowed to discover one or more Restricted ProSe Application User IDs.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G ProSe Remote UE plays the role of the Discoverer UE and sends a Relay Discovery Key Request instead of the Discovery Request. The Relay Discovery Key Request message includes the RSC and the 5G ProSe Remote UE's PC5 security capabilities. The Remote UE may provide a list of PLMNs in which the UE is authorized to use a 5G ProSe U2N Relay. in the Relay Discovery Key Request.\n6.\tThe 5G DDNMF in the HPLMN of the Discoverer UE sends an authorization request to the ProSe Application Server. If the RPAUID is allowed to discover at least one of the Target RPAUIDs contained in the Application Level Container, the ProSe Application Server returns an authorization response.\nFor 5G ProSe UE-to-Network Relay discovery, the 5G DDNMF of the Remote UE may check with the UDM whether the Remote UE is authorized to monitor UE-to-Network relay discovery.\n7.\tIf the Discovery Request is authorized, the 5G DDNMF in the HPLMN of the Discoverer UE contacts the 5G DDNMF in the HPLMN of the Discoveree UE by sending a Discovery Request message, as specified in clause 6.3 of TS 23.304 [2], including the PC5 UE security capability in step 5.\nFor 5G ProSe UE-to-Network Relay Discovery, Relay Discovery Key Request and RSC are used instead of Discovery Request and RPAUID. The 5G DDNMF of the remote UE discovers 5G DDNMF(s) of the potential 5G ProSe UE-to-Network relay(s) supporting the RSC based on HPLMNs of the potential 5G ProSe UE-to-Network relay(s) mapping to the RSC. Npkmf_Discovery_DiscoveryKey service operation is used to obtain the discovery key from the 5G PKMF for a discoverer UE in the PLMN.\nNOTE 2a:\t5G DDNMF may get the HPLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).\n8.\tThe 5G DDNMF in the HPLMN of the Discoveree UE may exchange authorization messages with the ProSe Application Server.\nFor 5G ProSe UE-to-Network Relay discovery, this step is skipped.\n9.\tIf the PC5 UE security capability in step 5 includes the chosen PC5 ciphering algorithm, the 5G DDNMF in the HPLMN of the Discoveree UE responds to the 5G DDNMF in the HPLMN of the Discoverer UE with a Discovery Response message including the ProSe Query Code(s) and their associated Code-Sending Security Parameters, ProSe Response Code and its associated Code-Receiving Security Parameters, an optional Discovery User Integrity Key (DUIK) for the ProSe Response Code, and a chosen PC5 ciphering algorithm. The Code-Receiving Security Parameters provide the information needed by the Discoverer UE to undo the protection applied by the Discoveree UE. The DUIK shall be included as a separate parameter if the Code-Receiving Security Parameters indicate that the Discoverer UE use Match Reports for MIC checking. The 5G DDNMF in the HPLMN of the Discoverer UE stores the ProSe Response Code and the Discovery User Integrity Key (if it received one outside of the Code-Receiving Security Parameters). The Code-Sending Security Parameters provide the information needed by the Discoverer UE to protect the ProSe Query Code.\nThe 5G DDNMF in the HPLMN of the Discoveree UE may send the PC5 security policies associated with the ProSe Response Code to the 5G DDNMF in the HPLMN of the Discoverer UE.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of ProSe Query Code and ProSe Response Code. Npkmf_Discovery_DiscoveryKey service operation is used to obtain the discovery key from the 5G PKMF for a discoverer UE in the PLMN.\nNOTE 3:\tFor 5G ProSe Direct Discovery, there are two possible configurations for integrity checking, namely, MIC checked by the 5G DDNMF of the Discoverer UE, and MIC checked at the Discoverer UE side; this is decided by the 5G DDNMF that assigns the ProSe Restricted Code, and signals the Discoverer UE in the Code-Receiving Security Parameters.\nFor 5G ProSe UE-to-Network Relay discovery, MIC checking is performed only at the Remote UE and the 5G DDNMF of the Remote UE does not need to configure integrity checking for UE-to-Network Relay discovery.\nNOTE 4:\tThe chosen PC5 ciphering algorithm is associated with the ProSe Response Code.\n10.\tThe 5G DDNMFs in the HPLMN and VPLMN of the Discoverer UE exchange Announce Auth. messages. If the Discoverer UE is not roaming, these steps do not take place.\nFor 5G ProSe UE-to-Network Relay discovery, Npkmf_Discovery_AnnounceAuthorize service operation is used to obtain the authorization from the 5G PKMF for discovering in the PLMN.\n11.\tThe 5G DDNMF in the HPLMN of the Discoverer UE returns the Discovery Response Filter and the Code-Receiving Security Parameters, the ProSe Query Code, the Code-Sending Security Parameters along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Discoverer UE takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of clause 6.1.3.1 of the present document. The UE stores the Discovery Response Filter and its Code-Receiving Security Parameters and the ProSe Query Code and its Code-Sending Security Parameters, and the chosen PC5 ciphering algorithm together with the ProSe Response Code.\nIf the 5G DDNMF in the HPLMN of the Discoverer UE receives the PC5 security policies associated with the ProSe Response Code in step 9, the Discoverer UE's 5G DDNMF forwards the PC5 security policies to the Discoverer UE.\nFor 5G ProSe UE-to-Network Relay discovery, a Relay Discovery Key Response is used instead of the Discovery Response, and the RSC is used instead of the ProSe Restricted Code.\nSteps 12 to 15 occur over PC5:\n12.\tThe Discoverer UE sends the ProSe Query Code and also listens for a response message if the UTC-based counter provided by the system associated with the discovery slot is within the MAX_OFFSET of the Discoverer UE's ProSe clock and if the Validity Timer has not expired. The Discoverer UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.\n13.\tThe Discoveree UE listens for a discovery message that satisfies its Discovery Filter if the UTC-based counter associated with that discovery slot is within the MAX_OFFSET of the Discoveree UE's ProSe clock. In order to find such a matching message, it processes the message.\nNOTE 5:\tMatch Reports are not used for the MIC checking of ProSe Query Codes.\n14.\tThe Discoveree UE sends the ProSe Response Code associated with the discovered ProSe Query Code. The Discoveree UE forms the discovery message and protects it. The four least significant bits of UTC-based counter are transmitted along with the protected discovery message.\n15.\tThe Discoverer UE listens for a discovery message that satisfies its Discovery Filter. In order to find such a matching message, it processes the message. If the Discoverer UE was not asked to send Match Reports for MIC checking, it stops at this step from a security perspective. Otherwise, it proceeds to step 16.\nNOTE 6:\tThe UE checking the integrity of the discovery message on its own does not prevent the UE from sending a Match Report due to requirements in TS 23.304 [2]. If such a Match Report is sent, then there is no security functionality involved.\nNOTE 7:\tThe security keys in the Code-Sending Security Parameters of Discoverer UE and the security keys in the Code-Sending Security Parameters of Discoveree UE need to be generated independently and randomly.\nSteps 16-19 refer to a Discoverer UE that has encountered a match:\nNOTE 8:\tFor 5G ProSe UE-to-Network Relay discovery, the steps 16-19 are skipped.\n16.\tIf the Discoverer UE has either not had the 5G DDNMF check the MIC for the discovered ProSe Response Code previously or the 5G DDNMF has checked a MIC for the ProSe Response Code and the associated Match Report refresh timer (see step 18 for details of this timer) has expired, or as required based on the procedure specified in TS 23.304 [2], then the Discoverer UE sends a Match Report message to the 5G DDNMF in the HPLMN of the Discoverer UE. The Match Report contains the UTC-based counter value with four least significant bits equal to four least significant bits received along with discovery message and nearest to the Discoverer UE's UTC-based counter associated with the discovery slot where it heard the announcement, and other discovery message parameters including the ProSe Response Code and MIC. The 5G DDNMF checks the MIC.\n17.\tThe 5G DDNMF in the HPLMN of the Discoverer UE may exchange an Auth Req/Auth Resp with the ProSe Application Server to ensure that Discoverer UE is authorized to discover the Discoveree UE.\n18.\tThe 5G DDNMF in the HPLMN of the Discoverer UE returns to the Discoverer UE an acknowledgement that the integrity check passed. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its ProSe clock. The 5G DDNMF in the HPLMN of the Discoverer UE include the Match Report refresh timer in the message to the Discoverer UE. The Match Report refresh timer indicates how long the UE will wait before sending a new Match Report for the ProSe Response Code.\n19.\tThe 5G DDNMF in the HPLMN of the Discoverer UE may send a Match Report Info message to the 5G DDNMF in the HPLMN of the Discoveree UE.\nThere are three types of security that are used to protect the restricted 5G ProSe Direct Discovery messages over the PC5 interface: integrity protection, scrambling protection, and message-specific confidentiality which are defined in clause 6.1.3.4.3 in TS 33.303 [4]. The protection mechanisms specified in TS 33.303 [4] are reused with the following changes:\n-\tInput parameters to integrity protection algorithm as specified in clause A.6 in the present document.\n-\tMessage-specific confidentiality mechanisms as specified in clause A.7 in the present document.\n-\tIn A.5 of TS 33.303 [4], the time-hash-bitsequence keystream is set to L least significant bits of the output of the KDF, where L is the bit length of the discovery message to be scrambled and set to Min (the length of discovery message - 16, 256).\n-\tStep 3 of clause 6.1.3.4.3.5 of TS 33.303 [4] becomes:\nXOR (0xFFFF || time-hash-bitsequence) with the most significant (L + 16) bits of discovery message.\nNOTE 1:\t16 is the size of Message Type and UTC-based counter LSB in bit length.\nNOTE 2:\tThe maximum length of the discovery message to be scrambled is limited to 256 bits.\n-\tStep 2 of clause 6.1.3.4.3.2 of TS 33.303 [4] becomes:\nCalculate MIC if a DUIK was provided, otherwise set MIC to a 32-bit random string. Then, set the MIC IE to the MIC.\n-\tStep 4 of clause 6.1.3.4.3.2 of TS 33.303 [4] is not processed.\nNOTE 3: Protection for the discovery messages between the ProSe UEs is provided at the ProSe layer.\nThis clause describes the security requirements and the procedures for 5G ProSe UE-to-UE Relay Discovery defined in TS 23.304 [2].\nTwo sets of discovery security materials are used for UE-to-UE Relay discovery message protection. Direct Discovery security materials are used by 5G ProSe End UEs to protect a direct discovery set that is an end-to-end data element between 5G ProSe End UEs and is not processed by the 5G ProSe UE-to-UE Relay. UE-to-UE Relay Discovery security materials are used by 5G ProSe UE-to-UE Relay and 5G ProSe End UEs to protect 5G ProSe UE-to-UE Relay Discovery messages. The 5G ProSe UE-to-UE Relay Discovery message includes the protected direct discovery set.\nProvisioning of the Direct Discovery security materials reuses the security materials provisioning mechanism for Restricted 5G ProSe Direct Discovery as specified in clause 6.1.3.2.\nProvisioning of the UE-to-UE Relay Discovery security materials reuses the security materials provisioning mechanism for 5G ProSe UE-to-Network Relay discovery as specified in clause 6.1.3.2.\nThe protection of 5G ProSe UE-to-UE Relay Discovery message and direct discovery set is configurable based on the provisioned discovery security materials.\n5G ProSe UE-to-UE Relay Discovery addresses the following security requirements:\n-\tThe 5G System shall provide a means for confidentiality protection, integrity protection and replay protection of discovery messages for UE-to-UE Relay discovery.\n-\tThe 5G System shall provide a means to mitigate trackability and linkability attacks of 5G ProSe End UEs during UE-to-UE Relay discovery procedure.\n-\tThe 5G System shall provide a means to securely provision the security materials for UE-to-UE Relay discovery.\nThe security procedure for 5G ProSe UE-to-UE Relay Discovery with Model A is described as follows.\nFigure 6 illustrates the security procedure for 5G ProSe, focusing on UE-to-UE relay discovery with Model A. The figure depicts the interaction between the ProSe user equipment (UE) and the network elements involved in the relay discovery process. The model is designed to ensure secure communication and efficient resource allocation, with a focus on latency and reliability. The figure showcases the importance of proper security measures in 5G ProSe, highlighting the need for secure communication between UEs and the network infrastructure.\nFigure 6.1.3.3.3.1-1: Security procedure for 5G ProSe UE-to-UE Relay Discovery with Model A\nNOTE 1: The protection of direct discovery set and Announcement message reuses the protection mechanism specified in clause 6.1.3.2.3 of the present document.\n1a.\tThe monitoring 5G ProSe End UE and announcing 5G ProSe End UE are provisioned with the discovery security materials associated with a 5G ProSe Direct Discovery service based on the discovery security materials provisioning procedure for Restricted 5G ProSe Direct Discovery, as specified in clause 6.1.3.2.2.1 of the present document.\n1b.\tThe monitoring 5G ProSe End UE, announcing 5G ProSe End UE, and 5G ProSe UE-to-UE Relay are provisioned with discovery security materials associated with an RSC based on the discovery security materials provisioning procedure for UE-to-Network Relay Discovery, as specified in clause 6.1.3.2.2.1 of the present document.\n2.\tThe announcing 5G ProSe End UE shall protect the direct discovery set using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3 of the present document. The protected direct discovery set shall include User Info ID of the announcing 5G ProSe End UE, the UTC-based counter LSB parameter, and a MIC IE. The 5G ProSe UE-to-UE Relay obtains the RSC and protected direct discovery set from the announcing 5G ProSe End UE in proximity (e.g., via a previous 5G ProSe UE-to-UE Relay Discovery or 5G ProSe UE-to-UE Relay Communication procedures) as specified in clause 6.3.2.4.2 of TS 23.304 [2]. When 5G ProSe UE-to-UE Relay Discovery is used to deliver the direct discovery set, the announcing 5G ProSe End UE shall include the RSC and protected direct discovery set in a discovery message that is protected using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3 of the present document. When 5G ProSe UE-to-UE Relay Communication is used to deliver the direct discovery set, the announcing 5G ProSe End UE shall use the secure PC5 unicast link with the 5G ProSe UE-to-UE Relay to send the RSC and protected direct discovery set. The 5G ProSe UE-to-UE Relay shall store the valid protected direct discovery set along with its validity time. A protected discovery set shall be removed once its validity time has expired. The validity time is determined from the UTC-based counter associated to the received direct discovery set that works as a timestamp.\nNOTE 2: The protected direct discovery set remains valid as long as the 5G ProSe UE-to-UE Relay and Monitoring 5G ProSe End UE estimates the same UTC-based counter used by the Announcing ProSe End UE.\n3.\tWhen broadcasting the Announcement message, the 5G ProSe UE-to-UE Relay shall include the list of valid protected direct discovery sets in the Announcement message and protect the Announcement message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3 of the present document. Then, the 5G ProSe UE-to-UE Relay sends the Announcement message.\n4.\tOn receiving the Announcement message from the 5G ProSe UE-to-UE Relay, the monitoring 5G ProSe End UE shall process the received Announcement message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3 of the present document. If the verification is successful, the monitoring 5G ProSe End UE shall extract the direct discovery set(s) from the Announcement message, and process the direct discovery set(s) using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3 of the present document.\nThe security procedure for 5G ProSe UE-to-UE Discovery with Model B is shown in Figure 6.1.3.X.3.2-1.\nFigure 6 illustrates the security procedure for 5G ProSe UE-to-UE Relay Discovery with Model B, showcasing the steps involved in establishing secure communication between user equipment (UEs) through relay discovery. The figure depicts the process of authentication, key agreement, and secure data transmission between UEs, emphasizing the importance of encryption and secure key management in 5G networks. The model B represents a specific approach to secure communication, ensuring that only authorized devices can establish connections and transmit data. This figure is crucial for understanding the security measures implemented in 5G ProSe systems.\nFigure 6.1.3.3.3.2-1: Security procedure for 5G ProSe UE-to-UE Relay Discovery with Model B\n0.\tThe discoverer 5G ProSe End UE and discoveree 5G ProSe End UE are provisioned with the discovery security materials associated with a 5G ProSe Direct Discovery service based on the discovery security materials provisioning procedure for Restricted 5G ProSe Direct Discovery, as specified defined in clause 6.1.3.2.2.2.\nThe discoverer 5G ProSe End UE, discoveree 5G ProSe End UE and 5G ProSe UE-to-UE Relay are provisioned with the discovery security materials associated with an RSC based on the discovery security materials provisioning procedure for UE-to-Network Relay Discovery, as specified in clause 6.1.3.2.2.2.\n1.\tThe discoverer 5G ProSe End UE shall protect a direct discovery set using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3. The protected direct discovery set shall include User Info ID of the discoverer 5G ProSe End UE and User Info ID of the discoveree 5G ProSe End UE, the UTC-based counter LSB parameter, and a MIC IE. Then, the discoverer 5G ProSe End UE shall include the protected direct discovery set in the Solicitation message and protect the Solicitation message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3. The solicitation message is sent to the 5G ProSe UE-to-UE Relay.\n2.\tOn receiving the 5G ProSe UE-to-UE Relay Discovery Solicitation message from the discoverer 5G ProSe End UE, the 5G ProSe UE-to-UE Relay shall process the received UE-to-UE Relay Discovery Solicitation message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3.\nIf the verification is successful, the 5G ProSe UE-to-UE Relay shall modify the UE-to-UE Relay Discovery Solicitation message to include User Info ID of the 5G ProSe UE-to-UE Relay.\nThe 5G ProSe UE-to-UE Relay Discovery Solicitation message is protected using the security materials associated with the RSC as specified in clause 6.1.3.2.3.\nThen, 5G ProSe UE-to-UE Relay sends the message to the discoveree 5G ProSe End UE.\n3.\tThe discoveree 5G ProSe End UE shall process the received UE-to-UE Relay Discovery Solicitation message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3.\nIf the verification is successful, the discoveree 5G ProSe End UE shall extract the protected direct discovery set from the message and process the direct discovery set using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3.\nThe discoveree 5G ProSe End UE shall protect a direct discovery set using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3. Then, the discoveree 5G ProSe End UE shall include the protected direct discovery set in the UE-to-UE Relay Discovery Response message and protect the UE-to-UE Relay Discovery Response message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3. The discoveree 5G ProSe End UE replies to the 5G ProSe UE-to-UE Relay with the UE-to-UE Relay Discovery Response message.\n4.\tOn receiving the UE-to-UE Relay Discovery Response message from the discoveree 5G ProSe End UE, the 5G ProSe UE-to-UE Relay shall process the received UE-to-UE Relay Discovery Response message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3.\nIf the verification is successful, the 5G ProSe UE-to-UE Relay shall modify the UE-to-UE Relay Discovery Response message to include User Info ID of 5G ProSe UE-to-UE Relay.\nThe UE-to-UE Relay Discovery Response message is protected using the security materials associated with the RSC as specified in clause 6.1.3.2.3. Then, 5G ProSe UE-to-UE Relay sends the UE-to-UE Relay Discovery Response message to the discoverer 5G ProSe End UE.\nOn receiving the UE-to-UE Relay Discovery Response message, the discoverer 5G ProSe End UE shall process the UE-to-UE Relay Discovery Response message using the discovery security materials associated with the RSC as specified in clause 6.1.3.2.3.\nIf the verification is successful, the discoverer 5G ProSe End UE shall extract the protected direct discovery set from the UE-to-UE Relay Discovery Response message and process the direct discovery set using the discovery security materials associated with the 5G ProSe Direct Discovery service as specified in clause 6.1.3.2.3.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.2\tSecurity for unicast mode 5G ProSe Direct Communication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.2.1\tGeneral",
                            "text_content": "The unicast mode 5G ProSe Direct Communication procedures are described in TS 23.304 [2]. Unicast mode 5G ProSe Direct Communication is used by two UEs that directly exchange traffic for the ProSe applications running between the peer UEs.\nPC5 security policy provisioning by 5G DDNMF for unicast mode 5G Prose Direct Communication during the restricted 5G ProSe Direct Discovery procedure is specified in clause 6.1.3.2.\nPC5 direct communication security for relay services is specified in clause 6.3.\nIf the UE receives PC5 security policies from 5G DDNMF as specified in clause 6.1.3.2.2, the UE uses the PC5 security policies from 5G DDNMF to establish PC5 unicast communication security instead of the PC5 security policies provisioned by PCF or pre-configured in UE as defined in TS 23.304 [2].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.2.2\tSecurity requirements",
                            "text_content": "The initiating UE shall establish a different security context for each peer UE during the PC5 unicast establishment if the security is activated. It shall be possible to establish security context also when either one or both the 5G ProSe-enabled UEs are out of coverage.\nThe mutual authentication between two 5G ProSe-enabled UEs during PC5 unicast shall be supported.\nThe PC5 unicast signalling shall support confidentiality protection, integrity protection and anti-replay protection.\nThe PC5 unicast user plane shall support confidentiality protection, integrity protection and anti-replay protection.\nThe PCF shall be able to provision the PC5 security policies to the UE per ProSe application during service authorization and information provisioning procedure as defined in TS 23.304 [2].\nThe 5G System shall support means for a secure refresh of the UE security context.\nNOTE 1:\tThe security context refresh may be triggered based on various options (e.g. validity time etc.).\nThe 5G System should provide means for mitigating trackability attacks on a UE during PC5 unicast communications.\nThe 5G System should provide means for mitigating link ability attacks on a UE during PC5 unicast communications.\nNOTE 2:\tThe 5G system provides means for mitigating trackability and link ability if security of the connection is activated.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.2.3\tSecurity procedures",
                            "text_content": "The unicast mode security mechanism defined in clause 5.3 of TS 33.536 [6] is reused in 5G ProSe to provide unicast mode 5G ProSe Direct Communication security.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.2.4\tIdentity privacy for the PC5 unicast link",
                            "text_content": "The privacy protection procedures defined in clause 5.3.3.2 of TS 33.536 [6] are reused in 5G ProSe to provide unicast mode 5G ProSe Direct Communication security.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.3\tSecurity for 5G ProSe UE-to-Network Relay Communication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.3.1\tGeneral",
                            "text_content": "This clause describes the security requirements and the procedures that are specifically applied to 5G ProSe UE-to-Network Relay communication defined in TS 23.304 [2]. The security requirements for 5G ProSe Layer-3 UE-to-Network Relay and 5G ProSe Layer-2 UE-to-Network Relay are different and are defined in clause 6.3.3 and clause 6.3.4 respectively.\nThere are two security mechanism options for 5G ProSe UE-to-Network Relay: security procedure over User Plane as defined in clause 6.3.3.2 and security procedure over Control Plane as defined in clause 6.3.3.3. The 5G ProSe remote UE and 5G ProSe UE-to-Network Relay determine the security mechanism based on the Control Plane Security Indicator associated with the RSC, the Control Plane Security Indicator and the associated RSC are specified in clause 5.1.4.3.2 of TS 23.304 [2].\nThe functionality in this clause is supported by both 5G ProSe-enabled UEs for commercial services and public safety.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.2\tSecurity requirements",
                            "text_content": "The following security requirements apply to both 5G ProSe Layer-3 UE-to-Network Relay and 5G ProSe Layer-2 UE-to-Network Relay:\n-\tThe 5G System shall support the authorization of the UE as a 5G ProSe UE-to-Network Relay in the 5G ProSe UE-to-Network Relay scenario.\n-\tThe 5G System shall support the authorization of the UE as a 5G ProSe Remote UE in the 5G ProSe UE-to-Network Relay scenario.\n-\tFor UE-to-Network Relay discovery, the security requirements in clause 6.1.2 apply.\n-\tThe 5G System shall support a secure means to establish a PC5 link between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay.\n-\tThe 5G System shall support confidentiality protection, integrity protection and replay protection for secure communication between the 5G ProSe Remote UE and the network via 5G ProSe UE-to-Network Relays.\n-\tPC5 signalling integrity security policy is set to \"REQUIRED\" for the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay.\n-\tThe 5G ProSe Remote UE shall establish a different PC5 security context with each different 5G ProSe UE-to-Network Relay and for each different Relay Service Code. It shall also be possible to establish a PC5 security context when the 5G ProSe Remote UE is out of coverage.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.3\tSecurity for 5G ProSe Communication via 5G ProSe Layer-3 UE-to-Network Relay",
                            "text_content": "Both user-plane (UP) based and control-plane (CP) based procedures can be used for 5G ProSe UE-to-Network Relay authorization and security establishment. The UP based procedure uses a UP connection to the 5G PKMF, while the CP based procedure uses the ProSe authentication for PC5 key establishment.\nThe following are the security requirements for 5G ProSe Layer-3 UE-to-Network Relay communication:\n-\tFor 5G ProSe Layer-3 UE-to-Network Relay security established over control plane, the PCF shall be able to provision the PC5 security policies to the 5G ProSe Remote UE and the UE-to-Network Relay respectively per 5G ProSe UE-to-Network Relay service, during service authorization and information provisioning procedure as defined in TS 23.304 [2].\n-\tFor 5G ProSe Layer-3 UE-to-Network Relay security established over user plane, the 5G PKMF shall be able to provision the PC5 security policies to the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay respectively per 5G ProSe UE-to-Network Relay service, during security materials provisioning procedure defined in clause 6.3.3.2.\n-\tThe PC5 UP security policies for protecting 5G ProSe UE-to-Network Relay communication shall be configured per 5G ProSe UE-to-Network Relay service based on the security requirements of the specific relay service.\n-\tThe activation of PC5 signalling security shall be based on PC5 CP security policies of the specific 5G ProSe UE-to-Network Relay service.\n-\tThe activation of PC5 user plane security shall be based on PC5 UP security policies of the specific 5G ProSe UE-to-Network Relay service.\n-\t5G PKMF shall be configured with the PC5 security policies associated with each 5G ProSe Layer-3 UE-to-Network Relay service.\nThis clause describes a mechanism to setup a PC5 link between a 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay. The mechanism includes how a 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay get authorized by the 5G ProSe Key Management Function (5G PKMF) and verify each other's roles.\nFigure 6.3.3.2.2-1 illustrates the PC5 security establishment procedure for 5G ProSe, detailing the steps involved in establishing secure communication between a 5G ProSe user equipment (UE) and the network. The figure showcases the process of authentication, key agreement, and encryption, ensuring secure data transmission. Key components include the UE, network, and PC5 protocol stack, which facilitate the secure establishment of a communication session. The figure highlights the importance of security in 5G ProSe, emphasizing the need for robust authentication and encryption mechanisms to protect against potential threats.\nFigure 6.3.3.2.2-1: PC5 security establishment procedure for 5G ProSe UE-to-Network relay communication over User Plane\nThe 5G ProSe Remote UE is provisioned with the discovery security materials (see clause 6.1.3.2) and Prose Remote User Key (UP-PRUK) when it is in coverage. These security materials are associated with an expiration time, after which they become invalid. If the UE does not have valid discovery security materials, the 5G ProSe Remote UE needs to connect to the 5G PKMF and obtain fresh ones to use the 5G ProSe UE-to-Network Relay services.\nNOTE 1:\tThe procedure is described for the scenario that the 5G PKMF of the 5G ProSe Remote UE is different from the 5G PKMF of the 5G ProSe UE-to-Network Relay. If both the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay are served by a single 5G PKMF, the 5G PKMF takes the role of the 5G PKMF of the 5G ProSe Remote UE and the 5G PKMF of the 5G ProSe UE-to-Network Relay and the inter-5G PKMF message exchanges are not needed.\nNOTE 2:\tSteps 0a, 0b, 1a, 1b are performed when the 5G ProSe Remote UE is in coverage.\n0a.\tThe 5G ProSe Remote UE gets the 5G PKMF address from the 5G DDNMF of its HPLMN. Alternatively, the 5G ProSe Remote UE may be provisioned with the 5G PKMF address by PCF. If the 5G ProSe Remote UE is provisioned with the 5G PKMF address, the 5G ProSe Remote UE may access the 5G PKMF directly without requesting it from the 5G DDNMF. In case that the 5G ProSe Remote UE cannot access the 5G PKMF using the provisioned 5G PKMF address, the 5G ProSe Remote UE may request the 5G PMKF address to the 5G DDNMF.\n0b.\tThe 5G ProSe Remote UE shall establish a secure connection with the 5G PKMF via PC8 reference point. Security for PC8 interface relies on Ua security if GBA specified in TS 33.220 [8] is used (see clause 5.2.3.4) or Ua* security if AKMA specified in TS 33.535 [5] is used (see clause 5.2.5.4). The 5G PKMF of the 5G ProSe Remote UE shall check whether the 5G ProSe Remote UE is authorized to receive UE-to-Network Relay service, and if the UE is authorized, the 5G PKMF of the 5G ProSe Remote UE provides the discovery security materials to the 5G ProSe Remote UE. If the 5G ProSe Remote UE provides a list of visited networks, the 5G PKMF of the 5G ProSe Remote UE shall request the discovery security materials from the 5G PKMFs of the potential 5G ProSe UE-to-Network Relays from which the 5G ProSe Remote UE gets the relay services based on the visited networks from the remote UE. If authorized visited networks are not provided by the 5G ProSe Remote UE, the 5G PKMF of the 5G ProSe Remote UE shall request the discovery security materials from the 5G PKMFs of the potential 5G ProSe UE-to-Network Relays based on the PLMNs of the potential 5G ProSe UE-to-Network Relays. The 5G PKMF of the 5G ProSe UE-to-Network Relay may include the PC5 security policies to the 5G ProSe Remote UE.\nNOTE 2a:\t5G PKMF may retrieve the PLMNs of the potential 5G ProSe UE-to-Network relays in different ways (e.g. from PCF, or based on local configuration).\nNOTE 3:\tThe 5G PKMF may be locally configured with the UE's authorization information. Otherwise, the 5G PKMF interacts with the UDM of the UE to retrieve the UE's authorization information.\nNOTE 4:\tThe 5G ProSe Remote UE is provisioned by PCF with a list of the potential visited networks for the 5G ProSe UE-to-Network Relay service (which is identified by RSC).\n0c.\tThe 5G ProSe UE-to-Network Relay gets the 5G PKMF address from its HPLMN in the same way as described in step 0a.\n0d.\tThe 5G ProSe UE-to-Network Relay shall establish a secure connection with the 5G PKMF via PC8 reference point as in step 0b. The 5G PKMF of the 5G ProSe UE-to-Network Relay shall check whether the 5G ProSe UE-to-Network Relay is authorized to provide 5G ProSe UE-to-Network Relay service, and if the UE is authorized, the 5G PKMF of the 5G ProSe UE-to-Network Relay provides the discovery security materials to the 5G ProSe UE-to-Network Relay. The 5G PKMF of the 5G ProSe UE-to-Network Relay may include the PC5 security policies to the 5G ProSe UE-to-Network Relay.\n1a.\tThe 5G ProSe Remote UE sends a UP-PRUK Request message to its 5G PKMF. The message indicates that the 5G ProSe Remote UE is requesting a UP-PRUK from the 5G PKMF. If the 5G ProSe Remote UE already has a UP-PRUK from this 5G PKMF, the message shall also contain the UP-PRUK ID of the UP-PRUK.\nUP-PRUK ID shall take the form of either the NAI format or the 64-bit string. If the UP-PRUK ID is in NAI format, i.e. username@realm, the realm part shall include Home Network Identifier (i.e. HPLMN ID). The username part shall include the 64-bit string.\n1b.\tThe 5G PKMF checks whether the 5G ProSe Remote UE is authorized to receive UE-to-Network Relay services. This is done by using the 5G ProSe Remote UE's identity associated with the key used to establish the secure connection between the 5G ProSe Remote UE and 5G PKMF in step 0b. If the 5G ProSe Remote UE is authorized to receive the service, the 5G PKMF sends a UP-PRUK and UP-PRUK ID to the 5G ProSe Remote UE. If a UP-PRUK and UP-PRUK ID are included, the 5G ProSe Remote UE shall store these and delete any previously stored ones for this 5G PKMF.\n2.\tThe discovery procedure is performed between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay using the discovery parameters and discovery security material as described in clause 6.1.3.2.\n3.\tThe 5G ProSe Remote UE sends a Direct Communication Request (DCR) that contains the UP-PRUK ID or a SUCI if the Remote UE does not have a valid UP-PRUK, Relay Service Code (RSC) of the 5G ProSe UE-to-Network Relay service and KNRP freshness parameter 1 to the 5G ProSe UE-to-Network Relay. If the UP-PRUK ID is not in NAI format, the DCR message shall include the HPLMN ID of the 5G ProSe Remote UE. The PC5 security establishment procedure between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay including security parameters and security policy negotiation and protection of messages hereafter shall follow the one-to-one security establishment described in clause 6.2.3 of the present document. Only additional parameters required for the 5G ProSe Layer-3 UE-to-Network Relay scenario are described in this clause. The privacy and integrity protection of DCR are described in clause 6.3.5.\n4a.\tThe 5G ProSe UE-to-Network Relay sends a Key Request message that contains UP-PRUK ID or SUCI, RSC and KNRP freshness parameter 1 to its 5G PKMF. The Key Request message shall also include the HPLMN ID of the 5G ProSe Remote UE if it is included in the DCR.\n4b.\tOn receiving the Key Request message, the 5G PKMF of the 5G ProSe UE-to-Network Relay shall check if the 5G ProSe UE-to-Network Relay is authorized to provide relay service to the 5G ProSe Remote UE based on the 5G ProSe UE-to-Network Relay's identity associated with the key used to establish the secure PC8 connection and the received RSC.\nNOTE 4a:\tThe 5G PKMF of the 5G ProSe UE-to-Network Relay needs to do the authorization of RSC based on its implementation.\nIf the 5G ProSe UE-to-Network Relay's authorization information is not locally available, the 5G PKMF shall request the authorization information from the UDM of the 5G ProSe UE-to-Network Relay (not shown in the figure) using Nudm_SDM_Get service as described in TS 23.502 [10]. If the 5G ProSe UE-to-Network Relay is authorized to provide the relay service based on ProSe Subscription data as specified in TS 23.502 [10], the 5G PKMF of the 5G ProSe UE-to-Network Relay sends the Key Request with the UP-PRUK ID or the SUCI to the 5G PKMF of the 5G ProSe Remote UE. The 5G PKMF of the 5G ProSe UE-to-Network Relay identifies the 5G PKMF address of the 5G ProSe Remote UE based on the UP-PRUK ID or HPLMN ID or SUCI of the 5G ProSe Remote UE if it is included in the Key Request message.\nNOTE 4b:\tThe 5G PKMF of the 5G ProSe Remote UE needs to do the authorization of RSC based on its implementation.\n4c.\tOn receiving the Key Request message from the 5G PKMF of the 5G ProSe UE-to-Network Relay, the 5G PKMF of the 5G ProSe Remote UE shall check if the 5G ProSe Remote UE is authorized to use the relay service. The relay service authorization check shall be based on the UP-PRUK ID and RSC included in the Key Request message or the SUPI of the Remote UE and the RSC included in the Key Request message. If a SUCI is included in the Key Request message, the 5G PKMF of the 5G ProSe Remote UE shall request the UDM of the 5G ProSe Remote UE to de-conceal the SUCI to gain the SUPI using Nudm_UEIdentifier_Deconceal service, and the UDM invokes SIDF to de-conceal SUCI to gain SUPI. If the 5G ProSe Remote UE's authorization information is not locally available, the 5G PKMF shall request the authorization information from the UDM of the 5G ProSe Remote UE (not shown in figure 6.3.3.2.2-1).\nNOTE 5:\tPrivacy issues need to be considered while determining whether the SUPI is to be sent to the PKMF. For a privacy control, the UDM can authorize the PKMF based on its NF type or the service provider domain.\nIf a new UP-PRUK is required, the 5G PKMF shall perform the one of the following procedures (as shown in the step 4c in figure 6.3.3.2.2-1):\n-\tIf the 5G PKMF of the 5G ProSe Remote UE supports the Zpn interface to the BSF of the 5G ProSe Remote UE, the 5G PKMF of the 5G ProSe Remote UE may request a GBA Push Info (GPI - see TS 33.223 [9]) for the 5G ProSe Remote UE from the BSF. When requesting the GPI, the 5G PKMF shall include a UP-PRUK ID in the P-TID field. On receiving the GPI, the 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.\n-\tIf the 5G PKMF of the 5G ProSe Remote UE supports the SBI interface to the BSF of the 5G ProSe Remote UE, the 5G PKMF may request the GPI via SBI interface as described in TS 33.223 [9]. On receiving the GPI, the 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.\n-\tIf the 5G PKMF of the 5G ProSe Remote UE supports the PC4a interface to the HSS of the UE, then the 5G PKMF of 5G ProSe Remote UE may request a GBA Authentication Vector (AV) for the 5G ProSe Remote UE from the HSS. On receiving the AV, the 5G PKMF locally forms the GPI including a UP-PRUK ID in the P-TID field. The 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.\n-\tIf the 5G PKMF of the 5G ProSe Remote UE is co-located or integrated with BSF functionality and supports the SBI interface to the UDM/HSS of the 5G ProSe Remote UE, the 5G PKMF may request the GBA AV via SBI interface as described in TS 33.220 [8]. On receiving the AV, the 5G PKMF locally forms the GPI including a UP-PRUK ID in the P-TID field. The 5G PKMF shall use Ks(_ext)_NAF as the UP-PRUK.\nNOTE 6:\tGPI is supported only when GBA is used.\n4d.\tThe 5G PKMF of the 5G ProSe Remote UE shall generate KNRP freshness parameter 2 and derive KNRP using the UP-PRUK identified by UP-PRUK ID, RSC, KNRP freshness parameter 1 and KNRP freshness parameter 2 as specified in A.8. Then, the 5G PKMF of the 5G ProSe Remote UE sends a Key Response message that contains KNRP and KNRP freshness parameter 2 to the 5G PKMF of the 5G ProSe UE-to-Network Relay. This message shall include GPI if generated. The 5G PKMF of the 5G ProSe Remote UE shall also include the Remote User ID of the 5G ProSe Remote UE in the Key Response message to the 5G PKMF of the 5G ProSe UE-to-Network Relay. UP-PRUK ID is used as a Remote User ID in the present document.\n4e.\tThe 5G PKMF of the 5G ProSe UE-to-Network Relay sends the Key Response message to the 5G ProSe UE-to-Network Relay, which includes Remote User ID, KNRP, KNRP freshness parameter 2,  the GPI if used to calculate a fresh UP-PRUK to the UE-to-Network Relay.\n5a.\tThe 5G ProSe UE-to-Network Relay shall derive the session key (KNRP-SESS) from KNRP and then derive the confidentiality key (NRPEK) (if applicable) and integrity key (NRPIK) based on the PC5 security policies as specified in TS 33.536 [6]. The 5G ProSe UE-to-Network Relay shall store the Remote User ID received in step 4d. The establishment of KNRP ID and KNRP-sess are specified in TS 33.536 [6]. The 5G ProSe UE-to-Network Relay sends a Direct Security Mode Command message to the 5G ProSe Remote UE. This message shall also include the KNRP Freshness Parameter 2 in addition to the parameters specified in TS 33.536 [6] and shall be protected as specified in TS 33.536 [6].\n5b.\tIf the 5G ProSe Remote UE receives the message containing the GPI, it processes the GPI as described in TS 33.223 [9]. The 5G ProSe Remote UE shall derive the UP-PRUK and obtain the UP-PRUK ID from the GPI.\nThe 5G ProSe Remote UE shall derive KNRP from its UP-PRUK, RSC, KNRP Freshness Parameter 1 and the received KNRP Freshness Parameter 2 as specified in A.8. It shall then derive the session key (KNRP-SESS) and the confidentiality key (NRPEK) (if applicable) and integrity key (NRPIK) based on the PC5 security policies in the same manner as the 5G ProSe UE-to-Network Relay and process the Direct Security Mode Command. Successful verification of the Direct Security Mode Command assures the 5G ProSe Remote UE that the 5G ProSe UE-to-Network Relay is authorized to provide the relay service.\nHandling of synchronization failure (for details of synchronization failures - see TS 33.102 [11]) when UE processes the authentication challenge in the GPI is performed similarly to clause 6.7.3.2.1.2 in TS 33.303 [4]. The 5G ProSe Remote UE shall send Direct Security Mode Failure message and include RAND and AUTS in the message. The 5G ProSe UE-to-Network Relay shall send the key request message to the 5G PKMF of the 5G ProSe Remote UE via the 5G PKMF of the 5G ProSe UE-to-Network Relay upon receiving the Direct Security Mode Failure message from the 5G ProSe Remote UE. The key request message shall include the HPLMN ID of the 5G ProSe Remote UE, if provided in step 3, the UP-PRUK ID or the SUCI of the 5G ProSe Remote UE received in step 3, Relay Service Code and KNRP freshness parameter 1 together with the RAND and the AUTS received from the 5G ProSe Remote UE. If the 5G PKMF of the 5G ProSe Remote UE decides to retry GBA Push procedure, the 5G PKMF of the 5G ProSe Remote UE shall request GPI as described in step 4c.\n5c.\tThe 5G ProSe Remote UE responds with a Direct Security Mode Complete message to the 5G ProSe UE-to-Network Relay as specified in TS 33.536 [6].\n5d.\tOn receiving the Direct Security Mode Complete message, the 5G ProSe UE-to-Network Relay shall verify the Direct Security Mode Complete message. Successful verification of the Direct Security Mode Complete message assures the 5G ProSe UE-to-Network Relay that the 5G ProSe Remote UE is authorized to get the relay service.\n5e.\tAfter successful verification, the 5G ProSe UE-to-Network Relay responds a Direct Communication Accept message to the 5G ProSe Remote UE to complete the PC5 connection establishment procedure.\n6.\tThe 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay continues the rest of procedure for the relay service over the secure PC5 link such as establishing a new PDU session or modifying an existing PDU session for relaying, if needed etc.\n7.\tWhen the 5G ProSe Layer-3 UE-to-Network Relay sends a Remote UE Report to the SMF as specified in TS 23.304 [2], the 5G ProSe Layer-3 UE-to-Network Relay shall include Remote User ID stored in the 5G ProSe UE-to-Network Relay in step 5a. If the UP-PRUK ID used as Remote User ID is not in NAI format, the 5G ProSe Layer-3 UE-to-Network Relay shall include the HPLMN ID of the 5G ProSe Remote UE in the Remote UE Report.\n8a. If the mapping of the Remote User ID and the 5G ProSe Remote UE's SUPI is not available in the SMF of the 5G ProSe UE-to-Network Relay, the SMF shall discover the 5G PKMF of the Relay UE using the HPLMN ID from Relay UE’s SUPI (based on the PDU session associated with the relay as specified in TS 23.304 [2]) and send a Resolve Remote User ID request towards the PKMF of the 5G ProSe UE-to-Network Relay in Npkmf_ResolveRemoteUserId_Get Request message, including the Remote User ID of the 5G ProSe Remote UE and the HPLMN ID of the 5G ProSe Remote UE if UP-PRUK ID used as Remote User ID is not in NAI format in the message.\n8b. The 5G PKMF of the 5G ProSe UE-to-Network Relay forwards the Resolve Remote User ID request in Npkmf_ResolveRemoteUserId_Get Request message towards the 5G PKMF of the 5G ProSe Remote UE. The 5G PKMF of the 5G ProSe UE-to-Network Relay identifies the 5G PKMF address of the 5G ProSe Remote UE based on the UP-PRUK ID or HPLMN ID of the 5G ProSe Remote UE.\n8c. The 5G PKMF of the 5G ProSe Remote UE shall send a Resolve Remote User ID response to the 5G PKMF of the 5G ProSe UE-to-Network Relay in Npkmf_ResolveRemoteUserId_Get Response message, including the SUPI of the 5G ProSe Remote UE in the message.\n8d. The 5G PKMF of the 5G ProSe UE-to-Network Relay forwards the Npkmf_ResolveRemoteUserId_Get Response message including the SUPI to the SMF of the 5G ProSe UE-to-Network Relay.\nThe SMF of the 5G ProSe UE-to-Network Relay shall store the Remote User ID, the SUPI of the 5G ProSe Remote UE and the Remote UE info in the 5G ProSe Layer-3 UE-to-Network Relay's SM context for this PDU Session associated with the 5G ProSe UE-to-Network Relay. The SMF sends Remote UE Report Ack message to the 5G ProSe Layer-3 UE-to-Network Relay.\nIf the 5G ProSe Remote UE receives from the 5G ProSe UE-to-Network Relay a Direct Connection Reject due to UP-PRUK ID not found in the network, the 5G ProSe Remote UE shall not attempt to reconnect with the 5G ProSe UE-to-Network Relay using the UP-PRUK ID. The 5G ProSe Remote UE may attempt to connect with the 5G ProSe UE-to-Network Relay using its SUCI.\nNOTE: The UP-PRUK ID not being found condition is detected by the 5G PKMF of the 5G ProSe Remote UE if it does not find a valid UP-PRUK that corresponds to the received UP-PRUK ID. The 5G ProSe UE-to-Network Relay is informed of this condition via the 5G PKMF of the 5G ProSe UE-to-Network Relay.\nFigure 6.3.3.2.3 -1: PC5 Key Hierarchy for 5G ProSe UE-to-Network Relay security over User Plane, illustrates the PC5 key hierarchy for secure communication between 5G ProSe user equipment (UE) and the network. The figure shows the various levels of keys involved in the process, including the network-side keys (N-side keys) and the UE-side keys (U-side keys). The keys are used to establish a secure connection and ensure confidentiality and integrity of the data transmitted. The figure also highlights the role of the network functions, such as the authentication server (NAS) and the key management server (KMS), in managing and distributing the keys. The diagram emphasizes the importance of secure key management in 5G ProSe for ensuring reliable and secure communication between the UE and the network.\nFigure 6.3.3.2.3-1: PC5 Key Hierarchy for 5G ProSe UE-to-Network Relay security over User Plane\nThe different layers of keys (see figure 6.3.3.2.3-1) are the following:\n-\tUP-PRUK: The root key of the PC5 unicast link.\n-\tKNRP: The key is equivalent to KNRP as specified in TS 33.536 [6]. This key is derived as specified in clause A.8.\n-\tKNRP-SESS: This key is derived as specified in TS 33.536 [6].\n-\tNRPEK, NRPIK: These keys are derived as specified in TS 33.536 [6].\nThis clause describes the security mechanisms for the 5G ProSe Layer-3 UE-to-Network Relay authentication, authorization and key management using the 5G ProSe Remote UE specific authentication for PC5 keys establishment. EAP-AKA’, as specified in IETF RFC 9048 [15] shall be used for 5G ProSe Remote UE authentication. The EAP-AKA’ implementations shall comply with the EAP-AKA’ profile specified in Annex F of of TS 33.501 [3]. Network entities AMF, AUSF and UDM are involved for key derivation and distribution of keys used for 5G ProSe UE-to-Network Relay communication. The UE shall be provisioned with necessary policies and parameters to use 5G ProSe services, as part of the UE ProSe Policy information as defined in clause 4.2.2 of TS 23.503 [7]. PCF shall provision the authorization policy and parameters for 5G ProSe UE-to-Network Relay discovery and communication as specified in clause 5.1.4 of TS 23.304 [2].\nThis clause describes the procedure for establishing a PC5 link between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay. The procedure includes how the 5G ProSe Remote UE is authenticated by the AUSF of the 5G ProSe Remote UE via the 5G ProSe UE-to-Network Relay and the AMF of the 5G ProSe UE-to-Network Relay during 5G ProSe PC5 establishment. This mechanism can be used when the 5G ProSe Remote UE is out of coverage.\n\nFigure 6.3.3.3.2-1 illustrates the PC5 security establishment procedure for 5G ProSe, detailing the steps involved in establishing secure communication between a 5G ProSe user equipment (UE) and the network. The figure showcases the process of authentication, encryption, and key management, ensuring secure data transmission. Key components include the 5G ProSe UE, the network, and the PC5 protocol stack, which facilitates the establishment of a secure connection for reliable and efficient communication.\nFigure 6.3.3.3.2-1: PC5 security establishment procedure for 5G ProSe UE-to-Network relay communication over Control Plane\n0.\tThe 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay shall be registered with the network. The 5G ProSe UE-to-Network Relay shall be authenticated and authorized by the network to provide UE-to-Network Relay service. The 5G ProSe Remote UE shall be authenticated and authorized by the network to receive UE-to-Network Relay service. PC5 security policies are provisioned to the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay respectively during this authorization and information provisioning procedure.\n1.\tThe 5G ProSe Remote UE or Relay UE shall initiate discovery procedure using any of Model A or Model B method as specified in clause 6.1.3.2 of the present document.\nIf the Remote UE receives NCGI from the Relay UE, it temporarily stores the NCGI.\n2.\tAfter the discovery of the 5G ProSe UE-to-Network Relay, the 5G ProSe Remote UE shall send a Direct Communication Request to the 5G ProSe UE-to-Network Relay for establishing secure PC5 unicast link. The 5G ProSe Remote UE shall include its security capabilities and PC5 signalling security policy in the DCR message as specified in TS 33.536 [6]. The message shall also include Relay Service Code, Nonce_1.\nIf the 5G ProSe Remote UE does not have a valid 5G Prose Remote User Key (CP-PRUK), the 5G ProSe Remote UE shall include SUCI in the DCR to trigger 5G ProSe Remote UE specific authentication and establish a CP-PRUK.\nIf the 5G ProSe Remote UE already has a valid CP-PRUK for Relay Service Code, the 5G ProSe Remote UE shall include the associated CP-PRUK ID in the DCR to indicate that the 5G ProSe Remote UE wants to get relay connectivity using the CP-PRUK. The privacy and integrity protection of DCR are described in clause 6.3.5\n3.\tUpon receiving the DCR message, the 5G ProSe UE-to-Network Relay shall send the Relay Key Request to the AMF of the 5G ProSe UE-to-Network Relay, including SUCI or CP-PRUK ID, RSC and Nonce_1 received in the DCR message. The 5G ProSe UE-to-Network Relay shall also include in the message a transaction identifier that identifies the 5G ProSe Remote UE for the subsequent messages over 5G ProSe UE-to-Network Relay's NAS messages.\n4.\tThe AMF of the 5G ProSe UE-to-Network Relay shall verify with the UDM whether the 5G ProSe UE-to-Network Relay is authorized to provide the UE-to-Network Relay service.\n5.\tThe AMF of the 5G ProSe UE-to-Network Relay shall select an AUSF based on SUCI or CP-PRUK ID and forward the parameters received in Relay Key Request to the AUSF in Nausf_UEAuthentication_ProseAuthenticate Request message. The Nausf_UEAuthentication_ProseAuthenticate Request message shall contain the 5G ProSe Remote UE's SUCI or CP-PRUK ID, Relay Service Code, Nonce_1 and serving network name of the 5G ProSe UE-to-Network Relay. If CP-PRUK ID is received from AMF of the 5G ProSe UE-to-Network Relay, the AUSF of the 5G ProSe Remote UE temporarily stores Nonce_1 and skips steps 6-9. If the 5G ProSe Remote UE's SUCI is received from AMF of the 5G ProSe UE-to-Network Relay, the AUSF of the 5G ProSe Remote UE temporarily stores Nonce_1 and Relay Service Code and skips step 10.\nNOTE: The AUSF gets the 5G ProSe Remote UE's Routing Indicator from the 5G ProSe Remote UE's SUCI or CP-PRUK ID and temporarily stores the Routing Indicator.\n6. The AUSF of the 5G ProSe Remote UE shall initiate a 5G ProSe Remote UE specific authentication using the ProSe specific parameters received (i.e. RSC, etc.). The serving network name handling is the same as defined in TS 33.501 [3].\nThe AUSF of the 5G ProSe Remote UE shall retrieve the Authentication Vectors from the UDM via Nudm_UEAuthentication_GetProseAv Request message. The AUSF includes the serving network name of the 5G ProSe UE-to-Network Relay in the Nudm_UEAuthentication_GetProseAV reques message. Upon reception of the Nudm_UEAuthentication_GetProSeAv Request, the UDM shall invoke SIDF de-conceal SUCI to gain SUPI before UDM can process the request. The UDM checks whether the UE is authorized to use a ProSe UE-to-Network Relay service based on authorization information in UE's Subscription data. If the UE is authorized, the UDM shall choose the EAP-AKA´ authentication method based on the received Nudm_UEAuthentication_GetProseAv Request. Then the UDM generates EAP-AKA’ Authentication Vector for ProSe as specified in clause 6.1.3.1 of TS 33.501 [3] and sends Nudm_UEAuthentication_GetProseAv Response with the Authentication Vector and SUPI to the AUSF.\n7a.\tThe AUSF of the 5G ProSe Remote UE shall temporarily store XRES and SUPI. The AUSF of the 5G ProSe Remote UE shall trigger authentication of the 5G ProSe Remote UE based on EAP-AKA'. The AUSF of the 5G ProSe Remote UE generates the EAP-Request/AKA'-Challenge message defined in clause 6.1.3.1 of TS 33.501 [3] and send EAP-Request/AKA'-Challenge message to the AMF of the 5G ProSe UE-to-Network Relay in a Nausf_UEAuthentication_ProSeAuthenticate Response message.\n7b.\tThe AMF of the 5G ProSe UE-to-Network Relay shall forward the Relay Authentication Request (including the EAP-Request/AKA'-Challenge) to the 5G ProSe UE-to-Network Relay over NAS message, including transaction identifier of the 5G ProSe Remote UE in the message. The NAS message is protected using the NAS security context created for the 5G ProSe UE-to-Network Relay.\n7c.\tBased on the transaction identifier, the 5G ProSe UE-to-Network Relay shall forwards the EAP-Request/AKA'-Challenge to the 5G ProSe Remote UE over PC5 messages.\nThe USIM in the 5G ProSe Remote UE verifies the freshness of the received values by checking whether AUTN can be accepted as described in TS 33.102 [11].\nFor EAP-AKA', the USIM computes a response RES. The USIM shall return RES, CK, IK to the ME. The ME shall derive CK' and IK' according to clause A.3 in TS 33.501 [3].\nIf the Remote UE requires network name verification (i.e. discrepancy comparison as specified in RFC 9048 [15]) and receives NCGI from the Relay UE in step 1, the Remote UE verifies using the SNN information received in the EAP-Request/AKA'-Challenge and the SN ID information in the NCGI. If necessary, the Remote UE aborts the authentication if verification fails. The Remote UE skips the network name verification if the Remote UE does not receive NCGI from the Relay.\n7d.\tThe 5G ProSe Remote UE shall return EAP-Response/AKA'-Challenge to the 5G ProSe UE-to-Network Relay over PC5 messages.\n7e.\tThe 5G ProSe UE-to-Network Relay forwards the EAP-Response/AKA'-Challenge together with the transaction identifier of the 5G ProSe Remote UE to the AMF of the 5G ProSe UE-to-Network Relay in a NAS message Relay Authentication Response.\n7f.\tThe AMF of the 5G ProSe UE-to-Network Relay forwards EAP-Response/AKA'-Challenge to the AUSF of the 5G ProSe Remote UE via Nausf_UEAuthentication_ProSeAuthenticate Request.\nThe AUSF of the 5G ProSe Remote UE performs the UE authentication by verifying the received information as described in TS 33.501 [3].\nFor EAP-AKA', the AUSF of the 5G ProSe Remote UE and the 5G ProSe Remote UE may exchange EAP-Request/AKA'-Notification and EAP-Response /AKA'-Notification messages via the AMF of the 5G ProSe UE-to-Network Relay and the 5G ProSe UE-to-Network Relay. After the exchanges, the AUSF of the 5G ProSe Remote UE and the 5G ProSe Remote UE shall use the most significant 256 bits of EMSK as the KAUSF_P in the same way as KAUSF is obtained for EAP-AKA’ in clause 6.1.3.1 in TS 33.501 [3].\n8.\tOn successful authentication, the AUSF of the 5G ProSe Remote UE and the 5G ProSe Remote UE shall generate CP-PRUK as specified in clause A.2 and CP-PRUK ID.\nThe CP-PRUK ID is in NAI format as specified in clause 2.2 of IETF RFC 7542 [14], i.e. username@realm. The username part includes the Routing Indicator from step 5 and the CP-PRUK ID*, and the realm part includes Home Network Identifier. The CP-PRUK ID* is specified in clause A.3.\n9a.\tThe AUSF of the 5G ProSe Remote UE shall select the PAnF (Prose Anchor Function) based on CP-PRUK ID and send the SUPI, RSC, CP-PRUK and CP-PRUK ID in Npanf_ProseKey_Register Request message to the PAnF.\nNOTE 1: The PAnF is selected based on the Routing Indicator in the CP-PRUK ID.\n9b.\tThe PAnF shall store the Prose context info (i.e. SUPI, RSC, CP-PRUK, CP-PRUK ID) for the 5G ProSe Remote UE and send Npanf_ProseKey_Register Response message to the AUSF.\n10a.\tThe AUSF of the 5G ProSe Remote UE shall select the PAnF based on CP-PRUK ID and send received CP-PRUK ID and RSC in Npanf_ProseKey_get Request message.\nNOTE 2: The PAnF is selected based on the Routing Indicator in the CP-PRUK ID.\n10b.\tThe PAnF retrieves CP-PRUK based on the CP-PRUK ID and checks whether the 5G ProSe Remote UE is authorized to use the UE-to-Network Relay service based on received RSC, i.e. the PAnF uses Nudm_SDM operation defined in TS 23.502 [10] to check with the UDM whether the Remote UE is authorized to use  ProSe UE-to-Network Relay service by using the SUPI. If the 5G ProSe Remote UE is authorized and the retrieved CP-PRUK is valid, the PAnF sends Npanf_ProseKey_get Response message with CP-PRUK to the AUSF.\nIf the CP-PRUK is stale, the PAnF treats it as invalid based on local policy. When receiving a Npanf_ProseKey_get request in such case, the PAnF responses with CP-PRUK not found.\n11.\tThe AUSF of the 5G ProSe Remote UE shall generate Nonce_2 and derive the KNR_ProSe key using CP-PRUK, Nonce_1 and Nonce_2 as defined in clause A.4.\n12.\tThe AUSF of the 5G ProSe Remote UE shall send the KNR_ProSe, Nonce_2 in Nausf_UEAuthentication_ProseAuthenticate Response message to the 5G ProSe UE-to-Network Relay via the AMF of the 5G ProSe UE-to-Network Relay. EAP Success message shall be included if step 7 is performed successfully. The AUSF of the 5G ProSe Remote UE shall also include the CP-PRUK ID in the message.\n13.\tWhen receiving a KNR_ProSe from the AUSF of the 5G ProSe Remote UE via the AMF of the 5G ProSe UE-to-Network Relay, the 5G ProSe UE-to-Network Relay derives PC5 session key Krelay-sess from KNR_ProSe as defined in clause 6.3.3.3.3. The 5G ProSe UE-to-Network Relay then derives confidentiality key Krelay-enc (if applicable) and integrity key Krelay-int from Krelay-sess, as defined in clause 6.3.3.3.3 of the present document. KNR_ProSe ID and Krelay-sess ID are established in the same way as KNRP ID and KNRP-sess ID in TS 33.536 [6]. The CP-PRUK ID is sent from the AMF of the 5G ProSe UE to-Network Relay to UE-to-Network Relay. The EAP Success message is also sent from the AMF of the 5G ProSe UE-to-Network Relay to UE-to-Network Relay if received from AUSF.\n14.\tThe 5G ProSe UE-to-Network Relay shall send the received Nonce_2 and 5G ProSe Remote UE's PC5 signalling security policy to the 5G ProSe Remote UE in Direct Security mode command message, which is integrity protected using Krelay-int. EAP Success message shall be included if received from the AMF of the 5G ProSe UE-to-Network Relay.\n15.\tThe 5G ProSe Remote UE shall generate the KNR_ProSe key to be used for remote access via the 5G ProSe UE-to-Network Relay in the same way as defined in step 11. The 5G ProSe Remote UE shall derive PC5 session key Krelay-sess from KNR_ProSe and shall then derive confidentiality and integrity keys from KNR_ProSe in the same way as defined in step 13.\nThe 5G ProSe Remote UE shall verify the Direct Security Mode Command message. Successful verification of the Direct Security Mode Command message assures the 5G ProSe Remote UE that the 5G ProSe UE-to-Network Relay is authorized to provide the relay service.\n16.\tThe 5G ProSe Remote UE shall send the Direct Security Mode Complete message containing its PC5 user plane security policies to the 5G ProSe UE-to-Network relay, which is protected by Krelay-int or/and Krelay-enc derived from Krelay-sess according to the negotiated PC5 signalling policies between the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay.\n17. On receiving the Direct Security Mode Complete message, the 5G ProSe UE-to-Network Relay shall verify the Direct Security Mode Complete message. Successful verification of the Direct Security Mode Complete message assures the 5G ProSe UE-to-Network Relay that the 5G ProSe Remote UE is authorized to get the relay service.\nAfter the successful verification of the Direct Security Mode complete message, the 5G ProSe UE-to-Network Relay responds a Direct Communication Accept message to the 5G ProSe Remote UE to finish the PC5 connection establishment procedures and store the CP-PRUK ID in the security context associated to the PC5 link with the 5G ProSe Remote UE.\n18. When the conditions to send a Remote UE Report reach as specified in TS 23.304 [2], the 5G ProSe Layer-3 UE-to-Network Relay shall send a Remote UE Report (Remote User ID, Remote UE info) message to the SMF of the 5G ProSe UE-to-Network Relay. The 5G ProSe Layer-3 UE-to-Network Relay shall include Remote User ID (i.e. the CP-PRUK ID received in step 13) in the message\n19. If the mapping of the Remote User ID and the 5G ProSe Remote UE's SUPI is not available in the SMF of the 5G ProSe UE-to-Network Relay, the SMF of the 5G ProSe UE-to-Network Relay shall discover the PAnF of the 5G ProSe Remote UE based on the Remote User ID (i.e. the CP-PRUK ID) and sends a Resolve Remote User ID request towards the PAnF in Npanf_ResolveRemoteUserId_Get Request message, including the Remote User ID of the 5G ProSe Remote UE in the message.\nThe PAnF of the 5G ProSe Remote UE shall send a Resolve Remote User ID response to the SMF of the 5G ProSe UE-to-Network Relay in Npanf_ResolveRemoteUserId_Get Response message, including the SUPI of the 5G ProSe Remote UE in the message.\nThe SMF of the 5G ProSe UE-to-Network Relay shall store the Remote User ID, the SUPI of the 5G ProSe Remote UE and the Remote UE info in the 5G ProSe Layer-3 UE-to-Network Relay's SM context for this PDU Session associated with the Relay. The SMF sends Remote UE Report Ack message to the 5G ProSe Layer-3 UE-to-Network Relay.\nFurther communication between the 5G ProSe Remote UE and the Network takes place securely via the 5G ProSe UE-to-Network Relay.\nIf the 5G ProSe Remote UE receives from the 5G ProSe UE-to-Network Relay a Direct Connection Reject due to CP-PRUK ID not found in the network, the 5G ProSe Remote UE shall not attempt to reconnect with the 5G ProSe UE-to-Network Relay using the CP-PRUK ID. The 5G ProSe Remote UE may attempt to connect with the 5G ProSe UE-to-Network Relay using its SUCI.\nNOTE:\tThe CP-PRUK ID not being found condition is detected by the PAnF if it does not find a ProSe context info for the 5G ProSe Remote UE that corresponds to the received CP-PRUK ID. The 5G ProSe UE-to-Network Relay is informed of this condition via the AUSF of the 5G ProSe Remote UE and AMF of the 5G ProSe UE-to-Network Relay.\nFigure 6.3.3.3.3-1 illustrates the PC5 key hierarchy for 5G ProSe, detailing the UE-to-Network relay security over the control plane. The figure showcases the various levels of keys involved in the process, including the network key, service key, and application key. These keys are essential for ensuring secure communication between the user equipment (UE) and the network, particularly in the context of ProSe, which stands for Proximity Services. The control plane plays a crucial role in managing these keys and maintaining the security of the communication process. The figure emphasizes the importance of a well-structured key hierarchy in achieving robust security measures in 5G networks.\nFigure 6.3.3.3.3-1: PC5 Key Hierarchy for 5G ProSe UE-to-Network Relay security over Control Plane\nThe different layers of keys (see figure 6.3.3.3.3-1) are the following:\n-\tKAUSF_P: A key derived based on 5G ProSe Remote UE specific authentication, only used to derive CP-PRUK.\n-\tCP-PRUK: The root credential derived from KAUSF_P that is the root of security of the PC5 unicast link used for 5G ProSe UE-to-Network Relay service.\n-\tKNR_ProSe: This is a 256-bit root key that is established between the two entities that communicating using NR PC5 unicast link.\n-\tKrelay-sess: This is the 256-bit key that is derived by UE from KNR_ProSe and is used derive keys that to protect the transfer of data between the UEs. The Krelay-sess is derived per unicast link same as KNRP-sess specified in TS 33.536 [6]. During activated unicast communication session between the UEs, the Krelay-sess may be refreshed by running the rekeying procedure. The keys for confidentiality and integrity algorithms are derived directly from Krelay-sess. The 16-bit Krelay-sess ID identifies the Krelay-sess.\n-\tKrelay-int, Krelay-enc: The Krelay-int and Krelay-enc are used in the chosen confidentiality and integrity algorithms respectively for protecting PC5-S signalling, PC5 RRC signalling, and PC5 user plane data. These keys are equivalent to NRPIK and NRPEK as specified in TS 33.536 [6]. They are derived from Krelay-sess and are refreshed automatically every time Krelay-sess is changed.\nThe 5G ProSe Layer-3 Remote UE selects N3IWF as specified in TS 23.304 [2].\nThe 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay shall establish security for PC5 connection using either User Plane based solution as specified in clause 6.3.3.2 or Control Plane based solution as specified in clause 6.3.3.3. Then, the 5G ProSe Layer-3 Remote UE performs the security procedures as specified in clause 7.2.1 of TS 33.501 [3].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.4\tSecurity for 5G ProSe Communication via 5G ProSe Layer-2 UE-to-Network Relay",
                            "text_content": "Connection establishment for 5G ProSe Communication via 5G ProSe Layer-2 UE-to-Network Relay is specified in clause 6.5.2.2 of TS 23.304 [2]. During the connection establishment, the 5G ProSe Remote UE and NG-RAN node shall establish AS security as specified in TS 33.501 [3].\nThe 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay shall establish security for PC5 connection using either User Plane based solution as specified in clause 6.3.3.2 or Control Plane based solution as specified in clause 6.3.3.3.2. The requirements on security policies for PC5 connection between the 5G ProSe Remote UE and the Layer-2 UE-to-Network Relay are as follows:\n-\tThe PCF shall be able to provision the PC5 security policies to the 5G ProSe Remote UE and Layer-2 UE-to-Network Relay respectively per ProSe relay service during their service authorization and information provisioning procedures as defined in TS 23.304 [2].\nNOTE:\tIf PC5 UP security policies are included in the PC5 security policies, they are negotiated but not enforced by the 5G ProSe Layer-2 UE-to-Network Relay.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.5\tDirect Communication Request in 5G ProSe UE-to-Network Relay Communication",
                            "text_content": "This clause describes the mechanism to protect the privacy of the UP-PRUK ID/CP-PRUK-ID and RSC in Direct Communication Request (DCR) message when restricted discovery is used for the UE-to-Network Relay service. This clause also describes a mechanism to integrity protect the DCR message when DUIK is provisioned for discovery.\nNOTE: Protection of Direct Communication Request (DCR) is provided at the ProSe layer.\nThe 5G ProSe Remote UE encrypts the UP-PRUK ID/CP-PRUK ID and RSC using the code-receiving security parameters used for discovery. The 5G ProSe UE-to-Network Relay, on receiving the DCR message, decrypts the encrypted UP-PRUK ID/CP-PRUK ID and RSC using the code-sending security parameters used for discovery and verifies if the RSC matches with the one that it sent in the discovery message. If the RSC does not match, the 5G ProSe UE-to-Network Relay shall abort the PC5 direct link establishment procedure.\nThe 5G ProSe Remote UE shall encrypt the UP-PRUK ID/CP-PRUK ID and RSC as follows:\n1)\tIf the UE is configured with Discovery User Confidentiality Key (DUCK), the DCR ciphering key KDCR is set to DUCK. If the UE is configured with Discovery User Scrambling Key (DUSK) but not DUCK, KDCR is set to DUSK. If the UE is neither configured with DUCK nor DUSK, the DCR message is not protected, and Steps 2-3 are skipped.\n2)\tSet Keystream to DCR confidentiality keystream calculated using KDCR, UTC-based counter and RSC as described in clause A.5.\n3)\tXOR the first L bits of the Keystream with the RSC where L is the length of the RSC, and XOR the remaining bits of the Keystream with the UP-PRUK ID/CP-PRUK ID.\nNOTE 1:\tIf UP-PRUK ID/CP-PRUK ID is in NAI format, encryption of the UP-PRUK ID/CP-PRUK ID is performed on the username part of the UP-PRUK ID/CP-PRUK ID.\nThe 5G ProSe UE-to-Network Relay shall decrypt the encrypted UP-PRUK ID/CP-PRUK ID and RSC as follows:\n1)\tIf the UE is configured with DUCK, the DCR ciphering key KDCR is set to DUCK. If the UE is configured with DUSK but not DUCK, KDCR is set to DUSK. If the UE is neither configured with DUCK nor DUSK, the DCR message is not protected, and steps 2-3 are skipped.\n2)\tSet Keystream to DCR confidentiality keystream calculated using KDCR, UTC-based counter and RSC as described in clause A.5.\n3)\tXOR the first L bits of Keystream with the encrypted RSC where L is the length of the encrypted RSC, and XOR the remaining bits of Keystream with the encrypted UP-PRUK ID/CP-PRUK ID.\nNOTE 2:\tIf UP-PRUK ID/CP-PRUK ID is in NAI format, decryption of the UP-PRUK ID//CP-PRUK ID is performed on the username part of the UP-PRUK ID/CP-PRUK ID.\nThe 5G ProSe Remote UE integrity protects the DCR message using the code-receiving security parameters used for discovery. The integrity protection of the DCR message is performed after the privacy protection of UP-PRUK ID/CP-PRUK ID and RSC.\nThe 5G ProSe UE-to-Network Relay, on receiving the DCR message, verifies the integrity of the received DCR message using the code-sending security parameters used for discovery. If the integrity verification of the DCR fails, the 5G ProSe UE-to-Network Relay shall abort the PC5 direct link establishment procedure.\nThe 5G ProSe Remote UE shall integrity protect the DCR as follows:\n1.\tIf the UE is configured with DUIK, the DCR integrity key KINT is set to DUIK. Otherwise, the DCR message is not integrity protected, and steps 2-3 are skipped.\n2.\tCalculate Message Integrity Check (MIC) using KINT, UTC-based counter and the DCR message as described in clause A.9.\n3.\tSet the MIC IE to the calculated MIC.\nThe 5G ProSe UE-to-Network Relay shall verify the integrity of the received DCR message as follows:\n1.\tIf the UE is configured with DUIK, the DCR integrity key KINT is set to DUIK. Otherwise, the DCR message is not integrity protected, and step 2 is skipped.\n2.\tCalculate a MIC using KINT, UTC-based counter and the received DCR message as described in clause A.9 and compare the calculated MIC with the MIC included in the DCR message. If they mismatch, the integrity check fails.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.6\tSecurity for emergency service from 5G ProSe Remote UE via 5G ProSe UE-to-Network Relay",
                            "text_content": "This clause describes the security requirements and the procedures that are specifically applied to support of emergency service via 5G ProSe Layer 2 UE-to-Network Relay and 5G ProSe Layer 3 UE-to-Network Relay defined in TS 23.304 [2].\nWhen a 5G ProSe enabled UE does not have direct connection to the network for emergency service, the UE may attempt to obtain emergency service via 5G ProSe Layer-2 or Layer-3 UE-to-Network Relay. A 5G ProSe enabled UE acting as 5G ProSe UE-to-Network Relay shall have a normal registration to support for relaying emergency service. Dedicated RSC(s) are used for relaying of emergency service as specified in TS 23.304 [2].\nBased on the regulatory requirements in some regions, emergency service over relay may be supported without PC5 link security. RSC(s) dedicated for emergency service needs to be provisioned in the 5G ProSe enabled UEs with capability of 5G ProSe UE-to-Network Relay and/or 5G ProSe Remote UE as specified in TS 23.304 [2] clause 5.1.4.Based on the regulation and the operator policy, there may or may not be discovery security materials provisioned for Emergency RSC.\nThe 5G system shall support the establishment of PC5 communication for emergency service over UE-to-network relay with or without PC5 security.\nThe security requirements defined in clause 6.3.2 and clause 6.3.3.1 apply for the case PC5 link security establishment is required for relaying emergency service.\nOtherwise, the following security requirements apply based on the regulatory requirements in some regions:\n-\tFor relaying emergency service without PC5 link security, protection is not required for emergency service discovery.\n-\tFor relaying emergency service without PC5 link security, the PC5 signalling security shall support NULL ciphering algorithm and NULL integrity protection algorithm.\n-\tFor relaying emergency service without PC5 link security, the PC5 user plane security shall support no integrity protection (by not inserting a MAC-I) and NULL ciphering algorithm.\nNOTE: For layer 2 relaying emergency service, the user plane security  shall be handled as specified in clause 10 of TS 33.501[3].\n-\tFor relaying emergency service without PC5 link security, PEI may be used to identify the 5G ProSe Remote UE.\nA 5G ProSe Remote UE can establish a PC5 security link for Emergency service with a network, via both a 5G ProSe Layer 2 UE-to-Network Relay and a 5G ProSe Layer-3 UE-to-Network Relay as specified in clause 6.3.3.\nBased on the regulation, the operator policy and the UP security policies of the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay for the emergency RSC, the UP traffic may be transmitted via a PC5 link without security protection for case that relaying emergency service with PC5 link security is not required.\nFigure 6.3.6.3.1.1-1 shows the PC5 security establishment procedure for the 5G ProSe UE-to-Network Relay communication when an Emergency Relay Service Code is used. This procedure is based on the procedure in clause 6.3.3.2.2 and clause 6.3.3.3.2.\nFigure 6.3.6.3.1.1 -1: PC5 link security establishment for Emergency Service over UE-to-Network relay illustrates the process of establishing a secure link between a user equipment (UE) and a network relay for emergency services. The figure shows the PC5 interface, which is used for secure communication between the UE and the network. The process involves authentication, encryption, and key management to ensure the integrity and confidentiality of the data transmitted. The figure highlights the importance of secure communication channels in emergency situations, where timely and accurate information is crucial for effective response.\nFigure 6.3.6.3.1.1-1: PC5 link security establishment for Emergency Service over UE-to-Network relay\nIf relaying emergency service with PC5 link security is not required for a 5G ProSe Remote UE has no USIM based on the regulation, there is no discovery security materials (and UP-PRUK in case of UP based security procedure) provisioned for an Emergency RSC.\n0.\tThe 5G ProSe UE retrieves discovery material with the procedures as specified in clause 6.1.3.2. For UP based security procedure, the 5G ProSe Remote UE retrieves UP-PRUK as specified in step 1 of clause 6.3.3.2.2.\nIf the 5G ProSe Remote UE has no USIM, this step is skipped. The discovery security materials, if exist,  and the Emergency RSC are locally configured in the 5G ProSe UE.\n1. \tThe discovery procedure for the Emergency RSC is performed between a 5G ProSe Remote UE, and the 5G ProSe UE-to-Network Relay, using the discovery parameters and discovery security material that are obtained in step 0.\nIf no discovery security material is provisioned or locally configured, the announcement and discovery of Emergency RSC may be performed without security protection if the regulation allow.\n2.\tIf the 5G ProSe Remote UE has a USIM, the 5G ProSe Remote UE sends a Direct Communication Request (DCR) to trigger PC5 security establishment for Emergency RSC using UP based security procedure as specified in step  4 of clause 6.3.3.2.2 or CP based security procedure as specified in step 3 to step 13 of clause 6.3.3.3.2.\nIf the 5G ProSe Remote UE has no USIM, then the 5G ProSe Remote UE sends a Direct Communication Request that contains PEI and Emergency RSC to the 5G ProSe UE-to-Network Relay. The Direct Communication Request message including PEI and Emergency RSC may be sent without protection if no discovery security material is provisioned or locally configured in the 5G ProSe Remote UE.\nIf UP/CP-PRUK ID or SUCI is received from the 5G ProSe Remote UE, the 5G ProSe UE-to-Network Relay performs UP based security procedure as specified in step  4 of clause 6.3.3.2.2 or CP based security procedure as specified in step 3 to step 13 of clause 6.3.3.3.2.\nIf only PEI and Emergency RSC are received from the 5G ProSe Remote UE, the 5G ProSe UE-to-Network Relay skips step 4 of clause 6.3.3.2.2 for UP based security procedure or step 3 to step 13 of clause 6.3.3.3.2 for CP based security procedure if the regulation and the operator policy allow. The 5G ProSe UE-to-network relay shall store the PEI.\n3a.\tIf UP based security procedure as specified in step 4 of clause 6.3.3.2.2 or CP based security procedure as specified in step 3 to step 13 of clause 6.3.3.3.2 in step 2 was successfully performed, then the 5G ProSe UE-to-Network Relay shall proceed with the Direct Security Mode procedure as specified in steps 5a-5d in clause 6.3.3.2.2 for UP based security procedure or step 14 to step 16 of clause 6.3.3.3.2 for CP based security procedure.\nIf UP based security procedure as specified in step 4 of clause 6.3.3.2.2 or CP based security procedure as specified in step 3 to step 13 of clause 6.3.3.3.2 in step 2 failed or was skipped, the 5G ProSe UE-to-Network Relay shall send Direct Security Mode Command message to the 5G ProSe Remote UE indicating NULL ciphering algorithm and NULL integrity protection algorithm as chosen algorithms if the regulation and the operator policy allow.\nWhen there has been no successful run of authentication of the 5G ProSe Remote UE, the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay independently generate the KNRP or KNR_ProSe in an implementation defined way. All key derivations proceed as if they were based on a KNRP or KNR_ProSe generated from a successful authentication run.\nIf the 5G ProSe Remote UE receives the Direct Security Mode Command message indicating NULL integrity algorithm and NULL encryption algorithm as chosen algorithms, then the 5G ProSe Remote UE shall accept NULL ciphering and NULL integrity algorithms indicated in Direct Security Mode Command message if, and only if, the 5G ProSe Remote UE has sent an Emergency RSC in step 2. The 5G ProSe Remote UE shall set the UP integrity protection as not activated for this connection.\n3b.\tIf the 5G ProSe Remote UE receives the Direct Security Mode Command message indicating non-NULL integrity and non-NULL encryption algorithm then the 5G ProSe Remote UE proceeds step 5a-5d in clause 6.3.3.2.2 for UP based security procedure or step 14- step 16 of clause 6.3.3.3.2 for CP based security procedure.\nIf the 5G ProSe Remote UE receives the Direct Security Mode Command message indicating NULL integrity and NULL encryption algorithm in step 3a and has accepted the message, then the 5G ProSe Remote UE shall send an Direct Security Mode Complete message and shall include the UP integrity protection policy as NOT NEEDED in the Direct Security Mode Complete message.\nIf the 5G ProSe UE-to-network relay receives the Direct Security Mode Complete message with no protection, the 5G ProSe UE-to-Network Relay shall only accept the message if 5G ProSe UE-to-Network Relay sent Direct Security Mode Command message including NULL integrity and NULL encryption algorithm in step 3a and if the 5G ProSe Remote UE has sent an Emergency RSC in step 2.\n4a. \tIf UP based security procedure as specified in step 4 of clause 6.3.3.2.2 or CP based security procedure as specified in step 3 to step 13 of clause 6.3.3.3.2 in step 2 failed or was skipped and PEI is not received from Direct Communication Request, the 5G ProSe UE-to-Network Relay sends a Remote Identity Request message to the 5G ProSe Remote UE to retrieve the PEI based on the regulation and the operator policy.\n4b. \tWhen the 5G ProSe Remote UE receives a Remote Identity Request message from the 5G ProSe Remote UE, then the 5G ProSe Remote UE sends a Remote Identity Response message including its PEI to the 5G ProSe UE-to-network relay. The 5G ProSe UE-to-network relay shall store the PEI.\n5.\tIf the 5G ProSe UE-to-network relay receives the Direct Security Mode Complete message in step 3b, and after successful verification, the 5G ProSe UE-to-Network Relay responds with a protected Direct Communication Accept message to the 5G ProSe Remote UE to complete the PC5 connection establishment procedure.\nIf the 5G ProSe UE-to-network relay receives the Direct Security Mode Complete message with no protection, and the 5G ProSe UE-to-Network Relay has accepted the message based on the conditions described in step 3b, the 5G ProSe UE-to-Network Relay shall send Direct Communication Accept message with no protection to the 5G ProSe Remote UE.\nThe 5G ProSe UE-to-Network Relay includes the configuration of UP integrity and confidentiality protection based on the agreed UP security policy in the Direct Communication Accept message as specified in TS 33.536 [6].\n6.\tThe 5G ProSe Remote UE and 5G ProSe UE-to-Network Relay continues the rest of procedure for the emergency service over relay as specified in TS 23.304 [2]. The 5G ProSe UE-to-Network Relay sends a Remote UE Report to the SMF for the Emergency RSC. The 5G ProSe UE-to-Network Relay includes Remote User ID i.e. (UP-/CP-) PRUK ID if UP or CP based security procedure is successfully performed. Otherwise, the 5G ProSe UE-to-Network Relay includes the PEI of the 5G ProSe Remote UE in the Remote UE Report.\nIf UP confidentiality protection is not activated for this connection, the UP confidentiality protection algorithm is the same as the selected signalling confidentiality algorithm as specified in TS 33.536 [6].\nIf UP integrity protection is not activated for this connection, the 5G ProSe Remote UE and the 5G ProSe UE-to-Network Relay do not put MAC-I into PDCP packet.\nUP protection for the layer 2 relaying emergency service shall be handled as specified in clause 10 of TS 33.501[3].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.7\tSecurity mechanism selection in path switching between two 5G ProSe UE-to-Network Relays",
                            "text_content": "Based on the UE-to-Network relay reselection mechanism as per clause 5.15 of TS 23.304 [2], the Remote UE performs the path switching between two UE-to-Network Relays with the following additional security considerations:\n-\tThe Remote UE first selects the RSC indicating the same security mechanism with the original path (i.e. User Plane based solution as specified in clause 6.3.3.2 or Control Plane based solution as specified in clause 6.3.3.3.2) to establish the PC5 security link with the new UE-to-Network Relay.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.4\tSecurity for broadcast mode 5G ProSe Direct Communication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.4.1\tGeneral",
                            "text_content": "This clause specifies the security requirements and the procedures of the broadcast mode 5G ProSe Direct Communication.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.2\tSecurity requirements",
                            "text_content": "There are no requirements for securing the broadcast mode 5G ProSe Direct Communication.\nThe 5G System shall protect against linkability and trackability attacks on Layer-2 ID and IP address for broadcast mode.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.3\tSecurity procedures",
                            "text_content": "There are no particular procedures defined for securing the broadcast mode 5G ProSe Direct Communication.\nThe broadcast mode security mechanism to randomise the UE’s source Layer-2 ID and source IP address including IP prefix (if used), as defined in clause 5.5 of TS 33.536 [6], is reused in 5G ProSe to provide broadcast mode 5G ProSe Direct Communication security.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.5\tSecurity for groupcast mode 5G ProSe Direct Communication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.5.1\tGeneral",
                            "text_content": "This clause specifies the security requirements and the procedures of the groupcast mode 5G ProSe Direct Communication.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.5.2\tSecurity requirements",
                            "text_content": "There are no requirements for securing the groupcast mode 5G ProSe Direct Communication.\nThe 5G System shall protect against linkability and trackability attacks on Layer-2 ID and IP address for groupcast mode.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.5.3\tSecurity procedures",
                            "text_content": "There are no particular procedures defined for securing the groupcast mode 5G ProSe Direct Communication.\nThe groupcast mode security mechanism to randomise the UE’s source Layer-2 ID and source IP address including IP prefix (if used), as defined in clause 5.5 of TS 33.536 [6], is reused in 5G ProSe to provide groupcast mode 5G ProSe Direct Communication security.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.6\tSecurity for 5G ProSe UE-to-UE Relay Communication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.6.1\tGeneral",
                            "text_content": "This clause describes the security requirements and the security procedures that are specifically for 5G ProSe UE-to-UE Relay Communication defined in TS 23.304 [2].\nThe security requirements for 5G ProSe Layer-3 UE-to-UE Relay and 5G ProSe Layer-2 UE-to-UE Relay are defined in clause 6.6.2. The security procedures for 5G ProSe L3 UE-to-UE Relay and 5G ProSe Layer-2 UE-to-UE Relay are defined in clause 6.6.3 and clause 6.6.4 respectively.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.2\tSecurity requirements",
                            "text_content": "The following security requirements apply to both 5G ProSe Layer-3 UE-to-UE Relay and 5G ProSe Layer-2 UE-to-UE Relay:\n-\tThe 5G System shall support the authorization of the UE as a 5G ProSe UE-to-UE Relay in the 5G ProSe UE-to-UE Relay scenario.\n-\tThe 5G System shall support the authorization of the UE as a 5G ProSe End UEs in the 5G ProSe UE-to-UE Relay scenario.\n-\tThe 5G System shall support confidentiality protection, integrity protection, and replay protection for secure communication between the 5G ProSe End UEs via 5G ProSe UE-to-UE Relays.\n-\tThe 5G System shall provide means for mitigating trackability and linkability attacks on peer 5G ProSe End UEs during communications over a UE-to-UE Relay.\n-\tThe PCF shall be able to provision the PC5 security policies to the 5G ProSe End UEs and the 5G ProSe UE-to-UE Relay per Relay Service Code during service authorization and information provisioning procedure as defined in TS 23.304 [2].\n-\tThe 5G Prose End UEs shall support to establish a secure PC5 link with the 5G Prose UE-to-UE Relay, with or without the network assistance.\n-\tThe 5G ProSe End UEs shall establish a different PC5 security context with each different 5G ProSe UE-to-UE Relay and for each different Relay Service Code.\n-\tThe 5G system shall support a means to protect security (i.e., the integrity, confidentiality, and replay protection) of user-plane and control-plane messages, including during 5G ProSe UE-to-UE Relay path switch.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.3\tSecurity for 5G ProSe Communication via 5G ProSe Layer-3 UE-to-UE Relay",
                            "text_content": "The User Plane (UP) based procedures as specified in clause 6.3.3.2 and the Control Plane (CP) based procedures as specified in clause 6.3.3.3 are used to provide authentication, authorisation and security establishment between the 5G ProSe Layer-3 UE-to-UE Relay and Source End UE with the following modification:\n-\tThe Remote UE is replaced by the Source End UE.\n-\tThe UE-to-Network Relay is replaced by the UE-to-UE Relay.\nThe User Plane (UP) based procedures as specified in clause 6.3.3.2 and the Control Plane (CP) based procedures as specified in clause 6.3.3.3 are used to provide authentication, authorisation and security establishment between the 5G ProSe Layer-3 UE-to-UE Relay and the Target End UE with the following modification:\n-\tThe Remote UE is replaced by the Target End UE.\n-\tThe UE-to-Network Relay is replaced by the UE-to-UE Relay.\n-\tThe procedure is initiated after security establishment between the 5G ProSe Layer-3 UE-to-UE Relay and the Source End UE is successfully completed, as specified in clause 6.7 of TS 23.304 [2].\n-\tUpon receiving the Direct Communication Request (DCR) message from the Source 5G ProSe End UE which includes an RSC and if the Network Assistance Security Indicator associated with the RSC indicates the security procedures with network assistance are required, the 5G ProSe UE-to-UE Relay needs to make sure it is inside network coverage prior to initiating the security procedure with network assistance. If the 5G ProSe UE-to-UE Relay is not in network coverage, it shall reject the Direct Communication Request message.\n-\tThe steps 4-5d in clause 6.3.3.2.2 and the steps 3-16 in clause 6.3.3.3.2 are not triggered by the Direct Communication Request (DCR) message sent by the UE-to-UE Relay. Upon receiving the DCR message from the UE-to-UE Relay which includes an RSC and if the Network Assistance Security Indicator associated with the RSC indicates the security procedures with network assistance are required which triggers the second hop PC5 link security establishment, the Target End UE shall inform the UE-to-UE Relay to initiate the above steps with the message pair Direct Communication Security Request and Direct Communication Security Accept. The Direct Communication Security Request message shall include the SUCI or UP-/CP-PRUK ID of Target End UE, Relay Service Code and freshness_parameter_1. Upon receiving the Direct Communication Security Request message, the UE-to-UE Relay shall make sure it is inside network coverage prior to initiating the security procedures with network assistance. If it is outside network coverage, it shall reject the Direct Communication Security Request message..\n- The Direct Communication Request sent by UE-to-UE relay to target End UE does not include a PRUK-ID, and thus, the security mechanism in clause 6.3.5 is modified to only protect the RSC by modifying Annex A.5 to generate a keystream of the length of the RSC.\n-\tThe Direct Communication Security Request message is protected by reusing the protection method defined in clause 6.3.5.\nFigure 6.6.3.1-1 shows the high level flow for the second hop PC5 link security between the 5G ProSe Layer-3 UE-to-UE Relay and the Target End UE.\nFigure 6.6.3.1 illustrates the PC5 security establishment procedure between a 5G ProSe UE-to-UE Relay and the Target 5G ProSe End UE. The figure depicts the process of establishing a secure connection between the two entities, highlighting the role of the Relay in facilitating communication and ensuring data integrity. Key components include the 5G ProSe End UE, 5G ProSe UE-to-UE Relay, and the PC5 protocol, which is responsible for establishing a secure connection between the two parties. The figure also shows the flow of data packets and the authentication process, emphasizing the importance of security in 5G ProSe communication.\nFigure 6.6.3.1-1: PC5 security establishment procedure between 5G ProSe UE-to-UE Relay and the Target 5G ProSe End UE\nThe security procedure in clause 6.2 is used to establish a secure PC5 link between the End UE and the 5G ProSe Layer-3 UE-to-UE Relay without network assistance with the following modifications.\n-\tThe RSC is included in the DCR message.\n-\tThe Direct Communication Accept message is sent to the Source End UE after security establishment between the 5G ProSe Layer-3 UE-to-UE Relay and the Target End UE is successfully completed.\nA Network Assistance Security Indicator per RSC is provisioned (i.e. follows the authorisation and provisioning for ProSe service as specified in clause 5.1.1 of TS 23.304 [2]) in the 5G ProSe End UEs and 5G ProSe UE-to-UE Relay to indicate which mechanism is to be used between the security procedures with the network assistance and the security procedures without network assistance. The 5G ProSe End UEs shall select the mechanism between security procedures with network assistance and security procedures without network assistance based on the Network Assistance Security Indicator, while the 5G ProSe UE-to-UE Relay shall select the mechanism between security procedures with network assistance and security procedures without network assistance based on the Network Assistance Security Indicator and its 3GPP coverage status.\nFor 5G ProSe UE-to-UE Relay Communication with model A discovery, the 5G ProSe UE-to-UE Relay may select both RSCs associated with the security procedures with network assistance and the security procedures without network assistance when the 5G ProSe UE-to-UE Relay is in 3GPP coverage. The 5G ProSe UE-to-UE Relay shall only select the RSC associated with the security procedures without network assistance when the 5G ProSe UE-to-UE Relay is out of 3GPP coverage. Then, the 5G ProSe UE-to-UE Relay broadcasts a Discovery Announcement message including the selected RSC. The source End UE shall use the security procedures with network assistance if the Network Assistance Security Indicator associated with the RSC indicates the security procedures with network assistance (as described in clause 6.6.3.1). Otherwise, if the Network Assistance Security Indicator associated with the RSC indicates the security procedures without network assistance, the source End UE shall use the security procedures without network assistance (as described in clause 6.6.3.2).\nFor 5G ProSe UE-to-UE Relay Communication with model B discovery, the source End UE may select both RSCs associated with the security procedures with network assistance and the security procedures without network assistance, based on the desired mechanism. Then, the source End UE broadcasts a Discovery Solicitation message including the selected RSC. The 5G ProSe UE-to-UE Relay shall use the security procedures with network assistance if the Network Assistance Security Indicator associated with the RSC indicates the security procedures with network assistance and it is inside 3GPP coverage. Otherwise, if the Network Assistance Security Indicator associated with the RSC indicates the security procedures without network assistance, the 5G ProSe UE-to-UE Relay shall use the security procedures without network assistance. The 5G ProSe UE-to-UE Relay shall ignore the Discovery Solicitation message if the selected RSC is associated with the security procedures with network assistance and 5G ProSe UE-to-UE Relay is out of the network coverage.\nThe privacy protection procedure in clause 6.2.4 of the present document is used for the privacy protection of the communication between the 5G ProSe End UE and the 5G ProSe Layer-3 UE-to-UE Relay, in addition to the link identifier update procedure in clause 6.7.1.2 of TS 23.304 [2].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.4\tSecurity for 5G ProSe Communication via 5G ProSe Layer-2 UE-to-UE Relay",
                            "text_content": "The security procedure in clause 6.6.3 is used to establish a secure PC5 signalling between the End UE and the 5G ProSe Layer-2 UE-to-UE Relay.\nThe security procedure in clause 6.2 is used to establish End-to-End security link between the End UEs via the 5G ProSe Layer-2 UE-to-UE Relay\nThe privacy protection procedure in clause 6.2.4 of the present document is used for the privacy protection of the End-to-End communication between the 5G ProSe End UEs via a 5G ProSe Layer-2 UE-to-UE Relay and the communication between the 5G ProSe End UE and the 5G ProSe Layer-2 UE-to-UE Relay.\nDuring the negotiated 5G ProSe Layer-2 UE-to-UE Relay reselection defined in clause 6.7.4.2 of TS 23.304 [2], a new KNRP ID is agreed between the 5G ProSe End UEs via a first 5G ProSe Layer-2 UE-to-UE Relay as specified in clause 5.3.3.2.2.2 of TS 33.536 [9] with the following modification:\n-\tA new KNRP ID is agreed using a Layer-2 Link Modification procedure via the first 5G ProSe Layer-2 UE-to-UE Relay instead of Layer-2 link release procedure. The 5G ProSe End UEs use the new KNRP ID to establish a connection via the second 5G ProSe Layer-2 UE-to-UE Relay.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "7\t5G ProSe services",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "7.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause provides the present document of the SBA services defined for 5G ProSe.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7.2\t5G PKMF services",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7.2.1\tGeneral",
                            "text_content": "For UE-to-Network discovery, the 5G PKMF supports the authorization request from the 5G PKMF in another PLMN via the new service Npkmf_Discovery. The 5G PKMF supports the key request from another 5G PKMF in another PLMN via the new service operation Npkmf_PKMFKeyRequest_ProseKey. The 5G PKMF also provides Remote User ID of a 5G ProSe Remote UE to be used in Remote UE Report and supports resolving Remote User ID to SUPI.\nFor the ProSe UE-to-UE Relay discovery and communication, the 5G ProSe End UE plays the role of the 5G ProSe Remote UE, and the 5G ProSe UE-to-UE Relay plays the role of the 5G ProSe UE-to-Network Relay.\nTable 7.2.1-1 shows the services exposed by 5G PKMF supporting 5G ProSe.\nTable 7.2.1-1: 5G ProSe Services provided by 5G PKMF\n\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 7.2.1-1: 5G ProSe Services provided by 5G PKMF",
                                    "table number": 3,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "7.2.2\tNpkmf_PKMFKeyRequest service",
                            "text_content": "Service operation name: Npkmf_PKMFKeyRequest_ProseKey.\nDescription: Provides ProSe related keying material.\nInput, Required: Relay Service Code, KNRP freshness parameter 1:\n1)\tIn the initial Key Request: SUCI of the 5G ProSe Remote UE or UP-PRUK ID.\n2)\tIn the subsequent Key Requests for Synchronization Failure handling: RAND, AUTS.\nInput, Optional: None.\nOutput, Required: KNRP, KNRP freshness parameter 2.\nOutput, Optional: GPI.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7.2.3\tNpkmf_ResolveRemoteUserId service",
                            "text_content": "Service operation name: Npkmf_ResolveRemoteUserId_Get\nDescription: The NF consumer requests the PKMF to resolve the Remote User ID.\nInput, Required: Remote User ID (UP-PRUK ID).\nInput, Optional: HPLMN ID.\nOutput, Required: SUPI.\nOutput, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7.2.4\tNpkmf_Discovery service",
                            "text_content": "Service operation name: Npkmf_Discovery_AnnounceAuthorize\nDescription: The consumer NF obtains the authorization from the 5G PKMF for announcing in the PLMN.\nInput, Required: User Info ID, RSC.\nInput, Optional: None.\nOutput, Required: Authorization result.\nOutput, Optional: None.\nService operation name: Npkmf_Discovery_MonitorKey\nDescription: The consumer NF obtains the discovery key from the 5G PKMF for monitoring in the PLMN.\nInput, Required: User Info ID, RSC, PC5 UE security capability.\nInput, Optional: None,\nOutput, Required: The chosen PC5 ciphering algorithm, discovery security materials.\nOutput, Optional: Discovery User Integrity Key (DUIK).\nService operation name: Npkmf_Discovery_DiscoveryKey\nDescription: The consumer NF obtains the discovery key from the 5G PKMF for a discoverer UE in the PLMN to operate Model B restricted discovery.\nInput, Required: User info ID, RSC, PC5 UE security capability.\nInput, Optional: None.\nOutput, Required: The chosen PC5 ciphering algorithm, discovery security materials.\nOutput, Optional: Discovery User Integrity Key (DUIK).\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "7.3\tAUSF services",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7.3.1\tGeneral",
                            "text_content": "The AUSF of the 5G ProSe Remote UE supports the 5G ProSe Remote UE specific authentication of a 5G ProSe Remote UE via the AMF of the 5G ProSe UE-to-Network Relay and 5G ProSe UE-to-Network Relay via the new service operation Nausf_UEAuthentication_ProseAuthenticate for the existing Nausf_UEAuthentication service.\nFor the 5G ProSe UE-to-UE Relay discovery and communication, the 5G ProSe End UE plays the role of the 5G ProSe Remote UE, and the 5G ProSe UE-to-UE Relay plays the role of the 5G ProSe UE-to-Network Relay.\nTable 7.3.1-1 shows the services exposed by AUSF supporting 5G ProSe.\nTable 7.3.1-1: 5G ProSe Services provided by AUSF\n\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 7.3.1-1: 5G ProSe Services provided by AUSF",
                                    "table number": 4,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "7.3.2\tNausf_UEAuthentication service",
                            "text_content": "Service operation name: Nausf_UEAuthentication_ProseAuthenticate.\nDescription: Authenticate the 5G ProSe Remote UE and provides Prose related keying material.\nInput, Required: One of the options below:\n1)\tIn the initial authentication request: SUCI or CP-PRUK ID of the 5G ProSe Remote UE, Relay Service Code, Nonce_1, UE-to-Network Relay’s serving network name.\n2)\tIn the subsequent authentication requests: EAP message.\nInput, Optional: None.\nOutput, Required: One of the options below:\n1)\tEAP message,\n2)\tAuthentication result and if success KNR_ProSe, Nonce_2 and CP-PRUK ID.\nOutput, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "7.4\tUDM Services",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7.4.1\tGeneral",
                            "text_content": "A UDM supports providing the authentication vector for 5G ProSe Remote UE specific authentication and for 5G ProSe End UE specific authentication via the new service operation Nudm_UEAuthentication_GetProseAv service operation of the existing Nudm_UEAuthentication service.\nTable 7.4.1-1 shows the services exposed by UDM supporting 5G ProSe.\nTable 7.4.1-1: 5G ProSe Services provided by UDM\n\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 7.4.1-1: 5G ProSe Services provided by UDM",
                                    "table number": 5,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "7.4.2\tNudm_UEAuthentication Service",
                            "text_content": "Service operation name: Nudm_UEAuthentication_GetProseAv.\nDescription: Requester NF gets the authentication data for ProSe from UDM.\nInputs, Required: SUCI, Relay Service Code, Serving network name.\nInputs, Optional: Synchronization Failure indication and related information (i.e. RAND/AUTS).\nOutputs, Required: Authentication Vector for Prose, SUPI.\nOutputs, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7.4.3\tNudm_UEIdentifier Service",
                            "text_content": "Service operation name: Nudm_UEIdentifier_Deconceal.\nDescription: Requester NF gets the SUPI from the UDM.\nInputs, Required: SUCI.\nInputs, Optional: None.\nOutputs, Required: SUPI.\nOutputs, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "7.5\tProse Anchor Function Services",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7.5.1\tGeneral",
                            "text_content": "The Prose Anchor Function (PAnF) supports providing storage for the Prose context info (i.e. SUPI, CP-PRUK, CP-PRUK ID, RSC) for a 5G ProSe Remote UE and the Prose context info for a 5G ProSe End UE. The PAnF also provides Remote User ID of a 5G ProSe Remote UE to be used in Remote UE Report and supports resolving Remote User ID to SUPI.\nTable 7.5.1-1 shows the PAnF Service and the PAnF Service Operations.\nTable 7.5.1-1: List of PAnF Services\n\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 7.5.1-1: List of PAnF Services",
                                    "table number": 6,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "7.5.2\tNpanf_ProseKey service",
                            "text_content": "Service operation name: Npanf_ProseKey_Register.\nDescription: The NF consumer requests the PAnF to store the Prose context info (i.e. SUPI, CP-PRUK, CP-PRUK ID, RSC).\nInput, Required: SUPI, CP-PRUK ID, CP-PRUK, Relay Service Code.\nInput, Optional: None.\nOutput, Required: None.\nOutput, Optional: None.\nService operation name: Npanf_ProseKey_Get.\nDescription: The NF consumer requests CP-PRUK from the PAnF.\nInput, Required: CP-PRUK ID, Relay Service Code.\nInput, Optional: None.\nOutput, Required: CP-PRUK.\nOutput, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7.5.3\tVoid",
                            "text_content": "",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7.5.4\tNpanf_ResolveRemoteUserId service",
                            "text_content": "Service operation name: Npanf_ResolveRemoteUserId_Get\nDescription: The NF consumer requests the PAnF to resolve the Remote User ID.\nInput, Required: Remote User ID (CP-PRUK ID).\nInput, Optional: None.\nOutput, Required: SUPI.\nOutput, Optional: None.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "A.1\tKDF interface and input parameter construction",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "A.1.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "All key derivations for 5G ProSe shall be performed using the Key Derivation Function (KDF) specified in clause B.2.2 of TS 33.220 [8].\nThis clause specifies how to construct the input string, S, and the input key, KEY, for each distinct use of the KDF. Note that \"KEY\" is denoted \"Key\" in TS 33.220 [8].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "A.1.2\tFC value allocations",
                    "description": "",
                    "summary": "",
                    "text_content": "The FC number space used is controlled by TS 33.220 [8], FC values allocated for the present document are: 0x85, 0x86, 0x87, 0x88, 0x89, 0x8A, 0x8B.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "A.2\tCP-PRUK derivation function",
            "description": "When deriving a CP-PRUK from KAUSF_P, the following parameters shall be used to form the input S to the KDF:\n-\tFC = 0x85;\n-\tP0 = SUPI;\n-\tL0 = length of SUPI;\n-\tP1 = relay service code;\n-\tL1 = length of relay service code.\nThe input key KEY is KAUSF_P.\nSUPI shall have the same value as parameter P0 in clause A.7.0 of TS 33.501 [3].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.3\tDerivation of CP-PRUK ID*",
            "description": "When deriving the CP-PRUK ID* from KAUSF_P, the following parameters are used to form the input S to the KDF:\n-\tFC = 0x86;\n-\tP0 = \"PRUK-ID\";\n-\tL0 = length of \"PRUK-ID\";\n-\tP1 = relay service code;\n-\tL1 = length of relay service code;\n-\tP2 = SUPI;\n-\tL2 = length of SUPI.\nThe input key KEY is KAUSF_P.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.4\tKNR_ProSe derivation function",
            "description": "When deriving the KNR_ProSe from CP-PRUK key, the following parameters shall be used to form the input S to the KDF:\n-\tFC = 0x87;\n-\tP0 = Nonce_2;\n-\tL0 = length of Nonce_2;\n-\tP1 = Nonce_1;\n-\tL1 = length of Nonce_1.\nThe input key KEY shall be CP-PRUK key.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.5\tCalculation of DCR confidentiality keystream",
            "description": "When calculating the message-specific confidentiality keystream, the following parameters shall be used to form the input S to the KDF that is specified in Annex B of TS 33.220 [8]:\n-\tFC = 0x88\n-\tP0 = UTC-based counter\n-\tL0 = length of UTC-based counter (i.e. 0x00 0x04)\n-\tP1 = RSC\n-\tL1 = length of RSC (i.e. 0x00 0x03).\nThe input key shall be the 256-bit selected key in Step 1 of clause 6.3.5.2.\nThe DCR confidentiality keystream is set to L least significant bits of the output of the KDF, where L = the length of the RSC + the length of the UP-PRUK ID.\nNOTE:\tIf UP-PRUK ID is in NAI format, the length of the UP-PRUK ID is determined by the username part of the UP-PRUK ID.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.6\tCalculation of MIC value for discovery message",
            "description": "When calculating a MIC using the Discovery Key for open discovery or the DUIK for restricted discovery, the following parameters shall be used to form the input S to the KDF that is specified in Annex B of TS 33.220 [8]:\n-\tFC = 0x89.\n-\tP0 = UTC-based counter associated with the discovery slot.\n-\tL0 = length of above (i.e. 0x00 0x04).\n-\tP1 = discovery message with the MIC value field set to all zeros.\n-\tL1 = length of above.\nThe MIC is set to the 32 least significant bits of the output of the KDF.\nThe Discovery Key, DUIK, Time parameter and discovery message follow the encoding also specified in Annex B of TS 33.220 [8].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.7\tMessage-specific confidentiality mechanisms for discovery",
            "description": "Message-specific confidentiality protection is provided by ProSe layer between ProSe UEs.\nThe use and mode of operation of the ciphering algorithms are specified in Annex D in TS 33.501 [3].\nThe input parameters to the ciphering algorithms as described in Annex D in TS 33.501 [3] are:\n-\tKEY: 128 least significant bits of the output of the KDF (DUCK, UTC-based counter, MIC)\n-\tCOUNT: UTC-based counter\n-\tBEARER: 0x00\n-\tDIRECTION: 0x00\n-\tLENGTH: LEN(discovery message) - (LEN(Message Type) + LEN(UTC-based counter LSB) + LEN(MIC)), where LEN(x) is the length of x in number of bits\nKEY is set to as such to generate message-specific keystream as in TS 33.303 [4].\nThe output keystream of the ciphering algorithm (output_keystream) is then masked with the Encrytped_bits_mask to produce the final keystream for the message-specific confidentiality protection (KEYSTREAM):\nKEYSTREAM = output_keystream AND (Encrypted_bits_mask || 0xFF..FF)\nThe KEYSTREAM is XORed with the discovery message for message-specific confidentiality protection.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.8\tCalculation of KNRP for UE-to-Network relays",
            "description": "When calculating KNRP from UP-PRUK, the following parameters shall be used to form the input S to the KDF that is specified in Annex B of TS 33.220 [8]:\n-\tFC = 0x8A\n-\tP0 = Relay Service Code\n-\tL0 = length of Relay Service Code (i.e. 0x00 0x03)\n-\tP1 = KNRP freshness parameter 1\n-\tL1 = length of KNRP freshness parameter 1 (i.e. 0x00 0x10)\n-\tP2 = KNRP freshness parameter 2\n-\tL2 = length of KNRP freshness parameter 2 (i.e. 0x00 0x10)\nThe input key shall be the 256-bit UP-PRUK.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.9\tCalculation of MIC value for Direct Communication Request",
            "description": "When calculating a MIC using the DUIK to integrity protect Direct Communication Request (DCR) message, the following parameters shall be used to form the input S to the KDF that is specified in Annex B of TS 33.220 [8]:\n-\tFC = 0x8B.\n-\tP0 = UTC-based counter.\n-\tL0 = length of above (i.e. 0x00 0x04).\n-\tP1 = DCR message with the MIC value field set to all zeros.\n-\tL1 = length of above.\nThe MIC is set to the 32 least significant bits of the output of the KDF.\nThe DUIK, UTC-based counter and DCR message follow the encoding also specified in Annex B of TS 33.220 [8].\nTo achieve source authenticity of discovery messages, the third security requirement in clause 6.1.2, a UE receiving a discovery message can verify the source authenticity of the received discovery message by using the provisioned DUIK under the assumption that the UEs provisioned with the same DUIK are trusted.\nAlternatively, if receiving UEs are not provisioned with the DUIK, the network can verify the source authenticity of discovery messages via match report procedure.\n\n",
            "summary": "",
            "tables": [
                {
                    "description": "",
                    "table number": 7,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        }
    ]
}