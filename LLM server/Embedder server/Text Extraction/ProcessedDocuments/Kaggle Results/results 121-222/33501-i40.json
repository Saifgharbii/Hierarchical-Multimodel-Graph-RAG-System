{
    "document_name": "33501-i40.docx",
    "content": [
        {
            "title": "Foreword",
            "description": "This Technical Specification has been produced by the 3rd Generation Partnership Project (3GPP).\nThe contents of the present document are subject to continuing work within the TSG and may change following formal TSG approval. Should the TSG modify the contents of the present document, it will be re-released by the TSG with an identifying change of release date and an increase in version number as follows:\nVersion x.y.z\nwhere:\nx\tthe first digit:\n1\tpresented to TSG for information;\n2\tpresented to TSG for approval;\n3\tor greater indicates TSG approved document under change control.\ny\tthe second digit is incremented for all changes of substance, i.e. technical enhancements, corrections, updates, etc.\nz\tthe third digit is incremented when editorial only changes have been incorporated in the document.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "1\tScope",
            "description": "The present document specifies the security architecture, i.e., the security features and the security mechanisms for the 5G System and the 5G Core, and the security procedures performed within the 5G System including the 5G Core and the 5G New Radio.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "2\tReferences",
            "description": "The following documents contain provisions which, through reference in this text, constitute provisions of the present document.\n-\tReferences are either specific (identified by date of publication, edition number, version number, etc.) or non-specific.\n-\tFor a specific reference, subsequent revisions do not apply.\n-\tFor a non-specific reference, the latest version applies. In the case of a reference to a 3GPP document (including a GSM document), a non-specific reference implicitly refers to the latest version of that document in the same Release as the present document.\n[1]\t3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".\n[2]\t3GPP TS 23.501: \"System Architecture for the 5G System\".\n[3]\t3GPP TS 33.210: \"3G security; Network Domain Security (NDS); IP network layer security\".\n[4]\tIETF RFC 4303: \"IP Encapsulating Security Payload (ESP)\".\n[5]\t3GPP TS 33.310: \"Network Domain Security (NDS); Authentication Framework (AF)\".\n[6]\tIETF RFC 4301: \"Security Architecture for the Internet Protocol\".\n[7]\t3GPP TS 22.261: \"Service requirements for next generation new services and markets\".\n[8]\t3GPP TS 23.502: \"Procedures for the 5G System\".\n[9]\t3GPP TS 33.102: \"3G security; Security architecture\".\n[10]\t3GPP TS 33.401: \"3GPP System Architecture Evolution (SAE); Security architecture\".\n[11]\t3GPP TS 33.402: \"3GPP System Architecture Evolution (SAE); Security aspects of non-3GPP accesses\".\n[12]\tIETF RFC 5448: \" Improved Extensible Authentication Protocol Method for 3rd Generation Authentication and Key Agreement (EAP-AKA')\".\n[13]\t3GPP TS 24.301: \" Non-Access-Stratum (NAS) protocol for Evolved Packet System (EPS); Stage 3\".\n[14]\t3GPP TS 35.215: \" Specification of the 3GPP Confidentiality and Integrity Algorithms UEA2 & UIA2; Document 1: UEA2 and UIA2 specifications\".\n[15]\tNIST: \"Advanced Encryption Standard (AES) (FIPS PUB 197)\".\n[16]\tNIST Special Publication 800-38A (2001): \"Recommendation for Block Cipher Modes of Operation\".\n[17]\tNIST Special Publication 800-38B (2001): \"Recommendation for Block Cipher Modes of Operation: The CMAC Mode for Authentication\".\n[18]\t3GPP TS 35.221: \" Specification of the 3GPP Confidentiality and Integrity Algorithms EEA3 & EIA3; Document 1: EEA3 and EIA3 specifications\".\n[19]\t3GPP TS 23.003: \"Numbering, addressing and identification\".\n[20]\t3GPP TS 22.101: \"Service aspects; Service principles\".\n[21]\tIETF RFC 4187: \"Extensible Authentication Protocol Method for 3rd Generation Authentication and Key Agreement (EAP-AKA)\".\n[22]\t3GPP TS 38.331: \"NR; Radio Resource Control (RRC); Protocol specification\".\n[23]\t3GPP TS 38.323: \"NR; Packet Data Convergence Protocol (PDCP) specification\".\n[24]\t3GPP TS 33.117: \"Catalogue of general security assurance requirements\".\n[25]\tIETF RFC 7296: \"Internet Key Exchange Protocol Version 2 (IKEv2)\"\n[26]\tVoid\n[27]\tIETF RFC 3748: \"Extensible Authentication Protocol (EAP)\".\n[28]\t3GPP TS 33.220: \"Generic Authentication Architecture (GAA); Generic Bootstrapping Architecture (GBA)\".\n[29]\tSECG SEC 1: Recommended Elliptic Curve Cryptography, Version 2.0, 2009. Available\n[30]\tSECG SEC 2: Recommended Elliptic Curve Domain Parameters, Version 2.0, 2010. Available at\n[31]\t3GPP TS 38.470: \"NG-RAN; F1 General aspects and principles\".\n[32]\t3GPP TS 38.472: \"NG-RAN; F1 signalling transport\".\n[33] \t3GPP TS 38.474: \"NG-RAN; F1 data transport\".\n[34]\t3GPP TS 38.413: \"NG-RAN; NG Application Protocol (NGAP)\"\n[35]\t3GPP TS 24.501: \"Non-Access-Stratum (NAS) protocol for 5G System (5GS); Stage 3\".\n[36] \t3GPP TS 35.217: \"Specification of the 3GPP Confidentiality and Integrity Algorithms UEA2 & UIA2; Document 3: Implementors' test data\".\n[37] \t3GPP TS 35.223: \"Specification of the 3GPP Confidentiality and Integrity Algorithms EEA3 & EIA3; Document 3: Implementors' test data\".\n[38]\tIETF RFC 5216: \"The EAP-TLS Authentication Protocol\".\n[39]\tIETF RFC 4346: \"The Transport Layer Security (TLS) Protocol Version 1.1\".\n[40]\tIETF RFC 5246: \"The Transport Layer Security (TLS) Protocol Version 1.2\".\n[41]\t3GPP TS 38.460: \"NG-RAN; E1 general aspects and principles\".\n[42]\tVoid.\n[43]\tIETF RFC 6749: \"OAuth2.0 Authorization Framework\".\n[44]\tIETF RFC 7519: \"JSON Web Token (JWT)\".\n[45]\tIETF RFC 7515: \"JSON Web Signature (JWS)\".\n[46]\tIETF RFC 7748: \"Elliptic Curves for Security\".\n[47]\tIETF RFC 9113: \"HTTP/2\".\n[48]\tIETF RFC 5280: \"Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile\".\n[49]\tIETF RFC 6960: \"X.509 Internet Public Key Infrastructure Online Certificate Status Protocol - OCSP\".\n[50]\tIETF RFC 6066: \"Transport Layer Security (TLS) Extensions: Extension Definitions\".\n[51]\t3GPP TS 37.340: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and NR; Multi-connectivity; Stage 2\".\n[52]\t3GPP TS 38.300: \"NR; NR and NG-RAN Overall Description; Stage 2\".\n[53]\t3GPP TS 33.122: \"Security Aspects of Common API Framework for 3GPP Northbound APIs\".\n[54]\t3GPP TS28.533: \" Management and orchestration; Architecture framework\".\n[55]\t3GPP TS28.531: \"Management and orchestration of networks and network slicing; Provisioning\".\n[56]\tVoid\n[57]\tIETF RFC 7542: \"The Network Access Identifier\".\n[58]\tIETF RFC 6083: \" Datagram Transport Layer Security (DTLS) for Stream Control Transmission Protocol (SCTP)\".\n[59]\tIETF RFC 7516: \"JSON Web Encryption (JWE)\".\n[60]\tIETF RFC 8446: \"The Transport Layer Security (TLS) Protocol Version 1.3\".\n[61]\tIETF RFC 5705,\"Keying Material Exporters for Transport Layer Security (TLS)\".\n[62]\tIETF RFC 5869 \"HMAC-based Extract-and-Expand Key Derivation Function (HKDF)\".\n[63]\tNIST Special Publication 800-38D: \"Recommendation for Block Cipher Modes of Operation: Galois Counter Mode (GCM) and GMAC\".\n[64]\tIETF RFC 6902: \"JavaScript Object Notation (JSON) Patch\".\n[65]\t3GPP TS 31.115: \"Secured packet structure for (Universal) Subscriber Identity Module (U)SIM Toolkit applications.\n[66]\t3GPP TS 31.111: \"Universal Subscriber Identity Module (USIM), Application Toolkit (USAT)\".\n[67]\tIETF RFC 9048: \"Improved Extensible Authentication Protocol Method for 3GPP Mobile Network  Authentication and Key Agreement (EAP-AKA')\".\n[68]\t3GPP TS 29.510: \"5G System; Network function repository services\".\n[69]\t3GPP TS 36.331: \"Radio Resource Control (RRC); Protocol specification\".\n[70]\t3GPP TS 29.505: \"5G System; Usage of the Unified Data Repository services for Subscription Data; Stage 3\".\n[71]\t3GPP TS 24.302: \"Access to the 3GPP Evolved Packet Core (EPC) via non-3GPP access networks; Stage 3\".\n[72]\t3GPP TS 23.216: \"Single Radio Voice Call Continuity (SRVCC)\".\n[73]\t3GPP TS 29.573: \" Public Land Mobile Network (PLMN) Interconnection; Stage 3\".\n[74]\t3GP TS 29.500: \"5G System; Technical Realization of Service Based Architecture; Stage 3\".\n[75]\tIEEE TSN network aspects: see 3GPP TS 23.501 [2] references [95], [96], [97], [98], [104], and [107].\n[76]\tIETF RFC 9190: \"EAP-TLS 1.3: Using the Extensible Authentication Protocol with TLS 1.3\".\n[77]\tIETF RFC 8446: \"The Transport Layer Security (TLS) Protocol Version 1.3\".\n[78]\t3GPP TS 38.401: \"NG-RAN; Architecture description\".\n[79]\t3GPP TS 23.316: \"Wireless and wireline convergence access support for the 5G System (5GS)\"\n[80]\tIEEE Std 802.11-2016 (Revision of IEEE Std 802.11-2012) - IEEE Standard for Information technology—Telecommunications and information exchange between systems Local and metropolitan area networks—Specific requirements - Part 11: Wireless LAN Medium Access Control (MAC) and Physical Layer (PHY) Specifications.\n[81]\tIETF RFC 2410 \"The NULL Encryption Algorithm and Its Use With IPsec\".\n[82]\tVoid\n[83]\tRFC 7858: \"Specification for DNS over Transport Layer Security (TLS)\".\n[84]\tRFC 8310: \"Usage Profiles for DNS over TLS and DNS over DTLS\".\n[85]\tRFC 4890: \"Recommendations for Filtering ICMPv6 Messages in Firewalls\".\n[86]\t3GPP TS 23.273: \"5G System (5GS) Location Services (LCS); Stage 2\".\n[87]\t3GPP TS 38.305: \"Stage 2 functional specification of User Equipment (UE) positioning in NG-RAN\".\n[88]\t3GPP TS 36.300: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and Evolved Universal Terrestrial Radio Access (E-UTRAN); Overall description; Stage 2\".\n[89]\tIANA: \"Transport Layer Security (TLS) Parameters\".\n[90]\tRFC 2818: \"HTTP Over TLS\".\n[91]\t3GPP TS 33.535: \"Authentication and key management for applications based on 3GPP credentials in the 5G System (5GS)\".\n[92]\t3GP TS 29.573: \"5G System; Public Land Mobile Network (PLMN) Interconnection\".\n[93]\t3GPP TS 29.503: \"5G System; Unified Data Management Services\".\n[94]\t3GPP TS 29.501: \"5G System; Principles and Guidelines for Services Definition\".\n[95]\t3GPP TS 29.502: \"5G System; Session Management Services\".\n[96]\t3GPP TS 29.526: \"5G System; Network Slice-Specific Authentication and Authorization (NSSAA) services\".\n[97]\t3GPP TS 23.402: \"Authentication enhancements for non-3GPP accesses\".\n[98]\t3GPP TS 23.548: \"5G System Enhancements for Edge Computing; Stage 2\".\n[99]\tRFC 5281: \"Extensible Authentication Protocol Tunneled Transport Layer Security              Authenticated Protocol Version 0 (EAP-TTLSv0)\".\n[100]\tRFC 6678: \"Requirements for a Tunnel-Based Extensible Authentication Protocol (EAP) Method\".\n[101]\tGeneral Data Protection Regulation, .\n[102]\t3GPP TS 33.246: \"Security of Multimedia Broadcast/Multicast Service (MBMS)\".\n[103] \t3GPP TS 23.247: \"Architectural enhancements for 5G multicast-broadcast services\".\n[104]\t3GPP TS 33.535: \"Authentication and Key Management for Applications (AKMA) based on 3GPP credentials in the 5G System (5GS)\".\n[105]\t3GPP TS 23.288: \"Architecture enhancements for 5G System(5GS) to support network data analytics services\".\n[106]\t3GPP TS 23.554 Application architecture for MSGin5G Service; Stage 2.\n[107]\t3GPP TS 22.262 Message service with the 5G System (5GS); Stage 1.\n[108]\t3GPP TS 26.502: \"5G multicast–broadcast services; User Service architecture\".\n[109]\t3GPP TS 33.503: \"Security Aspects of Proximity based Services (ProSe) in the 5G System (5GS)\".\n[110]\tNIST Special Publication 800-90A (2015): \"Recommendation for Random Number Generation Using Deterministic Random Bit Generators\".\n[111]\tIETF RFC 4555 (2006-06): \"RFC IKEv2 Mobility and Multihoming Protocol (MOBIKE)\".\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "3\tDefinitions and abbreviations",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "3.1\tDefinitions",
                    "description": "",
                    "summary": "",
                    "text_content": "For the purposes of the present document, the terms and definitions given in 3GPP TR 21.905 [1] and the following apply. A term defined in the present document takes precedence over the definition of the same term, if any, in 3GPP TR 21.905 [1].\n5G security context: The state that is established locally at the UE and a serving network domain and represented by the \"5G security context data\" stored at the UE and a serving network.\nNOTE 1:\tThe \"5G security context data\" consists of the 5G NAS security context, and the 5G AS security context for 3GPP access and/or the 5G AS security context for non-3GPP access.\nNOTE 2:\tA 5G security context has type \"mapped\", \"full native\" or \"partial native\". Its state can either be \"current\" or \"non-current\". A context can be of one type only and be in one state at a time. The state of a particular context type can change over time. A partial native context can be transformed into a full native. No other type transformations are possible.\n5G AS security context for 3GPP access: The cryptographic keys at AS level with their identifiers, the Next Hop parameter (NH), the Next Hop Chaining Counter parameter (NCC) used for next hop access key derivation, the identifiers of the selected AS level cryptographic algorithms, the UE security capabilities, and the UP Security Policy at the network side, UP security activation status and the counters used for replay protection.\nNOTE 3:\tNH and NCC need to be stored also at the AMF during connected mode.\nNOTE 4:\tUP security activation status is sent from gNB/ng-eNB in step 1b in clause 6.6.2 corresponding to the active PDU session(s).\n5G AS security context for non-3GPP access: The key KN3IWF, the cryptographic keys, cryptographic algorithms and tunnel security association parameters used at IPsec layer for the protection of IPsec SA.\n5G AS Secondary Cell security context: The cryptographic keys at AS level for secondary cell with their identifiers, the identifier of the selected AS level cryptographic algorithms for secondary cell, the UP Security Policy at the network side, and counters used for replay protection.\n5G Home Environment Authentication Vector: authentication data consisting of RAND, AUTN, XRES*, and KAUSF for the purpose of authenticating the UE using 5G AKA.\nNOTE 3a: This vector is received by the AUSF from the UDM/ARPF in the Nudm_UEAuthentication_Get Response.\n5G Authentication Vector: authentication data consisting of RAND, AUTN, HXRES*, and KSEAF.\nNOTE 3b: This vector is received by the SEAF from the AUSF in the Nausf_Authentication_Authenticate Response.\n5G NAS security context: The key KAMF with the associated key set identifier, the UE security capabilities, the uplink and downlink NAS COUNT values.\nNOTE 4:\tThe distinction between native 5G security context and mapped 5G security context also applies to 5G NAS security contexts. The 5G NAS security context is called \"full\" if it additionally contains the integrity and encryption keys and the associated identifiers of the selected NAS integrity and encryption algorithms.\n5G Serving Environment Authentication Vector: a vector consisting of RAND, AUTN and HXRES*.\nABBA parameter: Parameter that provides antibidding down protection of security features against security features introduced in higher release to a lower release and indicates the security features that are enabled in the current network.\nactivation of security context: The process of taking a security context into use.\nanchor key: The security key KSEAF provided during authentication and used for derivation of subsequent security keys.\napplication Layer Security: mechanism by which HTTP messages, exchanged between a Network Function in one PLMN and a Network Function in another PLMN, are protected on the N32-f interface between the two SEPPs in the two PLMNs.\nauthentication data: An authentication vector or transformed authentication vector.\nauthentication vector: A vector consisting of CK, IK, RAND, AUTN, and XRES.\nbackward security: The property that for an entity with knowledge of Kn, it is computationally infeasible to compute any previous Kn-m (m>0) from which Kn is derived.\nNOTE 5:\tIn the context of KgNB key derivation, backward security refers to the property that, for a gNB with knowledge of a KgNB, shared with a UE, it is computationally infeasible to compute any previous KgNB that has been used between the same UE and a previous gNB.\nCM-CONNECTED state: This is as defined in TS 23.501 [2].\nNOTE5a:\tThe term CM-CONNECTED state corresponds to the term 5GMM-CONNECTED mode used in TS 24.501 [35].\nCM-IDLE state: As defined in TS 23.501 [2].\nNOTE5b:\tThe term CM-IDLE state corresponds to the term 5GMM-IDLE mode used in TS 24.501 [35].\nconsumer's IPX (cIPX): IPX provider entity with a business relationship with the cSEPP operator.\nconsumer's NRF (cNRF): The NRF that authenticates the service consumer NF and resides in the PLMN where the service consumer NF is located.\nconsumer's PLMN (cPLMN): The PLMN where the service consumer NF is located.\nconsumer's SEPP (cSEPP): The SEPP residing in the PLMN where the service consumer NF is located.\nCredentials Holder: As defined in TS 23.501 [2].\ncurrent 5G security context: The security context which has been activated most recently.\nNOTE5c:\tA current 5G security context originating from either a mapped or native 5G security context can exist simultaneously with a native non-current 5G security context.\nDefault Credentials Server: As defined in TS 23.501[2].\nDefault UE credentials: As defined in TS 23.501[2].\nforward security: The fulfilment of the property that for an entity with knowledge of Km that is used between that entity and a second entity, it is computationally infeasible to predict any future Km+n (n>0) used between a third entity and the second entity.\nNOTE 6:\tIn the context of KgNB key derivation, forward security refers to the property that, for a gNB with knowledge of a KgNB, shared with a UE, it is computationally infeasible to predict any future KgNB that will be used between the same UE and another gNB. More specifically, n hop forward security refers to the property that a gNB is unable to compute keys that will be used between a UE and another gNB to which the UE is connected after n or more handovers (n=1 or more).\nfull native 5G security context: A native 5G security context for which the 5G NAS security context is full according to the above definition.\nNOTE6a:\tA full native 5G security context is either in state \"current\" or state \"non-current\".\nHome Network Identifier: An identifier identifying the home network of the subscriber.\nNOTE6b: Described in detail in TS 23.003 [19].\nHome Network Public Key Identifier: An identifier used to indicate which public/private key pair is used for SUPI protection and de-concealment of the SUCI.\nNOTE6c: Described in this document and detailed in TS 23.003 [19].\nIAB-donor-CU: As defined in TS 38.401 [78] .\nIAB-donor-DU: As defined in TS 38.401 [78].\nIAB-node: As defined in TS 38.300 [52].\nIAB-donor gNB: As defined in TS 38.300 [52].\nIAB-UE: The function within an IAB node, which behaves as a UE.\nIPX provider: Roaming Intermediary.\nNOTE 6ca: For historical reasons this term in the present document is equivalent to Roaming Intermediary.\nIPX provider entity: A type of Roaming Intermediary defined by GSMA as IPX provider.\nEditor's Note: GSMA does not use the term \"IPX provider entity\". Reference to GSMA PRD that defines the IPX provider will be added when GSMA determines the PRD in which it will be defined.\nmapped 5G security context: An 5G security context, whose KAMF was derived from EPS keys during interworking and which is identified by mapped ngKSI.\nMaster node: As defined in TS 37.340 [51].\nN32-c connection: A TLS based connection between a SEPP in one PLMN and a SEPP in another PLMN.\nNOTE 6d:\tThis is a short-lived connection that is used between the SEPPs for negotiation of the N32-f protection mechanism, cipher suite and protection policy exchange, and error notifications. Every N32-f connection requires an N32-c connection that was established before establishing N32-f.\nN32-f connection: Logical connection that exists between a SEPP in one PLMN and a SEPP in another PLMN for exchange of protected HTTP messages.\nNOTE 6e:\tWhen IPX providers are present in the path between the two SEPPs, an N32-f HTTP connection is setup on each hop towards the other SEPP.\nnative 5G security context: An 5G security context, whose KAMF was created by a run of primary authentication and which is identified by native ngKSI.\nng-eNB: As defined in TS 38.300 [52].\nNG-RAN node: gNB or ng-eNB (as defined in TS 38.300 [52]).\nnon-current 5G security context: A native 5G security context that is not the current one.\nNOTE 7:\tA non-current 5G security context may be stored along with a current 5G security context in the UE and the AMF. A non-current 5G security context does not contain 5G AS security context. A non-current 5G security context is either of type \"full native\" or of type \"partial native\".\nOperator Group Roaming Hub: Roaming hub used by a group of network operators that reside in the same security domain to consolidate and secure operator group roaming.\npartial native 5G security context: A partial native 5G security context consists of KAMF with the associated key set identifier, the UE security capabilities, and the uplink and downlink NAS COUNT values, which are initially set to zero before the first NAS SMC procedure for this security context.\nNOTE 8:\tA partial native 5G security context is created by primary authentication, for which no corresponding successful NAS SMC has been run. A partial native context is always in state \"non-current\".\nproducer's IPX (pIPX): IPX provider entity with a business relationship with the pSEPP operator.\nproducer's NRF (pNRF): The NRF where the service producer NF is registered in the PLMN where the service producer NF is located.\nproducer's PLMN (pPLMN): The PLMN where the service producer NF is located.\nproducer's SEPP (pSEPP): The SEPP residing in the PLMN where the service producer NF is located.\nProtection Scheme Identifier: An identifier identifying a protection scheme that is used for concealing the SUPI.\nRM-DEREGISTERED state: This is as defined in TS 23.501 [2].\nNOTE8a:\tThe term RM-DEREGISTERED state corresponds to the term 5GMM-DEREGISTERED mode used in TS 24.501 [35].\nRM-REGISTERED state: As defined in TS 23.501 [2].\nNOTE8b:\tThe term RM-REGISTERED state corresponds to the term 5GMM-REGISTERED mode used in TS 24.501 [35].\nRoaming Hub: A type of Roaming Intermediary; as defined by GSMA.\nEditor's Note: Reference to GSMA PRD that defines the IPX provider entity will be added when GSMA determines the PRD in which it will be defined.\nRoaming Intermediary: an entity that provides roaming related services.\nRouting Indicator: An indicator defined in TS 23.003 [19] that can be used for AUSF or UDM selection.\nScheme Output: the output of a public key protection scheme used for SUPI protection.\nsecurity anchor function: The function SEAF that serves in the serving network as the anchor for security in 5G.\nSecondary node: As defined in TS 37.340 [51].\nsubscription credential(s): The set of values in the USIM and in the home operator's network, consisting of at least the long-term key(s) and the subscription identifier SUPI, used to uniquely identify a subscription and to mutually authenticate the UE and 5G core network.\nsubscription identifier: The SUbscription Permanent Identifier (SUPI).\nNOTE8c: As defined in TS 23.501 [2] and detailed in 23.003 [19].\nsubscription concealed identifier: A one-time use subscription identifier, called the SUbscription Concealed Identifier (SUCI), which contains the Scheme-Output, and additional non-concealed information needed for home network routing and protection scheme usage.\nNOTE8d: Defined in the present document; detailed in TS 23.003 [19].\nsubscription identifier de-concealing function: The Subscription Identifier De-concealing Function (SIDF) service offered by the network function UDM in the home network of the subscriber responsible for de-concealing the SUPI from the SUCI.\ntransformed authentication vector: an authentication vector where CK and IK have been replaced with CK' and IK'.\nUE 5G security capability: The UE security capabilities for 5G AS and 5G NAS.\nUE security capabilities: The set of identifiers corresponding to the ciphering and integrity algorithms implemented in the UE.\nNOTE 9:\tThis includes capabilities for NG-RAN and 5G NAS, and includes capabilities for EPS, UTRAN and GERAN if these access types are supported by the UE.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "3.2\tAbbreviations",
                    "description": "",
                    "summary": "",
                    "text_content": "For the purposes of the present document, the abbreviations given in 3GPP TR 21.905 [1] and the following apply. An abbreviation defined in the present document takes precedence over the definition of the same abbreviation, if any, in 3GPP TR 21.905 [1].\n5GC\t5G Core Network\n5G-AN\t5G Access Network\n5G-RG\t5G Residential Gateway\nNG-RAN\t5G Radio Access Network\n5G AV\t5G Authentication Vector\n5G HE AV\t5G Home Environment Authentication Vector\n5G NSWO\t5G Non-Seamless WLAN Offload\n5G SE AV\t5G Serving Environment Authentication Vector\nABBA\tAnti-Bidding down Between Architectures\nAEAD\tAuthenticated Encryption with Associated Data\nAES\tAdvanced Encryption Standard\nAKA\tAuthentication and Key Agreement\nAMF\tAccess and Mobility Management Function\nAMF\tAuthentication Management Field\n\nNOTE:\tIf necessary, the full word is spelled out to disambiguate the abbreviation.\nARPF\tAuthentication credential Repository and Processing Function\nAUN3\tAuthenticable Non-3GPP devices\nAUSF\tAuthentication Server Function\nAUTN\tAUthentication TokeN\nAV\tAuthentication Vector\nAV'\ttransformed Authentication Vector\nBAP\tBackhaul Adaptation Protocol\nBH\tBackhaul\nCCA\tClient Credentials Assertion\nCell-ID\tCell Identity as used in TS 38.331 [22]\nCH\tCredentials Holder\nCHO\tConditional Handover\nCIoT\tCellular Internet of Things\ncIPX\tconsumer's IPX\nCKSRVCC\tCipher Key for Single Radio Voice Continuity\ncNRF\tconsumer's NRF\nCP\tControl Plane\nCPA\tConditional PSCell Addition\nCPC\tConditional PSCell Change\ncPLMN\tconsumer's PLMN\ncSEPP\tconsumer's SEPP\nCTR\tCounter (mode)\nCU\tCentral Unit\nDCS\tDefault Credentials Server\nDN\tData Network\nDNN\tData Network Name\nDU\tDistributed Unit\nEAP\tExtensible Authentication Protocol\nEDT\tEarly Data Transmission\nEMSK\tExtended Master Session Key\nEN-DC\tE-UTRA-NR Dual Connectivity\nENSI\tExternal Network Slice Information\nEPS\tEvolved Packet System\nFN-RG\tFixed Network RG\ngNB\tNR Node B\nGUTI\tGlobally Unique Temporary UE Identity\nHRES\tHash RESponse\nHXRES\tHash eXpected RESponse\nIAB\tIntegrated Access and Backhaul\nIKE\tInternet Key Exchange\nIKSRVCC\tIntegrity Key for Single Radio Voice Continuity\nIPUPS\tInter-PLMN UP Security\nIPX\tIP exchange service\nKSI\tKey Set Identifier\nKSISRVCC\tKey Set Identifier for Single Radio Voice Continuity\nLI\tLawful Intercept\nMBSF\tMulticast/Broadcast Service Function\nMBSSF\tMulticast/Broadcast Service Security Function\nMBSTF\tMulticast/Broadcast Service Transport Function\nMeNB\tMaster eNB\nMN\tMaster Node\nMO-EDT\tMobile Originated Early Data Transmission\nMT-EDT\tMobile Terminated Early Data Transmission\nMR-DC\tMulti-Radio Dual Connectivity\nMSK\tMaster Session Key\nN3IWF\tNon-3GPP access InterWorking Function\nNAI\tNetwork Access Identifier\nNAS\tNon Access Stratum\nNDS\tNetwork Domain Security\nNEA\tEncryption Algorithm for 5G\nNF\tNetwork Function\nNG\tNext Generation\nng-eNB\tNext Generation Evolved Node-B\nngKSI\tKey Set Identifier in 5G\nN5CW\tNon-5G-Capable over WLAN\nN5GC\tNon-5G-Capable\nNIA\tIntegrity Algorithm for 5G\nNR\tNew Radio\nNR-DC\tNR-NR Dual Connectivity\nNSSAI\tNetwork Slice Selection Assistance Information\nNSSAA\tNetwork Slice Specific Authentication and Authorization\nNSWO\tNon-Seamless WLAN Offload\nNSWOF\tNon-Seamless WLAN Offload Function\nPDN\tPacket Data Network\nPEI\tPermanent Equipment Identifier\npIPX\tproducer's IPX\npNRF\tproducer's NRF\npPLMN\tproducer's PLMN\nPRINS\tPRotocol for N32 INterconnect Security\npSEPP\tproducer's SEPP\nPUR\tPreconfigured Uplink Resource\nQoS\tQuality of Service\nRES\tRESponse\nSCG\tSecondary Cell Group\nSEAF\tSEcurity Anchor Function\nSCP\tService Communication Proxy\nNOTE: Void.\tSecurity Gateway\nSEPP\tSecurity Edge Protection Proxy\nSgNB\tSecondary gNB\nSIDF\tSubscription Identifier De-concealing Function\nSMC\tSecurity Mode Command\nSMF\tSession Management Function\nSN\tSecondary Node\nSN Id\tServing Network Identifier\nSUCI\tSubscription Concealed Identifier\nSUPI\tSubscription Permanent Identifier\nTLS\tTransport Layer Security\nTNAN\tTrusted Non-3GPP Access Network\nTNAP\tTrusted Non-3GPP Access Point\nTNGF\tTrusted Non-3GPP Gateway Function\nTWAP\tTrusted WLAN Access Point\nTWIF\tTrusted WLAN Interworking Function\nTSC\tTime Sensitive Communication\nUE\tUser Equipment\nUEA\tUMTS Encryption Algorithm\nUDM\tUnified Data Management\nUDR\tUnified Data Repository\nUIA\tUMTS Integrity Algorithm\nULR\tUpdate Location Request\nUP\tUser Plane\nUPF\tUser Plane Function\nURLLC\tUltra Reliable Low Latency Communication\nUSIM\tUniversal Subscriber Identity Module\nXRES\teXpected RESponse\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "4\tOverview of security architecture",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "4.1\tSecurity domains",
                    "description": "",
                    "summary": "",
                    "text_content": "Figure 4-1 gives an overview of security architecture.\nThe figure depicts an overview of the security architecture, highlighting the various components and their roles in ensuring the security of a network. Key elements include the network perimeter, intrusion detection and prevention systems, firewalls, and VPNs. The diagram illustrates the interconnection of these components, emphasizing the importance of network segmentation and the need for continuous monitoring and maintenance.\nFigure 4-1: Overview of the security architecture\nThe figure illustrates the following security domains:\n-\tNetwork access security (I): the set of security features that enable a UE to authenticate and access services via the network securely, including the 3GPP access and Non-3GPP access, and in particularly, to protect against attacks on the (radio) interfaces. In addition, it includes the security context delivery from SN to AN for the access security.\n-\tNetwork domain security (II): the set of security features that enable network nodes to securely exchange signalling data and user plane data.\n-\tUser domain security (III): the set of security features that secure the user access to mobile equipment.\n-\tApplication domain security (IV): the set of security features that enable applications in the user domain and in the provider domain to exchange messages securely. Application domain security is out of scope of the present document.\n-\tSBA domain security (V): the set of security features that enables network functions of the SBA architecture to securely communicate within the serving network domain and with other network domains . Such features include network function registration, discovery, and authorization security aspects, as well as the protection for the service-based interfaces. SBA domain security is a new security feature compared to TS 33.401 [10].\n-\tVisibility and configurability of security (VI): the set of features that enable the user to be informed whether a security feature is in operation or not.\nNOTE:\tThe visibility and configurability of security is not shown in the figure.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "4.2\tSecurity at the perimeter of the 5G Core network",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "4.2.0\tGeneral",
                            "text_content": "The security specified in this document applies to both roaming and PLMN interconnect.\nEditor's Note: check full specification on removing references to roaming unless specific to roaming.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "4.2.1\tSecurity Edge Protection Proxy (SEPP)",
                            "text_content": "The 5G System architecture introduces a Security Edge Protection Proxy (SEPP) as an entity sitting at the perimeter of the PLMN for protecting control plane messages.\nThe SEPP enforces inter-PLMN security on the N32 interface.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "4.2.2\tInter-PLMN UP Security (IPUPS)",
                            "text_content": "The 5G System architecture introduces Inter-PLMN UP Security (IPUPS) at the perimeter of the PLMN for protecting user plane messages.\nThe IPUPS is a functionality of the UPF that enforces GTP-U security on the N9 interface between UPFs of the visited and home PLMNs.\nNOTE: \tIPUPS can be activated with other functionality in a UPF or activated in a UPF that is dedicated to be used for IPUPS functionality (see also TS 23.501 [2], clause 5.8.2.14).\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "4.3\tSecurity entities in the 5G Core network",
                    "description": "",
                    "summary": "",
                    "text_content": "The 5G System architecture introduces the following security entities in the 5G Core network:\nAUSF: \tAUthentication Server Function;\nARPF: \tAuthentication credential Repository and Processing Function;\nSIDF:\t\tSubscription Identifier De-concealing Function;\nSEAF:\t\tSEcurity Anchor Function.\n\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "5\tSecurity requirements and features",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "5.1\tGeneral security requirements",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.1.1\tMitigation of bidding down attacks",
                            "text_content": "An attacker could attempt a bidding down attack by making the UE and the network entities respectively believe that the other side does not support a security feature, even when both sides in fact support that security feature. It shall be ensured that a bidding down attack, in the above sense, can be prevented.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.1.2\tAuthentication and Authorization",
                            "text_content": "The 5G system shall satisfy the following requirements.\nSubscription authentication: The serving network shall authenticate the Subscription Permanent Identifier (SUPI) in the process of authentication and key agreement between UE and network.\nServing network authentication: The UE shall authenticate the serving network identifier through implicit key authentication.\nNOTE 1: \tThe meaning of 'implicit key authentication' here is that authentication is provided through the successful use of keys resulting from authentication and key agreement in subsequent procedures.\nNOTE 2: \tThe preceding requirement does not imply that the UE authenticates a particular entity, e.g. an AMF, within a serving network.\nUE authorization: The serving network shall authorize the UE through the subscription profile obtained from the home network. UE authorization is based on the authenticated SUPI.\nServing network authorization by the home network: Assurance shall be provided to the UE that it is connected to a serving network that is authorized by the home network to provide services to the UE. This authorization is 'implicit' in the sense that it is implied by a successful authentication and key agreement run.\nAccess network authorization: Assurance shall be provided to the UE that it is connected to an access network that is authorized by the serving network to provide services to the UE. This authorization is 'implicit' in the sense that it is implied by a successful establishment of access network security. This access network authorization applies to all types of access networks.\nUnauthenticated Emergency Services: In order to meet regulatory requirements in some regions, the 5G system shall support unauthenticated access for emergency services. This requirement applies to all MEs and only to those serving networks where regulatory requirements for unauthenticated emergency services exist. Serving networks located in regions where unauthenticated emergency services are forbidden shall not support this feature.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.1.3\tRequirements on 5GC and NG-RAN related to keys",
                            "text_content": "The 5GC and NG-RAN shall allow for use of encryption and integrity protection algorithms for AS and NAS protection having keys of length 128 bits. The network interfaces shall support the transport of 256 bit keys.\nThe keys used for UP, NAS and AS protection shall be dependent on the algorithm with which they are used.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.2\tRequirements on the UE",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.2.1\tGeneral",
                            "text_content": "The support and usage of ciphering and integrity protection between the UE and the ng-eNB is identical to the support and usage of ciphering and integrity protection between the UE and the eNB as specified in TS 33.401 [10] with the following additional requirement(s):\n-\tThe UE shall support the use of integrity protection with the ng-eNB over the Uu interface if it supports E-UTRA connected to 5GC.\n-\tThe UE shall indicate its support of integrity protection with the ng-eNB if it supports E-UTRA connected to 5GC.\nThe PEI shall be securely stored in the UE to ensure the integrity of the PEI.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.2\tUser data and signalling data confidentiality",
                            "text_content": "The UE shall support ciphering of user data between the UE and the gNB.\nThe UE shall activate ciphering of user data based on the indication sent by the gNB.\nThe UE shall support ciphering of RRC and NAS-signalling.\nThe UE shall implement the following ciphering algorithms:\nNEA0, 128-NEA1, 128-NEA2 as defined in Annex D of the present document.\nThe UE may implement the following ciphering algorithm:\n128-NEA3 as defined in Annex D of the present document.\nThe UE shall implement the ciphering algorithms as specified in TS 33.401 [10] if it supports E-UTRA connected to 5GC.\nConfidentiality protection of the user data between the UE and the gNB is optional to use.\nConfidentiality protection of the RRC-signalling, and NAS-signalling is optional to use.\nConfidentiality protection should be used whenever regulations permit.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.3\tUser data and signalling data integrity",
                            "text_content": "The UE shall support integrity protection and replay protection of user data between the UE and the gNB. The UE shall support integrity protection of user data at any data rate, up to and including, the highest data rate supported by the UE.\nThe UE shall activate integrity protection of user data based on the indication sent by the gNB.\nThe UE shall support integrity protection and replay protection of RRC and NAS-signalling.\nThe UE shall implement the following integrity protection algorithms:\nNIA0, 128-NIA1, 128-NIA2 as defined in Annex D of the present document.\nThe UE may implement the following integrity protection algorithm:\n128-NIA3 as defined in Annex D of the present document.\nThe UE shall implement the integrity algorithms as specified in TS 33.401 [10] if it supports E-UTRA connected to 5GC.\nIntegrity protection of the user data between the UE and the gNB is optional to use.\nNOTE:\tIntegrity protection of user plane adds the overhead of the packet size and increases the processing load both in the UE and the gNB.\nIntegrity protection of the RRC-signalling, and NAS-signalling is mandatory to use, except in the following cases:\nAll NAS signalling messages except those explicitly listed in TS 24.501 [35] as exceptions shall be integrity-protected.\nAll RRC signalling messages except those explicitly listed in TS 38.331 [22] as exceptions shall be integrity-protected with an integrity protection algorithm different from NIA0, except for unauthenticated emergency calls.\nThe UE shall implement NIA0 for integrity protection of NAS and RRC signalling. NIA0 is only allowed for unauthenticated emergency session as specified in clause 10.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.4\tSecure storage and processing of subscription credentials",
                            "text_content": "The following requirements apply for the storage and processing of the subscription credentials used to access the 5G network:\nThe subscription credential(s) shall be integrity protected within the UE using a tamper resistant secure hardware component.\nThe long-term key(s) of the subscription credential(s) (i.e. K) shall be confidentiality protected within the UE using a tamper resistant secure hardware component.\nThe long-term key(s) of the subscription credential(s) shall never be available in the clear outside of the tamper resistant secure hardware component.\nThe authentication algorithm(s) that make use of the subscription credentials shall always be executed within the tamper resistant secure hardware component.\nIt shall be possible to perform a security evaluation / assessment according to the respective security requirements of the tamper resistant secure hardware component.\nNOTE:\tThe security assessment scheme used for the security evaluation of the tamper resistant secure hardware component is outside the scope of 3GPP specifications.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.2.5\tSubscriber privacy",
                            "text_content": "The UE shall support 5G-GUTI.\nThe SUPI should not be transferred in clear text over NG-RAN except routing information, e.g. Mobile Country Code (MCC) and Mobile Network Code (MNC).\nThe Home Network Public Key shall be stored in the USIM.\nThe protection scheme identifier shall be stored in the USIM.\nThe Home Network Public Key Identifier shall be stored in the USIM.\nThe SUCI calculation indication, either USIM or ME calculating the SUCI, shall be stored in USIM.\nThe ME shall support the null-scheme.If the home network has not provisioned the Home Network Public Key in USIM, the SUPI protection in initial registration procedure is not provided. In this case, the null-scheme shall be used by the ME.\nBased on home operator's decision, indicated by the USIM, the calculation of the SUCI shall be performed either by the USIM or by the ME.\nNOTE 1: \tIf the SUCI calculation indication is not present, the calculation is in the ME.\nIn case of an unauthenticated emergency call, privacy protection for SUPI is not required.\nProvisioning, and updating the Home Network Public Key, Home Network Public Key Identifier, protection scheme identifier, Routing Indicator, and SUCI calculation indication in the USIM shall be in the control of the home network operator.\nNOTE 2:\tThe provisioning and updating of the Home Network Public Key, Home Network Public Key Identifier, protection scheme identifier, and SUCI calculation indication is out of the scope of the present document. It can be implemented using, e.g. the Over the Air (OTA) mechanism. Routing Indicator can be updated, e.g., by OTA or as defined in clause 6.15.\nSubscriber privacy enablement shall be under the control of the home network of the subscriber.\nThe UE shall only send the PEI in the NAS protocol after NAS security context is established, unless during emergency registration when no NAS security context can be established.\nThe Routing Indicator shall be stored in the USIM. If the Routing Indicator is not present in the USIM, the ME shall set it to a default value as defined in TS 23.003 [19].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.3\tRequirements on the gNB",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.3.1\tGeneral",
                            "text_content": "The security requirements given in this clause apply to all types of gNBs. More stringent requirements for specific types of gNBs may be defined in other 3GPP specifications.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.2\tUser data and signalling data confidentiality",
                            "text_content": "The gNB shall support ciphering of user data between the UE and the gNB.\nThe gNB shall activate ciphering of user data based on the security policy sent by the SMF.\nThe gNB shall support ciphering of RRC-signalling.\nThe gNB shall implement the following ciphering algorithms:\n-\tNEA0, 128-NEA1, 128-NEA2 as defined in Annex D of the present document.\nThe gNB may implement the following ciphering algorithm:\n-\t128-NEA3 as defined in Annex D of the present document.\nConfidentiality protection of user data between the UE and the gNB is optional to use.\nConfidentiality protection of the RRC-signalling is optional to use.\nConfidentiality protection should be used whenever regulations permit.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.3\tUser data and signalling data integrity",
                            "text_content": "The gNB shall support integrity protection and replay protection of user data between the UE and the gNB.\nThe gNB shall activate integrity protection of user data based on the security policy sent by the SMF.\nThe gNB shall support integrity protection and replay protection of RRC-signalling.\nThe gNB shall support the following integrity protection algorithms:\n-\tNIA0, 128-NIA1, 128-NIA2 as defined in Annex D of the present document.\nThe gNB may support the following integrity protection algorithm:\n-\t128-NIA3 as defined in Annex D of the present document.\nIntegrity protection of the user data between the UE and the gNB is optional to use, and shall not use NIA0.\nNOTE: \tIntegrity protection of user plane adds the overhead of the packet size and increases the processing load both in the UE and the gNB. NIA0 will add an unnecessary overhead of 32-bits MAC with no security benefits.\nAll RRC signalling messages except those explicitly listed in TS 38.331 [22] as exceptions shall be integrity-protected with an integrity protection algorithm different from NIA0, except for unauthenticated emergency calls.\nNIA0 shall be disabled in gNB in the deployments where support of unauthenticated emergency session is not a regulatory requirement.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.4\tRequirements for the gNB setup and configuration",
                            "text_content": "Setting up and configuring gNBs by O&M systems shall be authenticated and authorized by gNB so that attackers shall not be able to modify the gNB settings and software configurations via local or remote access.\n-\tThe certificate enrolment mechanism specified in TS 33.310 [5] for base station should be supported for gNBs. The decision on whether to use the enrolment mechanism is left to operators.\n-\tCommunication between the O&M systems and the gNB shall be confidentiality, integrity and replay protected from unauthorized parties. The security associations between the gNB and an entity in the 5G Core or in an O&M domain trusted by the operator shall be supported. These security association establishments shall be mutually authenticated. The security associations shall be realized according to TS 33.210 [3] and TS 33.310 [5].\n-\tThe gNB shall be able to ensure that software/data change attempts are authorized.\n-\tThe gNB shall use authorized data/software.\n-\tSensitive parts of the boot-up process shall be executed with the help of the secure environment.\n-\tConfidentiality of software transfer towards the gNB shall be ensured.\n-\tIntegrity protection of software transfer towards the gNB shall be ensured.\n-\tThe gNB software update shall be verified before its installation (cf. sub-clause 4.2.3.3.5 of TS 33.117 [24]).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.5\tRequirements for key management inside the gNB",
                            "text_content": "The 5GC provides subscription specific session keying material for the gNBs, which also hold long term keys used for authentication and security association setup purposes. Protecting all these keys is important. The following requirements apply:\n-\tAny part of a gNB deployment that stores or processes keys in cleartext shall be protected from physical attacks. If not, the whole entity is placed in a physically secure location, then keys in cleartext shall be stored and processed in a secure environment. Keys stored inside a secure environment in any part of the gNB shall never leave the secure environment except when done in accordance with this or other 3GPP specifications.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.6\tRequirements for handling user plane data for the gNB",
                            "text_content": "The following requirements apply:\n-\tAny part of a gNB deployment that stores or processes user plane data in cleartext shall be protected from physical attacks. If not, the whole entity is placed in a physically secure location, then user plane data in cleartext shall be stored and processed in a secure environment.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.7\tRequirements for handling control plane data for the gNB",
                            "text_content": "The following requirements apply:\n-\tAny part of a gNB deployment that stores or processes control plane data in cleartext shall be protected from physical attacks. If not, the whole entity is placed in a physically secure location, then control plane data in cleartext shall be stored and processed in a secure environment.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.8\tRequirements for secure environment of the gNB",
                            "text_content": "The secure environment is logically defined within the gNB. It ensures protection and secrecy of all sensitive information and operations from any unauthorized access or exposure. The following list defines the requirements of the secure environment:\n-\tThe secure environment shall support secure storage of sensitive data, e.g. long-term cryptographic secrets and vital configuration data.\n-\tThe secure environment shall support the execution of sensitive functions, e.g. en-/decryption of user data and the basic steps within protocols which use long term secrets (e.g. in authentication protocols).\n-\tThe secure environment shall support the execution of sensitive parts of the boot process.\n-\tThe secure environment's integrity shall be assured.\n-\tOnly authorised access shall be granted to the secure environment, i.e. to data stored and used within it, and to functions executed within it.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.9\tRequirements for the gNB F1 interfaces",
                            "text_content": "Requirements given below apply to gNBs with split DU-CU implementations using F1 interface defined in TS 38.470 [31]. Signalling traffic (i.e. both F1-C interface management traffic defined in TS 38.470 [31] and F1-C signalling bearer defined in TS 38.472 [32]) and user plane data can be sent on the F1 interface between a given DU and its CU.\n-\tF1-C interface shall support confidentiality, integrity and replay protection.\n-\tAll management traffic carried over the CU-DU link shall be integrity, confidentiality and replay protected.\n-\tThe gNB shall support confidentiality, integrity and replay protection on the gNB DU-CU F1-U interface [33] for user plane.\n-\tF1-C and management traffic carried over the CU-DU link shall be protected independently from F1-U traffic.\nNOTE:\tThe above requirements allow to have F1-U protected differently (including turning integrity and/or encryption off or on for F1-U) from all other traffic on the CU-DU (e.g. the traffic over F1-C).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.3.10\tRequirements for the gNB E1 interfaces",
                            "text_content": "Requirements given below apply to gNBs with split DU-CU implementations, particularly with an open interface between CU-CP and CU-UP using the E1 interface defined in TS 38.460 [41].\n-\tThe E1 interface between CU-CP and CU-UP shall be confidentiality, integrity and replay protected.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.4\tRequirements on the ng-eNB",
                    "description": "",
                    "summary": "",
                    "text_content": "The security requirements for ng-eNB are as specified for eNB in TS 33.401 [10] with the following additional requirement:\n-\tng-eNB shall support the use of integrity protection with the UE over the Uu interface.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.5\tRequirements on the AMF",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.5.1\tSignalling data confidentiality",
                            "text_content": "The AMF shall support ciphering of NAS-signalling.\nThe AMF shall support the following ciphering algorithms:\n-\tNEA0, 128-NEA1, 128-NEA2 as defined in  Annex D of the present document.\nThe AMF may support the following ciphering algorithm:\n-\t128-NEA3 as defined in Annex D of the present document.\nConfidentiality protection NAS-signalling is optional to use.\nConfidentiality protection should be used whenever regulations permit.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.5.2\tSignalling data integrity",
                            "text_content": "The AMF shall support integrity protection and replay protection of NAS-signalling.\nThe AMF shall support the following integrity protection algorithms:\n-\tNIA-0, 128-NIA1, 128-NIA2 as defined in  Annex D of the present document.\nThe AMF may support the following integrity protection algorithm:\n-\t128-NIA3 as defined in  Annex D of the present document.\nNIA0 shall be disabled in AMF in the deployments where support of unauthenticated emergency session is not a regulatory requirement.\nAll NAS signalling messages except those explicitly listed in TS 24.501 [35] as exceptions shall be integrity-protected with an algorithm different to NIA-0 except for emergency calls.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.5.3\tSubscriber privacy",
                            "text_content": "The AMF shall support to trigger primary authentication using the SUCI.\nThe AMF shall support assigning 5G-GUTI to the UE.\nThe AMF shall support reallocating 5G-GUTI to UE.\nThe AMF shall be able to confirm SUPI from UE and from home network. The AMF shall deny service to the UE if this confirmation fails.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.6\tRequirements on the SEAF",
                    "description": "",
                    "summary": "",
                    "text_content": "The security anchor function (SEAF) provides the authentication functionality via the AMF in the serving network. The SEAF shall fulfil the following requirements:\nThe SEAF shall support primary authentication using SUCI.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.7\tVoid",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.8\tRequirements on the UDM",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.8.1\tGeneric requirements",
                            "text_content": "The long-term key(s) used for authentication and security association setup purposes shall be protected from physical attacks and shall never leave the secure environment of the UDM/ARPF unprotected.\nNOTE 1: Security mechanisms for protection of subscription credentials in ARPF are left to implementation.\nNOTE 2: Security mechanisms for storage of subscription credentials in the UDR and for the transfer of authentication subscription data (as specified in 3GPP TS 29.505 [70]) between UDR and ARPF are left to implementation.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.8.2\tSubscriber privacy related requirements to UDM and SIDF",
                            "text_content": "The SIDF is responsible for de-concealment of the SUCI and shall fulfil the following requirements:\n-\tThe SIDF shall be a service offered by UDM.\n-\tThe SIDF shall resolve the SUPI from the SUCI based on the protection scheme used to generate the SUCI.\nThe Home Network Private Key used for subscriber privacy shall be protected from physical attacks in the UDM.\nThe UDM shall hold the Home Network Public Key Identifier(s) for the private/public key pair(s) used for subscriber privacy.\nThe algorithm used for subscriber privacy shall be executed in the secure environment of the UDM.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.8a\tRequirements on AUSF",
                    "description": "",
                    "summary": "",
                    "text_content": "The Authentication server function (AUSF) shall handle authentication requests for both, 3GPP access and non-3GPP access.\nThe AUSF shall provide SUPI to the VPLMN only after authentication confirmation if authentication request with SUCI was sent by VPLMN.\nThe AUSF shall inform the UDM that a successful or unsuccessful authentication of a subscriber has occurred.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.9\tCore network security",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.9.1\tTrust boundaries",
                            "text_content": "It is assumed for the set of requirements in this sub-clause that mobile network operators subdivide their networks into trust zones. Subnetworks of different operators are assumed to lie in different trust zones. Messages that traverse trust boundaries shall follow the requirements in sub-clause 5.9.2 of the present document, if not protected end to end by NDS/IP as specified in TS 33.210 [3].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.9.2\tRequirements on service-based architecture",
                            "text_content": "NF Service based discovery and registration shall support confidentiality, integrity, and replay protection.\nNRF shall be able to ensure that NF Discovery and registration requests are authorized.\nNF Service based discovery and registration shall be able to hide the topology of the available / supported NF's in one administrative/trust domain from entities in different trust/administrative domains (e.g. between NFs in the visited and the home networks.)\nNF Service Request and Response procedure shall support mutual authentication between NF Service Consumer and NF Service Producer.\nEach NF shall validate all incoming messages. Messages that are not valid according to the protocol specification and network state shall be either rejected or discarded by the NF.\nThe Network Repository Function (NRF) receives NF Discovery Request from an NF instance, provides the information of the discovered NF instances to the NF instance, and maintains NF profiles. The NRF receives from NF Service Consumers or SCPs access token requests for service consumption and provides authorization tokens.\nThe NRF shall act as authorization server.The following NRF service-based architecture security requirements shall apply:\nNRF and NFs that are requesting service shall be mutually authenticated.\nNRF may provide authentication and authorization to NFs for establishing secure communication between each other.\nThe Network Exposure Function (NEF) supports external exposure of capabilities of Network Functions to Application Functions, which interact with the relevant Network Functions via the NEF.\nThe interface between the NEF and the Application Function shall fulfil the following requirements:\n-\tIntegrity protection, replay protection and confidentiality protection for communication between the NEF and Application Function shall be supported.\n-\tMutual authentication between the NEF and Application Function shall be supported.\n-\tInternal 5G Core information such as DNN, S-NSSAI etc., shall not be sent outside the 3GPP operator domain.\n-\tSUPI shall not be sent outside the 3GPP operator domain by NEF.\nThe NEF shall be able to determine whether the Application Function is authorized to interact with the relevant Network Functions..\nThe SCP has interfaces with Network Functions (NF) and peer SCPs within the PLMN (or SNPN). The interface between the SCP and the NFs and between the two SCPs shall fulfil the following requirements:\n-\tMutual authentication shall be performed between the SCP and NFs, and between the two SCPs within the PLMN (or SNPN).\n-\tAll communication between the SCP and NFs and between SCPs shall be confidentiality, integrity and replay protected.\nIf SCP endpoints are co-located with the NFs, the above two requirements may be satisfied by colocation.\nThe SCP shall provide confidentiality, integrity and replay protection for its internal communication over SCP internal network interfaces.\nNOTE 1: All parties communicating through the SCP need to trust the SCP to correctly handle the messages passing through it.\nIf the signalling message (service/subscription request or notification message) from the sending NF does not include the PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header and the sending SCP can determine the PLMN ID or SNPN ID value to be included in the 3gpp-Sbi-Originating-Network-Id header, the sending SCP should include it.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.9.3\tRequirements for e2e core network interconnection security",
                            "text_content": "The present sub-clause contains requirements common to sub-clauses 5.9.2 and 5.9.3.\nA solution for e2e core network interconnection security shall satisfy the following requirements.\nThe solution shall support application layer mechanisms for addition, deletion and modification of message elements by intermediate nodes except for specific message elements described in the present document.\nNOTE:\tTypical example for such a case is IPX providers modifying messages for routing purposes.\nThe solution shall provide confidentiality and/or integrity end-to-end between source and destination network for specific message elements identified in the present document. For this requirement to be fulfilled, the SEPP – cf [2], clause 6.2.17 shall be present at the edge of the source and destination networks dedicated to handling e2e Core Network Interconnection Security. The confidentiality and/or integrity for the message elements is provided between two SEPPs of the source and destination PLMN–.\nThe destination network shall be able to determine the authenticity of the source network that sent the specific message elements protected according to the preceding bullet. For this requirement to be fulfilled, it shall suffice that a SEPP in the destination network that is dedicated to handling e2e Core Network Interconnection Security can determine the authenticity of the source network.\nThe solution should have minimal impact and additions to 3GPP-defined network elements.\nThe solution should be using standard security protocols.\nThe solution shall cover interfaces used for roaming purposes.\nThe solution should take into account considerations on performance and overhead.\nThe solution shall cover prevention of replay attacks.\nThe solution shall cover algorithm negotiation and prevention of bidding down attacks.\nThe solution should take into account operational aspects of key management.\nThe SEPP shall act as a non-transparent proxy node.\nThe SEPP shall protect application layer control plane messages between two NFs belonging to different PLMNs or SNPNs that use the N32 interface to communicate with each other.\nThe SEPP shall perform mutual authentication and negotiation of cipher suites with the SEPP in the roaming network.\nThe SEPP shall handle key management aspects that involve setting up the required cryptographic keys needed for securing messages on the N32 interface between two SEPPs.\nThe SEPP shall perform topology hiding by limiting the internal topology information visible to external parties.\nAs a reverse proxy the SEPP shall provide a single point of access and control to internal NFs.\nThe receiving SEPP shall be able to verify whether the sending SEPP is authorized to use the PLMN ID or SNPN ID in the received N32 message.\nThe SEPP to SEPP communication may go via up to two Roaming Intermediaries.  The changes made by Roaming Intermediaries to messages originated by a SEPP, based on the originating PLMNs policy, shall be identifiable by the receiving SEPP.\nThe SEPP shall be able to clearly differentiate between certificates used for authentication of peer SEPPs and certificates used for authentication of Roaming Intermediaries performing message modifications. The SEPP shall support multiple trust anchors.\nNOTE 1: Such a differentiation and support of multiple trust anchors could be done, e.g. , by implementing separate certificate storages.\nThe SEPP shall discard malformed N32 signaling messages.\nThe sending SEPP shall reject messages received from the NF (directly or via SCP) with JSON including \"encBlockIndex\" (regardless of the encoding used for that JSON request).\nThe receiving SEPP shall reject any message in which a Roaming Intermediary has inserted or relocated references to encBlockIndex.\nThe SEPP shall implement rate-limiting functionalities to defend itself and subsequent NFs against excessive CP signaling. This includes SEPP-to-SEPP signaling messages.\nThe SEPP shall implement anti-spoofing mechanisms that enable cross-layer validation of source and destination address and identifiers (e.g. FQDNs or PLMN IDs).\nNOTE 2: An example for such an anti-spoofing mechanism is the following: If there is a mismatch between different layers of the message or the destination address does not belong to the SEPP’s own PLMN (or SNPN), the message is discarded.\nThe SEPP shall be able to use one or more PLMN IDs (or SNPN IDs). In the situation that a PLMN  (or SNPN) is using more than one PLMN ID (or SNPN ID), this PLMN’s SEPP (or SNPN’s SEPP) may use the same N32-connection for all of the networks PLMN IDs (or SNPN IDs), with each of the PLMN’s (or SNPN’s) remote partners. If different PLMNs (or SNPNs) are represented by the PLMN IDs  (or SNPN IDs) supported by a SEPP, the SEPP shall use separate N32-connections for each pair of home and visited PLMN (or SNPN).\nNOTE 3: \tIf a given PLMN uses a Roaming Hub for the purposes of roaming with multiple other PLMNs, then a single TLS connection between the PLMN’s SEPP and the roaming hub can be used for carrying the N32-f PRINS signalling for some or all the other PLMNs.\nNOTE 4: void\nError messages may be originated from either PLMN SEPPs or Roaming Hubs to adjacent Roaming Hubs or adjacent PLMN SEPPs, in an identifiable way.\nIf allowed by the PLMN policy, the SEPP shall be able to send error messages on the N32 interface to a roaming hub.\nSpecific error messages relevant to Roaming Hubs shall be supported (such as 'an IE is encrypted while it was expected to be available in the clear', 'an IE is not encrypted while its availability in the clear is not required', 'the N32 connection cannot be setup due to contractual reasons', 'the N32 connection cannot be setup due to a connectivity issue' and 'the message was not delivered due to contractual reasons').\nSending SEPP behavior for the 3gpp-Sbi-Originating-Network-Id header specified in TS 29.500 [74]:\n- \tIf the sending NF or the SCP has inserted the 3gpp-Sbi-Originating-Network-Id header in the signaling message (service/subscription request or notification message), the sending SEPP shall compare the PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header in the received signaling message with the PLMN ID(s) or SNPN ID(s) that the sending SEPP represents by its certificate.\n- \tIf the PLMN ID or SNPN ID does not match with any of the PLMN IDs that the sending SEPP represents, the sending SEPP shall discard the received signaling message.\n-\tIf the PLMN ID or SNPN ID matches with any of the PLMN IDs that the sending SEPP represents, the sending SEPP shall forward the signaling message to the receiving SEPP.\n-\tIf the sending NF and the SCP have not included the 3gpp-Sbi-Originating-Network-Id header in the signalling message, the sending SEPP shall include the 3gpp-Sbi-Originating-Network-Id header and send the updated signaling message to the receiving SEPP.\n-\tIf the sending SEPP only represents one PLMN ID or SNPN ID, the sending SEPP shall insert the 3gpp-Sbi-Originating-Network-Id header with this ID.\n-\tIf the sending SEPP represents multiple PLMN IDs or SNPN IDs, it is up to configuration and deployment to determine which PLMN ID or SNPN ID value should be included in the header.\nReceiving SEPP behavior for the 3gpp-Sbi-Originating-Network-Id header:\n- \tThe receiving SEPP shall check whether the 3gpp-Sbi-Originating-Network-Id header included in the signalling message belongs to the sending SEPP’s own PLMN or SNPN. It does this by verifying that the asserted PLMN ID in the 3gpp-Sbi-Originating-Network-Id header matches one of the sending SEPP's own PLMN ID(s) or SNPN ID(s) either in the N32-f context, the sending SEPP's certificate, or a locally configured list of PLMN IDs or SNPN-IDs that the sending SEPP represents.\n- \tIf the 3gpp-Sbi-Originating-Network-Id header does not match with any of the PLMN IDs or SNPN IDs belonging to the peer sending SEPP, the receving SEPP shall discard the received signaling message.\n- \tIf the 3gpp-Sbi-Originating-Network-Id header matches with any PLMN ID of the PLMN or SNPN IDs belonging to the peer sending SEPP, the header is successfully verified, and the receiving SEPP shall forward the received signaling message to the target NF.\nA PLMN SEPP that makes use of Roaming Intermediaries shall be able to handle error messages generated by Roaming Intermediaries, delivered over the N32 connection.\nThe following error messages relevant to Roaming Hub shall be supported,\n-\t'an IE is encrypted while it was expected to be available in the clear',\n-\t'an IE is not encrypted while its availability in the clear is not required',\n-\t'the N32 connection cannot be setup due to contractual reasons',\n-\t'the N32 connection cannot be setup due to a connectivity issue', and\n-\t'the message was not delivered due to contractual reasons'.\nThe mechanism used by the SEPP for setting up N32-c via a chain of Roaming Intermediaries shall contain sufficient information such that the target PLMN and the Roaming Intermediaries can determine the identities of the initiating PLMN and the target PLMN.\nNote: The Roaming Intermediary can reject the N32-c connection if no roaming relation exists. In this case, the expected error is \"the N32 connection cannot be setup due to contractual reasons\".\nAdditionally, it shall be possible for the Roaming Hubs to generate application layer control plane messages in order to reject traffic. Application layer control plane messages may be generated by the Roaming Hubs in order to reject registration attempts (refer to TS 23.502 [8] clause 4.2.2.2), to terminate sessions (see TS 23.502 [8] clause 4.3.4.3) and/or deregister the UE (refer to TS 23.502 [8] clause 4.2.2.3.3) and shall be sent using the corresponding NF Service operation to the NF, when relevant decisions are enforced by the Roaming Hub.\nIn this case, such messages are transparent to the SEPP and the SEPP shall act on them as any other message on the N32-f interface not making use of Roaming Intermediaries. How the SEPP authorizes such messages is left to implementation.\nIntegrity protection shall be applied to all attributes transferred over the N32-f interface.\nConfidentiality protection shall be applied to all attributes specified in SEPP's Data-type Encryption Policy (clause 13.2.3.2). The following attributes shall be confidentiality protected when being sent over the N32-f interface, irrespective of the Data-type Encryption Policy:\n-\tAuthentication Vectors.\n-\tCryptographic material.\n-\tLocation data, e.g. Cell ID and Physical Cell ID.\n-\tContent of SMS in case of SMS over SBI over N32.\n-\tAuthorization token.\nThe following attributes should additionally be confidentiality protected when being sent over the N32-f interface:\n-\tSUPI.\nThe IPUPS shall only forward GTP-U packets that contain an F-TEID that belongs to an active PDU session and discard all others.\nThe IPUPS shall discard malformed GTP-U messages.\nThe NF that sends a signalling message (service/subscription request or notification message) shall include its PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header.\nIf an NF supports multiple PLMN IDs or SNPN IDs, the sending NF shall include the PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header on behalf of which the message is sent.\nThe handling of the PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header at the receiving NF is up to configuration and deployment.\nNOTE:\tA misconfigured PLMN ID or SNPN ID in the 3gpp-Sbi-Originating-Network-Id header can lead to service interruption.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.10\tVisibility and configurability",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.10.1\tSecurity visibility",
                            "text_content": "Although in general the security features should be transparent to the user or application, for certain events and according to the user's or application's concern, greater visibility of the operation of following security feature shall be provided:\n-\tAS confidentiality: (AS confidentiality, Confidentiality algorithm, bearer information)\n-\tAS integrity: (AS integrity, Integrity algorithm, bearer information)\n-\tNAS confidentiality: (NAS confidentiality, Confidentiality algorithm)\n-\tNAS integrity: (NAS integrity, Integrity algorithm)\nThe UE shall provide above security information to the applications in the UE (e.g. via APIs), on a per PDU session granularity.\nThe serving network identifier shall be available for applications in the UE.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.10.2\tSecurity configurability",
                            "text_content": "Security configurability lets a user to configure certain security feature settings on a UE that allows the user to manage additional capability or use certain advanced security features.\nThe following configurability feature should be provided:\n-\tGranting or denying access to USIM without authentication as described in TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.11\tRequirements for algorithms, and algorithm selection",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "5.11.1\tAlgorithm identifier values",
                            "text_content": "All identifiers and names specified in this sub-clause are for 5G NAS and New Radio. In relation to AS capabilities, the identifiers and names for E-UTRAN connected to 5GC are specified in TS 33.401 [10].\nEach encryption algorithm will be assigned a 4-bit identifier. The following values for ciphering algorithms are defined:\n\"00002\"         NEA0\t\t\tNull ciphering algorithm;\n\"00012\"         128-NEA1\t\t128-bit SNOW 3G based algorithm;\n\"00102\"         128-NEA2\t\t128-bit AES based algorithm; and\n\"00112\"         128-NEA3\t\t128-bit ZUC based algorithm.\n128-NEA1 is based on SNOW 3G (see TS 35.215 [14]).\n128-NEA2 is based on 128-bit AES [15] in CTR mode [16].\n128-NEA3 is based on 128-bit ZUC (see TS 35.221 [18]).\nFull details of the algorithms are specified in Annex D.\nAll identifiers and names specified in the present sub-clause are for 5G NAS and New Radio. In relation to AS capabilities, the identifiers and names for E-UTRAN connected to 5GC are specified in TS 33.401 [10].\nEach integrity algorithm used for 5G will be assigned a 4-bit identifier. The following values for integrity algorithms are defined:\n\"00002\"         NIA0\t\t\tNull Integrity Protection algorithm;\n\"00012\"         128-NIA1\t\t128-bit SNOW 3G based algorithm;\n\"00102\"         128-NIA2\t\t128-bit AES based algorithm; and\n\"00112\"         128-NIA3\t\t128-bit ZUC based algorithm.\n128-NIA1 is based on SNOW 3G (see TS 35.215 [14]).\n128-NIA2 is based on 128-bit AES [15] in CMAC mode [17].\n128-NIA3 is based on 128-bit ZUC (see TS 35.221 [18]).\nFull details of the algorithms are specified in Annex D.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "5.11.2\tRequirements for algorithm selection",
                            "text_content": "a)\tUE in RRC_Connected and a serving network shall have agreed upon algorithms for\n-\tCiphering and integrity protection of RRC signalling and user plane (to be used between UE and gNB)\n-\tCiphering and integrity protection of RRC signalling and  user plane (to be used between UE and ng-eNB)\n-\tNAS ciphering and NAS integrity protection (to be used between UE and AMF)\nb)\tThe serving network shall select the algorithms to use dependent on\n-\tthe UE security capabilities of the UE,\n-\tthe configured allowed list of security capabilities of the currently serving network entity\nc)\tThe UE security capabilities shall include NR NAS algorithms for NAS level, NR AS algorithms for AS layer and LTE algorithms for AS level if the UE supports E-UTRAN connected to 5GC.\nNOTE:\tIf the UE supports both E-UTRAN and NR connected to 5GC, the UE 5G security capabilities include both the LTE and NR algorithms.\nd)\tEach selected algorithm shall be indicated to a UE in a protected manner such that a UE is ensured that the integrity of algorithm selection is protected against manipulation.\ne)\tThe UE security capabilities shall be protected against \"bidding down attacks\".\nf)\tIt shall be possible that the selected AS and NAS algorithms are different at a given point of time.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "5.12\tRequirements on 5G-RG",
                    "description": "",
                    "summary": "",
                    "text_content": "The 5G-RG shall be equipped with UICC where the subscription credentials resides. If provisioned by the home operator, the 5G-RG shall store the Home Network Public Key required for concealing the SUPI in the UICC.\nThe 5G-RG shall support all the security requirements and features of the UE defined in clause 5.2.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "5.13\tRequirements on NSSAAF",
                    "description": "",
                    "summary": "",
                    "text_content": "The Network slice specific and SNPN authentication and authorization function (NSSAAF) shall handle the Network Slice Specific Authentication requests from the serving AMF as specified in clause 16.The NSSAAF shall also support functionality for access to SNPN using credentials from Credentials Holder using AAA Server as specified in clause I.2.2.2.\nThe NSSAAF is responsible to send the NSSAA requests to the appropriate AAA-S.\nThe NSSAAF shall support AAA-S triggered Network Slice-Specific Re-authentication and Re-authorization and Slice-Specific Authorization Revocation and translate any AAA protocol into a Service Based format.\nNSSAAF shall translate the Service based messages from the serving AMF or AUSF to AAA protocols towards AAA-P/AAA-S.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "6\tSecurity procedures between UE and 5G network functions",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "6.0\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "When the UE is capable of connecting to 5GC and EPC and connected to an ng-eNB which is connected to both EPC and 5GC, the UE has the ability to select which core network to connect to as described in clause 4.8.4 in TS24.501[35]. If the UE selects the EPC, the UE shall use security procedure as in TS33.401[10]. Otherwise, if the UE selects 5GC, the UE shall use the security procedures as per this document.\nFor an ng-eNB which can connect to EPC and 5GC, the ng-eNB shall choose the corresponding security procedures based on the UE selected type of core netowrk, i.e., when EPC is selected, the ng-eNB shall use security procedures as described in TS33.401[10]. On the other hand, when 5GC is selected, the ng-eNB shall use security procedures as described in this document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "6.1\tPrimary authentication and key agreement",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.1.1\tAuthentication framework",
                            "text_content": "The purpose of the primary authentication and key agreement procedures is to enable mutual authentication between the UE and the network and provide keying material that can be used between the UE and the serving network in subsequent security procedures. The keying material generated by the primary authentication and key agreement procedure results in an anchor key called the KSEAF provided by the AUSF of the home network to the SEAF of the serving network.\nKeys for more than one security context can be derived from the KSEAF without the need of a new authentication run. A concrete example of this is that an authentication run over a 3GPP access network can also provide keys to establish security between the UE and a N3IWF used in untrusted non-3GPP access.\nThe anchor key KSEAF  is derived from an intermediate key called the KAUSF. The KAUSF is established between the UE and HN resulting from the primary authentication procedure. The KAUSF may be securely stored in the AUSF based on the home operator's policy on using such key e.g. if the control plane solution for Steering of Roaming (see clause 6.14) or UE Parameter Update procedures (see clause 6.15) or AKMA are supported by the HPLMN.\nNOTE A: For standalone non-public networks when an authentication method other than 5G AKA or EAP-AKA' is used, Annex I.2 applies.\nNOTE 1:\tThis feature is an optimization that might be useful, for example, when a UE registers to different serving networks for 3GPP-defined access and untrusted non-3GPP access (this is possible according to TS 23.501 [2]). The details of this feature are operator-specific and not in scope of this document.\nNOTE 2:\tA subsequent authentication based on the KAUSF stored in the AUSF gives somewhat weaker guarantees than an authentication directly involving the ARPF and the USIM. It is rather comparable to fast re-authentication in EAP-AKA'.\nNOTE 2a:\tVoid.\nUE and serving network shall support EAP-AKA' and 5G AKA authentication methods.\nNOTE 2b: It is the home operator's decision which authentication method is selected.\nThe USIM shall reside on a UICC. The UICC may be removable or non-removable.\nNOTE 3:\tFor non-3GPP access networks USIM applies in case of terminal with 3GPP access capabilities.\nIf the terminal supports 3GPP access capabilities, the credentials used with EAP-AKA' and 5G AKA for non-3GPP access networks shall reside on the UICC.\nNOTE 4:\tEAP-AKA' and 5G AKA are the only authentication methods that are supported in UE and serving network, hence only they are described in sub-clause 6.1.3 of the present document. For a private network using the 5G system as specified in [7] an example of how additional authentication methods can be used with the EAP framework is given in the informative Annex B.\nNOTE 5: For non-public network (NPN) security the Annex I of the present document provides details.\nUpon successful completion of the 5G AKA primary authentication, the AMF shall initiate NAS security mode command procedure (see clause 6.7.2) with the UE.\nNOTE 6: The reason to mandatory run the NAS SMC procedure after primary authentication is because the UE does not store the new derived KAUSF until receiving the NAS SMC message. The new partial native NAS security context is taken into use. It is specified in clause 6.9.4.4 whether AS key re-keying is performed.\nThe EAP framework is specified in RFC 3748 [27]. It defines the following roles: peer, pass-through authenticator and back-end authentication server. The back-end authentication server acts as the EAP server, which terminates the EAP authentication method with the peer. In the 5G system,  the EAP framework is supported in the following way:\n-\tThe UE takes the role of the peer.\n-\tThe SEAF takes the role of pass-through authenticator.\n-\tThe AUSF takes the role of the backend authentication server.\nThe primary authentication and key agreement procedures shall bind the KSEAF to the serving network. The binding to the serving network prevents one serving network from claiming to be a different serving network, and thus provides implicit serving network authentication to the UE.\nThis implicit serving network authentication shall be provided to the UE irrespective of the access network technology, so it applies to both 3GPP and non-3GPP access networks.\nFurthermore, the anchor key provided to the serving network shall also be specific to the authentication having taken place between the UE and a 5G core network, i.e. the KSEAF shall be cryptographically separate from the key KASME delivered from the home network to the serving network in earlier mobile network generations.\nThe anchor key binding shall be achieved by including a parameter called \"serving network name\" into the chain of key derivations that leads from the long-term subscriber key to the anchor key.\nThe value of serving network name is defined in sub-clause 6.1.1.4 of the present document.\nThe chain of key derivations that leads from the long-term subscriber key to the anchor key is specified in sub-clause 6.1.3 of the present document for each (class) of authentication methods. The key derivation rules are specified in Annex A.\nNOTE:\tNo parameter like 'access network type' is used for anchor key binding as 5G core procedures are supposed to be access network agnostic.\nThe serving network name is used in the derivation of the anchor key. It serves a dual purpose, namely:\n-\tIt binds the anchor key to the serving network by including the serving network identifier (SN Id).\n-\tIt makes sure that the anchor key is specific for authentication between a 5G core network and a UE by including a service code set to \"5G\".\nIn 5G AKA, the serving network name has a similar purpose of binding the RES* and XRES* to the serving network.\nThe serving network name is the concatenation of a service code and the SN Id with a separation character \":\" such that the service code prepends the SN Id.\nNOTE:\tNo parameter like 'access network type' is used for serving network name as it relates to a 5G core procedure that is access network agnostic.\nThe SN Id identifies the serving PLMN and, except for standalone non-public networks, is defined as SNN-network-identifier in TS 24.501[35].\nNOTE 1: For standalone non-public networks, the definition of SN Id is given in Annex I.3.\nThe UE shall construct the serving network name as follows:\n-\tIt shall set the service code to \"5G\".\n-\tIt shall set the network identifier to the SN Id of the network that it is authenticating to.\n-\tConcatenate the service code and the SN Id with the separation character \":\".\nThe SEAF shall construct the serving network name as follows:\n-\tIt shall set the service code to \"5G\".\n-\tIt shall set the network identifier to the SN Id of the serving network to which the authentication data is sent by the AUSF.\n-\tIt shall concatenate the service code and the SN Id with the separation character \":\".\nNOTE:\tAUSF gets the serving network name from the SEAF. Before using the serving network name, AUSF checks that the SEAF is authorized to use it, as specified in clause 6.1.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.1.2\tInitiation of authentication and selection of authentication method",
                            "text_content": "The initiation of the primary authentication is shown in Figure 6.1.2-1.\nThe figure depicts the initiation of the authentication procedure and selection of the authentication method in a network security system. It illustrates the steps involved in the authentication process, including the user's input, the system's response, and the user's acceptance of the response. The figure also shows the different authentication methods available, such as password, token, and biometric authentication, and their respective steps and outputs.\nFigure 6.1.2-1: Initiation of authentication procedure and selection of authentication method\nThe SEAF may initiate an authentication with the UE during any procedure establishing a signalling connection with the UE, according to the SEAF's policy. The UE shall use SUCI or 5G-GUTI in the Registration Request.\nThe SEAF shall invoke the Nausf_UEAuthentication service by sending a Nausf_UEAuthentication_Authenticate Request message to the AUSF whenever the SEAF wishes to initiate an authentication.\nThe Nausf_UEAuthentication_Authenticate Request message shall contain either:\n-\tSUCI, as defined in the current specification, or\n-\tSUPI, as defined in TS 23.501 [2].\nThe SEAF shall include the SUPI in the Nausf_UEAuthentication_Authenticate Request message in case the SEAF has a valid 5G-GUTI and re-authenticates the UE. Otherwise the SUCI is included in Nausf_UEAuthentication_Authenticate Request. SUPI/SUCI structure is part of stage 3 protocol design.\nThe Nausf_UEAuthentication_Authenticate Request shall furthermore contain:\n-\tthe serving network name, as defined in sub-clause 6.1.1.4 of the present document.\nNOTE 1:\tThe local policy for the selection of the authentication method does not need to be on a per-UE basis, but can be the same for all UEs.\nThe Nausf_UEAuthentication_Authenticate Request may furthermore contain:\n-\tDisaster Roaming service indication, as specified in TS 23.502[8] clause 4.2.2.2.\nUpon receiving the Nausf_UEAuthentication_Authenticate Request message, the AUSF shall check that the requesting SEAF in the serving network identified by the 3gpp-Sbi-Originating-Network-Id header specified in TS 29.500 [74] is entitled to use the serving network name in the Nausf_UEAuthentication_Authenticate Request.\nNOTE 1a: \tAs described in clause 5.9.3.2, the SEPP in the AUSF's network verifies the correctness of the 3gpp-Sbi-Originating-Network-Id header and the SEPP in the SEAF's network ensures that the 3gpp-Sbi-Originating-Network-Id is included.\nThe AUSF shall store the received serving network name temporarily. If the serving network is not authorized to use the serving network name, the AUSF shall respond with \"serving network not authorized\" in the Nausf_UEAuthentication_Authenticate Response.\nNOTE 2:\tThe AUSF and the UDM may be configured with Disaster Condition via OAM based on operator policy and the request by the government agencies.\nFor the Disaster Roaming, the AUSF shall check the local configuration and, if allowed, the AUSF sends Nudm_UEAuthentication_Get Request to the UDM.\nThe Nudm_UEAuthentication_Get Request sent from AUSF to UDM includes the following information:\n-\tSUCI or SUPI;\n-\tthe serving network name;\n-\tif received from SEAF, Disaster Roaming service indication;\nUpon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke SIDF if a SUCI is received. SIDF shall de-conceal SUCI to gain SUPI before UDM can process the request.\nBased on SUPI, the UDM/ARPF shall choose the authentication method.\nNOTE 3:\tThe Nudm_UEAuthentication_Get Response in reply to the Nudm_UEAuthentication_Get Request and the Nausf_UEAuthentication_Authenticate Response message in reply to the Nausf_UEAuthentication_Authenticate Request message are described as part of the authentication procedures in clause 6.1.3.\nFor the Disaster Roaming, the UDM shall check the local configuration and, if allowed, the UDM proceeds with the chosen authentication method.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.1.3\tAuthentication procedures",
                            "text_content": "EAP-AKA' is specified in RFC 5448 [12]. The 3GPP 5G profile for EAP-AKA' is specified in the normative Annex F.\nThe selection of using EAP-AKA' is described in sub-clause 6.1.2 of the present document.\n\nThe figure depicts the authentication procedure for EAP-AKA, which is a key component of the EAP-TTLS protocol used in 5G networks. The authentication process involves the use of a key exchange between the EAP server and the client, ensuring secure communication. The figure illustrates the key exchange process, including the exchange of authentication keys, the use of a shared secret, and the establishment of a secure channel. The figure also shows the client's response to the authentication request, which is a key part of the authentication process.\nFigure 6.1.3.1-1: Authentication procedure for EAP-AKA'\nThe authentication procedure for EAP-AKA' works as follows, cf. also Figure 6.1.3.1-1:\n1.\tThe UDM/ARPF shall first generate an authentication vector with Authentication Management Field (AMF) separation bit = 1 as defined in TS 33.102 [9]. The UDM/ARPF shall then compute CK' and IK' as per the normative Annex A and replace CK and IK by CK' and IK'.\n2.\tThe UDM shall subsequently send this transformed authentication vector AV' (RAND, AUTN, XRES, CK', IK') to the AUSF from which it received the Nudm_UEAuthentication_Get Request together with an indication that the AV' is to be used for EAP-AKA' using a Nudm_UEAuthentication_Get Response message.\nNOTE:\tThe exchange of a Nudm_UEAuthentication_Get Request message and an Nudm_UEAuthentication_Get Response message between the AUSF and the UDM/ARPF described in the preceding paragraph is the same as for trusted access using EAP-AKA' described in TS 33.402 [11], sub-clause 6.2, step 10, except for the input parameter to the key derivation, which is the value of <network name>. The \"network name\" is a concept from RFC 5448 [12]; it is carried in the AT_KDF_INPUT attribute in EAP-AKA'. The value of <network name> parameter is not defined in RFC 5448 [12], but rather in 3GPP specifications. For EPS, it is defined as \"access network identity\" in TS 24.302 [71], and for 5G, it is defined as \"serving network name\" in sub-clause 6.1.1.4 of the present document.\nIn case SUCI was included in the Nudm_UEAuthentication_Get Request, UDM will include the SUPI in the Nudm_UEAuthentication_Get Response.\nIf a subscriber has an AKMA subscription, the UDM shall include the AKMA indication and Routing indicator in the Nudm_UEAuthentication_Get Response.\n3.\tThe AUSF shall send the EAP-Request/AKA'-Challenge message to the SEAF in a Nausf_UEAuthentication_Authenticate Response message.\n4.\tThe SEAF shall transparently forward the EAP-Request/AKA'-Challenge message to the UE in a NAS message Authentication Request message. The ME shall forward the RAND and AUTN received in EAP-Request/AKA'-Challenge message to the USIM. This message shall include the ngKSI and ABBA parameter. In fact, SEAF shall include the ngKSI and ABBA parameter in all EAP-Authentication request message. The ngKSI will be used by the UE and AMF to identify the partial native security context that is created if the authentication is successful. The SEAF shall set the ABBA parameter as defined in Annex A.7.1. During an EAP authentication, the value of the ngKSI and the ABBA parameter sent by the SEAF to the UE shall not be changed.\nNOTE 1: \tThe SEAF needs to understand that the authentication method used is an EAP method by evaluating the type of authentication method based on the Nausf_UEAuthentication_Authenticate Response message.\n5.\tAt receipt of the RAND and AUTN, the USIM shall verify the freshness of the AV' by checking whether AUTN can be accepted as described in TS 33.102 [9]. If so, the USIM computes a response RES. The USIM shall return RES, CK, IK to the ME. If the USIM computes a Kc (i.e. GPRS Kc) from CK and IK using conversion function c3 as described in TS 33.102 [9], and sends it to the ME, then the ME shall ignore such GPRS Kc and not store the GPRS Kc on USIM or in ME. The ME shall derive CK' and IK' according to Annex A.3.\nIf the verification of the AUTN fails on the USIM, then the USIM and ME shall proceed as described in sub-clause 6.1.3. 3.\n6.\tThe UE shall send the EAP-Response/AKA'-Challenge message to the SEAF in a NAS message Auth-Resp message.\n7.\tThe SEAF shall transparently forward the EAP-Response/AKA'-Challenge message to the AUSF in Nausf_UEAuthentication_Authenticate Request message.\n8.\tThe AUSF shall verify the message by comparing the XRES and RES, and if the AUSF has successfully verified this message it shall continue as follows, otherwise it shall return an error to the SEAF. AUSF shall inform UDM about the authentication result (see sub-clause 6.1.4 of the present document for details on linking authentication confirmation).\n9.\tThe AUSF and the UE may exchange EAP-Request/AKA'-Notification and EAP-Response /AKA'-Notification messages via the SEAF. The SEAF shall transparently forward these messages.\nNOTE 2: \tEAP Notifications as described in RFC 3748 [27] and EAP-AKA Notifications as described in RFC 4187 [21] can be used at any time in the EAP-AKA exchange. These notifications can be used e.g. for protected result indications or when the EAP server detects an error in the received EAP-AKA response.\n10.\tThe AUSF derives EMSK from CK’ and IK’ as described in RFC 5448[12] and Annex F. The AUSF uses the most significant 256 bits of EMSK as the KAUSF and then calculates KSEAF from KAUSF as described in clause A.6. The AUSF shall send an EAP Success message to the SEAF inside Nausf_UEAuthentication_Authenticate Response, which shall forward it transparently to the UE. Nausf_UEAuthentication_Authenticate Response message contains the KSEAF. If the AUSF received a SUCI from the SEAF when the authentication was initiated (see sub-clause 6.1.2 of the present document), then the AUSF shall also include the SUPI in the Nausf_UEAuthentication_Authenticate Response message. The AUSF stores the KAUSF based on the home network operator's policy according to clause 6.1.1.1.\nNOTE 3: \tFor lawful interception, the AUSF sending SUPI to SEAF is necessary but not sufficient. By including the SUPI as input parameter to the key derivation of KAMF from KSEAF, additional assurance on the correctness of SUPI is achieved by the serving network from both, home network and UE side.\n11.\tThe SEAF shall send the EAP Success message to the UE in the N1 message. This message shall also include the ngKSI and the ABBA parameter. The SEAF shall set the ABBA parameter as defined in Annex A.7.1.\nNOTE 4: \tStep 11 could be NAS Security Mode Command or Authentication Result.\nNOTE 5: \tThe ABBA parameter is included to enable the bidding down protection of security features that may be introduced later.\nThe key received in the Nausf_UEAuthentication_Authenticate Response message shall become the anchor key, KSEAF in the sense of the key hierarchy in sub-clause 6.2 of the present document. The SEAF shall then derive the KAMF from the KSEAF, the ABBA parameter and the SUPI according to Annex A.7 and send it to the AMF. On receiving the EAP-Success message, the UE derives EMSK from CK’ and IK’ as described in RFC 5448 and Annex F. The ME uses the most significant 256 bits of the EMSK as the KAUSF and then calculates KSEAF in the same way as the AUSF. The UE shall derive the KAMF from the KSEAF, the ABBA parameter and the SUPI according to Annex A.7.\nNOTE 6:\tAs an implementation option, the UE creates the temporary security context as described in step 11 after receiving the EAP message that allows EMSK to be calculated. The UE turns this temporary security context into a partial security context when it receives the EAP Success. The UE removes the temporary security context if the EAP authentication fails.\nThe further steps taken by the AUSF upon receiving a successfully verified EAP-Response/AKA'-Challenge message are described in sub-clause 6.1.4 of the present document.\nIf the EAP-Response/AKA'-Challenge message is not successfully verified, the subsequent AUSF behaviour is determined according to the home network's policy.\nIf AUSF and SEAF determine that the authentication was successful, then the SEAF provides the ngKSI and the KAMF to the AMF.\n5G AKA enhances EPS AKA [10] by providing the home network with proof of successful authentication of the UE from the visited network. The proof is sent by the visited network in an Authentication Confirmation message.\nThe selection of using 5G AKA is described in sub-clause 6.1.2 of the present document.\nNOTE 1:\t5G AKA does not support requesting multiple 5G AVs, neither the SEAF pre-fetching 5G AVs from the home network for future use.\n\nThe figure depicts the authentication procedure for 5G AKA (Authentication Key Agreement), which is a key component of 5G network security. It illustrates the process of establishing a secure communication channel between two devices, with the authentication key being exchanged between them. The figure shows the steps involved in the authentication process, including the exchange of the authentication key, the establishment of a secure channel, and the verification of the key exchange. The figure is a visual representation of the complex security protocols used in 5G networks.\nFigure 6.1.3.2-1: Authentication procedure for 5G AKA\nThe authentication procedure for 5G AKA works as follows, cf. also Figure 6.1.3.2-1:\n1.\tFor each Nudm_Authenticate_Get Request, the UDM/ARPF shall create a 5G HE AV. The UDM/ARPF does this by generating an AV with the Authentication Management Field (AMF) separation bit set to \"1\" as defined in TS 33.102 [9]. The UDM/ARPF shall then derive KAUSF (as per Annex A.2) and calculate XRES* (as per Annex A.4). Finally, the UDM/ARPF shall create a 5G HE AV from RAND, AUTN, XRES*, and KAUSF.\n2.\tThe UDM shall then return the 5G HE AV to the AUSF together with an indication that the 5G HE AV is to be used for 5G AKA in a Nudm_UEAuthentication_Get Response. In case SUCI was included in the Nudm_UEAuthentication_Get Request, UDM will include the SUPI in the Nudm_UEAuthentication_Get Response after deconcealment of SUCI by SIDF.\nIf a subscriber has an AKMA subscription, the UDM shall include the AKMA indication and Routing indicator in the Nudm_UEAuthentication_Get Response.\n3.\tThe AUSF shall store the XRES* temporarily together with the received SUCI or SUPI.\n4.\tThe AUSF shall then generate the 5G AV from the 5G HE AV received from the UDM/ARPF by computing the HXRES* from XRES* (according to Annex A.5) and KSEAF from KAUSF (according to Annex A.6), and replacing the XRES* with the HXRES* and KAUSF with KSEAF in the 5G HE AV.\n5.\tThe AUSF shall then remove the KSEAF and return the 5G SE AV (RAND, AUTN, HXRES*) to the SEAF in a Nausf_UEAuthentication_UEAuthentication Response.\n6.\tThe SEAF shall send RAND, AUTN to the UE in a NAS message Authentication Request. This message shall also include the ngKSI that will be used by the UE and AMF to identify the KAMF and the partial native security context that is created if the authentication is successful. This message shall also include the ABBA parameter. The SEAF shall set the ABBA parameter as defined in Annex A.7.1. The ME shall forward the RAND and AUTN received in NAS message Authentication Request to the USIM.\nNOTE 2: The ABBA parameter is included to enable the bidding down protection of security features.\n7.\tAt receipt of the RAND and AUTN, the USIM shall verify the freshness of the received values by checking whether AUTN can be accepted as described in TS 33.102[9]. If so, the USIM computes a response RES. The USIM shall return RES, CK, IK to the ME. If the USIM computes a Kc (i.e. GPRS Kc) from CK and IK using conversion function c3 as described in TS 33.102 [9], and sends it to the ME, then the ME shall ignore such GPRS Kc and not store the GPRS Kc on USIM or in ME. The ME then shall compute RES* from RES according to Annex A.4. The ME shall calculate KAUSF from CK||IK according to clause A.2. The ME shall calculate KSEAF from KAUSF according to clause A.6. An ME accessing 5G shall check during authentication that the \"separation bit\" in the AMF field of AUTN is set to 1. The \"separation bit\" is bit 0 of the AMF field of AUTN.\nNOTE 3:\tThis separation bit in the AMF field of AUTN cannot be used anymore for operator specific purposes as described by TS 33.102 [9], Annex F.\n8.\tThe UE shall return RES* to the SEAF in a NAS message Authentication Response.\n9.\tThe SEAF shall then compute HRES* from RES* according to Annex A.5, and the SEAF shall compare HRES* and HXRES*. If they coincide, the SEAF shall consider the authentication successful from the serving network point of view. If not, the SEAF proceed as described in sub-clause 6.1.3.2.2. If the UE is not reached, and the RES* is never received by the SEAF, the SEAF shall consider authentication as failed, and indicate a failure to the AUSF.\n10.\tThe SEAF shall send RES*, as received from the UE, in a Nausf_UEAuthentication_Authenticate Request message to the AUSF.\n11.\tWhen the AUSF receives as authentication confirmation the Nausf_UEAuthentication_Authenticate Request message including a RES* it may verify whether the 5G AV has expired. If the 5G AV has expired, the AUSF may consider the authentication as unsuccessful from the home network point of view. Upon successful authentication, the AUSF stores the KAUSF based on the home network operator's policy according to clause 6.1.1.1. AUSF shall compare the received RES* with the stored XRES*. If the RES* and XRES* are equal, the AUSF shall consider the authentication as successful from the home network point of view. AUSF shall inform UDM about the authentication result (see sub-clause 6.1.4 of the present document for linking with the authentication confirmation).\nNOTE 4: It is left to implementation to temporarily store the KAUSF received in step 2 in AUSF until the RES* verification is done successfully (i.e., at step 11).\n12.\tThe AUSF shall indicate to the SEAF in the Nausf_UEAuthentication_Authenticate Response whether the authentication was successful or not from the home network point of view. If the authentication was successful, the KSEAF shall be sent to the SEAF in the Nausf_UEAuthentication_Authenticate Response. In case the AUSF received a SUCI from the SEAF in the authentication request (see sub-clause 6.1.2 of the present document), and if the authentication was successful, then the AUSF shall also include the SUPI in the Nausf_UEAuthentication_Authenticate Response message.\nIf the authentication was successful, the key KSEAF received in the Nausf_UEAuthentication_Authenticate Response message shall become the anchor key in the sense of the key hierarchy as specified in sub-clause 6.2 of the present document. Then the SEAF shall derive the KAMF from the KSEAF, the ABBA parameter and the SUPI according to Annex A.7. The SEAF shall provide the ngKSI and the KAMF to the AMF. If the AUSF indicates that the authentication was successful from the home network point of view, then the AMF shall initiate NAS security mode command procedure (see clause 6.7.2) with the UE, to take the newly generated partial native 5G NAS security context into use. Upon receiving the valid NAS Security Mode Command message from the AMF, the UE shall consider the performed primary authentication as successful.\nIf a SUCI was used for this authentication, then the SEAF shall only provide ngKSI and KAMF to the AMF after it has received the Nausf_UEAuthentication_Authenticate Response message containing KSEAF and SUPI; no communication services will be provided to the UE until the SUPI is known to the serving network.\nThe further steps taken by the AUSF after the authentication procedure are described in sub-clause 6.1.4 of the present document.\nThis clause describes how RES* verification failure in the SEAF or in the AUSF shall be handled.\nIn step 9 in Figure 6.1.3.2-1, the SEAF shall compute HRES* from RES* according to Annex A.5, and the SEAF shall compare HRES* and HXRES*. If they don’t coincide, then the SEAF shall consider the authentication as unsuccessful.\nThe SEAF shall proceed with step 10 in Figure 6.1.3.2-1 and after receiving the Nausf_UEAuthentication_Authenticate Response message from the AUSF in step 12in Figure 6.1.3.2-1, proceed as described below:\n-\tIf the AUSF has indicated in the Nausf_UEAuthentication_Authenticate Response message to the SEAF that the verification of the RES* was not successful in the AUSF, or\n-\tif the verification of the RES* was not successful in the SEAF,\nthen the SEAF shall either reject the authentication by sending an Authentication Reject to the UE if the SUCI was used by the UE in the initial NAS message or the SEAF/AMF shall initiate an Identification procedure with the UE if the 5G-GUTI was used by the UE in the initial NAS message to retrieve the SUCI and an additional authentication attempt may be initiated.\nAlso, if the SEAF does not receive any Nausf_UEAuthentication_Authenticate Response  message from the AUSF as expected, then the SEAF shall either reject the authentication to the UE or initiate an Identification procedure with the UE.\nThis clause describes synchronisation failure or MAC failure in USIM.\nIn step 7 in Figure 6.1.3.2-1 when 5G AKA is used; or in step 5 in Figure 6.1.3.1-1 when EAP-AKA’ is used, at the receipt of the RAND and AUTN, if the verification of the AUTN fails, then the USIM indicates to the ME the reason for failure and in the case of a synchronisation failure passes the AUTS parameter (see TS 33.102 [9]) to the ME.\nIf 5G AKA is used: The ME shall respond with NAS message Authentication Failure with a CAUSE value indicating the reason for failure. In case of a synchronisation failure of AUTN (as described in TS 33.102 [9]), the UE also includes AUTS that was provided by the USIM. Upon receipt of an authentication failure message, the AMF/SEAF may initiate new authentication towards the UE. (see TS 24.501 [35]).\nIf EAP-AKA’ is used: The ME shall proceed as described in RFC 4187 [21] and RFC 5448 [12] for EAP-AKA’.\nUpon receiving an authentication failure message with synchronisation failure (AUTS) from the UE, the SEAF sends an Nausf_UEAuthentication_Authenticate Request message with a \"synchronisation failure indication\" to the AUSF and the AUSF sends an Nudm_UEAuthentication_Get Request message to the UDM/ARPF, together with the following parameters:\n-\tRAND sent to the UE in the preceding Authentication Request, and\n-\tAUTS received by the SEAF in the response from the UE to that request, as described in subclause 6.1.3.2.0 and 6.1.3.3.1.\nAn SEAF will not react to unsolicited \"synchronisation failure indication\" messages from the UE.\nThe SEAF does not send new authentication requests to the UE before having received the response to its Nausf_UEAuthentication_Authenticate Request message with a \"synchronisation failure indication\" from the AUSF (or before it is timed out).\nWhen the UDM/ARPF receives an Nudm_UEAuthentication_Get Request message with a \"synchronisation failure indication\" it acts as described in TS 33.102 [9], clause 6.3.5 where ARPF is mapped to HE/AuC. The UDM/ARPF sends an Nudm_UEAuthentication_Get Response message with a new authentication vector for either EAP-AKA’ or 5G-AKA depending on the authentication method applicable for the user to the AUSF. The AUSF runs a new authentication procedure with the UE according to clauses 6.1.3.1 or 6.1.3.2 depending on the authentication method applicable for the user.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.1.4\tLinking increased home control to subsequent procedures",
                            "text_content": "The 5G authentication and key agreement protocols provide increased home control. Compared to EPS AKA in EPS, this provides better security useful in preventing certain types of fraud as explained in more detail below.\nThis increased home control comes in the following forms in 5GS:\n-\tIn the case of EAP-AKA', the AUSF in the home network obtains confirmation that the UE has been successfully authenticated when the EAP-Response/AKA'-Challenge received by the AUSF has been successfully verified, cf. sub-clause 6.1.3.1 of the present document.\n-\tIn the case of 5G AKA, the AUSF in the home network obtains confirmation that the UE has been successfully authenticated when the authentication confirmation received by the AUSF in Nausf_UEAuthentication_Authenticate Request message has been successfully verified, cf. sub-clause 6.1.3.2 of the present document.\nWhen 3GPP credentials are used in above cases, the result is reported to the UDM. Details are described in clause 6.1.4.1a.\nThe feature of increased home control is useful in preventing certain types of fraud, e.g. fraudulent Nudm_UECM_Registration Request for registering the subscriber's serving AMF in UDM that are not actually present in the visited network. But an authentication protocol by itself cannot provide protection against such fraud. The authentication result needs to be linked to subsequent procedures, e.g. the Nudm_UECM_Registration procedure from the AMF in some way to achieve the desired protection.\nThe actions taken by the home network to link authentication confirmation (or the lack thereof) to subsequent procedures are subject to operator policy and are not standardized.\nBut informative guidance is given in sub-clause 6.1.4.2 as to what measures an operator could usefully take. Such guidance may help avoiding a proliferation of different solutions.\nThe feature of increased home control is also used to allow the UDM to keep track of the AUSF that stores the KAUSF to be used during e.g. the control plane solution for Steering of Roaming or UE Parameter Update procedures; i.e. the AUSF that stores the latest KAUSF generated after successful completion of the latest primary authentication reported to the UDM.\nAfter the UDM is informed that the UE has been successfully (re-)authenticated, the UDM shall store the AUSF instance which reported the successful authentication. If the UDM has been previously informed that the UE was authenticated by a different AUSF instance, the UDM may request the old AUSF to clear the stale security parameters (KAUSF, SOR counter and UE parameter update counter). If the UDM determines to delete the security parameters in the old AUSF, then the UDM shall use the Nausf_UEAuthentication_deregister service operation (see clause 14.1.5).\nThe information sent from the AUSF to the UDM that a successful or unsuccessful authentication of a subscriber has occurred, shall be used to link authentication confirmation to subsequent procedures. The AUSF shall send the Nudm_UEAuthentication_ResultConfirmation service operation for this purpose as shown in figure6.1.4.1a-1.\nThe figure depicts a diagram illustrating the process of increasing Home control to subsequent procedures, with various components such as the Home control system, the subsequent procedures, and the communication network. This diagram highlights the importance of proper communication and coordination between the Home control system and the subsequent procedures to ensure a smooth and efficient process.\nFigure 6.1.4.1a-1: Linking increased Home control to subsequent procedures\n1.\tThe AUSF shall inform UDM about the result and time of an authentication procedure with a UE using a Nudm_UEAuthentication_ResultConfirmation Request. This shall include the SUPI, a timestamp of the authentication, the authentication type (e.g. EAP method or 5G-AKA), and the serving network name.\nNOTE: \tIt may be sufficient for the purposes of fraud prevention to send only information about successful authentications, but this is up to operator policy.\n2.\tThe UDM shall store the authentication status of the UE (SUPI, authentication result, timestamp, and the serving network name).\n3.\tUDM shall reply to AUSF with a Nudm_UEAuthentication_ResultConfirmation Response.\n4.\tUpon reception of subsequent UE related procedures (e.g. Nudm_UECM_Registration_Request from AMF) UDM may apply actions according to home operator’s policy to detect and achieve protection against certain types of fraud (e.g. as proposed in clause 6.1.4.2).\nThis sub-clause gives informative guidance on how a home operator could link authentication confirmation (or the lack thereof) to subsequent Nudm_UECM_Registration procedures from AMF to achieve protection against certain types of fraud, as mentioned in the preceding sub-clause.\nApproach 1:\nThe home network records the time of the most recent successfully verified authentication confirmation of the subscriber together with the identity of the 5G visited network that was involved in the authentication. When a new Nudm_UECM_Registration Request arrives from a visited network, the home network checks whether there is a sufficiently recent authentication of the subscriber by this visited network. If not, the Nudm_UECM_Registration Request is rejected. The rejection message may include, according to the home networks policy, an indication that the visited network should send a new Nausf_UEAuthentication_Authenticate Request (cf. sub-clause 6.1.2 of the present document) for fetching a new authentication vector before repeating the Nudm_UECM_Registration Request.\nNOTE 1: \tWith this approach, the authentication procedure and the Nudm_UECM_Registration procedure are performed independently. They are coupled only through linking information in the home network.\nNOTE 2: \tIt is up to the home network to set the time threshold to define what 'sufficiently recent' is.\nApproach 2:\nAs a variant of the above Approach 1, Approach 2 is based on a more fine-grained policy applied by the home network; the home network could classify roaming partners into different categories, depending on the trust - e.g. derived from previous experience placed in them, for example as follows:\n-\tFor a visited network in the first category, the home network would require a successful authentication 'immediately preceding' the Nudm_UECM_Registration Request from an AMF.\n-\tFor a visited network in the second category, the home network would only check that an authentication in a network visited by the subscriber was sufficiently recent (taking into account that there may have been a security context transfer between the visited networks).\n-\tFor a visited network in the third category, the home network would perform no checks regarding Nudm_UECM_Registration Requests and authentication at all.\nFurther approaches are possible, depending on the home operator's policy.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.1.5\tHome network triggered primary authentication procedure",
                            "text_content": "The support of Home Network triggered authentication is optional for the HN and the SN. If both the networks (HN and SN) support Home Network triggered primary authentication, the following clauses apply.\nThe UDM may initiate primary authentication based on procedures initiated by the UE (e.g. UE registration in 5GC) or towards the UE (e.g. SoR/UPU) or events from other NFs, considering the local policy into account as well.\n\nFigure 6.1.5.2-1 Home Network triggered primary authentication procedure\nStep 0a and step 0b are the pre-requisite of the whole procedure.\n0a.\tThe UDM may be pre-configured with an operator authentication  policy in order to determine when to trigger a primary authentication procedure.\n0b.\tThe UE registers to the network. As part of the registration, the serving AMF registers the UE with the UDM via the Nudm_UECM_Registration as per TS 23.502 [8], clause 4.2.2.2.2. The AMF shall provide a callback URI within the AMF registration for the UDM to create an implicit subscription to later notify the AMF for potential home network triggered re-authentication using the Nudm_UECM_Re-AuthenticationNotification service operation as in step 2.\n1a-c.\tThe UDM decides itself based on events (e.g., SoR/UPU or NF requests such as AAnF requests as defined in TS 33.535 [91]) or authentication policy and performs home network triggered primary authentication as described in the following steps. The NF such as the AAnF considers based on operator's local authentication policy described in TS 33.535 [91] to send Nudm_UECM_AuthTrigger request to the UDM for primary authentication using the UDM services as described in clause 14.2.6. The NF may send a Nudm_UECM_AuthTrigger Request message to the UDM with the SUPI of the target UE. The UDM may acknowledge the request with an Nudm_UECM_AuthTrigger Response to the NF.\nNOTE A:\tFor the NF (e.g., AAnF) request event, the UDM can decide not to proceed with triggering the primary authentication based on the UDM’s local authentication policy. In case of AAnF being the NF, as AAnF sets the AF key expiry based on operator’s local authentication policy, no frequent AF key expiry can happen and there is no risk of signalling overload. Based on a received event and the local operator authentication policy, if there is no ongoing primary authentication for the UE, and if the UDM determines to trigger the primary authentication, the UDM determines the serving AMF/SEAF of the target UE.\nIf there are different AMFs registered in the UDM for different access,  the UDM shall select one AMF to perform the re-authentication. The criteria for selecting the AMF are dependent of the local UDM authentication policy.\nNOTE 1: \tThe reasons for the UDM determining that the UE needs to be authenticated can be different. For example, the UDM can determine to initiate a primary authentication when the AMF registers the UE upon the Registration procedure during the mobility from EPC or when SoR/UPU counters are about to wrap around, or when required based on authentication policy, or based on the request from AAnF. The UDM behaviour is determined by operator  policy which takes into account the support of certain features in the PLMN. For example, if the HPLMN does not support the SoR/UPU feature, then SoR/UPU counter wrap around will not happen, and primary authentication will not be required for this case.\n\n2. \tThe UDM sends a Nudm_UECM_Re-AuthenticationNotification message to the AMF/SEAF with the UE’s SUPI.\n3. \tAfter receiving the Nudm_UECM_Re-AuthenticationNotification  message from the UDM, the AMF/SEAF shall decide whether to run the primary authentication procedure based on its own local authentication policy, and the UE state (e.g. , if the UE is under handover, or if the UE is already under authentication by the AMF before receiving the authentication notification from the UDM). If the AMF/SEAF determines that it cannot run a primary authentication as described in step 4 (e.g., due to local policy), the AMF/SEAF sends the authentication response message to the UDM with a failure cause else it acknowledges the request. If the AMF/SEAF acknowledged the request but the AMF/SEAF is not able to initiate the primary authentication towards the UE (e.g. if UE is not reachable), the AMF/SEAF shall set the authentication pending flag. Upon receiving a failure from the AMF, the UDM may check if another AMF is available over the other access. If available, the UDM may select another AMF and retry Step 2.\nWhen UE re-attaches to the same AMF or becomes reachable, the AMF checks the authentication pending flag and performs the reauthentication if needed. Once UE reauthentication is done, the AMF resets the authentication pending flag.\nNOTE B:\tIn the case that the UE attaches to a new AMF, the new AMF will register to the UDM using the Nudm_UECM_Registration message. In this case, the UDM can determine again on whether to trigger the primary authentication as described in 1b.\n\n4. \tThe AMF/SEAF starts the primary authentication procedure as defined in clause 6.2.1 of the present document.\nThe UDM may execute other procedures (e.g. SoR/UPU) depending on the reason that motivated the UDM triggered (re-)authentication procedure in step 1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.2\tKey hierarchy, key derivation, and distribution scheme",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.2.1\tKey hierarchy",
                            "text_content": "Requirements on 5GC and NG-RAN related to keys are described in clause 5.1.3. The following describes the keys of the key hierarchy generation in a 5GS in detail.:\nThe figure depicts a hierarchical structure of key elements in a 5G system, including the network, core, and radio access network (RAN). The figure illustrates the network's structure, with the core and radio access network (RAN) depicted as separate entities. The network includes various elements such as base stations (BSs), mobile stations (MSs), and access points (APs). The figure also highlights the use of key elements like radio frequency (RF) chains, radio frequency (RF) distribution, and radio frequency (RF) backhaul. The figure provides a clear and concise representation of the 5G system's key hierarchy, making it easier to understand the network's structure and components.\nFigure 6.2.1-1: Key hierarchy generation in 5GS\n\nThe keys related to authentication (see Figure 6.2.1-1) include the following keys: K, CK/IK. In case of EAP-AKA', the keys CK', IK' are derived from CK, IK as specified in clause 6.1.3.1.\nThe key hierarchy (see Figure 6.2.1-1) includes the following keys: KAUSF, KSEAF, KAMF, KNASint, KNASenc, KN3IWF, KgNB, KRRCint, KRRCenc, KUPint and KUPenc.\nKeys for AUSF in home network:\n-\tKAUSF is a key derived\n-\tby ME and AUSF from CK', IK' in case of EAP-AKA', CK' and IK' is received by AUSF as a part of transformed AV from ARPF; or,\n-\tby ME and ARPF from CK, IK in case of 5G AKA, KAUSF is received by AUSF as a part of the 5G HE AV from ARPF.\n-\tKSEAF is an anchor key derived by ME and AUSF from KAUSF.  KSEAF is provided by AUSF to the SEAF in the serving network.\nKey for AMF in serving network:\n-\tKAMF is a key derived by ME and SEAF from KSEAF. KAMF is further derived by ME and source AMF when performing horizontal key derivation.\nKeys for NAS signalling:\n-\tKNASint is a key derived by ME and AMF from KAMF, which shall only be used for the protection of NAS signalling with a particular integrity algorithm.\n-\tKNASenc is a key derived by ME and AMF from KAMF, which shall only be used for the protection of NAS signalling with a particular encryption algorithm.\nKey for NG-RAN:\n-\tKgNB is a key derived by ME and AMF from KAMF. KgNB is further derived by ME and source gNB when performing horizontal or vertical key derivation. The KgNB is used as KeNB between ME and ng-eNB.\nKeys for UP traffic:\n-\tKUPenc is a key derived by ME and gNB from KgNB, which shall only be used for the protection of UP traffic with a particular encryption algorithm.\n-\tKUPint is a key derived by ME and gNB from KgNB, which shall only be used for the protection of UP traffic between ME and gNB with a particular integrity algorithm.\nKeys for RRC signalling:\n-\tKRRCint is a key derived by ME and gNB from KgNB, which shall only be used for the protection of RRC signalling with a particular integrity algorithm.\n-\tKRRCenc is a key derived by ME and gNB from KgNB, which shall only be used for the protection of RRC signalling with a particular encryption algorithm.\nIntermediate keys:\n-\tNH is a key derived by ME and AMF to provide forward security as described in Clause A.10.\n-\tKNG-RAN * is a key derived by ME and NG-RAN (i.e., gNB or ng-eNB) when performing a horizontal or vertical key derivation as specified in Clause 6.9. 2.1.1 using a KDF as specified in Clause A.11/A.12.\n-  KAMF' is a key that can be derived by ME and AMF when the UE moves from one AMF to another during inter-AMF mobility as specified in Clause 6.9.3 using a KDF as specified in Annex A.13.\nKey for the non-3GPP access:\n-\tKN3IWF is a key derived by ME and AMF from KAMF for the non-3GPP access. KN3IWF is not forwarded between N3IWFs.\nNOTE 1: The key hierarchy for standalone non-public networks when an authentication method other than 5G AKA or EAP-AKA' is used is given in Annex I.2.3.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.2.2\tKey derivation and distribution scheme",
                            "text_content": "Keys in the ARPF\nThe ARPF shall process the long-term key K and any other sensitive data only in its secure environment. The key K shall be 128 bits or 256 bits long.\nDuring an authentication and key agreement procedure, the ARPF shall derive CK' and IK' from K in case EAP-AKA' is used and derive KAUSF from K in case 5G AKA is used. The ARPF shall forward the derived keys to the AUSF.\nThe ARPF holds the Home Network Private Key that is used by the SIDF to deconceal the SUCI and reconstruct the SUPI. The generation and storage of this key material is out of scope of the present document.\nKeys in the AUSF\nIn case EAP-AKA' is used as authentication method, the AUSF shall derive a key KAUSF from CK' and IK' for EAP-AKA' as specified in clause 6.1.3.1. In case that 5G AKA is used as authentication method, the UDM/ARPF shall generate the KAUSF as specified in clause 6.1.3.2.\nThe KAUSF may be stored in the AUSF between two subsequent authentication and key agreement procedures.\nWhen the AUSF stores the KAUSF, the AUSF shall store the latest KAUSF generated after successful completion of the latest primary authentication. The authentication is considered as successful and the AUSF shall store the latest KAUSF or replace the old KAUSF with the new KAUSF (if the AMF(s) end up selecting the same AUSF instance for (re)authentication of the UE):\n- in case 5G AKA is used as authentication method, when the RES* and the XRES* are equal (see clause 6.1.3.2.0, Step 11).\n- in case EAP-AKA' is used as authentication method, when the AUSF sends an EAP-Success message to the SEAF (see clause 6.1.3.1, Step 10).\nThe AUSF shall generate the anchor key, also called KSEAF, from the authentication key material received from the ARPF during an authentication and key agreement procedure.\nKeys in the SEAF\nThe SEAF receives the anchor key, KSEAF, from the AUSF upon a successful primary authentication procedure in each serving network.\nThe SEAF shall never transfer KSEAF to an entity outside the SEAF. Once KAMF is derived KSEAF shall be deleted.\nThe SEAF shall generate KAMF from KSEAF immediately following the authentication and key agreement procedure and hands it to the AMF.\nNOTE 1: \tThis implies that a new KAMF, along with a new KSEAF, is generated for each run of the authentication and key agreement procedure.\nNOTE 2: \tThe SEAF is co-located with the AMF.\nKeys in the AMF\nThe AMF receives KAMF from the SEAF or from another AMF.\nThe AMF shall, based on policy, derive a key KAMF' from KAMF for transfer to another AMF in inter-AMF mobility. The receiving AMF shall use K'AMF as its key KAMF.\nNOTE 3: The precise rules for key handling in inter-AMF mobility can be found in clause 6.9.3.\nThe AMF shall generate keys KNASint and KNASenc dedicated to protecting the NAS layer.\nThe AMF shall generate access network specific keys from KAMF. In particular,\n-\tthe AMF shall generate KgNB and transfer it to the gNB.\n-\tthe AMF shall generate NH and transfer it to the gNB, together with the corresponding NCC value. \nThe AMF may also transfer an NH key, together with the corresponding NCC value, to another AMF, cf. clause 6.9.\n-\tthe AMF shall generate KN3IWF and transfer it to the N3IWF when KAMF is received from SEAF, or when KAMF' is received from another AMF.\nKeys in the NG-RAN\nThe NG-RAN (i.e., gNB or ng-eNB) receives KgNB and NH from the AMF. The ng-eNB uses KgNB as KeNB.\nThe NG-RAN (i.e., gNB or ng-eNB) shall generate all further access stratum (AS) keys from KgNB and /or NH.\nKeys in the N3IWF\nThe N3IWF receives KN3IWF from the AMF.\nThe N3IWF shall use KN3IWF as the key MSK for IKEv2 between UE and N3IWF in the procedures for untrusted non-3GPP access, cf. clause 11.\nFigure 6.2.2-1 shows the dependencies between the different keys, and how they are derived from the network nodes point of view.\nThe figure depicts a key distribution and key derivation scheme for 5G network nodes, illustrating the key distribution process, which involves the distribution of keys to network nodes, and the key derivation process, which involves the derivation of keys from the distribution of keys. This scheme is crucial for ensuring secure communication in 5G networks.\nFigure 6.2.2-1: Key distribution and key derivation scheme for 5G for network nodes\nNOTE 4: The key derivation and distribution scheme for standalone non-public networks, when an authentication method other than 5G AKA or EAP-AKA' is used, is given in Annex I.2.3.\nFor every key in a network entity, there is a corresponding key in the UE.\nFigure 6.2.2-2 shows the corresponding relations and derivations as performed in the UE.\nThe figure depicts a key distribution and key derivation scheme for 5G for the UE, illustrating the key distribution process where the key is generated by the UE and then distributed to the network. The key derivation scheme involves the use of a key distribution network (KDN) to distribute the key to the network.\nFigure 6.2.2-2: Key distribution and key derivation scheme for 5G for the UE\nKeys in the USIM\nThe USIM shall store the same long-term key K that is stored in the ARPF.\nDuring an authentication and key agreement procedure, the USIM shall generate key material from K that it forwards to the ME.\nIf provisioned by the home operator, the USIM shall store the Home Network Public Key used for concealing the SUPI.\nKeys in the ME\nThe ME shall generate the KAUSF from the CK, IK received from the USIM. The generation of this key material is specific to the authentication method and is specified in clause 6.1.3.\nWhen 5G AKA is used, the generation of RES* from RES shall be performed by the ME.\nThe UE shall store the latest KAUSF or replace the old KAUSF with the latest KAUSF, after successful completion of the latest primary authentication . If the USIM supports 5G parameters storage, KAUSF shall be stored in the USIM. Otherwise, KAUSF shall be stored in the non-volatile memory of the ME.\nIn case 5G AKA is used as an authentication method, upon receiving the valid NAS Security Mode Command message from the AMF (to take the corresponding partial context derived from the newly generated KAUSF into use), the UE shall consider the performed primary authentication as successful and the UE shall store the newly generated KAUSF as the latest KAUSF or replace the old KAUSF with the latest KAUSF.\nIn case of any key generating EAP method in the present document (EAP-AKA'', EAP-TLS in Annex B, EAP methods in Annex I) is used as the authentication method for the primary (re)authentication, upon receiving the EAP-Success message, the primary authentication shall be considered as successful and the UE shall store the newly generated KAUSF as the latest KAUSF or replace the old KAUSF with the latest KAUSF.\nThe ME shall perform the generation of KSEAF from the KAUSF. If the USIM supports 5G parameters storage, KSEAF shall be stored in the USIM. Otherwise, KSEAF shall be stored in the non-volatile memory of the ME.\nThe ME shall perform the generation of KAMF. If the USIM supports 5G parameters storage, KAMF shall be stored in the USIM. Otherwise, KAMF shall be stored in the non-volatile memory of the ME.\nThe ME shall perform the generation of all other subsequent keys that are derived from the KAMF.\nAny 5G security context, KAUSF and KSEAF that are stored at the ME shall be deleted from the ME if:\na)\tthe USIM is removed from the ME when the ME is in power on state;\nb)\tthe ME is powered up and the ME discovers that the USIM is different from the one which was used to create the 5G security context;\nc)\tthe ME is powered up and the ME discovers that there is no USIM is present at the ME.\nWhen the ME is powered up and the USIM supports the 5G parameters storage but does not support the 5G parameters extended storage, and the USIM has a stored KAUSF, then the UE may delete the KAUSF and associated 5G security context that are stored at the USIM and set the KSI value of ngKSI to '111'.\nNOTE A: The above handling can be used to prevent a stored CounterSoR and CounterUPU being associated with the wrong KAUSF. Further criteria for deleting the security information are left to the ME implementation.\nNOTE 1: The key derivation and distribution scheme for standalone non-public networks, when an authentication method other than 5G AKA or EAP-AKA' is used, is given in Annex I.2.3.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.2.3\tHandling of user-related keys",
                            "text_content": "Key setting happens at the end of successful authentication procedure. Authentication and key setting may be initiated by the network as often as the network operator wishes when an active NAS connection exists. Key setting can occur as soon as the identity of the mobile subscriber (i.e. 5G-GUTI or SUPI) is known by the AMF. A successful run of 5G AKA or EAP AKA' results in a new KAMF that is stored in the UE and the AMF with a new partial, non-current security context.\nNAS keys (i.e. KNASint and KNASenc) and AS keys (i.e. KgNB, KRRCenc, KRRCint, KUPenc, KUPint) are derived from KAMF using the KDFs specified in Annex A. The NAS keys derived from the new KAMF are taken in use in the AMF and the UE by means of the NAS security mode command procedure (see sub-clause 6.7.2). The AS keys are taken into use with the AS security mode command procedure (see sub-clause 6.7.4) or with the key change on the fly procedure (see sub-clause 6.9.6).\nFor the non-3GPP access, the key KN3IWF is derived from the KAMF. KN3IWF is stored in the UE and the N3IWF as specified in subclause 7.2.1. This key KN3IWF and the IPsec SA cryptographic keys are taken into use with the establishment of IPsec Security Association (SA) between the UE and the N3IWF.\nNOTE:\tFor mapped security contexts, the KAMF is derived from EPS keys during interworking with EPS (see clause 8).\nThe key KAMF shall be identified by the key set identifier ngKSI. ngKSI may be either of type native or of type mapped. An ngKSI shall be stored in the UE and the AMF together with KAMF and the temporary identifier 5G-GUTI, if available.\nNOTE 1:\tThe 5G-GUTI points to the AMF where the KAMF is stored.\nA native ngKSI is associated with the KSEAF and KAMF derived during primary authentication. It is allocated by the SEAF and sent with the authentication request message to the UE where it is stored together with the KAMF. The purpose of the ngKSI is to make it possible for the UE and the AMF to identify a native security context without invoking the authentication procedure. This is used to allow re-use of the native security context during subsequent connection set-ups.\nA mapped ngKSI is associated with the KAMF derived from EPS keys during interworking, cf. clause 8 of the present document. It is generated in both the UE and the AMF respectively when deriving the mapped KAMF when moving from EPS to 5GS. The mapped ngKSI is stored together with the mapped KAMF.\nThe purpose of the mapped ngKSI is to make it possible for the UE and the AMF to indicate the use of the mapped KAMF in interworking procedures (for details cf. clause 8).\nThe format of ngKSI shall allow a recipient of such a parameter to distinguish whether the parameter is of type native or of type mapped. The format shall contain a type field and a value field. The type field indicates the type of the key set. The value field consists of three bits where seven values, excluding the value '111', are used to identify the key set. The value '111' is reserved to be used by the UE to indicate that a valid KAMF is not available for use. The format of ngKSI is described in [35]\nKNASenc and KNASint in the key hierarchy specified in clause 6.2.1, which are derived from KAMF, can be uniquely identified by ngKSI together with those parameters from the set {algorithm distinguisher, algorithm identifier}, which are used to derive these keys from KAMF.\nThe KN3IWF can be uniquely determined by ngKSI together with the uplink NAS COUNT are used to derive it according to clause A.9.\nThe initial KgNB can be uniquely determined by ngKSI, together with the uplink NAS COUNT are used to derive it according to clause A.9.\nThe intermediate key NH as defined in clause 6.9.2.1.1 can be uniquely determined by ngKSI, together with the initial KgNB derived from the current 5G NAS security context for use during the ongoing CM-CONNECTED state and a counter counting how many NH-derivations have already been performed from this initial KgNB according to clause A.10. The next hop chaining counter, NCC, represents the 3 least significant bits of this counter.\nIntermediate key KNG-RAN*, as well as non-initial KgNB, defined in clause 6.9.2.1.1 can be uniquely identified by ngKSI together with those parameters from the set {KgNB or NH, sequence of PCIs and ARFCN-DLs}, which are used to derive these keys from KgNB or NH.\nKRRCint, KRRCenc, KUPint, and KUPenc in the key hierarchy specified in clause 6.2.1 can be uniquely identified by ngKSI together with those parameters from the set {algorithm distinguisher, algorithm identifier}, which are used to derive these keys from KgNB.\nNOTE 2:\tIn addition to 5G security contexts, the UE may also cache EPS security contexts. These EPS security contexts are identified by the eKSI, as defined in TS 33.401 [10].\nKAUSF, and KSEAF shall be created when running a successful primary authentication as described in clause 6.1.3.\nKAMF shall be created in the following cases:\n1.\tPrimary authentication\n2.\tNAS key re-keying as described in clause 6.9.4.2\n3.\tNAS key refresh as described in clause 6.9.4.3\n4.\tInterworking procedures with EPS (cf. clauses 8 and 10)\nIn case the UE does not have a valid KAMF, an ngKSI with value \"111\" shall be sent by the UE to the network, which can initiate (re)authentication procedure to get a new KAMF based on a successful primary authentication.\nKNASint and KNASenc are derived based on a KAMF when running a successful NAS SMC procedure as described in clause 6.7.2.\nKN3IWF is derived from KAMF and remains valid as long as the UE is connected to the 5GC over non- 3gpp access or until the UE is reauthenticated.\nKgNB and NH are derived based on KAMF or KgNB or NH in the following cases:\n1.\tInter-gNB-CU-handover as described in clause 6.9.2.3.1\n2.\tState transitions as described in clause 6.8\n3.\tAS key re-keying as described in clause 6.9.4.4\n4.\tAS key refresh as described in clause 6.9.4.5\nThe KRRCint, KRRCenc, KUPint and KUPenc are derived based on KgNB after a new KgNB is derived.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.3\tSecurity contexts",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.3.1\tDistribution of security contexts",
                            "text_content": "The present clause focuses on the security contexts themselves; the handling of security contexts in mobility procedures is described in  clause 6.9.\nThe transmission of the following subscriber identities and security data is permitted between 5G core network entities of the same serving network domain:\n-\tSUPI in the clear\n-\t5G security contexts, as described in clause 6.9\nA 5G authentication vector shall not be transmitted between SEAFs.\nOnce the subscriber identities and security data have been transmitted from an old to a new network entity the old network entity shall delete the data.\nThe transmission of the following subscriber identities and security data is permitted between 5G core network entities of different serving network domains:\n-\tSUPI in the clear\n-\t5G security contexts, as described in clause 6.9, if the security policy of the transmitting 5G serving network domain allows this.\nA 5G authentication vector or non-current 5G security contexts shall not be transmitted to a different 5G serving network domain.\nNOTE 1: \tNo direct interworking between 5G networks and network of generations prior to EPS are foreseen. Therefore, only the interaction between 5G and EPS serving network domains is addressed here.\nThe transmission of the SUPI in the clear is permitted between 5G and EPS core network entities if it has the form of an IMSI.\nThe transmission of any unmodified 5G security contexts to a EPS core network entity is not permitted. Details of security context transfer between EPS and 5G core network entities can be found in clause 8.\nThe transmission of a 5G authentication vector to an EPS core network entity is not permitted. The transmission of any unused EPS authentication vectors to a 5G core network entity is not permitted. If SEAF receives any unused authentication vectors (e.g. in mobility scenarios from legacy MME) they shall be dropped without any processing.\nNOTE 2: \tThe rules above differ from the corresponding rules in 3GPP TS 33.401, clause 6.1.6: The latter allows forwarding of UMTS authentication vectors from an SGSN to an MME and back to the same SGSN under certain conditions. But this feature goes against a strict security separation of EPS and 5G domains. As its performance advantage is questionable it was not copied into 5G.\nNOTE 3: \tSecurity context mapping between EPS and 5G serving networks is allowed, according to clause 8.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.3.2\tMultiple registrations in same or different serving networks",
                            "text_content": "There are two cases where the UE can be multiple registered in different PLMN's serving networks or in the same PLMN's serving networks. The first case is when the UE is registered in one PLMN serving network over a certain type of access (e.g. 3GPP) and is registered to another PLMN serving network over the other type of access (e.g. non-3GPP). The second case is where the UE is registered in the same AMF in the same PLMN serving network over both 3GPP and non-3GPP accesses. The UE will establish two NAS connections with the network in both cases.\nNOTE: \tThe UE uses the same subscription credential(s) for multiple registrations in the same or different serving networks.\nThe UE shall independently maintain and use two different 5G security contexts, one per PLMN's serving network. Each security context shall be established separately via a successful primary authentication procedure with the Home PLMN.\nThe ME shall store the two different 5G security contexts on the USIM if the USIM supports the 5G parameters storage. If the USIM does not support the 5G parameters storage, then the ME shall store the two different 5G security contexts in the ME non-volatile memory. Both of the two different 5G security contexts are current 5G security context.\nThe latest KAUSF result of the successful completion of the latest primary authentication shall be used by the UE and the HN regardless over which access network type (3GPP or non-3GPP) it was generated.\nThe HN shall keep the latest KAUSF generated during successful authentication over a given access even if the UE is deregistered from that access, but the UE is registered via another access.\nWhen the UE is registered in the same AMF in the same PLMN serving network over both 3GPP and non-3GPP accesses, the UE shall establish two NAS connections with the network. Upon receiving the registration request message, the AMF should check whether the UE is authenticated by the network. The AMF may decide to skip a new authentication run in case there is an available 5G security context for this UE by means of 5G-GUTI, e.g. when the UE successfully registered to 3GPP access.\nIf the UE registers to the same AMF via non-3GPP access, the AMF can decide not to run a new authentication if it has an available security context to use. In this case, the UE shall directly take into use the available common 5G NAS security context and use it to protect the registration over the non-3GPP access. If there are stored NAS counts for the non-3GPP access for the PLMN in the UE, then the stored NAS counts for the non-3GPP access for the PLMN shall be used to protect the registration over the non-3GPP access. Otherwise, the common 5G NAS security context is taken into use for the first time (partial) over non-3GPP access. In this case, the UL NAS COUNT value and DL NAS COUNT value for the non-3GPP access needs to be set to zero by the UE before the UE is taking the 5G NAS security context into use over non 3GPP access.\nThe AMF and the UE shall establish a common NAS security context consisting of a single set of NAS keys and algorithm at the time of first registration over any access. The AMF and the UE shall also store parameters specific to each NAS connection in the common NAS security context including two pairs of NAS COUNTs for each access (i.e. 3GPP access and non-3GPP access). The connection specific parameters are specified in clause 6.4.2.2 of the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.4\tNAS security mechanisms",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.4.1\tGeneral",
                            "text_content": "This sub-clause describes the security mechanisms for the protection of NAS signalling and data between the UE and the AMF over the N1 reference point. This protection involves both integrity and confidentiality protection. The security parameters for NAS protection are part of the 5G security context described in sub-clause 6.3 of the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.2\tSecurity for multiple NAS connections",
                            "text_content": "TS 23.501 [2] has a scenario when the UE is registered to a VPLMN's serving network via 3GPP access and to another VPLMN's or HPLMN's serving network via non-3GPP access at the same time. When the UE is registered in one PLMN's serving network over a certain type of access (e.g. 3GPP) and is registered to another PLMN's serving network over another type of access (e.g. non-3GPP), then the UE has two active NAS connections with different AMF's in different PLMNs. As described in clause 6.3.2.1, the UE shall independently maintain and use two different 5G security contexts, one per PLMN serving network. The 5G security context maintained by the UE shall contain the full set of 5G parameters, including NAS context parameters for 3GPP and non-3GPP access types per PLMN. In case of connection to two different PLMNs, it is necessary to maintain a complete 5G NAS security context for each PLMN independently, each with all associated parameters (such as two pairs of NAS COUNTs, i.e. one pair for 3GPP access and one pair for non-3GPP access).\nEach security context shall be established separately via a successful primary authentication procedure with the Home PLMN.\nAll the NAS and AS security mechanisms defined for single registration mode are applicable independently on each access using the corresponding 5G security context.\nNOTE: \tThe UE belongs to a single HPLMN.\nWhen the UE is registered in a serving network over two types of access (e.g. 3GPP and non-3GPP), then the UE has two active NAS connections with the same AMF. A common 5G NAS security context is created during the registration procedure over the first access type.\nIn order to realize cryptographic separation and replay protection, the common NAS security-context shall have parameters specific to each NAS connection. The connection specific parameters include a pair of NAS COUNTs for uplink and downlink and unique NAS connection identifier. The value of the unique NAS connection identifier shall be set to \"0x01\" for 3GPP access and set to \"0x02\" for non-3GPP access. All other parameters as e.g. algorithm identifiers in the common NAS security context are common to multiple NAS connections.\nIn non-mobility cases, when the UE is simultaneously registered over both types of accesses, and if NAS key re-keying as described in clause 6.9.4.2 or if NAS key refresh as described in clause 6.9.4.3 takes place over one of the accesses (say access A):\n1)\tIf the other access (access B) is in CM-CONNECTED state, then the new NAS security context shall only be activated over that access (access A). The UE and the AMF shall not change the NAS security context in use on the other access (say access B). In order to activate the new NAS security context over the other access (access B), the AMF shall trigger a NAS SMC run over that access either in the current running procedure or a subsequent NAS procedure. During the second NAS SMC run (on access B), the AMF shall include the same ngKSI associated with the new NAS security context and the same algorithm choices as for the first access. After a successful second NAS SMC procedure over the other access (access B), both the UE and the AMF shall delete the old NAS security context.\n2)\tWhenever the AMF sends a NAS SMC over access (access A) and AMF considers the UE to not be in CM-CONNECTED state on the other access (access B), the AMF shall additionally activate (if not already in use on the other access) the security context that is active on the other accesses. Similarly, whenever the UE receives a NAS SMC over the access (access A) and UE is not in CM-CONNECTED state on the other access (access B), the UE additionally activates (if not already in use on the other access) the security context  on  the other access.\nIn case of 3GPP access mobility or interworking with EPS, the following procedures apply:\n1)\tIf the UE is in CM-CONNECTED state on the non-3GPP access, then:\na)\tif the AMF does not have the security context the UE is using on the non-3GPP access (e.g. KAMF change on 3GPP access when the AMF changes), then in order to activate the same NAS security context that is in use over the 3GPP access the AMF shall run a NAS SMC procedure on the non-3GPP access; or\nb)\tin the case of handover from EPS, then a mapped context will be in use on the 3GPP access and a different security context will be active on the non-3GPP access. To align the security contexts in use over both accesses, the AMF shall run a NAS SMC procedure over one access to take into use on that access the security context that is in use on the other access. In the case that a native security context is in use on the non-3GPP access, then the NAS SMC procedure shall be on the 3GPP access to take the native security context into use.\n2)\tWhenever the AMF sends a Registration Accept over the 3GPP access and AMF considers the UE to not be in CM-CONNECTED state on the non-3GPP access, the AMF shall activate (if not already in use on the non-3GPP access) the security context that is in use on the 3GPP access on the non-3GPP access. The AMF shall keep a native security context that was in use on non-3GPP access if the security context in use on the 3GPP access is a mapped security context. In order to take this native security context into use, the AMF shall run a NAS SMC procedure.\nSimilarly, whenever the UE receives a Registration Accept over the 3GPP access and UE is not in CM-CONNECTED state on the non-3GPP access, the UE activates (if not already in use on the non-3GPP access) the security context that is in use on the 3GPP access on the non-3GPP access. The UE shall keep a native security context that was in use on non-3GPP access if the security context in use on the 3GPP access is a mapped security context.\nTo recover from a failure to align the NAS security contexts due to a state  mis-match between AMF and UE, the AMF can align the security contexts in use on the 3GPP and non-3GPP access using the a NAS SMC procedure during a subsequent registration procedure (that was either initiated by the UE or sent in response to a Service Reject if the UE sends a Service Request).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.3\tNAS integrity mechanisms",
                            "text_content": "Integrity protection for NAS signalling messages shall be provided as part of the NAS protocol.\nThe input parameters to the NAS 128-bit integrity algorithms as described in Annex D shall be set as follows.\nThe KEY input shall be equal to the KNASint key.\nThe BEARER input shall be equal to the NAS connection identifier.\nThe DIRECTION bit shall be set to 0 for uplink and 1 for downlink.\nThe COUNT input shall be constructed as follows:\nCOUNT :=  0x00 || NAS COUNT\nWhere NAS COUNT is the 24-bit NAS UL COUNT or the 24-bit NAS DL COUNT value, depending on the direction, that is associated to the current NAS connection identified by the value used to form the BEARER input.\nA NAS COUNT shall be constructed as follows:\nNAS COUNT :=  NAS OVERFLOW || NAS SQN\nWhere\n-\tNAS OVERFLOW is a 16-bit value which is incremented each time the NAS SQN is incremented from the maximum value.\n-\tNAS SQN is the 8-bit sequence number carried within each NAS message.\nThe use and mode of operation of the 128-bit integrity algorithms are specified in Annex D.\nNAS integrity shall be activated using the NAS SMC procedure or after an inter-system handover from EPC.\nReplay protection shall be activated when integrity protection is activated, except when the NULL integrity protection algorithm is selected. Replay protection shall ensure that the receiver only accepts each incoming NAS COUNT value once using the same NAS security context.\nOnce NAS integrity has been activated, NAS messages without integrity protection shall not be accepted by the UE or the AMF. Before NAS integrity has been activated, NAS messages without integrity protection shall only be accepted by the UE or the AMF in certain cases where it is not possible to apply integrity protection.\nNAS integrity shall stay activated until the 5G security context is deleted in either the UE or the AMF. It shall not be possible to change from non-NULL integrity protection algorithm to NULL integrity protection.\nThe supervision of failed NAS integrity checks shall be performed both in the ME and the AMF. In case of failed integrity check (i.e. faulty or missing NAS-MAC) is detected after the start of NAS integrity protection, the concerned message shall be discarded except for some NAS messages specified in TS 24.501 [35]. For those exceptions the AMF shall take the actions specified in TS 24.501 [35] when receiving a NAS message with faulty or missing NAS-MAC. Discarding NAS messages can happen on the AMF side or on the ME side.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.4\tNAS confidentiality mechanisms",
                            "text_content": "Confidentiality protection for NAS signalling messages shall be provided as part of the NAS protocol.\nThe input parameters for the NAS 128-bit ciphering algorithms shall be the same as the ones used for NAS integrity protection as described in clause 6.4.3, with the exception that a different key, KNASenc, is used as KEY, and there is an additional input parameter, namely the length of the key stream to be generated by the encryption algorithms.\nThe use and mode of operation of the 128-bit ciphering algorithms are specified in Annex D.\nNOTE:\tIn the context of the present subclause 6.4.4, a message is considered ciphered also when the NULL encryption algorithm NEA0 is applied.\nNAS confidentiality shall be activated using the NAS SMC procedure or after an inter-system handover from EPC.\nOnce NAS confidentiality has been activated, NAS messages without confidentiality protection shall not be accepted by the UE or the AMF. Before NAS confidentiality has been activated, NAS messages without confidentiality protection shall only be accepted by the UE or the AMF in certain cases where it is not possible to apply confidentiality protection.\nNAS confidentiality shall stay activated until the 5G security context is deleted in either the UE or the AMF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.5\tHandling of NAS COUNTs",
                            "text_content": "The NAS security context created at the registration time of the first access type contains the NAS integrity and encryption keys, selected algorithm common for all NAS connections. In addition, each NAS connection shall have a unique NAS connection identifier, a distinct pair of NAS COUNTs, one NAS COUNT for uplink and one NAS COUNT for downlink, associated with it. In the NAS security context, the NAS connection identifier shall be the differentiator for the connection-specific parameters.\nIt is essential that the NAS COUNTs for a particular KAMF are not reset to the start values (that is the NAS COUNTs only have their start value when a new KAMF is generated). This prevents the security issue of using the same NAS COUNTs with the same NAS keys, e.g. key stream re-use, in the case a UE moves back and forth between two AMFs and the same NAS keys are re-derived.\nIn the AMF, all the distinct pairs of NAS COUNTs part of the same 5G NAS security context, shall only be set to the start value in the following cases:\n-\tfor a partial native 5GC NAS security context created by a successful primary authentication run on one of the NAS connections established between the same AMF and the UE, or,\n-\tfor a mapped 5G security context generated when a UE moves from an MME to the AMF during both idle and connected mode mobility, or,\n-\tfor a new KAMF taken into use in a target AMF during mobility registration update or handover.\nThe start value of NAS COUNT shall be zero (0).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.6\tProtection of initial NAS message",
                            "text_content": "The initial NAS message is the first NAS message that is sent after the UE transitions from the idle state. The UE shall send a limited set of IEs (called the cleartext IEs) including those needed to establish security in the initial message when it has no NAS security context. When the UE has a NAS security context, the UE shall send a message that has the complete initial NAS message ciphered in a NAS Container along with the cleartext IEs with whole message integrity protected. The complete initial message is included in the NAS Security Mode Complete message in a NAS Container when needed (e.g. AMF cannot find the used security context) in the latter case and always in the former case as described below.\nIn case, the UE selects a PLMN other than Registered PLMN/EPLMN in the 5GMM-IDLE state and the UE has a NAS security context containing the NEA0, then the UE shall discard the NAS security context and shall follow the procedure specified in this clause for protection of initial NAS message.\nThe protection of the initial NAS message proceeds as shown in Figure 6.4.6-1.\nThe figure depicts a protective mechanism for the initial NAS message in a network, illustrating the use of a 4-6-1 network topology. The figure shows a 4-node network with a 6-node network in the middle, and a 1-node network at the end. The 4-6-1 topology is designed to protect the initial NAS message by ensuring that the message is not lost or intercepted during transmission. The figure also shows the use of a 4-node network as a relay node to forward the message to the 6-node network, and the 1-node network as a backup node to ensure the message is not lost in case of a failure.\nFigure 6.4.6-1: Protecting the initial NAS message\nStep 1: The UE shall send the initial NAS message to the AMF. If the UE has no NAS security context, the initial NAS message shall only contain the cleartext IEs, i.e. subscription identifiers (e.g. SUCI or GUTIs), UE security capabilities, ngKSI,  indication that the UE is moving from EPC, Additional GUTI, and IE containing the TAU Request in the case idle mobility from LTE.\nIf the UE has a NAS security context, the message sent shall contain the information given above in cleartext and the complete initial NAS message ciphered in a NAS container which is ciphered. With a NAS security context, the sent message shall also be integrity protected. In the case that the initial NAS message was protected and  the AMF has the same security context, then steps 2 to 4 may be omitted In this case the AMF shall use the complete initial NAS message that is in the NAS container as the message to respond to..\nStep 2: If the AMF is not able to find the security context locally or from last visited AMF, or if the integrity check fails, then the AMF shall initiate an authentication procedure with the UE. If the AMF fetches old security context from the last visited AMF, the AMF may decipher the NAS container with the same security context, and get the initial NAS message, then the step 2b to 4 may be omitted. If the AMF fetches new K AMF from the last visited AMF (receiving keyAmfChangeInd), the step 2b may be omitted.\nStep 3: If the authentication of the UE is successful, the AMF shall send the NAS Security Mode Command message. If the initial NAS message was protected but did not pass the integrity check (due either to a MAC failure or the AMF not being able to find the used security context) or the AMF could not decrypt the complete initial NAS message in the NAS container (due to receiving \"keyAmfChangeInd\" from the last visited AMF), then the AMF shall include in the Security Mode Command message a flag requesting the UE to send the complete initial NAS message in the NAS Security Mode Complete message.\nStep 4: The UE shall send the NAS Security Mode Complete message to the network in response to a NAS Security Mode Command message. The NAS Security Mode Complete message shall be ciphered and integrity protected. Furthermore the NAS Security Mode Complete message shall include the complete initial NAS message in a NAS Container if either requested by the AMF or the UE sent the initial NAS message unprotected. The AMF shall use the complete initial NAS message that is in the NAS container as the message to respond to.\nStep 5: The AMF shall send its response to the Initial NAS message. This message shall be ciphered and integrity protected.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.4.7\tSecurity aspects of SMS over NAS",
                            "text_content": "Specific services of SMS over NAS are defined in TS 23.501 [2], and procedures for SMS over NAS are specified in TS 23.502 [8].\nFor registration and de-registration procedures for SMS over NAS, the details are specified in subclause 4.13.3.1 and 4.13.3.2 in TS 23.502 [8]. The NAS message can be protected by NAS security mechanisms.\nFor MO/MT SMS over NAS via 3GPP/non-3GPP when the UE has already activated NAS security with the AMF before sending/receiving SMS, the NAS Transport message shall be ciphered and integrity protected using the NAS security context by the UE/AMF as described in sub-clause 6.4 in the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.5\tRRC security mechanisms",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.5.1\tRRC integrity mechanisms",
                            "text_content": "RRC integrity protection shall be provided by the PDCP layer between UE and gNB and no layers below PDCP shall be integrity protected. Replay protection shall be activated when integrity protection is activated (except for when the selected integrity protection algorithm is NIA0, see Annex D). Replay protection shall ensure that the receiver accepts each particular incoming PDCP COUNT value only once using the same AS security context.\nThe use and mode of operation of the 128-NIA algorithms are specified in Annex D.\nThe input parameters to the 128-bit NIA algorithms as described in Annex D are the RRC message as MESSAGE, an 128-bit integrity key KRRCint as KEY, a 5-bit bearer identity BEARER which value is assigned as specified by TS 38.323 [23], the 1-bit direction of transmission DIRECTION and a bearer specific direction dependent 32-bit input COUNT which corresponds to the 32-bit PDCP COUNT.\nThe RRC integrity checks shall be performed both in the ME and the gNB. In case failed integrity check (i.e. faulty or missing MAC-I) is detected after the start of integrity protection, the concerned message shall be discarded. This can happen on the gNB side or on the ME side. UE may trigger a recovery procedure as specified in TS 38.331 [22].\nNOTE: Failed integrity check does not always imply that the concerned message is silently discarded.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.5.2\tRRC confidentiality mechanisms",
                            "text_content": "RRC confidentiality protection is provided by the PDCP layer between UE and gNB.\nThe use and mode of operation of the 128-NEA algorithms are specified in Annex D.\nThe input parameters to the 128-bit NEA algorithms as described in Annex D are a 128-bit cipher Key KRRCenc as KEY, a 5-bit bearer identity BEARER which corresponds to the radio bearer identity, the 1-bit direction of transmission DIRECTION, the length of the keystream required LENGTH and a bearer specific direction dependent 32-bit input COUNT which corresponds to the 32-bit PDCP COUNT.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.5.3\tRRC UE capability transfer procedure",
                            "text_content": "The network should activate AS security (i.e., perform a successful AS SMC procedure) before running the RRC UE capability transfer procedure.\nWith the exception of unauthenticated emergency calls and the UEs using Control plane CIoT optimization,, if the network had acquired UE capabilities using RRC UE capability transfer procedure before AS security activation, then the network shall not store them locally for later use and shall not send them to other network entities. In that case, the network shall re-run the RRC UE capability transfer procedure after a successful AS SMC procedure.\nNOTE 1:\tFor UEs without AS security (e.g., UEs using Control Plane CIoT optimization), RRC UE radio capability transfer procedure cannot be protected.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.6\tUP security mechanisms",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.6.1\tUP security policy",
                            "text_content": "The SMF shall provide UP security policy for a PDU session to the ng-eNB/gNB during the PDU session establishment procedure as specified in TS 23.502 [8].\nThe UP security policy shall indicate whether UP confidentiality and/or UP integrity protection shall be activated or not for all DRBs belonging to that PDU session. The UP security policy shall be used to activate UP confidentiality and/or UP integrity for all DRBs belonging to the PDU session.\nThe ng-eNB/gNB shall activate UP confidentiality and/or UP integrity protection per each DRB, according to the received UP security policy, using RRC signalling as defined in clause 6.6.2. If the user plane security policy indicates \"Required\" or \"Not needed\", the ng-eNB/gNB shall not overrule the UP security policy provided by the SMF. If the ng-eNB/gNB cannot activate UP confidentiality and/or UP integrity protection when the received UP security policy is \"Required\", the ng-eNB/gNB shall reject establishment of UP resources for the PDU Session and indicate reject-cause to the SMF. If the received UP security policy is \"Not needed \", then the establishment of the PDU Session shall proceed as described in TS 23.502 [8]. Only if the UE indicates that it supports use of integrity protection with ng-eNB, the ng-eNB can activate UP integrity protection.\nNOTE 1: \tLocal SMF can override the confidentiality option in the UP security policy received from the home SMF based on its local policy, roaming agreement and/or regulatory requirements.\nAt an Xn-handover from the source ng-eNB/gNB to the target ng-eNB/gNB, the source ng-eNB/gNB shall include in the HANDOVER REQUEST message, the UE's UP security policy. If the UP security policy is ‘Required’, the target ng-eNB/gNB shall reject all PDU sessions for which it cannot comply with the corresponding received UP security policy and indicate the reject-cause to the SMF. For the accepted PDU sessions, the target ng-eNB/gNB shall activate UP confidentiality and/or UP integrity protection per DRB according to the received UE's UP security policy and shall indicate that to the UE in the HANDOVER COMMAND by the source ng-eNB/gNB. Only if the UE indicates that it supports use of integrity protection with ng-eNB, the target ng-eNB can activate UP integrity protection.\nIf the UE receives an indication in the HANDOVER COMMAND that UP integrity protection and/or UP encryption for a PDU session is enabled at the target ng-eNB/gNB, the UE shall generate or update the UP encryption key and/or UP integrity protection key and shall activate UP encryption and/or UP integrity protection for the respective PDU session.\nNOTE 2:\tIf the security policy is ‘Preferred’, it is possible to have a change in activation or deactivation of UP integrity after the handover.\nFurther, in the Path-Switch message, the target ng-eNB/gNB shall send the UE's UP security policy and corresponding PDU session ID received from the source ng-eNB/gNB to the SMF. The SMF shall verify that the UE's UP security policy received from the target ng-eNB/gNB is the same as the UE's UP security policy that the SMF has locally stored. If there is a mismatch, the SMF shall send its locally stored UE's UP security policy of the corresponding PDU sessions to the target ng-eNB/gNB. This UP security policy information, if included by the SMF, is delivered to the target ng-eNB/gNB in the Path-Switch Acknowledge message. The SMF shall support logging capabilities for this  event and may take additional measures, such as raising an alarm.\nIf the target ng-eNB/gNB receives UE's UP security policy from the SMF in the Path-Switch Acknowledge message, the target ng-eNB/gNB shall update the UE's UP security policy with the received UE's UP security policy. If UE's current UP confidentiality and/or UP integrity protection activation is different from the received UE's UP security policy, then the target ng-eNB/gNB shall initiate intra-cell handover procedure which includes RRC Connection Reconfiguration procedure to reconfigure the DRBs to activate or de-activate the UP integrity/confidentiality as per the received policy from SMF.\nIn case of the target ng-eNB/gNB receives both UE security capability and UP security policy, then ng-eNB/gNB initiates the intra-cell handover procedure which contains selected algorithm and an NCC to the UE.  New UP keys shall be derived and used at both the UE and the target ng-eNB/gNB.\nAt an N2-handover the SMF shall send the UE's UP security policy to the target ng-eNB/gNB via the target AMF. The target ng-eNB/gNB shall reject all PDU sessions for which it cannot comply with the corresponding received UP security policy and indicate the reject-cause to the SMF via the target AMF. For all other PDU sessions, the target ng-eNB/gNB shall activate UP confidentiality and/or UP integrity protection per DRB according to the received UE's UP security policy. Only if the UE indicates that it supports use of integrity protection with ng-eNB, the target ng-eNB can activate UP integrity protection.\nAt interworking-handover from EPS to 5GS, the SMF+PGW-C provides the UE's UP security policy to the target ng-eNB/gNB via the target AMF. The target ng-eNB shall determine from the UP security policy received from the AMF together with the UE indication that it supports user plane integrity protection with ng-eNB in UE EPS security capabilities (i.e. bit EIA7), whether to activate user plane integrity protection with the UE or not. The target ng-eNB/gNB shall reject all DRBs for which it cannot comply with the corresponding UP integrity protection policy in the UP security policy and indicate the reject-cause to the source MME via the target AMF. For all other DRBs, the target ng-eNB/gNB shall activate UP integrity protection per DRB according to the used UP security policy. Only if the UE indicates that it supports use of user plane integrity protection with ng-eNB, the target ng-eNB can activate UP integrity protection. If the target AMF detects in a Registration procedure following interworking-handover from EPS to 5GS, and becomes aware of that there is a mismatch between the UE EPS security capabilities received from the source MME and the one received from the UE, and that the target ng-eNB may not have the UE capability indicating UP IP support in UE EPS security capabilities, then the AMF shall send an N2 CONTEXT MODIFICATION REQUEST message to inform the target ng-eNB about the correct UE EPS security capabilities and target ng-eNB shall take the new UE EPS security capabilities into account.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.2\tUP security activation mechanism",
                            "text_content": "AS UP integrity protection and ciphering activation shall be done as part of the DRB addition procedure using RRC Connection Reconfiguration procedure as described in this clause, see Figure 6.6.2-1.\nThe SMF shall send the UP security policy to the gNB/ng-eNB as defined in Clause 6.6.1.\nThe figure depicts a user plane security activation mechanism, which is a crucial component of network security. The mechanism is designed to ensure that unauthorized users cannot access the network. It involves the use of encryption and authentication protocols to protect the network from unauthorized access. The diagram illustrates the various components involved in the activation process, such as the user plane, security protocols, and network infrastructure. This helps to ensure that the network is secure and can be used safely by authorized users.\nFigure 6.6.2-1: User plane (UP) security activation mechanism\n1a.\tThis RRC Connection Reconfiguration procedure which is used to add DRBs shall be performed only after RRC security has been activated as part of the AS security mode command procedure defined in Clause 6.7.4.\n1b.\tThe gNB/ng-eNB shall send the RRC Connection Reconfiguration message to the UE for UP security activation containing indications for the activation of UP integrity protection and ciphering for each DRB according to the security policy.\n1c.\tIf UP integrity protection is activated for DRBs as indicated in the RRC Connection Reconfiguration message, and if the gNB/ng-eNB does not have KUPint, the gNB/ng-eNB shall generate KUPint and UP integrity protection for such DRBs shall start at the gNB/ng-eNB. Similarly, if UP ciphering is activated for  DRBs as indicated in the RRC Connection Reconfiguration message, and if the gNB/ng-eNB does not have KUPenc, the gNB/ng-eNB shall generate KUPenc and UP ciphering for such DRBs shall start at the gNB/ng-eNB.\n2a.\tUE shall verify the RRC Connection Reconfiguration message. If successful:\n2a.1\tIf UP integrity protection is activated for DRBs as indicated in the RRC Connection Reconfiguration message, and if the UE does not have KUPint, the UE shall generate KUPint and UP integrity protection for such DRBs shall start at the UE.\n2a.2\tSimilarly, if UP ciphering is activated for DRBs as indicated in the RRC Connection Reconfiguration message, and if the UE does not have KUPenc, the UE shall generate KUPenc and UP ciphering for such DRBs shall start at the UE\n2b.\tIf the UE successfully verifies integrity of the RRC Connection Reconfiguration message, the UE shall send the RRC Connection Reconfiguration Complete message to the gNB/ng-eNB.\nIf UP integrity protection is not activated for DRBs, the gNB/ng-eNB and the UE shall not integrity protect the traffic of such DRB and shall not put MAC-I into PDCP packet.\nIf UP ciphering is not activated for DRBs, the gNB/ng-eNB and the UE shall not cipher the traffic of such DRBs.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.3\tUP confidentiality mechanisms",
                            "text_content": "The PDCP protocol, as specified in TS 38.323 [23] between the UE and the NG-RAN, shall be responsible for user plane data confidentiality protection.\nThe use and mode of operation of the 128-bit NEA algorithms are specified in Annex D.\nThe input parameters to the 128-bit NEA algorithms as described in Annex D are the message packet, an 128-bit cipher key KUPenc as KEY, a 5-bit bearer identity BEARER which value is assigned as specified by TS 38.323 [23], the 1-bit direction of transmission DIRECTION, the length of the keystream required LENGTH and a bearer specific, and direction dependent 32-bit input COUNT which corresponds to the 32-bit PDCP COUNT.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.6.4\tUP integrity mechanisms",
                            "text_content": "The PDCP protocol, as specified in TS 38.323 [23] between the UE and the NG-RAN, shall be responsible for user plane data integrity protection.\nThe use and mode of operation of the 128-bit NIA algorithms are specified in Annex D.\nThe input parameters to the 128-bit NIA algorithms as described in Annex D are, the message packet, a 128-bit integrity key KUPint as KEY, a 5-bit bearer identity BEARER value of which is assigned as specified by TS 38.323 [23], the 1-bit direction of transmission DIRECTION, and a bearer specific, and direction dependent 32-bit input COUNT which corresponds to the 32-bit PDCP COUNT.\nIf the gNB or the UE receives a PDCP PDU which fails integrity check with faulty or missing MAC-I after the start of integrity protection, the PDU shall be discarded.\nIf the UE supports E-UTRA connected to 5GC, the UE shall indicate support of integrity protection by setting the EIA7 algorithm bit in 5G UE Security Capability IE (see clause 9.11.3.54 of TS 24.501 [35]) to indicate that the UE supports user plane integrity protection with an ng-eNB.\nIf the 128-NIA algorithm is signalled by the ng-eNB to the UE, clause 6.6.4.2 applies.\nIf the 128-EIA algorithm is signalled by the ng-eNB to the UE, the following applies:\n-\tThe use and mode of operation of the 128-EIA algorithms are specified in Annex B of TS 33.401 [10].\n-\tThe input parameters to the 128-bit EIA algorithms as described in Annex B of TS 33.401 [10] are, the message packet, a 128-bit integrity key KUPint as KEY, a 5-bit bearer identity BEARER value of which is assigned as specified by TS 38.323 [23], the 1-bit direction of transmission DIRECTION, and a bearer specific, time and direction dependent 32-bit input COUNT which corresponds to the 32-bit PDCP COUNT.\nNOTE: The ng-eNB decides whether to signal 128-NIA or 128-EIA algorithm (cf. clause 5.3.1.2 of TS 36.331 [69]).\nIf the ng-eNB or the UE receives a PDCP PDU which fails integrity check with faulty or missing MAC-I after the start of integrity protection, the PDU shall be discarded.\nUE and the ng-eNB (or the ng-eNB acting as the MN) shall derive UP integrity key as specified in Annex A.7 of TS 33.401 [10], with the KeNB set to KgNB.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.7\tSecurity algorithm selection, key establishment and security mode command procedure",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.7.1\tProcedures for NAS algorithm selection",
                            "text_content": "Each AMF shall be configured via network management with lists of algorithms which are allowed for usage. There shall be one list for NAS integrity algorithms, and one for NAS ciphering algorithms. These lists shall be ordered according to a priority decided by the operator.\nTo establish the NAS security context, the AMF shall choose one NAS ciphering algorithm and one NAS integrity protection algorithm. The AMF shall then initiate a NAS security mode command procedure, and include the chosen algorithm and UE security capabilities (to detect modification of the UE security capabilities by an attacker) in the message to the UE (see sub-clause 6.7.2 of the present document). The AMF shall select the NAS algorithm which have the highest priority according to the ordered lists.\nIf the change of the AMF at N2-Handover or mobility registration update results in the change of algorithm to be used for establishing NAS security, the target AMF shall indicate the selected algorithm to the UE as defined in Clause 6.9.2.3.3 for N2-Handover (i.e., using NAS Container) and Clause 6.9.3 for mobility registration update (i.e., using NAS SMC). The AMF shall select the NAS algorithm which has the highest priority according to the ordered lists (see sub-clause 6.7.1.1 of the present document).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.7.2\tNAS security mode command procedure",
                            "text_content": "The NAS SMC shown in Figure 6.7.2-1 shall be used to establish NAS Security context between the UE and the AMF. This procedure consists of a roundtrip of messages between the AMF and the UE. The AMF sends the NAS Security Mode Command message to the UE and the UE replies with the NAS Security Mode Complete message.\nNOTE 1:\tThe NAS SMC procedure is designed such that it protects the Registration Request against a man-in-the-middle attack where the attacker modifies the IEs containing the UE security capabilities provided by the UE in the Registration Request. It works as follows: if the method completes successfully, the UE is attached to the network knowing that no bidding down attack has happened. In case a bidding down attack was attempted, the verification of the NAS SMC will fail and the UE replies with a reject message meaning that the UE will not attach to the network.\nThe figure depicts a NAS security mode command procedure, illustrating the steps involved in configuring the security mode of a network-attached storage (NAS) device. The command is executed by the NAS device, which is connected to the network, and is followed by a series of steps that ensure the security of the data stored on the device. The figure includes a flowchart and a list of commands, providing a clear and concise visual representation of the procedure.\nFigure 6.7.2-1: NAS Security Mode Command procedure\n1a.\tThe AMF activates the NAS integrity protection before sending the NAS Security Mode Command message.\n1b.\tThe AMF sends the NAS Security Mode Command message to the UE. The NAS Security Mode Command message shall contain: the replayed UE security capabilities, the selected NAS algorithms, and the ngKSI for identifying the KAMF. The NAS Security Mode Command message may contain: K_AMF_change_flag (carried in the additional 5G security parameters IE specified in TS 24.501 [35]) to indicate a new KAMF is calculated,  a flag requesting the complete initial NAS message (see subclause 6.4.6), Anti-Bidding down Between Architectures (ABBA) parameter. In the case of horizontal derivation of KAMF during mobility registration update or during multiple registration in same PLMN, K_AMF_change_flag shall be included in the NAS Security Mode Command message as described in clause 6.9.3.\nThis message shall be integrity protected (but not ciphered) with NAS integrity key based on the KAMF indicated by the ngKSI in the NAS Security Mode Command message (see Figure 6.7.2-1).\nNOTE 2: Void.\nIn case the network supports interworking using the N26 interface between MME and AMF, the AMF shall also include the selected EPS NAS algorithms (defined in Annex B of TS 33.401 [10]) to be used after mobility to EPS in the NAS Security Mode Command message (see clause 8.5.2). The UE shall store the algorithms for use after mobility to EPS using the N26 interface between MME and AMF. The AMF shall store the selected EPS NAS algorithms in the UE security context.\nNOTE 2a:\tWhen AMF change happens either due to N2-handover or idle mode mobility, the selected EPS NAS algorithms is always included in the 5G UE security context and provided to the target AMF as part of the 5G UE security context.\n1c. The AMF activates NAS uplink deciphering after sending the NAS Security Mode Command message.\n2a. The UE shall verify the NAS Security Mode Command message. This includes checking that the UE security capabilities sent by the AMF match the ones stored in the UE to ensure that these were not modified by an attacker and verifying the integrity protection using the indicated NAS integrity algorithm and the NAS integrity key based on the KAMF indicated by the ngKSI.\nIn case the NAS Security Mode Command message includes a K_AMF_change_flag, the UE shall derive a new KAMF as described in Annex A.13 and set the NAS COUNTs to zero.\nIf the verification of the integrity of the NAS Security Mode Command message is successful, the UE shall start NAS integrity protection and ciphering/deciphering with the security context indicated by the ngKSI.\n2b. The UE sends the NAS Security Mode Complete message to the AMF ciphered and integrity protected. The NAS Security Mode Complete message shall include PEI in case AMF requested it in the NAS Security Mode Command message. The AMF shall set the NAS COUNTs to zero if horizontal derivation of KAMF is performed. The UE may include the complete initial NAS message (see subclause 6.4.6 for details).\nIf the verification of the NAS Security Mode Command message is not successful in the UE, it shall reply with a NAS Security Mode Reject message (see TS 24.501 [35]). The NAS Security Mode Reject message and all subsequent NAS messages shall be protected with the previous, if any, 5G NAS security context, i.e., the 5G NAS security context used prior to the failed NAS Security Mode Command message. If no 5G NAS security context existed prior to the NAS Security Mode Command message, the NAS Security Mode Reject message shall remain unprotected.\nNOTE 2b:\tVoid.\nThe AMF shall de-cipher and check the integrity protection on the NAS Security Mode Complete message using the key and algorithm indicated in the NAS Security Mode Command message. NAS downlink ciphering at the AMF with this security context shall start after receiving the NAS Security Mode Complete message.\n1d. The AMF activates NAS downlink ciphering.\nNOTE 3:\tIf the uplink NAS COUNT will wrap around by sending the NAS Security Mode Reject message, the UE releases the NAS connection instead of sending the NAS Security Mode Reject message.\nNOTE 4:\tIf the AMF successfully validated the NAS SMC Complete message, the AMF has successfully confirmed the SUPI received from the home network and the SUPI used by the UE match (as required in clause 5.5.3). However, integrity check failure of the NAS SMC Complete message at the AMF could have other causes than a mismatch of the SUPIs.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.7.3\tProcedures for AS algorithm selection",
                            "text_content": "This clause provides the details for AS security algorithms negotiation and consideration during the UE initial AS security context establishment.\nEach gNB/ng-eNB shall be configured via network management with lists of algorithms which are allowed for usage. There shall be one list for integrity algorithms, and one for ciphering algorithms. These lists shall be ordered according to a priority decided by the operator. When AS security context is to be established in the gNB/ng-eNB, the AMF shall send the UE 5G security capabilities to the gNB/ng-eNB. The gNB/ng-eNB shall choose the ciphering algorithm which has the highest priority from its configured list and is also present in the UE 5G security capabilities.\nThe gNB/ng-eNB shall choose the integrity algorithm which has the highest priority from its configured list and is also present in the UE 5G security capabilities. The chosen algorithms shall be indicated to the UE in the AS SMC. The chosen ciphering algorithm is used for ciphering (when activated) of the user plane and RRC traffic. The chosen integrity algorithm is used for integrity protection (when activated) of the user plane and RRC traffic. Activation of ciphering and integrity protection for the RRC traffic shall be done as defined by clause 6.7.4. Activation of ciphering and integrity protection for the user plane traffic shall be done based on the UP security policy received from the SMF as defined by clause 6.6.2.\nAt handover from a source gNB/ng-eNB over Xn to a target gNB/ng-eNB, the source gNB/ng-eNB shall include the UE's 5G security capabilities and ciphering and integrity algorithms used in the source cell in the handover request message. The target gNB/ng-eNB shall select the algorithm with highest priority from the received 5G security capabilities of the UE according to the prioritized locally configured list of algorithms (this applies for both integrity and ciphering algorithms). The chosen algorithms shall be indicated to the UE in the Handover Command message if the target gNB/ng-eNB selects different algorithms compared to the source gNB/ng-eNB. If the UE does not receive any selection of integrity and ciphering algorithms, it continues to use the same algorithms as before the handover (see TS 38.331 [22] for gNB or TS 36.331 [69] for ng-eNB). When a Xn-handover takes place from ng-eNB to gNB or vice versa, then the selected algorithms in the target node shall always be signalled in the Handover Command to the UE. In the Path-Switch message, the target gNB/ng-eNB shall send the UE's 5G security capabilities received from the source gNB/ng-eNB to the AMF. The AMF shall verify that the UE's 5G security capabilities received from the target gNB/ng-eNB are the same as the UE's 5G security capabilities that the AMF has locally stored. If there is a mismatch, the AMF shall send its locally stored 5G security capabilities of the UE to the target gNB/ng-eNB in the Path-Switch Acknowledge message. The AMF shall support logging capabilities for this event and may take additional measures, such as raising an alarm.\nIf the target gNB/ng-eNB receives UE's 5G security capabilities from the AMF in the Path-Switch Acknowledge message, the target gNB/ng-eNB shall update the AS security context of the UE with these 5G security capabilities of the UE. The target gNB/ng-eNB shall select the algorithm with highest priority from these 5G security capabilities according to the locally configured prioritized list of algorithms (this applies for both integrity and ciphering algorithms). If the algorithms selected by the target gNB/ng-eNB are different from the algorithms used at the source gNB/ng-eNB, then the target gNB/ng-eNB shall initiate intra-cell handover procedure which includes RRC Connection Reconfiguration procedure indicating the selected algorithms and an NCC to the UE.\nNOTE:\tTransferring the ciphering and integrity algorithms used in the source cell to the target gNB/ng-eNB in the handover request message allows for the target gNB/ng-eNB to decipher and verify the integrity of the RRC Reestablishment Complete message on SRB1 in the potential RRC Connection Re-establishment procedure. The information is also used by the target gNB/ng-eNB to decide if it is necessary to include a new selection of security algorithms in the Handover Command message.\nAt handover from a source gNB/ng-eNB to a target gNB/ng-eNB over N2 (possibly including an AMF change and hence a transfer of the UE's 5G security capabilities from the source AMF to the target AMF), the target AMF shall send the UE's 5G security capabilities to the target gNB/ng-eNB in the NGAP HANDOVER REQUEST message (see TS 33.413 [34]). The target gNB/ng-eNB shall select the algorithm with highest priority from the UE's 5G security capabilities according to the locally configured prioritized list of algorithms (this applies for both integrity and ciphering algorithms). The chosen algorithms shall be indicated to the UE in the Handover Command message if the target gNB/ng-eNB selects different algorithms compared to the source gNB/ng-eNB. If the UE does not receive any selection of integrity and ciphering algorithms, it continues to use the same algorithms as before the handover (see TS 38.331 [22]).\nFor N2-handover, the source gNB/ng-eNB shall include AS algorithms used in the source cell (ciphering and integrity algorithms) in the source to target transparent container that shall be sent to the target gNB/ng-eNB. The AS algorithms used by the source cell are provided to the target gNB/ng-eNB so that it can use them during the potential RRC Connection Re-establishment procedure use them as specified in clause 6.11 for gNB and TS 33.401 [10] for ng-eNB.\nIt is not required to change the AS security algorithms during intra-gNB-CU/intra-ng-eNB handover. If the UE does not receive an indication of new AS security algorithms during an intra-gNB-CU/intra-ng-eNB handover, the UE shall continue to use the same algorithms as before the handover (see TS 38.331 [22] for gNB and TS 36.331 [69] for ng-eNB).\nAt state transition from RRC_INACTIVE to RRC_CONNECTED, the source gNB/ng-eNB shall include the UE 5G security capabilities and the ciphering and integrity algorithms the UE was using with the source cell in the Xn-AP Retrieve UE Context Response message.\nThe target gNB/ng-eNB shall check if it supports the received algorithms, if the target gNB/ng-eNB supports the received ciphering and integrity algorithms, the target gNB/ng-eNB shall check the received algorithms to its locally configured list of algorithms (this applies for both integrity and ciphering algorithms). If the target gNB/ng-eNB selects the same security algorithms, the target gNB/ng-eNB shall use the selected algorithms to derive RRC integrity and RRC encryption keys to protect the RRCResume message and send to the UE on SRB1.\nIf the target gNB/ng-eNB does not support the received algorithms or if the target gNB/ng-eNB prefers to use different algorithms, the target gNB/ng-eNB shall send an RRCSetup message on SRB0 in order to proceed with RRC connection establishment as if the UE was in RRC_IDLE (fallback procedure) to the UE. Then the UE performs NAS based RRC recovery and negotiates a suitable algorithm with target gNB/ng-eNB via AS SMC procedure.\nIf the source gNB/ng-eNB decides to relocate UE context to the target gNB/ng-eNB during an RNA Update procedure, the source gNB/ng-eNB shall include the UE 5G security capabilities and the ciphering and integrity algorithms the UE was using with the source cell in the <Xn-AP Retrieve UE Context Response> message. AS security algorithm selection is as described in clause 6.7.3.4.\nUEs that are in limited service mode (LSM) and that cannot be authenticated by the AMF/SEAF (for whatever reason) may still be allowed to establish emergency session by sending the emergency registration request message. It shall be possible to configure whether the AMF allows unauthenticated UEs in LSM to establish bearers for emergency session or not. If an AMF allows unauthenticated UEs in LSM to establish bearers for an emergency session, then for the NAS protocol, the AMF shall use NIA0 and NEA0 as the integrity and ciphering algorithm respectively.\nIf the AMF allows an unauthenticated UE in LSM to establish bearers for emergency session after it has received the emergency registration request message from the UE, the AMF shall:\n-\tSelect NIA0 and NEA0, regardless of the supported algorithms announced previously by the UE as the NAS algorithms and signal this to the UE via the NAS security mode command procedure when activating the 5G NAS security context.\n-\tSet the UE 5G security capabilities to only contain EIA0, EEA0, NIA0 and NEA0 when sending these to the gNB/ng-eNB  in the following messages:\n-\tNGAP UE INITIAL CONTEXT SETUP\n-\tNGAP UE CONTEXT MODIFICATION REQUEST\n-\tNGAP HANDOVER REQUEST\nNOTE:\tAs a result of that the AMF only sending a UE 5G security capability containing EIA0, EEA0, NIA0 and NEA0 to the gNB/ng-eNB , the gNB/ng-eNB  is only able of selecting a null integrity protection for AS integrity protection and a null ciphering algorithm for AS confidentiality protection. That is, if NIA0 is used for NAS integrity protection, then NIA0 or EIA0 will always be used for AS integrity protection.\nIf NIA0 is disabled at the gNB for regulatory requirements and the gNB receives the UE 5G security capabilities to only contain NIA0 for integrity protection algorithms from the AMF in one of the above messages, the gNB shall reject the session.\nThe rules for when the AMF shall select NIA0 for NAS integrity protection, and when the UE shall accept a NAS security mode command selecting NIA0 for NAS integrity protection depends on whether the UE and AMF can be certain that no 5G NAS security context can be established. The rules for determining this is defined in clause 10 of this specification. If the AMF has selected NIA0 as the NAS integrity protection algorithm, the UE shall accept selection of NIA0 or EIA0 as the AS integrity protection algorithm. Selection of AS integrity protection algorithm happens via the AS security mode command procedure or via a handover command. The UE shall under no other circumstances accept selection of null integrity algorithm as the AS integrity protection algorithm.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.7.4\tAS security mode command procedure",
                            "text_content": "The AS SMC procedure is for RRC and UP security algorithms negotiation and RRC security activation. for the gNB/ng-eNB. AS SMC procedure can be triggered to establish a secure RRC signalling-only connection during UE registration or PDU session establishment as specified in TS 38.413 [34] and TS 23.502 [8]. The activation of UP security is as described in clause 6.6.2. AS SMC procedure consists of a roundtrip of messages between gNB/ng-eNB and UE. The gNB/ng-eNB sends the AS security mode command to the UE and the UE replies with the AS security mode complete message. See Figure 6.7.4-1.\nThe AS security mode command message sent from gNB/ng-eNB to UE shall contain the selected RRC and UP encryption and integrity algorithms. This AS security mode command message shall be integrity protected with RRC integrity key based on the current KgNB.\nThe AS security mode complete message from UE to gNB/ng-eNB shall be integrity protected with the selected RRC algorithm indicated in the AS security mode command message and RRC integrity key based on the current KgNB.\nRRC downlink ciphering (encryption) at the gNB/ng-eNB shall start after sending the AS security mode command message. RRC uplink deciphering (decryption) at the gNB/ng-eNB shall start after receiving and successful verification of the AS security mode complete message.\nRRC uplink ciphering (encryption) at the UE shall start after sending the AS security mode complete message. RRC downlink deciphering (decryption) at the UE shall start after receiving and successful verification of the AS security mode command message.\nIf any control of the AS security mode command is not successful in the UE, the UE shall reply with an unprotected security mode failure message (see TS 38.331[22]).\nCiphering and integrity protection of UP downlink and uplink, at the UE and the gNB/ng-eNB, shall start as defined by clause 6.6.2.\nAS SMC shall be used only during an initial context setup between the UE and the gNB/ng-eNB (i.e., to activate an initial KgNB at RRC_IDLE to RRC_CONNECTED state transition).\nNOTE: \tDerivation of a KgNB at RRC_IDLE to RRC_CONNECTED state ensures that AS SMC establishes a fresh KgNB. Consequently, the PDCP COUNTs can be reset.\nThe figure depicts the AS Security Mode Command Procedure, which is a crucial component of the network's security architecture. It outlines the steps and commands that are executed when an AS (Access Server) initiates a security-related command. The figure includes various command lines and their corresponding parameters, such as the command type, the command ID, and the command parameters. This diagram is essential for ensuring the proper execution of security commands and maintaining network integrity.\nFigure 6.7.4-1: AS Security Mode Command Procedure\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.8\tSecurity handling in state transitions",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.8.1\tKey handling at connection and registration state transitions",
                            "text_content": "One state machine in the UE and AMF is handling the registration states over 3GPP access and a second state machine is handling the registration states over non-3GPP access. This clause and its sub-clauses applies to both 3GPP access and non-3GPP access. UDM manages separate/independent UE Registration procedure for each access. The AMF shall associate Registration state per access type with the UE.\nThere are different reasons for transition to the RM-DEREGISTERED state. If a NAS messages leads to state transition to RM-DEREGISTERED, it shall be security protected by the current 5G NAS security context (mapped or native), if such exists in the UE or the AMF.\nNOTE:\tThe present document only considers the states RM-DEREGISTERED and RM REGISTERED and transitions between these two states. Other documents define additional RM states (see, e.g. 5GMM states in TS 24.501 [35]).\nOn transitioning to RM-DEREGISTERED, the UE and AMF shall do the following:\n1.\tIf they have a full non-current native 5G NAS security context and a current mapped 5G NAS security context, then they shall make the non-current native 5G NAS security context the current one.\n2.\tThey shall delete any mapped or partial 5G NAS security contexts they hold.\nHandling of the remaining security parameters for each of these cases are given below:\n1.\tRegistration reject: All remaining security parameters shall be removed from the UE and AMF\n2.\tDeregistration:\na.\tUE-initiated\ni.\tIf the reason is switch off then all the remaining security parameters shall be removed from the UE and AMF with the exception of the current native 5G NAS security context (as in clause 6.1.1), which should remain stored in the AMF and UE.\nii.\tIf the reason is not switch off then AMF and UE shall keep all the remaining security parameters.\nb.\tAMF-initiated\ni.\tExplicit: all the remaining security parameters shall be kept in the UE and AMF if the de-registration  type is \"re-registration required\".\nii.\tImplicit: all the remaining security parameters shall be kept in the UE and AMF.\nc.\tUDM/ARPF-initiated: If the message is \"subscription withdrawn\" then all the remaining security parameters shall be removed from the UE and AMF.\n3.\tRegistration reject: There are various reasons for Registration reject. The action to be taken shall be as given in TS 24.501 [35].\nStorage of the full native 5G NAS security context including the pair(s) of distinct NAS COUNT values associated with each access together with respective NAS connection identifier, excluding the UE security capabilities and the keys KNASint and KNASenc, in the UE when the UE transitions to RM-DEREGISTERED state is done as follows:\na)\tIf the ME does not have a full native 5G NAS security context in volatile memory, any existing native 5G NAS security context stored on the USIM or in non-volatile memory of the ME shall be marked as invalid.\nb)\tIf the USIM supports RM parameters storage, then the ME shall store the full native 5G NAS security context parameters on the USIM (except for KNASint and KNASenc), mark the native 5G NAS security context on the USIM as valid, and not keep any native 5G NAS security context in non-volatile ME memory.\nc)\tIf the USIM does not support RM parameters storage, then the ME shall store the full native 5G NAS security context (except for KNASint and KNASenc) in a non-volatile part of its memory and mark the native 5G NAS security context in its non-volatile memory as valid.\nd) For the case that the AMF or the UE enter RM-DEREGISTERED state without using any of the above procedures, the handling of the remaining security parameters shall be as specified in TS 24.501 [35].\nWhen starting the transition away from RM DEREGISTERED state with the intent to eventually transitioning to RM-REGISTERED state, if no current 5G NAS security context is available in the ME, the ME shall retrieve native 5G NAS security context stored on the USIM if the USIM supports RM parameters storage and if the stored native 5G NAS security context on the USIM is marked as valid. If the USIM does not support RM parameters storage the ME shall retrieve stored native 5G NAS security context from its non-volatile memory if the native 5G NAS security context is marked as valid. The ME shall derive the KNASint and KNASenc from the KAMF after retrieving the stored 5G NAS security context; see Annex A on NAS key derivation. The retrieved native 5G NAS security context with the derived KNASint and KNASenc shall then become the current 5G NAS security context.\nWhen the ME is transitioning away from RM DEREGISTERED state with the intent to eventually transitioning to RM-REGISTERED state, if the USIM supports RM parameters storage, the ME shall mark the stored 5G NAS security context on the USIM as invalid. If the USIM does not support RM parameters storage, the ME shall mark the stored 5G NAS security context in its non-volatile memory as invalid.\nIf the ME uses a 5G NAS security context to protect NAS messages, the distinct NAS COUNT values together with the NAS connection identifier associated with this access, are updated in the volatile memory of the ME. If the attempt to transition away from RM DEREGISTERED state with the intent to eventually transitioning to RM-REGISTERED state fails, the ME shall store the (possibly updated) 5G NAS security context including the distinct NAS COUNT values together with the NAS connection identifier associated with this access, on the USIM or non-volatile ME memory and mark it as valid.\nNOTE:\tThe present document only considers the states RM-DEREGISTERED and RM REGISTERED and transitions between these two states. Other documents define additional RM states (see, e.g. 5GMM states in TS 24.501 [35]).\nWhen the UE transits from RM-DEREGISTERED to RM-REGISTERED/CM-CONNECTED, there are two cases to consider, either a full native 5G NAS security context exists, or it does not.\nThe UE shall transmit a NAS Registration Request message. This message is integrity protected using the distinct NAS COUNT values and the NAS connection identifier associated with this access. For the case that the 5G NAS security context used by the UE is non-current in the AMF, the AMF shall delete any existing current 5G security context and make the used 5G security context the current 5G security contex.  Furthermore, provided that the NAS Registration Request was with \"PDU session(s) to be re-activated\" and there is no NAS SMC procedure before the AS SMC the NAS COUNT of the Registration Request message shall be used to derive the KgNB/KeNB with the KDF as specified in Annex A.\nAs a result of the NAS Registration Request with \"PDU session(s) to be re-activated\", the gNB/ng-eNB shall send an AS SMC to the UE to activate AS security. The KgNB/KeNB used, is derived in the current 5G NAS security context.\nWhen the UE receives the AS SMC without having received a NAS Security Mode Command after the Registration Request with \"PDU session(s) to be re-activated\", it shall use the uplink NAS COUNT of the Registration Request message that triggered the AS SMC to be sent as freshness parameter in the derivation of the initial KgNB/KeNB. From this initial KgNB/KeNB the RRC protection keys and the UP protection keys shall be derived as described in sub-clause 6.2.3.1.\nThe same procedure for generating initial KgNB/KeNB can be used regardless of the fact if the UE is connecting to the same AMF to which it was connected previously or to a different AMF. In case UE connects to a different AMF and this AMF selects different NAS algorithms, the NAS keys have to be re-derived in the AMF with the new algorithm IDs as input using the KDF as specified in Annex A.\nIn addition, there is a need for the AMF to send a NAS SMC to the UE to indicate the change of NAS algorithms and to take the re-derived NAS keys into use. The UE shall assure that the NAS keys used to verify the integrity of the NAS SMC are derived using the algorithm ID specified in the NAS SMC. The NAS SMC Command and NAS SMC Complete messages are protected with the new NAS keys.\nIf there is a NAS Security Mode Command after the Registration Request with \"PDU session(s) to be re-activated\" but before the AS SMC, the UE and AMF use the uplink NAS COUNT of the most recent NAS Security Mode Complete and the related KAMF as the parameter in the derivation of the KgNB/KeNB. From this KgNB/KeNB the RRC protection keys and the UP protection keys are derived as described in sub-clause 6.2.3.1.\nIf in the process described in clause 6.8.1.1.2.2, there is no full native 5G NAS security context available in the AMF (i.e. either the UE has sent an unprotected Registration Request message or the UE has protected the Registration Request message with a current native 5G security context which no longer is stored in the AMF) a primary authentication run is required. If there is a full native 5G NAS security context available in the AMF, then the AMF may (according to AMF policy) decide to run a new primary authentication and a NAS SMC procedure (which activates the new 5G NAS security context based on the KAMF derived during the primary authentication run) after the Registration Request.\nIf the Registration Request was with \"PDU session(s) to be re-activated\", the NAS SMC procedure is executed before the corresponding AS SMC. The NAS (uplink and downlink) COUNTs are set to start values, and the start value of the uplink NAS COUNT shall be used as freshness parameter in the KgNB/KeNB derivation from the fresh KAMF (after primary authentication) when UE receives AS SMC the KgNB/KeNB is derived from the current 5G NAS security context, i.e., the fresh KAMF is used to derive the KgNB/KeNB. The KDF as specified in clause Annex A shall be used to derive the KgNB/KeNB.\nNOTE:\tUsing the start value for the uplink NAS COUNT in this case cannot lead to the same combination of KAMF and NAS COUNT being used twice. This is guaranteed by the fact that the first integrity protected NAS message the UE sends to the AMF after primary authentication is the NAS SMC complete message.\nThe NAS SMC complete message shall include the start value of the uplink NAS COUNT that is used as freshness parameter in the KgNB/KeNB derivation and the KAMF is fresh. After a primary authentication, a NAS SMC needs to be sent from the AMF to the UE in order to take the new NAS keys into use. Both NAS SMC and NAS SMC Complete messages are protected with the new NAS keys.\nIt is assumed in this clause that the UE is already registered over a first access type (say access A). Clauses 6.8.1.1.2.1 and 6.8.1.1.2.2 applies as well when the UE attempts to register over a new access type (access B) to the same AMF with the following addition/exception:\nWhenever the UE registers over a second access type (access B) to the same AMF, with the intention to transitioning from RM-DEREGISTERED to RM-REGISTERED state, then a full native 5G NAS security context is already available in the UE and the AMF. In this case, the UE shall directly take into use the available full 5G NAS security context and use it to protect the Registration Request over the second access using the distinct pair of NAS COUNTs for this second access type (access B).\nThe AMF may decide to run a new primary authentication as part of the Registration procedure on this second access (access B). If a new primary authentication is run, then the new derived partial 5G NAS security context needs to be taken into use on this second access (access B) with a NAS SMC using the distinct pair of NAS COUNTs for this second access. As the UE is already registered on the first access (access A), then the AMF needs to run a NAS SMC procedure on the first access in order to take the partial 5G NAS security context into use as described in clause 6.4.2.2.\nIf there is a need for the AMF to take a new partial 5G NAS security context into use, derived from primary authentication executed on the first access (access A), then the AMF needs to send a NAS SMC to the UE on the second access (access B) in order to take the new partial 5G NAS security context into use as described in clause 6.4.2.2.\nOne state machine in the UE and AMF is handling the connection states over 3GPP access and a second state machine is handling the connection states over non-3GPP access. This clause and its sub-clauses applies to both 3GPP access and non-3GPP access when not explicitly stated.\nThe UE sends an initial NAS message to initiate transition from CM-IDLE to CM-CONNECTED state (see TS 24.501 [35].\nIf a full native 5G NAS security context is already available in the UE and the AMF, then the UE shall directly take into use the available full 5G NAS security context and use it to protect the initial NAS message using the distinct pair of NAS COUNTs together with the NAS connection identifier for this access.\nIf the UE is simultaneously registered over both 3GPP access and non-3GPP access in the same AMF, then if there is a need for the AMF to take a new partial 5G NAS security context into use on this access (access A), derived from primary authentication executed on a different access, then the AMF needs to send a NAS SMC to the UE on this access (access A) in order to take the new partial 5G NAS security context also into use on this access as described in clause 6.4.2.2.\nOn transitions to CM-CONNECTED, the AMF should be able to check whether a new authentication is required, e.g. because of prior inter-provider handover.\nIf the UE is simultaneously registered over both 3GPP access and non-3GPP access in the same AMF, then if a new primary authentication is run, then the new derived partial 5G NAS security context needs to be taken into use on this access (access A) with a NAS SMC using the distinct pair of NAS COUNTs for this access. But the new derived partial 5G NAS security context also needs to be taken into use on the other accesses (access B) with a NAS SMC using the distinct pair of NAS COUNTs for the respective access as part of the NAS procedure as described in clause 6.4.2.2.\nWhen cryptographic protection for radio bearers is established RRC protection keys and UP protection keys shall be generated as described in sub-clause 6.2.3.1 while KAMF is assumed to be already available in the AMF.\nThe initial NAS message shall be integrity protected by the current 5G NAS security context if such exists using the distinct pair of NAS COUNTs together with the NAS connection identifier for this access. If no current 5G NAS security context exists the ME shall signal \"no key available\" in the initial NAS message.\nKAMF may have been established in the AMF as a result of a primary authentication run on this access or on a different access, or as a result of a 5G security context transfer from another AMF during N2 handover or idle mode mobility.\nWhen the gNB/ng-eNB releases the RRC connection, the UE and the gNB/ng-eNB shall delete the keys they store such that state in the network for CM-IDLE state UEs will only be maintained in the AMF.\nThis sub-clause applies to establishment of keys for cryptographically protected radio bearers in 3GPP access only.\nThe procedure the UE uses to establish cryptographic protection for radio bearers is initiated by an NAS Service Request message or Registration Request message with \"PDU session(s) to be re-activated\" included from the UE to the AMF. The AMF may initiate the procedure to establish cryptographic protection for radio bearers when \"PDU session(s) to be re-activated\" is not included in the Registration request and but there is pending downlink UP data or pending downlink signalling.\nUpon receipt of the NAS message, if the AMF does not require a NAS SMC procedure before initiating the NGAP procedure INITIAL CONTEXT SETUP, the AMF shall derive key KgNB/KeNB as specified in Annex A using the uplink NAS COUNT (see TS 24.501 [35]) corresponding to the NAS message that initiated transition from CM-IDLE to CM-CONNECTED state and the KAMF of the current 5G NAS security context.\nThe AMF shall communicate the KgNB/KeNB to the serving gNB/ng-eNB in the NGAP procedure INITIAL CONTEXT SETUP. The UE shall derive the KgNB/KeNB from the KAMF of the current 5G NAS security context using the NAS uplink COUNT corresponding to the NAS message that initiated transition from CM-IDLE to CM-CONNECTED state.\nAs a result of the NAS Service Request or Registration procedure, with \"PDU session(s) to be re-activated\" radio bearers are established, and the gNB/ng-eNB sends an AS SMC to the UE. When the UE receives the AS SMC without having received a NAS Security Mode Command, it shall use the NAS uplink COUNT corresponding to the NAS message that initiated transition from CM-IDLE to CM-CONNECTED state as freshness parameter in the derivation of the KgNB/KeNB. The KDF as specified in Annex A shall be used for the KgNB/KeNB derivation using the KAMF of the current 5G NAS security context. From the KgNB/KeNB the RRC protection keys and the UP protection keys are derived by the UE and the gNB/ng-eNB as described in sub-clause 6.2.\nIf the NAS procedure establishing radio bearers contains a primary authentication run (which is optional), the NAS uplink and downlink COUNT for the new KAMF shall be set to the start values (i.e. zero). If the NAS procedure establishing radio bearers contains a NAS SMC (which is optional), the value of the uplink NAS COUNT corresponding to the most recent NAS Security Mode Complete shall be used as freshness parameter in the KgNB/KeNB derivation from fresh KAMF of the current 5G NAS security context when executing an AS SMC. The KDF as specified in Annex A shall be used for the KgNB/KeNB derivation also in this case.\nThe case that the UE is using Control Plane CIoT 5GS optimisation to send data over NAS and N3 bearers are established (due to either a request from the UE or decided by the AMF - see 5.31.4 of TS 23.501 [2]) works as follows. The UE and AMF shall always use the value of the uplink NAS COUNT from the Control Plane Service Request that was sent to transition the UE from idle to active as freshness parameter in the derivation of the KeNB unless there has been a subsequent NAS Security Mode Complete. If there was a subsequent NAS Security Mode Complete, then the UE and AMF use the value of the uplink NAS COUNT from the latest NAS Security Mode Complete message as freshness parameter in the derivation of the KeNB.\nIn the case of non-3GPP access, there are no individual radio bearers set up between the UE and N3IWF. For non-3GPP access, an IPsec tunnel is established between the UE and the interworking function N3IWF. The main SA is used solely for the transport of NAS messages between the UE and the AMF/SMF.\nCorresponding to the PDU session of the UE, based on the policies and configuration, N3IWF determines the number of IPsec child SAs to be established and the QoS profiles associated with each IPsec child SA. For example, the N3IWF may decide to establish one IPsec child SA and associate all QoS profiles with this IPsec child SA. In this case, all QoS Flows of the PDU Session would be transferred over one IPsec child SA. N3IWF may also decide to establish different child SAs corresponding to the different QoS flows.\nCorresponding to radio bearers in 3GPP access which are mapped to QoS values, for non-3GPPaccess there are only child SAs mapped to QoS values. Cryptographically each child SA is different with distinct key materials exchanged as per RFC 7296 [25].\nOn CM-CONNECTED to CM-IDLE transitions the gNB/ng-eNB does no longer need to store state information about the corresponding UE.\nIn particular, on CM-CONNECTED to CM-IDLE transitions:\n-\tThe gNB/ng-eNB and the UE shall release all radio bearers and delete the AS security context.\n-\tAMF and the UE shall keep the 5G NAS security context stored.\nNOTE:\tThis clause applies to both 3GPP access and non-3GPP access.\nBefore the UE can initiate the Registration procedure, the UE needs to transition to CM-CONNECTED state. The UE shall use the current 5G security context to protect the Registration Request and include the corresponding 5G-GUTI and ngKSI value. The Registration Request shall be integrity-protected, but not confidentiality-protected. UE shall use the current 5G security context algorithms to protect the Registration Request message. For the case that this security context is non-current in the AMF, the AMF shall delete any existing current 5G security context and make the used 5G NAS security context the current 5G security context.\nIf \"PDU session(s) to be re-activated\" is included in the Registration request message or if the AMF chooses to establish radio bearers when there is pending downlink UP data or pending downlink signalling, radio bearers will be established as part of the Registration procedure and a KgNB/KeNB will be derived. If there was no subsequent NAS SMC, the value of the uplink NAS COUNT, associated with the 3GPP access over which the Registration request message was sent from the UE to the AMF, is used as freshness parameter in the KgNB/KeNB derivation using the KDF as specified in clause Annex A.9.\nIn the case a primary authentication is run successfully, the uplink and downlink NAS COUNT shall be set to the start values (i.e. zero).\nIn the case source and target AMF use different NAS algorithms, the target AMF re-derives the NAS keys from KAMF with the new algorithm identities as input and provides the new algorithm identifiers within a NAS SMC. The UE shall assure that the NAS keys used to verify the integrity of the NAS SMC are derived using the algorithm identity specified in the NAS SMC.\nIf there is a NAS Security Mode Command after the Registration Request over 3GPP access, the UE and AMF shall use the value of the uplink NAS COUNT associated with the 3GPP access of the most recent NAS Security Mode Complete and the related KAMF as the parameter in the derivation of the KgNB/KeNB. From this KgNB/KeNB the RRC protection keys and the UP protection keys are derived as described in sub-clause 6.2.3.1.\nIn the case of Registration over non-3GPP access, the UE and AMF shall use the uplink NAS COUNT associated with the non-3GPP access of the most recent NAS Security Mode Complete and the related KAMF as the parameter in the derivation of the KN3IWF. IPsec SA is established between the UE and N3IWF using the KN3IWF as described in sub-clause 7.2.1 of this document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.8.2\tSecurity handling at RRC state transitions",
                            "text_content": "In 5G, the RRC_INACTIVE state allows gNB/ng-eNB to suspend the UE's RRC connection while the gNB/ng-eNB and the UE continue to maintain the UE 5G AS security context. The UE RRC connection can be resumed at a later time by allowing the UE to transition into RRC__CONNECTED state. The UE may transition from RRC_INACTIVE state to RRC_CONNECTED state to the same last serving gNB/ng-eNB which sent the UE into RRC_INACTIVE state or to a different gNB/ng-eNB. While the UE is in RRC_INACTIVE state, the UE and last serving gNB/ng-eNB store the UE 5G AS security context which can be reactivated when the UE transitions from RRC_INACTIVE to RRC_CONNECTED. The gNB/ng-eNB and the UE shall behave as defined in following sub-clauses. The ng-eNB connected to 5GC shall also support the same security handling at RRC state transitions.\nThe gNB/ng-eNB shall send to the UE an RRCRelease with suspendConfig  message that is ciphered and integrity protected in PDCP layer using a current AS security context. The gNB/ng-eNB shall include a fresh I-RNTI, and an NCC in that RRCRelease with suspendConfig  message. The I-RNTI is used for context identification, and the UE ID part of the I-RNTI assigned by the gNB/ng-eNB shall be different in consecutive suspends of the same UE. This is to avoid tracking of UEs based on the I-RNTI. If the gNB/ng-eNB has a fresh and unused pair of {NCC, NH}, the gNB/ng-eNB shall include the NCC in the RRCRelease with suspendConfig  message. Otherwise, the gNB/ng-eNB shall include the same NCC associated with the current KgNB in the RRCRelease with suspendConfig  message. The NCC is used for AS security.\nThe gNB/ng-eNB shall delete the current AS keys KRRCenc, KUPenc (if available), and KUPint (if available) after sending the RRCRelease with suspendConfig  message to the UE, but shall keep the current AS key KRRCint. If the sent NCC value is fresh and belongs to an unused pair of {NCC, NH}, the gNB/ng-eNB shall save the pair of {NCC, NH} in the current UE AS security context and shall delete the current AS key KgNB. If the sent NCC value is equal to the NCC value associated with the current KgNB, the gNB/ng-eNB shall keep the current AS key KgNB and NCC. The gNB/ng-eNB shall store the sent I-RNTI together with the current UE context including the remainder of the AS security context.\nUpon receiving the RRC Release with suspendConfig message from the gNB/ng-eNB, the UE shall verify that the integrity of the received RRCRelease with suspendConfig  message is correct by checking the PDCP MAC-I. If this verification is successful, then the UE shall take the received NCC value and save it as stored NCC with the current UE context. The UE shall delete the current AS keys KRRCenc, KUPenc (if available), and KUPint (if available), but keep the current AS key KRRCint key. If the stored NCC value is different from the NCC value associated with the current KgNB, the UE shall delete the current AS key KgNB. If the stored NCC is equal to the NCC value associated with the current KgNB, the UE shall keep the current AS key KgNB. The UE shall store the received I-RNTI together with the current UE context including the remainder of the AS security context, for the next state transition.\nWhen the UE decides to resume the RRC connection to transit from RRC_INACTIVE to RRC_CONNECTED, the UE sends RRCResumeRequest message on SRB0 and hence it is not integrity protected. However, the RRCResumeRequest message shall include the I-RNTI and a ResumeMAC-I/shortResumeMAC-I. The I-RNTI (short or full I-RNTI) is used for context identification and its value shall be the same as the I-RNTI that the UE had received from the source gNB/ng-eNB in the RRCRelease with suspendConfig  message. The ResumeMAC-I/shortResumeMAC-I is a 16-bit message authentication token, the UE shall calculate it using the integrity algorithm (NIA or EIA) in the stored AS security context, which was negotiated between the UE and the source gNB/ng-eNB and the  current KRRCint with the following inputs:\n- \tKEY\t\t\t: it shall be set to current KRRCint;\n-\tBEARER\t\t: all its bits shall be set to 1.\n-\tDIRECTION\t: its bit shall be set to 1;\n-\tCOUNT\t\t: all its bits shall be set to 1;\n-\tMESSAGE\t: it shall be set to VarResumeMAC-Input/VarShortInactiveMAC-Input as defined in TS 38.331 [22] for gNB and in TS 36.331 [69] for ng-eNB with following inputs:\nsource PCI, target Cell-ID, source C-RNTI.\n\nFor protection of all RRC messages except RRCReject message following the sent RRCResumeRequest message, the UE shall derive a KNG-RAN* using the target PCI, target ARFCN-DL/EARFCN-DL and the KgNB/NH based on either a horizontal key derivation or a vertical key derivation as defined in clause 6.9.2.1.1 and Annex A.11/Annex A.12. The UE shall further derive KRRCint, KRRCenc, KUPenc (optionally), and KUPint (optionally) from the newly derived KNG-RAN*.\nWhen the target gNB/ng-eNB receives the RRCResumeRequest message from the UE, the target gNB/ng-eNB extracts the I-RNTI from the RRCResumeRequest message. The target gNB/ng-eNB contacts the source gNB/ng-eNB based on the information in the I-RNTI by sending an Xn-AP Retrieve UE Context Request message with the following included: I-RNTI, the ResumeMAC-I/shortResumeMAC-I and target Cell-ID, in order to allow the source gNB/ng-eNB to validate the UE request and to retrieve the UE context including the UE 5G AS security context.\nThe source gNB/ng-eNB retrieves the stored UE context including the UE 5G AS security context from its database using the I-RNTI. The source gNB/ng-eNB verifies the ResumeMAC-I/shortResumeMAC-I using the current KRRCint key stored in the retrieved UE 5G AS security context (calculating the ResumeMAC-I/shortResumeMAC-I in the same way as described above). If the verification of the ResumeMAC-I/shortResumeMAC-I is successful, then the source gNB/ng-eNB calculates KNG-RAN* using the target cell PCI, target ARFCN-DL/EARFCN-DL and the KgNB/NH in the current UE 5G AS security context based on either a horizontal key derivation or a vertical key derivation according to whether the source gNB/ng-eNB has an unused pair of {NCC, NH} as described in Annex A.11/Annex A.12. The source gNB/ng-eNB can obtain the target PCI and target ARFCN-DL/EARFCN-DL from a cell configuration database by means of the target Cell-ID which was received from the target gNB/ng-eNB. Then the source gNB/ng-eNB shall respond with an Xn-AP Retrieve UE Context Response message to the target gNB/ng-eNB including the UE context that contains the UE 5G AS security context. The UE 5G AS security context sent to the target gNB/ng-eNB shall include the newly derived KNG-RAN*, the NCC associated to the KNG-RAN*, the UE 5G security capabilities, UP security policy, the UP security activation status with the corresponding PDU session ID(s), and the ciphering and integrity algorithms used by the UE with the source cell.\nThe target gNB/ng-eNB shall check if it supports the ciphering and integrity algorithms the UE used with the last source cell. If the target gNB/ng-eNB does not support the ciphering and integrity algorithms used in the last source cell or if the target gNB/ng-eNB prefers to use different algorithms than the source gNB/ng-eNB, then the target gNB/ng-eNB shall send an RRC Setup/RRCSetup message on SRB0 to the UE in order to proceed with RRC connection establishment as if the UE was in RRC_IDLE (i.e., a fallback procedure).\nIf the target gNB/ng-eNB supports the ciphering and integrity algorithms used with the last source cell and these algorithms are the chosen algorithms by the target gNB/ng-eNB, the target gNB/ng-eNB shall derive new AS keys (RRC integrity key, RRC encryption key and UP keys) using the algorithms the UE used with the source cell and the received KNG-RAN*. The target gNB/ng-eNB shall reset all PDCP COUNTs to 0 and activate the new keys in PDCP layer. The target gNB/ng-eNB shall respond to the UE with an RRC Resume message on SRB1 which is integrity protected and ciphered in PDCP layer using the new RRC keys.\nIf the UP security activation status can be supported in the target gNB/ng-eNB, the target gNB/ng-eNB shall use the UP security activations that the UE used at the last source cell. Otherwise, the target gNB/ng-eNB shall respond with an RRC Setup message to establish a new RRC connection with the UE.\nWhen the UE receives the RRCResume message, the UE shall decrypt the message using the KRRCenc that was derived based on the newly derived KNG-RAN*. The UE shall also verify the <RRC Connection Resume> message by verifying the PDCP MAC-I using the KRRCint that was derived from the newly derived KNG-RAN* If verification of the RRCResume message is successful, the UE shall delete the current KRRCint key and the UE shall save the KRRCint, KRRCenc, KUPenc (optionally), and KUPint (optionally) from the newly derived KNG-RAN* as part of the UE current AS security context. In this case, the UE shall send the RRCResumeComplete message both integrity protected and ciphered to the target gNB/ng-eNB on SRB1 using the current KRRCint and KRRCenc. The UE shall use the UP security activations that were used before tansition to the RRC Inactive.\nIf the UE receives RRCReject message from the target gNB/ng-eNB in response to the UE <RRC Resume Request> message, the UE shall delete newly derived AS keys used for connection resumption attempt, including newly derived KNG-RAN*, newly derivedRRC integrity key, RRC encryption key and UP keys, and keep the current KRRCint and the KgNB/NH in its current AS context.\nSecurity is fully resumed on UE side after reception and processing of RRCResume message. The UE can receive data on DRB(s) after having received and processed RRC connection resume message. UL data on DRB(s) can be sent after RRCResumeComplete message has been successfully sent.\nAfter a successful transition from RRC_INACTIVE to RRC_CONNECTED the target gNB/ng-eNB shall perform Path Switch procedure with the AMF. The AMF shall verify the UE security capability as described in the clause 6.7.3.1, and the SMF shall veirfy the UE security policy as described in the clause 6.6.1.\nThe target gNB/ng-eNB may be the same as the source gNB/ng-eNB in the description in the previous subclause. If so, the single gNB/ng-eNB performs the roles of both the source and target gNB/ng-eNB.\nThe purpose of this procedure is to allow the UE to notify the network if it moves out of the configured RNA (RAN-based Notification Area) or if UE initiates a periodic RAN-based notification area update procedure. The UE and gNB store the AS security context in RRC_INACTIVE state and reactivate the AS security context when the UE initiates the RAN-based Notification Area Update (RNAU) procedure. The ng-eNB connected to 5GC shall also support the same key handling during mobility in RRC_INACTIVE.\nWhen the UE decides to initiate the RANU procedure the UE may initiate the procedure with a new gNB/ng-eNB. In this case, the UE, the target gNB/ng-eNB and the source gNB/ng-eNB follow the detailed procedure as described in clause 6.8.2.1.3 with the following deviations:\nThe target gNB/ng-eNB shall check if it supports the ciphering and integrity algorithms the UE used with the last source cell. If the target gNB/ng-eNB does not support the ciphering and integrity algorithms used in the last source cell or if the target gNB/ng-eNB prefers to use different algorithms than the source gNB/ng-eNB, then the target gNB/ng-eNB shall send an RRCSetup message on SRB0 to the UE in order to proceed with RRC connection establishment as if the UE was in RRC_IDLE (i.e., fallback procedure).\nIf the target gNB/ng-eNB selects the ciphering and integrity protection algorithms which the UE used with the last source cell and the target gNB/ng-eNB decides to send the UE directly back to RRC_INACTIVE state without bringing the UE to RRC_CONNECTED state, the target gNB/ng-eNB shall perform a Path Switch procedure with the AMF to get a fresh {NCC, NH} pair before sending the RRCRelease message to the UE. After the target gNB/ng-eNB receives a fresh {NCC, NH} pair in the Path Switch Acknowledgement message from the AMF, the target gNB/ng-eNB shall set the value of NCC in the RRCRelease message to the NCC value of the received fresh {NCC, NH} pair.\nAfter the source gNB/ng-eNB (old gNB/ng-eNB) validates the ResumeMAC-I/shortResumeMAC-I received from the target gNB/ng-eNB (new gNB/ng-eNB) in the RETRIEVE UE CONTEXT REQUEST message, the old gNB/ng-eNB may decide not to relocate the UE context to the new gNB/ng-eNB. In this case, the old gNB/ng-eNB builds the RRCRelease message (MSG4) with a fresh I-RNTI, integrity protect it and encrypt it using the RRC keys that were derived from the new KgNB* similar to RRCResume message (MSG4) protection as specified in clause 6.8.2.1.3. Then, the old gNB/ng-eNB sends the integrity protected and encrypted RRCRelease message to the new gNB/ng-eNB in the RETRIEVE UE CONTEXT FAILURE message.\nWhen the UE decides to initiate a periodic RNAU procedure, the target gNB/ng-eNB may be the same as the source gNB/ng-eNB. If so the single gNB/ng-eNB (same gNB/ng-eNB) performs the roles of both the source gNB/ng-eNB and the target gNB/ng-eNB.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.9\tSecurity handling in mobility",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.9.1\tVoid",
                            "text_content": "",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.9.2\tKey handling in handover",
                            "text_content": "The general principle of key handling for KNG-RAN*/NH at handovers is depicted in Figure 6.9.2.1.1-1.\nThe figure depicts a handover key chaining model, which is a key component of the handover process in 5G networks. It illustrates the steps involved in transferring control from one network to another, including the handover key, which is a unique identifier used to identify the network being transferred. The figure also shows the handover key chaining process, which involves the use of a handover key to establish a connection between the two networks. The model is important for ensuring the smooth and efficient handover process in 5G networks.\nFigure 6.9.2.1.1-1: Model for the handover key chaining\nThe following is an outline of the key handling model to clarify the intended structure of the key derivations. The detailed specification is provided in sub-clauses 6.9.2.2 and 6.9.2.3.\nWhenever an initial AS security context needs to be established between UE and gNB/ng-eNB, AMF and the UE shall derive a KgNB and a Next Hop parameter (NH). The KgNB and the NH are derived from the KAMF. A NH Chaining Counter (NCC) is associated with each KgNB and NH parameter. Every KgNB is associated with the NCC corresponding to the NH value from which it was derived. At initial setup, the KgNB is derived directly from KAMF, and is then considered to be associated with a virtual NH parameter with NCC value equal to zero. At initial setup, the derived NH value is associated with the NCC value one.\nNOTE 1:\tAt the UE, the NH derivation associated with NCC=1 could be delayed until the first handover performing vertical key derivation.\nNOTE 1a:\tIn N2 handover, when the KgNB is updated either due to KAMF change or synchronising the AS security context with the NAS security context, the KgNB is derived as specified in clauses 6.9.2.3.3 and 6.9.2.3.4 of the present document. In inter-RAT handover, the KgNB is derived as specified in clause 8.4 of the present document. In UE context modification, the KgNB is derived as specified in clause 6.9.2.2.\nWhether the AMF sends the KgNB key or the {NH, NCC} pair to the serving gNB/ng-eNB is described in detail in sub-clauses 6.9.2.2 and 6.9.2.3. The AMF shall not send the NH value to gNB/ng-eNB at the initial connection setup. The gNB/ng-eNB shall initialize the NCC value to zero after receiving NGAP Initial Context Setup Request message.\nNOTE 2:\tSince the AMF does not send the NH value to gNB/ng-eNB at the initial connection setup, the NH value associated with the NCC value one cannot be used in the next Xn handover or the next intra-gNB/intra-ng-eNB-CU handover, for the next Xn handover or the next intra-gNB-CU/intra-ng-eNB handover the horizontal key derivation (see Figure 6.9.2.1.1-1) will apply.\nNOTE 3:\tOne of the rules specified for the AMF in sub-clause 6.9.2.3.3 of the present document states that the AMF always computes a fresh {NH, NCC} pair that is given to the target gNB/ng-eNB. An implication of this is that the first {NH, NCC} pair will never be used to derive a KgNB. It only serves as an initial value for the NH chain.\nThe UE and the gNB/ng-eNB use the KgNB to secure the communication between each other. On handovers and at transitions from RRC_INACTIVE to RRC_CONNECTED states (defined in clause 6.8.2.1), the basis for the KgNB that will be used between the UE and the target gNB/ng-eNB, called KNG-RAN*, is derived from either the currently active KgNB or from the NH parameter. If KNG-RAN* is derived from the currently active KgNB this is referred to as a horizontal key derivation (see Figure 6.9.2.1.1-1) and if the KNG-RAN* is derived from the NH parameter the derivation is referred to as a vertical key derivation (see Figure 6.9.2.1.1-1).\nAs NH parameters are only computable by the UE and the AMF, it is arranged so that NH parameters are provided to gNB/ng-eNBs from the AMF in such a way that forward security can be achieved.\nOn handovers with vertical key derivation the NH is further bound to the target PCI and its frequency ARFCN-DL before it is taken into use as the KgNB in the target gNB/ng-eNB. On handovers with horizontal key derivation the currently active KgNB is further bound to the target PCI and its frequency ARFCN-DL before it is taken into use as the KgNB in the target gNB/ng-eNB.\nDuring mobility, NAS aspects that need to be considered are the possible KAMF change, the possible NAS algorithm change at AMF change, and the possible presence of a parallel NAS connection. There is the possibility that the source AMF and the target AMF do not support the same set of NAS algorithms or have different priorities regarding the use of NAS algorithms. In this case, the target AMF re-derives the NAS keys from the existing KAMF (if unchanged) or derives the NAS keys from the new KAMF (if changed) using the NAS algorithm identities and NAS algorithm types as input to the NAS key derivation functions (see Annex A.8). When the KAMF has not changed, all inputs, in particular the KAMF, will be the same in the re-derivation except for the NAS algorithm identity. When the KAMF has changed, new NAS keys are derived irrespective of change in NAS algorithms.\nIn case the KAMF has changed or the target AMF decides to use NAS algorithms different from the ones used by the source AMF, the target AMF shall provide needed parameters to the UE as defined in Clause 6.9.2.3.3 for N2-Handover (i.e., using NAS Container) and Clause 6.9.3 for mobility registration update (i.e., using NAS SMC).\nNOTE 1:\tIt is per operator's policy how to configure selection of handover types. Depending on an operator's security requirements, the operator can decide whether to have Xn or N2 handovers for a particular gNB/ng-eNB according to the security characteristics of a particular gNB/ng-eNB.\nNOTE 2:\tFollowing key change indicators are involved with N2 handovers. 1) Source AMF indicates AS key re-keying required meaning that the KAMF sent by source AMF to the target AMF is not in sync with current gNB/ng-eNB with keyAmfChangeInd (KAMF Change Indicator). 2) Source AMF indicates that the KAMF sent by source AMF to target AMF has been calculated using horizontal KAMF derivation with keyAmfHDerivationInd  (KAMF Horizontal Derivation Indicator). 3) The target AMF indicates a horizontal KAMF derivation to the UE with K_AMF_change_flag in the NAS Container to tell the NAS layer of the UE to change KAMF. 4). The target AMF indicates anAS key re-keying  to the gNB/ng-eNB with NSCI (New Security Context Indicator). 5) The gNB/ng-eNB indicates a AS re-keying to the UE with keySetChangeIndicator so that the AS layer of the UE knows that new KgNB needs to be derived from new KAMF instead of NH, and NCC needs to be reset to zero.\nAs outlined in clause 6.9.2.1, whenever a fresh KgNB is calculated from the KAMF, the AMF shall transfer the KgNB to the serving ng-eNB/gNB in a message modifying the security context in the ng-eNB/gNB. The AMF and the UE shall compute the fresh KgNB as defined in Annex A.9 according to the rules in clause 6.9.6.4. An NCC value 0 is associated with the fresh KgNB. From the fresh KgNB, the ng-eNB/gNB and the UE shall compute the KNG-RAN* as described in Annex A.11 and A.12  and then use the computed KNG-RAN*  as the KgNB/KeNB as described in clause 6.9.4.4.\nNOTE 1: Unlike EPS, in 5GS the NAS and the AS security contexts are synchronized as a part of handover procedure, if a handover is occurring. See sub-clauses under the clause 6.9.2.3 (key derivations during handover) of the present document.\nThe gNB shall have a policy deciding at which intra-gNB -CU handovers the KgNB can be retained and at which a new KgNB needs to be derived. At an intra-gNB-CU handover, the gNB shall indicate to the UE whether to change or retain the current KgNB in the HO Command message. Retaining the current KgNB shall only be done during intra-gNB-CU handover.\nNOTE: \tThe option of retaining the KeNB at intra-ng-eNB handover is not supported in ng-eNB.\nIf the current KgNB is to be changed, the gNB/ng-eNB and the UE shall derive a KNG-RAN* as in Annex A.11/A.12 using target PCI, its frequency ARFCN-DL/EARFCN-DL, and either NH or the current KgNB depending on the following criteria: the gNB shall use the NH for deriving KNG-RAN* if an unused {NH, NCC} pair is available in the gNB (this is referred to as a vertical key derivation), otherwise if no unused {NH, NCC} pair is available in the gNB, the gNB shall derive KNG-RAN* from the current KgNB (this is referred to as a horizontal key derivation). The gNB shall send the NCC used for the KNG-RAN*derivation to UE in HO Command message. The gNB/ng-eNB and the UE shall use the KNG-RAN* as the KgNB, after handover.\nIf the current KgNB is to be retained, the gNB and the UE shall continue using the current KgNB, after handover.\nNOTE 1:\tThis clause is also applicable when gNB is implemented as a single unit, i.e., when the gNB is not split into CU and DU.\nNOTE 2: The key derivation mechanism described in this clause is also applicable to CHO defined in TS 38.300[52].\nIn Xn handovers the source gNB/ng-eNB shall perform a vertical key derivation in case it has an unused {NH, NCC} pair. The source gNB/ng-eNB shall first compute KNG-RAN* from target PCI, its frequency ARFCN-DL/EARFCN-DL, and either from currently active KgNB in case of horizontal key derivation or from the NH in case of vertical key derivation as described in Annex A.11/A.12.\nNext, the source gNB/ng-eNB shall forward the { KNG-RAN*, NCC} pair to the target gNB/ng-eNB. The target gNB/ng-eNB shall use the received KNG-RAN* directly as KgNB to be used with the UE. The target gNB/ng-eNB shall associate the NCC value received from source gNB/ng-eNB with the KgNB. The target gNB/ng-eNB shall include the received NCC into the prepared HO Command message, which is sent back to the source gNB/ng-eNB in a transparent container and forwarded to the UE by source gNB/ng-eNB.\nWhen the target gNB/ng-eNB has completed the handover signalling with the UE, it shall send a NGAP PATH SWITCH REQUEST message to the AMF. Upon reception of the NGAP PATH SWITCH REQUEST, the AMF shall increase its locally kept NCC value by one and compute a new fresh NH from its stored data using the function defined in Annex A.10. The AMF shall use the KAMF from the currently active 5G NAS security context for the computation of the new fresh NH. The AMF shall then send the newly computed {NH, NCC} pair to the target gNB/ng-eNB in the NGAP PATH SWITCH REQUEST ACKNOWLEDGE message. The target gNB/ng-eNB shall store the received {NH, NCC} pair for further handovers and remove other existing unused stored {NH, NCC} pairs if any.\nIf the AMF had activated a new 5G NAS security context with a new KAMF, different from the 5G NAS security context on which the currently active 5G AS security context is based, but has not yet successfully performed a UE Context Modification procedure, the sent NGAP PATH SWITCH REQUEST ACKNOWLEDGE message shall in addition contain a NSCI (New Security Context Indicator). The AMF shall in this case derive a new initial KgNB from the new KAMF and the uplink NAS COUNT in the most recent NAS Security Mode Complete message as specified in Annex A.9. The AMF shall associate the derived new initial KgNB with a new NCC value equal to zero. Then, the AMF shall use {the derived new initial KgNB, the new NCC value initialized to zero} pair as the newly computed {NH, NCC} pair to be sent in the NGAP PATH SWITCH REQUEST ACKNOWLEDGE message. The gNB/ng-eNB shall in this case set the value of keySetChangeIndicator field to true in further handovers. The gNB/ng-eNB should in this case perform an intra-gNB-CU/intra-ng-eNB handover immediately .\nNOTE 1:\tBecause the NGAP PATH SWITCH REQUEST message is transmitted after the radio link handover, it can only be used to provide keying material for the next handover procedure. Thus, for Xn-handovers key separation happens only after two hops because the source gNB/ng-eNB knows the target gNB/ng-eNB keys. The target gNB/ng-eNB can immediately initiate an intra-gNB-CU/intra-ng-eNB handover to take the new NH into use once the new NH has arrived in the PATH SWITCH REQUEST ACKNOWLEDGE message.\nNOTE 2: The key derivation mechanism described in this clause is also applicable to CHO defined in TS 38.300[52].\nUpon reception of the NGAP HANDOVER REQUIRED message, if the source AMF does not change the active KAMF (meaning no horizontal KAMF derivation) and if AS key re-keying is not required, the source AMF shall increment its locally kept NCC value by one and compute a fresh NH from its stored data using the function defined in Annex A.10. The source AMF shall use the KAMF from the currently active 5GS NAS security context for the computation of the fresh NH. The source AMF shall send the fresh {NH, NCC} pair to the target AMF in the Namf_Communication_CreateUEContext Request message. The Namf_Communication_CreateUEContext Request message shall in addition contain the KAMF that was used to compute the fresh {NH, NCC} pair and its corresponding ngKSI and corresponding uplink and downlink NAS COUNTs.\nIf the source AMF had activated a new 5G NAS security context with a new KAMF, different from the 5G NAS security context on which the currently active 5G AS security context is based, but has not yet performed a UE Context Modification procedure, the Namf_Communication_CreateUEContext Request message shall in addition contain an indication that the KAMF sent by source AMF to target AMF is not in sync with the current KgNB used between the UE and the source gNB (i.e., keyAmfChangeInd) which means that AS key re-keying is required at the UE. Further, the source AMF shall derive a new KgNB associated with NCC=0 using the new KAMF and the uplink NAS COUNT from the last successful NAS SMC procedure with the UE and provide the {NH= newly derived KgNB, NCC=0} pair to the target AMF in the Namf_Communication_CreateUEContext Request message.\nThe source AMF uses its local policy to determine whether to perform horizontal KAMF derivation on currently active KAMF. If horizontal KAMF derivation is performed, the Namf_Communication_CreateUEContext Request shall contain an indication (i.e., keyAmfHDerivationInd ) that the new KAMF has been calculated, an indication (i.e., keyAmfChangeInd) that AS key re-keying is required at the UE, and the downlink NAS COUNT used in the horizontal derivation of the sent KAMF. The ngKSI for the newly derived KAMF key has the same value and the same type as the ngKSI of the current KAMF. Further, the source AMF shall derive a new KgNB associated with NCC=0 using the newly derived KAMF and the uplink NAS COUNT value of 232-1 as defined in Annex A.9. The source AMF shall include the{NH=newly derived KgNB, NCC=0} pair and the ngKSI for the newly derived KAMF key in the Namf_Communication_CreateUEContext Request as well.\nNOTE a:\tThe uplink NAS COUNT value for the initial KgNB derivation is set to 232-1. The reason for choosing such a value is to avoid any possibility that the value may be used to derive the same KgNB again.\nThe source AMF shall always increment the downlink NAS COUNT by one after sending the Namf_Communication_CreateUEContext Request message to the target AMF.\nUnlike the S10 FORWARD RELOCATION REQUEST message in EPS, the Namf_Communication_CreateUEContext Request message in 5G shall not contain data and meta-data related to old 5G security context.\nNOTE 1:\tVoid.\nIf the target AMF receives the indication of horizontal KAMF derivation (i.e., keyAmfHDerivationInd), it shall derive the NAS keys from the received KAMF as specified in clause A.8 and set the NAS COUNTs to zero. The target AMF shall create a NASC (NAS Container) containing the K_AMF_change_flag, the received downlink NAS COUNT, ngKSI, selected NAS security algorithms, and NAS MAC. The K_AMF_change_flag is set to one when the target AMF receives keyAmfHDerivationInd_. Otherwise, the K_AMF_change_flag is set to zero. If the target AMF does not receive keyAmfHDerivationInd but wants to change the NAS algorithms, it shall create a NASC using the selected NAS security algorithms in the same manner as the case for the horizontal KAMF derivation. However, the target AMF shall not set the NAS COUNTs to zero.\nThe target AMF shall calculate a 32-bit NAS MAC over the parameters included in the NASC using the KNASint key. The input parameters to the NAS 128-bit integrity algorithms as described in Annex D.3 shall be set as follows when calculating NAS MAC.\nThe calculation of NAS MAC shall be the 32-bit output of the selected NIA and shall use the following inputs:\n- \tKEY\t\t\t: it shall be set to the corresponding KNASint;\n-\tCOUNT\t\t: it shall be set to 232-1;\n-\tMESSAGE\t: it shall be set to the content of NAS Container as defined in TS 24.501 [35];\n-\tDIRECTION\t: its bit shall be set to 1; and\n-\tBEARER\t\t: it shall be set to the value of the NAS connection identifier for 3GPP access.\nThe use of the 232-1 as the value of the COUNT for the purpose of NAS MAC calculation/verification does not actually set the NAS COUNT to 232-1. The reason for choosing such a value not in the normal NAS COUNT range, i.e., [0, 224-1] is to avoid any possibility that the value may be reused for normal NAS messages.\nReplay protection is achieved by the UE checking if the downlink NAS COUNT included in the NAS Container is replayed or not. The UE shall not accept the same downlink NAS COUNT value twice before a newly derived KAMF is taken into use and the corresponding downlink NAS COUNT is set to zero. The target AMF shall increment the downlink NAS COUNT by one after creating a NASC.\nThe NASC is included in the NGAP HANDOVER REQUEST message to the target ng-eNB/gNB. The purpose of this NASC could be compared to a NAS SMC message. If the target AMF receives the keyAmfChangeInd, it shall further send the received {NCC, NH} pair and the New Security Context Indicator (NSCI) to the target ng-eNB/gNB within the NGAP HANDOVER REQUEST message. The target AMF shall further set the NCC to one and shall further compute a NH as specified in Annex A.10. The target AMF shall further store the {NCC=1, NH} pair.\nNOTE 1a: VoidNOTE 2: The NAS Container (NASC) is defined as Intra N1 mode NAS transparent container in TS 24.501 [35].\nNOTE 3: The downlink NAS COUNT is always included in the Namf_Communication_CreateUEContext Request and used by the target AMF for NAS MAC computation. This provides replay protection for NASC.\nIf the target AMF does not receive the keyAmfChangeInd, it shall store locally the KAMF and {NH, NCC} pair received from the source AMF and then send the received {NH, NCC} pair to the target ng-eNB/gNB within the NGAP HANDOVER REQUEST message.\nUpon receipt of the NGAP HANDOVER REQUEST message from the target AMF, the target ng-eNB/gNB shall compute the KNG-RAN* to be used with the UE by performing the key derivation defined in Annex A.11 and A.12 with the {NH, NCC} pair received in the NGAP HANDOVER REQUEST message and the target PCI and its frequency ARFCN-DL/EARFCN-DL. The gNB uses the KNG-RAN* corresponding to the selected cell as KgNB. The ng-eNB uses the KNG-RAN* corresponding to the selected cell as KeNB. The target ng-eNB/gNB shall associate the NCC value received from AMF with the KgNB/KeNB. The target ng-eNB/gNB shall include the NCC value from the received {NH, NCC} pair, and the NASC if such was also received, into the HO Command message to the UE and remove any existing unused stored {NH, NCC} pairs. If the target ng-eNB/gNB had received the NSCI, it shall set the keySetChangeIndicator field in the HO Command message to true.\nNOTE 4:\tThe source AMF may be the same as the target AMF in the description in this sub-clause. If so the single AMF performs the roles of both the source and target AMF. In this case, actions related to N14 messages are handled internally in the single AMF.\nThe UE behaviour is the same regardless if the handover is intra-gNB-CU, intra ng-eNB, Xn, or N2 with the exception that during intra-gNB-CU handover, the UE may retain the same key based on an indication from the gNB. The UE behaviour is also same in case of conditional handover, as specified in TS 38.300 [52], i.e., the UE shall use the parameters of the selected target cell in KNG-RAN* derivations.\nIf the UE also receives a NASC (NAS Container) in the HO Command message, the UE shall update its NAS security context as follows:\nNOTE 1: The purpose of this NASC could be compared to a NAS SMC message.\n-\tThe UE shall verify the freshness of the downlink NAS COUNT in the NASC.\n-\tIf the NASC indicates a new KAMF has been calculated (i.e., K_AMF_change_flag is one),\n-\tThe UE shall compute the horizontally derived KAMF using the KAMF from the current 5G NAS security context identified by the ngKSI included in the NASC and the downlink NAS COUNT in the NASC, as specified in Annex A.13.\n-\tThe UE shall assign the ngKSI included in the NASC to the ngKSI of the new derived KAMF. The UE shall further configure NAS security based on the horizontally derived KAMF and the selected NAS security algorithms in the NASC.\n-\tThe UE shall further verify the NAS MAC in the NASC as described in Clause 6.9.2.3.3 and if the verification is successful, the UE shall further set the NAS COUNTs to zero.\n-\tIf KAMF change is not indicated,\n-\tIf the verification is successful, the UE shall configure the NAS security based on the parameters included in the NASC but shall not set the NAS COUNTs to zero.\n-\tThe UE shall verify the NAS MAC in the NASC.\n-\tThe UE shall further set the downlink NAS COUNT value of the currently active NAS security context to the received downlink NAS COUNT value in the NASC.\nIf verification of the NASC fails, the UE shall abort the handover procedure. Furthermore, the UE shall discard the new NAS security context if it was derived and continue to use the existing NAS and AS security contexts.\nIf keySetChangeIndicator in the HO command is true\n-\tIf the HO Command message contained a NASC parameter with the K_AMF_change_flag set to one:\n-\tThe UE shall use the horizontally derived KAMF and the NAS COUNT value of 232-1 in the derivation of the temporary KgNB. The UE shall further process this temporary key as described in subclause 6.9.4.4.\n-\tElse:\n-\tThe UE handling related to key derivation shall be done as defined in clause 6.9.4.4.\nElse\n-\tIf the NCC value the UE received in the HO Command message from target ng-eNB/gNB via source ng-eNB/gNB is equal to the NCC value associated with the currently active KgNB/KeNB, the UE shall derive the KNG-RAN* from the currently active KgNB/KeNB and the target PCI and its frequency ARFCN-DL/EARFCN-DL using the function defined in Annex A.11 and A.12.\n-\tIf the UE received an NCC value that was different from the NCC associated with the currently active KgNB/KeNB, the UE shall first synchronize the locally kept NH parameter by computing the function defined in Annex A.10 iteratively (and increasing the NCC value until it matches the NCC value received from the source ng-eNB/gNB via the HO command message. When the NCC values match, the UE shall compute the KNG-RAN* from the synchronized NH parameter and the target PCI and its frequency ARFCN-DL/EARFCN-DL using the function defined in Annex A.11 and A.12.\nThe UE shall use the KNG-RAN* as the KgNB when communicating with the target gNB and as the KeNB when communicating with the target ng-eNB.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.9.3\tKey handling in mobility registration update",
                            "text_content": "The procedure shall be invoked by the target AMF after the receiving of a Registration Request message of type mobility registration update from the UE wherein the UE and the source AMF are identified by means of a temporary identifier 5G-GUTI.\nThe protocol steps for the source AMF and target AMF performing context transfer are as follows:\na)\tThe target AMF sends a message to the source AMF, this message contains the 5G-GUTI, the Access Type and the received Registration Request message.\nb)\tThe source AMF searches the data of the UE in the database and checks the integrity protection on the Registration Request message. The source AMF uses the 5G NAS security context corresponding to the Access Type to perform the integrity check.\ni)\tIf the UE is found and the integrity check succeeds, when the source AMF does not change KAMF according to its local policy, the source AMF shall send a response back that:\n-\tshall include the SUPI, and\n-\tmay include any current 5G security context it holds.\nii)\tIf the UE is found and the integrity check succeeds, when the source AMF changes KAMF according to its local policy, the source AMF shall send a response back that:\n-\tshall include the SUPI,\n-\tkeyAmfHDerivationInd, and\n-\tmay include a new 5G security context it derives from the current one it holds.\nThe source AMF subsequently deletes the 5G security context which it holds.\nIf the UE cannot be identified or the integrity check fails, then the source AMF shall send a response indicating that the temporary identifier 5G-GUTI cannot be retrieved.\nc)\tIf the target AMF receives a response with a SUPI, it creates an entry and stores the 5G security context that may have beenreceived .\nIf the target AMF receives a response indicating that the UE could not be identified, it shall initiate the subscription identification procedure described in clause 6.12.4 of the present document.\nNOTE: \tVoid.\nNOTE 1: The source AMF does not have KSEAF because it is deleted after KAMF derivation as per clause 6.2.2.1 and therefore the context transfer from the source AMF to the target AMF does not contain KSEAF.\nAt mobility registration update, the source AMF shall use local policy to determine whether to perform horizontal KAMF derivation. If the source AMF determines not to perform horizontal KAMF derivation, the source AMF shall transfer current security context to the target AMF. If the source AMF determines to perform horizontal KAMF derivation, the source AMF shall derive a new key KAMF from the currently active KAMF and the uplink NAS COUNT value in the received Registration Request message. The ngKSI for the newly derived KAMF key is defined such as the value field and the type field are taken from the ngKSI of the current KAMF. The source AMF shall transfer the new KAMF, the new ngKSI, the UE security capability, the  keyAmfHDerivationInd to the target AMF. The key derivation of the new KAMF is specified in Annex A.13. If the source AMF has derived a new key KAMF, the source AMF shall not transfer the old KAMF to the target AMF and the source AMF shall in this case also delete any stored non-current 5G security context, and not transfer any non-current 5G security context to the target AMF.\nWhen the target AMF receives the new KAMF together with the  keyAmfHDerivationInd, then the target AMF shall decide whether to use the KAMF directly according to its local policy after receiving the response from the source AMF.\nIf the target AMF, according to its local policy, decides to not use the KAMF received from the source AMF, it can perform a re-authentication procedure to the UE to establish a new NAS security context.\nIf the target AMF decides to use the key KAMF received from source AMF (i.e., no re-authentication), it shall send the  K_AMF_change_flag set to 1 to the UE in the NAS SMC including replayed UE security capabilities, the selected NAS algorithms and the ngKSI for identifying the new KAMF from which the UE shall derive a new KAMF to establish a new NAS security context between the UE and target AMF.\nThe target AMF shall reset the NAS COUNTs to zero and derive new NAS keys (KNASint and KNASenc) from the new KAMF using the selected NAS algorithm identifiers as input. The target AMF shall integrity protect the NAS Security Mode Command message with the new KNASint key.\nIf the UE receives the  K_AMF_change_flag set to 1 in the NAS Security Mode Command message, then the UE shall derive a new key KAMF from the current active KAMF identified by the received ngKSI in the NAS Security Mode Command message using the uplink NAS COUNT valuethat was sent in the Registration Request message. The UE shall assign the received ngKSI in the NAS Security Mode Command message to the ngKSI of the new derived KAMF. The UE shall derive new NAS keys (KNASint and KNASenc) from the new KAMF and integrity check the NAS Security Mode Command message using the new KNASint key.\nThe UE shall then derive a new initial KgNB from the new KAMF as specified in Annex A.9.\nThe UE shall associate the derived new initial KgNB with a new NCC value equal to zero and reset the NAS COUNTs to zero.\nAfter the ongoing mobility registration procedure is successfully completed, the ME shall replace the currently stored KAMF and ngKSI values on both USIM and ME with the new KAMF and the associated ngKSI.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.9.4\tKey-change-on-the-fly",
                            "text_content": "Key change on-the-fly consists of key refresh or key re-keying.\nKey refresh shall be possible for KgNB, KRRC-enc, KRRC-int, KUP-enc, and KUP-int (if available ) and shall be initiated by the gNB/ng-eNB when a PDCP COUNTs are about to be re-used with the same Radio Bearer identity and with the same KgNB. The procedure is described in clause 6.9.4.5.\nKey re-keying shall be possible for the KgNB, KRRC-enc, KRRC-int, KUP-enc, and KUP-int (if available). This re-keying shall be initiated by the AMF when a 5G AS security context different from the currently active one shall be activated. The procedures for doing this are described in clause 6.9.4.4.\nAS Key change on-the-fly is accomplished using a procedure based on intra-cell handover. The following AS key changes on-the-fly shall be possible: local KgNB refresh (performed when PDCP COUNTs are about to wrap around), KgNB re-keying performed after an AKA run, activation of a native context after handover from E-UTRAN.\nKey re-keying shall be possible for KNAS-enc and KNAS-int. Re-keying of KNAS-enc and KNAS-int shall be initiated by the AMF when a 5G NAS security context different from the currently active one shall be activated. The procedures for doing this are described in clause 6.9.4.2.\nRe-keying of the entire 5G key hierarchy including KAMF shall be achieved by first re-keying KAMF, then KNAS-enc and KNAS-int, followed by re-keying of the KgNB and derived keys. For NAS key change on-the-fly, activation of NAS keys is accomplished by a NAS SMC procedure.\nAfter a primary authentication has taken place, new NAS keys from a new KAMF shall be derived, according to Annex A.8.\nTo re-activate a non-current full native 5G security context after handover from E-UTRAN the UE and the AMF take the NAS keys into use by running a NAS SMC procedure according to clause 6.7.2.\nAMF shall activate fresh NAS keys from a primary authentication run or activate native security context, which has a sufficiently low NAS COUNT values, before the NAS uplink or downlink COUNT wraps around with the current security context.\nIf the AMF determines that NAS key refresh is required due to e.g. uplink or downlink NAS counter in the current security context is about to wrap around or based on a local operator policy to refresh the NAS keys after a certain time, the AMF may trigger a primary authentication run or may derive a new KAMF key using horizontal KAMF derivation upon the reception of an initial NAS message, e.g. a Registration Request or a Service Request using the uplink NAS COUNT value in the initial NAS message as described in clause 6.9.3 for mobility update registration. The AMF resets the corresponding uplink and downlink NAS counters and derive new NAS keys from the new KAMF key and the algorithms in use. The AMF activates the new KAMF key by running a NAS SMC with UE according to clause 6.7.2. When the new KAMF key is horizontally derived, the UE shall use the uplink NAS COUNT value that was sent in the initial NAS message to derive the same KAMF key as the AMF, reset the corresponding uplink and downlink NAS counters and then derive new NAS keys from the KAMF and the algorithms in use.\nIn this case, if AS security is also established between the UE and gNB/ng-eNB, then the AMF and the UE shall derive a new initial KgNB from the new KAMF as specified in Annex A.9. Further, the AMF and the UE shall associate the derived new initial KgNB with a new NCC value equal to zero. Further, the derived new initial KgNB/KeNB is sent by the AMF to the gNB/ng-eNB triggering the gNB/ng-eNB to perform the AS key re-keying as described in clause 6.9.4.4.\nThe KgNB/KeNB re-keying procedure is initiated by the AMF. It may be used under the following conditions:\n-\tafter a successful AKA run with the UE as part of activating a partial native 5G security context; or\n-\tas part of synchronizing the NAS and the AS security contexts as a part of handover procedure, if a handover is occuring; or\n-\tas part of re-activating a non-current full native 5G security context after handover from E-UTRAN according to  clause 8.4; or\n-\tto create a new KgNB from the current KAMF.\nNOTE 1: To perform a key change on-the-fly of the entire key hierarchy, the AMF has to change the 5G NAS security context before changing the 5G AS security context.\nIn order to be able to re-key the KgNB, the AMF requires a fresh uplink NAS COUNT from a successful NAS SMC procedure with the UE. In the case of creating a new KgNB from the current KAMF a NAS SMC procedure shall be run first to provide this fresh uplink NAS COUNT. This NAS SMC procedure does not have to change other parameters in the current EPS NAS security context. The AMF derives the new KgNB using the key derivation function as specified in Annex  A.9 using the KAMF and the uplink NAS COUNT used in the most recent NAS Security Mode Complete message. The derived new KgNB is sent to the gNB/ng-eNB in an NGAP UE CONTEXT MODIFICATION REQUEST message triggering the gNB/ng-eNB to perform the AS key re-keying. The gNB/ng-eNB runs the key change on-the-fly procedure with the UE. During this procedure the gNB/ng-eNB shall indicate to the UE that a key change on-the-fly is taking place. The procedure used is based on an intra-cell handover, and hence the same KgNB derivation steps shall be taken as in a normal handover procedure. The gNB/ng-eNB shall indicate to the UE to change the current KgNB in intra-cell handover during this procedure. Network-side handling of AS key re-keying that occur as a part of Xn and N2 handovers are described is defined in clauses 6.9.2.3.2 and 6.9.2.3.3 of the present document.\nWhen the UE receives an indication that the procedure is a key change on-the-fly procedure, the UE shall derive a temporary KgNB by applying the key derivation function as specified in Annex A.9 using the KAMF from the current 5G NAS security context and the uplink NAS COUNT in the most recent NAS Security Mode Complete message. UE-side handling of AS key re-keying that occur as a part of Xn and N2 handovers is described in clause 6.9.2.3.4 of the present document.\nFrom this temporary KgNB the UE shall derive the KNG-RAN* as normal (see Annex A.11/A.12). The gNB/ng-eNB shall take the KgNB it received from the AMF, which is equal to the temporary KgNB, as basis for its KNG-RAN* derivations. From this step onwards, the key derivations continue as in a normal handover.\nIf the AS level re-keying fails, then the AMF shall complete another NAS security mode procedure before initiating a new AS level re-keying. This ensures that a fresh KgNB is used.\nThe NH parameter shall be handled according to the following rules:\n-\tThe UE, AMF, and gNB/ng-eNB shall delete any old NH upon completion of the context modification.\n-\tThe UE and AMF shall use the KAMF from the currently active 5G NAS security context for the computation of the fresh NH. The computation of NH parameter value sent in the Namf_Communication_CreateUEContext Request, NGAP HANDOVER REQUEST, and NGAP PATH SWITCH REQUEST ACKNOWLEDGE messages shall be done according to clauses 6.9.2.3.2 and 6.9.2.3.3.\nThis procedure is based on an intra-cell handover. The KgNB chaining that is performed during a handover ensures that the KgNB is re-freshed with respect to the RRC and UP COUNT after the procedure. The gNB/ng-eNB shall indicate to the UE to change the current KgNB in intra-cell handover during this procedure.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.9.5\tRules on concurrent running of security procedures",
                            "text_content": "Concurrent runs of security procedures may, in certain situations, lead to mismatches between security contexts in the network and the UE. In order to avoid such mismatches, the following rules shall be adhered to:\n1.\tAMF shall not initiate any of the N2 procedures including a new key towards a UE if a NAS Security Mode Command procedure is ongoing with the UE.\n2.\tThe AMF shall not initiate a NAS Security Mode Command towards a UE if one of the N2 procedures including a new key is ongoing with the UE.\n3.\tWhen the AMF has sent a NAS Security Mode Command to a UE in order to take a new KAMF into use and receives a request for an inter-AMF handover or an inter-RAT handover from the serving gNB/ng-eNB, the AMF shall wait for the completion of the NAS SMC procedure (i.e. receiving NAS Security Mode Complete) before initiating an inter-AMF handover or initiating an inter-RAT handover.\n4.\tWhen the AMF has initiated a NGAP UE Context Modification procedure in order to take a new KgNB into use, and receives a request for an inter-AMF handover from the serving gNB/ng-eNB, and decides not to change the KAMF for the inter-AMF handover, the AMF shall wait for the (successful or unsuccessful) completion of the UE Context Modification procedure before initiating an inter-AMF handover.\n5.\tOnce the source AMF has initiated inter-AMF handover to the target AMF, or inter-system handover to the target MME, the source AMF shall not send any downlink NAS messages to the UE until it is aware that the handover has either failed or has been cancelled.\n\nConcurrent runs of security procedures in parallel over two different NAS connections when terminated in the same AMF can lead to race conditions and mismatches between the security contexts in the network and the UE. In order to avoid such mismatches, the following rules shall be followed:\n1.\tThe SEAF/AMF shall not initiate a primary authentication or NAS SMC procedure in case a primary authentication or a NAS SMC procedure is ongoing on a parallel NAS connection. Authentication procedures followed by a NAS SMC procedures taking the new 5G security context into use, shall be performed on one NAS signalling connection at a time.\n2.\tWhen the AMF has sent a NAS Security Mode Command to a UE in order to take a new KAMF into use and receives a context transfer request message for the UE from another AMF, the AMF shall wait for the completion of the NAS SMC procedure (e.g. receiving NAS Security Mode Complete) before transferring the context.\n3.\tThe UE shall not initiate a NAS registration over a second NAS connection to an AMF of the same network before primary authentication on the first NAS connection is complete.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.9.6\tSecurity handling in registration with AMF reallocation via direct NAS reroute",
                            "text_content": "In registration with AMF reallocation via direct NAS reroute, the initial AMF shall send the complete Registration Request in clear text to the target AMF.\nNOTE:\tThe completeRegistration Request in clear text is obtained based on the Registration Request initially received by the initial AMF if the UE have a valid NAS sececurity context, or the Registration Request received by the initial AMF as part of the Security Mode Complete if it is executed.\nIn registration with AMF reallocation via direct NAS reroute, the initial AMF shall use its local policy to determine whether to perform horizontal KAMF derivation on current KAMF. As described in Clause 6.9.3, if the initial AMF decides not to change KAMF, the initial AMF shall send the current security context to the target AMF; otherwise, the initial AMF shall derive new security context and send to the target AMF the derived security context and the indication of horizontal KAMF derivation (i.e., keyAmfHDerivationInd).\nIf the target AMF receives the indication of horizontal KAMF derivation (i.e., keyAmfHDerivationInd) from the initial AMF, it shall initiate NAS SMC.  If the target AMF does not receive keyAmfHDerivationInd, the target AMF shall use the received security context from initial AMF and send protected NAS message including protected authentication request message if authentication is needed. The target AMF decides whether to perform authentication based on local policy.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.10\tDual connectivity",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.10.1\tIntroduction",
                            "text_content": "This clause describes the security functions necessary to support a UE that is simultaneously connected to more than one NG-RAN node, i.e., Multi-Radio dual connectivity (MR-DC) with 5GC as described in TS 37.340 [51]. The security functions are described in the context of the functions controlling the dual connectivity.\nThe dual connectivity protocol architecture for MR-DC with 5GC is shown in figure 6.10.1.2-1. The TS 37.340 [51] is to be referred for further details of the architecture illustrating MCG, SCG, and Split bearers for both SRBs and DRBs. The architecture has the following variants:\n-\tNG-RAN E-UTRA-NR Dual Connectivity (NGEN-DC) is the variant when the UE is connected to one ng-eNB that acts as a Master Node (MN) and one gNB that acts as a Secondary Node (SN). The ng-eNB is connected to the 5GC and the gNB is connected to the ng-eNB via Xn interface.\n-\tNR-E-UTRA Dual Connectivity (NE-DC) is the variant when the UE is connected to one gNB that acts as a MN and one ng-eNB that acts as a SN. The MN (i.e., gNB) is connected to 5GC and the ng-eNB (i.e., SN) is connected to the gNB via Xn interface.\n-\tNR-NR Dual Connectivity (NR-DC) is the variant when the UE is connected to one gNB that acts as a MN and one gNB that acts as a SN. The MN is connected to 5GC while the SN is connected to MN via Xn interface.\n\nThe figure depicts a multi-radio dual connectivity (MR-DC) protocol architecture, illustrating the various radio access network (RAN) components and their interconnections. The diagram highlights the use of radio frequency (RF) and optical technologies, with key components such as base stations (BSs), radio access network (RAN) elements, and optical line terminals (OLTs). The MR-DC protocol is designed to provide dual connectivity, enabling simultaneous transmission of data over two radio frequencies (RFs) and optical signals. This architecture is crucial for ensuring reliable and efficient communication in a multi-radio environment.\nFigure 6.10.1.2-1 Multi-Radio dual connectivity (MR-DC) protocol architecture.\nWhen the MN establishes security context between an SN and the UE for the first time for a given AS security context shared between the MN and the UE, the MN generates the KSN for the SN and sends it to the SN over the Xn-C. To generate the KSN, the MN associates a counter, called an SN Counter, with the current AS security context. The SN Counter is used as freshness input into KSN derivations as described in the clause 6.10.3.2. The MN sends the value of the SN Counter to the UE over the RRC signalling path when it is required to generate a new KSN. The KSN is used to derive further RRC and UP keys that are used between the UE and SN.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.2\tSecurity mechanisms and procedures for DC",
                            "text_content": "When the MN is executing the Secondary Node Addition procedure (i.e. initial offload of one or more radio bearers to the SN), or the Secondary Node Modification procedure (as in clauses 10.2.2 and 10.3.2 in TS 37.340 [51]) which requires an update of the KSN, the MN shall derive an KSN as defined in clause 6.10.3.2. The MN shall maintain the SN Counter as defined in Clause 6.10.3.1. In the case of Conditional PSCell Change and conditional PSCell addition as specified in TS 37.340 [51], if there are more than one candidate SNs, for each SN, the MN shall derive a different KSN via using different SN counter as defined in clause 6.10.3.2.\nWhen executing the procedure for adding subsequent radio bearer(s) to the same SN, the MN shall, for each new radio bearer, assign a radio bearer identity that has not previously been used since the last KSN change. If the MN cannot allocate an unused radio bearer identity for a new radio bearer in the SN, due to radio bearer identity space exhaustion, the MN shall increment the SN Counter and compute a fresh KSN, and then shall perform a SN Modification procedure to update the KSN.\nThe dual connectivity procedure with activation of encryption/decryption and integrity protection follows the steps outlined on the Figure 6.10.2.1-1.\nThe figure depicts the security aspects of SN Addition/Modification procedures in 5G networks, highlighting the importance of secure communication protocols and procedures. It illustrates the various steps involved in the process, such as authentication, encryption, and access control, to ensure the confidentiality and integrity of data transmitted over the network.\nFigure 6.10.2.1-1. Security aspects in SN Addition/Modification procedures (MN initiated)\n1.\tThe UE and the MN establish the RRC connection.\n2.\tThe MN sends SN Addition/Modification Request to the SN over the Xn-C to negotiate the available resources, configuration, and algorithms at the SN. The MN computes and delivers the KSN to the SN if a new key is needed. The UE security capabilities (see subclause 6.10.4) and the UP security policy received from the SMF shall also be sent to SN. In case of PDU split, UP integrity protection and ciphering activation decision from MN may be also included as described in subclause 6.10.4\nWhen the MN decides to configure CPA or CPC, if there are more than one candidate SNs, for each SN, the MN shall derive a different KSN and delivers the KSN to each SN seperately..\n3.\tThe SN allocates the necessary resources and chooses the ciphering algorithm and integrity algorithm which has the highest priority from its configured list and is also present in the UE security capability. If a new KSN was delivered to the SN then the SN calculates the needed RRC. The UP keys may be derived at the same time when RRC key derived. The SN shall activate the UP security policy as described in subclause 6.10.4.\n4.\tThe SN sends SN Addition/Modification Acknowledge to the MN indicating availability of requested resources and the identifiers for the selected algorithm(s) for the requested DRBs and/or SRB for the UE. The UP integrity protection and encryption indications shall be send to the MN.\n5.\tThe MN sends the RRC Connection Reconfiguration Request to the UE instructing it to configure the new DRBs and/or SRB for the SN. The MN shall include the SN Counter parameter to indicate a new KSN is needed and the UE shall compute the KSN for the SN. The MN forwards the UE configuration parameters (which contains the algorithm identifier(s) received from the SN in step 4) , and UP integrity protection and encryption indications(received from the SN in step 4) to the UE (see subclause 6.10.3.3 for further details).\nIf an SN sends more than one candidate PScell SCG configuration, the MN signals to the UE that all these configurations are associated with the same SN counter value.\nNOTE 3: Since the message is sent over the RRC connection between the MN and the UE, it is integrity protected using the KRRCint of the MN. Hence the SN Counter cannot be tampered with.\n6.\tThe UE accepts the RRC Connection Reconfiguration Request after validating its integrity. The UE shall compute the KSN for the SN if an SN Counter parameter was included. The UE shall also compute the needed RRC and UP keys and activate the RRC and UP protection as per the indications received for the associated SRB and/or DRBs respectively. The UE sends the RRC Reconfiguration Complete to the MN. The UE activates the chosen encryption/decryption and integrity protection keys with the SN at this point.\n7. MN sends SN Reconfiguration Complete to the SN over the Xn-C to inform the SN of the configuration result. On receipt of this message, SN may activate the chosen encryption/decryption and integrity protection with UE. If SN does not activate encryption/decryption and integrity protection with the UE at this stage, SN shall activate encryption/decryption and integrity protection upon receiving the Random Access request from the UE.\nThe SN shall request the Master Node to update the KSN over the Xn-C, when uplink and/or downlink PDCP COUNTs are about to wrap around for any of the SCG DRBs or SCG SRB.\nIf the Master Node re-keys its currently active AS key in an 5G AS security context the Master Node shall update any KSN associated with that 5G AS security context.\nWhenever the UE or SN start using a fresh KSN, they shall re-calculate the RRC and UP keys from the fresh KSN.\nThe Master Node may update the KSN for any reason. If the MN decides to update the KSN, the MN shall perform a SN modification procedure to deliver the fresh KSN to the SN as defined in clause 6.10.2.1. The MN shall provide the value of the SN Counter used in the derivation of the KSN to the UE in an integrity protected RRC Connection Reconfiguration procedure. The UE shall derive the KSN as described in clause  A.16.\nWhen uplink and/or downlink PDCP COUNTs are about to wrap around for any of the SCG DRBs or SCG SRB, the SN shall request the MN to update the KSN over the Xn-C using the SN Modification procedure with MN involvement. The SN shall send the SN Modification Required message including KSN key update an indication to the MN as shown in Figure 6.10.2.2.3-1. When the MN receives KSN Key update indication, the MN shall derive a fresh KSN and send the derived KSN to the SN in the SN Modification Request message as in clause 6.10.2.1. Rest of the flows are like the call flow in Clause 6.10.2.1.\nThe figure depicts a detailed SN Key update procedure using SN Modification procedure (SN initiated with MN involvement), illustrating the step-by-step process of updating the SN key. The SN Key is a crucial component in the network, and this procedure ensures the integrity and security of the network.\nFigure 6.10.2.2.3-1. SN Key update procedure using SN Modification procedure (SN initiated with MN involvement)\nWhen the SN releases the last UE radio bearer on the SN or when the SN is changed, i.e., the UE radio bearer(s) is moved from the SN, the SN and the UE shall delete the SN RRC and UP keys. The SN and UE shall also delete the KSN, if it was not deleted earlier.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.3\tEstablishing the security context between the UE and SN",
                            "text_content": "The MN shall maintain a 16-bit counter, SN Counter, in its AS security context. The SN Counter is used when computing the KSN.\nThe MN maintains the value of the counter SN Counter for a duration of the current 5G AS security context between UE and MN. The UE does not need to maintain the SN Counter after it has computed the KSN since the MN provides the UE with the current SN Counter value when the UE needs to compute a new KSN.\nThe SN Counter is a fresh input to KSN derivation. That is, the UE assumes that the MN provides a fresh SN Counter each time and does not need to verify the freshness of the SN Counter.\nNOTE: An attacker cannot, over the air modify the SN Counter and force re-use of the same SN Counter. The reason for this is that the SN Counter is delivered over the RRC connection between the MN and the UE, and this connection is both integrity protected and protected from replay.\nThe MN shall set the SN Counter to ‘0’ when a new AS root key, KNG-RAN, in the associated 5G AS security context is established. The MN shall set the SN Counter to ‘1’ after the first calculated KSN, and monotonically increment it for each additional calculated KSN. The SN Counter value '0' is used to calculate the first KSN.\nIf the MN decides to release the offloaded connections to the SN and later decides to re-start the offloading to the same SN, the SN Counter value shall keep increasing, thus keeping the computed KSN fresh.\nThe MN shall refresh the root key of the 5G AS security context associated with the SN Counter before the SN Counter wraps around. Refreshing the root key is done using intra cell handover as described in subclause 6.7.3.3 of the present document. When the root key is refreshed, the SN Counter is reset to '0' as defined above.\nThe UE and MN shall derive the security key KSN of the SN as defined in Annex A.16 of the present document.\nThe SN RRC and UP keys shall be derived from the KSN both at the SN and the UE using the function given in Annex A.7 of TS 33.401 [10] if the SN is a ng-eNB or using the function given in Annex A.8 of the present specification if the SN is a gNB.\nOnce all the SN RRC and UP keys have been derived from the KSN, the SN and UE may delete the KSN.\nThe MN shall receive the UE security capabilities from the AMF or the previous NG-RAN node. These security capabilities include both LTE and NR security capabilities.\nWhen establishing one or more DRBs and/or SRBs for a UE at the SN, as shown on Figure 6.10.2.1-1, the MN shall provide the UE security capabilities of the UE to the SN in the SN Addition/Modification Request message.\nUpon receipt of this message, the SN shall select the algorithms with highest priority in its locally configured list of algorithms that are also present in the received UE security capabilities and include the selected algorithms in SN Addition/Modification Request Acknowledge.\nThe MN shall provide the selected algorithms to the UE during the RRCConnectionReconfiguration procedure that configures the DRBs and/or SRB with the SN for the UE. The UE shall use the indicated algorithms for the DRBs and/or SRB whose PDCP terminates on the SN.\nNOTE: The algorithms that the UE uses with the MN can be the same or different to the algorithms used with the SN.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.4\tProtection of traffic between UE and SN",
                            "text_content": "This subclause provides the details of the needed SN RRC and UP keys and the algorithms used to protect the traffic whose PDCP terminates on the SN. The UE and SN may either calculate all the SN RRC and UP keys at once or as there are required to be used. The RRC and UP keys are KRRCenc and KRRCint for the SRB whose PDCP terminates on the SN and KUPenc for the DRBs whose PDCP terminate on the SN.\nWhen the SN is a gNB, the RRC traffic protection directly between the UE and SN is done using the mechanism described in subclause 6.5 of the present document with the algorithms specified in Annex D of the present document.\nWhen the SN is a gNB, the UP traffic protection and activation is done using the mechanism described in subclauses 6.6 of the present document using the algorithms specified in Annex D of the present document. The UP security activation procedure for MR-DC (meaning NR-DC, NE-DC and NGEN-DC) scenarios use the mechanism described in sublcause 6.10.2.1 with the following additional procedures:\nIn the case of split PDU session where some of the DRB(s) is terminated at the MN and some DRB(s) is terminated at the SN, the MN shall ensure that all DRBs which belong to the same PDU session have the same UP integrity protection and ciphering activation. To achieve this, the MN shall inform the SN with its UP integrity protection and ciphering activation decision of any DRB that is offloaded and to be terminated at the SN. The SN shall activate the UP integrity protection and ciphering based on the MN decision.\n\nFor UP Integrity Protection, if the UE does not indicate that it supports the use of integrity protection with ng-eNB:\nCase 1: UP security policy indicates UP Integrity Protection \"required\":\nIn NGEN-DC scenario, the MN shall reject the PDU session.\nIn NE-DC scenario, if the MN decides to activate the UP integrity protection for this PDU session, the MN shall not offload any DRB of the PDU session to the SN.\nIn NR-DC scenario, the MN makes the decision for PDU sessions that are terminated at the MN while the SN makes the decision for PDU sessions that are terminated at the SN.\nCase 2: UP security policy indicates UP Integrity Protection \"preferred\":\nIn NGEN-DC scenario, the MN shall always deactivate UP integrity protection. In this case, the SN shall always deactivate the UP integrity protection of any PDU session terminated at the SN.\nIn NE-DC scenario, if the MN has activated any of this PDU session DRBs with UP integrity protection \"on\", the MN shall not offload any DRB of this PDU session to the SN. However, if the MN has activated all DRBs of this PDU session with integrity protection \"off\", the MN may offload DRBs of this PDU session to the SN. In this case, the SN shall not activate the UP integrity protection and shall always set the UP integrity protection indication to \"off\".\nIn NR-DC scenario, the MN makes the decision for PDU sessions that are terminated at the MN while the SN makes the decision for PDU sessions that are terminated at the SN.\nCase 3: UP security policy indicates UP Integrity Protection \"not needed\":\nIn all MR-DC scenarios, the MN and SN shall always deactivate UP integrity protection.\nFor UP integrity protection, if the UE indicates that it supports use of integrity protection with ng-eNB, in all 5GC-based MR-DC scenarios, the MN and SN shall make a decision on UP integrity protection according to the UP security policy for PDU sessions which terminate at the MN and SN, respectively, where all DRBs belonging to the same PDU session shall have the integrity protection either \"on\" or \"off\".\nFor UP Ciphering Protection:\nIn all MR-DC scenario, the MN and SN shall make a decision on UP ciphering protection according to the UP security policy for PDU sessions which terminate at the MN and SN, respectively, where all DRBs belonging to the same PDU session shall have the ciphering protection either \"on\" or \"off\".\nNOTE 1:\tA UE that is Rel-16 or prior does not support UP integrity protection with ng-eNB. Therefore, explicit indication, as specified in clause 6.6.4.3, that the UE supports use of UP integrity protection with ng-eNB is required.\nIn all scenarios of MR-DC, the SN shall send the UP integrity protection and encryption indications to the MN in the SN Addition/Modification Request Acknowledgement message. The MN shall forward the UP integrity protection and encryption indications to the UE in RRC Connection Reconfiguration message. The UE activate the UP security protection with the SN based on the UP integrity protection and encryption indications using the scheme described in subclause 6.6.2. If the MN has not activated the RRC security before sending the RRC Connection Reconfiguration message, the MN shall perform AS SMC procedure first.\nWhen the SN is a ng-eNB, the RRC and UP traffic is protected using the mechanism described in subclauses 7.4 and 7.3 respectively of TS 33.401 [10] with the algorithms specified in Annex C of TS 33.401 [10]. Additionally, the UP traffic is integrity protected based on the UP security policy and the indication that the UE supports the use of UP integrity protection with ng-eNB.\nNOTE:\tVoid.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.5\tHandover Procedure",
                            "text_content": "During N2 and Xn handover, the DRB and/or SRB connections between the UE and the SN shall be released, and the SN and the UE shall delete the SN RRC and UP keys since they shall be refreshed by the new KSN derived by the target-MN.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.6\tSignalling procedure for PDCP COUNT check",
                            "text_content": "SN may request the MN to execute a counter check procedure specified in Clause 6.13 of this specification to verify the value of the PDCP COUNT(s) associated with DRB(s) offloaded to the SN. To accomplish this, the SN shall communicate this request, including the expected values of PDCP COUNT(s) and associated radio bearer identities to the MN over the Xn-C.\nIf the MN receives a RRC counter check response from the UE that contains one or several PDCP COUNT values (possibly associated with both MN and SN), the MN may release the connection or report the difference of the PDCP COUNT values to the serving AMF or O&M server for further traffic analysis, e.g., detecting the attacker.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.10.7\tRadio link failure recovery",
                            "text_content": "Since the MN holds the control plane functions in MR-DC as in clause 6.10.1.2, the UE runs the RRC re-establishment procedure with the MN as specified in Clause 6.11 of the present document. During the RRC re-establishment procedure, the radio bearers between the UE and the SN shall be released.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.11\tSecurity handling for RRC connection re-establishment procedure",
                    "description": "",
                    "summary": "",
                    "text_content": "NOTE: \tThis clause applies only to the gNB. Inter-RAT RRC Connection Re-establishment (i.e., between gNB and ng-eNB) is not supported. The RRC Connection Re-establishment procedure for the ng-eNB is specified in TS 33.401 [10].\nThe KNG-RAN* and token calculation at handover preparation are cell specific instead of gNB specific. During the handover procedure, at potential RRC connection reestablishment (e.g., in handover failure case), the UE may select a cell different from the target cell to initiate the reestablishment procedure. To ensure that the UE RRC connection re-establishment attempt is successful when the UE selects another cell under the control of the target gNB at handover preparation, the source gNB may prepare multiple KNG-RAN* keys and tokens for multiple cells which are under the control of the target gNB. The source gNB may prepare for multiple cells belonging to the serving gNB itself.\nThe preparation of these cells includes sending security context containing KNG-RAN* keys and tokens for each cell to be prepared, as well as the corresponding NCC, the UE 5G security capabilities, and the security algorithms used in the source cell for computing the token, to the target gNB. The source gNB shall derive the KNG-RAN* keys as described in Annex A.11/A.12 based on the corresponding target cell’s physical cell ID and frequency ARFCN-DL.\nIn order to calculate the token, the source gNB shall use the negotiated NIA-algorithm from the 5G AS Security context from the source gNB with the following inputs: source C-RNTI, source PCI and target Cell-ID, where source PCI and source C-RNTI are associated with the cell the UE last had an active RRC connection with and target Cell-ID is the identity of the target cell where the RRCReestablishmentRequest is sent to.\n-\tKEY shall be set to KRRCint of the source cell;\n-\tall BEARER bits shall be set to 1;\n-\tDIRECTION bit shall be set to 1;\n-\tall COUNT bits shall be set to 1.\nThe token shall be the 16 least significant bits of the output of the used integrity algorithm.\nIn order to avoid UE’s inability to perform the RRC re-establishment procedure due to a failure during a handover or a connection re-establishment, the UE shall keep the KgNB used in the source cell until the handover or a connection re-establishment has been completed successfully or until the UE has deleted the KgNB for other reasons (e.g., due to transitioning to CM-IDLE).\nFor Xn handover, the target gNB shall use the received multiple KNG-RAN* keys. But for N2 handover, the target gNB discards the multiple KNG-RAN* keys received from the source gNB, and derives the KNG-RAN* keys as described in Annex A.11/A.12 based on the received fresh {NH, NCC} pair from AMF for forward security purpose.\nWhen an RRCReestablishmentRequest is initiated by the UE, the RRCReestablishmentRequest shall contain the token corresponding to the cell the UE tries to reconnect to. This message is transmitted over SRB0 and hence not integrity protected.\nIf the target gNB receiving the RRCReestablishmentRequest has a prepared KNG-RAN* key and token for the specific cell, the target gNB receiving the RRCReestablishmentRequest shall validate the token received in the RRCReestablishmentRequest. However, if the target gNB has not prepared token for the cell, the target gNB extracts the C-RNTI and PCI from the RRCReestablishmentRequest message. The target gNB contacts the source gNB based on PCI by sending an Xn-AP Retrieve UE Context Request message with the following included: C-RNTI, PCI, the token and target Cell-ID, in order to allow the source gNB to validate the UE request and to retrieve the UE context including the UE 5G AS security context.\nThe source gNB retrieves the stored UE context including the UE 5G AS security context from its database using the C-RNTI. The source gNB verifies the token. If the verification is successful, then the source gNB calculates KNG-RAN* using the target cell PCI, target ARFCN-DL and the KgNB/NH in the current UE 5G AS security context based on either a horizontal key derivation or a vertical key derivation according to whether the source gNB has an unused pair of {NCC, NH} as described in Annex A.11. The source gNB can obtain the target PCI and target ARFCN-DL from a cell configuration database by means of the target Cell-ID which was received from the target gNB. Then the source gNB shall respond with an Xn-AP Retrieve UE Context Response message to the target gNB including the UE context that contains the UE 5G AS security context.\nAfter successful verification of token by either target gNB or source gNB, the target gNB shall check whether it supports ciphering and integrity algorithms that the UE was using with the last source cell, if supports  and these algorithms are the chosen algorithms or they are not the chosen algorithms by the target gNB, the target gNB shall use the KNG-RAN* corresponding to the selected cell as KgNB and derive new RRC keys (new KRRCint and new KRRCenc) based on the KgNB and the AS algorithms used in source cell.\nThen, the target gNB shall respond with an RRCReestablishment message containing the NCC received during the preparation phase or context fetch phase. This RRCReestablishment message is sent on SRB1 and is integrity protected in PDCP layer using the newly calculated KRRCint.\nIf verification of the token is failed by either target gNB or source gNB, or the target gNB does not support the ciphering and integrity algorithms used in source cell, the target gNB shall reply with an RRCSetup message. The RRCSetup message is sent on SRB0 and hence not integrity protected.\nNext the target gNB and UE shall do the following: The UE shall firstly synchronize the locally kept NH parameter as defined in Annex A.10 if the received NCC value is different from the current NCC value in the UE itself. Then the UE shall derive KNG-RAN* as described in Annex A.11/A.12 based on the selected cell’s physical cell ID and its frequency ARFCN-DL. The UE shall use this KNG-RAN* as KgNB. The gNB uses the KNG-RAN* corresponding to the selected cell as KgNB. The UE shall derive the new RRC keys from the KgNB and the AS algorithms (ciphering and integrity algorithms) the UE was using with the source cell. The UE shall verify the integrity of the RRCReestablishment message by verifying the PDCP MAC-I using the newly derived KRRCint.\nNOTE: Void.\nIf the UE successfully validate the integrity of the received RRCReestablishment message, the UE shall respond with an RRCReestablishmentComplete on SRB1 while being integrity protected and ciphered using the new RRC keys. The RRCConnectionReconfiguration procedure used to re-establish the remaining radio bearers shall only include integrity protected and ciphered messages.\nWhen the UE receives RRCSetup message, the UE shall perform the RRC connection establishment procedure as if the UE was in RRC_IDLE.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "6.12\tSubscription identifier privacy",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.12.1\tSubscription permanent identifier",
                            "text_content": "In the 5G system, the globally unique 5G subscription permanent identifier is called SUPI as defined in 3GPP TS 23.501 [2]. The SUCI is a privacy preserving identifier containing the concealed SUPI.\nThe SUPI is privacy protected over-the-air by using the SUCI which is described in clause 6.12.2. Handling of SUPI and privacy provisioning related to concealing the SUPI shall be done according to the requirements specified in clause 5 and details provided in clause 6.12.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.12.2\tSubscription concealed identifier",
                            "text_content": "The SUbscription Concealed Identifier, called SUCI, is a privacy preserving identifier containing the concealed SUPI.\nThe UE shall generate a SUCI using a protection scheme with the raw public key, i.e. the Home Network Public Key, that was securely provisioned in control of the home network. The protection schemes shall be the ones specified in Annex C of this document or the ones specified by the HPLMN.\nThe UE shall construct a scheme-input from the subscription identifier part of the SUPI as  follows:\nFor SUPIs containing IMSI, the subscription identifier part of the SUPI includes the MSIN of the IMSI as defined in TS 23.003 [19].\nFor SUPIs taking the form of a NAI, the subscription identifier part of the SUPI includes the \"username\" portion of the NAI as defined in NAI RFC 7542 [57].\nNOTE A: Use of variable-length SUPIs in NAI format (e.g., unusually short, or long length for the username portion of the NAI) can result in leakage of length even if the username portion is confidentiality protected. Such a leakage can affect the privacy of the subscriber. To mitigate this risk, it is recommended that home networks configure the username portion of the SUPIs in the USIMs and the UDM to meet the desired anonymity. This can be ensured by the home network operator, for example, by choosing username(s) of a fixed length or by making variable-length usernames fixed-length using techniques such as padding in the USIM and home network. The actual method chosen is left to the decision of the home network operator.\nNOTE B: The above risk is not applicable to SUPIs that are of fixed length such as SUPIs containing IMSI.\nThe UE shall execute the protection scheme with the constructed scheme-input as input and take the output as the Scheme Output.\nThe UE shall not conceal the Home Network Identifier and the Routing Indicator.\nFor SUPIs containing IMSI, the UE shall construct the SUCI with the following data fields:\n- \tThe SUPI Type as defined in TS 23.003 [19] identifies the type of the SUPI concealed in the SUCI.\n-\tThe Home Network Identifier is set to the MCC and MNC of the IMSI as specified in 23.003 [19].\n-\tThe Routing Indicator as specified in TS 23.003 [19].\n-\tThe Protection Scheme Identifier as specified in Annex C of this specification.\n-\tThe Home Network Public Key Identifier as specified in this document and detailed in TS 23.003 [19].\n-\tThe Scheme Output as specified in this document and detailed in TS 23.003 [19].\nFor SUPIs containing Network Specific Identifier, the UE shall construct the SUCI in NAI format with the following data fields:\n-\trealm part of the SUCI is set to the realm part of the SUPI.\n- \tusername part of the SUCI is formatted as specified in TS 23.003 [19] using the SUPI Type, Routing Indicator, the Protection Scheme Identifier, the Home Network Public Key Identifier and the Scheme Output.\nNOTE 1: \tThe format of the SUPI protection scheme identifiers is defined in Annex C.\nNOTE 2:\tThe identifier and the format of the Scheme Output are defined by the protection schemes in Annex C. In case of non-null-schemes, the freshness and randomness of the SUCI will be taken care of by the corresponding SUPI protection schemes.\nNOTE 2a:\tIn case of null-scheme being used, the Home Network Public Key Identifier is set to a default value as described in TS 23.003 [19].\nThe UE shall include a SUCI only in the following 5G NAS messages:\n-\tif the UE is sending a Registration Request message of type \"initial registration\" to a PLMN for which the UE does not already have a 5G-GUTI, the UE shall include a SUCI to the Registration Request message, or\n-\tif the UE responds to an Identity Request message by which the network requests the UE to provide its permanent identifier,  the UE  includes a  SUCI in the Identity Response message as specified in clause 6.12.4.\n-\tif the UE is sending a De-Registration Request message to a PLMN during an initial registration procedure for which the UE did not receive the registration accept message with 5G-GUTI, the UE shall include the SUCI used in the initial registration to the De-Registration Request message.\nNOTE 3: \tIn response to the Identity Request message, the UE never sends the SUPI.\nThe UE shall generate a SUCI using \"null-scheme\" only in the following cases:\n-\tif the UE is making an unauthenticated emergency session and it does not have a 5G-GUTI to the chosen PLMN, or\n-\tif the home network has configured \"null-scheme\" to be used, or\n- \tif the home network has not provisioned the public key needed to generate a SUCI.\nIf the operator's decision, indicated by the USIM, is that the USIM shall calculate the SUCI, then the USIM shall not give the ME any parameter for the calculation of the SUCI including the Home Network Public Key Identifier, the Home Network Public Key, and the Protection Scheme Identifier. If the ME determines that the calculation of the SUCI, indicated by the USIM, shall be performed by the USIM, the ME shall delete any previously received or locally cached parameters for the calculation of the SUCI including the SUPI Type, the Routing Indicator, the Home Network Public Key Identifier, the Home Network Public Key and the Protection Scheme Identifier. The operator should use proprietary identifier for protection schemes if the operator chooses that the calculation of the SUCI shall be done in USIM.\nIf the operator's decision is that ME shall calculate the SUCI, the home network operator shall provision in the USIM an ordered priority list of the protection scheme identifiers that the operator allows. The priority list of protection scheme identifiers in the USIM shall only contain protection scheme identifiers specified in Annex C, and the list may contain one or more protection schemes identifiers. The ME shall read the SUCI calculation information from the USIM, including the SUPI, the SUPI Type, the Routing Indicator, the Home Network Public Key Identifier, the Home Network Public Key and the list of protection scheme identifiers. The ME shall select the protection scheme from its supported schemes that has the highest priority in the list are obtained from the USIM.\nThe ME shall calculate the SUCI using the null-scheme if the Home Network Public Key or the priority list are not provisioned in the USIM.\nNOTE 4:\tThe above feature is introduced since additional protection schemes could be specified in the future for a release newer than the ME release. In this case, the protection scheme selected by older MEs may not be the protection scheme with the highest priority in the list of the USIM.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.12.3\tSubscription temporary identifier",
                            "text_content": "A new 5G-GUTI shall be sent to a UE only after a successful activation of NAS security. The 5G-GUTI is defined in TS 23.003 [19].\nUpon receiving Registration Request message of type \"initial registration\" or \"mobility registration update\" from a UE, the AMF shall send a new 5G-GUTI to the UE in the registration procedure.\nUpon receiving Registration Request message of type \"periodic registration update\" from a UE, the AMF should send a new 5G-GUTI to the UE in the registration procedure.\nUpon receiving Service Request message sent by the UE in response to a Paging message, the AMF shall send a new 5G-GUTI to the UE. This new 5G-GUTI shall be sent before the current NAS signalling connection is released or the N1 NAS signalling connection is suspended.\nUpon receiving an indication from the lower layers that the RRC connection has been resumed for a UE in 5GMM-IDLE mode with suspend indication in response to a Paging message, the AMF shall send a new 5G-GUTI to the UE. This new 5G-GUTI shall be sent before the current NAS signalling connection is released or the suspension of the N1 NAS signalling connection.\nNOTE 1:\tIt is left to implementation to re-assign 5G-GUTI more frequently than in cases mentioned above, for example after a Service Request message from the UE not triggered by the network.\nNOTE 2:\tIt is left to implementation to generate 5G-GUTI containing 5G-TMSI that uniquely identifies the UE within the AMF.\n5G-TMSI generation should be following the best practices of unpredictable identifier generation.\nA new I-RNTI shall be sent to a UE only after a successful activation of AS security.\nOn transition of UE to RRC INACTIVE state requested by gNB during RRC Resume procedure or RNAU procedure, the gNB shall assign a new I-RNTI to the UE.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.12.4\tSubscription identification procedure",
                            "text_content": "The subscriber identification mechanism may be invoked by the serving network when the UE cannot be identified by means of a temporary identity (5G-GUTI). In particular, it should be used when the serving network cannot retrieve the SUPI based on the 5G-GUTI by which the subscriber identifies itself on the radio path.\nThe mechanism described in figure 6.12.4-1 allows the identification of a UE on the radio path by means of the SUCI.\nThe figure depicts a subscription identifier query, which is a crucial component in the process of managing and monitoring subscriptions in a telecommunications network. It is used to retrieve information about a specific subscription, such as its status, expiration date, or any other relevant details. The figure includes a clear and concise label, making it easy to understand the purpose and function of the query.\nFigure 6.12.4-1: Subscription identifier query\nThe mechanism is initiated by the AMF that requests the UE to send its SUCI.\nThe UE shall calculate a fresh SUCI from SUPI using the Home Network Public Key, and respond with Identity Response carrying the SUCI. The UE shall implement a mechanism to limit the frequency at which the UE responds with a fresh SUCI to an Identity Request for a given 5G-GUTI.\nNOTE 1:\tIf the UE is using any other scheme than the null-scheme, the SUCI does not reveal the SUPI.\nAMF may initiate authentication with AUSF to receive SUPI as specified in clause 6.1.3.\nIn case the UE registers for Emergency Services and receives an Identity Request, the UE shall use the null-scheme for generating the SUCI in the Identity Response.\nNOTE 2: \tRegistration for Emergency does not provide subscription identifier confidentiality.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.12.5\tSubscription identifier de-concealing function (SIDF)",
                            "text_content": "SIDF is responsible for de-concealing the SUPI from the SUCI. When the Home Network Public Key is used for encryption of SUPI, the SIDF shall use the Home Network Private Key that is securely stored in the home operator's network to decrypt the SUCI. The de-concealment shall take place at the UDM. Access rights to the SIDF shall be defined, such that only a network element of the home network is allowed to request SIDF.\nNOTE: \tOne UDM can comprise several UDM instances. The Routing Indicator in the SUCI can be used to identify the right UDM instance that is capable of serving a subscriber.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.13\tSignalling procedure for PDCP COUNT check",
                    "description": "",
                    "summary": "",
                    "text_content": "The following procedure is used optionally by the gNB to periodically perform a local authentication. At the same time, the amount of data sent during the AS connection is periodically checked by the gNB and the UE for both up and down streams. If UE receives the Counter Check request, it shall respond with Counter Check Response message.\nNOTE: \tThe PDCP COUNT check is used to detect maliciously inserted packets. Packet insertion is detected automatically in integrity protected DRBs; therefore, the PDCP COUNT check procedure is superfluous for integrity protected bearers.\nThe gNB is monitoring the PDCP COUNT values associated to each radio bearer. The procedure is triggered whenever any of these values reaches a critical checking value. The granularity of these checking values and the values themselves are defined by the visited network. All messages in the procedure are integrity protected.\nThe figure depicts the periodic local authentication procedure of a gNB (gNB-13-1) in a 5G network. The diagram illustrates the steps involved in the authentication process, including the gNB's periodic local authentication (PLAT) and the authentication request (ARQ) messages. The figure highlights the importance of PLAT in ensuring network security and the role of ARQ in maintaining network reliability.\nFigure 6.13-1: gNB periodic local authentication procedure\n1.\tWhen a checking value is reached (e.g. the value in some fixed bit position in the hyperframe number is changed), a Counter Check message is sent by the gNB. The Counter Check message contains the most significant parts of the PDCP COUNT values (which reflect amount of data sent and received) from each active radio bearer.\n2.\tThe UE compares the PDCP COUNT values received in the Counter Check message with the values of its radio bearers. Different UE PDCP COUNT values are included within the Counter Check Response message.\n3.\tIf the gNB receives a counter check response message that does not contain any PDCP COUNT values, the procedure ends. If the gNB receives a counter check response that contains one or several PDCP COUNT values, the gNB may release the connection or report the difference of the PDCP COUNT values for the serving AMF or O&M server for further traffic analysis for e.g. detecting the attacker.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "6.14\tSteering of roaming security mechanism",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.14.1\tGeneral",
                            "text_content": "This clause describes the security functions necessary to support steering of the UE in the VPLMN during registration procedure and also after registration as described in TS 23.122 [53] Annex C. The security functions are described in the context of the functions supporting the control plane solution for steering of roaming in 5GS.\nIf the control plane solution for Steering of Roaming is supported by the HPLMN, the AUSF shall store the latest KAUSF after the completion of the latest primary authentication.\nThe content of the Steering List as well as the conditions for sending it to the UE are described in TS 23.122 [53] Annex C. The Steering List includes either a list of preferred PLMN/access technology combinations, a secured packet or the HPLMN indication that 'no change of the \"Operator Controlled PLMN Selector with Access Technology\" list stored in the UE is needed and thus no list of preferred PLMN/access technology combinations is provided'.\nNOTE1: \tIf a SOR-AF is involved in providing the content of the Steering List as described in TS 23.122 [53] Annex C, the SOR-AF belongs to the HPLMN.\nNOTE 2:\tThe Steering of Roaming Information is defined in clause 1.2 of TS 23.122 [53]. It contains thus the ACK indication, the Steering List and the integrity protection information.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.14.2\tSecurity mechanisms",
                            "text_content": "The security procedure for the case where the UE registers with VPLMN AMF is described below in figure 6.14.2.1-1:\nThe figure depicts a procedure for selecting preferred PLMN/access technology combinations during registration in a VPLMN. It includes a list of options, such as 4G, 5G, and Wi-Fi, and provides guidance on how to select the most suitable combination based on various factors like network coverage, latency, and cost.\nFigure 6.14.2.1-1: Procedure for providing list of preferred PLMN/access technology combinations during registration in VPLMN\n1)\tThe UE initiates registration by sending Registration Request message to the VPLMN AMF.\n2-3)\tThe VPLMN AMF executes the registration procedure as defined in sub-clause 4.2.2.2.2 of 3GPP TS 23.502 [8]. As part of the registration procedure, the VPLMN AMF executes primary authentication of the UE and then initiates the NAS SMC procedure, after the authentication is successful.\n4-5) The VPLMN AMF invokes the Nudm_UECM_Registration message to the UDM and registers access with the UDM as per step 14a in sub-clause 4.2.2.2.2 of 3GPP TS 23.502[8].\n6)\tThe VPLMN AMF invokes Nudm_SDM_Get service operation message to the UDM to get amongst other information the Access and Mobility Subscription data for the UE (see step 14b in sub-clause 4.2.2.2.2 of 3GPP TS 23.502 [8]).\n7)\tThe UDM decides to send the Steering of Roaming Information, and obtains a list of preferred PLMN/access technology combinations and optional additional SoR information (e.g. SOR-CMCI and the \"Store the SOR-CMCI in the ME\" indicator), or a secured packet list as described in TS 23.122 [53].\nNOTE 1: Additional SoR information (e.g. SOR-CMCI and the \"Store the SOR-CMCI in the ME\" indicator) can only be added when the AMF supports SoR transparent container.\nIf the UDM determines that the UE is configured to not expect to receive Steering of Roaming Information at initial registration and if the UDM determines that no change of the \"Operator Controlled PLMN Selector with Access Technology\" list stored in the UE is needed, then the UDM may not piggyback Steering of Roaming Information at all in the Nudm_SDM_Get response and hence the following steps are omitted.\n8-9)\tThe UDM shall invoke Nausf_SoRProtection service operation message to the AUSF to get SoR-MAC-IAUSF and CounterSoR as specified in sub-clause 14.1.3 of this document. The UDM shall select the AUSF that holds the latest KAUSF of the UE.\nIf the HPLMN decides that the UE is to acknowledge the successful security check of the received Steering of Roaming  Information, then the UDM shall set accordingly the ACK Indication included in the Nausf_SoRProtection service operation message to signal that it also needs the expected SoR-XMAC-IUE, as specified in sub-clause 14.1.3 of this document.\nNOTE 2:\tAt reception of Nausf_SoRProtection_Protect request from the UDM, if the SoR header is not included in the request, the AUSF constructs the SOR header, as described in clause 9.11.3.51 of TS 24.501 [35], based on the information received from the UDM, i.e. ACK Indication and list of preferred PLMN/access technology combinations or secured packet (if provided); otherwise, if the SoR header is contained in the request, the AUSF uses the received SoR header in the calculation of SoR-MAC-IAUSF..\nThe details of the CounterSoR are specified in sub-clause 6.14.2.3 of this document.  The inclusion of the Steering List  and the SoR header in the calculation of SoR-MAC-IAUSF allows the UE to verify that the received Steering of Roaming Information is not tampered with or removed by the VPLMN. The expected SoR-XMAC-IUE allows the UDM to verify that the UE received the Steering of Roaming Information.\n10)\tThe UDM responds to the Nudm_SDM_Get service operation to the VPLMN AMF, which shall include the SoR transparent container as specified in clause 6.1.6.3.2 of TS 29.503 [93] if the VPLMN AMF support SoR transparent container, or shall include individual IEs comprising the ACK Indication, the list of preferred PLMN/access technology combinations or secured packet (if provided), SoR-MAC-IAUSF and CounterSoR within the Access and Mobility Subscription data. If the UDM requests an acknowledgement, it shall temporarily store the expected SoR-XMAC-IUE.\n11)\tIf the SoR transparent container is received from the UDM, the VPLMN AMF shall include the received SoR transparent container in the Registration Accept message and send it to the UE. If the individual IEs are received from the UDM, the VPLMN AMF shall construct the SOR header based on the ACK Indication and the list of preferred PLMN/access technology combinations or  secured packet (if provided) received from the UDM and include it in the SOR transparent container as specified in clause 9.11.3.51 of TS 24.501 [35]. The vPLMN shall also include SoR-MAC-IAUSFand CounterSoR(both also received from the UDM) in the constructed SoR transparent container, and convey the constructed SoR transparent container  to the UE in the Registration Accept message.\n12)\t On receiving the Registration Accept message with the SoR transparent container from the AMF the UE shall calculate the SoR-MAC-IAUSF in the same way as the AUSF (as specified in Annex A.17) on the SoR transparent container, including the CounterSoR and the SoR header, and verifies whether it matches the SoR-MAC-IAUSF value received in the Registration Accept message. Based on the SoR-MAC-IAUSF verification outcome, the behaviour of the UE is specified in TS 23.122 [53].\n13) If the UDM has requested an acknowledgement from the UE and the UE verified that the SoR transparent container received in step 12 has been provided by the HPLMN, then the UE shall send the Registration Complete message to the serving AMF. The UE shall generate the SoR-MAC-IUE as specified in Annex A.18 and includes the generated SoR-MAC-IUE in a SOR transparent container in the Registration Complete message.\n14)\tThe AMF sends a Nudm_SDM_Info request message to the UDM. If a transparent container with the SoR-MAC-IUE was received in the Registration Complete message, then if the AMF supports SoR transparent container, the AMF shall include the received SoR transparent container in SoR transparent container in the Nudm_SDM_Info request message, otherwise, the AMF shall include the SoR-MAC-IUE  in the received SoR transparent container in the Nudm_SDM_Info request message.\n15)\tIf the HPLMN indicated that the UE is to acknowledge the successful security check of the received Steering of Roaming  Information in step 10, then the UDM shall compare the received SoR-MAC-IUE with the expected SoR-XMAC-IUE that the UDM stored temporarily in step 10.\nIf the UDM supports Home triggered authentication (see clause 6.1.5), the UDM based on its local policy may decide to trigger a primary authentication to refresh the SoR counter based on the value of counter received in step 9.\nThe security procedure for the steering of UE in VPLMN after registration is described below in figure 6.14.2.2-1:\n\n\nThe figure depicts a procedure for providing a list of preferred PLMN/access technology combinations after registration, which is crucial for network planning and management.\nFigure 6.14.2.2-1: Procedure for providing list of preferred PLMN/access technology combinations after registration\n1)\tThe UDM decides to notify the UE of the changes to the Steering of Roaming Information by the means of invoking Nudm_SDM_Notification service operation.\n2-3)\tThe UDM shall invoke Nausf_SoRProtection service operation message by including the ACK Indication and optionally the list of preferred PLMN/access technology combinations or secured packet or SoR transparent container (only if transparent container is supported by the AMF) to the AUSF to get SoR-MAC-IAUSF and CounterSoR as specified in sub-clause 14.1.3 of this document. The UDM shall select the AUSF that holds the latest KAUSF of the UE.\nIf the HPLMN decided that the UE is to acknowledge the successful security check of the received Steering of Roaming Information, then the UDM shall set accordingly the ACK Indication included in the Nausf_SoRProtection service operation message to signal that it also needs the expected SoR-XMAC-IUE, as specified in sub-clause 14.1.3 of this document.\nNOTE:\tAt reception of Nausf_SoRProtection_Protect request from the UDM, if the SoR header is not included in the request, the AUSF constructs the SOR header, as described in clause 9.11.3.51 of TS 24.501 [35], based on the information received from the UDM, i.e. ACK Indication and optionally the list of preferred PLMN/access technology combinations or  secured packet; otherwise, if the SoR header in contained in the request, the AUSF uses the received SoR header in the calculation of SoR-MAC-IAUSF..\nThe details of the CounterSoR are specified in sub-clause 6.14.2.3 of this document. The inclusion of the Steering List and the SOR header in the calculation of SoR-MAC-IAUSF allows the UE to verify that the Steering of Roaming Information received is not tampered with or removed by the VPLMN. The inclusion of these information in the calculation of the expected SoR-XMAC-IUE allows the UDM to verify that the UE received the Steering of Roaming Information.\n4)\tThe UDM shall invoke Nudm_SDM_Notification service operation, which contains the SoR transaprent container as specified in clause 6.1.6.3.2 of TS 29.503 [93] if the VPMN AMF support SOR transparent container, or contains individual IEs including an optional the list of preferred PLMN/access technology combinations or secured packet, the ACK Indication, SoR-MAC-IAUSF, and CounterSoR within the Access and Mobility Subscription data. If the UDM requests an acknowledgement, it shall temporarily store the expected SoR-XMAC-IUE.\n5)\tUpon receiving the Nudm_SDM_Notification message, if the SoR transparent container is included in the message, the AMF shall send a DL NAS Transport message to the served UE. including the received SoR transparent container; otherwise, the AMF shall construct the SOR transparent container (including the SOR header) as specified in clause 9.11.3.51 of 3GPP TS 24.501 [35] based on the ACK Indication, the Steering List, SoR-MAC-IAUSF and CounterSoR received from the UDM, and send the constructed SoR transparent container included to the served UE in a DL NAS Transport message.\n6)\t On receiving the DL NAS Transport message, the UE shall calculate the SoR-MAC-IAUSF in the same way as the AUSF (as specified in Annex A.17) on the received SoR transparent container, including the CounterSoR and the SoR header and verify whether it matches the SoR-MAC-IAUSF value received in the DL NAS Transport message.\n7) \tIf the UDM has requested an acknowledgement from the UE and the UE verified that the Steering Information  has been provided by the HPLMN, then the UE shall send the UL NAS Transport message to the serving AMF. The UE shall generate the SoR-MAC-IUE as specified in Annex A.18 and includes the generated SoR-MAC-IUE in a SOR transparent container in the UL NAS Transport message.\n8)\tThe AMF shall send a Nudm_SDM_Info request message to the UDM. If a SOR transparent container with the SoR-MAC-IUE was received in the UL NAS Transport message, the AMF shall include the received SoR transparent container in the Nudm_SDM_Info request message if the AMF supports SoR transparent container, otherwise, the AMF shall include the SoR-MAC-IUE in the Nudm_SDM_Info request message.\n9)\tIf the HPLMN indicated that the UE is to acknowledge the successful security check of the received Steering of Roaming  Information, then the UDM shall compare the received SoR-MAC-IUE with the expected SoR-XMAC-IUE that the UDM stored temporarily in step 4.\nThe AUSF and the UE shall associate a 16-bit counter, CounterSoR, with the key KAUSF.\nThe UE shall initialize the CounterSoR to 0x00 0x00 when the newly derived KAUSF is  stored (see clause 6.2.2.2). The UE shall store the SoR counter. If the USIM supports both 5G parameters storage and 5G parameters extended storage, then CounterSoR shall be stored in the USIM. Otherwise, CounterSoR shall be stored in the non-volatile memory of the ME\nTo generate the SoR-MAC-IAUSF, the AUSF shall use the CounterSoR. The CounterSoR shall be incremented by the AUSF for every new computation of the SoR-MAC-IAUSF. The CounterSoR is used as freshness input into SoR-MAC-IAUSF and SoR-MAC-IUE derivations as described in the Annex A.17 and Annex A.18 respectively, to mitigate the replay attack. The AUSF shall send the value of the CounterSoR (used to generate the SoR-MAC-IAUSF) along with the SoR-MAC-IAUSF to the UE. The UE shall only accept CounterSoR value that is greater than stored CounterSoR value. The UE shall store the received CounterSoR, only if the verification of the received SoR-MAC-IAUSF is successful. The UE shall use the stored CounterSoR received from the HPLMN, when deriving the SoR-MAC-IUE for the SoR acknowledgement.\nThe AUSF and the UE shall maintain the CounterSoR for lifetime of the KAUSF.\nThe AUSF that supports the control plane solution for steering of roaming shall initialize the CounterSoR to 0x00 0x01 when the newly derived KAUSF is stored (see clause 6.2.2.1). The AUSF shall set the CounterSoR to 0x00 0x02 after the first calculated SoR-MAC-IAUSF, and monotonically increment it for each additional calculated SoR-MAC-IAUSF. The SoR Counter value of 0x00 0x00 shall not be used to calculate the SoR-MAC-IAUSF and SoR-MAC-IUE.\nThe AUSF shall suspend the SoR protection service for the UE, if the CounterSoR associated with the KAUSF of the UE, is about to wrap around. When a fresh KAUSF is generated for the UE, the CounterSoR at the AUSF is reset to 0x00 0x01 as defined above and the AUSF shall resume the SoR protection service for the UE.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.15\tUE parameters update via UDM control plane procedure security mechanism",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.15.1\tGeneral",
                            "text_content": "This clause describes the security functions necessary to update the UE parameters using the UDM control plane procedure specified in TS 23.502 [8]. The security functions are described in the context of the functions supporting the delivery of UE Parameters Update Data from the UDM to the UE after the UE has successfully registered to the 5G network.\nIf the control plane procedure for UE parameters update is supported by the UDM, the AUSF shall store the latest KAUSF after the completion of the latest primary authentication.\nThe content of UE Parameters Update Data and the conditions for sending it to the UE as well as how it is handled at the UE are specified in TS 24.501 [35].\nNOTE : The home network relies on the serving network to deliver the UE parameters update.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.15.2\tSecurity mechanisms",
                            "text_content": "The UDM may decide to perform UE parameters update anytime after the UE has been successfully authenticated and registered to the 5G system. The security procedure for the UE parameters update is described below in figure 6.15.2.1-1:\nThe figure depicts a procedure for updating the parameters of an UE (User Equipment) in a 5G network. The diagram illustrates the steps involved in updating the parameters, including the selection of the correct update method, the selection of the correct update parameters, and the execution of the update process. The figure is important for ensuring that the parameters of the UE are updated correctly and efficiently, which is crucial for the proper functioning of the 5G network.\nFigure 6.15.2.1-1: Procedure for UE Parameters Update\n1)\tThe UDM decides to perform the UE Parameters Update (UPU) using the control plane procedure while the UE is registered to the 5G system. If the final consumer of any of the UE parameters to be updated (e.g., the updated Routing ID Data) is the USIM, the UDM shall protect these parameters using a secured packet mechanism (see 3GPP TS 31.115 [65]) to update the parameters stored on the USIM. The UDM shall then prepare the UE Parameters Update Data (UPU Data) by including the parameters protected by the secured packet, if any, as well as any UE parameters for which final consumer is the ME (see TS 24.501 [35]).\n2-3)\tThe UDM shall invoke Nausf_UPUProtection service operation message by including the UPU Data to the AUSF to get UPU-MAC-IAUSF and CounterUPU as specified in sub-clause 14.1.4 of this document. The UDM shall select the AUSF that holds the latest KAUSF of the UE.\nIf the UDM decided that the UE is to acknowledge the successful security check of the received UE Parameters Update Data, then the UDM shall include the ACK Indication in the Nausf_UPUProtection service operation message to signal that it also needs the expected UPU-XMAC-IUE, as specified in sub-clause 14.1.4 of this document.\nThe details of the CounterUPU is specified in sub-clause 6.15.2.2 of this document. The inclusion of UE Parameters Update Data in the calculation of UPU-MAC-IAUSF allows the UE to verify that it has not been tampered by any intermediary. The expected UPU-XMAC-IUE allows the UDM to verify that the UE received the UE Parameters Update Data correctly.\n4)\tThe UDM shall invoke Nudm_SDM_Notification service operation, which includes the UPU transparent container if the AMF supports UPU transparent container, or includes individual IEs comprising the UE Parameters Update Data, UPU-MAC-IAUSF, CounterUPU within the Access and Mobility Subscription data. If the UDM requests an acknowledgement, it shall temporarily store the expected UPU-XMAC-IUE.\n5)\tUpon receiving the Nudm_SDM_Notification message, the AMF shall send a DL NAS Transport message to the served UE. The AMF shall include in the DL NAS Transport message the transparent container if received from the UDM in step 4. Otherwise, if the UDM provided individual IEs in step 4, then the AMF shall construct a UPU transparent container.\n6)\t On receiving the DL NAS Transport message, the UE shall calculate the UPU-MAC-IAUSF in the same way as the AUSF (as specified in Annex A.19) on the received UE Parameters Update Data and the CounterUPU and verify whether it matches the UPU-MAC-IAUSF value received within the UPU transparent container in the DL NAS Transport message. If the verification of UPU-MAC-IAUSF is successful and the UPU Data contains any parameters that is protected by secured packet (see 3GPP TS 31.115 [65]), the ME shall forward the secured packet to the USIM using procedures in 3GPP TS 31.111 [66]. If the verification of UPU-MAC-IAUSF is successful and the UPU Data contains any parameters that is not protected by secure packet, the ME shall update its stored parameters with the received parameters in UDM Updata Data.\n7) \tIf the UDM has requested an acknowledgement from the UE and the UE has successfully verified and updated the UE Parameters Update Data provided by the UDM, then the UE shall send the UL NAS Transport message to the serving AMF. The UE shall generate the UPU-MAC-IUE as specified in Annex A.20 and include the generated UPU-MAC-IUE in a transparent container in the UL NAS Transport message.\n8)\tIf a transparent container with the UPU-MAC-IUE was received in the UL NAS Transport message, the AMF shall send a Nudm_SDM_Info request message with the transparent container to the UDM.\n9)\tIf the UDM indicated that the UE is to acknowledge the successful security check of the received UE Parameters Update Data, then the UDM shall compare the received UPU-MAC-IUE with the expected UPU-XMAC-IUE that the UDM stored temporarily in step 4.\nIf the UDM supports Home triggered authentication (see clause 6.1.5), the UDM based on its local policy may decide to trigger a primary authentication to refresh the UPU counter based on the value of counter received in step 3.\nThe AUSF and the UE shall associate a 16-bit counter, CounterUPU, with the key KAUSF.\nThe UE shall initialize the CounterUPU to 0x00 0x00 when the newly derived KAUSF is stored (see clause 6.2.2.2). The UE shall store the UPU counter . If the USIM supports both 5G parameters storage and 5G parameters extended storage, then CounterUPU shall be stored in the USIM. Otherwise, CounterUPU shall be stored in the non-volatile memory of the ME.\nTo generate the UPU-MAC-IAUSF, the AUSF shall use the CounterUPU. The CounterUPU shall be incremented by the AUSF for every new computation of the UPU-MAC-IAUSF. The CounterUPU is used as freshness input into UPU-MAC-IAUSF and UPU-MAC-IUE derivations as described in the Annex A.19 and Annex A.20 respectively, to mitigate the replay attack. The AUSF shall send the value of the CounterUPU (used to generate the UPU-MAC-IAUSF) along with the UPU-MAC-IAUSF to the UE. The UE shall only accept CounterUPU value that is greater than stored CounterUPU value. The UE shall update the stored CounterUPU with the received CounterUPU, only if the verification of the received UPU-MAC-IAUSF is successful. The UE shall use the CounterUPU received from the UDM, when deriving the UPU-MAC-IUE for the UE Parameters Upadate Data acknowledgement.\nThe AUSF and the UE shall maintain the CounterUPU for lifetime of the KAUSF.\nThe AUSF that supports the UE parameters update using control plane procedure shall initialize the CounterUPU to 0x00 0x01 when the newly derived KAUSF is stored (see clause 6.2.2.1). The AUSF shall set the CounterUPU to 0x00 0x02 after the first calculated UPU-MAC-IAUSF, and monotonically increment it for each additional calculated UPU-MAC-IAUSF. The UPU Counter value of 0x00 0x00 shall not be used to calculate the UPU-MAC-IAUSF and UPU-MAC-IUE.\nThe AUSF shall suspend the UE Parameters Update protection service for the UE, if the CounterUPU associated with the KAUSF of the UE, is about to wrap around. When a fresh KAUSF is generated for the UE, the CounterUPU at the AUSF is reset to 0x00 0x01 as defined above and the AUSF shall resume theUE Parameters Update protection service for the UE.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "6.16\tSecurity handling in Cellular IoT",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "6.16.1\tSecurity handling in Control Plane CIoT 5GS Optimization",
                            "text_content": "The Control Plane Optimisation for 5GS CIoT is used to exchange small user data or SMS as payload of a NAS message in both uplink and downlink directions. The UE and the AMF perform integrity protection and ciphering for the small user data or SMS using NAS security context specific to the NAS connection.\nIf UE uses Control Plane optimisation for 5GS CIoT for Mobile Originated data transport, the UE sends a Control Plane Service Request message including a container for small user data or SMS transport. The Control Plane Service Request message shall be partially ciphered (i.e. the container including uplink user data or SMS is ciphered, and non-cleartext remains unciphered) and integrity protected by the current 5G NAS security context specific to the NAS connection if such exists as depicted in TS 24.501 [35]. Upon reception of the Control Plane Service Request message with the ciphered container for small user data or SMS transport, the AMF shall verify integrity of the whole Control Plane Service Request message and decipher the ciphered container to obtain the small user data or SMS. When applying NAS ciphering/deciphering mechanism for the container, the LENGTH value shall be set to the length of the container contents.\nAdditionally, if UE uses Control Plane optimisation for 5GS CIoT for Mobile Originated data transport, the UE in CM-CONNECTED mode sends small user data or SMS in UL NAS transport message to the AMF. The UL NAS transport message shall be ciphered and integrity protected with the current 5G NAS security context specific to the NAS connection. Upon reception of the UL NAS transport message for small user data or SMS transport, the AMF shall verify integrity and decipher the UL NAS transport message to obtain the small user data or SMS.\nIf UE uses Control Plane optimisation for 5GS CIoT for Mobile Terminated data transport, the UE obtains small user data or SMS in DL NAS transport message from the AMF. The DL NAS transport message shall be ciphered and integrity protected with the current 5G NAS security context specific to the NAS connection. Upon reception of the DL NAS transport message for small user data or SMS transport, the UE shall verify integrity and decipher the DL NAS transport message to obtain the small user data or SMS.\nIf the UE experience a RLF when using Control Plane CIoT 5GS optimisation only, the AS layer of the UE may trigger an RRCConnectionReestablishment procedure. As there is no AS security available, this procedure can not be protected as described in subclause 6.11.\nIn order to protect the the re-establishment procedure, the AS part of the UE triggers the NAS part of the UE to provide the UL_NAS_MAC and XDL_NAS_MAC. These parameter are used to show that the UE is requesting the re-establishment and that the UE is talking to a genuine network respectively.\nThe UE calculates a UL_NAS_MAC and XDL_NAS_MAC by using the curently used NAS integrity algorithm with the following inputs, KNASint as the key, the uplink NAS COUNT that would be used for the next uplink NAS message, the DIRECTION bit set to 0 and the target Cell-ID as the message to be protected to calculate NAS-MAC (see Annex D.3.1).\nThe uplink NAS COUNT is increased by the UE in exactly the same way as if it had sent a NAS message. The first 16 bits of NAS-MAC form UL_NAS_MAC and the last 16 bits form XDL_NAS_MAC, which is stored by the UE.\nThe UE shall send the RRCConnectionRestablishmentRequest message to the target ng-eNB and shall include the Truncated 5G-S-TMSI (as described in TS 23.501 [2], TS 23.003 [19] and TS 36.331 [69]), the 5 least significant bits (LSB) of the NAS COUNT that was used to calculate NAS-MAC and UL_NAS_MAC in the message.\nThe target ng-eNB recognises the RRCConnectionRestablishmentRequest message sent by a UE relates to the Control Plane CIoT 5GS optimisation based on the presence of the Truncated 5G-S-TMSI in the message. The target ng-eNB shall recreate the 5G-S-TMSI from the Truncated 5G-S-TMSI (as described in TS 23.501 [2], TS 23.003 [19] and TS 36.331 [69]). The target ng-eNB shall send the 5G-S-TMSI, LSB of NAS COUNT, UL_NAS_MAC and target Cell-ID in the CP Relocation Indication message to the AMF that is serving the UE (this can be deteremined by the S-TMSI).\nThe AMF uses LSB of NAS COUNT to estimate the full uplink NAS COUNT and calculates XNAS-MAC (see Annex D.3.1) using the same inputs (i.e. estimated uplink NAS COUNT, DIRECTION bit set to 0 and the target Cell-ID as the message) as the UE used for calculating NAS-MAC. The AMF then compares the received UL_NAS_MAC with the first 16 bits of XNAS-MAC and if these are equal the network is sure that the geniune UE sent the RRCConnectionRestablishmentRequest message. The stored uplink NAS COUNT in the AMF is set as though the AMF received a sucessfully protected NAS message using that NAS COUNT.\nThe AMF shall set DL_NAS_MAC to the last 16 bits of already calculated XNAS-MAC and send DL_NAS_MAC to the target ng-eNB in the Connection Establishment Indication message. The target ng-eNB shall send the DL_NAS_MAC to the UE in the RRCConnectionReestablisment message. The UE shall check that the received DL_NAS_MAC equal to the stored XDL_NAS_MAC. If so, the UE shall complete the re-establishment procedure.\n6.16.2\tSecurity handling in User Plane CIoT 5GS Optimization\nThe purpose of this procedure is to allow the ng-eNB to suspend an RRC connection to be resumed by the UE using User Plane CIoT 5GS Optimisation at a later time. The UE may resume the RRC connection in the same or different ng-eNB where the suspend took place. The UE and ng-eNB store the AS security context at suspend and reactivate the AS security context at resume.\nThe UE and the ng-eNB may also use EDT (Early Data Transmission) or PUR (Preconfigured Uplink Resource) feature in this procedure, as defined in TS 36.300 [88] and TS 36.331 [69].\nWhen the ng-eNB initiates the Connection Suspend procedure, it sends N2 Suspend Request message to the AMF.  Upon reception of the N2 Suspend Request message, the AMF shall check its local policy. If the local policy indicates that a new NH derivation is needed, the AMF shall increase its locally kept NCC value by one and compute a fresh NH from its stored data using the function defined in Annex A.10. The AMF shall store that fresh {NH, NCC} pair and send it to the ng-eNB in the N2 Suspend Response message.\nUpon receipt of the N2 Suspend Response message from the AMF and if the message includes a {NH, NCC} pair, the ng-eNB shall store the fresh {NH, NCC} pair in the N2 Suspend Response message and remove any existing unused stored {NH, NCC} pairs.\nThe ng-eNB shall send to the UE an RRC Release with releaseCause set to rrc-suspend message that is ciphered and integrity protected in PDCP layer using current AS security context. The ng-eNB shall include a fresh I-RNTI, and an NCC in that RRC Release message. The I-RNTI is used for context identification, and the UE ID part of the I-RNTI assigned by the ng-eNB shall be different in consecutive suspends of the same UE. This is to avoid tracking of UEs based on the I-RNTI. If the ng-eNB has a fresh and unused pair of {NCC, NH}, the ng-eNB shall include the NCC in the RRC Release message. Otherwise, the ng-eNB shall include the same NCC associated with the current KgNB in the RRC Release message. The NCC is used for AS security.\nThe ng-eNB shall delete the current AS keys KRRCenc, KUPenc (if available), and KUPint (if available) after sending the RRC Release message to the UE, but shall keep the current AS key KRRCint. If the sent NCC value is fresh and belongs to an unused pair of {NCC, NH}, the ng-eNB shall save the pair of {NCC, NH} in the current UE AS security context and shall delete the current AS key KgNB. If the sent NCC value is equal to the NCC value associated with the current KgNB, the ng-eNB shall keep the current AS key KgNB and NCC. The ng-eNB shall store the sent I-RNTI together with the current UE context including the remainder of the AS security context.\nUpon receiving the RRC Release with releaseCause set to rrc-suspend message from the ng-eNB, the UE shall decrypt the RRC Release message using the KRRCenc key and verify that the integrity of the received the RRC Release message is correct by checking the PDCP MAC-I. If this verification is successful, then the UE shall take the received NCC value and save it as stored NCC with the current UE context.\nWhen the UE using user plane CIoT 5GS Optimization decides to resume the RRC connection in CM-IDLE with suspend, the UE sends the RRC Resume Request message on SRB0 (i.e. it is not integrity protected). The UE shall include I-RNTI and a ShortResumeMAC-I in RRC Resume Request message. The I-RNTI is used for context identification and its value shall be the same as the I-RNTI that the UE had received from the source ng-eNB in the RRC Release with releaseCause set to rrc-suspend message in the source cell. The ShortResumeMAC-I is a 16-bit message authentication token, the UE shall calculate it using the integrity algorithm (EIA) in the stored AS security context, which was negotiated between the UE and the source ng-eNB and the current KRRCint with the following inputs:\n- \tKEY\t\t\t: it shall be set to current KRRCint;\n-\tBEARER\t\t: all its bits shall be set to 1.\n-\tDIRECTION\t: its bit shall be set to 1;\n-\tCOUNT\t\t: all its bits shall be set to 1;\n-\tMESSAGE\t: it shall be set to VarShortResumeMAC-Input as defined in TS 36.331 [69] for ng-eNB with the following inputs:\nsource C-RNTI, source PCI, resume constant, target Cell-ID.\nThe source PCI and source C-RNTI are associated with the cell where the UE was suspended. The target Cell-ID is the identity of the target cell where the UE sends the RRC Resume Request message. The resume constant allows differentiation of VarShortResumeMAC from VarShortMAC.\nFor protection of all RRC messages except RRC Reject message following the sent RRC Resume Request message, the UE shall derive a KNG-RAN* using the target PCI, target EARFCN-DL and the KgNB/NH based on either a horizontal key derivation or a vertical key derivation as defined in clause 6.9.2.1.1 and Annex A.12. The UE shall further derive KRRCint, KRRCenc, KUPenc (optionally), and KUPint (optionally) from the newly derived KNG-RAN*. Then the UE resets all PDCP COUNTs to 0 and activates the new AS keys in PDCP layer.\nWhen the target ng-eNB receives the RRC Resume Request message from the UE, the target ng-eNB extracts the I-RNTI from the RRC Resume Request message. The target ng-eNB contacts the source ng-eNB based on the information in the I-RNTI by sending an Xn-AP Retrieve UE Context Request message with the following included: I-RNTI, ShortResumeMAC-I and target Cell-ID, in order to allow the source ng-eNB to validate the UE request and to retrieve the UE context including the UE 5G AS security context.\nThe source ng-eNB retrieves the stored UE context including the UE 5G AS security context from its database using the I-RNTI. The source ng-eNB verifies the shortResumeMAC-I using the current KRRCint key stored in the retrieved UE 5G AS security context (calculating the shortResumeMAC-I in the same way as described above). If the verification of the shortResumeMAC-I is successful, then the source ng-eNB calculates KNG-RAN* using the target cell PCI, target EARFCN-DL and the KgNB/NH in the current UE 5G AS security context based on either a horizontal key derivation or a vertical key derivation according to whether the source ng-eNB has an unused pair of {NCC, NH} as described in Annex A.12. The source ng-eNB can obtain the target PCI and target EARFCN-DL from a cell configuration database by means of the target Cell-ID which was received from the target ng-eNB. Then the source ng-eNB shall respond with an Xn-AP Retrieve UE Context Response message to the target ng-eNB including the UE context that contains the UE 5G AS security context. The UE 5G AS security context sent to the target ng-eNB shall include the newly derived KNG-RAN*, the NCC associated to the KNG-RAN*, the UE EPS security capabilities, UP security policy, the UP security activation status, and the ciphering and integrity algorithms used by the UE with the source cell.\nThe target ng-eNB shall check if it supports the ciphering and integrity algorithms the UE used with the last source cell. If the target ng-eNB does not support the ciphering and integrity algorithms used in the last source cell or if the target ng-eNB prefers to use different algorithms than the source ng-eNB, then the target ng-eNB shall send an RRC Setup message on SRB0 to the UE in order to proceed with RRC connection establishment as if the UE was in RRC_IDLE (i.e., a fallback procedure).\nIf the target ng-eNB supports the ciphering and integrity algorithms used with the last source cell and these algorithms are the chosen algorithms by the target ng-eNB, the target ng-eNB shall derive new AS keys (RRC integrity key, RRC encryption key and UP keys) using the algorithms the UE used with the source cell and the received KNG-RAN*. The target ng-eNB shall reset all PDCP COUNTs to 0 and activate the new keys in PDCP layer. The target ng-eNB shall respond to the UE with an RRC Resume message on SRB1 which is integrity protected and ciphered in PDCP layer using the new RRC keys.\nIf the UP security activation status can be supported in the target ng-eNB, the target ng-eNB shall use the UP security activations that the UE used at the last source cell.\nWhen the UE receives the RRC Resume message, the UE shall decrypt the message using the KRRCenc that was derived based on the newly derived KNG-RAN*. The UE shall also verify the RRC Resume message by verifying the PDCP MAC-I using the KRRCint that was derived from the newly derived KNG-RAN* If verification of the RRC Resume message is successful, the UE shall delete the current KRRCint key and the UE shall save the KRRCint, KRRCenc, KUPenc (optionally), and KUPint (optionally) from the newly derived KNG-RAN* as part of the UE current AS security context. In this case, the UE shall send the RRC Resume Complete message both integrity protected and ciphered to the target ng-eNB on SRB1 using the current KRRCint and KRRCenc. The UE shall use the UP security activations status to protect the UP data.\nIf the UE receives RRC Reject message from the target ng-eNB in response to the RRC Resume Request message, the UE shall delete newly derived AS keys used for connection resumption attempt, including newly derived KNG-RAN*, newly derived RRC integrity key, RRC encryption key and UP keys, and keep the current KRRCint and the KgNB/NH in its current AS context. In that case, for the next resume to any target ng-eNB, the UE shall start with the same AS security context as it had when it was suspended originally, i.e., same KgNB/NH shall act as base key for derivation of new KNG-RAN*.\nAfter a successful resume, the target ng-eNB shall perform Path Switch procedure with the AMF as is done in case of X2-handover. The AMF shall verify the UE security capability as described in the clause 6.7.3.1, and the SMF shall verify the UE’s UP security policy as described in the clause 6.6.1.\nWhen EDT or PUR feature is used, the UE shall use newly derived KUPenc to encrypt the UL UP data according to the UP security activations before transmitting the RRC Resume Request message, and send the encrypted UL UP data in the PDCP layer with RRC Resume Request message to the target ng-eNB. The target ng-eNB shall use newly derived KUPenc key to get the UL UP data according to the UP security activations after retrieving UE context from the source ng-eNB. The UE and the target eNB shall use the same KUPenc key and UP security activation to protect the DL data (if included) in PDCP layer in the RRC Release or RRC Resume message.\nNOTE:\tUP security policy is only applicable for UP ciphering as UP integrity protection is not supported.\nThe target ng-eNB may be the same as the source ng-eNB in the description in the previous subclause. If so the single ng-eNB performs the roles of both the source and target ng-eNB. In particular, a new KNG-RAN* shall be derived even if the UE is resuming to the same cell from where it was suspended. However, there is the following difference.\nAfter a successful resume, the ng-eNB shall send N2 Resume Request message to the AMF.  Upon reception of the N2 Resume Request message, the AMF shall check its local policy. If the local policy in the AMF indicates that a new NH derivation is needed, the AMF shall increase its locally kept NCC value by one and compute a fresh NH from its stored data using the function defined in Annex A.10. The AMF shall store that fresh pair and send it to the ng-eNB in the N2 Resume Response message.\nUpon receipt of the N2 Resume Response message from the AMF and if the message includes a {NH, NCC} pair, the ng-eNB shall store the {NH, NCC} pair in the N2 Resume Response message and remove any existing unused stored {NH, NCC} pairs. The {NH, NCC} pair may be used in the next suspend/resume or Xn handover procedures.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.16.3\tProtection of Non-IP Data Delivery (NIDD) interfaces",
                            "text_content": "Functions for NIDD may be used to handle Mobile Originated (MO) and Mobile Terminated (MT) communication with UEs, where the data used for the communication is considered unstructured (which is also referred as Non-IP).\nSince the NEF exposes the NIDD API, TLS protection mechanism defined in clause 12 shall be used for protection of NIDD interfaces.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "6.16.4\tSecurity handling in NAS based redirection from 5GS to EPS",
                            "text_content": "When a UE initiates registration procedure with the AMF, the AMF may redirect the UE from 5GC to EPC by including a EMM cause indicating to the UE that it shall not use 5GC, as described in clause 5.31.3 in TS 23.501 [2]. The following requirements apply to Registration Reject message with an EMM cause which indicates to the UE that the UE shall not use 5GC:\n-\tthe AMF shall only send such a Registration Reject message once NAS security has been established between the AMF and the UE; and\n-\tthe UE shall only act upon such Registration Reject message if received integrity protected and if UE has verified the integrity of the Registration Reject message successfully.\nNOTE:\tThis solution does not apply to unauthenticated emergency calls.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "7\tSecurity for non-3GPP access to the 5G core network",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "7.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "Security for non-3GPP access to the 5G Core network is achieved by a procedure using IKEv2 as defined in RFC 7296 [25] to set up one or more IPsec ESP [4] security associations. The role of IKE initiator (or client) is taken by the UE, and the role of IKE responder (or server) is taken by the N3IWF.\nDuring this procedure, the AMF delivers a key KN3IWF to the N3IWF. The AMF derives the key KN3IWF from the key KAMF. The key KN3IWF is then used by UE and N3IWF to complete authentication within IKEv2.\nSecurity for trusted non-3GPP access to 5G Core network is defined in clause 7A.\nTrusted and untrusted Non-3GPP Access Networks are IP access networks that use access technology whose specification is out of the scope of 3GPP.\nWhether a non-3GPP IP access network is trusted or untrusted is not a characteristic of the access network.\nIn non-roaming scenario it is the HPLMN's operator decision if a non-3GPP IP access network is used as trusted or untrusted non-3GPP access Network. When one or more of the security feature groups provided by the non-3GPP access network are considered not sufficiently secure by the home operator, the non-3GPP access may be identified as an untrusted non-3GPP access for that operator. However, this policy decision may additionally be based on reasons not related to security feature groups.\nIn roaming scenario, the UDM in HPLMN makes the final decision of whether a non-3GPP IP access network is used as trusted or untrusted non-3GPP access network based on the identities of the access network and the visited network. The UDM may take the VPLMN's policy and capability returned from the AMF or roaming agreement into account\nFor supporting multiple DNs, the same trust relationship shall apply to all the DNs the UE connects to from a certain non-3GPP access network, i.e. it shall not be possible to access one DN using the non-3GPP access network as trusted, while access to another PDN using the same non-3GPP access network as untrusted.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7.1a\tDetermining trust relationship in the UE",
                    "description": "",
                    "summary": "",
                    "text_content": "There are various possibilities to determine the trust relationship in the UE as it is described in TS 23.501 [2]. For example, the non-3GPP access networks, which are trusted, can be pre-configured in the UE.  If the USIM supports non-3GPP access networks service, the home network operator may configure in the USIM a list of trusted non-3GPP access networks. In case of pre-configured information in the UE, the list of trusted non-3GPP access networks pre-configured by the home network operator in the USIM shall take precedence over information pre-configured in the ME.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7.2\tSecurity procedures",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7.2.1\tAuthentication for Untrusted non-3GPP Access",
                            "text_content": "This clause specifies how a UE is authenticated to 5G network via an untrusted non-3GPP access network. It uses a vendor-specific EAP method called \"EAP-5G\", utilizing the \"Expanded\" EAP type and the existing 3GPP Vendor-Id, registered with IANA under the SMI Private Enterprise Code registry. The \"EAP-5G\" method is used between the UE and the N3IWF and is utilized for encapsulating NAS messages. If the UE needs to be authenticated by the 3GPP home network, any of the authentication methods as described in clause 6.1.3 can be used. The method is executed between the UE and AUSF as shown below.\nWhen possible, the UE shall be authenticated by reusing the existing UE NAS security context in AMF.\nThe figure depicts a network authentication scheme for untrusted non-3GPP access, illustrating the use of a key exchange protocol to ensure secure communication.\nFigure 7.2.1-1: Authentication for untrusted non-3GPP access\n1.\tThe UE connects to an untrusted non-3GPP access network with procedures outside the scope of 3GPP. When the UE decides to attach to 5GC network, the UE selects an N3IWF in a 5G PLMN, as described in TS 23.501 [2] clause 6.3.6.\n2.\tThe UE proceeds with the establishment of an IPsec Security Association (SA) with the selected N3IWF by initiating an IKE initial exchange according to RFC 7296 [25]. After step 2 all subsequent IKE messages are encrypted and integrity protected by using the IKE SA established in this step.\n3.\tThe UE shall initiate an IKE_AUTH exchange by sending an IKE_AUTH request message. The AUTH payload is not included in the IKE_AUTH request message, which indicates that the IKE_AUTH exchange shall use EAP signalling (in this case EAP-5G signalling). As per the RFC 7296 [25], in the IDi the UE shall set the ID type as ID_KEY-ID in this message and set its value equal to any random number. The UE shall not use its GUTI/SUCI/SUPI as the Id in this step. If the UE is provisioned with the N3IWF root certificate, it shall include the CERTREQ payload within the IKE_AUTH request message to request N3IWF’s certificate.\n4.\tThe N3IWF responds with an IKE_AUTH response message which includes the N3IWF identity, the AUTH payload to protect the previous message it sent to the UE (in the IKE_SA_INIT exchange) and an EAP-Request/5G-Start packet. The EAP-Request/5G-Start packet informs the UE to initiate an EAP-5G session, i.e. to start sending NAS messages encapsulated within EAP-5G packets. If the UE has sent a CERTREQ payload in step 3, the N3IWF shall also include the CERT payload including N3IWF certificate.\n5.\tThe UE shall validate the N3IWF certificate and shall confirm that the N3IWF identity matches the N3IWF selected by the UE. An absence of the certificate from the N3IWF if the UE had requested the certificate  or unsuccessful identity confirmation shall result in a connection failure. The UE shall send an IKE_AUTH request which includes an EAP-Response/5G-NAS packet that contains a Registration Request message containing UE security capabilities and the SUCI. If UE is already with the 5GC over 3GPP access and there is an available security context, the UE shall integrity protect the Registration Request message and shall send the 5G-GUTI instead of SUCI. The N3IWF shall refrain from sending an EAP-Identity request. The UE may ignore an EAP Identity request or respond with the SUCI it sent in the Registration Request. If the UE has registered to the same AMF through 3GPP access, and if this is the first time that the UE connects to the 5GC through non-3GPP access, the value of corresponding UL NAS COUNT used for integrity protection is 0; else it can use the existing non-3GPP specific UL NAS COUNT for integrity protection\nNOTE: \tThe N3IWF does not send an EAP-Identity request because the UE includes its identity in the IKE_AUTH request in message 5. This is in line with RFC 7296 [25], clause 3.16.\n6.\tThe N3IWF shall select an AMF as specified in TS 23.501 [2], clause 6.5.3. The N3IWF forwards the Registration Request received from the UE to the AMF.\n7.\tIf the AMF receives a 5G-GUTI and the Registration is integrity protected, it may use the security context to verify the integrity protection as describe in clause 6.4.6. If the UE has registered to the same AMF through 3GPP access, and if this is the first time that the AMF receives UE’s NAS signalling through non-3GPP access, the value of corresponding UL NAS COUNT used for integrity verification is 0; else it can use the existing non-3GPP specific UL NAS COUNT for integrity verification. If integrity is verified successfully, this means that UE is authenticated by AMF.If integrity is verified successfully and no newer security context has been activated over the 3GPP access, then s the primary authentication and tep 8 to step 11 may be skipped. If integrity is verified successfully and a newer security context has been activated over the 3GPP access then authentication may be skipped but the AMF shall activate the newer context with a NAS SMC procedure as described in step 8 and onwards. Otherwise, the AMF shall authenticate the UE.\nIf the AMF decides to authenticate the UE, it shall use one of the methods from clause 6.1.3. In this case, the AMF shall send a key request to the AUSF. The AUSF may initiate an authentication procedure as specified in clause 6.1.3. Between AMF and UE, the authentication packets are encapsulated within NAS authentication messages and the NAS authentication messages are carried in N2 signalling between the AMF and N3IWF, and then are encapsulated within EAP-5G/5G-NAS packets between the N3IWF and the UE.\nIn the final authentication message from the home network, the AUSF shall send the anchor key KSEAF derived from KAUSF to the SEAF. The SEAF shall derive the KAMF from KSEAF and send it to the AMF which is used by the AMF to derive NAS security keys. If EAP-AKA' is used for authentication as described in clause 6.1.3.1, then the AUSF shall include the EAP-Success. The UE also derives the anchor key KSEAF and from that key it derives the KAMF followed by NAS security keys. The NAS COUNTs associated with NAS connection identifier \"0x02\" are set at the UE and AMF.\n8.\tThe AMF shall send a Security Mode Command (SMC) to the UE in order to activate NAS security associated with NAS connection identifier \"0x02\". This message is first sent to N3IWF (within an N2 message). If EAP-AKA' is used for authentication, the AMF shall encapsulate the EAP-Success received from AUSF within the SMC message.\n9.\tThe N3IWF shall forward the NAS SMC to UE within an EAP-Request/5G-NAS packet.\n10.\tThe UE completes the authentication (if initiated in step 7) and creates a NAS security context or activates another one based on the received ngKSI in the NAS SMC. UE shall respond to the NAS SMC it received from the AMF based on the selected algorithms and parameters as described in clause 6.7.2. The UE shall encapsulate the NAS SMC Complete in the EAP-5G Response.\n11. The N3IWF shall forward the NAS packet containing NAS SMC Complete to the AMF over the N2 interface.\n12. The AMF upon reception of the NAS SMC Complete from the UE or upon success of integrity protection verification, initiates the NGAP procedure to set up the AN context. AMF shall compute the N3IWF key, KN3IWF, using the uplink NAS COUNT associated with NAS connection identifier \"0x02\" as defined in Annex A.9 for the establishment of the IPsec SA between the UE and the N3IWF and shall include it in the NGAP Initial Context Setup Request sent to the N3IWF.\n13. N3IWF sends an EAP-Success/EAP-5G to the UE upon reception of the NGAP Initial Context Setup Request containing the N3IWF key, KN3IWF. This completes the EAP-5G session and no further EAP-5G packets are exchanged. If the N3IWF does not receive the KN3IWF from AMF, the N3IWF shall respond with an EAP-Failure\n14.\tThe IPsec SA is established between the UE and N3IWF by using the N3IWF key KN3IWF that was created in the UE using the uplink NAS COUNT associated with NAS connection identifier \"0x02\" as defined in Annex A.9 and was received by N3IWF from the AMF in step 12.\n15. Upon successful establishment of the IPsec SA between the UE and the N3IWF, the N3IWF shall send the NGAP Initial Context Setup Response message to the AMF.\n15a. The AMF may determine whether the N3IWF is appropriate for the slice selected as defined in clause 4.12.2.2 of TS 23.502[8]. If it is compatible with the selected N3IWF, then proceed with step 16 and step 17. Otherwise, the AMF shall proceed with step 18 to step 20, and step 16 to 17 are skipped.\nCase a):\n16. When NGAP Initial Context Setup Response for the UE is received by the AMF, AMF shall send the NAS Registration Accept message for the UE over the N2 towards the N3IWF.\n17. Upon receiving the NAS Registration Accept message from the AMF, the N3IWF shall forward it to the UE over the established IPsec SA. All further NAS messages between the UE and the N3IWF shall be sent over the established IPsec SA.\nCase b):\n18. The AMF may trigger the UE policy update procedure and update the UE policy as defined in step 15 and step 16 in clause 4.12.2.2 of TS 23.502[8].\n19. The AMF shall send a Registration Reject message via N3IWF to the UE as defined in step 17 in clause 4.12.2.2 of TS 23.502[8]. The Registration Reject message is ciphered and integrity protected.\n20. The UE shall decipher and verify the integrity of the Registration Reject message. If verification is successful, then the UE proceeds with step 18 in clause 4.12.2.2 of TS 23.502[8], and sends a Registration request message to the AMF via a new selected N3IWF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "7A\tSecurity for trusted non-3GPP access to the 5G core network",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "7A.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "Security for trusted non-3GPP access to the 5G Core network is achieved when the UE registers to the 5GC via the TNAN. The UE registers to 5GC and, at the same time, it authenticates with the TNAN by using the EAP-5G procedure, similar to the one used with the registration procedure for untrusted non-3GPP access.\nThe link between the UE and the TNAN can be any data link (L2) that supports EAP encapsulation. The requirement on the Ta interface between the TNAP and TNGF can be found in clause 4.2.8.3.2 of TS 23.501[2]. The TNGF terminates the EAP-5G signalling andfowards the NAS message to the 5GC when the UE attempts to register to 5GC via the TNAN. The security relies on Layer-2 security between UE and TNAP, which is a trusted entity so that no IPSec encryption would be necessary between UE and TNGF, i.e. NULL encryption is sufficient for the user plane and signalling.\nNOTE: The encryption protection over Layer-2 between UE and TNAP is assumed to be enabled.\nSeparate IPSec SAs may be used for NAS transport and PDU Sessions. At the end of the UE’s registration to 5GC, an IPSec SA (NWt) is established between the UE and TNGF. This is used to protect NAS messages between the UE and TNGF. Later when the UE initiates a PDU session establishment, the TNGF initiates establishment of one or more IPSec child SAs per PDU session. This results in additional IPSec SA’s (NWt) to be setup between the UE and TNGF-UP which are then for user plane transport between the two.\nClause 7A.2.4 describes how WLAN UEs that do not support 5GC NAS (N5CW) register via trusted non-3GPP access. Those N5CW devices are able to authenticate to the network with 3GPP credentials and register with the help of an interworking function (TWIF) that provides the 5GC NAS protocol stack towards the AMF.\nAs defined in clause 7.1, it is the home operator policy decision if a non-3GPP access network is treated as trusted non-3GPP access network. When all of the security domains in clause 4.1 of the present specification related to the non-3GPP access network are considered sufficiently secure by the home operator, the non-3GPP access may be identified as a trusted non-3GPP access for that operator. However, this policy decision may additionally be based on reasons not related to security feature groups.\nNOTE: It is specified in clause 7.1a of the current document how the UE gets the operator policy and how it will behave accordingly.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7A.2\tSecurity procedures",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7A.2.1\tAuthentication for trusted non-3GPP access",
                            "text_content": "This clause specifies how a UE is authenticated to 5G network via a trusted non-3GPP access network.\nThis is based on the specified procedure in TS 23.502 [8] clause 4.12a.2.2 \"Registration procedure for trusted non-3GPP access\". The authentication procedure is similar to the authentication procedure for Untrusted non-3GPP access defined in clause 7.2.1 with few differences, which are mentioned below:\nThe figure depicts a registration and authentication process for trusted non-3GPP access, with a focus on the establishment of a PDU session for the registration and authentication process.\nFigure 7A.2.1-1: Registration \\ Authentication and PDU Session establishment for trusted non-3GPP access\n0.\tThe UE selects a PLMN and a TNAN for connecting to this PLMN by using the Trusted Non-3GPP Access Network selection procedure specified in TS 23.501 [2] clause 6.3.12. During this procedure, the UE discovers the PLMNs with which the TNAN supports trusted connectivity (e.g. \"5G connectivity\").\n1.\tA layer-2 connection is established between the UE and the TNAP. In case of IEEE 802.11 [80], this step corresponds to an 802.11 [80] Association. In case of PPP, this step corresponds to a PPP LCP negotiation. In other types of non-3GPP access (e.g. Ethernet), this step may not be required.\n2-3.\tAn EAP authentication procedure is initiated. EAP messages shall be encapsulated into layer-2 packets, e.g. into IEEE 802.3/802.1x packets, into IEEE 802.11/802.1x packets, into PPP packets, etc. The UE provides a NAI that triggers the TNAP to send a AAA request to a TNGF. Between the TNAP and TNGF the EAP packets are encapsulated into AAA messages.\n4-10.\tAn EAP-5G procedure is executed as specified in clause 7.2.1with the following modifications:\n-\tThe EAP-5G packets shall not be encapsulated into IKEv2 packets. The UE shall also include a UE Id in the AN parameter, e.g. a 5G-GUTI if available from a prior registration to the same PLMN.\n-\tA KTNGF as specified in clause Annex A.9 (equivalent to KN3IWF) is created in the UE and in the AMF after the successful authentication. The KTNGF is transferred from the AMF to TNGF in step 10a (within the N2 Initial Context Setup Request).\n-\tThe TNAP is a trusted entity. The TNGF shall generate the KTNAP as specified in Annex A.22 and transfers it from TNGF to TNAP in step 10b (within a AAA message).\n-\tAfter receiving the TNGF key from AMF in step 10a, the TNGF shall send to UE an EAP-Request/5G-Notification packet containing the \"TNGF Contact Info\", which includes the IP address of TNGF. After receiving an EAP-Response/5G-Notification packet from the UE, the TNGF shall send message 10d containing the EAP-Success packet.\n11.\tThe common TNAP key is used by the UE and TNAP to derive security keys according to the applied non-3GPP technology and to establish a security association to protect all subsequent traffic. In case of IEEE 802.11 [80], the KTNAP is the Pairwise Master Key (PMK) and a 4-way handshake is executed (see IEEE 802.11 [80]) which establishes a security context between the WLAN AP and the UE that is used to protect unicast and multicast traffic over the air. All messages between UE and TNAP are encrypted and integrity protected from this step onwards.\nNOTE 1: whether step 11 is performed out of the scope of this document. The current procedure assumes the encryption protection over Layer-2 between UE and TNAP is to be enabled.\n12.\tThe UE receives IP configuration from the TNAN, e.g. with DHCP.\n13.\tThe UE shall initiate an IKE_INIT exchange with the TNGF. The UE has received the IP address of TNGF during the EAP-5G signalling in step 9b, subsequently, the UE shall initiate an IKE_AUTH exchange and shall include the same UE Id (i.e. SUCI or 5G-GUTI) as in the UE Id provided in step 5. The common KTIPSe is used for mutual authentication. The key KTIPSec is derived as specified in Annex A.22.NULL encryption is negotiated as specified in RFC 2410 [81]. After step 13c, an IPsec SA is established between the UE and TNGF (i.e. a NWt connection) and it is used to transfer all subsequent NAS messages. This IPsec SA does not apply encryption but only apply integrity protection.\n14.\tAfter the NWtp connection is successfully established, the TNGF responds to AMF with an N2 Initial Context Setup Response message.\n14a. The AMF may determine whether the TNGF is appropriate for the slice selected as defined in clause 4.12.2.2 of TS 23.502[8]. If it is compatible with the selected TNGF, then proceed with steps 15 to step 19. Otherwise, the AMF shall proceed with step 20 to step 22, and step 15 to step 19 are skipped.\nCase a):\n15.\tFinally, the NAS Registration Accept message is sent by the AMF and is forwarded to UE via the established NWt connection.\n16-18. The UE initiates a PDU session establishment. This is carried out exactly as specified in TS 23.502 [8] clause 4.12a.5. The TNGF may establish one or more IPSec child SA’s per PDU session.\n19. User plane data for the established PDU session is transported between the UE and TNGF inside the established IPSec child SA\nCase b:)\n20. The AMF may trigger the UE policy update procedure and update the UE policy as defined in step 17 and step 18 in clause 4.12a.2.2 of TS 23.502[8].\n21. The AMF shall send a Registration Reject message via TNGF to the UE as defined in step 19 to step21 in clause 4.12a.2.2 of TS 23.502[8]. The Registration Reject message is ciphered and integrity protected.\n22. The UE shall decipher and verify the integrity of the Registration Reject message. If verification is successful, then the UE proceeds with step 21 in clause 4.12.2.2 of TS 23.502[8], and sends a Registration request message to the AMF via a new selected TNGF..\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7A.2.2\tVoid",
                            "text_content": "",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7A.2.3\tKey hierarchy for trusted non-3GPP access",
                            "text_content": "The key hierarchy described in clause 6.2.1 applies, with the following changes:\nThe key derived for non-3GPP access is called KTNGF in the context of trusted access.\nThe key KTNGF received from AMF is used for two different purposes; to setup IPSec SAs between the UE and the TNGF and to create WLAN keys between the UE and the TNAP.\nTo separate the keys for these purposes, the key hierarchy in Figure 7A.2.3-1 shall be used. The KTIPSec key is used to setup IPSec SAs and the KTNAP key is used to setup access security.\nThe keys KTIPSec and KTNAP are derived as described in Clause A.22.\nThe figure depicts a hierarchical structure for trusted non-3GPP access, with key components such as the access control list (ACL), access control list (ACL), and access control list (ACL). The hierarchy is designed to ensure that only authorized users can access the network, and that unauthorized users are blocked. This helps to maintain network security and prevent unauthorized access.\nFigure 7A.2.3-1 Key hierarchy for trusted non-3GPP access\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7A.2.4\tAuthentication for devices that do not support 5GC NAS over WLAN access",
                            "text_content": "A N5CW device is capable to register to 5GC with 3GPP credentials and to establish 5GC connectivity via a trusted WLAN access network. The reference architecture is captured in clause 4.2.8.5.2 of TS 23.501[2]. The 3GPP credentials are stored as defined in clause 6.1.1.1. The Trusted WLAN Interworking Function (TWIF) provides interworking functionality that enables connectivity with 5GC and implements the NAS protocol stack and exchanges NAS messages with the AMF on behalf of the N5CW device. A single EAP-AKA’ authentication procedure is executed for connecting the N5CW device both to the trusted WLAN access network and to the 5G core network.\nThe figure depicts a simplified representation of the authentication procedure for N5CW, a wireless communication protocol. It shows a series of steps, including the use of a key exchange, which is crucial for secure communication. The figure is labeled with the figure name \"Figure 7A. 2 . 4 -1:  Authentication Procedure for N5CW,\" indicating that it is a technical illustration of the authentication process for the N5CW protocol.\nFigure 7A.2.4-1: Authentication Procedure for N5CW\n0.\tThe N5CW device selects a PLMN and a trusted WLAN that supports \"5G connectivity-without-NAS\" to this PLMN by using the procedure specified in TS 23.501 [2] clause 6.3.12a, \"Access Network selection for devices that do not support 5GC NAS over WLAN\".\nSteps 1-10:\tInitial registration to 5GC.\n1.\tThe N5CW device associates with the trusted WLAN network and the EAP-AKA’ authentication procedure is initiated.\n2.\tThe N5CW device shall provide its Network Access Identity (NAI) The Trusted WLAN Access Point (TWAP) selects a Trusted WLAN Interworking Function (TWIF), e.g. based on the received realm, and sends an AAA request to the selected TWIF.\nIf the N5CW device registers to 5GC over 3GPP access for the first time when the above procedure is initiated, then the NAI shall include the SUCI. The SUCI shall be constructed as specified in clause 6.12.2.\nIf the N5CW device has registered to 5GC over 3GPP access when the above procedure is initiated, then the NAI includes the 5G-GUTI assigned to the N5CW device over 3GPP access. This enables the TWIF in step 4a below to select the same AMF as the one serving the N5CW device over 3GPP access.\n3.\tThe TWIF shall create a 5GC Registration Request message on behalf of the N5CW device. The TWIF shall use default values to populate the parameters in the Registration Request message, which are the same for all N5CW device that do not support 5G NAS. The Registration type indicates \"Initial Registration\".\n4.\tThe TWIF shall select an AMF (e.g. by using the 5G-GUTI in the NAI, if provided by the N5CW device) and shall send an N2 message to the AMF including the Registration Request, the User Location and an AN Type.\n5.\tIn case the AMF triggers an authentication procedure, it sends a request to AUSF by sending Nausf_UEAuthentication_Authenticate Request message. The Nausf_UEAuthentication_Authenticate Request message contains SUCI or SUPI (in case of a valid 5G-GUTI is received by the AMF). The request message contains also an indication that the request is from a N5CW device.\nEven if the AMF already has a security context identified by 5G-GUTI, the AMF shall initiate the primary authentication.\nNOTE 1:\tTo avoid key stream reuse when deriving KTWIF from KAMF, the KAMF always needs to be refreshed by a renewed primary authentication.\n6. The AUSF shall send Nudm_UEAuthentication_Get Request to the UDM including SUCI or SUPI and the N5CW indication.\n7. Upon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke SIDF if a SUCI is received. SIDF shall de-conceal SUCI to gain SUPI before UDM can process the request. The UDM may select an authentication method based on the \"realm\" part of the SUPI, the N5CW device indicator, a combination of the \"realm\" part and the N5CW device indicator, or the UDM local policy.\n8. The EAP-AKA’ procedure will be trigged to perform mutual authentication between the N5CW device and the home network as specified in clause 6.1.3.1.\nEAP-AKA' takes place between the N5CW device and AUSF. Over the N2 interface, the EAP messages are encapsulated within NAS Authentication messages. The EAP-AKA’ messages exchanged between the N5CW Device and the TWIF shall be encapsulated into the layer-2 packets, e.g. into IEEE 802.3/802.1x packets, into IEEE 802.11/802.1x packets, into PPP packets, etc.\n9.\tThe NAS security context is not be required in this scenario. The AMF shall derive an KTWIF key from the received KAMF key as specified in Annex A.9. NAS security between AMF and TWIF is established similar to unauthenticated emergency calls, i.e. with NULL encryption and NULL integrity protection.\nNOTE 2:\tN5CW devices does not support NAS; therefore, using the NAS counter is not possible in N5CW devices.\n10a.\tThe AMF shall send NAS Security Mode Command to the TWIF. The NAS Security Mode Command shall contain the EAP-Success message and the NULL security algorithms.\n10b. The TWIF shall not forward the EAP-Success to the N5CW directly, instead, it shall store the EAP-Success message and wait for KTWIF.\n10c. The TWIF shall send the NAS Security Mode Complete message to the AMF.\n11.\tThe AMF sends an N2 Initial Context Setup Request and provides the KTWIF key to TWIF.\n12.\t\tThe TWIF shall derive a TNAP key, KTNAP, from the KTNGF key as specified in Appendix A.22 and send the TNAP key and the EAP-Success message to the Trusted WLAN Access Point, which forwards the EAP-Success to the N5CW device. The TNAP key corresponds to the PMK (Pairwise Master Key) which is  used to secure the WLAN air-interface communication according to IEEE 802.11 [80]. A layer-2 or layer-3 connection is established between the Trusted WLAN Access Point and the TWIF for transporting all user-plane traffic of the N5CW device to TWIF. This connection is later bound to an N3 connection that is created for this N5CW device.\n13. The TWIF shall send N2 Initial Context Setup Response message to the AMF.\n14. The following steps are captured in clause 4.12b.2 of TS 23.502[8].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "7B\tSecurity for wireline access to the 5G core network",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "7B.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "To support Wireless and Wireline Convergence for the 5G system, two new network entities, 5G-RG and FN-RG, are introduced in the architecture specificaction TS 23.501[2].\nThe 5G-RG acts as a 5G UE and can connect to 5GC via wireline access network (W-5GAN) or via Fixed Wireless Access (FWA). Existing security procedures defined in this document are reused. The 5G-RG also acts as end point of N1 and provides the NAS signaling connection to the 5GC on behalf of the AUN3 devices behind the 5G-RG.\nThe FN-RG can connect to 5GC via wireline access network (W-5GAN). The W-AGF performs the registration procedure on behalf of the FN-RG. It acts as end point of N1 and provides the NAS signalling connection to the 5GC on behalf of the FN-RG.\nA 5G -capable UE can connect to 5GC through an RG that’s connected to the 5GC via wireline access network (W-5GAN) or NG-RAN. The UE supports untrusted non-3GPP access and/or trusted non-3GPP access.\nNOTE: Roaming of AUN3, FN-RG and 5G-RG are not supported.\nNOTE: Informative Annex O provides an example of how N5GC devices behind a residential gateway in private or in isolated scenarios with wireline access make use of additional EAP methods for authentication.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.2\tAuthentication for 5G-RG",
                    "description": "",
                    "summary": "",
                    "text_content": "The 5G-RG can be connected to 5GC via W-5GAN, NG RAN or via both accesses. The registration procedure for the 5G-RG connecting to 5GC via NG-RAN is specified in TS 23.316 [79] clause 4.11. The registration procedure for the 5G-RG connecting to 5GC via W-5GAN is specified in TS 23.316 [79] clause 7.2.1.\nThe Untrusted non-3GPP access procedure defined in clause 7.2.1 is used as the basis for registration of the 5G-RG. The 5G-RG shall support both 5G-AKA and EAP-AKA’ and it shall be authenticated by the 3GPP home network. The 5G-RG is equivalent to a normal UE.\nAs 5G-RG is a UE from 5GC point of view, the authentication framework defined in clause 6.1.3 shall be used to authenticate the 5G-RG.\nIn case of 5G-RG connects to 5GC via 5G-RAN, comparing to clause 6.1, the difference is:\n-\tUE is replaced by 5G-RG.\nIn case of 5G-RG connects to 5GC via W-5GAN, a W-CP protocol stack message  shall be used between the 5G-RG and the W-5GAN for encapsulating NAS message. The authentication method is executed between the 5G-RG and AUSF as shown below.\nThe 5G-RG authentication procedure involves the use of a 2-1 authentication scheme, which is a key component of 5G network security. This authentication process ensures that only authorized users can access the network, preventing unauthorized access and potential security breaches. The 2-1 authentication scheme involves two-factor authentication, where the user must provide two different forms of identification, such as a password and a biometric identifier, to access the network. This ensures that only authorized users can access the network and prevents unauthorized access.\nFigure 7B.2-1 5G-RG authentication procedure\n1.\t5G-RG establishes a W-CP connection with a W-5GAN. The detail of connection is out of the scope of 3GPP.\n2.\t(void)\n3.\tThe 5G-RG shall send a message using W-CP protocol stack  that contains a Registration message containing UE security capabilities and the SUCI. If there is an available security context, the 5G-RG shall integrity protect the Registration Request message and shall send the 5G-GUTI instead of SUCI. If the 5G-RG has registered to the same AMF through NG RAN, and if this is the first time that the 5G-RG connects to the 5GC throughW-5GAN, the value of corresponding UL NAS COUNT used for integrity protection is 0; else it can use the existing non-3GPP specific UL NAS COUNT for integrity protection.\nNOTE: \tSince the 5G-RG will not use non-3GPP access, and to avoid to create new category of security context, so the non-3GPP specific security context is used to refer to the security context that 5G-RG is used through wireline access.\n4.\tThe W-AGF shall select an AMF as specified in TS 23.316[79]. The W-AGF shall then forward the Registration Request received from the UE to the selected AMF within an N2 initial UE message\n5.\tIf the AMF receives a 5G-GUTI and the Registration is integrity protected, it may use the security context to verify the integrity protection as describe in clause 6.4.6. If the 5G-RG has registered to the same AMF through NG RAN, and if this is the first time that the AMF receives UE’s NAS signalling through wireline access, the value of corresponding UL NAS COUNT used for integrity verification is 0; else it can use the existing non-3GPP specific UL NAS COUNT for integrity verification. If integrity is verified successfully, it indicates that 5G-RG is authenticated by AMF. If integrity is verified successfully and no newer security context has been activated over the NG RAN, then step 8 to step 11 may be skipped. If integrity is verified successfully and a newer security context has been activated over the NG RAN then authentication may be skipped but the AMF shall activate the newer context with a NAS SMC procedure as described in step 8 and onwards. Otherwise, the AMF shall authenticate the 5G-RG.\nIf the AMF decides to authenticate the 5G-RG, it shall use one of the methods from clause 6.1.3. In this case, the AMF shall send a key request to the AUSF. The AUSF may initiate an authentication procedure as specified in clause 6.1.3. Between AMF and UE (5G-RG), the authentication packets are encapsulated within NAS authentication messages and the NAS authentication messages are carried in N2 signalling between the AMF and W-AGF, and then are encapsulated using W-CP protocol stack message between the W-AGF and the UE (5G-RG).\nIn the final authentication message from the home network, the AUSF shall send the anchor key KSEAF derived from KAUSF to the SEAF. The SEAF shall derive the KAMF from KSEAF and send it to the AMF which is used by the AMF to derive NAS security keys. If EAP-AKA' is used for authentication as described in clause 6.1.3.1, then the AUSF shall include the EAP-Success. The 5G-RG also derives the anchor key KSEAF and from that key it derives the KAMF followed by NAS security keys. The NAS COUNTs associated with NAS connection identifier \"0x02\" are set at the 5G-RG and AMF.\n6.\tThe AMF shall send a Security Mode Command (SMC) to the UE (5G-RG) in order to activate NAS security associated with NAS connection identifier \"0x02\". This message is first sent to W-AGF (within an N2 message). If EAP-AKA' is used for authentication, the AMF shall encapsulate the EAP-Success received from AUSF within the SMC message.\n7.\tThe W-AGF shall forward the NAS SMC to 5G-RG.\n8.\tThe W-AGF shall forward the NAS packet containing NAS SMC Complete to the AMF over the N2 interface.\n9.\tThe AMF upon reception of the NAS SMC Complete from the UE (5G-RG) or upon success of integrity protection verification, initiates the NGAP procedure to set up the AN context. AMF shall compute the W-AGF key, KWAGF that is an equivalent to key KN3IWF, using the uplink NAS COUNT associated with NAS connection identifier \"0x02\" as defined in Annex A.9.\n10.\tUpon receiving NAS Security Mode Complete, the AMF shall send an N2 Initial Context Setup Request message to the W-AGF. The message contains the KWAGF.\nNOTE: \tWhether the key KWAGF is used by the 5G-RG and W-AGF is out of the scope of 3GPP.\n11. (void)\n12.\tUpon receiving the NAS Registration Accept message from the AMF, the W-AGF shall forward it to the 5G-RG over the established W-CP. All further NAS messages between the UE and the W-AGF shall be sent over the established W-CP.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.3\tAuthentication for FN-RG",
                    "description": "",
                    "summary": "",
                    "text_content": "The FN-RG connects to 5GC via W-5GAN, which has the W-AGF function that provides connectivity to the 5GC via N2 and N3 reference points. Since the FN-RG is a non-wireless entity defined by BBF or CableLabs, it doesn’t support N1. The W-AGF provides N1 connectivity on behalf of the FN-RG. The authentication method is executed between the FN-RG and AUSF as shown in Figure 7B.c.\nThe W-AGF may authenticate the FN-RG; this is controlled by local policies.\nIt is assumed that there is a trust relationship between the wireline operator that manages the W-5GAN and the PLMN operator managing the 5GC. The AMF trusts the W-5GAN based on mutual authentication executed when security is established on the interface between the two using NDS/IP or DTLS.\n\nThe figure depicts the FN-RG authentication procedure, which involves the use of a key exchange protocol to ensure secure communication between the client and the server. The diagram illustrates the key exchange process, including the generation of a random key, the exchange of the key, and the verification of the key exchange. The figure also shows the client's response to the key exchange, which is a secure handshake. The diagram is crucial for understanding the security measures in the FN-RG authentication process.\nFigure7B.c FN-RG authentication procedure\n1. A layer-2 (L2) connection is established between the FN-RG and the FAGF function in the W-AGF.\n2. The FN-RG is authenticated by the W-AGF. Authentication method used for FN-RG is defined by BBF or CableLabs and out of scope of 3GPP.\n3-4. The W-AGF shall perform initial registration on behalf of the FN-RG. The W-AGF shall generate a Registration Request message and send it to the AMF over N2. The Registration Request message contains the SUCI of the FN-RG. The N2 message contains an indication that the W-AGF has authenticated the FN-RG.\n5. The AMF shall select an AUSF based on the received SUCI. The AMF shall send a Nausf_UEAuthentication_Authenticate Request message to the AUSF. It contains the SUCI of the FN-RG. It also contains the authenticated indication generated by the W-AGF.\n6. The AUSF shall send a Nudm_UEAuthentication_Get Request to the UDM. It contains the SUCI of the FN-RG and the authenticated indication.\n7. The UDM shall invoke the SIDF and maps the SUCI to the SUPI.\n8. The UDM decides, based on the subscription profile of the SUPI and the authenticated indication that authentication has been completed by the W-5GAN, that authentication by the home network is not required for the FN-RG.\n9. The UDM shall send a Nudm_UEAuthentication_Get Response to the AUSF. It contains the SUPI of the FN-RG and an indication that authentication by the home network is not required.\n10. After checking the indication set by the UDM, The AUSF shall not perform authentication and shall send a Nausf_UEAuthentication_Authenticate Response to the AMF. It contains the SUPI of the FN-RG and the indication that authentication by the home network is not required set by the UDM.\nThis response from AUSF indicates that authentication is not required, and no KSEAF is included.\n11. After checking the indication to make sure that the authentication by the home network is not required, the AMF shall estabilish the NAS security between AMF and W-AGF with NULL encryption and NULL integrity protection.\n12. The AMF shall send Registration Accept message to the W-AGF. This message contains 5G-GUTI and other parameters.\n13. The W-AGF shall send a Registration Complete message back to the AMF. The W-AGF shall store the 5G-GUTI for use in later NAS procedures.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.4\tAuthentication for UE behind 5G-RG and FN-RG",
                    "description": "",
                    "summary": "",
                    "text_content": "A UE that is connected to a 5G-RG or FN-RG, can access the 5GC via the N3IWF or via the TNGF.\nA UE behind a FN-RG can use the untrusted non-3GPP access procedure as defined in TS 23.502[8] clause 4.12.2.2 to access the 5GC via the N3IWF.\nA UE behind a 5G-RG can use either the untrusted non-3GPP access as defined in TS 23.502[8] clause 4.12.2.2, or trusted N3GPP-access as defined in TS 23.502 [8] clause 4.12a.2.2.\nA UE connecting to the 5G-RG or FN-RG via WLAN supporting IEEE 802.1X can use the NSWO authentication procedure as specified in Annex S of the present document.\nWhen the UE uses untrusted non-3GPP access, the authentication of the UE is as specified in clause 7.2.1.\nWhen the UE uses trusted non-3GPP access, the authentication of the UE is as specified in clause 7A.2.1.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.5\tSubscriber privacy for wireline access",
                    "description": "",
                    "summary": "",
                    "text_content": "The requirements and procedures on the UE related to subscriber privacy in clauses 5.2.5, 6.12 and Annex C are applicable for the 5G-RG.\nNOTE 1: The requirements and procedures on the UE related to subscriber privacy in clauses 5.2.5, 6.12 and Annex C are not applicable for the FG-RG.\nNOTE 2: When the SUPI contains a GCI, the 5G-CRG can use the null scheme to construct the SUCI.\nFor a W-AGF representing an FN-RG, the null scheme shall be used to construct the SUCI as described in clauses 4.7.3 and 4.7.4 in TS 23.316 [79].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.6\tSubscriber privacy for N5CW over trusted WLAN access",
                    "description": "",
                    "summary": "",
                    "text_content": "The requirements and procedures on the UE related to subscriber privacy in clauses 5.2.5, 6.12 and Annex C are applicable for the N5CW.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "7B.7\tAuthentication for AUN3 devices behind 5G-RG",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "7B.7.1\tGeneral",
                            "text_content": "An AUN3 device behind 5G-RG, as defined in TS 23.316 [79], shall be registered to the 5GC by the 5G-RG and shall be authenticated by 5GC using EAP-AKA’, as specified in RFC 5448 [12].\nNOTE: the storage of 3GPP credentials for EAP-AKA’ is defined in clause 6.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7B.7.2\tAuthentication for AUN3 devices not supporting 5G key hierarchy",
                            "text_content": "The figure depicts a simplified authentication procedure for AUN3 devices using EAP-AKA, which stands for Extensible Authentication Protocol-Access Key Authentication. The figure illustrates the steps involved in authenticating AUN3 devices, including the use of EAP-AKA for secure communication.\nFigure 7B.7-1 Authentication Procedure for AUN3 devices using EAP-AKA’\n1.  The AUN3 device initiates a layer 2 connection with the 5G-RG either via Ethernet or WLAN. If the layer 2 connection is based on Ethernet, steps 20-21 are skipped.\n2.\tThe 5G-RG shall initiate the EAP authentication procedure by sending an EAP request/Identity to the AUN3 device in a layer 2 frame (e.g., EAPOL).\n3.  The AUN3 device shall send back an EAP response/Identity including its Network Access Identifier (NAI) in the form of username@realm.  If the AUN3 device supports SUPI privacy, the AUN3 device shall send SUCI in the EAP response/Identity.\n4.  The 5G-RG shall construct a SUCI using null-scheme from the NAI-based SUPI if the NAI-based SUPI is received from the AUN3 device in step 3. The 5G-RG shall send a NAS Registration Request message to the AMF, including the SUCI of the AUN3 device and an AUN3 device indicator.\n5.\tThe AMF/SEAF shall select the AUSF based on the SUCI in the received registration request and send to the AUSF a Nausf_UEAuthentication_Authenticate Request message, including the SUCI of the AUN3 device and the AUN3 device indicator.\n6. The AUSF shall send to the UDM a Nudm_UEAuthentication_Get Request message, including the SUCI of the AUN3 device and the AUN3 device indicator.\n7. Upon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke the SIDF to map the SUCI to the SUPI and select EAP-AKA’ as authentication method based on the SUPI and the AUN3 device indicator. The UDM/ARPF shall generate an authentication vector using the Access Network Identity as the KDF input parameter.\n8. The UDM shall send to the AUSF a Nudm_UEAuthentication_Get Response message, including the EAP-AKA’ authentication vector (RAND, AUTN, XRES, CK´ and IK´), the SUPI. According to the AUN3 subscription data, the UDM shall also send the MSK indicator to the AUSF to indicate that the AUN3 device does not support the 5G key hirerachy.\n9. The AUSF shall store XRES for future verification. The AUSF shall send the EAP-Request/AKA'-Challenge message to the AMF/SEAF in a Nausf_UEAuthentication_Authenticate Response message.\n10. The AMF/SEAF shall send the EAP-Request/AKA'-Challenge message to the 5G-RG in the NAS Authentication Request message.\n11. The 5G-RG shall send to the AUN3 device the EAP-Request/AKA'-Challenge message encapsulated in a layer 2 (L2) message.\n12. At receipt the EAP-Request/AKA'-Challenge message, the AUN3 device shall verify the message, generate the authentication response, and derive keys as described in RFC 5448[12].\n13. The AUN3 device shall send the EAP-Response/AKA'-Challenge message to the 5G-RG, encapsulated in a layer 2 message.\n14. The 5G-RG shall send to the AMF/SEAF the EAP-Response/AKA'-Challenge message in an NAS Authentication Response message.\n15. The AMF/SEAF shall send to the AUSF the EAP-Response/AKA'-Challenge message in an Nausf_UEAuthentication_Authenticate Request message.\n16. The AUSF shall verify the AKA’-Challenge message as described in RFC 5448[12]. If successful, based on the MSK indicator received in step 8, the AUSF shall generate the MSK as described in RFC 5448[12] and the AUSF shall not generate the KAUSF.\n17. The AUSF shall send to the AMF/SEAF an Nausf_UEAuthentication_Authenticate Response message including the EAP-Success, the MSK, and the SUPI.\n18.  Based on the received MSK, the AMF shall not generate the KAMF.   The AMF shall send EAP-Success and MSK to the 5G-RG in N1 message.\nStep 18 could be NAS Security Mode Command or Authentication Result. If Step 18 is a NAS Security Mode Command, it uses NULL encryption and NULL integrity protection, since the NAS security context is not required in this scenario.\n19. The 5G-RG sends to the AUN3 device the the EAP-Success message in a layer 2 frame.\n20a-20b. If the layer 2 connection is over WLAN (IEEE 802.11), the AUN3 device and the 5G-RG use the first 256-bit of the MSK as the PMK, from which the WLAN keys are derived.\n21.  The AUN3 and the 5G-RG performs four-way handshaking to establish WLAN secure connection.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "7B.7.3\tAuthentication for AUN3 devices supporting 5G key hierarchy",
                            "text_content": "This clause specifies the how an AUN3 device supporting 5G key hierarchy behind 5G-RG shall be registered to the 5GC by the 5G-RG and shall be authenticated by 5GC using EAP-AKA’.\n\n\n\nFigure 7B.7.3-1 Authentication Procedure for AUN3 devices supporting 5G key hierarchy using EAP-AKA’\nSteps 1-7 are the same as steps 1-7 in clause 7B.7.2.\n8. The UDM shall send to the AUSF a Nudm_UEAuthentication_Get Response message, including the EAP-AKA’ authentication vector (RAND, AUTN, XRES, CK´ and IK´), the SUPI.\nSteps 9-15 are the same as steps 9-15 in clause 7B.7.2.\n16. The AUSF shall verify the AKA’-Challenge message as described in RFC 5448[12]. If successful, the AUSF shall generate the KAUSF as defined in section 6.1.3.1.\n17. The AUSF shall send to the AMF/SEAF an Nausf_UEAuthentication_Authenticate Response message including the EAP-Success, the Anchor key, and the SUPI.\nIn the final authentication message from the home network, if the AUSF has sent the anchor key KSEAF, the SEAF shall derive the KAMF from KSEAF and send it to the AMF.\n18. The AMF shall derive KWAGF key.\n19. The AMF shall send EAP-Success and KWAGF to the 5G-RG in N1 message.\nStep 19 could be NAS Security Mode Command or Authentication Result. If Step 19 is a NAS Security Mode Command, it uses NULL encryption and NULL integrity protection, since the NAS security context is not required in this scenario.\nNOTE: \tWhether the key KWAGF is used by the 5G-RG and W-AGF is out of the scope of 3GPP.\n20. Step 20 is the same as step 19 in clause 7B.7.2.\n21a-21b. If the layer 2 connection is over WLAN (IEEE 802.11), the AUN3 device and the 5G-RG use KWAGF as the PMK, from which the WLAN keys are derived.\n22. Step 22 is the same as step 21 in clause 7B.7.2.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "8\tSecurity of interworking",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "8.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "As described in TS 23.501 [2], in order to interwork with EPC, the UE can operate in Single Registration or Dual Registration mode.\nWhen operating in Dual Registration mode, the UE shall independently maintain and use two different security contexts, an EPS security context to interact with the Evolved Packet System and a 5G security context to interact with the 5G System. Therefore, during inter-system mobility, when the target system is EPS, the UE shall take into use the EPS security context and hence all the security mechanisms described in TS 33.401 [10] are applicable. In the other direction, i.e. when the target system is the 5GC, the UE shall take into use the 5G security context and hence all the security mechanisms described in the present document are applicable.\nWhen operating in Single Registration mode, there are two cases depending on the support of the N26 interface between the AMF and the MME. In both cases the security mechanisms described in all the subsequent sub-clauses are applicable.\nUpon registration during mobility from EPS to 5GS, the UDM may decide to trigger the procedure defined in clause 6.1.5 based on the local operator authentication policy.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "8.2\tRegistration procedure for mobility from EPS to 5GS over N26",
                    "description": "",
                    "summary": "",
                    "text_content": "During mobility from EPS to 5GS, the security handling described below shall apply.\nWhen the UE performs idle mode mobility from EPS to 5GS, and if the UE has a native non-current 5G context, then the UE shall make the native non-current 5G context as the current one. The UE shall discard any mapped 5G security context.\nThe UE shall include the UE 5G security capability alongside the mapped 5G GUTI in the Registration Request message. The UE shall also include the 5G GUTI and the ngKSI that identify a current 5G security context if available, e.g. established during an earlier visit to 5G, and integrity protect the Registration Request using the selected security algorithms in the current 5G NAS security context as it is performed for a 5G NAS message over a 3GPP access. If the UE has no current 5G security context then the UE shall send the Registration Request message without integrity protection. As per clause 5.5.1.2.2 in 3GPP 24.501, the Registration Request shall contain the TAU request or ATTACH request integrity protected using the EPS NAS security context shared with the source MME as it is performed for a LTE NAS message, then the UE shall increment its stored uplink EPS NAS COUNT value by one.\nNOTE: The enclosed TAU request or ATTACH request in the Registration Request contains a complete TAU Request or ATTACH request.\nUpon receipt of the Registration Request, the AMF shall interact with the MME identified by the mapped 5G GUTI to retrieve the UE context. The AMF shall include the enclosed TAU request or ATTACH request in the Context Request message to the MME. The MME shall verify the TAU request or ATTACH request using the stored UE security context and if the verification is successful, the MME shall send the UE context to the AMF.\nThe AMF shall verify the integrity of the Registration Request message if the AMF obtained the 5G security context identified by the 5G GUTI. In case the verification succeeds then the AMF shall then dispose of any EPS security parameters received from the source MME in the Context Response message. In case the verification fails or the 5G UE context is not available then the AMF shall treat the Registration Request message as if it was unprotected. In such case, the AMF may either derive a mapped 5G security context from the EPS context received from the source MME as described in clause 8.6.2 or initiate a primary authentication procedure to create a new native 5G security context. If triggered by home network, the AMF performs the primary authentication as described in clause 6.1.5.\nIf the AMF derives a mapped 5G security context from the EPS security context, then the ngKSI associated with the newly derived mapped 5G security context and the uplink and downlink 5G NAS COUNTs are defined and set as described in clause 8.6.2. If the Registration Request contains a TAU Request or ATTACH request message, the network shall use the uplink EPS NAS COUNT corresponding to the TAU Request or ATTACH request message for deriving the KAMF' from the KASME. The AMF shall use and include the ngKSI to the UE in NAS SMC procedure, for the UE to identify the EPS security context used for the derivation of a mapped 5G security context.  If a mapped 5G security context is created or the native 5G security context has been changed (e.g., due to a new KAMF' derivation or NAS algorithm change), the AMF shall activate the resulting 5G security context by a NAS SMC procedure. When a mapped 5G security context is created, the AMF shall store the selected EPS NAS security algorithms in the mapped 5G security context and include them in the NAS Security Mode Command.\nIf the AMF wants to continue to use the native 5G security context used by the UE to protect the Registration Request, the AMF may skip the NAS SMC procedure and send the Registration Accept message protected using the native 5G security context identified by the 5G-GUTI and the ngKSI included in the Registration Request message.\nIn case the type value in the received ngKSI in NAS SMC indicates a mapped security context, then the UE shall use the value field in the received ngKSI to identify the EPS security context from which the UE derives the mapped 5G security context as described in clause 8.6.2. The UE shall activate the mapped 5G security context to verify the integrity protection of the NAS SMC as it is performed for a 5G NAS message over a 3GPP access.\nThe Registration Accept message shall be protected by the new mapped 5G security context (if a mapped 5G security context was activated by NAS SMC) or by the new native 5G security context (if a new native 5G security context was activated by NAS SMC) as it is performed for a 5G NAS message over a 3GPP access. Otherwise, the current native 5G security context shall be used. If the AMF chooses to derive an initial KgNB from a new KAMF key (either the mapped KAMF' key or the native KAMF key), then the initial KgNB is derived as specified in Annex A.9 using the start value of the uplink 5G NAS COUNT protecting the NAS Security Mode Command Complete message and an access type distinguisher set to \"3GPP access\". If the UE receives an AS SMC message, then the UE shall derive an initial KgNB from a new KAMF key in the same way as the AMF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "8.3\tHandover procedure from 5GS to EPS over N26",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "8.3.1\tGeneral",
                            "text_content": "This subclause covers the case of handover from 5GS to EPS, as defined in TS 23.502 [8].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "8.3.2\tProcedure",
                            "text_content": "\nThe figure depicts a handover from 5G to EPC over N26, illustrating the transition from a 5G network to an EPC network. The figure shows the handover process, including the handover signal, the network topology, and the handover procedure.\nFigure 8.3.2-1 Handover from 5GS to EPC over N26\nNOTE 1:\tThis procedure is based on clause 4.11.1.2.1 in TS 23.502 and only includes steps and description that are relevant to security.\nIf the UE is initially registered and connected to the 5GC, the 5GC has a current security context for the UE. The current 5G security context may be a mapped 5G security context resulting from a previous mobility from EPC, or a native 5G security context resulting from a primary authentication with the 5GC.\n1.\tThe gNB/ng-eNB sends a Handover Required message to the AMF, including UE’s identity .\n2.\tWhen the source AMF performs a handover procedure to the EPC, after checking the UE's access rights and security capabilities, the source AMF shall prepare a UE context including a mapped EPS security context for the target MME. To construct the mapped EPS security context, the source AMF shall derive a K’ASME using the KAMF key and the current downlink 5G NAS COUNT of the current 5G security context as described in clause 8.6.1 and then increments its stored downlink 5G NAS COUNT value by one.\nThe source AMF shall select the EPS NAS algorithms identifiers (it has stored) to be used in the target MME at interworking handover to EPS, for encryption and integrity protection.\nNOTE 2: \tA legacy target MME is expecting to receive the selected EPS NAS algorithms identifiers over N26 from the source AMF as the target MME believes the source AMF is another MME. The source AMF has therefore provisioned the EPS NAS security algorithms identifiers to be used at interworking handover to EPS to the UE in the 5G NAS SMC in 5G access as described in clause 6.7.2. The target MME could re-select different EPS NAS algorithms though to be used with the UE by running a NAS SMC in the following Tracking Area Update procedure.\nThe uplink and downlink EPS NAS COUNT associated with the newly derived KASME' key are set to the values as described in clause 8.6.1. The eKSI for the newly derived KASME' key is defined as described in clause 8.6.1.\nThe source AMF shall also derive the initial KeNB key from the KASME' key and the uplink NAS COUNT as specified in Annex A.3 of TS 33.401 [10] using 232-1 as the value of the uplink NAS COUNT parameter.\nNOTE 3:\tThe source AMF and the UE only uses the 232-1 as the value of the uplink NAS COUNT for the purpose of deriving KeNB and do not actually set the uplink NAS COUNT to 232-1. The reason for choosing such a value not in the normal NAS COUNT range, i.e., [0, 224-1] is to avoid any possibility that the value may be used to derive the same KeNB again.\nThe source AMF subsequently derives NH two times as specified in clause A.4 of TS 33.401 [10]. The {NH, NCC=2} pair is provided to the target MME as a part of UE security context in the Forward Relocation Request message.\n3.\tThe source AMF shall transfer the UE security context (including new KASME', eKSI, uplink and downlink EPS NAS COUNT’s, UE EPS security capabilities, selected EPS NAS algorithms identifiers) to the target MME in the Forward Relocation Request message. The UE NR security capabilities may be sent by the source AMF as well.\n4.\tWhen the target MME receives Forward Relocation Request message from source AMF, then the target MME shall derive EPS NAS keys (i.e., KNASenc and KNASint) from the received KASME' key with the received EPS NAS security algorithm identifiers as input, to be used in EPC as described in Annex A.7 in TS 33.401 [10]. The target MME needs to include the {NH, NCC=2} pair and the UE security capabilities in the S1 HANDOVER REQUEST message to the target LTE eNB. The UE security capabilities include the UE EPS security capabilities received from the source AMF.\n5.\tUpon receipt of the S1 HANDOVER REQUEST from the target MME, the target LTE eNB selects AS security algorithmsfrom the UE EPS security capabilities as described in clause 7.2.4.2.3 in TS 33.401 [10] and computes the KeNB to be used with the UE and proceed as described in clause 7.2.8.4.3 in TS 33.401[10]. The target LTE eNB then sends the selected AS security algorithms in the target to source transparent container in the S1 Handover Request Ack Message to the target MME.\n6.\tThe target MME shall include the target to source transparent container received from the target LTE eNB in the Forward Relocation Response message sent to the source AMF.\n7.\tThe source AMF shall include the target to source transparent container and the 8 LSB of the downlink NAS COUNT value used in KASME’ derivation in step 2, in the Handover command sent to the source gNB/ng-eNB.\n8.\tThe source gNB/ng-eNB shall include the target to source transparent container and the 8 LSB of the downlink NAS COUNT value in the Handover command sent to the UE.\nUpon the reception of the Handover Command message, the UE shall estimate the downlink NAS COUNT value using the received 8 LSB of the downlink NAS COUNT value and its stored downlink NAS COUNT value. The UE shall ensure that the estimated downlink NAS COUNT value is greater than the stored downlink NAS COUNT value. Then, the UE shall derive the mapped EPS security context, i.e. derive KASME' from KAMF as described in clause 8.6.1 using the estimated downlink 5G NAS COUNT value. After the derivation the UE shall set the downlink NAS COUNT value in the 5G NAS security context to the received downlink NAS COUNT value.\n9.\tThe eKSI for the newly derived KASME' key is defined as described in clause 8.6.1. The UE shall also derive the EPS NAS keys (i.e. KNASenc and KNASint) as the MME did in step 4 using the EPS NAS security algorithms identifiers stored in the ME and provisioned by the AMF to the UE in 5G NAS SMC in earlier 5G access. The UE shall also derive the initial KeNB from the KASME' and the uplink NAS COUNT as specified in Annex A.3 of TS 33.401 [10] using 232-1 as the value of the uplink NAS COUNT parameter.\nThe UE shall also derive the {NH, NCC=2} pair as described in A.4 of TS 33.401 [10] and further derive the KeNB to be used with the UE by performing the key derivation defined in Annex A.5 in TS 33.401[10]. The UE shall derive the AS RRC keys and the AS UP keys based on the KeNB and the received AS EPS security algorithms identifiers selected by the target eNB as described in Annex A.7 in TS 33.401 [10]. The uplink and downlink EPS NAS COUNT associated with the derived EPS NAS keys are set to the values as described in clause 8.6.1. The UE shall immediately take into use the newly created mapped EPS security context, both for NAS and AS communication.\n10.  The UE sends the Handover Complete message to the target LTE eNB. The UE shall cipher and integrity protect this message using the newly created mapped EPS security context.\n11.  The target LTE eNB notifies the target MME with a Handover Notify message.\nAfter successful completion of the Handover procedure, the UE shall delete any mapped 5G security context.\nAfter deleting the mapped 5G security context, if the UE has a full non-current native 5G NAS security context then the UE shall make the non-current native 5G NAS security context the current one.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "8.4\tHandover from EPS to 5GS over N26",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "8.4.1\tGeneral",
                            "text_content": "This clause covers the case of handoff from EPS to 5GS, as defined in TS 23.502 [8].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "8.4.2\tProcedure",
                            "text_content": "The figure depicts a handover from an EPS (Enhanced Packet Service) to a 5GS (5G Service) over a N26 (New 26 GHz) frequency band. The handover is facilitated by the use of a 5G-specific handover protocol, which ensures a smooth transition from EPS to 5GS. The figure also highlights the importance of proper handover management, including the use of handover slots, handover delay, and handover rate. The figure provides a visual representation of the handover process, allowing network operators to understand the steps involved and ensure a successful handover.\nFigure 8.4.2-1: Handover from EPS to 5GS over N26\nNOTE 1:\tThis procedure is based on clause 4.11.1.2.2 in TS 23.502 [8] and only includes steps and description that are relevant to security.\nAs the UE is connected to the EPS, the source MME has a current EPS security context for the UE. The current EPS security context may be a mapped EPS security context resulting from a previous mobility from 5GC, or a native EPS security context resulting from a primary authentication with the EPS.\n1.\tThe source eNB sends a Handover Required message to the source MME, including UE's identity .\nNOTE 2:\tThe source MME checks whether the UE's security capabilities and access rights are valid in order to decide whether it can initiate handover to 5GS.\n2.\tThe source MME selects the target AMF and sends a Forward Relocation Request to the selected target AMF. The source MME includes UE's EPS security context including KASME, eKSI, UE EPS security capabilities, selected EPS NAS algorithm identifiers, uplink and downlink EPS NAS COUNTs, {NH, NCC} pair, in this message. If the source MME has the UE NR security capabilities stored, then it will forward the UE NR security capabilities as well to the target AMF.\n3.\tThe target AMF shall construct a mapped 5G security context from the EPS security context received from the source MME. The target AMF shall derive a mapped KAMF' key from the received KASME and the NH value in the EPS security context received from the source MME as described in clause 8.6.2.\nIf the target AMF receives the UE 5G security capabilities, then the target AMF shall select the 5G NAS security algorithms (to be used in the target AMF for encryption and integrity protection) which have the highest priority from its configured list.\nIf the target AMF does not receive the UE 5G security capabilities from the source MME, then the target AMF shall assume that the following default set of 5G security algorithms are supported by the UE (and shall set the UE 5G security capabilities in the mapped 5G NAS security context according to this default set):\na.\tNEA0, 128-NEA1 and 128-NEA2 for NAS signalling ciphering, RRC signalling ciphering and UP ciphering;\nb.\t128-NIA1 and 128-NIA2 for NAS signalling integrity protection, RRC signalling integrity protection and UP integrity protection.\nThe target AMF then derives the complete mapped 5G security context. The target AMF shall derive the 5G NAS keys (i.e., KNASenc and KNASint) from the new KAMF' with the selected 5G NAS security algorithm identifiers as input, to be used in AMF as described in clause A.8. The uplink and downlink 5G NAS COUNTs associated with the derived 5G NAS keys are set to the value as described in clause 8.6. 2. The ngKSI for the newly derived KAMF' key is defined such as the value is taken from the eKSI of the KASME key (i.e. included in the received EPS security context) and the type is set to indicate a mapped security context. The target AMF shall store the EPS NAS security algorithms received from the source MME in the mapped 5G security context. Similar to N2-Handover defined in Clause 6.9.2.3.3, the target AMF shall also set the NCC to zero and shall further derive the temporary KgNB using the mapped KAMF' key and the uplink NAS COUNT value of 232-1 as specified in Annex A.9.\nThe target AMF associates this mapped 5G Security context with ngKSI.\nNOTE 3:\tThe target AMF derives a temporary KgNB using the mapped KAMF' instead of using the {NH, NCC} pair received from the MME. The uplink NAS COUNT value for the initial KgNB derivation is set to 232-1. The reason for choosing such a value is to avoid any possibility that the value may be used to derive the same KgNB again.\nThe target AMF shall create a NAS Container to signal the necessary security parameters to the UE. The NAS Container shall include a NAS MAC, the selected 5G NAS security algorithms, the ngKSI associated with the derived KAMF' and the NCC value associated with the NH parameter used in the derivation of the KAMF'.  The target AMF shall calculate the NAS MAC as described in clause 6.9.2.3.3. with the COUNT parameter set to the maximal value of 232-1.\nThe target AMF shall increment the downlink NAS COUNT by one after creating a NAS Container.\n4.\tThe target AMF requests the target gNB/ng-eNB to establish the bearer(s) by sending the Handover Request message.\nThe target AMF sends the NAS Container created in step 3 along with, the {NCC=0, NH=derived temporary KgNB}, the New Security Context Indicator (NSCI), and the UE security capabilities in the Handover Request message to the target gNB/ng-eNB. The target AMF shall further set the NCC to one and shall further compute a NH as specified in Annex A.10. The target AMF shall further store the {NCC=1, NH} pair.\n5.\tThe target gNB/ng-eNB shall selects the 5G AS security algorithms from the list in the UE security capabilities\nThe target gNB/ng-eNB shall compute the KgNB to be used with the UE by performing the key derivation defined in Annex A.11 with the {NCC, NH} pair received in the Handover Request message and the target PCI and its frequency ARFCN-DL. The target gNB/ng-eNB shall associate the NCC value received from AMF with the KgNB.The target gNB /ng-eNB shall then derive the 5G AS security context, by deriving the 5G AS keys (KRRCint, KRRCenc, KUPint, and KUPenc) from the KgNB and the selected 5G AS security algorithm identifiers as described in Annex A.8 for gNB and in Annex A.7 in TS 33.401[10].\nThe target gNB/ng-eNB sends a Handover Request Ack message to the target AMF. Included in the Handover Request Ack message is the Target to Source Container, which contains the selected 5G AS algorithms, the keySetChangeIndicator, the NCC value from the received {NH, NCC} pair, and the NAS Container received from the target AMF. If the target gNB/ng-eNB had received the NSCI, it shall set the keySetChangeIndicator field to true, otherwise it shall set the keySetChangeIndicator field to false.\n6.\tThe target AMF sends the Forward Relocation Response message to the source MME. The required security parameters obtained from gNB/ng-eNB in step 5 as the Target to Source Container are forwarded to the source MME.\n7.\tThe source MME sends the Handover Command to the source eNB. The source eNB commands the UE to handover to the target 5G network by sending the Handover Command. This message includes all the security related parameters in the NAS Container obtained from the target AMF in step 6.\n8.\tThe UE derives a mapped KAMF' key from the KASME in the same way the AMF did in step 3. It shall also derive the 5G NAS keys and KgNB corresponding to the AMF and the target gNB/ng-eNB in step 3 and step 5. The UE shall further set the selected EPS NAS security algorithms in the 5G security context to the NAS security algorithms used with the source MME. It associates this mapped 5G security context with the ngKSI included in the NAS Container. The UE shall verify the NAS MAC in the NAS Container.\nIf verification of the NAS MAC fails, the UE shall abort the handover procedure. Furthermore, the UE shall discard the new NAS security context if it was derived and continue to use the existing NAS and AS security contexts.\nNOTE 4: \tVoid.\nThe mapped 5G security context shall become the current 5G security context.\n9.\tThe UE sends the Handover Complete message to the target gNB/ng-eNB. This shall be ciphered and integrity protected by the AS keys in the current 5G security context.\n10.\tThe target gNB/ng-eNB notifies the target AMF with a Handover Notify message.\nIf the UE has a native 5G security context established during the previous visit to 5GS, then the UE shall provide the associated the 5G GUTI as an additional GUTI in the Registration Request following the handover procedure. The UE shall use the mapped 5G security context to protect the subsequent Registration Request message over 3GPP access. The target AMF shall validate the integrity of the Registration Request message using the mapped security context. Upon successful validation, the target AMF shall send a context request message to the old AMF and shall include the additional GUTI and an indication that the UE is validated. Upon receiving the context request message with the indication that the UE is validated, the old AMF shall skip the integrity check and transfer the native 5G security context to the target AMF.The AMF shall retrieve the native security context using the 5G GUTI. If the AMF determines to activate the native security context, the AMF shall perform a NAS SMC procedure.\nNOTE 5: It is up to AMF when to activate the native 5G security context.\nIf the handover is not completed successfully, the new mapped 5G security context cannot be used in the future. In this case, the AMF shall delete the new mapped 5G security context.\nIf the AMF has no native 5G security context available when the UE performs the Registration Request (protected by the mapped 5G security context) following the handover procedure, then the AMF via the SEAF should run a primary authentication depending on local operator policy.\nThe handling of security contexts in the case of multiple active NAS connections in the same PLMN’s serving network is given in clasue 6.4.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "8.5\tIdle mode mobility from 5GS to EPS over N26",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "8.5.1\tGeneral",
                            "text_content": "This clause covers the case of idle mode mobility from 5GS to EPS over N26, as defined in TS 23.502 [8].The UE performs either Tracking Area Update (TAU) procedure or Initial Attach procedure in this scenario.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "8.5.2\tTAU Procedure",
                            "text_content": "NOTE:\tThis procedure is based on clause 4.11.1.3.2 in TS 23.502 [8] and only includes steps and descriptions that are relevant to security.\nThe figure depicts the transition from 5G to 4G in an idle mode, illustrating the evolution of mobile network technology.\nFigure 8.5.2-1: Idle mode mobility from 5G to 4G\n1.\tThe UE initiates the TAU procedure by sending a TAU Request to the MME with a mapped EPS GUTI derived from the 5G GUTI and its EPS security capabilities. The mapped EPS GUTI contains the information of the AMF that has the latest UE context in the 5G network.\nThe UE integrity protects the TAU Request message using the current 5G NAS security context identified by the 5G GUTI used to derive the mapped EPS GUTI. More precisely, the UE shall compute the NAS MAC for the TAU request as it is done for a 5G NAS message over a 3GPP access. The NAS Uplink COUNT for integrity protection of the TAU request shall use the same value as the 5G NAS Uplink COUNT. Consequently, this results in an increase of the stored NAS Uplink COUNT value in the NAS COUNT pair associated with the 3GPP access. The corresponding ngKSI value of the 5G Security context is included in the eKSI parameter of the TAU Request message.\n2.\tUpon receipt of the TAU Request, the MME obtains the AMF address from the mapped EPS GUTI value.\n3.\tThe MME forwards the complete TAU Request message including the eKSI, NAS-MAC and mapped EPS GUTI in the Context Request message.\n4.\tThe AMF shall use the eKSI value field to identify the 5G NAS security context and use it to verify the TAU Request message as if it was a 5G NAS message received over 3GPP access.\n5.\tIf the verification is successful, the AMF shall derive a mapped EPS NAS security context as described in clause 8.6.1. The AMF shall set the EPS NAS algorithms to the ones indicated earlier to the UE in a NAS SMC as described in clause 6.7.2.\nThe AMF shall include the mapped EPS NAS security context in the Context Response message it sends to the MME. The AMF shall never transfer 5G security parameters to an entity outside the 5G system.\n6.\tThe UE shall derive a mapped EPS NAS security context as described in clause 8.6.1. The UE shall select the EPS algorithms using the ones received in an earlier NAS SMC from the AMF as described in clause 6.7.2. The UE shall immediately activate the mapped EPS security context and be ready to use it for the processing of the TAU Accept message in step 7.\n7.\tThe MME compares the UE security algorithms to its configured list after it receives the Context Response message. If an algorithm change is required, the MME shall select the NAS algorithm which has the highest priority from its configured list and is also present in the UE 5G security capabilities and initiate an NAS SMC to the UE. Otherwise, step 8~10 shall be skipped.\n8 - 10.\tThe MME and the UE performs an NAS SMC to derive new NAS keys with the new algorithms as described in Clause 7.2.8.1.2 of TS 33.401[10].\n11.\tThe MME completes the procedure with a TAU Accept message.\nAfter successful completion of the TAU procedure, the UE shall delete any mapped 5G security context. After deleting the mapped 5G security context, if the UE has a full non-current native 5G NAS security context then the UE shall make the non-current native 5G NAS security context the current one.\n8.5.3\tInitial Attach Procedure\nNOTE:\tThis procedure is based on clause 4.11.1.5.2 in TS 23.502 [8].\nThe Initial Attach procedure shall use the security mechanism for the TAU procedure in clause 8.5.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "8.6\tMapping of security contexts",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "8.6.1\tMapping of a 5G security context to an EPS security context",
                            "text_content": "The derivation of a mapped EPS security context from a 5G security context is done as described below:\n-\tThe KASME' key, taken as the KASME, shall be derived from the KAMF using the 5G NAS Uplink COUNT value derived from the TAU Request message or Attach Request message in idle mode mobility or the 5G NAS Downlink COUNT value in handovers as described in Annex A.14.\n-\tThe eKSI for the newly derived KASME key shall be defined such as the value field is taken from the ngKSI and the type field is set to indicate a mapped security context.\n-\tThe EPS uplink and downlink NAS COUNT values in the mapped context shall be set to the uplink and downlink NAS COUNT values of the current 5G security context respectively.\n-\tThe selected EPS NAS algorithms shall be set to the EPS algorithms signalled to the UE by the AMF during an early authentication procedure followed by a NAS SMC as described in clause 6.7.2.\nNOTE:\tWhenever an algorithm change is required, the target MME initiates an NAS SMC to select other algorithms as described in TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "8.6.2\tMapping of an EPS security context to a 5G security context",
                            "text_content": "The derivation of a mapped 5G security context from an EPS security is done as described below.\n-\tThe KAMF' key, taken as the KAMF, shall be derived from the KASME using the EPS NAS Uplink COUNT of the TAU message included in the Registration Request message in idle mode mobility or the NH value in handovers as described in clause A.15.\n-\tThe ngKSI for the newly derived KAMF key shall be defined such as the value field is taken from the eKSI and the type field is set to indicate a mapped security context.\n-\tThe 5G NAS COUNT values in the mapped 5G security context shall be set to 0.\nNOTE:\tThe selection of the 5G NAS algorithms is performed by the AMF and signalled to the UE either in the NAS Container during handovers as described in clause 8.4, or in a NAS SMC during idle mode mobility as described in clause 8.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "8.7\tInterworking without N26 interface in single-registration mode",
                    "description": "",
                    "summary": "",
                    "text_content": "When the UE supports single-registration mode and network supports interworking procedure without N26 interface:\n-\tFor mobility from 5GC to EPC, if the UE has a current EPS NAS security context, the UE shall start using the EPS security context as defined in TS 33.401 [10].\n-\tFor mobility from EPC to 5GC, if the UE has a current 5G NAS security context, the UE shall start using the 5G NAS security context as defined in the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "9\tSecurity procedures for non-service based interfaces",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "9.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "9.1.1\tUse of NDS/IP",
                            "text_content": "The protection of IP based interfaces for 5GC and 5G-AN according to NDS/IP is specified in TS 33.210 [3]. Traffic on interfaces carrying control plane signalling can be both integrity and confidentiality protected according to NDS/IP.\nNOTE 1:\tVoid.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "9.1.2\tImplementation requirements",
                            "text_content": "IPsec ESP implementation shall be done according to RFC 4303 [4] as profiled by TS 33.210 [3]. For IPsec implementation, tunnel mode is mandatory to support while transport mode is optional.\nIKEv2 certificate-based authentication implementation shall be done according to TS 33.310 [5]. The certificates shall be supported according to the profile described by TS 33.310 [5]. IKEv2 shall be supported conforming to the IKEv2 profile described in TS 33.310 [5].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "9.1.3\tQoS considerations",
                            "text_content": "If the sender of IPsec traffic uses DiffServ Code Points (DSCPs) to distinguish different QoS classes, either by copying DSCP from the inner IP header or directly setting the encapsulating IP header's DSCP, the resulting traffic may be reordered to the point where the receiving node's anti-replay check discards the packet. If different DSCPs are used on the encapsulating IP header, then to avoid packet discard under one IKE SA and with the same set of traffic selectors, distinct Child-SAs should be established for each of the traffic classes (using the DSCPs as classifiers) as specified in RFC 4301 [6].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "9.2\tSecurity mechanisms for the N2 interface",
                    "description": "",
                    "summary": "",
                    "text_content": "N2 is the reference point between the AMF and the 5G-AN. It is used, among other things, to carry NAS signalling traffic between the UE and the AMF over 3GPP and non-3GPP accesses.\nThe transport of control plane data over N2 shall be integrity, confidentiality and replay-protected.\nIn order to protect the N2 reference point, it is required to implement IPsec ESP and IKEv2 certificates-based authentication as specified in sub-clause 9.1.2 of the present document. IPsec is mandatory to implement on the gNB and the ng-eNB. On the core network side, a SEG may be used to terminate the IPsec tunnel.\nIn addition to IPsec, DTLS shall be supported as specified in RFC 6083 [58] to provide mutual authentication, integrity protection, replay protection and confidentiality protection. Security profiles for DTLS implementation and usage shall follow the TLS profile given in clause 6.2 of TS 33.210 [3] and the certificate profile given in clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks.\nMutual authentication shall be supported over the N2 interface between the AMF and the 5G-AN using DTLS and/or IKEv2.\nNOTE 1: \tThe use of transport layer security, via DTLS, does not rule out the use of network layer protection according to NDS/IP as specified in TS 33.210 [3]. In fact, IPsec has the advantage of providing topology hiding.\nNOTE 2: \tThe use of cryptographic solutions to protect N2 is an operator's decision. In case the NG-RAN node (gNB or ng-eNB) has been placed in a physically secured environment then the 'secure environment' includes other nodes and links beside the NG-RAN node.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.3\tSecurity requirements and procedures on N3",
                    "description": "",
                    "summary": "",
                    "text_content": "N3 is the reference point between the 5G-AN and UPF. It is used to carry user plane data from the UE to the UPF.\nThe transport of user data over N3 shall be integrity, confidentiality and replay-protected.\nIn order to protect the traffic on the N3 reference point, it is required to implement IPsec ESP and IKEv2 certificate-based authentication as specified in sub-clause 9.1.2 of the present document with confidentiality, integrity and replay protection. IPsec is mandatory to implement on the gNB and the ng-eNB. On the core network side, a SEG may be used to terminate the IPsec tunnel.\nNOTE: \tThe use of cryptographic solutions to protect N3 is an operator's decision. In case the NG-RAN node (gNB or ng-eNB) has been placed in a physically secured environment then the 'secure environment' includes other nodes and links beside the NG-RAN node.\nQoS related aspects are further described in sub-clause 9.1.3 of the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.4\tSecurity mechanisms for the Xn interface",
                    "description": "",
                    "summary": "",
                    "text_content": "Xn is the interface connecting NG-RAN nodes. It consists of Xn-C and Xn-U. Xn-C is used to carry signalling and Xn-U user plane data.\nThe transport of control plane data and user data over Xn shall be integrity, confidentiality and replay-protected.\nIn order to protect the traffic on the Xn reference point, it is required to implement IPsec ESP and IKEv2 certificate- based authentication as specified in sub-clause 9.1.2 of the present document with confidentiality, integrity and replay protection. IPsec shall be supported on the gNB and ng-eNB.\nIn addition to IPsec, for the Xn-C interface, DTLS shall be supported as specified in RFC 6083 [58] to provide mutual authentication, integrity protection, replay protection and confidentiality protection. Security profiles for DTLS implementation and usage shall follow the TLS profile given in clause 6.2 of TS 33.210 [3] and the certificate profile given in clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks.\nMutual authentication shall be supported over the Xn interface between the NG-RAN nodes using DTLS and/or IKEv2.\nNOTE 1: \tThe use of transport layer security, via DTLS, does not rule out the use of network layer protection according to NDS/IP as specified in TS 33.210 [3]. In fact, IPsec has the advantage of providing topology hiding..\nNOTE 2: \tThe use of cryptographic solutions to protect Xn is an operator's decision. In case the NG-RAN node (gNB or ng-eNB) has been placed in a physically secured environment then the 'secure environment' includes other nodes and links beside the NG-RAN node.\nQoS related aspects are further described in sub-clause 9.1.3 of the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.5\tInterfaces based on DIAMETER or GTP",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause applies to all DIAMETER or GTP-based interfaces between the 5G Core and other network entities that are not part of the 5G System. These includes the Rx interface between the PCF and the IMS System and the N26 interface between the AMF and the MME.\nThe protection of these interfaces shall be supported according to NDS/IP as specified in TS 33.210 [3], unless security is provided by other means, e.g. physical security. If (D)TLS is used, implementation and usage shall follow the profile given in clause 6.2 of TS 33.210 [3] and clause 6.1.3a of TS 33.310 [5]. The cipher suites in RFC 6733 shall not be supported. A SEG may be used to terminate the NDS/IP IPsec tunnels.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "9.5.1\tVoid",
                            "text_content": "",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "9.6\tVoid",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.7\tVoid",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.8\tSecurity mechanisms for protection of the gNB internal interfaces",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "9.8.1\tGeneral",
                            "text_content": "The following clause applies to the gNB supporting the split architecture.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "9.8.2\tSecurity mechanisms for the F1 interface",
                            "text_content": "The F1 interface connects the gNB-CU to the gNB-DU. It consists of the F1-C for control plane and the F1-U for the user plane. The security mechanisms for the F1 interface connecting the IAB-node to the IAB-donor-CU are detailed in clause M.3.3 of this document.\nIn order to protect the traffic on the F1-U interface, IPsec ESP and IKEv2 certificates-based authentication shall be supported as specified in sub-clause 9.1.2 of the present document with confidentiality, integrity and replay protection.\nIn order to protect the traffic on the F1-C interface, IPsec ESP and IKEv2 certificates-based authentication shall be supported as specified in sub-clause 9.1.2 of the present document with confidentiality, integrity and replay protection.\nIPsec is mandatory to implement on the gNB-DU and on the gNB-CU. On the gNB-CU side, a SEG may be used to terminate the IPsec tunnel.\nIn addition to IPsec, for the F1-C interface, DTLS shall be supported as specified in RFC 6083 [58] to provide mutual authentication, integrity protection, replay protection and confidentiality protection. Security profiles for DTLS implementation and usage shall follow the TLS profile given in clause 6.2 of TS 33.210 [3] and the certificate profile given in clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks..\nMutual authentication shall be supported over the F1-C interface between the gNB-CU and the gNB-DU using DTLS and/or IKEv2.\nNOTE 1: \tThe use of transport layer security, via DTLS, does not rule out the use of network layer protection according to NDS/IP as specified in TS 33.210 [3]. In fact, IPsec has the advantage of providing topology hiding.\nNOTE 2: \tThe use of cryptographic solutions to protect F1 is an operator's decision. In case the gNB or the IAB-node has been placed in a physically secured environment then the 'secure environment' includes other nodes and links beside the gNB or the IAB-node.\nNOTE 3: \tThe security considerations for DTLS over SCTP are documented in RFC 6083 [58].\nNOTE 4:\tThe support of DTLS (with mutual authentication) for F1-C, between the IAB-node (gNB-DU) and the IAB-donor-CU, is optional for the IAB-node and the IAB-donor-CU.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "9.8.3\tSecurity mechanisms for the E1 interface",
                            "text_content": "The E1 interface connects the gNB-CU-CP to the gNB-CU-UP. It is only used for the transport of signalling data.\nIn order to protect the traffic on the E1 interface, IPsec ESP and IKEv2 certificates-based authentication shall be supported as specified in sub-clause 9.1.2 of the present document with confidentiality, integrity and replay protection.\nIn addition to IPsec, DTLS shall be supported as specified in RFC 6083 [58] to provide mutual authentication, integrity protection, replay protection and confidentiality protection. Security profiles for DTLS implementation and usage shall follow the TLS profile given in clause 6.2 of TS 33.210 [3] and the certificate profile given in clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks.\nMutual authentication shall be supported over the E1interface between the gNB-CU-CP and the gNB-CU-UP using DTLS and/or IKEv2.\nIPsec is mandatory to support on the gNB-CU-UP and the gNB-CU-CP. Observe that on both the gNB-CU-CP and the gNB-CU-UP sides, a SEG may be used to terminate the IPsec tunnel.\nNOTE 1: \tThe use of transport layer security, via DTLS, does not rule out the use of network layer protection according to NDS/IP as specified in TS 33.210 [3]. In fact, IPsec has the advantage of providing topology hiding.\nNOTE 2: \tThe use of cryptographic solutions to protect E1 is an operator's decision. In case the gNB has been placed in a physically secured environment then the 'secure environment' includes other nodes and links beside the gNB.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "9.9\tSecurity mechanisms for non-SBA interfaces internal to the 5GC and between PLMNs",
                    "description": "",
                    "summary": "",
                    "text_content": "Non-SBA interfaces internal to the 5G Core such as N4 and N9 can be used to transport signalling data as well as privacy sensitive material, such as user and subscription data, or other parameters, such as security keys. Therefore, these interfaces shall be confidentiality, integrity, and replay protected.\nRoaming interfaces between PLMNs except for N32, shall be confidentiality, integrity, and replay protected. Protection for the N32 interface is specified in clauses 13.1 and 13.2..\nFor the protection of the above mentioned non-SBA internal and roaming interfaces except N32, IPsec ESP and IKEv2 certificate-based authentication shall be supported as specified in sub-clauses 9.1.2 of the present document with confidentiality, integrity and replay protection. This security mechanism shall be used,, unless security is provided by other means, e.g. physical security. A SEG may be used to terminate the IPsec tunnels.\nQoS related aspects are further described in sub-clause 9.1.3 of the present document.\nNOTE:\tIt is up to the operator choice to use cryptographic solutions or other mechanisms to protect internal non-SBA interfaces such as N4 and N9.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "9.10\tSecurity mechanisms for the interface between W-5GAN and 5GC",
                    "description": "",
                    "summary": "",
                    "text_content": "The W-AGF function in Wireline 5G Access network (W-5GAN) terminates the following interfaces:\n- N2 interface between the W-5GAN and the AMF.\n-N3 interface between the W-5GAN and the UPF.\nThe security of the N2 interface between the W-5GAN and the AMF is as defined in clause 9.2 of the present document.\nThe security of the N3 interface between the W-5GAN and the UPF is as defined in clause 9.3 of the present document.\nOn the W-AGF side a SEG may be used to terminate the IPsec tunnels.\nNOTE:\tClauses 9.2 and 9.3 require that the N2 and N3 interfaces are integrity, confidentiality, and replay protected. The same protection can be achieved by placing the AGF in the same trust domain as the AMF and the SMF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "10\tSecurity aspects of IMS emergency session handling",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "10.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause addresses security procedures for IMS emergency session handling.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "10.2\tSecurity procedures and their applicability",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "10.2.1\tAuthenticated IMS Emergency Sessions",
                            "text_content": "Authenticated emergency services are provided to UEs in the following scenarios:\na)\tA UE in RM-DEREGISTERED state requests IMS Emergency services\nIn this scenario, the UE has a valid subscription and is authenticated when it registers with the network.\nb)\tA UE in RM-REGISTERED state initiates a PDU Session request to setup an IMS Emergency Session\nIn this scenario, the UE is already registered with the network and share a security context with the AMF. The UE initiates a session management message to setup a new bearer for emergency services. The request for emergency services is sent protected by the current security context. The AMF may decide to re-authenticate the UE.\nIf there is a redirection of the UE to EUTRAN for IMS Emergency services, the redirect command from the gNB to the UE shall be protected by the UE’s AS security context. The AMF shall send the ‘NG AP UE Initial Context setup’ message to enable the AS security context set up.\nThe UE shall first initiate a normal initial registration procedure to register with the 5G network. Upon successful normal registration, the UE initiates the UE requested PDU session establishment procedure to establish a PDU Session to receive emergency services as specified in TS 23.502 [8].\nAt the time of registration, the security mode control procedure shall be applied to authenticate the UE and setup NAS and AS security. Thus, integrity protection (and optionally ciphering) shall be applied to the emergency bearers as for normal bearers.\nIf authentication fails for any reason, it shall be treated the same way as any registration. Once the IMS Emergency Session is in progress with NAS and AS integrity protection (and optionally ciphering) applied, failure of integrity checking or ciphering (for both NAS and AS) is an unusual circumstance and shall be treated as in the case of a normal bearer.\nThe UE initiates the UE requested PDU session establishment procedure to receive emergency services as specified in clause 5.16.4 in TS 23.501 [2]. Since the UE already has a current 5G security context when it attempts to set up an IMS Emergency Session, the UE shall use this 5G security context to protect NAS, RRC and UP traffic. If the AMF successfully validates the PDU Session request for emergency bearer services using the current 5G security context, the AMF may accept this request and setup a PDU session.\nIf the AMF attempts to re-authenticate the UE after receiving a correctly integrity protected request for emergency bearer services based on the current NAS security context and the authentication failed and if the serving network policy does not allow unauthenticated IMS Emergency Sessions, the UE and AMF shall proceed as for the initial registration error scenario as described in clause 6.1.3.\nIf the AMF attempts to re-authenticate the UE after receiving a correctly integrity protected request for emergency bearer services based on the current NAS security context and the authentication failed and the serving network policy allows unauthenticated IMS Emergency Sessions, then the set up of the emergency bearers shall proceed in one of the two ways:\na)\tThe set-up proceeds according to clause 10.2.2. In this case, there is no need for the UE to re-attach, and the AMF requests the use of the NULL ciphering and integrity algorithms in the same way as described in clause 10.2.2.2 for the case of Emergency registration by UEs in limited service state.\nNOTE 1:\tIf the authentication failure is detected in the AMF then the UE is not aware of the failure in the AMF, but still needs to be prepared, according to the conditions specified in TS 24.301, to accept a NAS SMC from the AMF requesting the use of the NULL ciphering and integrity algorithms.\nNOTE 2:\tRegardless of if the authentication failed in the UE or in the AMF, the AMF can assume that the UE will accept that NULL integrity and ciphering algorithms are selected in the security mode control procedure\nb)\tThe UE and the AMF continues using the current security context as described below for the case when primary authentication is executed while setting up a PDU session for emergency services.\nIf primary authentication procedure is executed while setting up a PDU Session for emergency bearer services, the AMF and UE shall behave as follows:\nUE behavior:\n-\tUpon successful authentication verification in the UE, the UE shall continue using the current security context.\n-\tAlternatively, upon authentication verification failure in the UE, the UE shall send a failure message to the AMF and shall continue using the current security context. If the UE receives a NAS security mode command selecting NULL integrity and ciphering algorithms, the UE shall accept this as long as the IMS Emergency session progresses.\nAMF behavior:\n-\tIf the serving network policy allows unauthenticated IMS Emergency Sessions, the AMF, after the unsuccessful authentication verification of the UE, should not send a reject an Authentication Reject message and continue using the current security context with the UE.\n-\tAfter receiving both, the EC Indication and the failure message from the UE, the AMF shall continue using the current security context with the UE for establishing an emergency bearer.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "10.2.2\tUnauthenticated IMS Emergency Sessions",
                            "text_content": "There are many scenarios when an unauthenticated Emergency Session may be established without the network having to authenticate the UE or apply ciphering or integrity protection for either AS or NAS. For example:\na)\tUEs that are in Limited service state UEs, as specified in clause 3.5 in TS 23.122\nb)\tUEs that have valid subscription but SN cannot complete authentication because of network failure or other reasons\nTS 23.401 clause 4.3.12.1 identifies four possible network behaviours of emergency bearer support. Amongst these, the following two cases are applicable for unauthenticated emergency sessions:\na.\tIMSI required, authentication optional. These UEs shall have a SUPI. If authentication fails, the UE is granted access and the unauthenticated SUPI retained in the network for recording purposes. The PEI is used in the network as the UE identifier. PEI only UEs will be rejected (e.g. UICCless UEs).\nb.\tAll UEs are allowed. Along with authenticated UEs, this includes UEs with a SUPI that cannot be authenticated and UEs with only an PEI. If an unauthenticated SUPI is provided by the UE, the unauthenticated SUPI is retained in the network for recording purposes. The PEI is used in the network to identify the UE.\nThe network policy is configured to one of the above, and accordingly determine how emergency requests from the UE are treated.\nIf the ME receives a NAS SMC selecting NIA0 (NULL integrity) for integrity protection, and NEA0 (NULL ciphering) for encryption protection, then:\n- \tthe ME shall mark any stored native 5G NAS security context on the USIM /non-volatile ME memory as invalid; and\n- \tthe ME shall not update the USIM/non-volatile ME memory with the current 5G NAS security context.\nThese two rules override all other rules regarding updating the 5G NAS security context on the USIM/non-volatile ME memory, in the present document.\nIf NIA0 is used, and the NAS COUNT values wrap around, and a new KAMF has not been established before the NAS COUNT wrap around, the NAS connection shall be kept.\nNOTE:\tFor unauthenticated IMS emergency sessions, NIA0, i.e., null integrity algorithm, is used for integrity protection. Additionally, as the NAS COUNT values can wrap around, the initialization of the NAS COUNT values are not crucial. Uplink and downlink NAS COUNT are incremented for NAS message that use NIA0, as for any other NAS messages.\nA UE without a valid 5G subscription shall at an IRAT handover to 5G, when an IMS Emergency Service is active, be considered by the AMF to be unauthenticated. In such a scenario, EIA0 shall be used in 5G after handover if the target network policy allows unauthenticated IMS Emergency Sessions.\nA handover from 5G to another RAT, of an unauthenticated IMS Emergency Session, shall result in an unauthenticated IMS Emergency Session in the other RAT.\nUEs that are in limited service state (LSM) request emergency services by initiating the Registration procedure with the indication that the registration is to receive emergency services, referred to as Emergency Registration.\nUEs that had earlier registered for normal services but now cannot be authenticated by the serving network, shall initiate Emergency Registration procedure to request emergency services.\nIt shall be possible to configure whether the network allows or rejects an emergency registration request and whether it allows unauthenticated UEs to establish bearers for unauthenticated IMS emergency sessions or not.\nThe AMF may attempt to authenticate the UE after receiving the emergency registration request.\nIf authentication failed in the UE during an emergency registration request, the UE shall wait for a NAS SMC command to set up an unauthenticated emergency bearer.\nIf authentication failed in the serving network and if the serving network policy does not allow unauthenticated IMS Emergency Sessions, the UE and AMF shall proceed as with the normal initial registration requests. The AMF shall reject the unauthenticated emergency bearer setup request from the UE.\nIf authentication failed in the serving network and if the serving network policy allow unauthenticated IMS Emergency Sessions, then the AMF shall support unauthenticated emergency bearer setup and the behaviours of the UE and the AMF are as described below.\na) UE behaviour:\nAfter sending Emergency Registration request to the serving network the UE shall know of its own intent to establish an unauthenticated IMS Emergency Session.\nThe UE shall proceed as specified for the non-emergency case in except that the UE shall accept a NAS SMC selecting NEA0 and NIA0 algorithms from the AMF. If the UE accepts a NAS SMC selecting NEA0 and NIA0 algorithms from the AMF as part of Emergency Registration request, then the primary authentication performed if any shall be considered as unsuccessful and the newly generated KAUSF is not stored.\nNOTE: \tIn case of authentication success the AMF will send a NAS SMC selecting algorithms with a non-NULL integrity algorithm, and the UE will accept it.\nb) AMF behavior:\nAfter receiving Emergency Registration request from the UE, the AMF knows of that UE's intent to establish an unauthenticated IMS Emergency Session.\n-\tIf the AMF cannot identify the subscriber, or cannot obtain authentication vector (when SUPI is provided), the AMF shall send NAS SMC with NULL algorithms to the UE regardless of the supported algorithms announced previously by the UE.\n-\tAfter the unsuccessful verification of the UE, the AMF shall send NAS SMC with NULL algorithms to the UE regardless of the supported algorithms announced previously by the UE.\n-\tIf both, the Emergency Registration request and an AUTHENTICATION FAILURE  message with error code as defined in 24.501 [35] clauses 5.4.1.2.4.5 (for EAP based authentication) or 5.4.1.3.7 (for 5G AKA based authentication) are received by the AMF from the UE, then the AMF shall send NAS SMC with NULL algorithms to the UE regardless of the supported algorithms announced previously by the UE.\nIf the UE has initiated a PDU session establishment procedure to establish bearers for unauthenticated IMS emergency sessions and the AMF has indicated to the SMF that this is an unauthenticated emergency call, then the SMF shall indicate 'Not Needed' in the UP security policy for both UP confidentiality and UP integrity protection to the ng-eNB/gNB.\nAn unauthenticated UE does not share a complete 5G NAS security context with the network as there has been no successful primary authentication run between the UE and the AMF. When the UE and the AMF does not share the security context the only possibility for an AMF that allows unauthenticated IMS Emergency Sessions is to run with the NULL integrity algorithm NIA0 and the NULL ciphering algorithm NEA0.\nWhen there has been no successful run of Primary authentication of the UE, the UE and the AMF independently generate the KAMF in an implementation defined way and populate the 5G NAS security context with this KAMF to be used when activating a 5G NAS security context. All key derivations proceed as if they were based on a KAMF generated from a successful Primary authentication run.\nEven if no confidentiality or integrity protection is provided by NIA0 and NEA0, the UE and the network treat the 5G security context with the independently generated KAMF as if it contained a normally generated KAMF.\nWhen UE attempts to make Xn/N2 handover, UE and gNB derive and transfer the keys as normal to re-use the normal handover mechanism. Since the derived keys have no ability to affect the output of the NULL algorithms it is irrelevant that the network and the UE derive different keys. This implies that source gNB will forward UE 5G security capability which contains NIA0 and NEA0 only to target gNB. So the target gNB can only select NIA0 for integrity protection and NEA0 for confidential protection. If the UE does not receive any selection of new AS security algorithms during a intra-gNB-CU handover, the UE continues to use the same algorithms as before the handover (see TS 38.331 [22]).\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "11\tSecurity procedures between UE and external data networks via the 5G Network",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "11.1\tEAP based secondary authentication by an external DN-AAA server",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "11.1.1\tGeneral",
                            "text_content": "This sub-clause specifies support for optional to use secondary authentication between the UE and an external data network (DN).\nThe EAP framework specified in RFC 3748 [27] shall be used for authentication between the UE and a DN-AAA server in the external data network. The SMF shall perform the role of the EAP Authenticator. In the non-roaming scenario, the SMF shall perform the role of EAP Authenticator. And In the local break out scenario, the V-SMF of visited nework shall perform the role of EAP Authenticator. In the Home Routed deployment scenario, the H-SMF shall perform the role of the EAP Authenticator and the V-SMF shall transport the EAP messages exchanged between the UE and H-SMF. It shall rely on the external DN-AAA server to authenticate and authorize the UE's request for the establishment of PDU sessions.\nBetween the UE and the SMF, EAP messages shall be sent in the SM NAS message. This message is received at the AMF over N1 and delivered to the SMF over N11 using either the Nsmf_PDUSession_CreateSMContext service operation or the Nsmf_PDUSession_Update SM Context service operation, as specified in TS23.502 [8]. The SMF that takes the role of the EAP authenticator communicates with the external DN-AAA over N4 and N6 via the UPF.\nThe SMF invokes the Namf_Communication_N1N2MessageTransfer service operation to transfer the N1 NAS message containing the EAP message, towards the UE via the AMF.\nFollowing clauses describe the procedures for initial Authentication and Re-Authentication with the external DN-AAA server.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "11.1.2\tAuthentication",
                            "text_content": "The figure depicts the initial EAP authentication process with an external AAA server, illustrating the steps involved in establishing a secure connection between the client and the server. The diagram includes a client device, an external AAA server, and a network interface card (NIC). The client initiates the authentication process by sending an EAP request to the server, which then responds with an EAP response. The response includes the server's public key, which is used to encrypt the subsequent communication. The diagram highlights the importance of using a secure communication channel, such as HTTPS, to ensure the confidentiality and integrity of the data being transmitted.\nFigure 11.1.2-1: Initial EAP Authentication with an external AAA server\nThis procedure concerns both roaming and non-roaming scenarios. In the non-roaming case, the V-SMF is not involved. In the HR roaming case, the V-SMF shall proxy the signalling between the AMF in the VPLMN and the H-SMF in the HPLMN. In the LBO roaming case, only one SMF in VPLMN is involved.\nThe following procedure is based on sub-clauses 4.2.2.2.2, 4.3.2.2.1 and 4.3.2.3 in TS 23.502 [8].\nNOTE 1:\tSteps 1-6 are borrowed from clause 4.2.2.2.2 and 4.3.2.2.1 TS 23.502 [8] and are for information only. Steps 7 to 15are related to authentication and are normative text.\n1-3. The NG-UE registers with the network performing primary authentication with the AUSF/ARPF based on its network access credentials and establishes a NAS security context with the AMF.\n4. The UE initiates establishment of a new PDU Session by sending a NAS message containing a PDU Session Establishment Request within the N1 SM container, slice information (identified by S-NSSAI) , PDU session ID and the PDN it would like to connect to (identified by DNN).\nThe PDU Session Establishment Request may contain SM PDU DN Request Container IE containing information for the PDU session authorization by the external DN.\n5a. The AMF selects a V-SMF and sends either Nsmf_PDUSession_CreateSMContext Request or Nsmf_PDUSession_UpdateSMContext Request with the N1 SM container as one of its payload. It also forwards SUPI PDU Session ID, the received S-NSSAI, and the DNN.\n5b. The V-SMF sends an Nsmf_PDUSession_CreateSMContext Responseor Nsmf_PDUSession_UpdateSMContext Response correspondingly to the AMF.\nIn case of a single SMF being involved in the PDU session setup, e.g. non-roaming or local breakout, that single SMF takes the role of both V-SMF and H-SMF. In this case, steps 6 and 17 are skipped.\n6. The V-SMF sends an Nsmf_PDUSession_Create Request to the H-SMF.\n7. The H-SMF obtains subscription data from the UDM for the given SUPI obtained from the AMF in step 5. The SMF checks the subscription data whether the secondary authentication is required and whether the UE request is allowed according to the user subscription and local policies. If not allowed, the H-SMF will reject UE's request via SM-NAS signalling and skip rest of the procedure. If secondary authentication is required, the SMF may also check whether the UE has been authenticated and/or authorized by the same DN, as indicated DNN in step 5, or the same AAA server in a previous PDU session establishment. The SMF may skip steps 8 to 15 if positive.\nNote 2:\tThe information on a successful authentication/authorization between a UE and an SMF may be saved in SMF and/or UDM.\n8. The H-SMF shall trigger EAP Authentication to obtain authorization from an external DN-AAA server. If there is no existing N4 session, the H-SMF selects a UPF and establishes an N4 Session with it. The H-SMF notifies the DN-AAA server with the GPSI, if available, and the IP address(es) of the UE allocated to the PDU Session if the PDU session is of IP PDU type or the MAC address if the PDU session is of Ethernet PDU type.\n9. The H-SMF may send an EAP Request/Identity message to the UE.\n10. The UE may send an EAP Response/Identity message contained within t a NAS message. The DN-specific identity shall comply with Network Access Identifier (NAI) format.\nTo avoid the additional round-trip in steps 9 and 10, the secondary authentication DN-specific identity may be sent by the UE in step 4. In this case, H-SMF forms an EAP Response/Identity message that contains the identity.\n11. If there is no existing N4 session, the H-SMF selects a UPF and establishes an N4 Session with it.\n12. The DN-specific identity, if provided by the UE, is forwarded to the UPF. The H-SMF identifies the DN AAA server based on the DN-specific identity provided by the UE and on local configuration.\nThe UPF shall forward the DN-specific identity within an EAP Response/Identity message to the DN AAA Server.\n13. The DN AAA server and the UE shall exchange EAP messages, as required by the EAP method. In addition, it may send additional authorization information as defined in TS 23.501 clause 5.6.6.\n14. After the successful completion of the authentication procedure, DN AAA server shall send EAP Success message to the H-SMF.\n15. This completes the authentication procedure at the SMF. The SMF may save the DN-specific ID and DNN (or DN's AAA server ID if available) in a list for successful authentication/authorization between UE and an SMF. Alternatively, the SMF may update the list in UDM.\nIf the authorization is successful, PDU Session Establishment proceeds further starting at step 7a of Figure 4.3.2.2.1-1 in TS 23.502 [8].\n16a-16b. The SMF initiates a N4 Session Modification procedure with the selected UPF as in steps 10a and 10b of Fig 4.3.2.2.1-1 in TS 23.502 [8].\n17. The H-SMF sends an Nsmf_PDUSession_Create Response to the V-SMF. This message shall include EAP Success to be sent to the UE to V-SMF.\n18. The V-SMF sends Namf_Communication_N1N2MessageTransfer to the AMF as in step 11 of Figure 4.3.2.2.1-1 in TS 23.502 [8]. This message shall include EAP Success to be sent to the UE within the NAS SM PDU Session Establishment Accept message.\n19. The AMF forwards NAS SM PDU Session Establishment Accept message along with EAP Success to the UE as described in steps 12 and step 13 of Figure 4.3.2.2.1-1 in TS 23.502 [8].\nThe UE-requested PDU Session Establishment authentication/authorization by a DN-AAA server proceeds further as described in sub-clause 4.3.2.3 in TS 23.502 [8].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "11.1.3\tRe-Authentication",
                            "text_content": "The figure depicts a scenario where an external AAA server is used for EAP re-authentication. The diagram illustrates the process of the server receiving a request from the client, verifying the identity of the client, and then sending a response back to the client. The server's role is crucial in ensuring the security and integrity of the authentication process.\nFigure 11.1.3-1: EAP Re-Authentication with an external AAA server\nThis procedure concerns both roaming and non-roaming scenarios. In the non-roaming and LBO roaming cases, only one SMF is involved. In the HR roaming case, the V-SMF shall proxy the signalling between the AMF in the VPLMN and the H-SMF in the HPLMN.\n1-3\tSecondary Authentication has been established according to procedures specified in clause 11.1.2, Initial EAP Authentication with an external AAA server.\nSecondary Re-authentication may either be initiated by SMF or the external DN/AAA server. If Re-authentication is initiated by SMF, the procedure proceeds with step 4 (skipping steps 4a and 4b). If Re-authentication is initiated by the external DN/AAA server, the procedure proceeds with the alternative steps 4a and 4b.\n4.\tThe SMF decides to initiate Secondary Re-Authentication.\n4a. The DN AAA server decides to initiate Secondary Re-Authentication.\n4b. The DN AAA shall send a Secondary Re-Authentication request to UPF, and the UPF forwards it to SMF. The Secondary Re-authentication request contains the GPSI, if available, and the IP/MAC address of the UE allocated to the PDU Session and the MAC address if the PDU session is of Ethernet PDU type.\n5.\tThe SMF shall send an EAP Request/Identity message to the UE.\n6.\tThe UE shall respond with an EAP Response/Identity message (with Fast-Reauth Identity).\n7.\tThe SMF forwards the EAP Response/Identity to UPF, selected during initial authentication, over N4 interface.\nThis establishes an end-to-end connection between the SMF and the external DN-AAA server for EAP exchange.\n8.\tThe UPF shall forward the EAP Response/Identity message to the DN AAA Server.\n9.\tThe DN AAA server and the UE shall exchange EAP messages as required by the EAP method.\n10.\tAfter the completion of the authentication procedure, DN AAA server either sends EAP Success or EAP Failure message to the SMF.\n11.\tThis completes the Re-authentication procedure at the SMF.\n12-13.\tIf the authentication is successful, EAP-Success shall be sent to UE.\n12-14.\tIf authentication is not successful, the SMF notifies failure to UPF. Upon completion of a N4 Session Modification procedure with the selected UPF, SMF sends EAP-Failure to UE via AMF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "11.1.4\tSecondary authentication and authorization revocation",
                            "text_content": "At any time, a DN-AAA server may revoke the authentication and authorization for a PDU Session and according to the request from the DN-AAA server, the SMF may release the PDU Session as specified in sub-clause 4.3.4 of TS 23.502 [8].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "12\tSecurity aspects of Network Exposure Function (NEF)",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "12.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "In the 5G system, the Network Functions securely expose capabilities and events to 3rd party Application Functions (AF) via NEF. The NEF also enable secure provision of information in the 3GPP network by authenticated and authorized AFs.\nNOTE:\tIf a token is generated for AF authorization, such a token can include specific information depending on the procedure, e.g. clause 16.6.3.\nRequirements on security aspects of NEF are captured in clause 5.9.2.3.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "12.2\tMutual authentication",
                    "description": "",
                    "summary": "",
                    "text_content": "For authentication between NEF and an AF that resides outside the 3GPP operator domain, mutual authentication based on client and server certificates shall be performed between the NEF and AF using TLS.\nCertificate based authentication shall follow the profiles given in 3GPP TS 33.310 [5], clause 6.1.3a. The identities in the end entity certificates shall be used for authentication and policy checks. The structure of the PKI used for the certificate is out of scope of the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "12.3\tProtection of the NEF – AF interface",
                    "description": "",
                    "summary": "",
                    "text_content": "TLS shall be used to provide integrity protection, replay protection and confidentiality protection for the interface between the NEF and the AF. The support of TLS is mandatory.\nSecurity profiles for TLS implementation and usage shall follow the provisions given in clause 6.2 of TS 33.210 [3].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "12.4\tAuthorization of Application Function’s requests",
                    "description": "",
                    "summary": "",
                    "text_content": "After the authentication, NEF determines whether theAF is authorized to send requests for the 3GPP Network Entity. The NEF shall authorize the requests from AF using OAuth-based authorization mechanism, the specific authorization mechanisms shall follow the provisions given in RFC 6749 [43].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "12.5\tSupport for CAPIF",
                    "description": "",
                    "summary": "",
                    "text_content": "When the NEF supports CAPIF for external exposure as specified in clause 6.2.5.1 in TS 23.501[2], then CAPIF core function shall choose the appropriate CAPIF-2e security method as defined in the sub-clause 6.5.2 in TS 33.122[53] for mutual authentication and protection of the NEF – AF interface.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "13\tService Based Interfaces (SBI)",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "13.1\tProtection at the network or transport layer",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "13.1.0\tGeneral",
                            "text_content": "All network functions shall support mutually authenticated TLS and HTTPS as specified in RFC 9113 [47] and RFC 2818 [90]. The identities in the end entity certificates shall be used for authentication and policy checks. Network functions shall support both server-side and client-side certificates. TLS client and server certificates shall be compliant with the SBA certificate profile specified in clause 6.1.3c of TS 33.310 [5].\nThe TLS profile shall follow the profile given in clause 6.2 of TS 33.210 [3] with the restriction that it shall be compliant with the profile given by HTTP/2 as defined in RFC 9113 [47]. TLS clients shall include the SNI extension as specified in RFC 9113 [47].\nTLS shall be used for transport protection within a PLMN unless network security is provided by other means.\nNOTE 1: \tRegardless of whether TLS is used or not, NDS/IP as specified in TS 33.210 [3] and TS 33.310 [5] can be used for network layer protection.\nNOTE 2:\tIf interfaces are trusted (e.g. physically protected), it is for the PLMN-operator to decide whether to use cryptographic protection.\nNOTE 3:\tIt is a vendor implementation decision how the SNI extension is being used in TLS servers.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.1.1\tTLS protection between NF and SEPP",
                            "text_content": "To allow for TLS protection between the SEPP and Network Functions or SCPs within a PLMN, the SEPP shall support:\n-\tTLS wildcard certificate for its domain name and generation of telescopic FQDN based on an FQDN obtained from the received N32-f message as specified in clause 13.1.1.1.\n-\tusing the custom HTTP header 3gpp-Sbi-Target-apiRoot, defined in clause 5.2.3.2.4 of TS 29.500[74], in the HTTP request originated by the NF within the SEPP’s PLMN, to forward the protected HTTP Request message towards the remote PLMN as specified in clause 13.1.1.2.\nNOTE: Whether the SEPP and NFs within the SEPP’s PLMN use telescopic FQDN or the custom HTTP header is based on PLMN operator’s policy.\nA telescopic FQDN is an FQDN with a single label as the first element and the SEPP’s domain as the trailer component. The label uniquely represents the original FQDN.\nNOTE 3: The structure of telescopic FQDN is defined in 3GPP TS 23.003 [19], clause 28.5.2.\nThe SEPP shall generate a telescopic FQDN for the following messages received over N32-f:\na. Nnrf_NFDiscovery_Get response HTTP message with FQDNs of a set of the discovered NF or NF service instance(s) (see TS 29.510 [68]). The cSEPP generates a telescopic FQDN for each target Network Function FQDN in the Discovery response, rewrites the original FQDN with the telescopic FQDN and forwards the modified Discovery response to the NRF.\nb. Subscription message with the Callback URI in the payload of the message (see TS 29.501 [94]). The pSEPP generates a telescopic FQDN from the Callback URI in the Subscription message, rewrites the original FQDN in the callback URI, and forwards the modified Subscription message to the producer Network Function.\nc. Nsmf_PDUSession_POST HTTP message from a V-SMF with PduSessionCreateData containing the URI representing the PDU session in the V-SMF (see TS 29.502 [95]). The pSEPP generates a telescopic FQDN from the Callback URI in the message, rewrites the original FQDN in the callback URI, and forwards the modified message to the target H-SMF.\nThe following procedure illustrates how SEPPs use telescopic FQDN and wildcard certificate to establish a TLS connection between a Network Function or a SCP and the SEPP:\n1.\tWhen the SEPP receives one of the messages identified in a-c above, it shall rewrite the FQDN from the received message with a telescopic FQDN and it forwards the modified HTTP message to the target Network Function or SCP inside the PLMN.\n2.\tWhen the Network Function or SCP that received the telescopic FQDN in step 1 is ready to communicate with the target Network Function or SCP in another PLMN, it uses the telescopic FQDN in the Request URI of the HTTP Request. When communication between the Network Function or SCP and the SEPP that generated the telescopic FQDN is based on using the 3gpp-Sbi-Target-apiRoot custom HTTP header as specified in TS 29.500 [74], clause 5.2.3.2.4, the Network Function or SCP uses the telescopic FQDN in the 3gpp-Sbi-Target-apiRoot custom HTTP header of the HTTP Request. During TLS setup between the Network Function and the SEPP, the SEPP shall authenticate towards the Network Function or SCP using the wildcard certificate.\n3. \tWhen the SEPP receives a HTTP request from the Network Function or SCP, the SEPP shall rewrite the telescopic FQDN with the original FQDN by replacing the unique delimiter in the label with the period character and removing its own suffix part.\nThe NF uses the 3gpp-Sbi-Target-apiRoot HTTP header in the HTTP Request to convey the target FQDN to the SEPPs.\nIf PRINS is used on the N32-f interface, the following applies: The sending SEPP shall use the 3gpp-Sbi-Target-apiRoot header to obtain the apiRoot to be used in the request URI of the protected HTTP Request. It removes the 3gpp-Sbi-Target-apiRoot header before forwarding the protected HTTP Request on the N32-f interface.\nIf TLS is used on the N32 interface, the following applies: The sending SEPP shall replace the authority header in the HTTP Request with the FQDN of the receiving SEPP before forwarding the protected HTTP Request on the N32 interface. The sending SEPP shall not change the 3gpp-Sbi-Target-apiRoot header.\nNOTE: This solution does not require the SEPP to support TLS wildcard certificate for its domain name during TLS setup, nor the SEPP to generate a telescopic FQDN for the target FQDN.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.1.2\tProtection between SEPPs",
                            "text_content": "TLS shall be used for N32-c connections between the SEPPs.\nThe SEPP shall maintain a set of trust anchors, each consisting of a list of trusted root certificates and a list of corresponding PLMN-IDs. Any given PLMN-ID shall appear in at most one trust anchor. During N32-c connection setup, the SEPP shall map the PLMN-ID of the remote SEPP leaf (server or client) certificate to the associated trust anchor for the purposes of certificate chain verification. Only the root certificates in the associated list shall be treated as trusted during certificate chain verification. If the remote SEPP certificate contains multiple PLMN-IDs that are mapped to different trust anchors, then that certificate shall be rejected.\nOperator Group Roaming Hubs SEPPs are equivalent to a network operator SEPP when they are in the same security domain and are not considered IPX providers as detailed in this clause. The communication between a group network operator's SBA network border element and the Operator Group Roaming Hub SEPP is out of scope of the present document.\nIf there are no IPX providers between the SEPPs, TLS shall be used for N32-f connections between the SEPPs. Different TLS connections are used for N32-c and N32-f. If there are IPX providers which only offer IP routing service between SEPPs, either TLS or PRINS (application layer security) shall be used for protection of N32-f connections between the SEPPs. PRINS is specified in clause 5.9.3 (requirements) and clause 13.2 (procedures).\nIf TLS is selected, the SEPP shall correlate the N32-f TLS connection with the N32-c connection. If the peer network is a PLMN, the SEPP compares the PLMN-IDs contained in the SEPP TLS certificates used to establish the N32-c and N32-f connections. Specifically, if the certificate used for N32-f contains one or more PLMN-IDs that are not contained in the TLS certificate used for the corresponding N32-c, the N32-f certificate shall be rejected. If the peer network is an SNPN, the SEPP compares the SNPN-ID contained in the SEPP TLS certificates used to establish the N32-c and N32-f connections.\nIf there are IPX providers which, in addition to IP routing, offer other services that require modification or observation of the information and/or additions to the information sent between the SEPPs, PRINS shall be used for protection of N32-f connections between the SEPPs.\nNOTE 1a:\tThe procedure specified in clause 13.5 for security mechanism selection between SEPPs allows SEPPs to negotiate which security mechanism to use for protecting NF service-related signalling over N32, and provides robustness and future-proofness, e.g. in case new algorithms are introduced in the future.\nIf PRINS is used on the N32-f interface, one of the following additional transport protection methods should be applied between SEPP and IPX provider for confidentiality and integrity protection:\n-\tNDS/IP as specified in TS 33.210 [3] and TS 33.310 [5], or\n-\tTLS VPN with mutual authentication following the profile given in clause 6.2 of TS 33.210 [3] and clause clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks, with the restriction that it shall be compliant with the profile given by HTTP/2 as defined in RFC 9113 [47].\nNOTE 1:\tVoid\nNOTE 2:\tVoid.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "13.2\tApplication layer security on the N32 interface",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "13.2.1\tGeneral",
                            "text_content": "The internetwork interconnect allows secure communication between service-consuming and a service-producing NFs in different PLMNs. Security is enabled by the Security Edge Protection Proxies of both networks, henceforth called cSEPP and pSEPP respectively. The SEPPs enforce protection policies regarding application layer security thereby ensuring integrity and confidentiality protection for those elements to be protected.\nIt is assumed that there are interconnect providers between cSEPP and pSEPP. The interconnect provider the cSEPP's operator has a business relationship with is called cIPX, while the interconnect provider the pSEPP's operator has a business relationship with is called pIPX. There could be further interconnect providers in between cIPX and pIPX, but they are assumed to be transparent and simply forward the communication.\nThe SEPPs use JSON Web Encryption (JWE, specified in RFC 7516 [59]) for protecting messages on the N32-f interface, and the IPX providers use JSON Web Signatures (JWS, specified in RFC 7515 [45]) for signing their modifications needed for their mediation services.\nFor illustration, consider the case where a service-consuming NF sends a message to a service-producing NF. If this communication is across PLMN operators over the N32-f interface, as shown in Figure 13.2.1-1 below, the cSEPP receives the message and applies symmetric key based application layer protection, as defined in clause 13.2 of the present document. The resulting JWE object is forwarded to roaming intermediaries. The pIPX and cIPX can offer services that require modifications of the messages transported over the interconnect (N32) interface. These modifications are appended to the message as digitally signed JWS objects which contain the desired changes. The pSEPP, which receives the message from pIPX, validates the JWE object, extracts the original message sent by the NF, validates the signature in the JWS object and applies patches corresponding to the modifications by roaming intermediaries. The pSEPP then forwards the message to the destination NF.\nThe N32 interface consists of:\n-\tN32-c connection, for management of the N32 interface, and\n-\tN32-f connection, for sending of JWE and JWS protected messages between the SEPPs.\nThe application layer security protocol for the N32 interface described in clause 13.2 of the present document is called PRINS.\n\nThe figure depicts a comprehensive overview of PRINS, a software tool used for managing and optimizing the performance of a network. The figure includes various components such as the network topology, network metrics, and network performance indicators. The figure provides a clear and concise representation of the PRINS software, making it easy for network administrators to understand and manage their network.\nFigure 13.2.1-1: Overview of PRINS\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.2.2\tN32-c connection between SEPPs",
                            "text_content": "When the negotiated security mechanism to use over N32, according to the procedure in clause 13.5, is PRINS (described in clause 13.2), the SEPPs use the established TLS connection (henceforth referred to as N32-c connection) to negotiate the N32-f specific associated security configuration parameters required to enforce application layer security on HTTP messages exchanged between the SEPPs. A second N32-c connection is established by the receiving SEPP to enable it to not only receive but also send HTTP Requests.\nThe N32-c connection is used for the following purposes:\n-\tKey agreement: The SEPPs independently export keying material associated with the first N32-c connection between them and use it as the pre-shared key for generating the shared session key required.\n-\tParameter exchange: The SEPPs exchange security related configuration parameters that they need to protect HTTP messages exchanged between the two Network Functions (NF) in their respective networks.\n-\tError handling: The receiving SEPP sends an error signalling message to the peer SEPP when it detects an error on the N32-f interface.\nThe following security related configuration parameters may be exchanged between the two SEPPs:\na.\tModification policy. A modification policy, as specified in clause 13.2.3.4, indicates which IEs can be modified by an IPX provider of the sending SEPP.\nb. \tData-type encryption policy. A data-type encryption policy, as specified in 13.2.3.2, indicates which types of data will be encrypted by the sending SEPP.\nc.\tCipher suites for confidentiality and integrity protection, when application layer security is used to protect HTTP messages between them.\nd.\tN32-f context ID. As specified in clause 13.2.2.4.1, N32-f context ID identifies the set of security related configuration parameters applicable to a protected message received from a SEPP in a different PLMN.\n1. The two SEPPs shall perform the following cipher suite negotiation to agree on a cipher suite to use for protecting NF service related signalling over N32-f.\n1a. The SEPP which initiated the first N32-c connection shall send a Security Parameter Exchange Request message to the responding SEPP including the initiating SEPP’s supported cipher suites. The cipher suites shall be ordered in initiating SEPP’s priority order. The SEPP shall provide an initiating SEPP’s N32-f context ID for the responding SEPP.\n1b. The responding SEPP shall compare the received cipher suites to its own supported cipher suites and shall select, based on its local policy, a cipher suite, which is supported by both initiating SEPP and responding SEPP.\n1c. The responding SEPP shall send a Security Parameter Exchange Response message to the initiating SEPP including the selected cipher suite for protecting the NF service related signalling over N32. The responding SEPP shall provide a responding SEPP’s N32-f context ID for the initiating SEPP.\n2. The two SEPPs may perform the following exchange of Data-type encryption policies and Modification policies. Both SEPPs shall store protection policies sent by the peer SEPP:\n2a. The SEPP which initiated the first N32-c  connection shall send a Security Parameter Exchange Request message to the responding SEPP including the initiating SEPP’s Data-type encryption policies, as described in clause 13.2.3.2, and Modification policies, as described in clause 13.2.3.4.\n2b. The responding SEPP shall store the policies if sent by the initiating SEPP.\n2c. The responding SEPP shall send a Security Parameter Negotiation Response message to the initiating SEPP with the responding SEPP’s suite of protection policies.\n2d. The initiating SEPP shall store the protection policy information if sent by the responding  SEPP.\n3. The two SEPPs shall exchange IPX security information lists that contain information on IPX public keys or certificates that are needed to verify IPX modifications at the receiving SEPP.\n4. The two SEPPs shall export keying material from the TLS session established between them using the TLS export function. For TLS 1.2, the exporter specified in RFC 5705 [61]  shall be used. For TLS 1.3, the exporter described in section 7.5 of RFC 8446 [60] shall be used. The exported key shall be used as the master key to derive session keys and IVs for the N32-f context as specified in clause 13.2.4.4.1.\n5. When the responding SEPP needs to initiate traffic, e.g., error reporting, in the reverse direction to the sending SEPP, the responding SEPP in the first N32-c connection shall now setup a second N32-c connection by establishing a mutually authenticated TLS connection with the peer SEPP.\nNOTE:  The second N32-c connection setup by the responding SEPP does not perform the negotiation of steps 1-4.\n6.\tThe two SEPPs start exchanging NF to NF service related signalling over N32-f and tear down the N32-c connection. The SEPPs may initiate new N32-c TLS sessions for any further N32-c communication that may occur over time while application layer security is applied to N32-f.\nErrors can occur on an active N32-c connection or on one or more N32-f connections between two SEPPs.\nWhen an error is detected, the SEPP shall map the error to an appropriate cause code. The SEPP shall create a signalling message to inform the peer SEPP, with cause code as one of its parameters.\nThe SEPP shall use the N32-c connection to send the signalling message to the peer SEPP. If the old N32-c connection has been terminated, it uses a new N32-c connection instead. If errors are relevant for the Roaming intermediaries, the error message shall be sent over N32-f to the peer SEPP, and shall be sent over N32-c if delivery over N32-f failed.\nIf the error occurred in the processing of the one or more N32-f message(s), the SEPP shall include the corresponding message ID (s), obtained from the metadata section of the N32-f message, as a parameter in the signalling message. This allows the peer SEPP to identify the source message(s) (HTTP Request or Response) on which the other SEPP found the error.\nNOTE:\tLocal action taken by either SEPP is out of 3GPP scope.\nThe N32-f context consists of the following main parts as illustrated in Figure 13.2.2.4.0-1:\n1.\tN32-f context ID\n2.\tN32-f peer information\n3.\tN32-f security context\n4.\tN32-f context information\nThe figure depicts a 2.4 GHz frequency context overview, specifically focusing on the N32-f band. It illustrates the various elements and their relationships within the context, including the 2.4 GHz frequency, the 1.2 GHz reference band, and the 0.4 GHz sub-band. The figure provides a comprehensive overview of the N32-f context, highlighting the key features and relationships that are essential for understanding the radio frequency spectrum in this particular band.\nFigure 13.2.2.4.0-1: N32-f context overview\nThe N32-f context ID is used to refer to an N32-f context. The SEPPs shall create the N32-f context ID during the N32-c negotiation and use it over N32-f to inform the receiving peer which security context to use for decryption of a received message.\nThe initiating SEPP shall send the initiating SEPP’s N32-f context ID to the responding SEPP which the responding SEPP shall use to identify the N32-f connection with this initiating SEPP. Vice versa, the responding SEPP shall send the responding SEPP’s N32-f context ID to the initiating SEPP which the initiating SEPP shall use to identify the N32-f connection with this responding SEPP. To avoid collision of the N32-f context ID value, the SEPPs shall select the N32-f context ID as a random value during the exchange over N32-c.\nDuring transfer of application data over N32-f, the SEPP shall include the N32-f context ID in a separate IE in the metadata part of the JSON structure, see clause 13.2.4.2. The receiving SEPP shall use this information to apply the correct key and parameters during decryption and validation.\nThe  N32-f connection between SEPPs is bidirectional and consists of the two SEPP endpoints and possibly up to two IPX providers. The SEPPs are identified by the PLMN ID and additionally a SEPP ID to distinguish between several SEPPs in the same PLMN. The remote SEPP address is necessary for routing the messages to the correct destination.\nThe N32-f peer information shall consist of the following parameters:\n-\tRemote PLMN ID;\n-\tRemote SEPP ID;\n-\tRemote SEPP address.\nThe N32-c initial handshake described in clause 13.2.2.2 establishes session keys, IVs and negotiated cipher suites. Counters are used for replay protection. Modification policies are identified by modification policy IDs, to be able to verify received messages that have undergone IPX modifications.\nThe N32-f security context shall consist of the following parameters:\n-\tSession keys\n-\tNegotiated cipher suites\n-\tData type encryption policy IDs\n-\tModification policy list (if IPXs are used)\n-\tModification policy IDs\n-\tIPX provider identifier\n-\tCounters\n-\tIVs\n-\tList of security information of the IPX providers connected to the SEPPs (IPX security information list)\n-\tIPX provider identifier\n-\tList of raw public keys or certificates for that IPX\nThe N32-f context information shall consist of the following parameters:\n-\tValidity.\n-\tUsage (PRINS).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.2.3\tProtection policies for N32 application layer solution",
                            "text_content": "The protection policy suite is comprised of a data-type encryption policy and a modification policy. Together, these policies determine which part of a certain message shall be confidentiality protected and which part of a certain message shall be modifiable by IPX providers. The SEPP shall apply the protection policies for application layer protection of messages on the N32-f interface.\nThere are two types of protection policies, namely:\n-\tData-type encryption policy: specifies which data types need to be confidentiality protected;\n-\tModification policy: specifies which IEs are modifiable by roaming intermediaries.\nIn addition, there is a mapping between the data-types in the data-type encryption policy and the IEs in NF API descriptions which is given in a NF-API data-type placement mapping.\nThe SEPP shall contain an operator-controlled protection policy that specifies which types of data shall be encrypted. The data-types defined are the following:\n-\tData of the type 'SUPI';\n-\tData of the type 'authentication vector';\n-\tData of the type 'location data';\n-\tData of the type 'cryptographic material';\n-\tData of the type 'authorization token'.\nThe policy shall be specific per roaming partner. The policy shall contain a policy identifier and a release number referring to the release it is applicable for.\nThe data-type encryption policies in the two partner SEPPs shall be equal to enforce a consistent ciphering of IEs on N32-f.\nEach NF API data-type placement mapping shall contain the following:\n-\tWhich IEs contain data of the type 'SUPI' or type 'NAI'.\n-\tWhich IEs contain data of the type 'authentication vector’.\n-\tWhich IEs contain data of the type 'location data'.\n-\tWhich IEs contain data of the type 'cryptographic material'.\n-\tWhich IEs contain data of the type 'authorization token'.\nThe location of the IEs refers to the location of the IEs after the SEPP has rewritten the message for transmission over N32-f.\nAn NF API data-type placement mapping shall furthermore contain data that identifies the NF API, namely\n-\tThe name of the NF;\n-\tThe API version;\n-\tAn identifier for the NF API data-type placement mapping;\n- \tThe NF’s 3GPP Release version.\nNOTE: \tLarger networks can contain multiple NFs with the same API, e.g. three AMFs. The NF API policy applies to all NFs with the same API.\nThe NF API data-type placement mapping shall reside in the SEPP.\nThe SEPP shall contain an operator-controlled policy that specifies which IEs can be modified by the IPX provider directly related to this particular SEPP. These IEs refer to the IEs after the sending SEPP has rewritten the message.\nEach PLMN-operator shall agree the modification policy with the IPX provider it has a business relationship with prior to establishment of an N32 connection. Each modification policy applies to one individual relation between PLMN-operator and IPX provider. To cover the whole N32 connection, both involved roaming partners shall exchange their modification policies.\nNOTE 1: \tIn order to validate modifications for messages received on the N32-f interface, the operator’s roaming partners will have to know the overall modification policy.\nNOTE 2: Modification includes removal and addition of new IE. IEs therefore may not be present in the rewritten message.\nThe IEs that the IPX is allowed to modify shall be specified in a list giving an enumeration of JSON paths within the JSON object created by the SEPP. Wildcards may be used to specify paths.\nThis policy shall be specific per roaming partner and per IPX provider that is used for the specific roaming partner.\nThe modification policy shall reside in the SEPP.\nFor each roaming parter, the SEPP shall be able to store a policy for receiving.\nThe following basic validation rules shall always be applied irrespective of the policy exchanged between two roaming partners:\n-\tIEs requiring encryption shall not be inserted at a different location in the JSON object.\nThe SEPP shall contain an interface that the operator can use to manually configure the protection policies in the SEPP.\nThe SEPP shall be able to store and process the following policies for outgoing messages:\n-\tA generic data-type encryption policy;\n-\tRoaming partner specific data-type encryption policies that will take precedence over a generic data-type encryption policy if present;\n-\tNF API data-type placement mappings;\n-\tMultiple modification policies, to handle modifications that are specific per IPX provider and modification policies that are specific per IPX provider and roaming partner.\nThe SEPP shall also be able to store and process the following policies for incoming messages during the initial connection establishment via N32-c:\n-\tRoaming partner specific data-type encryption policies;\n-\tRoaming partner specific modification policies that specify which fields can be modified by which of its IPX providers.\nThis clause specifies the order of precedence of data-type encryption policies and modification policies available in a SEPP.\nIn increasing order of precedence, the following policies apply for a message to be sent on N32:\n1.\tThe set of default rules specified in the present specification:\n-\tFor the data-type encryption policy, the rules on data-types that are mandatory to be encrypted according to clause 5.9.3.3.\n-\tFor the modification policy, the basic validation rules defined in clause 13.2.3.4.\n2.\tManually configured policies:\n-\tFor the data-type encryption policy: rules according to clause 13.2.3.2, on a per roaming partner basis.\n-\tFor the modification policy: rules according to clause 13.2.3.4, per roaming partner and per IPX provider that is used for the specific roaming partner.\nNOTE 1: \tIt is assumed that operators agree both data-type encryption and modification policy in advance, for example as part of their bilateral roaming agreement. The protection policies exchanged via N32-c during the initial connection establishment only serve the purpose of detecting possible misconfigurations.\nNOTE 2:\tIt is assumed that the default rules and manually configured policies do not overlap or contradict each other. The manually configured policies are used to extend the protection by the default rules in the present document and are applied on top of them.\nWhen a SEPP receives a data-type encryption or modification policy on N32-c as specified in clause 13.2.2.2, it shall compare it to the one that has been manually configured for this specific roaming partner and IPX provider. If a mismatch occurs for one of the two policies, the SEPP shall perform one of the following actions, according to operator policy:\n-\tSend the error message as specified in TS 29.573 [73], clause 6.1.4.3.2,  to the peer SEPP.\n-\tCreate a local warning.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.2.4\tN32-f connection between SEPPs",
                            "text_content": "The SEPP receives HTTP/2 request/response messages from the Network Function. It shall perform the following actions on these messages before they are sent on the N32-f interface to the SEPP in the other PLMN:\na)\tIt parses the incoming message and, if present, rewrites the telescopic FQDN of the receiving NF to obtain the original FQDN as described in clause 13.1.\nb) \tIt reformats the message to produce the input to JSON Web Encryption (JWE) [59] as described in clause 13.2.4.3.\nc)\tIt applies JWE to the input created in b) to protect the reformatted message as described in clause 13.2.4.4.\nd)\tIt encapsulates the resulting JWE object into a HTTP/2 message (as the body of the message) and sends the HTTP/2 message to the SEPP in the other PLMN over the N32-f interface.\nThe message may be routed via the cIPX and pIPX nodes. These IPX nodes may modify messages as follows:\na) The IPX node recovers the cleartext part of the HTTP message from the JWE object, modifies it according to the modification policy, and calculates an \"operations\" JSON Patch object. It then creates a temporary JSON object with the \"operators\" JSON Patch object and some other parameters for replay protection etc. as described in clause 13.2.4.5.1.\nb) The IPX node uses the temporary JSON object as input into JSON Web Signature (JWS) [45] to create a JWS object, as described in clause 13.2.4.5.2.\nc) The IPX node appends the JWS object to the received message and sends it to the next hop.\nThe JWS objects generated by the two IPX providers form an auditable chain of modifications that to the receiving SEPP shall apply to the parsed message after verifying that the patches conform to the modification policy.\nEncryption of IEs shall take place end to end between cSEPP and pSEPP.\nA SEPP shall not include IEs in the clear that are encrypted elsewhere in the JSON object.\nA SEPP shall verify that an intermediate IPX has not moved or copied an encrypted IE to a location that would be reflected from the producer NF in an IE without encryption.\nThe SEPP reformats an HTTP message received from an internal Network Function into two temporary JSON objects that will be intput to JWE:\n\na. The dataToIntegrityProtect, containing information that is only integrity protected. It consists of the following:\n-\tclearTextEncapsulationMessage: contains the complete original HTTP message, excluding attribute values which require encryption and, including the pseudo-header fields, HTTP headers and HTTP message body.\n-\tmetadata: contains SEPP generated information i.e. authorizedIPX ID, N32-f message ID and N32-f context ID.\nb. The dataToIntegrityProtectAndCipher: contains attribute values of the original message that require both encryption and integrity protection.\nFor the details of JSON representation of a reformatted HTTP message, refer to TS 29.573 [92].\nThe clearTextEncapsulatedMessage is a JSON object that contains the non-encrypted portion of the original message.Specifically, it consists of the following objects:\n1.a) Pseudo_Headers – the JSON object that includes all the Pseudo Headers in the message.\n- For HTTP Request messages, the object contains one entry for each of the \":method\", \":path\", \":scheme\" and \":authority\" pseudo headers. If the \":path\" pseudoheader contains multiple parts separated by a slash (/) or includes a query parameter (following a \"?\"), an array is used to represent :path, with one element per part of the path (i.e. per \"directory\").\nNOTE:\tThis enables encryption of individual elements of the path (e.g. if SUPI is passed).\n- For HTTP Response messages, the object contains the \":status\" pseudo header.\n1.b) HTTP_Headers – the JSON object that includes all the Headers in the message.\nAll the headers of the request are put into a JSON array called HTTP_Headers.Each entry contains a header name and value, where the value part can be an encoded index to the dataToIntegrityProtectAndCipher block, if the header value is encrypted.\n1.c) Payload – the JSON object that includes the content of the payload of the HTTP message.\nEach attribute or IE in the payload shall form a single entry in the Payload JSON object. If there is any attribute value that requires encryption, it shall be moved into the dataToIntegrityProtectAndCipher JSON object (clause 13.2.4.2), and the original value in this element shall be replaced by the index in the form {\"encBlockIdx\": <num>} where \"num\" is the index of the corresponding entry in the dataToIntegrityProtectAndCipher array.\nThe JSON object containing information added by the sending SEPP. It shall contain:\na) N32-f message ID: Unique identifier (64-bit integer) representing a HTTP Request/Response transaction between two SEPPs. The N32-f message ID is generated by the sending SEPP and included in the HTTP Request sent over the N32 interface. The receiving SEPP uses the same N32-f message ID when it responds back with a HTTP Response. The N32-f message ID is included in the metadata portion of the JSON structure.\nb) authorizedIPX ID: String identifying the first hop IPX (cIPX or pIPX) that is authorized to update the message. This field shall always be present. When there is no IPX that is authorized to update, the value of this field is set to  null. The sending SEPP selects one of the IPX providers from the list exchanged with the other SEPP during parameter exchange over N32-c and includes its identifier value in this field.\nc) N32-f context ID: Unique identifier representing the N32-f context information used for protecting the message. This is exchanged during parameter exchange over N32-c (clause 13.2.2.4.1).\nThe dataToIntegrityProtectAndCipher is a JSON patch document as per RFC 6902 [64] that contains all the attribute values that require both encryption and integrity protection. Attribute values may come from any part of the original HTTP message – Pseudo_Headers, HTTP_Headers and Payload.\nThe JSON array shall contain one array entry per attribute value that needs encryption. Each array entry represents the value of the attribute to be protected, and the index in the array is used to reference the protected value within the dataToIntegrityProtect block. This associates each attribute in the dataToIntegrityProtectAndCipher block with the original attribute in the dataToIntegrityProtect block. This is needed to reassemble the original message at the receiving SEPP.\nThe SEPP shall use JSON Web Encryption (JWE) as specified in RFC 7516 [59] for the protection of reformatted HTTP messages between the SEPPs. All encryption methods supported by JWE are AEAD methods, i.e. methods that encrypt and integrity protect  in one single operation and can additionally integrity protect additional data.\nThe dataToIntegrityProtectAndCipher and dataToIntegrityProtect blocks shall be input to JWE as plaintext and JWE Additional Authenticated Data (AAD) respectively. The JWE AEAD algorithm generates JWE encrypted text (ciphertext) and a JWE Authentication Tag (Message Authentication Code). The ciphertext is the output from symmetrically encrypting the plaintext, while the authentication tag is a value that verifies the integrity of both the generated ciphertext and the Additional Authenticated Data.\nThe Flattened JWE JSON Serialization syntax shall be used to represent JWE as a JSON object.\nThe session key shared between the two SEPPs, as specified in clause 13.2.4.4.1, shall be used as the Content Encryption Key (CEK) value to the algorithm indicated in the Encryption algorithm (\"enc\") parameter in the JOSE header. The algorithm (\"alg\") parameter in the JOSE header denoting the key exchange method shall be set to \"dir\", i.e. \"Direct use of a shared symmetric key as the CEK\".\nThe 3GPP profile for supported cipher suites in the \"enc\" parameter is described in clause 13.2.4.9.\nThe generated JWE object shall be transmitted on the N32-f interface in the payload body of a SEPP to SEPP HTTP/2 message.\nThe N32-f key hierarchy is based on the N32-f master key generated during the N32-c initial handshake by TLS key export. The N32-f key hierarchy consists of two pairs of session keys and two pairs of IV salts, which are used in two different HTTP/2 sessions. In one Session the N32-c initiator acts as the HTTP client and in the second the N32-c responder acts as the client.\nIf the exported master secret is reused to set up multiple HTTP sessions or to set up new HTTP sessions on stream ID exhaustion, a new, unique, N32-f Context ID shall be generated to avoid key and IV re-use.\nThe master key shall be obtained from the TLS exporter. The export function takes 3 arguments: Label, Context, Length (in octets) of the desired output. For the N32 Master key derivation, the Label shall be the IANA registered label \"EXPORTER_3GPP_N32_MASTER\" [89], the Context shall be \"\" (the empty string) and the Length shall be 64.\nThe N32 key derivation function N32-KDF shall be based on HKDF [62] and shall use only the HKDF-Expand function as the initial key material has been generated securely:\nN32-KDF (label, L) = HKDF-Expand (N32-f master key, \"N32\" || N32-Context-ID || label, L),\nwhere\n-\tlabel is a string used for key separation,\n-\tL is the length of output keying material in octets.\nEach run of N32-KDF (label, L) produces either one session key or one IV salt.\nThere are two pairs of session keys and IV salts to be derived.\nNOTE:\tIn AES-GCM re-use of one IV may reveal the integrity key (Joux’s Forbidden attack). The binding of session keys and IV salts to N32-f context IDs and labels is essential to protect against inadvertent use of the same key with a repeated IV.\nThe labels for the JWE keys are:\n-\t\"parallel_request_key\"\n-\t\"parallel_response_key\"\n-\t\"reverse_request_key\", and\n-\t\"reverse_response_key\".\nThe keys derived with labels starting parallel shall be used for request/responses in an HTTP session with the N32-c initiating SEPP acting as the client (i.e. in parallel to the N32-c connection). The keys derived with the labels starting reverse shall be used for an HTTP session with the N32-c responding SEPP acting as the client.\nTo generate the IV salts, the length is 8 and the labels are:\n-\t\"parallel_request_iv_salt\",\n-\t\"parallel_response_iv_salt\",\n-\t\"reverse_request_iv_salt\", and\n-\t\"reverse_response_iv_salt\".\nThe 96-bit nonce for AES_GCM shall be constructed as the concatenation of the IV salt (8 octets, 64-bits) and the sequence counter, SEQ, following section 8.2.1 of NIST Special Publication 800-38D [63]:\n\nNonce = IV salt || SEQ.\n\nThe sequence counter shall be a 32-bit unsigned integer that starts at zero and is incremented for each invocation of the encryption.  A different sequence counter shall be maintained for each IV salt.\n\nThe figure depicts an example of JSON representation of IPX provider modifications, illustrating the process of updating the IPX provider configuration. The JSON format is used to store and transmit data in a structured format, making it easier to manage and share information. The figure includes various elements such as IPX provider, IPX version, and modifications, which are essential for understanding the changes made to the IPX provider configuration.\nFigure 13.2.4.5.1-1 Example of JSON representation of IPX provider modifications\nThis is a temporary JSON object generated by an IPX provider as it modifies the original message. It shall contain the following:\na)\tOperations – This is a JSON patch document that captures IPX modifications based on RFC 6902 [64]. If no patch is required, the operations element shall be set to null.\nb)\tIdentity – This is the identity of the IPX performing the modification.\nc)\tTag – A JSON string element to capture the “tag” value (JWE Authentication tag) in the JWE object generated by the sending SEPP. This is required for replay protection.\nNOTE:\tSince there is no central registry that can ensure unique IPX Identities, it is expected that an IPX will include its Fully Quantified Domain Name (FQDN) in the JSON modification object.\nNOTE 1: \tIt is assumed that operators act as a certification authority for IPX providers they have a direct business relationship with. In order to authorize N32-f message modifications, operators sign a digital certificate for each of these IPX providers and provide it to both the IPX provider itself as well as their roaming partners to enable them to validate any modifications by this IPX provider.\nOnly cIPX and pIPX shall be able to modify messages between cSEPP and pSEPP. In cases of messages from cSEPP to pSEPP, the cIPX is the first roaming intermediary, while the pIPX is the second Roaming Intermediary. In cases of messages from pSEPP to cSEPP the pIPX is the first roaming intermediary, while the cIPX is the second roaming Intermediary.\nThe first roaming intermediary shall parse the encapsulated request (i.e. the clearTextEncapsulationMsg in the dataToIntegrityProtect block) and determine which changes are required. The first roaming intermediary creates an  Operations JSON patch document to describe the differences between received and desired message, using the syntax and semantic from RFC 6902 [64], such that, when applying the JSON patch to the encapsulated request the result will be the desired request. If no patch is required, the operations element is null.\nNOTE 2:\tIt is necessary to create a JWS object even if no patch is required to prevent deletion of modifications.\nThe first roaming intermediary shall create a modifiedDataToIntegrityProtect JSON object as described in clause 13.2.4.5.1. The JSON object shall include the roaming intermediary’s identity and the JWE authentication tag, which associates this update by the roaming intermediary with the JWE object created by the sending SEPP.\nThe first roaming intermediary shall use the modifiedDataToIntegrityProtect JSON object as input to JWS to create a JWS object. The first roaming intermediary shall append the generated JWS object to the payload in the HTTP message and then send the messageto the next hop.\nThe second roaming intermediary shall parse the encapsulated request, apply the modifications described in the JSON patch appended by the first roaming intermediary and determine further modifications required for obtaining the desired request. The second roaming intermediary shall record these modifications in an additional JSON patch against the JSON object resulting from application of the first roaming intermediary's JSON patch. If no patch is required, the operations element for the second JSON patch is null.\nThe second roaming intermediary shall create a modifiedDataToIntegrityProtect JSON object as described in clause 13.2.4.5.1. It shall include its identity and the JWE authentication tag, which associates this update by the second roaming intermediary with the JWE object created by the sending SEPP.\nThe second roaming intermediary shall use the modifiedDataToIntegrityProtect JSON object as input to JWS to create a JWS object. The second roaming intermediary shall append the generated JWS object to the payload in the HTTP message and then send the message to the receiving SEPP.\nIn case a roaming hub needs to originate an error message, then clause 13.2.4.5.2 shall also apply with the following addition: If an error message needs to be sent, the originating roaming hub shall insert a reformattedData JSON element including only the metadata IE as defined in TS 29.573 [73], Table 6.2.5.2.2 for the Request, and Table 6.2.5.2.3 for the response, and the patches shall be based on a  reformattedData JSON element including only the metadata.\nThe reformattedData JSON element shall only contain metadata with N32-f message ID and N32-f context ID.\nThe IPX providers shall use JSON Web Signature (JWS) as specified in RFC 7515 [45] for the protection of IPX provider modified attributes. The mechanism described in this clause uses signatures, i.e. asymmetric methods, with private/public key pairs.\nMore specifically, when an IPX node modifies one or more attributes of the original HTTP message and creates a modifiedDataToIntegrityProtect object to record its modifications, it shall use JWS to integrity protect the modifiedDataToIntegrityProtect object.\nThe IPX provider shall use its private key as input to JWS for generating the signature representing the contents of the modifiedDataToIntegrityProtect object.\nThe \"alg\" parameter in the JOSE header indicates the chosen signature algorithm. The 3GPP profile for supported algorithms is described in clause 13.2.4.9.\nThe Flattened JWS JSON Serialization syntax shall be used to represent JWS as a JSON object.\nThe receiving SEPP determines that the received message is generated by the Roaming Hub based on the reformattedData IE.\nIf the received messages is not generated by a roaming hub:\n-\tThe receiving SEPP shall decrypt the JWE ciphertext using the shared session key and the following parameters obtained from the JWE object – Initialization Vector, Additional Authenticated Data value (clearTextEncapsulatedMessage in \"aad\") and JWE Authentication Tag (\"tag\").\n-\tThe receiving SEPP shall check the integrity and authenticity of the clearTextEncapsulatedMessage and the encrypted text by verifying the JWE Authentication Tag in the JWE object with the JWE AAD algorithm. The algorithm returns the decrypted plaintext (dataToIntegrityProtectAndCipher) only if the JWE Authentication Tag is correct.\n-\tThe receiving SEPP refers to the NF API in clearTextEncapsulatedMessage with values in the dataToIntegrityProtectAndCipher array.\n-\tThe receiving SEPP shall next verify IPX provider updates, if included, by verifying the JWS signatures added by the Roaming Intermediaries. The SEPP shall verify the JWS signature, using the corresponding raw public key or certificate that is contained in the IPX provider’s security information list obtained during parameter exchange in the related N32-c connection setup or, alternatively, has been configured for the particular peer SEPP.\n-\tThe receiving SEPP shall then check that the raw public key or certificate of the JWS signature IPX's Identity in the modifiedDataToIntegrity block matches to the IPX provider referred to in the \"authorizedIPX ID\" field added by the sending SEPP, based on the information given in the IPX provider security information list.\n-\tThe receiving SEPP shall check whether the modifications performed by the Roaming Intermediaries were permitted by the respective modification policies. The receiving SEPP shall use the modification policy of the cIPX obtained during parameter exchange in the related N32-c connection setup, and use the modification policy of pIPX configured within the receiving SEPP.\n-\tIf this is the case, the receiving SEPP shall apply the patches in the  Operations field in order, perform plausibility checks, and create a new HTTP request according to the \"patched\" clearTextEncapsulatedMessage.\n-\tThe receiving SEPP shall verify that the PLMN-ID contained in the incoming N32-f message matches the PLMN-ID in the related N32-f context.\nIf the received message is generated by a Roaming Hub:\n-\tThe receiving SEPP shall check that the raw public key or certificate of the JWS signature IPX's identity in the modifiedDataToIntegrityProtect block matches the adjacent Roaming Hub identity.\n-\tIf the receiving SEPP determines from the error message that the Roaming Hub requires a modified request message, it can modify if allowed by the MNO's policy, and can resend the modified request message.\nThe following clause illustrates the message flow between the two SEPPs with modifications from cIPX and pIPX.\nThe figure depicts a message flow between two SEPPs, illustrating the communication between two separate entities. The flow is represented by a series of arrows, indicating the direction of the message flow. The figure is labeled with the figure number \"13.2,\" which likely represents a specific section or topic within the larger document.\nFigure 13.2.4.8-1 Message flow between two SEPPs\n1.\tThe cSEPP receives an HTTP request message from a network function. If the message contains a telescopic FQDN, the cSEPP removes its domain name from this FQDN to obtain the original FQDN as described in clause 13.1.\n2.\tThe cSEPP shall reformate the HTTP Request message as follows:\na. The cSEPP shall generate blocks (JSON objects) for integrity protected data and encrypted data, and protecting them:\nThe cSEPP shall encapsulate the HTTP request into a clearTextEncapsulatedMessage block containing the following child JSON objects:\n-\tPseudo_Headers\n-\tHTTP_Headers with one element per header of the original request.\n-\tPayload that contains the message body of the original request.\nFor each attribute that require end-to-end encryption between the two SEPPs, the attribute value is copied into a dataToIntegrityProtectAndCipher JSON object and the attribute's value in the clearTextEncapsulatedMessage is replaced by the index of attribute value in the dataToIntegrityProtectAndCipher block.\nThe cSEPP shall create a metadata block that contains the N32-f context ID, message ID generated by the cSEPP for this request/response transaction and next hop identity.\nThe cSEPP shall protect the dataToIntegrityProtect block and the dataToIntegrityProtectAndCipher block as per clause 13.2.4.4. This results in a single JWE object representing the protected HTTP Request message.\nb. The cSEPP shall generate payload for the SEPP to SEPP HTTP message:\nThe JWE object becomes the payload of the new HTTP message generated by cSEPP.\n3.\tThe cSEPP shall use HTTP POST to send the HTTP message to the first Roaming Intermediary.\n4.\tThe first Roaming Intermediary (e.g. visited network's IPX provider) shall create a new modifiedDataToIntegrityProtect JSON object with three elements:\na. The Operations JSON patch document contains modifications performed by the first Roaming Intermediary as per RFC 6902 [64].\nb. The first Roaming Intermediary shall include its own identity in the Identity field of the modifiedDataToIntegrityProtect.\nc. The first Roaming Intermediary shall copy the \"tag\" element, present in the JWE object generated by the cSEPP, into the modifiedDataToIntegrityProtect object. This acts as a replay protection for updates made by the first Roaming Intermediary.\nThe Roaming Intermediary shall execute JWS on the modifiedDataToIntegrityProtect JSON object and append the resulting JWS object to the message.\n5.\tThe first Roaming Intermediary shall send the modified HTTP message request to the second Roaming Intermediary (e.g. home network's IPX) as in step 3.\n6.\tThe second Roaming Intermediary shall perform further modifications as in step 4 if required. The second Roaming Intermediary shall further execute JWS on the modifiedDataToIntegrityProtect JSON object and shall append the resulting JWS object to the message.\n7.\tThe second Roaming Intermediary shall send the modified HTTP message to the pSEPP as in step 3.\nNOTE 1:\tThe behaviour of the Roaming Intermediaries is not normative, but the pSEPP assumes that behaviour for processing the resulting request.\n8.\tThe pSEPP receives the message and shall perform the following actions:\n-\tThe pSEPP extracts the serialized values from the components of the JWE object.\n- \tThe pSEPP invokes the JWE AEAD algorithm to check the integrity of the message and decrypt the dataToIntegrityProtectAndCipher block. This results in entries in the encrypted block becoming visible in cleartext.\n-\tThe pSEPP updates the clearTextEncapsulationMessage block in the message by replacing the references to the dataToIntegrityProtectAndCipher block with the referenced decrypted values from the dataToIntegrityProtectAndCipher block.\n-\tThe pSEPP then verifies IPX provider updates of the attributes in the modificationsArray. It checks whether the modifications performed by the Roaming Intermediaries were permitted by policy.\nThe pSEPP further verifies that the PLMN-ID contained in the message is equal to the \"Remote PLMN-ID\" in the related N32-f context.\n-\tThe pSEPP updates the modified values of the attributes in the clearTextEncapsulationMessage in order.\nThe pSEPP shall re-assemble the full HTTP Request from the contents of the clearTextEncapsulationMessage.\n\n9.\tThe pSEPP shall send the HTTP request resulting from step 8 to the home network's NF.\n10.-18.\tThese steps are analogous to steps 1.-9.\nSEPPs shall follow the JWE profile defined in TS 33.210 [3] with the restriction that it shall only use AES GCM with a 128-bit or 256-bit key. The security considerations for the use of AES GCM in section 8.4 of RFC 7518 [59] shall be taken into account. In particular, the same key shall not be used more than 232 times and an IV value shall not be used more than once with the same key.\nSEPPs and IPXs shall follow the JWS profile as defined in TS 33.210 [3] with the restriction that they shall only use ES256 algorithm.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "13.3\tAuthentication and static authorization",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "13.3.0\tStatic authorization",
                            "text_content": "Static authorization is based on local authorization policy at the NRF and the NF Service Producer. It can be used when token-based authorization is not used.\nDuring the Nnrf_NFDiscovery procedure, the NRF ensures that the NF Service Consumer is authorized to discover the NF Service Producer service(s) as specified in clause 13.3.1.3 of this document.\nIf token-based authorization is not used within one PLMN and the NF Service Producer receives a service request, the NF Service Producer shall check authorization of the NF Service Consumer based on its local policy. If the NF Service Consumer is authorized to receive the service requested, the NF Service Producer shall grant the NF Service Consumer access to the service API.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.1\tAuthentication and authorization between network functions and NRF",
                            "text_content": "NRF and NF shall authenticate each other during discovery, registration, and access token request.\nIn direct communication, NF and NRF shall use one of the following methods for authentication:\n-\tIf the PLMN uses protection at the transport layer as described in clause 13.1, authentication provided by the transport layer protection solution shall be used for mutual authentication of the NRF and NF.\n-\tIf the PLMN does not use protection at the transport layer, mutual authentication of NRF and NF may be implicit by NDS/IP or physical security (see clause 13.1).\nIn indirect communication, NF and NRF shall use one of the following methods for authentication:\n-\tMutual authentication between NF and NRF provided by the transport layer protection solution.\n-\tClient credentials assertion (CCA) based authentication as specified in clause 13.3.8.\nNOTE 1:\tClient credentials assertion authentication is based on a CCA token sent by the NF Service Consumer to the NRF via an intermediate such as the SCP. CCA based authentication does not provide authentication of the NRF towards the NF Service Consumer or protection of the service request sent by the NF Service Consumer to the NRF.\n-\tImplicit, i.e. by relying on authentication between NF Service Consumer and SCP, and between SCP and NRF, provided by the hop-by-hop security protection at the transport layer, NDS/IP, or physical security.\nNOTE 2:\tMutual authentication between NF Service Consumer and NRF is not achieved with hop-by-hop security.\nNOTE 3:\tIf only hop-by-hop security is used in a PLMN, the NRF is not able to verify that an access token request sent by SCP on behalf of a certain NF Service Consumer, is actually authorized by this consumer.\nWhen NRF receives message from unauthenticated NF, NRF shall support error handling, and may send back an error message. The same procedure shall be applied vice versa.\nAfter successful authentication between NRF and NF, the NRF shall decide whether the NF is authorized to perform discovery and registration.\nIn the non-roaming scenario, the NRF authorizes the Nnrf_NFDiscovery_Request based on the profile of the expected NF/NF service and the type of the NF Service Consumer, as described in clause 4.17.4 of TS23.502 [8].\nIn the roaming scenario, the NRF of the NF Service Producer shall authorize the Nnrf_NFDiscovery_Request based on the profile of the expected NF/NF Service, the type of the NF Service Consumer and the serving network ID.\nIf the NRF finds NF Service Consumer is not allowed to discover the expected NF instances(s) as described in clause 4.17.4 of TS 23.502[8], NRF shall support error handling, and may send back an error message.\nNOTE 1: \tVoid.\nWhen a NF consumes the Nnrf_NFManagement or the Nnrf_NFDiscovery services provided by the NRF, the usage of the OAuth 2.0 access token for authorization between the NF and the NRF is optional.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.2\tAuthentication and authorization between network functions",
                            "text_content": "In direct communication, authentication between network functions within one PLMN shall use one of the following methods:\n-\tIf the PLMN uses protection at the transport layer as described in clause 13.1, authentication provided by the transport layer protection solution shall be used for authentication between NFs.\n-\tIf the PLMN does not use protection at the transport layer, authentication between NFs within one PLMN may be implicit by NDS/IP or physical security (see clause 13.1).\nIf the PLMN uses token-based authorization, the network shall use protection at the transport layer as described in clause 13.1.\nIn indirect communication scenarios, the NF Service Producer and NF Service Consumer shall use implicit authentication by relying on authentication between NF Service Consumer and SCP, and between SCP and NF Service Producer, provided by the transport layer protection solution, NDS/IP, or physical security.\nNOTE 0: Mutual authentication between NF Service Consumer and NF Service Producer is not achieved with hop-by-hop security.\nIf the PLMN uses token-based authorization as specified by clause 13.4.1.2 and the PLMN’s policy mandates that the NRF authenticates the NF Service Consumer before granting an access token, the access token indicates to the NF Service Producer that the NF Service Consumer has been authenticated by the NRF.\nIf additional authentication of the NF Service Consumer is required, the NF Service Producer authenticates the NF Service Consumer at the application layer using CCA based authentication as specified in clause 13.3.8.\nThe NF Service Consumer authentication based on CCA based authentication is optional to use, and based on operator policy.\nNOTE 1: Void\nNOTE 2: Void\nThe Inter-PLMN UP Security functionality (IPUPS) as described in clauses 4.2.2 and 5.9.3.4 provide a standardised solution for binding 5G SBA REST Service Operations between the PLMN V-SMF and H-SMF over N16 / N32 to GTP-U over N9 in roaming scenarios.\nWhen an NF receives a message from an unauthenticated NF, the receiving NF shall support error handling, and may send back an error message.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.3\tAuthentication and authorization between SEPP and network functions",
                            "text_content": "NOTE 1: This clause also describes authentication and authorization between SEPP and NRF, because the NRF is a network function.\nAuthentication between SEPP and network functions within one PLMN shall use one of the following methods:\n-\tIf the PLMN uses protection at the transport layer, authentication provided by the transport layer protection solution shall be used for authentication between SEPP and NFs.\n-\tIf the PLMN does not use protection at the transport layer, authentication between SEPP and NFs within one PLMN may be implicit by NDS/IP or physical security (see clause 13.1).\nA network function and the SEPP shall mutually authenticate before the SEPP forwards messages sent by the network function to network functions in other PLMN, and before the SEPP forwards messages sent by other network functions in other PLMN to the network function.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.4\tAuthentication and authorization between SEPPs",
                            "text_content": "Authentication and authorization between SEPPs in different PLMNs is defined in clause 13.2.\n13.3.5\tAuthentication between SEPP and SCP\nAuthentication between SEPP and SCP within one PLMN shall use one of the following methods:\n-\tIf the PLMN uses protection at the transport layer, authentication provided by the transport layer protection solution shall be used for authentication between SEPP and SCP.\n-\tIf the PLMN does not use protection at the transport layer, authentication between SEPP and SCP within one PLMN may be implicit by NDS/IP or physical security (see clause 13.1).\nA SCP and the SEPP shall mutually authenticate before forwarding incoming or outgoing requests.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.6\tAuthentication and authorization between SCP and network functions",
                            "text_content": "The SCP and network functions shall use one of the following methods described in clause 13.1 to mutually authenticate each other before service layer messages can be exchanged on that interface:\n-\tIf the PLMN uses protection at the transport layer, authentication provided by the transport layer protection solution shall be used for mutual authentication of the SCP and the network functions.\n-\tIf the PLMN does not use protection at the transport layer, mutual authentication of the SCP and network functions may be implicit by NDS/IP or physical security.\nAuthentication between the SCP and the Network Function may be implicit by co-location.\nAuthorization between the SCP and NFs is based on local authorization policy. Regarding the authorization of access token requests sent by an SCP on behalf of an NF Service Consumer, NOTE 3 in clause 13.3.1.2 applies.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.7\tAuthentication and authorization between SCPs",
                            "text_content": "SCPs shall use one of the following methods as described in 13.1 to mutually authenticate each other before service layer messages can be exchanged on that interface:\n-\tIf the PLMN uses protection at the transport layer, authentication provided by the transport layer protection solution shall be used for mutual authentication of the SCPs.\n-\tIf the PLMN does not use protection at the transport layer, mutual authentication of the two SCPs may be implicit by NDS/IP or physical security.\nAuthorization between SCPs is based on local authorization policy.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "13.3.8\tClient credentials assertion based authentication",
                            "text_content": "The Client credentials assertion (CCA) is a token signed by the NF Service Consumer. It enables the NF Service Consumer to authenticate towards the receiving end point (NRF, NF Service Producer) by including the signed token in a service request.\nIt includes the NF Service Consumer’s NF Instance ID that can be checked against the certificate by the NF Service Producer. The CCA includes a timestamp as basis for restriction of its lifetime.\nCCAs are expected to be more short-lived than NRF generated access tokens. So, they can be used in deployments with requirements for tokens with shorter lifetime for NF-NF communication. There is a trade-off that when the lifetime of the CCA is too short, it requires the NF Service Consumer to generate a new CCA for every new service request.\nThe CCA cannot be used in the roaming case, as the NF Service Producer in the home PLMN will not be able to verify the signature of the NF Service Consumer in the visited PLMN unless cross-certification process is established between the two PLMNs through one of the mechanisms specified in TS 33.310.\nCCA does not provide integrity protection on the full service request. Neither does it provide a mechanism for the NF Service Consumer to authenticate the NF Service Producer.\nIn this clause, CCAs are described generally for both NF-NRF communication and NF-NF communication.\nCCAs shall be JSON Web Tokens as described in RFC 7519 [44] and are secured with digital signatures based on JSON Web Signature (JWS) as described in RFC 7515 [45].\nThe CCA shall include:\n-\tthe NF instance ID of the NF Service Consumer (subject);\n-\tA timestamp (iat) and an expiration time (exp), and\n-\tThe NF type of the expected audience (audience), i.e. the type \"NRF\" and/or the NF type of the NF Service Producer.\nThe NF Service Consumer shall digitally sign the generated CCA based on its private key as described in RFC 7515 [45]. The signed CCA shall include one of the following fields:\n-\tthe X.509 URL (x5u) to refer to a resource for the X.509 public key certificate or certificate chain used for signing the client authentication assertion, or\n-\tthe X.509 Certificate Chain (x5c) include the X.509 public key certificate or certificate chain used for signing the client authentication assertion.\nThe verification of the CCA shall be performed by the receiving node, i.e., NRF or NF Service Producer in the following way:\nIt validates the signature of the JWS as described in RFC 7515 [45].\nIt validates the timestamp (iat) and/or the expiration time (exp) as specified in RFC 7519 [44].\nIf the receiving node is the NRF, the NRF validates the timestamp (iat) and the expiration time (exp).\nIf the receiving node is the NF Service Producer, the NF Service Producer validates the expiration time and it may validate the timestamp.\nIt checks that the audience claim in the the CCA matches its own type.\nIt verifies that the NF instance ID of the NFc in the CCA matches the NF instance ID in the public key certificate used for signing the CCA.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "13.4\tAuthorization of NF service access",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "13.4.1\tOAuth 2.0 based authorization of Network Function service access",
                            "text_content": "The authorization framework described in clause 13.4.1 allows NF Service Producers to authorize the requests from NF Service requestors. Subscription requests are also service requests.\nThe authorization framework uses the OAuth 2.0 framework as specified in RFC 6749 [43]. Grants shall be of the type Client Credentials Grant, as described in clause 4.4 of RFC 6749 [43]. Access tokens shall be JSON Web Tokens as described in RFC 7519 [44] and are secured with digital signatures or Message Authentication Codes (MAC) based on JSON Web Signature (JWS) as described in RFC 7515 [45].\nNOTE 1a: Securing the access token using Message Authentication Codes (MAC) based on JSON Web Signature (JWS) as described in RFC 7515 [45] requires a pairwise pre-shared symmetric key between the NRF and the NF Service Producer. The provisioning of such pre-shared symmetric key is outside the scope of this document.\nThe basic extent provided by the authorization token is at service level (i.e. the \"scope\" claim includes allowed services per NF type). Depending on the NF Service Producer configuration, higher level of granularity for the authorization token can be defined adding \"additional scope\" information within the token e.g. to authorize specific service operations and/or resources/data sets within service operations per NF Service Consumer type.\nNOTE 1: The additional scope(s) included within the access token add additional security checks at the NF Service Producer that authorizes the services operations, resources and NF Service Consumer type related to the additional scope(s).\nThe authorization framework described in clause 13.4.1 is mandatory to support for NRF and NF.\nThe OAuth 2.0 framework does not apply to the notification operation.\nExtensions to the authorization framework specific for the security of enablers for Network Automation by 5GS are described in Annex X.\nOAuth 2.0 roles, as defined in clause 1.1 of RFC 6749 [43], are as follows:\na.\tThe Network Repository Function (NRF) shall be the OAuth 2.0 Authorization server.\nb.\tThe NF Service Consumer shall be the OAuth 2.0 client.\nc.\tThe NF Service Producer shall be the OAuth 2.0 resource server.\n\nOAuth 2.0 client (NF Service Consumer) registration with the OAuth 2.0 authorization server (NRF)\nThe NF Service registration procedure, as defined in clause 4.17.1 of TS 23.502 [8], may be used to register the OAuth 2.0 client (NF Service Consumer) with the OAuth 2.0 Authorization server (NRF), as described in clause 2.0 of RFC 6749 [43]. The client id, used during OAuth 2.0 registration, shall be the NF Instance Id of the NF. OAuth2.0 clients may also register with the NRF using OAM.\nA Network Function that does not implement this option shall be able to get an access token from the NRF as long as the NRF is able to authenticate and authorize the Network Function during the NF access token get service request.\nOAuth 2.0 resource server (NF Service Producer) registration with the OAuth 2.0 authorization server (NRF)\nThe NF Service registration procedure, as defined in clause 4.17.1 of TS 23.502 [8], shall be used to register the OAuth 2.0 resource server (NF Service Producer) with the OAuth 2.0 Authorization server (NRF). The NF Service Producer, as part of its NF profile, may include \"additional scope\" information related to the allowed service operations and resources per NF Service Consumer type.\nThe figure depicts a NF Service Provider register in NRF, which is a crucial component in the network's architecture. It illustrates the process of registering NF Service Providers (NFPs) in the network, ensuring that they are properly authenticated and authorized to provide their services. The figure also highlights the importance of network function virtualization (NFV) in enabling efficient network management and resource allocation.\nFigure 13.4.1.1-1b NF Service Producer registers in NRF\n1)\tThe NF Service Producer registers as OAuth 2.0 resource server in the NRF. The NF profile configuration data of the NF Service Producer may include the \"additional scope\". The \"additional scope\" information indicates the resources and the actions (service operations) that are allowed on these resources for the NF Service Consumer. These resources may be per NF type of the NF Service Consumer or per NF instance ID of the NF Service Consumer.\n2-3)\tAfter storing the NF Profile, NRF responds successfully.\nThe complete service request is a two-step process including requesting an access token by NF Service Consumer (Step 1, i.e. 1a or 1b), and then verification of the access token by NF Service Producer (Step 2).\nNOTE: The service request process regarding the enabler for network automation is specified in Annex X.\nStep 1: Access token request\nPre-requisite:\n- The NF Service consumer (OAuth2.0 client) is registered with the NRF (Authorization Server).\n- The NF Service Producer (OAuth2.0 resource server) is registered with the NRF (Authorization Server) with optionally \"additional scope\" information per NF type.\n- The NRF and NF Service Producer share the required credentials.\n- The NRF and NF have mutually authenticated each other – where the NF Service Consumer is identified by the NF Instance ID of the public key certificate of the NF Service Consumer..\n1a. Access token request for accessing services of NF Service Producers of a specific NF type\nThe following procedure describes how the NF Service Consumer obtains an access token before service access to NF Service Producers of a specific NF type.\n\nThe figure depicts a user accessing NF Service Consumer (NFC) service, obtaining an access token before accessing NF Service.\nFigure 13.4.1.1.2-1: NF Service Consumer obtaining access token before NF Service access\n1. The NF Service Consumer shall request an access token from the NRF in the same PLMN using the Nnrf_AccessToken_Get request operation. The message shall include the NF Instance Id(s) of the NF Service Consumer, the requested \"scope\" including the expected NF Service name(s) and optionally \"additional scope\" information (i.e. requested resources and requested actions (service operations) on the resources), NF type of the expected NF Service Producer instance and NF Service Consumer. The NF Service Consumer may also include a list of NSSAIs or list of NSI IDs for the expected NF Service Producer instances.\nThe message may include the NF Set ID and/or NF Service Set Id of the expected NF Service Producer instances.\nThe message may include a list of S-NSSAIs of the NF Service Consumer.\n\nThe message may also include the PLMN ID(s) of the NF Service Consumer.\n\n2. The NRF shall verify that the input parameters NF Instance ID and NF type as well as PLMN ID(s), if available, in the access token request match with the corresponding ones in the public key certificate of the NF Service Consumer or those in the NF profile of the NF Service Consumer. If the verification of the parameters in the access token request fails, the access token request is not further processed. The NRF may additionally verify the S-NSSAIs of the NF Service Consumer. The NRF checks whether the NF Service Consumer is authorized to access the requested service(s). For example, the NRF may verify that the NF Service Consumer can serve a slice which is included in the allowed slices for the NF Service Producer. If the NF Service Consumer is authorized, the NRF shall then generate an access token with appropriate claims included. The NRF shall digitally sign the generated access token based on a shared secret or private key as described in RFC 7515 [45]. If the NF Service Consumer is not authorized, the NRF shall not issue an access token to the NF Service Consumer.\nThe claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer (subject), NF type of the NF Service Producer (audience), expected service name(s), (scope), expiration time (expiration) and optionally \"additional scope\" information (allowed resources and allowed actions (service operations) on the resources). The claims may include a list of NSSAIs or NSI IDs for the expected NF Service Producer instances. The claims may include the NF Set ID and/or NF Service Set Id of the expected NF Service Producer instances.\n3. If the authorization is successful, the NRF shall send access token to the NF Service Consumer in the Nnrf_AccessToken_Get response operation, otherwise it shall reply based on Oauth 2.0 error response defined in RFC 6749 [43]. The other parameters (e.g., the expiration time, allowed scope) sent by NRF in addition to the access token are described in TS 29.510 [68].\nThe NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Service Producer NF type listed in claims (scope, audience) during their validity time.\n\n1b. Access token request for accessing services of a specific NF Service Producer instance / NF Service Producer service instance\nThe following steps describes how the NF Service Consumer obtains an access token before service access to a specific NF Service Producer instance / NF Service Producer service instance. 1. The NF Service Consumer shall request an access token from the NRF for a specific NF Service Producer instance / NF Service Producer service instance. The request shall include the NF Instance Id(s) of the requested NF Service Producer, the expected NF Service name, optionally \"additional scope\" information (allowed resources and allowed actions (service operations) on the resources) and NF Instance Id of the NF Service Consumer. The request may also include the PLMN ID(s) of the NF Service Consumer.\n2. The NRF shall verify that the input parameters in the access token request, i.e. NF Instance ID and, if available, PLMN ID(s) and NF type, match with the corresponding ones in the public key certificate of the NF Service Consumer or those in the NF profile of the NF Service Consumer. If the verification of the parameters in the access token request fails, the access token request is not further processed.\nThe NRF checks whether the NF Service Consumer is authorized to access the requested services from the NF Service Producer instance/NF Service Producer service instance, and then proceeds to generate an access token with the appropriate claims included. If the NF Service Consumer is not authorized, the NRF shall not issue an access token to the NF Service Consumer.\nThe claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer (subject), NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer (audience), expected service name(s) (scope), optionally \"additional scope\" information (allowed resources and allowed actions (service operations) on the resources), and expiration time (expiration).\n3. The token shall be included in the Nnrf_AccessToken_Get response sent to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer instance listed in claims (scope, audience) during their validity time.\nStep 2: Service access request based on token verification\nThe following figure and procedure describe how authorization is performed during Service request of the NF Service Consumer. Prior to the request, the NF Service Consumer may perform Nnrf_NFDiscovery_Request operation with the requested additional scopes to select a suitable NF Service Producer (resource server) which is able to authorize the Service Access request.\nThe figure depicts a user interface for a NF Service Consumer (S) requesting service access with an access token. The interface includes a form for entering the access token, a button for submitting the request, and a confirmation message. The figure illustrates the user experience and functionality of the NF Service Consumer application.\nFigure 13.4.1.1.2-2: NF Service Consumer requesting service access with an access token\nPre-requisite: The NF Service Consumer is in possession of a valid access token before requesting service access from the NF Service Producer.\n1.\tThe NF Service Consumer requests service from the NF Service Producer. The NF Service Consumer shall include the access token.\nThe NF Service Consumer and NF Service Producer shall authenticate each other following clause 13.3.\n2.\tThe NF Service Producer shall verify the token as follows:\n-\tThe NF Service Producer ensures the integrity of the token by verifying the signature using NRF’s public key or checking the MAC value using the shared secret.\n-\t If integrity check is successful, the NF Service Producer shall verify the claims in the token as follows: -\nIn the direct communication case, it checks that the NF Instance ID in the subject claim within the access token matches the NF Instance ID in the subjectAltName in the NF Service Consumer's TLS client certificate.\nNOTE: Void.\n-\tIt checks that the audience claim in the access token matches its own identity or the type of NF Service Producer. If a list of NSSAIs or list of NSI IDs is present, the NF Service Producer shall check that it serves the corresponding slice(s). If applicable (e.g., when the request is for information related to a specific UE), the NF Service Producer may check that the NF Service Consumer is allowed to access (as indicated by the NF Service Producer’s NSSAIs in the access token presented by the NF Service Consumer) at least one of the slice(s) that the UE is currently registered to, e.g., by verifying that the UE’s allowed NSSAI(s) intersect with the NF Service Producer's NSSAIs in the access token.\n-\tIf an NF Set ID present, the NF Service Producer shall check the NF Set ID in the claim matches its own NF Set ID.\nIf an NF Service Set ID present, the NF Service Producer shall check if the NF Service Consumer is authorized to access the requested service according to NF Service Producer Service Set ID in the access token claim.\n-\tIf scope is present, it checks that the scope matches the requested service operation.\n- \tIf the access token contains \"additional scope\" information (i.e. allowed resources and allowed actions (service operations) on the resources), it checks that the additional scope matches the requested service operation.\n-\tIt checks that the access token has not expired by verifying the expiration time in the access token against the current data/time.\n-\tIf the CCA is present in the service request, it may verify the CCA as specified in clause 13.3.8.3 and that the subject claim (i.e., the NF Instance Id of the NF Service Consumer) in the access token matches the subject claim in the CCA.\n3.\tIf the verification is successful, the NF Service Producer shall execute the requested service and responds back to the NF Service Consumer. Otherwise, it shall reply based on Oauth 2.0 error response defined in RFC 6749 [43].\nAs described in clause 6.2.6.1 of TS 23.501 [1], an operator network can deploy multiple NRFs, for example due to network slicing or network segmentation.\nAn NF Service Consumer shall send its access token requests to the NRF where it is registered as OAuth 2.0 client.  The NRF authenticates the NF Service Consumer, and shall verify the input parameters in the access token request as described under Step 1 in clause 13.4.1.1.2. If the verification of the parameters in the access token request fails, the access token request is not further processed. After successful authentication and verification of the input parameters, the NRF may forward the access token request to another NRF.\nIf an NRF receives an access token request for an NF Service Producer that is not registered at this NRF, the NRF determines the target NRF where the NF Service Producer is registered as specified in TS 29.510 [68] clause 5.4.2.2.2 step 2a, and forwards the access token request to the target NRF. There can also be several hops of NRFs between the NRF that receives the access token request from the NF Service Consumer and the target NRF where the NF Service Producer is registered.\nOne possible hierarchical NRF deployment is the local NRF deployment. An NF Service Producer’s local NRF is the NRF where the NF Service Producer registered its NF profile. In the local NRF deployment, the NF Service Producer is configured with the public key which corresponds to the private key that its local NRF uses for signing the access token. Thus, when the local NRF receives an access token request from an NF Service Consumer, the local NRF checks if the NF Service Consumer is authorized to receive the requested service and, if yes, issues and signs the access token. In the case when the access token request from the NF Service Consumer was forwarded by another NRF, the local NRF of the NF Service Producer needs to trust the NRF which forwarded the access token request.\nIn the inter-PLMN interconnect scenario, OAuth 2.0 roles are as follows:\na.\tThe NF Service Consumer's Network Repository Function (cNRF) shall be the OAuth 2.0 Authorization server for the PLMN of the NF Service Consumer (cPLMN) and authenticates the NF Service Consumer.\nb.\tThe NF Service Producer's Network Repository Function (pNRF) shall be OAuth 2.0 Authorization server for the PLMN of the NF Service Producer (pPLMN) and generates the access token.\nc.\tThe NF Service Consumer in the cPLMN shall be the OAuth 2.0 client.\nd.\tThe NF Service Producer in the pPLMN shall be the OAuth 2.0 resource server.\nAs an example of the inter-PLMN interconnect use case, service access authorization in the roaming scenario where the service consumer NF is located in the visited PLMN and the service producer NF is located in the home PLMN is specified in clause 13.4.1.2.\nAn NF Service Consumer shall send its access token requests to the NRF in the consumer PLMN where it is registered as OAuth 2.0 client. The NRF in consumer PLMN authenticates the NF Service Consumer, and shall verify the input parameters in the access token request as described for the vNRF under Step 1 in clause 13.4.1.2.2. If the verification of the parameters in the access token request fails, the access token request is not further processed. After successful authentication and verification of the input parameters, the NRF in the consumer PLMN forwards the access token request to the NRF in the producer PLMN as described for the vNRF and hNRF under Step 1 in clause 13.4.1.2.2. The NRF in the producer PLMN checks whether the NF Service Consumer is authorized to access the requested service(s) as described for the hNRF under Step 1 in clause 13.4.1.2.2.\nIn the roaming scenario, OAuth 2.0 roles are as follows:\na.\tThe visited Network Repository Function (vNRF) shall be the OAuth 2.0 Authorization server for vPLMN and authenticates the NF Service Consumer.\nb.\tThe home Network Repository Function (hNRF) shall be OAuth 2.0 Authorization server for hPLMN and generates the access token.\nc.\tThe NF Service Consumer in the visited PLMN shall be the OAuth 2.0 client.\nd.\tThe NF Service Producer in the home PLMN shall be the OAuth 2.0 resource server.\nOAuth 2.0 client (NF Service Consumer) registration with the OAuth 2.0 authorization server (NRF) in the vPLMN\nSame as in the non-roaming scenario in 13.4.1.1.\nOAuth 2.0 resource server (NF Service Producer) registration with the OAuth 2.0 authorization server (NRF) in the hPLMN\nSame as in the non-roaming scenario in 13.4.1.1.\nThe complete service request is two-step process including requesting an access token by NF Service Consumer (Step 1, i.e. 1a or 1b), and then verification of the access token by NF Service Producer (Step 2).\n\nStep 1: Access token request\nPre-requisite:\n- The NF Service consumer (OAuth2.0 client) is registered with the vNRF (Authorization Server in the vPLMN).\n- The hNRF and NF Service Producer share the required credentials. Additionally, the NF Service Producer (OAuth2.0 resource server) is registered with the hNRF (Authorization Server in the hPLMN) with optionally \"additional scope\" information per NF type.\n- The two NRFs are implicitly authenticated via N32 mutual authentication of SEPPs.\nNOTE: \tvSEPP to hSEPP communication is secured via N32. Only transitive trust between vNRF and hNRF can be achieved: The vNRF and vSEPP mutually authenticate, the vSEPP and hSEPP mutually authenticate, and the hSEPP and hNRF mutually authenticate. Hence, vNRF and hNRF can only implicitly authenticate each other.\n\n- The NRF in the visited PLMN (vNRF) has authenticated the NF Service Consumer. –  where the NF Service Consumer is identified by the NF Instance ID of the public key certificate of the NF Service Consumer.\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Consumer and the vNRF are located in the SNPN while the hNRF is located in the Credentials Holder.\n1a. Access token request for accessing services of NF Service Producers of a specific NF type\nThe following procedure describes how the NF Service Consumer obtains an access token for NF Service Producers of a specific NF type for use in the roaming scenario.\nThe figure depicts a user obtaining an access token before accessing NF Service Consumer roaming. The figure shows the various components involved in the access token process, including the user's device, the access token server, and the roaming service provider. The figure illustrates the steps taken to authenticate the user and grant them access to the roaming service.\nFigure 13.4.1.2.2-1: NF Service Consumer obtaining access token before NF Service access (roaming)\n1.\tThe NF Service Consumer shall invoke Nnrf_AccessToken_Get Request (NF Instance Id of the NF Service Consumer, the requested \"scope\" including the  expected NF Service Name (s) and optionally \"additional scope\" information (i.e. requested resources and requested actions (service operations) on the resources), NF Type of the expected NF Service Producer instance, NF type of the NF Service Consumer, home and serving PLMN IDs, optionally list of NSSAIs or list of NSI IDs for the expected NF Service Producer instances, optionally NF Set ID and/or the NF Service Set ID of the expected NF Service Producer) from NRF in the same PLMN.\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the serving PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the home PLMN ID.\n2.\tThe NRF in visited PLMN shall verify the input parameters in the access token request as described under Step 1 in clause 13.4.1.1.2. If the verification of the parameters in the access token request fails, the access token request is not further processed. After successful verification of the input parameters, the vNRF shall identify the NRF in home PLMN (hNRF) based on the home PLMN ID, and request an access token from hNRF as described in clause 4.17.5 of TS 23.502 [8]. The vNRF shall forward the parameters it obtained from the NF Service Consumer, including NF Service Consumer type, to the hNRF.\n3.\tThe hNRF checks whether the NF Service Consumer is authorized to access the requested service(s). If the NF Service Consumer is authorized, the hNRF shall generate an access token with appropriate claims included as defined in clause 13.4.1.1. The hNRF shall digitally sign the generated access token based on a shared secret or private key as described in RFC 7515 [45]. If the NF service consumer is not authorized, the hNRF shall not issue an access token to the NF Service Consumer.\nThe claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF type of the NF Service Producer appended with its PLMN ID (audience), expected services name(s), (scope) and expiration time (expiration), and optionally \"additional scope\" information (allowed resources and allowed actions (service operations) on the resources). The claims may include a list of NSSAIs or NSI IDs for the expected NF Service Producer instances. The claims may include the NF Set ID and/or the NF Service Set ID of the expected NF Service Producer instances.\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.\n4.\tIf the authorization is successful, the access token shall be included in Nnrf_AccessToken_Get Response message to the vNRF. Otherwise it shall reply based on Oauth 2.0 error response defined in RFC 6749 [43].\n5.\tThe vNRF shall forward the Nnrf_AccessToken_Get Response or error message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Service Producer NF type listed in claims (scope, audience) during their validity time. The other parameters (e.g., the expiration time, allowed scope) sent by NRF in addition to the access token are described in TS 29.510 [68].\n\n1b. Obtain access token for accessing services of a specific NF Service Producer instance / NF Service Producer service instance\nThe following steps describes how the NF Service Consumer obtains an access token before service access to a specific NF Service Producer instance / NF Service Producer service instance.\n1. The NF Service Consumer shall request an access token from the NRF for a specific NF Service Producer instance / NF Service Producer service instance. The request shall include the NF Instance Id of the requested NF Service Producer, appended with its PLMN ID, the expected NF service name and NF Instance Id of the NF Service Consumer, appended with its PLMN ID.\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.\n2. The NRF in serving PLMN shall verify the input parameters in the access token request as described under Step 1 in clause 13.4.1.1.2. If the verification of the parameters in the access token request fails, the access token request is not further processed. After successful verification of the input parameters, the NRF in the visited PLMN shall forward the request to the NRF in the home PLMN.\n3. The NRF in the home PLMN checks whether the NF Service Consumer is authorized to access the requested services from the NF Service Producer instance/NF Service Producer service instance and shall then proceed to generate an access token with the appropriate claims included. If the NF Service Consumer is not authorized, the NRF in the home PLMN shall not issue an access token to the NF Service Consumer.\nThe claims in the token shall include the NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer appended with its PLMN ID (subject), NF Instance Id of the requested NF Service Producer appended with its PLMN ID (audience), expected service name(s) (scope) and expiration time (expiration).\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the SNPN ID of the serving SNPN is included instead of the NF Service Consumer's PLMN ID and the SNPN ID or the PLMN ID of the Credentials Holder is included instead of the NF Service Producer's PLMN ID.\n4. The token shall be included in the Nnrf_AccessToken_Get response sent to the NRF in the visited PLMN.\n5. The NRF in the visited PLMN shall forward the Nnrf_AccessToken_Get response message to the NF Service Consumer. The NF Service Consumer may store the received token(s). Stored tokens may be re-used for accessing service(s) from NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer listed in claims (scope, audience) during their validity time.\nStep 2: Service access request based on token verification\nIn addition to the steps described in the non-roaming scenario in 13.4.1.1, the NF Service Producer shall verify that the PLMN-ID (or SNPN ID) contained in the API request is equal to the one inside the access token.\nThe figure depicts a user-friendly interface for NF Service Consumer (S) requesting service access in a roaming case. The user is presented with a list of available service providers, their respective access tokens, and the corresponding roaming case status. The user can select the desired service provider and access token, and the system will display the corresponding roaming case status. This interface is designed to be user-friendly and intuitive, making it easy for users to navigate and select the appropriate service and access token for their needs.\nFigure 13.4.1.2.2-2: NF Service Consumer requesting service access with an access token in roaming case\nThe NF Service Producer shall check that the home PLMN ID of audience claim in the access token matches its own PLMN identity.\nFor SNPNs with Credentials Holder using AUSF and UDM for primary authentication, the NF Service Producer verifies the SNPN ID of the serving SNPN contained in the API request instead of the PLMN-ID, and the SNPN ID or the PLMN ID of the Credentials Holder instead of the home PLMN ID.\nThe pSEPP shall check that the serving PLMN ID of subject claim in the access token matches the remote PLMN ID. If PRINS is used, this can be achieved by the pSEPP checking the PLMN ID of the serving network in the access token against the PLMN ID(s) in the N32-f context.\nIf the peer network is an SNPN, the pSEPP shall check that the SNPN ID of the NF Service Consumer in the access token matches the SNPN ID of the peer network.\nThis clause covers the scenario where the NF Service Consumer and the NRF are connected over a mutually authenticated TLS connection.\nThe figure depicts a simplified authorization and service invocation procedure for indirect communication without delegated discovery, with mutual authentication between the Network Functions (NF) and Network Radio Functions (NRF) at the transport layer. It illustrates the steps involved in establishing a secure communication channel between the two entities, ensuring that only authorized users can access the network resources.\nFigure 13.4.1.3.1.1-1: Authorization and service invocation procedure, for indirect communication without delegated discovery, with mutual authentication between NF and NRF at the transport layer\nDiscovery of the NF Service Producer:\n0.\tOptionally, the NF Service Consumer may discover the NF Service Producer before requesting authorization to invoke the services of the NF Service Producer. E.g. if the NF Service Consumer has not yet discovered the NF Service Producer, then it may run the discovery procedure.\nNF Service Consumer authorization:\n1-2.\nAfter mutual authentication between NF Service Consumer and NRF at the transport layer, the NF Service Consumer and NRF perform the \"Access token request before service access\" procedure as described in clause 13.4.1.1. If the NF Service Consumer has already discovered the NF Service Producer, it can also perform the \"Access token request for a specific NF Service Producer/NF Service Producer instance\" procedure as described in clause 13.4.1.1.\nService request:\nThe NF Service Consumer, SCP, NRF and NF Service Producer perform the procedure \"Indirect Communication without delegated discovery Procedure\" described in clause 4.17.11 of TS 23.502 [8]. The following steps describe how the access token received from steps 1 and 2 is used in this procedure.\n3.\tIf no cached data is available, the NF Service Consumer discovers the NF Service Producer via the SCP.\n4.\tThe NF Service Consumer sends a service request for the specific service to the SCP. The service request includes the access token as received in step 2, and may include the NF Service Consumer CCA as defined in clause 13.3.8.\nIf the CCA is included, the NF type of the expected audience in the CCA shall contain the NF type of the NF Service Producer .\nIf the NF Service Consumer allows reselection of a target NF Service Producer by the SCP, the expected audience in the CCA shall also contain NF type \"NRF\".\nNOTE:\tIn the same deployment, the NF Service Consumer can delegate the reselection of the target NF Service Producer to the SCP for some requests, and not for other requests.\n5.\tThe SCP selects a NF Service Producer instance, performs the API root modifications and forwards the received request to the selected NF Service Producer instance. The request contains the access token and may contain the NF Service Consumer CCA if received in step 4.\n6.\tTo authorize the access, the NF Service Producer authenticates the service consumer NF using one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1 by verifying the signature and checking if the requested service is part of the token's scope.\n7.   If the checks in step 6 are successful, the NF Service Producer processes the service request and provides a service response.\n8.\tThe SCP performs reverse API root modifications and forwards the service response.\n\nWhen there is no  mutual authentication between NF Service Consumer and NRF at the transport layer, the NF Service Consumer performs the following procedure to obtain the access token from NRF and uses it for service access at the NF Service Producer. In this clause, the authentication of NF Service Consumer by the NRF and by the NF Service Producer is based on any of the methods described in clauses 13.3.1.2 and 13.3.2.2.\n\nThe figure depicts the authorization and service invocation procedure for indirect communication without mutual authentication between the Network Functions (NF) and Network Radio Functions (NRF) at the transport layer. It illustrates the steps involved in determining the authorization and service invocation, including the use of delegated discovery and mutual authentication.\nFigure 13.4.1.3.1.2-1: Authorization and service invocation procedure, for indirect communication without delegated discovery, without mutual authentication between NF and NRF at the transport layer\n0.\tOptionally, the NF Service Consumer may discover the NF Service Producer before requesting authorization to invoke the services of the NF Service Producer.\n1. \tThe NF Service Consumer sends an access token request (Nnrf_AccessToken_Get Request) to the SCP with parameters as specified in 13.4.1.1.  The access token request may additionally include the NF Service Consumer CCA as defined in clause 13.3.8.\nIf the CCA is included, the NF type of the expected audience in CCA shall contain NF type \"NRF\".\n2. \tThe SCP forwards the access token request (Nnrf_AccessToken_Get Request) to the NRF. The request may include the NF Service Consumer CCA if received in step 1.\n3.\tThe NRF authenticates the service consumer NF using one of the methods described in clause 13.3.1.2. If the NF Service Consumer authentication is successful and the NF Service Consumer is authorized based on the NRF policy, the NRF issues an access token as described in clause 13.4.1.1. The NRF uses the NF Service Consumer NF Instance ID as the subject of the access token.\n4.   The NRF sends the access token to the SCP in an access token response (Nnrf_AccessToken_Get Response).\n5.\tThe SCP forwards the access token response (Nnrf_AccessToken_Get Response) to the NF Service Consumer, including the access token.\n6.   The NF Service Consumer sends the service request to the SCP. The service request includes the access token received in Step 5 and may include the NF Service Consumer CCA.\nIf the CCA is included, the NF type of the expected audience in CCA shall contain the NF type of the NF Service Producer .\nIf the NF Service Consumer allows reselection of a target NF Service Producer by the SCP, the expected audience in the CCA shall also contain NF type \"NRF\".\nNOTE: \tIn the same deployment, the NF Service Consumer can delegate the reselection of the target NF Service Producer to the SCP for some requests, and not for other requests.\n7.  The SCP forwards the service request to the NF Service Producer. The service request includes the access token received in step 6, and may include the NF Service Consumer CCA if received in step 6.\n8.\tThe NF Service Producer authenticates the NF Service Consumer by one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1.\n9.\tIf the validation of the access token is successful, the NF Service Producer sends the service response to the SCP.\n10.\tThe SCP forwards the service response to the NF Service Consumer.\nThis clause covers the scenario where the NF Service Consumer use the SCP to discover and select the NF Service Producer instance that can process the service request.\n\nThe figure depicts a simplified illustration of the authorization and service invocation procedure for indirect communication with delegated discovery in a 3GPP-compliant network. It shows the steps involved in obtaining authorization and initiating a service invocation, with a focus on the delegated discovery process.\nFigure 13.4.1.3.2-1: Authorization and service invocation procedure, for indirect communication with delegated discovery\n1.\tThe NF Service Consumer sends a service request to the SCP. The service request may include the NF Service Consumer's CCA as defined in clause 13.3.8.The NF Service Consumer may include an access token in the service request if it has received an access token in a previous service response. If a previously received access token has expired, the NF Service Consumer may include discovery parameters as specified in TS 29.500 [74] clause 5.2.3.2.7 in the service request.\nIf the CCA is included, the NF type of the expected audience in CCA shall contain NF type of \"NRF\" and the NF type of the NF Service Producer .\n2.\tThe SCP may perform a service discovery with the NRF. If NF Service Consumer has included an access token in step 1, or if the SCP has a cached granted access token, then SCP may reuse the access token and proceeds to step 6.\n3. \tThe SCP sends an access token request (Nnrf_AccessToken_Get Request) to the NRF. The access token request includes parameters as defined in clause 13.4.1.1. The access token request may include the NF Service Consumer's CCA if received in Step 1.\n4.\tThe NRF authenticates the NF Service Consumer using one of the methods described in clause 13.3.1.2. If NF Service Consumer authentication is successful and the NF Service Consumer is authorized based on the NRF policy, the NRF issues an access token as described in clause 13.4.1.1. The NRF uses the NF Service Consumer instance ID as the subject of the access token.\n5.\tThe NRF sends the access token to the SCP in an access token response (Nnrf_AccessToken_Get Response).\n6.\tThe SCP sends the service request to the NF Service Producer. The service request includes an access token (i.e., received in Step 1, received in Step 5, or previously cached), and may include the NF Service Consumer's CCA if received in Step 1.\n7.\tThe NF Service Producer authenticates the NF Service Consumer by one of the methods described in clause 13.3.2.2 and if successful, it validates the access token as described in clause 13.4.1.1.\n8.\tIf the validation of the access token is successful, the NF Service Producer sends the service response to the SCP.\n9.\tThe SCP forwards the service response to the NF Service Consumer. The SCP may include the access token in the service response to NF Service Consumer for possible re-use in subsequent service requests.\nDuring inter-NF mobility, i.e., AMF to AMF mobility and/or NWDAF to NWDAF mobility, subscriptions at the source NF are transferred to the target NF as part of the context transfer. The source NF may store the access token along with the created subscriptions and forward the access token to the target NF as a part of context transfer. The target NF authorizes the subscription based on its local policy. The target NF may use the received token from the source NF for authorizing the subscription.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "13.5\tSecurity capability negotiation between SEPPs",
                    "description": "",
                    "summary": "",
                    "text_content": "The security capability negotiation over N32-c allows the SEPPs to negotiate which security mechanism to use for protecting NF service-related signalling over N32-f. There shall be an agreed security mechanism between a pair of SEPPs before conveying NF service-related signalling over N32-f.\nWhen a SEPP notices that it does not have an agreed security mechanism for N32-f protection with a peer SEPP or if the security capabilities of the SEPP have been updated, the SEPP shall perform security capability negotiation with the peer SEPP over N32-c in order to determine, which security mechanism to use for protecting NF service-related signalling over N32-f. Certificate based authentication shall follow the profiles given in 3GPP TS 33.210 [3], clause 6.2.\nA mutually authenticated TLS connection as defined in clause 13.1 shall be used for protecting security capability negotiation over N32-c. The TLS connection shall provide integrity, confidentiality and replay protection.\nThe figure depicts a security capability negotiation process in a 5G network, illustrating the negotiation between the network and the security service provider (SSP) to determine the security level and service level agreement (SLA). The figure shows the negotiation process, including the negotiation process, negotiation results, and the negotiation process.\nFigure 13.5-1 Security capability negotiation\n1.\tThe SEPP which initiated the TLS connection shall issue a POST request to the exchange-capability resource of the responding SEPP including the initiating SEPP’s supported security mechanisms for protecting the NF service-related signalling over N32-f (see table Table 13.5-1). The security mechanisms shall be ordered in the initiating SEPP’s priority order.\n2.\tThe responding SEPP shall compare the received security capabilities to its own supported security capabilities and selects, based on its local policy (e.g. based on whether there are IPX providers on the path between the SEPPs), a security mechanism, which is supported by both initiating SEPP and responding SEPP.\n3.\tThe responding SEPP shall respond to the initiating SEPP with the selected security mechanism for protecting the NF service-related signalling over N32.\nTable 13.5-1: NF service-related signalling traffic protection mechanisms over N32\n\nIf the selected security mechanism is PRINS, the SEPPs shall behave as specified in clause 13.2.\nIf the selected security mechanism is TLS, the SEPPs shall behave as specified in clause 13.1.2, tear down the N32-c connection and forward the NF service related signalling over N32-f using a TLS connection.\nIf the selected security mechanism is a mechanism other than the ones specified in Table 13.5-1, the two SEPPs shall terminate the N32-c TLS connection.\n\n",
                    "tables": [
                        {
                            "description": "Table 13.5-1: NF service-related signalling traffic protection mechanisms over N32",
                            "table number": 2,
                            "summary": "",
                            "name": ""
                        }
                    ],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "14\tSecurity related services",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "14.1\tServices provided by AUSF",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "14.1.1\tGeneral",
                            "text_content": "The AUSF provides UE authentication service to the requester NF by Nausf_UEAuthentication. For AKA based authentication, this operation can be also used to recover from synchronization failure situations. Clause 14.1.2 describes the Nausf_UEAuthentication service. The service operations listed here are used in procedures that are described in clause 6 of the present document and in TS 33.503 [109].\nClause 14.1.3 describes the Nausf_SoRProtection service used in procedures that are described in clause 6.14 of the present document.\nClause 14.1.4 describes the Nausf_UPUProtection service used in procedures that are described in clause 6.15 of the present document.\nSince AUSF is completely security-related, all service operations are described in the present document. TS 23.501 [2], clause 7.2.7, only lists the services and TS 23.502 [8], clause 5.2.10, provides the reference to the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.1.2\tNausf_UEAuthentication service",
                            "text_content": "Service operation name: Nausf_UEAuthentication_authenticate.\nDescription: Authenticate the UE and provides related keying material.\nInput, Required: One of the options below.\n1.\tIn the initial authentication request: SUPI or SUCI, serving network name.\n2.\tIn the subsequent authentication requests depending on the authentication method:\na.\t5G AKA: Authentication confirmation message with RES* as described in clause 6.1.3.2 or Synchronization Failure indication and related information (i.e. RAND/AUTS).\nb.\tEAP-AKA’: \tEAP packet as described in RFC 4187 [21] and RFC 5448 [12], and Annex F.\nInput, Optional: Disaster Roaming service indication, NSWO indicator.\nNOTE:\tIf NSWO indicator is present then the serving network name contains \"5G:NSWO\".\nOutput, Required: One of the options below.\n1.\tDepending on the authentication method:\na.\t5G AKA: authentication vector, as described in clause 6.1.3.2 or Authentication confirmation acknowledge message.\nb.\tEAP-AKA’:\tEAP packet as described in RFC 4187 [21] and RFC 5448 [12], and Annex F.\n2.\tAuthentication result and if success the master key which are used by AMF to derive NAS security keys and other security key(s).\nOutput, Optional: SUPI if the authentication was initiated with SUCI, MSK if either NSWO indicator was received as input or MSK indicator was received from UDM.\nService operation name: Nausf_UEAuthentication_deregister\nDescription: Deletion of stale security parameters (KAUSF, SOR counter and UE parameter update counter) in AUSF. UDM uses this service operation to request the AUSF to clear the stale security parameters, after the UE has been successfully (re)authenticated in different AUSF Instance.\nInput, Required: SUPI\nInput, Optional: None\nOutput, Required: None\nOutput, Optional: None\nSee TS 33.503 [109].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.1.3\tNausf_SoRProtection service",
                            "text_content": "The following table illustrates the security related services for SoR that AUSF provides.\nTable 14.1.3-1: NF services for SoR provided by AUSF\n\nService operation name: Nausf_SoRProtection.\nDescription: The AUSF calculates the SoR-MAC-IAUSF as specified in the Annex A.17 of this document using UE specific home key (KAUSF), the Steering Information List and ACK Indication  received from the requester NF and delivers the SoR-MAC-IAUSF and CounterSoR to the requester NF. If the ACK Indication input is set to indicate that the acknowledgement is requested, then the AUSF shall compute the SoR-XMAC-IUE as specified in Annex A.18 of the present document, and return it in the response.\nNOTE:\tAt reception of Nausf_SoRProtection_Protect request from the UDM, the AUSF constructs the SOR header, as described in clause 9.11.3.51 of TS 24.501 [35], based on the information received from the requester NF, i.e. ACK Indication and list of preferred PLMN/access technology combinations or a secured packet (if provided).\nInput, Required: Requester ID, SUPI, service name, ACK Indication.\nInput, Optional: list of preferred PLMN/access technology combinations or secured packet or SoR transparent container.\nOutput, Required: SoR-MAC-IAUSF, CounterSoR or error (counter_wrap).\nOutput, Optional: SoR-XMAC-IUE (if the ACK Indication input is set to indicate that the acknowledgement is requested, then the SoR-XMAC-IUE shall be computed and returned).\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 14.1.3-1: NF services for SoR provided by AUSF",
                                    "table number": 3,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "14.1.4\tNausf_UPUProtection service",
                            "text_content": "The following table illustrates the security related services for UE Parameters Update that AUSF provides.\nTable 14.1.4-1: NF services for UE Parameters Update provided by AUSF\n\nService operation name: Nausf_UPUProtection.\nDescription: The AUSF calculates the UPU-MAC-IAUSF as specified in the Annex A.19 of this document using UE specific home key (KAUSF) along with the UE Parameters Update Data received from the requester NF (see clause A.19) and delivers the UPU-MAC-IAUSF and CounterUPU to the requester NF. If the ACK Indication input is present, then the AUSF shall compute the UPU-XMAC-IUE and return the computed UPU-XMAC-IUE as specified in Annex A.20 of the present document, in the response. The details of the UE Parameters Update Data is specified in TS 24.501 [35].\nInput, Required: Requester ID, SUPI, service name, UE Parameters Update Data.\nInput, Optional: ACK Indication.\nOutput, Required: UPU-MAC-IAUSF, CounterUPU or error (counter_wrap).\nOutput, Optional: UPU-XMAC-IUE (if the ACK Indication input is present, then the UPU-XMAC-IUE shall be computed and returned).\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 14.1.4-1: NF services for UE Parameters Update provided by AUSF",
                                    "table number": 4,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "14.1.5\tVoid",
                            "text_content": "",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "14.2\tServices provided by UDM",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "14.2.1\tGeneral",
                            "text_content": "UDM provides within Nudm_UEAuthentication service all authentication-related service operations, which are Nudm_UEAuthentication_Get (clause 14.2.2) , Nudm_UEAuthentication_ResultConfirmation (clause 14.2.3), Nudm_UEAuthentication_GetProseAv (clause 14.2.4) and Nudm_UEAuthentication_GetGbaAv (clause 14.2.5).\nThe complete list of UDM services is defined in TS 23.501 [2], clause 7.2.5, and further refined in TS 23.502 [8], clause 5.2.3.1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.2\tNudm_UEAuthentication_Get service operation",
                            "text_content": "Service operation name: Nudm_UEAuthentication_Get\nDescription: Requester NF gets the authentication data from UDM. For AKA based authentication, this operation can be also used to recover from synchronization failure situations. If SUCI is included, this service operation returns the SUPI.\nInputs, Required: SUPI or SUCI, serving network name.\nInputs, Optional: Synchronization Failure indication and related information (i.e. RAND/AUTS) , Disaster Roaming service indication, NSWO indicator.\nNOTE:\tIf NSWO indicator is present then the serving network name contains \"5G:NSWO\".\nOutputs, Required: Authentication method\nEditor's note: How the UDM indicates to the AUSF to run primary authentication with an external Credentials holder is FFS.\nOutputs, Optional: SUPI if SUCI was used as input. Depending on the authentication method, authentication data (e.g. AKA authentication vector) for the SUPI. AKMA Indication and Routing indicator, if the subscriber has an AKMA subscription (see TS 33.535 [91]). MSK indicator.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.3\tNudm_UEAuthentication_ResultConfirmation service operation",
                            "text_content": "Service operation name: UEAuthentication_ResultConfirmation\nDescription: Requester NF informs UDM about the result of an authentication procedure with a UE.\nInputs, Required: SUPI, timestamp of the authentication, the authentication type (e.g. EAP method or 5G-AKA), and the serving network name.\nInputs, Optional: None.\nOutputs, Required: None.\nOutputs, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.4\tNudm_UEAuthentication_GetProseAv service operation",
                            "text_content": "See TS 33.503 [109].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.5\tNudm_UEAuthentication_GetGbaAv service operation",
                            "text_content": "See TS 33.220 [28], Annex N.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.6\tNudm_UECM_AuthTrigger service operation",
                            "text_content": "Service operation name: Nudm_UECM_AuthTrigger.\nDescription: This service operation allows the NF to request UDM to trigger a primary (re-)authentication as described in clause 6.1.5.\nInput, Required: SUPI.\nInput, Optional: None.\nOutput, Required: None.\nOutput, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "14.2.7\tNudm_UECM_Re-AuthenticationNotification service operation",
                            "text_content": "Service operation name: Nudm_UECM_Re-AuthenticationNotification\nDescription: The UDM requests the AMF to perform a primary authentication for a specific UE.\nInputs, Required: SUPI\nInputs, Optional: None.\nOutputs, Required: Success/Failure cause.\nOutputs, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "14.3\tServices provided by NRF",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "14.3.1\tGeneral",
                            "text_content": "The following table illustrates the security related services for OAuth 2.0 that NRF provides. OAuth 2.0 based authorization is described in clause 13.4.1.\n\nThe complete list of NRF services is defined in TS 23.501 [2], clause 7.2.6, and further refined in TS 23.502 [8], clause 5.2.7.\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "The following table illustrates the security related services for OAuth 2.0 that NRF provides. OAuth 2.0 based authorization is described in clause 13.4.1.",
                                    "table number": 5,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "14.3.2\tNnrf_AccessToken_Get Service Operation",
                            "text_content": "Service Operation name: Nnrf_AccessToken_Get.\nDescription: NF Service Consumer requests NRF to provide an Access Token.\nInputs, Required: the NF Instance Id of the NF Service Consumer, the requested \"scope\" including the expected NF service name(s).\nInputs, Optional: PLMN ID (or SNPN ID) of the requester NF Service Consumer, PLMN ID  (or SNPN ID)of the requested NF Service Producer, NF Instance Id(s) of the requested NF Service Producer, NF type of the expected NF Service Producer instance and NF Service Consumer, \"additional scope\" information (i.e. requested resources and requested actions (service operations) on the resources), list of NSSAIs or list of NSI IDs for the expected NF Service Producer instances, NF Set ID of the expected NF Service Producer instances, list of S-NSSAIs of the NF Service Consumer.\nOutputs, Required: Access Token with appropriate claims, where the claims shall include NF Instance Id of NRF (issuer), NF Instance Id of the NF Service Consumer potentially appended with its PLMN ID (or SNPN ID) (subject), NF type of the NF Service Producers or NF Instance Id or several NF Instance Id(s) of the requested NF Service Producer, potentially appended with PLMN ID (or SNPN ID) (audience), expected service name (scope), optionally \"additional scope\" information (allowed resources and allowed actions (service operations) on the resources) and expiration time (expiration), may include list of NSSAIs or NSI IDs for the expected NF Service Producer instances, and may include the NF Set ID of the expected NF Service Producer instances.\nOutputs, Optional: None.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "14.4\tServices provided by NSSAAF",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "14.4.1\tNnssaaf_NSSAA services",
                            "text_content": "The following table illustrates the security related services for Network Slice Specific Authentication and Authorisation that NSSAAF provides.\nTable 14.4.1.1-1: NF services for the NSSAA service provided by NSSAAF\n\nService operation name: Nnssaaf_NSSAA_Authenticate\nDescription: NF consumer requires the NSSAAF to relay Network Slice specific authentication messages towards the corresponding AAA-S handling the Network Slice specific authentication for the requested S-NSSAI (see clause 16).\nInput, Required:\n1) In the initial NSSAA requests: EAP ID Response, GPSI, S-NSSAI\n2) In subsequent NSSAA requests: EAP message, GPSI, S-NSSAI\nInput, Optional: None\nOutput, Required: EAP message, GPSI, S-NSSAI\nOutput, Optional: None\nService operation name: Nnssaaf_NSSAA_Re-AuthenticationNotification\nDescription: NSSAAF notifies the NF consumer to trigger a Network Slice specific reauthentication procedure for a given UE and S-NSSAI.\nNOTE:\tThe AMF is implicitly subscribed to receive Nnssaaf_NSSAA_Re-authenticationNotification service operation.\nInput, Required: GPSI, S-NSSAI\nInput, Optional: None\nOutput, Required: None\nOutput, Optional: None\nService operation name: Nnssaaf_NSSAA_RevocationNotification\nDescription: NSSAAF notifies the NF consumer to trigger a Network Slice specific revocation procedure for a given UE and S-NSSAI.\nNOTE:\tThe AMF is implicitly subscribed to receive Nnssaaf_NSSAA_RevocationNotification service operation.\nInput, Required: GPSI, S-NSSAI\nInput, Optional: None\nOutput, Required: None\nOutput, Optional: None\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 14.4.1.1-1: NF services for the NSSAA service provided by NSSAAF",
                                    "table number": 6,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        },
                        {
                            "title": "14.4.2\tNnssaaf_AIW services",
                            "text_content": "The following table illustrates the security related services provided by the NSSAAF for primary authentication in SNPN with Credentials holder using AAA server (see clause I.2.2.2).\nTable 14.4.2.1-1: NF services for CH using AAA for primary authentication provided by NSSAAF\n\nService operation name: Nnssaaf_AIW_Authenticate\nDescription: The NSSAAF provides Authentication and Authorization service to the consumer NF by relaying EAP or EAP-TTLS inner method messages towards a AAA Server and performing related protocol conversion as needed. Input, Required:\n1) In EAP Authentication:\na) In the initial authentication request: SUPI.\nb) In subsequent authentication requests: EAP message.\n2) In case EAP-TTLS mechanisms are implemented: inner method container.\nInput, Optional: None\nOutput, Required:\n1) In EAP authentication: EAP message, authentication result and if success MSK and SUPI.\n2) In case EAP-TTLS mechanisms are implemented: inner method container.\nOutput, Optional: None\n\n",
                            "figures_meta_data": [],
                            "tables": [
                                {
                                    "description": "Table 14.4.2.1-1: NF services for CH using AAA for primary authentication provided by NSSAAF",
                                    "table number": 7,
                                    "summary": "",
                                    "name": ""
                                }
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "title": "15\tManagement security for network slices",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "15.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The creation, modification, and termination of a Network Slice Instance (NSI) is part of the Management Services provided by the 5G management systems. A management service is accessed by management service consumers via standardized service interfaces given in 3GPP TS 28.533 [54]. The typical service consumers for the above NSI provisioning and NSI provisioning exposure are operators and vertical industry respecitively, as described in 3GPP TS 28.531 [55]. These management services are securely protected through mutual authentication and authorization below.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "15.2\tMutual authentication",
                    "description": "",
                    "summary": "",
                    "text_content": "If a management service consumer resides outside the 3GPP operator’s trust domain, mutual authentication shall be performed between the management service consumer and the management service producer using TLS. TLS shall follow, the profile given in TS 33.210 [3], clause 6.2 and either 1) the client and server certificates with the profiles given in 3GPP TS 33.310 [5], clause 6.1.3a or 2) pre-shared keys following RFC 5489for TLS 1.2 and RFC 8446 [60] for TLS 1.3. The structure of the PKI used for the certificates is out of scope of the present document. The identities in the end entity certificates shall be used for authentication and policy checks. The key distribution of pre-shared keys for TLS is up to the operator’s security policy and out of scope of the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "15.3\tProtection of management interactions between the management service consumer and the management service producer",
                    "description": "",
                    "summary": "",
                    "text_content": "TLS shall be used to provide mutual authentication, integrity protection, replay protection and confidentiality protection for the interface between the management service producer and the management service consumer residing outside the 3GPP operator’s trust domain. Security profiles for TLS implementation and usage shall follow the TLS profile given in clause 6.2 of TS 33.210 [3] and the certificate profile given in clause 6.1.3a of TS 33.310 [5]. The identities in the end entity certificates shall be used for authentication and policy checks.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "15.4\tAuthorization of management service consumer’s request",
                    "description": "",
                    "summary": "",
                    "text_content": "After the mutual authentication, the management service producer determines whether the management service consumer is authorized to send requests to the management service producer. The management service producer shall authorize the requests from the management service consumer using the one of the following two options: 1) OAuth-based authorization mechanism following RFC 6749 [43]; 2) based on the local policy of the management service producer.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "16\tSecurity procedures for network slices",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "16.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause specifies the security procedures for network slices.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "16.2\tAuthorization for network slice access",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause specifies the relationship between primary authentication (as described in Clause 6.1) and authorization for network slice access (as described in TS 23.502 [8]) for a UE. Authorization from a home/serving PLMN is required for a UE to gain access to a network slice, identified by an S-NSSAI. An authorized S-NSSAI (i.e. allowed S-NSSAI) shall be granted to a UE only after the UE has completed successfully primary authentication. At the end of the primary authentication, the AMF and UE may receive a list of allowed S-NSSAI, which the UE is authorized to access.\nFor certain S-NSSAIs, additional Network Slice Specific Authentication and Authorization (NSSAA) is required. This clause in addition specifies the pre-requisite for an NSSAA procedure that is described in clause 16.3, with reference to the following figure 16.2-1.\n\nThe figure depicts a relationship between primary authentication and NSSAA (Network Security Services Architecture). It illustrates the various components and their interactions, highlighting the importance of NSSAA in ensuring network security.\nFigure 16.2-1: Relationship between primary authentication and NSSAA\n1. UE sends a Registration Request with a list of S-NSSAIs. UE shall not include those S-NSSAIs for which NSSAA procedures are ongoing, regardless of access types (c.f. TS 23.501[2], clause 5.15.5.2.1 and TS 23.502[8], clause 4.2.2.2.2).\n2. For an initial Registration Request, the AMF/SEAF shall invoke Primary authentication as described in clause 6.1.2 of the present document. For a subsequent Registration Request, the Primary authentication may be skipped if the UE has already been authenticated and the AMF has valid security context.\n3. AMF shall determine whether NSSAA is required for each of S-NSSAIs, based on information stored locally or from UDM. For example, the NSSAA for an S-NSSAI may be omitted\n1) if it is not required based on the subscription information,\n2) if UE has previously performed NSSAA successfully, regardless of access type and the result is still valid, or\n3) NSSAA for UE is ongoing\n4. AMF sends the Registration Accept message to the UE (c.f. TS 23.501[2], clause 5.15.5.2.1 and TS 23.502[8], clause 4.2.2.2.2, step 21). Optionally UE sends a Registration Complete.\n5. The EAP based NSSAA procedure for each S-NSSAI if required, as determined in step 3, is executed in this step.\n6. Based on the results of step 5, AMF sends UE Configuration Update to update the requested S-NSSAI status based on the NSSAA results.\nThe procedure for step 5, i.e., the NSSAA procedure is specified in clause 16.3.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "16.3\tNetwork slice specific authentication and authorization",
                    "description": "",
                    "summary": "",
                    "text_content": "This clause specifies the optional-to-use NSSAA between a UE and an AAA server (AAA-S) which may be owned by an external 3rd party enterprise. NSSAA uses a User ID and credentials, different from the 3GPP subscription credentials (e.g. SUPI and credentials used for PLMN access) and takes place after the primary authentication.\nThe EAP framework specified in RFC 3748 [27] shall be used for NSSAA between the UE and the AAA server. The SEAF/AMF shall perform the role of the EAP Authenticator and communicates with the AAA-S via the NSSAAF. The NSSAAF undertakes any AAA protocol interworking with the AAA-S. Multiple EAP methods are possible for NSSAA. If the AAA-S belongs to a third party the NSSAAF contacts the AAA-S via a AAA-P. The NSSAAF and the AAA-P may be co-located.\nTo protect privacy of the EAP ID used for the EAP based NSSAA, a privacy-protection capable EAP method is recommended, if privacy protection is required.\n\nThe steps involved in NSSAA are described below.\nThe figure depicts the NSSAA (Network Segmentation and Submarine Antennas Array) procedure, which is a crucial step in the design and installation of submarine communication systems. The figure illustrates the process of segmenting the network into different sections, such as the submarine's own section, the communication section, and the communication between the submarine and the surface. The figure also shows the placement of the submarine's own section, which is crucial for the communication between the submarine and the surface. The figure is important for understanding the complexity of submarine communication systems and the importance of proper planning and execution.\nFigure 16.3-1: NSSAA procedure\n1.\tFor S-NSSAIs that are requiring NSSAA, based on change of subscription information, or triggered by the AAA-S, the AMF may trigger the start of the NSSAA procedure.\nIf NSSAA is triggered as a result of Registration procedure, the AMF may determine, based on UE Context in the AMF, that for some or all S-NSSAI(s) subject to NSSAA, the UE has already been authenticated following a Registration procedure on a first access. Depending on NSSAA result (e.g. success/failure) from the previous Registration, the AMF may decide, based on Network policies, to skip NSSAA for these S-NSSAIs during the Registration on a second access.\nIf the NSSAA procedure corresponds to a re-authentication and re-authorization procedure triggered as a result of AAA Server-triggered UE re-authentication and re-authorization for one or more S-NSSAIs, as described in clause 16.4, or triggered by the AMF based on operator policy or a subscription change and if S-NSSAIs that are requiring Network Slice-Specific Authentication and Authorization are included in the Allowed NSSAI for each Access Type, the AMF selects an Access Type to be used to perform the NSSAA procedure based on network policies.\n2.\tThe AMF may request the UE User ID for EAP authentication (EAP ID) for the S-NSSAI in a NAS MM Transport message including the S-NSSAI.\n3.\tThe UE provides the EAP ID for the S-NSSAI alongside the S-NSSAI in an NAS MM Transport message towards the AMF.\n4.\tThe AMF sends the EAP ID to the NSSAAF which provides interface with the AAA, in an Nnssaaf_NSSAA_Authenticate Request (EAP ID Response, GPSI, S-NSSAI).\n5.\tIf the AAA-P is present (e.g. because the AAA-S belongs to a third party and the operator deploys a proxy towards third parties), the NSSAAF forwards the EAP ID Response message to the AAA-P, otherwise the NSSAAF forwards the message directly to the AAA-S. NSSAAF routes to the AAA-S based on the S-NSSAI. The NSSAAF/AAA-P forwards the EAP Identity message to the AAA-S together with S-NSSAI and GPSI. The AAA-S stores the GPSI to create an association with the EAP ID in the EAP ID response message so the AAA-S can later use it to revoke authorisation or to trigger reauthentication. The AAA-S uses the EAP-ID and S-NSSAI to identify for which UE and slice authorisation is requested.\nNOTE :\tIf the AAA-S belongs to the 3rd party, the NSSAAF optionally maps the S-NSSAI to External Network Slice Information (ENSI), and forwards the EAP Identity message to the AAA-S together with ENSI and GPSI. In this case, the AAA-S uses the EAP-ID and ENSI to identify the UE for which slice authorisation is requested.\n6 -11.\tEAP-messages are exchanged with the UE. One or more than one iterations of these steps may occur.\n12.\tEAP authentication completes. An EAP-Success/Failure message is delivered to the NSSAAF/AAA-P along with GPSI and S-NSSAI/ENSI.\n13.\tThe NSSAAF sends the Nnssaaf_NSSAA_Authenticate Response (EAP-Success/Failure, S-NSSAI, GPSI) to the AMF.\n14.\tThe AMF transmits a NAS MM Transport message (EAP-Success/Failure) to the UE.\n15. Based on the result of Slice specific authentication (EAP-Success/Failure), if a new Allowed NSSAI or new Rejected NSSAIs needs to be delivered to the UE, or if the AMF re-allocation is required, the AMF initiates the UE Configuration Update procedure, for each Access Type, as described in clause 4.2.4.2 of TS 23.502 [8].\nIf the NSSAA procedure can not be completed (e.g. due to server error or UE becoming unreachable), the AMF sets the status of the corresponding S-NSSAI subject to Network Slice-Specific Authentication and Authorization in the UE context as defined in  TS 29.526 [96], so that an NSSAA is executed next time the UE requests to register with the S-NSSAI.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "16.4\tAAA Server triggered Network Slice-Specific Re-authentication and Re-authorization procedure",
                    "description": "",
                    "summary": "",
                    "text_content": "\n\nFigure 16.4-1: AAA Server initiated Network Slice-Specific Re-authentication and Re-authorization procedure\n0.\tThe UE is registered in 5GC via an AMF. The AMF ID is stored in the UDM.\n1.\tThe AAA-S requests the re-authentication and re-authorization for the Network Slice specified by the S-NSSAI/ENSI in the Re-Auth Request message, for the UE identified by the GPSI in this message. This message is sent to an AAA-P, if the AAA-P is used (e.g. the AAA Server belongs to a third party), otherwise it may be sent directly to the NSSAAF. If an AAA-P is present, the AAA-P relays the Reauthentication Request to the NSSAAF.\n2.\tThe NSSAAF checks whether the AAA-S is authorized to request the re-authentication and re-authorization by checking the local configuration of AAA-S address per S-NSSAI. If success,the NSSAAF requests UDM for the AMF serving the UE using the Nudm_UECM_Get (GPSI, AMF Registration) service operation. The UDM provides the NSSAAF with the AMF ID of the AMF serving the UE.\n3.\tThe NSSAAF provides an acknowledgement to the AAA protocol Re-Auth Request message. If the AMF is not registered in UDM the procedure is stopped here.\n4.\tIf the AMF is registered in UDM, the NSSAAF requests the relevant AMF to re-authenticate/re-authorize the S-NSSAI for the UE using the Nnssaaf_NSSAA_Re-authenticationNotification service operation. The AMF is implicitly subscribed to receive Nnssaaf_NSSAA_Re-authenticationNotification service operations. The NSSAAF may discover the Callback URI for the Nnssaaf_NSSAA_Re-authenticationNotification service operation exposed by the AMF via the NRF.\nThe AMF acknowledges the notification of Re-authentication request.\n5.\tIf the UE is registered with the S-NSSAI in the Mapping Of Allowed NSSAI, the AMF triggers the NSSAA procedure defined in clause 16.3 for the UE identified by the GPSI and the Network Slice identified by the S-NSSAI received from the NSSAAF.\nIf the UE is registered but the S-NSSAI is not in the Mapping Of Allowed NSSAI, the AMF removes any status of the corresponding S-NSSAI subject to Network Slice-Specific Authentication and Authorization in the UE context it may have kept, so that an NSSAA is executed next time the UE requests to register with the S-NSSAI.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "16.5\tAAA Server triggered Slice-Specific Authorization Revocation",
                    "description": "",
                    "summary": "",
                    "text_content": "\nThe figure depicts a network slice-specific authorization revocation procedure in an AAA (Authentication, Authorization, and Accounting) server-initiated network. The procedure involves the AAA server initiating a network slice, which is a logical grouping of network slices within a network. The figure illustrates the steps involved in revoking authorization for a network slice, including the use of a revocation token. The figure also shows the role of the AAA server in managing the network slice-specific authorization and revocation processes.\nFigure 16.5-1: AAA Server-initiated Network Slice-Specific Authorization Revocation procedure\n0.\tThe UE is registered in 5GC via an AMF. The AMF ID is stored in the UDM.\n1.\tThe slice specific AAA-S requests the revocation of authorization for the Network Slice identified by the GPSI in the AAA Protocol Revoke Authorization Request message. This message is sent to NSSAAF instance interfacing with AAA-S or AAA-P if it is used.\nThe AAA-P, if present, relays the request to the NSSAAF.\n2.\tThe NSSAAF checks whether the AAA-S is authorized to request the revocation by checking the local configuration of AAA-S address per S-NSSAI. If success,the NSSAAF requests UDM for the AMF serving the UE using the Nudm_UECM_Get (GPSI, AMF Registration) service operation. The UDM provides the NSSAAF with the AMF ID of the AMF serving the UE.\n3. The NSSAAF sends an acknowledgement to the the AAA-S/AAA-P with AAA Protocol Revoke Authorization Response message. If the AMF is not registered in UDM the procedure is stopped here.\n4.\tIf the AMF is registered in UDM, the NSSAAF request the relevant AMF to revoke the S-NSSAI authorization for the UE using the Nnssaaf_NSSAA_RevocationNotification service operation.\nThe AMF is implicitly subscribed to receive Nnssaaf_NSSAA_RevocationNotification service operations. The NSSAAF may discover the Callback URI for the Nnssaaf_NSSAA_RevocationNotification service operation exposed by the AMF via the NRF.  The AMF acknowledges the Notification of Revocation request.\n5.\tThe AMF removes any status it may have kept of the corresponding S-NSSAI subject to Network Slice-Specific Authentication and Authorisation in the UE context and sends the UE Configuration Update message to revoke the S-NSSAI from the current Allowed NSSAI, for any Access Type for which NSSAA had been successfully run on this S-NSSAI. The AMF provides a new Allowed NSSAI to the UE by removing the S-NSSAI for which authorization has been revoked. The AMF provides new rejected NSSAIs to the UE including the S-NSSAI for which authorization has been revoked. If no S-NSSAI is left in Allowed NSSAI for an access after the revocation, and a Default NSSAI exists that requires no NSSAA or for which a NSSAA did not previously fail over this access, then the AMF may provide a new Allowed NSSAI to the UE containing the Default NSSAI. If no S-NSSAI is left in Allowed NSSAI for an access after the revocation, and no Default NSSAI can be provided to the UE in the Allowed NSSAI or a previous NSSAA failed for the Default NSSAI over this access, then the AMF shall execute the Network-initiated Deregistration procedure for the access as described in subclause 4.2.2.3.3 in TS 23.502 [8], and it shall include in the explicit De-Registration Request message the list of Rejected S-NSSAIs, each of them with the appropriate rejection cause value.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "16.6\tAF Authorization for network slice quota-usage information notification/retrieval",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "16.6.1\tIntroduction",
                            "text_content": "This clause specifies the AF Authorization procedures when AF subscribes/unsubscribes to network slice quota-usage information and when AF retrieves network slice quota-usage information.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "16.6.2\tGeneral",
                            "text_content": "If an AF is deployed within the 3GPP operator domain, an S-NSSAI is allowed to be sent to the AF. The baseline procedure for notifying the AF slice usage information (e.g. number of UEs and PDU Sessions in the slice indicated by the S-NSSAI) and the procedure for retrieving slice usage information by the AF are defined in TS 23.502 [8].\nIf an AF is deployed outside the 3GPP operator domain, an S-NSSAI is not allowed to be sent to the AF as required in clasue 5.9.2.3. The procedure for notifying the AF slice usage information (e.g. number of UEs and PDU Sessions in the slice indicated by the S-NSSAI) and the procedure for retrieving slice usage information by the AF are described in clause 16.6.3.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "16.6.3\tSubscription/unsubscription procedure of NSACF notification service",
                            "text_content": "\nThe figure depicts the subscription/unsubscription process of the NSACF notification procedure in a network security control (NSACF) system. It illustrates the steps involved in initiating and terminating the notification, including the use of a notification service (NSACF) and the associated network security control (NSACF) system. The figure provides a clear visual representation of the process, making it easier to understand and follow.\nFigure 16.6.3-1: Subscription/unsubscription of NSACF notification procedure\n0.\tAuthentication of the AF: the AF is authenticated based on the description in clause 13 or clause 12. The AF authorization is based on clause 13 or clause 12 or local configuration at the NEF. If a token based authorization mechanism is used, a token is generated for the AF after authentication and authorization.\n1.\tTo subscribe or unsubscribe for the number of UEs or the number of PDU Sessions per network slice notification with the NSACF, the AF sends Nnef_EventExposure_Subscribe/Unsubscribe Request (Event ID, Event Filter, Event Reporting information) message to the NEF as described in TS 23.502 [8]. The Event Filter parameter shall be AF-Service-Identifier for an AF deployed outside the 3GPP operator domain. Other parameters are specified in TS 23.502 [8].\n2.\tThe NEF confirms with Nnef_ SliceStatusEventExposure _Subscribe/Unsubscribe Response message to the AF.\nThe Event Filter parameter is the mapped AF-Service-Identifier for the AF deployed outside the 3GPP operator domain.\n3.\tThe NEF checks whether the AF is authorised for the requested subscription based on the AF token. It needs to check whether the token claims match the AF’s identity and the Event Filter parameter. If authorised, the NEF may query the NRF to find the NSACF responsible for the requested S-NSSAI (NEF needs to map to S-NSSAI based on AF-Service-Identifier for the AF deployed outside the 3GPP operator domain).\n4.  The NEF forwards the request to the NSACF with Nnsacf_SliceEventExposure_Subscribe/Unsubscribe Request (Event ID, Event Filter, Event Reporting information). The Event Filter parameter shall be the mapped S-NSSAI for the AF deployed outside the 3GPP operator domain.\n5.\tThe NSACF confirms with Nnsacf_SliceEventExposure_Subscribe/Usubscribe Response message to the NEF as in TS 23.502 [8].\n6-7a.\tThe NSACF triggers a notification towards the AF and sends the Nnsacf_SliceEvent Exposure_Notify (Event ID, Event Filter, Event Reporting information) message to the NEF as described in TS 23.502 [8].\n7b-9.\tThe NEF forwards the message to the AF for single NSACF or aggregates reporting information for multiple NSACFs in the Nnef_EventExposure_Notify (Event ID, Event Filter, Event Reporting information) message as described in TS 23.502 [8]. The Event Filter parameter shall be the mapped AF-Service-Identifier from the S-NSSAI for the AF deployed outside the 3GPP operator domain.\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "A.1\tKDF interface and input parameter construction",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "A.1.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "All key derivations (including input parameter encoding) for 5GC shall be performed using the key derivation function (KDF) specified in Annex B.2.0 of TS 33.220 [28].\nThis clause specifies how to construct the input string, S, and the input key, KEY, for each distinct use of the KDF. Note that \"KEY\" is denoted \"Key\" in TS 33.220 [28].\n\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "A.1.2\tFC value allocations",
                    "description": "",
                    "summary": "",
                    "text_content": "The FC number space used is controlled by TS 33.220 [28], FC values allocated for the present document are in range of 0x69 – 0x79, 0x7B – 0x7D and 0x83-0x84.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "A.2\tKAUSF derivation function",
            "description": "This clause applies to 5G AKA only.\nWhen deriving a KAUSF from CK, IK and the serving network name when producing authentication vectors, and when the UE computes KAUSF during 5G AKA, the following parameters shall be used to form the input S to the  KDF:\n-\tFC =  0x6A;\n-\tP0 = serving network  name;\n-\tL0 = length of the serving network name (variable length as specified in 24.501  [35]);\n-\tP1 = SQN   AK,\n-\tL1 = length of SQN  AK (i.e. 0x00 0x06).\nThe XOR of the Sequence Number (SQN) and the Anonymity Key (AK) is sent to the UE as a part of the Authentication Token (AUTN), see TS 33.102. If AK is not used, AK shall be treated in accordance with TS 33.102, i.e. as 000…0.\nThe serving network name shall be constructed as specified in clause 6.1.1.4.\nThe input key KEY shall be equal to the concatenation CK || IK of CK and IK.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.3\tCK' and IK' derivation function",
            "description": "When deriving CK' and IK' then the KDF of TS 33.402 [11] clause A.2 shall be used with the following exception: the serving network name (specified in clause 6.1.1.4) shall be used as the value of access network identity (P0).\n\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.4\tRES* and XRES* derivation function",
            "description": "When deriving RES* from RES, RAND, and serving network name in the UE and when deriving XRES* from XRES, RAND, and the serving network name in the ARPF, the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x6B,\n-\tP0 = serving network name,\n-\tL0 = length of the serving network name (variable length as specified in 24.501 [35]),\n-\tP1 = RAND,\n-\tL1 = length of RAND (i.e. 0x00  0x10),\n-\tP2 = RES or XRES,\n-\tL2 = length RES or XRES (i.e. variable length between 0x00 0x04 and 0x00  0x10).\nThe input key KEY shall be equal to the concatenation CK || IK of CK and IK.\nThe serving network name shall be constructed as specified in clause 6.1.1.4.\n\nThe (X)RES* is identified with the 128 least significant bits of the output of the KDF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.5\tHRES* and HXRES* derivation function",
            "description": "When deriving HRES* from RES* in the SEAF and when deriving HXRES* from XRES* in the AUSF the following parameters shall be used to form the input S to the SHA-256 hashing algorithm:\n-\tP0 = RAND,\n-\tP1 = RES* or XRES*,\nThe input S shall be equal to the concatenation P0||P1 of the P0 and P1.\nThe H(X)RES* is identified with the 128 least significant bits of the output of the SHA-256 function.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.6\tKSEAF derivation function",
            "description": "When deriving a KSEAF from KAUSF, the following parameters shall be used to form the input S to the  KDF:\n-\tFC = 0x6C,\n-\tP0 = <serving network name>,\n-\tL0 = length of <serving network  name>.\nThe input key KEY shall be KAUSF.\nThe serving network name shall be constructed as specified in clause 6.1.1.4.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.7\tKAMF derivation function",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "A.7.0\tParameters for the input S to the KDF",
                    "description": "",
                    "summary": "",
                    "text_content": "When deriving a KAMF from KSEAF the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x6D\n-\tP0 = IMSI or NAI or GCI or GLI\n-\tL0 = P0 length - number of octets in P0\n-\tP1 = ABBA parameter\n-\tL1 = P1 length - number of octets in P1\nThe input key KEY shall be the 256-bit KSEAF.\nFor P0, when the SUPI type is IMSI, P0 shall be set to IMSI as defined in clause 2.2 of TS 23.003 [19]. For P0, when the SUPI type is network specific identifier, the P0 shall be set to Network Access Identifier (NAI) as defined in clause 28.7.2 of TS 23.003 [19]. When the SUPI type is GLI, P0 shall be set to GLI taking format of NAI as defined in clause 28.16.2 of TS 23.003 [19]. When the SUPI type is GCI, P0 shall be set to GCI taking format of NAI as defined in clause 28.15.2 of TS 23.003 [19]. P0 shall be represented as a character string as specified in B.2.1.2 of TS 33.220 [28], for both SUPI types.\nFor ABBA parameter values please refer to clause A.7.1.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "A.7.1\tABBA parameter values",
                    "description": "",
                    "summary": "",
                    "text_content": "ABBA parameter is provided to the UE from SEAF and shall be used as an input parameter for KAMF derivation. To support flexible set of security features ABBA parameter is defined when security features change. To ensure forward compatibility, the ABBA parameter is a variable length parameter.\nThe SEAF shall set the ABBA parameter to 0x0000. The UE shall use the ABBA parameter provided by the SEAF in the calculation of KAMF.\nThe following values have been defined for this parameter.\nTable A.7.1-1: ABBA parameter definitions\n\n",
                    "tables": [
                        {
                            "description": "The following values have been defined for this parameter.",
                            "table number": 8,
                            "summary": "",
                            "name": ""
                        }
                    ],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "A.8\tAlgorithm key derivation functions",
            "description": "When deriving keys for NAS integrity and NAS encryption algorithms from KAMF in the AMF and UE or ciphering and integrity keys from KgNB/ KSN in the gNB and UE, the following parameters shall be used to form the string S.\n-\tFC = 0x69\n-\tP0 = algorithm type distinguisher\n-\tL0 = length of algorithm type distinguisher (i.e. 0x00 0x01)\n-\tP1 = algorithm identity\n-\tL1 = length of algorithm identity (i.e. 0x00 0x01)\nThe algorithm type distinguisher shall be N-NAS-enc-alg for NAS encryption algorithms and N-NAS-int-alg for NAS integrity protection algorithms. The algorithm type distinguisher shall be N-RRC-enc-alg for RRC encryption algorithms, N-RRC-int-alg for RRC integrity protection algorithms, N-UP-enc-alg for UP encryption algorithms and N-UP-int-alg for UP integrity protection algorithms (see table A.8-1). The values 0x00 and 0x07 to 0xf0 are reserved for future use, and the values 0xf1 to 0xff are reserved for private use.\nTable A.8-1: Algorithm type distinguishers\n\nThe algorithm identity (as specified in clause 5) shall be put in the four least significant bits of the octet. The two least significant bits of the four most significant bits are reserved for future use, and the two most significant bits of the most significant nibble are reserved for private use. The entire four most significant bits shall be set to all zeros.\nFor the derivation of integrity and ciphering keys used between the UE and gNB, the input key shall be the 256-bit KgNB// KSN. For the derivation of integrity and ciphering keys used between the UE and AMF, the input key shall be the 256-bit KAMF.\nFor an algorithm key of length n bits, where n is less or equal to 256, the n least significant bits of the 256 bits of the KDF output shall be used as the algorithm key.\n",
            "summary": "",
            "tables": [
                {
                    "description": "Table A.8-1: Algorithm type distinguishers",
                    "table number": 9,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.9\tKgNB, KWAGF, KTNGF, KTWIF and KN3IWF derivation function",
            "description": "When deriving the keys KgNB, KWAGF, KTNGF, KTWIF and KN3IWF from KAMF and the uplink NAS COUNT in the UE and the AMF the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x6E\n-\tP0 = Uplink NAS COUNT\n-\tL0 = length of uplink NAS COUNT (i.e. 0x00 0x04)\n- \tP1 = Access type distinguisher\n-\tL1 = length of Access type distinguisher  (i.e. 0x00 0x01)\nThe values for the access type distinguisher are defined in table A.9-1. The values 0x00 and 0x03 to 0xf0 are reserved for future use, and the values 0xf1 to 0xff are reserved for private use.\nThe access type distinguisher shall be set to the value for 3GPP (0x01) when deriving KgNB. The access type distinguisher shall be set to the value for non-3GPP (0x02) when deriving KN3IWF, KWAGF, KTWIF or KTNGF..\nTable A.9-1: Access type distinguishers\n\nThe input key KEY shall be the 256-bit KAMF.\nThis function is applied when cryptographically protected 5G radio bearers are established and when a key change on-the-fly is performed.\nAs N5CW devices do not support NAS over non-3GPP access, the Uplink NAS COUNT shall be set to 0 for KTWIF key generation, see clause 7A.2.4. Similarly, the AUN3 devices do not support NAS over non-3GPP access, the Uplink NAS COUNT shall be set to 0 for KWAGF key generation, see clause 7B.7.3.\n",
            "summary": "",
            "tables": [
                {
                    "description": "Table A.9-1: Access type distinguishers",
                    "table number": 10,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.10\tNH derivation function",
            "description": "When deriving a NH from KAMF the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x6F\n-\tP0 = SYNC-input\n-\tL0 = length of SYNC-input (i.e. 0x00 0x20)\nThe SYNC-input parameter shall be the newly derived KgNB for the initial NH derivation, and the previous NH for all subsequent derivations. This results in a NH chain, where the next NH is always fresh and derived from the previous NH.\nThe input key KEY shall be the 256-bit KAMF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.11\tKNG-RAN* derivation function for target gNB",
            "description": "When deriving a KNG-RAN* from current KgNB or from fresh NH and the target physical cell ID in the UE and NG-RAN  for handover purposes and transition from RRC_INACTIVE to RRC_CONNECTED states the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x70\n-\tP0 = PCI (target physical cell id)\n-\tL0 = length of PCI (i.e. 0x00 0x02)\n-\tP1 = ARFCN-DL (the absolute frequency of SSB of the target PCell as specified in clause 13.3 of TS 38.300 [52])\n-\tL1 = length of ARFCN-DL (i.e. 0x00 0x03)\nThe input key KEY shall be the 256-bit NH when the index NCC in the handover increases, otherwise the current 256-bit KgNB(when source is gNB) or KeNB (when source is ng-eNB).\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.12\tKNG-RAN* derivation function for target ng-eNB",
            "description": "When deriving a KNG-RAN* from current KgNB  or from fresh NH and the target physical cell ID in the UE and NG-RAN for handover purposes and transition from RRC_INACTIVE to RRC_CONNECTED states the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x71\n-\tP0 = PCI (target physical cell id)\n-\tL0 = length of PCI (i.e. 0x00 0x02)\n-\tP1 = EARFCN-DL (target physical cell downlink frequency)\n-\tL1 = length of EARFCN-DL (i.e. 0x00 0x03)\nThe input key KEY shall be the 256-bit NH when the index NCC in the handover increases, otherwise the current 256-bit KgNB (when source is gNB) or KeNB (when source is ng-eNB).\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.13\tKAMF to KAMF'  derivation in mobility",
            "description": "Derivation of KAMF'  from KAMF during mobility shall use the following input parameters.\n-\tFC = 0x72\n-\tP0 =  DIRECTION\n-\tL0 = length of DIRECTION (i.e. 0x00 0x01)\n-\tP1 = COUNT,\n-\tL1 = length of COUNT (i.e. 0x00 0x04)\nThe input key KEY shall be KAMF.\nWhen KAMF' is derived in handover, DIRECTION shall be 0x01 and COUNT shall be the downlink NAS COUNT of the 3GPP access.\nWhen KAMF' is derived in idle mode mobility (i.e., mobility registration update), DIRECTION shall be 0x00 and COUNT shall be the uplink NAS COUNT of the 3GPP access used in the Registration Request.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.14\tKAMF to KASME' derivation for interworking",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "A.14.1\tIdle mode mobility",
                    "description": "",
                    "summary": "",
                    "text_content": "This input string is used when there is a need to derive K'ASME from KAMF during mapping of security contexts from 5G to EPS at idle mode mobility. The following input parameters shall be used.\n-\tFC = 0x73\n-\tP0 = NAS Uplink COUNT value\n-\tL0 = length of NAS Uplink COUNT value (i.e. 0x00 0x04)\nThe input key KEY shall be KAMF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "A.14.2\tHandover",
                    "description": "",
                    "summary": "",
                    "text_content": "This input string is used when there is a need to derive KASME' from KAMF during mapping of security contexts from 5G to EPS at handovers. The following input parameters shall be used.\n-\tFC = 0x74\n-\tP0 = NAS Downlink COUNT value\n-\tL0 = length of NAS Downlink COUNT value (i.e. 0x00 0x04)\nThe input key KEY shall be KAMF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "A.15\tKASME to KAMF' derivation for interworking",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "A.15.1\tIdle mode mobility",
                    "description": "",
                    "summary": "",
                    "text_content": "This input string is used when there is a need to derive  KAMF' from KASME during mapping of security contexts from EPS to 5G at idle mode mobility. The following input parameters shall be used.\n-\tFC = 0x75\n-\tP0 = NAS Uplink COUNT value of the TAU message included in the Registration Request message\n-\tL0 = length of NAS Uplink COUNT value of the TAU message included in the Registration Request message (i.e. 0x00 0x04)\nThe input key KEY shall be KASME.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "A.15.2\tHandover",
                            "text_content": "This input string is used when there is a need to derive KAMF' from KASME during mapping of security contexts from EPS to 5G at handovers. The following input parameters shall be used.\n-\tFC = 0x76\n-\tP0 = NH value\n-\tL0 = length of NH value (i.e. 0x00 0x20)\nThe input key KEY shall be KASME.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "A.16\tDerivation of KSN for dual connectivity",
            "description": "This input string is used when the MN and UE derive KSN during dual connectivity. The following input parameters shall be used:\n-\tFC =0x79,\n-\tP0 = Value of the SN Counter as a non-negative integer,\n-\tL0 = length of the SN Counter value (i.e. 0x00 0x02).\nThe input key KEY shall be KeNB when the MN is an ng-eNB and KgNB when the MN is a gNB.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.17\tSoR-MAC-IAUSF generation function",
            "description": "When deriving a SoR-MAC-IAUSF from KAUSF, the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x77,\n-\tP0 = SoR  header,\n-\tL0 = length of SoR header,\n- \tP1 =  CounterSoR,\n-\tL1 = length of  CounterSoR,\n- \tP2 = octets included in SoR transparent container (in clause 9.11.3.51 of TS 24.501 [35]) beyond (and not including) octet 22,\n-\tL2 = length of list data included in P2\nThe input key KEY shall be KAUSF.\nThe selection of parameters included in P2 shall be the same as the selection of input to the Nausf_SoRProtection service operation. If none of these parameters are included in Nausf_SoRProtection service operation, P2 and L2 are not included for SoR-MAC-IAUSF generation.\nThe SOR header is either received from the requester NF (e.g UDM), or constructed by the AUSF, as described in clause 9.11.3.51 of TS 24.501 [35], based on the information received from the requester NF (e.g. UDM), i.e. ACK Indication and List of preferred PLMN/access technology combinations or secured packet (if provided).\nThe SoR-MAC-IAUSF is identified with the 128 least significant bits of the output of the KDF.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.18\tSoR-MAC-IUE/SoR-XMAC-IUE generation function",
            "description": "When deriving a SoR-MAC-IUE/SoR-XMAC-IUE from KAUSF, the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x78,\n-\tP0 = 0x01 (SoR Acknowledgement: Verified the Steering of Roaming Information  successfully),\n-\tL0 = length of SoR Acknowledgement (i.e. 0x00 0x01),\n- \tP1 =  CounterSoR,\n-\tL1 = length of  CounterSoR.\nThe input key KEY shall be KAUSF.\nThe SoR-MAC-IUE/SoR-XMAC-IUE is identified with the 128 least significant bits of the output of the KDF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.19\tUPU-MAC-IAUSF generation function",
            "description": "When deriving a UPU-MAC-IAUSF from KAUSF, the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x7B,\n-\tP0 = UE Parameters Update Data, i.e. UE parameters update list as given in clause 9.11.3.53A of TS 24.501 [35] (starting from octet 23),\n-\tL0 = length of UE Parameters Update Data\n- \tP1 = CounterUPU\n-\tL1 = length of CounterUPU\nThe input key Key shall be KAUSF.\nThe UPU-MAC-IAUSF is identified with the 128 least significant bits of the output of the KDF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.20\tUPU-MAC-IUE/UPU-XMAC-IUE generation function",
            "description": "When deriving a UPU-MAC-IUE/UPU-XMAC-IUE from KAUSF, the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x7C,\n-\tP0 = 0x01 (UPU Acknowledgement: Verified the UE Parameters Update Data successfully)\n-\tL0 = length of UPU Acknowledgement (i.e. 0x00 0x01)\n- \tP1 = CounterUPU\n-\tL1 = length of CounterUPU\nThe input key Key shall be KAUSF.\nThe UPU-MAC-IUE/UPU-XMAC-IUE is identified with the 128 least significant bits of the output of the KDF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.21\tKAMF to KASME_SRVCC derivation for interworking",
            "description": "This input string is used when there is a need to derive KASME_SRVCC from KAMF during SRVCC from 5G to UTRAN CS. The following input parameters shall be used.\n-\tFC = 0x7D\n-\tP0 = NAS Downlink COUNT value\n-\tL0 = length of NAS Downlink COUNT value (i.e. 0x00 0x04)\nThe input key KEY shall be KAMF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.22\tKTIPSec and KTNAP derivation function",
            "description": "When deriving a KTIPSec from KTNGF and when deriving a KTNAP from KTWIF or KTNGF the following parameters shall be used to form the input S to the KDF.\n-\tFC = 0x84\n-\tP0 = Usage type distinguisher\n-\tL0 = length of Usage type distinguisher (i.e. 0x00 0x01)\nThe values for the Usage type distinguisher are defined in table A.22-1. The values 0x00 and 0x03 to 0xf0 are reserved for future use, and the values 0xf1 to 0xff are reserved for private use.\nThe Usage type distinguisher shall be set to the value for IPSec (0x01) when deriving KTIPSec. The Usage type distinguisher shall be set to the value for TNAP (0x02) when deriving KTNAP.\nThe input key KEY shall be the 256-bit KTNGF or KTWIF.\nTable A.22-1: Usage type distinguishers\n",
            "summary": "",
            "tables": [
                {
                    "description": "Table A.22-1: Usage type distinguishers",
                    "table number": 11,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "A.23\tKIAB generation function",
            "description": "This input string is used when the IAB-node and the IAB-donor derive KIAB (PSK) for establishment of secure F1 interface. The following parameters shall be used to form the input S to the KDF:\n-\tFC = 0x83,\n-\tP0 = IAB-donor-CU IP address,\n-\tL0 = length of IAB-donor-CU IP address,\n- \tP1 = IAB-node DU IP address,\n-\tL1 = length of IAB-node DU IP address.\nThe input key KEY shall be KgNB, if the key KgNB is in possession of the IAB-UE functionality in the IAB-node and in the IAB-donor-CU (also when acts as MN for NR-DC scenario), after the IAB-UE setup procedure (Phase-1).\nThe input key KEY shall be S-KgNB, if the key S-KgNB is in possession of the IAB-UE functionality in the IAB-node and in the IAB-donor-CU (acts as a SN for EN-DC scenario), after dual connectivity procedure.\nThe input key KEY shall be KSN, if the key KSN is in possession of the IAB-UE functionality in the IAB-node and in the IAB-donor-CU (acts as a SN for NR-DC scenario), after dual connectivity procedure.\nFor P0, in case of CP-UP separation of IAB-donor-CU,\n- \tP0 shall be set to IAB-donor-CU-CP IP address for deriving KIAB-CU-CP.\n- \tP0 shall be set to IAB-donor-CU-UP IP address for deriving KIAB-CU-UP.\nThe entire output of the KDF (256 bits) is used as the KIAB or KIAB-CU-CP or KIAB-CU-UP..\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "B.1\tIntroduction",
            "description": "The present annex describes an example of the usage of additional EAP methods for primary authentication in private networks using the 5G system as specified in TS 22.261  [7]. It is provided as an example on how the 5G authentication framework for primary authentication can be applied to EAP methods other than  EAP-AKA' The additional EAP methods are only intended for private networks or with IoT devices in isolated deployment scenarios, i.e. roaming is not considered, as specified in TS 22.261 [7].\nWhen the 5G system is deployed in private networks, the SUPI and SUCI should be encoded using the NAI format as specified in TS 23.501 [2]. UE always includes the realm part in the NAI for routing to the correct UDM.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "B.2\tPrimary authentication and key agreement",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "B.2.1\tEAP TLS",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "B.2.1.1\tSecurity procedures",
                            "text_content": "EAP-TLS is a mutual authentication EAP method that can be used by the EAP peer and the EAP server to authenticate each other. It is specified in RFC 5216 [38] and  RFC 9190 [76]. The 3GPP TLS protocol profile related to supported TLS versions and supported TLS cipher suites in 3GPP networks is specified in clause 6.2 of TS 33.210 [3]. The 3GPP profile of TLS certificates is specified in clause 6.1.3a of TS 33.310 [5].\nEAP-TLS supports several TLS versions, and the negotiation of the TLS version is part of EAP-TLS. The main principle of negotiation goes as follows. The EAP server indicates the support for EAP-TLS in the EAP-Request. If the peer chooses EAP-TLS, it responds with an EAP-Response indicating in the ClientHello message which TLS versions the peer supports. The EAP server chooses the TLS version, and indicates the chosen version in the ServerHello message.\nThe EAP-TLS procedure described in the RFC 5216 [38] is applicable to TLS 1.2 defined in RFC 5246 [40]. The EAP-TLS procedure described in the  RFC 9190 [76] is applicable to TLS 1.3 defined in RFC 8446 [77].\nThe procedure below is based on the unified authentication framework from the present document, procedures from TS 23.502 [8] and RFC 5216 [38]. The procedure for EAP-TLS with TLS 1.2 is presented here as an example, and other potential procedures are possible, e.g. if TLS resumption is used.\nThe figure B.2.1.1-1 illustrates the use of EAP-TLS (Extensible Authentication Protocol-Transport Layer Security) authentication procedures over 5G networks for initial authentication. This figure demonstrates the process of establishing a secure connection between a mobile device and a base station, ensuring that only authorized users can access the network. The figure highlights the importance of using EAP-TLS for secure communication, as it provides a reliable and encrypted method of authentication.\nFigure B.2.1.1-1: Using EAP-TLS Authentication Procedures over 5G Networks for initial authentication\n1.\tThe UE sends the Registration Request message to the SEAF, containing SUCI. If the SUPI is in NAI format, only the username part of the NAI is encrypted using the selected protection scheme and included in the SUCI, together with the realm part in the NAI needed for UDM routing.\nPrivacy considerations are described in Clause B.2.2.\n2.\tThe SEAF sends Nausf_UEAuthentication_Authenticate Request message to the AUSF. The SUCI and the serving network name (as described in clause 6.1.1.4) are included in the message.\n3.\tAUSF sends the the Nudm_UEAuthentication_Get Request, containing SUCI and the serving network name, to UDM. The general rules for UDM selection apply.\n4.\tThe SIDF located within the UDM de-conceals the SUCI to SUPI if SUCI is received in the message. The UDM then selects the primary authentication method.\n5. If the UDM chooses to use EAP-TLS, it sends the SUPI and an indicator to choose EAP-TLS to AUSF in the Nudm_UEAuthentication_Get Response.\n6. With the received SUPI and the indicator, the AUSF chooses EAP-TLS as the authentication method. The AUSF sends thea Nausf_UEAuthentication_Authenticate Response message containing EAP-Request/EAP-TLS [TLS start] message to the SEAF.\n7.\tThe SEAF forwards the EAP-Request/EAP-TLS [TLS start] in the Authentication Request message to the UE. This message also includes the ngKSI and the ABBA parameter. In fact, the SEAF shall always include the ngKSI and ABBA parameter in all EAP-Authentication request message. ngKSI will be used by the UE and AMF to identify the partial native security context that is created if the authentication is successful. The SEAF shall set the ABBA parameter as defined in Annex A.7.1. During an EAP authentication, the value of the ngKSI and the ABBA parameter sent by the SEAF to the UE shall not be changed.\n8.\tAfter receiving the EAP-TLS [TLS-start] message from SEAF, the UE replies with an EAP-Response/EAP-TLS [client_hello] to the SEAF in the Authentication Response message. The contents of TLS client_hello are defined in the TLS specification of the TLS version in use.\nNOTE1:\tThe EAP framework supports negotiation of EAP methods. If the UE does not support EAP-TLS, it should follow the rule described in RFC 3748 [27] to negotiate another EAP method. In 5G system, UDM typically knows which EAP method and credentials are supported by the subscriber, and consequently EAP based negotiation may never be used.\n9.\tThe SEAF forwards the EAP-Response/EAP-TLS [client hello] message to AUSF in the Nausf_UEAuthentication_Authenticate Request.\n10.\tThe AUSF replies to the SEAF with EAP-Request/EAP-TLS in the Nausf_UEAuthentication_Authenticate Response, which further includes information elements such as server_hello, server_certificate, server_key_exchange, certificate_request, server_hello_done. These information elements are defined in the RFCs for the corresponding TLS version in use.\n11.\tThe SEAF forwards the EAP-Request/EAP-TLS message with server_hello and other information elements to the UE through Authentication Request message. This message also includes the ngKSI and the ABBA parameter. The SEAF shall set the ABBA parameter as defined in Annex A.7.1.\n12.\tThe UE authenticates the server with the received message from step 11.\nNOTE 2: \tThe UE is required to be pre-configured with a UE certificate and also certificates that can be used to verify server certificates.\n13.\tIf the TLS server authentication is successful, then the UE replies with EAP-Response/EAP-TLS in Authentication Response message, which further contains information element such as client_certificate, client_key_exchange, client_certificate_verify, change_cipher_spec, client_finished etc. Privacy considerations are described in Clause B.2.1.2.\n14.\tThe SEAF forwards the message with EAP-Response/EAP-TLS message with client_certificate and other information elements to the AUSF in the Nausf_UEAuthentication_Authenticate Request.\n15.\tThe AUSF authenticates the UE based on the message received. The AUSF verifies that the client certificate provided by the UE belongs to the subscriber identified by the SUPI. If there is a miss-match in the subscriber identifiers in the SUPI, the AUSF does not accept the client certificate. If the AUSF has successfully verified this message, the AUSF continues to step 16, otherwise it returns an EAP-failure.\nNOTE 2:\tThe AUSF is required to be pre-configured with the root or any intermediary CA certificates that can be used to verify UE certificates. Deployment of certificate revocation lists (CRLs) and online certificate status protocol (OCSP) are described in clause B.2.2.\n16.\tThe AUSF sends EAP-Request/EAP-TLS message with change_cipher_spec and server_finished to the SEAF in the Nausf_UEAuthentication_Authenticate Response.\n17.\tThe SEAF forwards EAP-Request/EAP-TLS message from step 16 to the UE with Authentication Request message. This message also includes the ngKSI and the ABBA parameter. The SEAF shall set the ABBA parameter as defined in Annex A.7.1.\n18.\tThe UE sends an empty EAP-TLS message to the SEAF in Authentication Response message.\n19.\tThe SEAF further forwards the EAP-Response/EAP-TLS message to the AUSF in the Nausf_UEAuthentication_Authenticate Request.\n20.\tThe AUSF uses the most significant 256 bits of EMSK as the KAUSF and then calculates KSEAF from KAUSF as described in Annex A.6. The AUSF sends an EAP-Success message to the SEAF together with the SUPI and the derived anchor key in the Nausf_UEAuthentication_Authenticate Response.\n21.\tThe SEAF forwards the EAP-Success message to the UE and the authentication procedure is finished. This message also includes the ngKSI and the ABBA parameter. The SEAF shall set the ABBA parameter as defined in Annex A.7.1. Then the SEAF derives the KAMF from the KSEAF, the ABBA parameter and the SUPI according to Annex A.7, and provides the ngKSI and the KAMF to the AMF.\nOn receiving the EAP-Success message, the UE derives EMSK and uses the most significant 256 bits of the EMSK as the KAUSF and then calculates KSEAF in the same way as the AUSF. The UE derives the KAMF from the KSEAF, the ABBA parameter and the SUPI according to Annex A.7.\nNOTE 3:\tStep 21 could be NAS Security Mode Command or Authentication Result.\nNOTE 4: \tThe ABBA parameter is included to enable the bidding down protection of security features that may be introduced later.\nNOTE 5: As an implementation option, the UE creates the temporary security context as described in step 21 after receiving the EAP message that allows EMSK to be calculated. The UE turns this temporary security context into a partial security context when it receives the EAP Success. The UE removes the temporary security context if the EAP authentication fails.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "B.2.1.2\tPrivacy considerations",
                            "text_content": "For EAP TLS, if the operator determines to not provide subscription identifier privacy for the UE in TLS layer (e.g., in TLS 1.2 without privacy option), the subscription identifier protection in NAS layer, i.e., in Step 1 of Figure B.2.1-1, becomes ineffective privacy-wise. Therefore, the operator may just choose that UE uses \"null-scheme\" for calculation of SUCI which is sent in NAS layer. However, the operator may anyway use other than null-schemes (e.g., one of ECIES schemes) for simplification of having single scheme for all UEs in NAS layer even though privacy is not enhanced in this particular case.\nThe operator could also determine not to provide subscription identifier privacy for the UE in NAS layer even though the TLS layer inherently provides subscription identifier privacy (e.g., in TLS 1.3). In such case, the operator may just choose that UE uses \"null-scheme\" for calculation of SUCI which is sent in NAS layer.\nFor EAP TLS, if the operator determines to provide subscription identifier privacy for the UE in TLS layer, the the EAP TLS server needs to support privacy either inherently (e.g., in TLS 1.3) or via separate privacy option (e.g., in TLS 1.2). If privacy is an option in TLS layer, then the operator needs to configure UE with the information that privacy-on-TLS layer is enabled. Further, following considerations need to be taken.\nIn Step 1 of Figure B.2.1-1, it is important that calculation of SUCI, which is sent in NAS layer, is done using schemes other than \"null-scheme\". Otherwise, the subscription identifier protection provided by TLS layer becomes ineffective privacy-wise. Nevertheless, the \"null-scheme\" could be used in NAS layer while still preserving subscription identifier privacy, by omitting the username part from NAI as described in RFC 4282 clause 2.3 [y]. It would be analogous to using anonymous identifier in EAP, meaning that only realm part from NAI is included in SUCI which is sent in NAS layer. Thus formed SUCI can still be used to route the authentication request to AUSF.\nIn Step 13 and 14 of Figure B.2.1-1, when TLS 1.2 is used, the UE would need to behave as described in \"Section 2.1.4. Privacy\" of RFC 5216 [38] where instead of sending the client certificate in cleartext over the air, the UE first sends TLS certificate (no cert) and only later sends TLS certificate after a TLS is setup.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "B.2.2\tRevocation of subscriber certificates",
                            "text_content": "Subscriber certificates that are used with EAP-TLS typically include static validity times. A certificate revocation list (CRL) as specified in RFC 5280 [48] and online certificate status protocol (OCSP) as specified in RFC 6960 [49] are means for the issuing certificate authority (CA) to revoke the certificates before their scheduled expiration date. In 5G security architecture, the UDM/ARPF is responsible for such subscriber status information. EAP-TLS peers and servers may also support Certificate Status Requests (OCSP stapling) as specified in RFC6066 [50] which allows peers to request the server's copy of the current status of certificates.\nThe deployment of CRLs is demonstrated in figure B.2.2-1. When the UDM/ARPF maintains the CRLs, the lists may be periodically updated to AUSFs, and stored locally in AUSF.\nThe figure depicts a communication protocol called AUSF (Automatic User Switching Function) in a network. It shows the request for a Content-Related Link (CRL) from the User Data Management (UDM)/Application Resource Plane (ARPF) to the Application Resource Plane (ARP). The figure illustrates the flow of data between the UDM and ARP, highlighting the importance of this protocol in ensuring efficient communication in a network.\nFigure B.2.2-1: AUSF requests CRL from UDM/ARPF\nThe deployment of OSCP is demonstrated in figure B.2.2-2. When the UDM/ARPF supports OCSP, the AUSF may check the certificate status online.\nThe figure depicts a network interface card (NIC) in a network-based system, specifically a Unified Traffic Management (UTM) system. The figure shows a request for the status of a TLS certificate from the Unified Security Framework (USF) to the Application Data Repository (ADR) and the Application Resource Protection (ARPF). The request is sent using the Secure Sockets Layer (SSL) protocol, which is used to establish a secure connection between the client and the server. The figure also includes a diagram of the network interface card (NIC) and its connections to the ADR and ARPF.\nFigure B.2.2-2: AUSF requests the status of TLS certificate from UDM/ARPF\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "B.3\tKey derivation",
            "description": "When EAP methods are used with 5G system, the serving network name is always bound to the anchor key derivation as required in clause 6.1.1.3.\nWhen SEAF acts as a pass-through EAP authenticator, it always includes the serving network name (constructed as specified in clause 6.1.1.4) into the authentication request to the AUSFduring the initial authentication procedure as specified in clause 6.1.2. The AUSF verifies that the SEAF is authorized to use the serving network name, before it uses the serving network name to calculate the KSEAF from the KAUSF as described in Annex A.6. The AUSF always uses the most significant 256 bits of EMSK as the KAUSF.\nWhen EAP-TLS as specified in RFC 5216 [38] and  RFC 9190 [76] is used for authentication, key materials are derived during authentication and key agreement procedure, which are further split into MSK and EMSK. Both UE and AUSF share a 512 bits EMSK key and use the most significant 256 bits of the EMSK as the KAUSF. The KSEAF is derived based on the rules specified in Annex A.6.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "C.1\tIntroduction",
            "description": "The present Annex specifies the protection schemes for concealing the subscription permanent identifier. Each protection scheme is identified  by a Protection Scheme Identifier. The Protection Scheme Identifiers are as follows:\nnull-scheme         0x0;\nProfile <A>         0x1;\nProfile <B>         0x2.\nThe values 0x3 - 0xB are reserved for future standardized protection schemes. The values 0xC - 0xF are reserved for proprietary protection schemes specified by the home operator.\nCare should be taken when using unique schemes for small groups of users, as this may impact the effectiveness of the privacy scheme for these users.\nThe size of the Scheme Output of the protection schemes is as follows:\nnull-scheme         size of input, i.e., size of username used in case of NAI format or MSIN in case of IMSI;\nProfile <A>         total of 256-bit public key, 64-bit MAC, plus size of input;\nProfile <B>         total of 264-bit public key, 64-bit MAC, plus size of input.\nThe maximum size of a Scheme Output for proprietary protection schemes shall be total of 3000 octets plus size of input .\nNOTE 1: The maximum size of scheme-output was chosen to allow the introduction of quantum-resistant protection schemes.\nThe UE shall not send, and the network may reject SUCIs larger than the maximum size of scheme-output.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "C.2\tNull-scheme",
            "description": "The null-scheme shall be implemented such that it returns the same output as the input, which applies to both encryption and decryption.\nWhen using the null-scheme, the SUCI does not conceal the SUPI and therefore the newly generated SUCIs do not need to be fresh.\nNOTE 1:\tThe reason for mentioning the non-freshness is that, normally, in order to attain unlinkability (i.e., to make it infeasible for over-the-air attacker to link SUCIs together), it is necessary for newly generated SUCIs to be fresh. But, in case of the null-scheme, the SUCI does not conceal the SUPI. So unlinkability is irrelevant.\nNOTE 2:\tThe null-scheme provides no privacy protection.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "C.3\tElliptic Curve Integrated Encryption Scheme (ECIES)",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "C.3.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The use of ECIES for concealment of the SUPI shall adhere to the SECG specifications [29] and [30]. Processing on UE side and home network side are described in high level in clauses C.3.2 and C.3.3.\nWhen the SUPI is of type IMSI, the subscription identifier part of the IMSI (i.e., MSIN) that is used to construct the scheme-input shall be coded as hexadecimal digits using packed BCD coding where the order of digits within an octet is same as the order of MSIN digits specified in Figure 9.11.3.4.3a of TS 24.501 [35]. If the MSIN is composed of an odd number of digits, then the bits 5 to 8 of final octet shall be coded as \"1111\".\nWhen the SUPI is of type network specific identifier, the subscription identifier part of the SUPI that is used to construct the scheme-input shall follow the encoding rules specified in Annex B.2.1.2 of TS 33.220 [28].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "C.3.2\tProcessing on UE side",
                    "description": "",
                    "summary": "",
                    "text_content": "The ECIES scheme shall be implemented such that for computing a fresh SUCI, the UE shall use the provisioned public key of the home network and freshly generated ECC (elliptic curve cryptography) ephemeral public/private key pair according to the ECIES parameters provisioned by home network. The processing on UE side shall be done according to the encryption operation defined in [29]. with the following changes to Section 3.8 and step 5 and 6 of Section 5.1.3.\n-\tgenerate keying data K of length enckeylen + icblen + mackeylen.\n-\tParse the leftmost enckeylen octets of K as an encryption key EK, the middle icblen octets of K as an ICB, and\nthe rightmost mackeylen octets of K as a MAC key MK.\nThe final output shall be the concatenation of the ECC ephemeral public key, the ciphertext value, the MAC tag value, and any other parameters, if applicable.\nNOTE:\tThe reason for mentioning \"any other parameter, if applicable\" in the final output is to allow cases, e.g. to enable the sender to send additional sign indication when point compression is used.\nThe Figure C.3.2-1 illustrates the UE's steps.\nThe figure C.3.2-1 illustrates the encryption process at the user equipment (UE) in a 5G network. It shows the encryption key distribution among the network nodes, including the base station (gNB), user equipment (UE), and the network elements (e.g., scatterers). The encryption key is distributed using a key distribution protocol (KDP) to ensure secure communication.\nFigure C.3.2-1: Encryption based on ECIES at UE\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "C.3.3\tProcessing on home network side",
                    "description": "",
                    "summary": "",
                    "text_content": "The ECIES scheme shall be implemented such that for deconcealing a SUCI, the home network shall use the received ECC ephemeral public key of the UE and the private key of the home network. The processing on home network side shall be done according to the decryption operation defined in [29]. with the following changes to Section 3.8 and step 6 and 7 of Section 5.1.4.\n-\tgenerate keying data K of length enckeylen + icblen + mackeylen.\n-\tParse the leftmost enckeylen octets of K as an encryption key EK, the middle icblen octets of K as an ICB, and\nthe rightmost mackeylen octets of K as a MAC key MK.\nNOTE:\tUnlike the UE, the home network does not need to perform a fresh ephemeral key pair generation for each decryption. How often the home network generates new public/private key pair and how the public key is provisioned to the UE are out of the scope of this clause.\nThe Figure C.3.3-1 illustrates the home network's steps.\nThe figure C.3.3-1 illustrates the encryption process at a home network, demonstrating the use of ECIES (Encapsulated Cryptographic Engine) for secure communication. The figure shows the encryption key, the encryption process, and the decryption process, highlighting the importance of secure communication in home networks.\nFigure C.3.3-1: Decryption based on ECIES at home network\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "C.3.4\tECIES profiles",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "C.3.4.0\tGeneral",
                            "text_content": "Unless otherwise stated, the ECIES profiles follow the terminology and processing specified in SECG version 2 [29] and [30]. The profiles shall use \"named curves\" over prime fields.\nFor generating successive counter blocks from the initial counter block (ICB) in CTR mode, the profiles shall use the standard incrementing function in section B.1 of NIST Special Publication 800-38A [16] with m = 32 bits. The ICB corresponds to T1 in section 6.5 of [16].\nThe value of the MAC tag in ECIES, shall be the L most significant octets of the output generated by the HMAC function, where L equals to the maclen.\nProfile A shall use its own standardized processing for key generation (section 6 of RFC 7748 [46]) and shared secret calculation (section 5 of RFC 7748 [46]). The Diffie-Hellman primitive X25519 (section 5 of RFC 7748 [46]) takes two random octet strings as input, decodes them as scalar and coordinate, performs multiplication, and encodes the result as an octet string. The shared secret output octet string from X25519 shall be used as the input Z in the ECIES KDF (section 3.6.1 of [29]). As the point compression is not applied for profile A, the prefix rule for compression type defined in [29] section 5.1.3 shall not be used in profile A, i.e., there shall be no prefix for the ephemeral public key of Profile A.\nProfile B shall use point compression to save overhead and shall use the Elliptic Curve Cofactor Diffie-Hellman Primitive (section 3.3.2 of [29]) to enable future addition of profiles with cofactor h ≠ 1. For curves with cofactor h = 1 the two primitives (section 3.3.1 and 3.3.2 of [29]) are equal.\nThe profiles shall not use backwards compatibility mode (therefore are not compatible with version 1 of SECG).\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "C.3.4.1\tProfile A",
                            "text_content": "The ME and SIDF shall implement this profile. The ECIES parameters for this profile shall be the following:\n-\tEC domain parameters\t\t\t\t\t\t\t: Curve25519 [46]\n-\tEC Diffie-Hellman primitive\t\t\t\t\t: X25519 [46]\n-\tpoint compression\t\t\t\t\t\t\t\t: N/A\n-\tKDF\t\t\t\t\t\t\t\t\t\t\t\t: ANSI-X9.63-KDF [29]\n-\tHash\t\t\t\t\t\t\t\t\t\t\t\t: SHA-256\n-\tSharedInfo1\t\t\t\t\t\t\t\t\t\t:  (the ephemeral public key octet string – see [29] section 5.1.3)\n-\tMAC\t\t\t\t\t\t\t\t\t\t\t\t: HMAC–SHA-256\n-\tmackeylen\t\t\t\t\t\t\t\t\t\t: 32 octets (256 bits)\n-\tmaclen\t\t\t\t\t\t\t\t\t\t\t: 8 octets (64 bits)\n-\tSharedInfo2\t\t\t\t\t\t\t\t\t\t: the empty string\n-\tENC\t\t\t\t\t\t\t\t\t\t\t\t: AES–128 in CTR mode\n-\tenckeylen\t\t\t\t\t\t\t\t\t\t\t: 16 octets (128 bits)\n-\ticblen\t\t\t\t\t\t\t\t\t\t\t\t: 16 octets (128 bits)\n-\tbackwards compatibility mode\t\t\t\t\t: false\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "C.3.4.2\tProfile B",
                            "text_content": "The ME and SIDF shall implement this profile. The ECIES parameters for this profile shall be the following:\n-\tEC domain parameters\t\t\t\t\t\t\t: secp256r1 [30]\n-\tEC Diffie-Hellman primitive\t\t\t\t\t: Elliptic Curve Cofactor Diffie-Hellman Primitive [29]\n-\tpoint compression\t\t\t\t\t\t\t\t: true\n-\tKDF\t\t\t\t\t\t\t\t\t\t\t\t: ANSI-X9.63-KDF [29]\n-\tHash\t\t\t\t\t\t\t\t\t\t\t\t: SHA-256\n-\tSharedInfo1\t\t\t\t\t\t\t\t\t\t:  (the ephemeral public key octet string – see [29] section 5.1.3)\n-\tMAC\t\t\t\t\t\t\t\t\t\t\t\t: HMAC–SHA-256\n-\tmackeylen\t\t\t\t\t\t\t\t\t\t: 32 octets (256 bits)\n-\tmaclen\t\t\t\t\t\t\t\t\t\t\t: 8 octets (64 bits)\n-\tSharedInfo2\t\t\t\t\t\t\t\t\t\t: the empty string\n-\tENC\t\t\t\t\t\t\t\t\t\t\t\t: AES–128 in CTR mode\n-\tenckeylen\t\t\t\t\t\t\t\t\t\t\t: 16 octets (128 bits)\n-\ticblen\t\t\t\t\t\t\t\t\t\t\t\t: 16 octets (128 bits)\n-\tbackwards compatibility mode\t\t\t\t\t: false\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "C.4\tImplementers’ test data",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "C.4.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The test data sets presented here are for encryption based on ECIES at UE with protection schemes defined in this clause.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "C.4.2\tNull-scheme",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "C.4.2.1\tIMSI-based SUPI",
                            "text_content": "The following test data set corresponds to ECIES-based encryption in the UE for IMSI-based SUPI and null-scheme.\nIMSI consists of MCC|MNC: '274012' and MSIN: '001002086'\n\nECIES Scheme Input\nScheme Input: '00012080F6'\n\nECIES Scheme Output\nScheme Output: '00012080F6'\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "C.4.2.2\tNetwork specific identifier-based SUPI",
                            "text_content": "The following test data set corresponds to ECIES-based encryption in the UE for network specific identifier-based SUPI and null-scheme.\nSUPI is: verylongusername1@3gpp.com\n\nECIES Scheme Input\nScheme Input: '766572796C6F6E67757365726E616D6531'\n\nECIES Scheme Output\nScheme Output: useridverylongusername1\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "C.4.3\tECIES Profile A",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "C.4.3.1\tIMSI-based SUPI",
                            "text_content": "The following test data set corresponds to SUCI computation in the UE for IMSI-based SUPI and ECIES Profile A.\nIMSI consists of MCC|MNC: '274012' and MSIN: '001002086'\n\nECIES test data\nThe ECIES Scheme Output is computed in the UE as defined in Figure C.3.2-1 of clause C.3.2 with the following data\nHome Network Private Key:\n'c53c22208b61860b06c62e5406a7b330c2b577aa5558981510d128247d38bd1d'\n\nHome Network Public Key:\n'5a8d38864820197c3394b92613b20b91633cbd897119273bf8e4a6f4eec0a650'\n\nEph. Private Key:\n'c80949f13ebe61af4ebdbd293ea4f942696b9e815d7e8f0096bbf6ed7de62256'\n\nEph. Public Key:\n'b2e92f836055a255837debf850b528997ce0201cb82adfe4be1f587d07d8457d'\n\nEph. Shared Key:\n'028ddf890ec83cdf163947ce45f6ec1a0e3070ea5fe57e2b1f05139f3e82422a'\n\nEph. Enc. Key:\n'2ba342cabd2b3b1e5e4e890da11b65f6'\n\nICB:\n'e2622cb0cdd08204e721c8ea9b95a7c6'\n\nPlaintext block:\n'00012080f6'\n\nCipher-text vaue:\n'cb02352410'\n\nEph. mac key:\n'd9846966fb7cf5fcf11266c5957dea60b83fff2b7c940690a4bfe57b1eb52bd2'\n\nMAC-tag value:\n'cddd9e730ef3fa87'\n\nScheme Output:\n'b2e92f836055a255837debf850b528997ce0201cb82adfe4be1f587d07d8457dcb02352410cddd9e730ef3fa87’\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "C.4.3.2\tNetwork specific identifier-based SUPI",
                            "text_content": "The following test data set corresponds to SUCI computation in the UE for network specific identifier-based SUPI and ECIES Profile A.\nSUPI is:\n\nECIES test data\nThe ECIES Scheme Output is computed in the UE as defined in Figure C.3.2-1 of clause C.3.2 with the following data\nHome Network Private Key:\n'C53C22208B61860B06C62E5406A7B330C2B577AA5558981510D128247D38BD1D'\n\nHome Network Public Key:\n'5A8D38864820197C3394B92613B20B91633CBD897119273BF8e4A6f4EEC0A650'\n\nEph. Private Key:\n'BE9EFF3E9F22A4B42A3D236E7A6C500B3F2E7E0C7449988BA800D664BF4FCD97'\n\nEph. Public Key:\n'977D8B2FDAA7B64AA700D04227D5B440630EA4EC50F9082273A26BB678C92222'\n\nEph. Shared Key:\n'511C1DF473BB88317F923501F8BA944FD3B667D25699DCB552DBCEF60BBDC56D'\n\nEph. Enc. Key:\n'FE77B87D87F40428EDD71BCA69D79059'\n\nPlaintext block:\n'766572796C6F6E67757365726E616D6531'\n\nCipher-text vaue:\n'8E358A1582ADB15322C10E515141D2039A'\n\nEph. mac key:\n'D87B69F4FE8CD6B211264EA5E69F682F151A82252684CDB15A047E6EF0595028'\n\nMAC-tag value:\n'12E1D7783A97F1AC'\n\nScheme Output:\necckey977D8B2FDAA7B64AA700D04227D5B440630EA4EC50F9082273A26BB678C92222.cip8E358A1582ADB15322C10E515141D2039A.mac12E1D7783A97F1AC\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "C.4.4\tECIES Profile B",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "C.4.4.1\tIMSI-based SUPI",
                            "text_content": "The following test data set corresponds to ECIES-based encryption in the UE for IMSI-based SUPI and ECIES Profile B.\nIMSI consists of MCC|MNC: '274012' and MSIN: '001002086'\n\nECIES test data\nThe Scheme Output is computed in the UE as defined in Figure C.3.2-1 of clause C.3.2 with following data:\nHome Network Public Key:\nuncompressed: '0472DA71976234CE833A6907425867B82E074D44EF907DFB4B3E21C1C2256EBCD15A7DED52FCBB097A4ED250E036C7B9C8C7004C4EEDC4F068CD7BF8D3F900E3B4',\nif compressed: '0272DA71976234CE833A6907425867B82E074D44EF907DFB4B3E21C1C2256EBCD1'\n\nHome Network Private Key (Not available in the UE, provided here only for test purposes): 'F1AB1074477EBCC7F554EA1C5FC368B1616730155E0041AC447D6301975FECDA'\n\nEph. Public Key:\nIf compressed: '039AAB8376597021E855679A9778EA0B67396E68C66DF32C0F41E9ACCA2DA9B9D1'\nuncompressed: '049AAB8376597021E855679A9778EA0B67396E68C66DF32C0F41E9ACCA2DA9B9D1D1F44EA1C87AA7478B954537BDE79951E748A43294A4F4CF86EAFF1789C9C81F'\nIf point compression applied (scheme output for Profile B always applies point compression for Eph. public key as specified in clause C.3.4.2 above)\nEph. Private Key: '99798858A1DC6A2C68637149A4B1DBFD1FDFF5ADDD62A2142F06699ED7602529'\n\nEph. Shared Key: '6C7E6518980025B982FBB2FF746E3C2E85A196D252099A7AD23EA7B4C0959CAE'\n\nEph. Enc. Key: '\t8A65C3AED80295C12BD55087E965702A'\n\nICB: 'EF285B4061C3BAEE858AB6EC68487DAE'\n\nScheme-input corresponding to the plaintext-block: '00012080F6'\n\nCipher-text vaue:\t'46A33FC271'\n\nEph. mac key: : 'A5EBAC0BC48D9CF7AE5CE39CD840AC6C761AEC04078FAB954D634F923E901C64'\n\nMAC-tag value:\t'6AC7DAE96AA30A4D'\n\nScheme Output:\n'039AAB8376597021E855679A9778EA0B67396E68C66DF32C0F41E9ACCA2DA9B9D146A33FC2716AC7DAE96AA30A4D'\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "C.4.4.2\tNetwork specific identifier-based SUPI",
                            "text_content": "The following test data set corresponds to ECIES-based encryption in the UE for network specific identifier-based SUPI and ECIES Profile B.\nSUPI is: verylongusername1@3gpp.com\n\nECIES test data\nThe Scheme Output is computed in the UE as defined in Figure C.3.2-1 of clause C.3.2 with following data:\nHome Network Public Key:\n\nuncompressed: '0472DA71976234CE833A6907425867B82E074D44EF907DFB4B3E21C1C2256EBCD15A7DED52FCBB097A4ED250E036C7B9C8C7004C4EEDC4F068CD7BF8D3F900E3B4',\nif compressed: '0272DA71976234CE833A6907425867B82E074D44EF907DFB4B3E21C1C2256EBCD1'\n\nHome Network Private Key (Not available in the UE, provided here only for test purposes): 'F1AB1074477EBCC7F554EA1C5FC368B1616730155E0041AC447D6301975FECDA'\n\nEph. Public Key(scheme output for Profile B always applies point compression for Eph. public key as specified in clause C.3.4.2 above):\ncompressed: '03759BB22C563D9F4A6B3C1419E543FC2F39D6823F02A9D71162B39399218B244B'\n\nEph. Private Key: '90A5898BD29FFA3F261E00E980067C70A2B1B992A21F5B4FEF6D4DF69FE804AD'\n\nEph. Shared Key: 'BC3529ED79541CF8C007CE9806330F4A5FF15064D7CF4B16943EF8F007597872'\n\nEph. Enc. Key: '84F9A78995D39E6968047547ECC12C4F'\n\nScheme-input corresponding to the plaintext-block: '766572796C6F6E67757365726E616D6531'\n\nCipher-text vaue:\t'BE22D8B9F856A52ED381CD7EAF4CF2D525'\n\nEph. mac key: '39D5517E965F8E1252B61345ED45226C5F1A8C69F03D6C91437591F0B8E48FA0'\n\nMAC-tag value: '3CDDC61A0A7882EB'\n\nScheme Output:\necckey03759BB22C563D9F4A6B3C1419E543FC2F39D6823F02A9D71162B39399218B244B.cipBE22D8B9F856A52ED381CD7EAF4CF2D525.mac3CDDC61A0A7882EB\n\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "D.1\tNull ciphering and integrity protection algorithms",
            "description": "The NEA0 algorithm shall be implemented such that it generates a KEYSTREAM of all zeroes (see sub-clause D.2.1). The length of the KEYSTREAM generated shall be equal to the LENGTH input parameter. The generated KEYSTREAM requires no other input parameters but the LENGTH. Apart from this, all processing performed in association with ciphering shall be exactly the same as with any of the ciphering algorithms specified in this Annex.\nThe NIA0 algorithm shall be implemented in such way that it shall generate a 32 bit MAC-I/NAS-MAC and XMAC-I/XNAS-MAC of all zeroes (see sub-clause D.3.1). Replay protection shall not be activated when NIA0 is activated. All processing performed in association with integrity (except for replay protection) shall be exactly the same as with any of the integrity algorithms specified in this annex except that the receiver does not check the received MAC.\nNOTE 1: \tThe reason for mentioning the replay protection here is that replay protection is associated with integrity.\nThe NIA0 shall not be used for signalling radio bearers (SRBs) except for unauthenticated emergency sessions for unauthenticated UEs in LSM.\nThe NIA0 shall not be used for data radio bearers (DRBs).\nNOTE 2: \tA UE with a 2G SIM is considered to be in LSM in NR.\nNOTE 3: \tNEA0 and NIA0 provide no security.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "D.2\tCiphering algorithms",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "D.2.1\t128-bit Ciphering algorithms",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "D.2.1.1\tInputs and outputs",
                            "text_content": "The input parameters to the ciphering algorithm are a 128-bit cipher key named KEY, a 32-bit COUNT, a 5-bit bearer identity BEARER, the 1-bit direction of the transmission i.e. DIRECTION, and the length of the keystream required i.e. LENGTH. The DIRECTION bit shall be 0 for uplink and 1 for downlink.\nFigure D.2.1.1-1 illustrates the use of the ciphering algorithm NEA to encrypt plaintext by applying a keystream using a bit per bit binary addition of the plaintext and the keystream. The plaintext may be recovered by generating the same keystream using the same input parameters and applying a bit per bit binary addition with the ciphertext.\nThe figure depicts a cryptographic ciphering process, showing the encryption of data using a specific cipher. The cipher is represented by a series of dots and dashes, with each dot representing a bit and the dashes indicating the encryption process. The figure illustrates the process of encoding data into a cipher, which is then decrypted using a decryption key. The figure is used to demonstrate the complexity and security of cryptographic systems.\nFigure D.2.1.1-1: Ciphering of data\nBased on the input parameters the algorithm generates the output keystream block KEYSTREAM which is used to encrypt the input plaintext block PLAINTEXT to produce the output ciphertext block CIPHERTEXT.\nThe input parameter LENGTH shall affect only the length of the KEYSTREAM BLOCK, not the actual bits in it.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.2.1.2\t128-NEA1",
                            "text_content": "128-NEA1 is identical to 128-EEA1 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.2.1.3\t128-NEA2",
                            "text_content": "128-NEA2 is identical to 128-EEA2 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.2.1.4\t128-NEA3",
                            "text_content": "128-NEA3 is identical to 128-EEA3 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "D.3\tIntegrity algorithms",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "D.3.1\t128-Bit integrity algorithms",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "D.3.1.1\tInputs and outputs",
                            "text_content": "The input parameters to the integrity algorithm are a 128-bit integrity key named KEY, a 32-bit COUNT, a 5-bit bearer identity called BEARER, the 1-bit direction of the transmission i.e. DIRECTION, and the message itself i.e. MESSAGE. The DIRECTION bit shall be 0 for uplink and 1 for downlink. The bit length of the MESSAGE is LENGTH.\nFigure D.3.1.1-1 illustrates the use of the integrity algorithm NIA to authenticate the integrity of messages.\nThe figure depicts the derivation of MAC-I/NAS-MAC (or XMAC-I/XNAS-MAC) in a 5G network. It illustrates the process of calculating the minimum access delay (MAC-I) and minimum access rate (NAS-MAC) for each user equipment (UE) in the network. The figure includes key components such as the base station (gNB), user equipment (UE), and scatterers. The diagram highlights the use of beamforming techniques to improve signal quality and reduce interference.\nFigure D.3.1.1-1: Derivation of MAC-I/NAS-MAC (or XMAC-I/XNAS-MAC)\nBased on these input parameters the sender computes a 32-bit message authentication code (MAC-I/NAS-MAC) using the integrity algorithm NIA. The message authentication code is then appended to the message when sent. For integrity protection algorithms, the receiver computes the expected message authentication code (XMAC-I/XNAS-MAC) on the message received in the same way as the sender computed its message authentication code on the message sent and verifies the data integrity of the message by comparing it to the received message authentication code, i.e. MAC-I/NAS-MAC.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.3.1.2\t128-NIA1",
                            "text_content": "128-NIA1 is identical to 128-EIA1 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.3.1.3\t128-NIA2",
                            "text_content": "128-NIA2 is identical to 128-EIA2 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "D.3.1.4\t128-NIA3",
                            "text_content": "128-NIA3 is identical to 128-EIA3 as specified in Annex B of TS 33.401 [10].\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "D.4\tTest Data for the security algorithms",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "D.4.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "Annex D.4 contains references to the test data for each of the specified algorithms.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.2\t128-NEA1",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NEA1 is the test data for UEA2 in TS 35.217 [36] can be reused directly as there is an exact, one-to-one mapping between UEA2 inputs and 128-NEA1 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.3\t128-NIA1",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NIA1 is the test data for 128-EIA1 in clause C.4 of TS 33.401 [10] can be reused directly as there is an exact, one-to-one mapping between 128-EIA1 inputs and 128-NIA1 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.4\t128-NEA2",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NEA2 is the test data for 128-EEA2 in clause C.1 of TS 33.401 [10] can be reused directly as there is an exact, one-to-one mapping between 128-EEA2 inputs and 128-NEA2 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.5\t128-NIA2",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NIA2 is the test data for 128-EIA2 in clause C.2 of TS 33.401 [10] can be reused directly as there is an exact, one-to-one mapping between 128-EIA2 inputs and 128-NIA2 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.6\t128-NEA3",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NEA3 is the test data for 128-EEA3 in TS 35.223 [37] can be reused directly as there is an exact, one-to-one mapping between 128-EEA3 inputs and 128-NEA3 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "D.4.7\t128-NIA3",
                    "description": "",
                    "summary": "",
                    "text_content": "For 128-NIA3 is the test data for 128-EIA3 in TS 35.223 [37] can be reused directly as there is an exact, one-to-one mapping between 128-EIA3 inputs and 128-NIA3 inputs.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "E.1\tIntroduction",
            "description": "The UE in RRC_CONNECTED mode sends measurement reports to the network in accordance with the measurement configuration provided by the network. These measurement reports have security values in being useful for detection of false base stations or SUPI/5G-GUTI catchers. The network, in an implementation specific way, could choose UEs or tracking areas or duration for which the measurement reports are to be analysed for detection of false base station. The present Annex gives examples of how measurement reports from UEs could be used for detection of false base station, and some actions thereafter.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "E.2\tExamples of using measurement reports",
            "description": "The received-signal strength and location information in measurement reports can be used to detect a false base station which attract the UEs by transmitting signal with higher power. They can also be used to detect a false base station which replays the genuine MIB/SIB without modification.\nIn order to detect a false base station which replays modified version of broadcast information to prevent victim UEs from switching back and forth between itself and genuine base stations (e.g. modifying neighbouring cells, cell reselection criteria, registration timers, etc. to avoid the so called ping-pong effect), information on broadcast information can be used to detect inconsistency from the deployment information.\nFurther, a false base station which uses inconsistent cell identifier or operates in inconsistent frequency than the deployment of the genuine base stations, can be detected respectively by using the cell identifier or the frequency information in the measurement reports.\nMeasurement reports collected from multiple UEs can be used to filter out incorrect reports sent by a potential rogue UE.\nUpon detection of the false base station, the operator can take further actions, e.g. informing legal authorities or contacting the victim UE.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "F.1\tIntroduction",
            "description": "The present annex describes the 3GPP 5G profile for EAP-AKA' described in RFC 5448 [12], and RFC 4187 [21].\nNOTE: \tRFC 5448 [12] was specified for the needs of LTE and it does not take into account nor refer to 5G specifications. EAP-AKA’ identity handling, when it comes to 5G, is specified in the present Annex F. RFC 5448 [12] has been updated in RFC 9048  [67] to align with the 5G specifications and especially with Annex F. Otherwise RFC 9048  [67] is technically backwards compatible with RFC 5448 [12] . The present document uses RFC 5448 [12] as the normative reference and in case of technical discrepancy, RFC 5448 [12] and the present document take precedence over RFC 9048  [67].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "F.2\tSubscriber privacy",
            "description": "EAP-AKA' includes optional support for identity privacy mechanism that protects the privacy against passive eavesdropping. The mechanism is described in RFC 4187 [21] clause 4.1.1.2, and it uses pseudonyms that are delivered from the EAP server to the peer as part of an EAP-AKA exchange. The privacy mechanism described in [21] corresponds to the privacy provided by 5G-GUTI, however, assignment of 5G-GUTI is done outside the EAP framework in 5GS.\nTS 33.501 assumes that the SUCI is sent outside the EAP messages, however, the peer may still receive EAP-Request/Identity or EAP-Request/AKA-Identity messages. Table F.2-1 specifies how the 5G UE shall behave when receiving such requests.\nTable F.2-1: 5G UE behaviour when receiving EAP identity requests\n\n1) \tRFC 3748 [27] allows the peer to respond with abbreviated Identity Response where the peer-name portion of the NAI has been omitted. The 5G UE responds with SUCI in the same format as sent in the Registration Request, where the peer name has been encrypted.\n2) \tRFC 4187 [21] allows the peer to respond with a pseudonym (cf. 5G-GUTI) or the permanent identity (i.e. SUPI). The 5G UE follows the \"conservative\" policy that has been described in RFC 4187 [21] clause 4.1.6 (Attacks against Identity Privacy) for the pseudonym based privacy, i.e. the peer shall not reveal its permanent identity. Instead, the peer shall send the EAP-Response/AKA-Client-Error packet with the error code \"unable to process packet\", and the authentication exchange terminates. The peer assumes that the EAP-Request/AKA-Identity originates from an attacker that impersonates the network, and for this reason refuses to send the cleartext SUPI.\n3) \tRFC 4187 [21] allows the peer to respond with a pseudonym (cf. 5G-GUTI) or the permanent identity (i.e. SUPI). The 5G UE responds with SUCI.\n4) \tRFC 4187 [21] allows the peer to respond with a fast re-authentication identity, pseudonym (cf. 5G-GUTI) or the permanent identity (i.e. SUPI). If the 5G UE supports fast re-authentication, it responds with the fast re-authentication identity, and if the 5G UE does not support fast re-authentication, it responds with SUCI.\n",
            "summary": "",
            "tables": [
                {
                    "description": "Table F.2-1: 5G UE behaviour when receiving EAP identity requests",
                    "table number": 12,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "F.3\tSubscriber identity and key derivation",
            "description": "EAP-AKA' uses the subscriber identity (Identity) as an input to the key derivation when the key derivation function has value 1 ( i.e. MK = PRF'(IK'|CK',\"EAP-AKA'\"|Identity)). RFC 4187 [21] clause 7 describes that the Identity is taken from the EAP-Response/Identity or EAP-Response/AKA-Identity AT_IDENTITY attribute sent by the peer. This principle is not applied to the 5GS.\nIf the AT_KDF_INPUT parameter contains the prefix \"5G:\", the AT_KDF parameter has the value 1 and the authentication is not related to fast re-authentication, then the UE shall set as the Identity for key derivation. When the SUPI Type is IMSI, the Identity shall be set to IMSI as defined in clause 2.2 of TS 23.003 [19]. When the SUPI type is network specific identifier, the Identity shall be set to Network Access Identifier (NAI) as defined in clause 28.7.2 of TS 23.003 [19]. When the SUPI type is GLI, the Identity shall be set to GLI taking format of NAI as defined in clause 28.15.2 of TS 23.003 [19]. When the SUPI type is GCI, the Identity shall be set to GLI taking format of NAI as defined in clause 28.16.2 of TS 23.003 [19]. This principle applies to all full EAP-AKA' authentications, even if the UE sent SUCI in NAS protocol or if the UE sent SUCI in the respose to the EAP identity requests as described in Table F.2-1 or if no identity was sent because the network performed re-authentication. The only exception is fast re-authentication when the UE follows the key derivation as described in RFC 5448 [12] for fast re-authentication.\nNOTE 1:\tThe fast re-authentication is not supported in 5GS.\nNOTE 2: \tThe prefix \"5G:\" is part of serving network name as specified in clause 6.1.1.4.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "F.4\tVoid",
            "description": "\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "G.1\tIntroduction",
            "description": "The SEPP as described in clause 4.2.1 is the entity that sits at the perimeter of the network and performs application layer security on the HTTP message before it is sent externally over the roaming interface.\nThe application layer traffic comprises all the IEs in the HTTP message payload, sensitive information in HTTP message header and Request URI. Not all the IEs get the same security treatment in SEPP. Some IEs require e2e encryption, some only require e2e integrity protection, while other IEs may require e2e integrity protection but modifiable by intermediate IPX provider while in-transit.\nThe figure depicts a signaling message from AMF (vPLMN) to AUSF (hPLMN) traversing the respective SEPPs. The message is transmitted over a fiber-optic backbone, with key components including the base station (gNB), user equipment (UE), and scatterers. The diagram highlights beamforming techniques to mitigate interference, ensuring reliable communication.\nFigure G.1-1: Signaling message from AMF (vPLMN) to AUSF (hPLMN) traversing the respective SEPPs\nIn the above figure, an example is shown where the AMF NF in the visited PLM network (vPLMN) invokes an API request on the AUSF NF in the home PLM network (hPLMN) using the following message flow:\n-\tThe AMF NF first sends the HTTP Request message to its local SEPP (i.e. vSEPP).\n-\tThe vSEPP applies application layer security (PRINS) and sends the secure message on the N32 interface to AUSF NF of the hPLMN.\n-\tThe hSEPP at the edge of the hPLMN, receives all incoming HTTP messages from its roaming partners. It verifies the message, removes the protection mechanism applied at the application layer, and forwards the resulting HTTP message to the corresponding AUSF NF.\nTo allow for the trusted roaming intermediary IPX nodes to see and possibly modify specific IEs in the HTTP message, while completely protecting all sensitive information end to end between SEPPs, the SEPP implements application layer security in such a way that:\n-\tSensitive information such as authentication vectors are fully e2e confidentiality protected between two SEPPs. This ensures that no node in the IPX network shall be able to view such information while in-transit.\n-\tIEs that are subject to modification by roaming intermediary IPX nodes are integrity protected and can only be modified in a verifiable way by authorized IPX nodes.\n-\tReceiving SEPP can detect modification by unauthorized IPX nodes.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "G.2\tStructure of HTTP Message",
            "description": "Following is a typical structure of the HTTP Message:\nThe figure depicts the typical structure of an HTTP message received by SEPP, highlighting the various components such as the request header, request body, and response header. The figure illustrates the use of HTTP headers like the \"Content-Type\" and \"Content-Length\" to convey the content of the message. The response header includes the \"Server\" and \"Location\" headers, which specify the server and the requested resource, respectively. The figure also includes a visual representation of the request and response messages, allowing for a clear understanding of the communication process.\nFigure G.2-1 Typical structure of the HTTP message received by SEPP\nIt consists of:\n-\tHTTP Message payload with JSON based IEs\n-\tHTTP Headers with or without sensitive elements\n-\tHTTP Request-URI with or without sensitive elements such as SUPI.\nIn the outgoing direction, i.e. towards the N32 interface, the SEPP shall parse the HTTP message fully and apply protection on each part as required.\nIn the incoming direction, i.e. towards the Network Function, the SEPP shall verify the message, and if successful reassemble the original message and send it to the destined Network Function.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "I.1\tGeneral",
            "description": "This Annex provides details on security for non-public networks. Most of the security procedures are the same as public networks so this annex only summarizes and specifies where there are exceptions to the normal procedures.\nThe feature for support of non-public networks (NPN) by 5GS is described in clause 5.30 of 23.501 [2].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "I.2\tAuthentication in standalone non-public networks",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.2.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "One of the major differences of non-public networks is that authentication methods other than AKA based ones may be used in a standalone non-public network (SNPN). When an AKA-based authentication method is used, clause 6.1 shall apply. When an authentication method other than 5G AKA or EAP-AKA' is used, only the non-AKA specific parts of clause 6.1 shall apply. An example of running such an authentication method is given in Annex B with EAP-TLS.\nThe choice of the supported authentication methods for access to SNPNs follows the principles described in clauses I.2.2 and I.2.3.\nThe authentication server can be an internal authentication server or an external authentication server. The internal authentication server is the AUSF, and the authentication method can be 5G-AKA or EAP-AKA´ as described in clause 6.1, or can be EAP-TLS as described in Annex B. When external authentication server is the AAA, the primary authentication procedure is described in Annex I.2.2.2.2. When external authentication server is an AUSF, then the primary authentication procedure is described in Annex I.2.4. The UDM decides to run primary authentication with internal authentication server or external authentication server.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "I.2.2\tEAP framework, selection of authentication method, and EAP method credentials",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.2.2.1\tGeneral",
                            "text_content": "The EAP authentication framework is supported by the 5GS as described in clause 6.1.1.2.\nThe UE and the SNPN may support 5G AKA, EAP-AKA', or any other key-generating EAP authentication method.\nSelection of the authentication methods is dependent on NPN configuration.\nNOTE 1: For EAP-AKA' (as well as 5G AKA), the selection is described in clause 6.1.2. For authentication,  that is not using EAP-AKA' (or 5G AKA), the selection is NPN operator deployment specific and out of scope of this specification.\nWhen an EAP authentication method other than EAP-AKA' is selected, the chosen method determines the credentials needed in the UE and network. These credentials, called the EAP-method credentials, shall be used for authentication.\nNOTE 2: How credentials for EAP methods other than EAP-AKA' are stored and processed within the UE is out of the scope for standalone non-public networks.\nNOTE 3:\tStorage and processing of credentials for EAP-AKA' (as well as 5G AKA) is described in clause 6 of the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.2.2.2\tCredentials holder using AAA server for primary authentication",
                            "text_content": "The procedures described in this clause enables UEs to access an SNPN which makes use of a credential management system managed by a credential provider external to the SNPN.\nIn this scenario the authentication server role is taken by the AAA Server. The AUSF acts as EAP authenticator and interacts with the AAA Server to execute the primary authentication procedure.\nThe architecture for SNPN access using credentials from a Credentials Holder using AAA Server is described in clause 5.30.2.9.2 of TS 23.501 [2].\nThe figure depicts a primary authentication scenario with an external domain, illustrating the process of authenticating users through a secure channel. The figure shows a user initiating a secure connection to the external domain, which is then authenticated by the user's device. The authentication process is facilitated by the use of a secure channel, ensuring the confidentiality and integrity of the data being transmitted.\nFigure: I.2.2.2.2-1: Primary authentication with external domain\n0.\tThe UE shall be configured with credentials from the Credentials holder e.g. SUPI containing a network-specific identifier and credentials for the key-generating EAP-method used. As part of configuration of the credentials, the UE shall also be configured with an indication that the UE shall use MSK for the derivation of KAUSF after the success of the primary authentication.  The exact procedures used to configure the UE are not specified in the present document.\nIt is further assumed that there exists a trust relation between the SNPN and the Credentials holder AAA Server. These entities need to be mutually authenticated, and the information transferred on the interface need to be confidentiality, integrity and replay protected. \n\nWhen the procedures of this clause are used for onboarding purposes, the onboarding specific adaptations includes: the 'credentials' used is 'Default credentials', the 'SUPI' used is 'onboarding SUPI', the 'SUCI' used is 'onboarding SUCI' respectively.\n1.\tThe UE shall select the SNPN and initiate UE registration in the SNPN.\nFor construction of the SUCI, existing methods in clause 6.12 can be used. Otherwise, if the EAP method supports SUPI privacy, the UE may send an anonymous value SUCI based on configuration.\n2.\tThe AMF within the SNPN shall initiate a primary authentication for the UE using a Nausf_UEAuthentication_Authenticate service operation with the AUSF. The AMF shall discover and select an AUSF based  on criterions specified in TS 23.501 [2] clause 5.30.2.9.2.\n3.\tIn the case of onboarding, steps 3-5 are omitted. If steps 3-5 are not omitted, the AUSF shall initiate a Nudm_UEAuthentication_Get service operation. The AUSF shall discover and select a UDM based on criterions specified in TS 23.501 [2] clause 5.30.2.9.\nNOTE 1: \tSUPI will be used instead of SUCI in the case of a re-authentication.\n4. \tIn case the UDM receives a SUCI, the UDM shall resolve the SUCI to the SUPI before checking the authentication method applicable for the SUPI. The UDM decides to run primary authentication with an external entity based on subscription data.\nIn case the UDM receives an anonymous SUCI, the UDM decides to run primary authentication with an external entity based the realm part of the SUPI in NAI format.\nNOTE 1a: The UDM needs to be configured with a list of realms and the intended authentication server\nIn case the UDM receives an anonymous SUCI that does not contain the realm part, the UDM shall abort the procedure. Otherwise, the UDM authorizes the UE based on realm part of SUCI and send the anonymous SUPI and the indicator to the AUSF as described in step5.\nThe anonymous SUPI shall be a NAI format.\n5.\tIn case the UDM received a SUCI in previous steps, the UDM shall provide the AUSF with the SUPI or anonymous SUPI and shall indicate to the AUSF to run primary authentication with a AAA Server in an external Credentials holder.\nWhen a Credentials Holder using AAA Server is used for primary authentication, the AUSF uses the MSK to derive KAUSF. It is strongly recommended that the same credentials that are used for authentication between UE and the 5G SNPN are not used for the authentication between the UE and a non-5G network, assuming that 5G SNPN and non-5G network are in different security domains.\nNOTE 2: \tMSKs obtained from the non-5G network could be used to impersonate the 5G SNPN towards the UE.\n6.\tBased on the indication from the UDM, the AUSF shall select an NSSAAF as defined in  TS 23.501 [2] and initiate a Nnssaaf_AIWF_Authenticate service operation towards that NSSAAF as defined in clause 14.4.2.\n7.\tThe NSSAAF shall select AAA Server based on the domain name corresponding to the realm part of the SUPI. The NSSAAF shall perform related protocol conversion and relay EAP messages to the AAA Server.\nNOTE 3:  The interface and protocol between NSSAAF and AAA is out of scope of the present document and existing AAA protocols such as RADIUS or Diameter can be used.\n8.\tThe UE and AAA Server shall perform mutual authentication. The AAA Server shall act as the EAP Server for the purpose of primary authentication. The EAP Identity received by the AAA Server in the EAP-Response/Identity message in step 7 may contain anonymised SUPI. In such cases, AAA Server uses the EAP-method specific EAP Identity request/response messages to obtain the UE identifier as part of the EAP authentication between the UE and the AAA Server.\n9.\tAfter successful authentication, the MSK and the SUPI (i.e., the UE identifier that is used for the successful EAP authentication) shall be provided from the AAA Server to the NSSAAF.\n10.\tThe NSSAAF returns the MSK and the SUPI to the AUSF using the Nnssaaf_AIWF_Authenticate service operation response message. The SUPI received from the AAA shall be used when deriving 5G keys (e.g., KAMF) that requires SUPI as an input for the key derivation.\n11-13. In case of onboarding or SUCI received in step 2 is not anonymous, steps 11-13 are omitted. Otherwise, the AUSF verifies that the SUPI corresponds to a valid subscription in the SNPN by informing the UDM about the authentication result for the received SUPI using a Nudm_UEAuthentication_ResultConfirmation service operation. The UDM stores the authentication state for the SUPI and if there is not a subscription corresponding to the SUPI, the UDM shall return an error.\nIf the verification of the SUPI is not successful, then the AUSF rejects the UE access to the SNPN.\n\nNOTE 4: If the above failure happens, the error is no failed authentication but lacking subscription in the SNPN.\n14. The AUSF shall use the most significant 256 bits of MSK as the KAUSF. The AUSF shall also derive KSEAF from the KAUSF as defined in Annex A.6.\n15. The AUSF shall send the successful indication together with the SUPI of the UE to the AMF/SEAF together with the resulting KSEAF.\n16. The AMF shall send the EAP success in a NAS message.\n17. The UE shall derive the KAUSF from MSK as described in step 11 according to the pre-configured indication as described in step 0.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "I.2.3\tKey hierarchy, key derivation and key distribution",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.2.3.1\tGeneral",
                            "text_content": "The text in clauses 6.2.1 and 6.2.2 cannot apply directly for an EAP authentication method other than EAP-AKA' as these clauses assume that an AKA-based authentication method is used. The major differences are the way in which KAUSF is calculated and that the UDM/ARPF is not necessarily involved in the key derivation or distribution.\nDepending on the selected authentication method, the KAUSF is generated as follows:\n-\tFor 5G AKA and EAP-AKA' refer to clause 6.2.1.\n-\tWhen using a key-generating EAP authentication method other than EAP-AKA', the key derivation of KAUSF is based on the EAP-method credentials in the UE and AUSF and shall be done as shown in Figure I.2.3-1.\nNOTE: For EAP authentication methods other than EAP-AKA', this key derivation replaces clauses 6.2.1 and 6.2.2 for the generation of KAUSF .\n\nThe figure depicts a derivation of the K AUSF (Key-Generating Authentication and User Subset Function) for key-generating EAP authentication methods other than EAP-AKA. The figure includes a flowchart and a list of key-generating EAP authentication methods, along with their corresponding EAP-AKA derivation. The K AUSF is derived from the EAP-AKA, and the derivation process is shown in a step-by-step manner. The figure is useful for understanding the key-generating EAP authentication methods and their derivation, which is an important concept in network security.\nFigure I.2.3.1-1: KAUSF derivation for key-generating EAP authentication methods other than EAP-AKA'\nKAUSF shall be derived by the AUSF and UE from the EMSK created by the EAP authentication as for EAP-AKA'.\nAll of figures 6.2.1-1, 6.2.2.1-1 and 6.2.2.2.2-1 from the KAUSF downwards are used without modification. Similarly, text relating to the key hierarchy, key derivation and key distribution in clauses 6.2.1, 6.2.2.1 and 6.2.2.2 for keys derived from KAUSF (e.g. KSEAF, KAMF, KgNB etc) apply without modification.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.2.3.2\tCredentials holder using AAA server for primary authentication",
                            "text_content": "When running primary authentication towards an external Credentials holder using AAA server for authentication as specified in clause I.2.2.2 the derivation of KAUSF is based on the EAP-method credentials in the UE and AAA-S and shall be done as shown in Figure I.2.3.2-1.\nThe figure depicts a simplified derivation of the K AUSF (Key Authentication Using External Server) protocol for primary authentication towards an external Credentials holder using an AAA (Authentication, Authorization, and Accounting) server. The diagram illustrates the steps involved in the authentication process, including the use of an external server to authenticate the credentials holder. The figure is a visual representation of the protocol's flow, providing a clear understanding of the authentication process.\nFigure I.2.3.2-1: KAUSF derivation for primary authentication towards an external Credentials holder using AAA server\nKAUSF shall be derived by the AUSF and UE from the MSK derived during the EAP authentication as specified in clause I.2.2.2.1.\nAll of figures 6.2.1-1, 6.2.2.1-1 and 6.2.2.2.2-1 from the KAUSF downwards are used without modification. Similarly, text relating to the key hierarchy, key derivation and key distribution in clauses 6.2.1, 6.2.2.1 and 6.2.2.2 for keys derived from KAUSF (e.g. KSEAF, KAMF, KgNB etc) apply without modification.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.2.4\tCredentials Holder using AUSF and UDM for primary authentication",
                            "text_content": "The 5G System architecture for SNPN with Credentials Holder using AUSF and UDM for primary authentication and authorization is described in clause 5.30.2.9.3 of TS 23.501 [2].\nThe requirements and procedures for primary authentication using AUSF and UDM as described in the present document apply, for 5G AKA, EAP-AKA', EAP-TLS or any other key-generating EAP method.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "I.3\tServing network name for standalone non-public networks",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.3.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The identification of standalone non-public networks uses Network Identifier (NID) in addition to PLMN ID. This means the definition of SN Id in clause 6.1.1.4.1 for the derivation of KSEAF for all authentication methods, CK' and IK' for EAP-AKA', and KAUSF and (X)RES* for 5G AKA needs modification for standalone non-public networks.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "I.3.2\tDefinition of SN Id for standalone non-public networks",
                    "description": "",
                    "summary": "",
                    "text_content": "For standalone non-public networks, the SN Id (used in the input for various key/parameter derivations) identifies the serving SNPN.\nIt is defined as follows:\nSN Id = PLMN ID:NID\nand is specified in detail in TS 24.501 [35].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "I.4\tModification of CAG ID list in the UE",
            "description": "The following requirements apply to NAS messages that modify the list of CAG IDs stored in the UE:\n-\tthe AMF shall only send such a NAS message once NAS security has been established; and\n-\tthe UE shall only modify its list of CAG IDs after successful integrity verification of the integrity protected NAS message requesting such a modification.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "I.5\tSUPI privacy for standalone non-public networks",
            "description": "The UE shall support SUPI privacy as defined in clause 6.12 with the following exception. When using an authentication method other than 5G AKA or EAP-AKA', the location of the functionality related to SUPI privacy in the UE is out of scope.\nIn scenarios where the EAP-method supports privacy, the UE may send an anonymous SUCI based on configuration.\nFurthermore, the privacy considerations for EAP TLS (given in Annex B.2.1.2) should be taken into account when using an authentication method other than 5G AKA or EAP-AKA'.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "I.6\tAuthentication in Public Network Integrated Non-Public Networks (PNI-NPN)",
            "description": "For public network integrated NPN (PNI-NPN), the primary authentication shall be performed with the public network as described in clause 6.1. Secondary authentication as described in clause 11 and slice-specific authentication as described in the main body can take place after a successful primary authentication.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "I.7\tAuthorization aspects in SNPNs",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.7.1\tCredentials holder using AUSF and UDM for primary authentication",
                    "description": "",
                    "summary": "",
                    "text_content": "For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, service authorization as specified in clause 13.4.1.2 applies.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "I.8\tSEPP and interconnect related security procedures",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.8.1\tCredentials holder using AUSF and UDM for primary authentication",
                    "description": "",
                    "summary": "",
                    "text_content": "For SNPNs with Credentials Holder using AUSF and UDM for primary authentication, clause 5.30.2.9.3 of TS 23.501 [2] states that the UE is not considered to be roaming, however SNPN and Credentials Holder communicate via SEPPs.\nThe following requirements and procedures related to SEPPs and interconnect security apply for SNPNs with Credentials Holder using AUSF and UDM for primary authentication:\n- \tRequirements for Security Edge Protection Proxy (SEPP), clause 5.9.3.2\n-\tProtection between SEPPs, clause 13.1.2.\nNOTE: \tIPX providers are not expected to be used between SNPN and Credentials holder using AUSF and UDM for primary authentication.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "I.9\tSecurity of UE onboarding in SNPNs",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.9.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "Onboarding of UEs for SNPNs is specified in clause 5.30.2.10 of TS 23.501 [2].\nOnboarding of UEs for SNPNs allows the UE to access an Onboarding Network (ONN) based on Default UE credentials for the purpose of provisioning the UE with SNPN credentials and any other necessary information. The Default UE credentials are pre-configured on the UE. Default UE credentials consist of credentials for primary authentication and optionally credentials for secondary authentication.\nTo provision SNPN credentials in a UE that is configured with Default UE credentials, the UE selects an SNPN as ONN and establishes a secure connection  with that SNPN referred to as Onboarding SNPN (ON-SNPN).\nThe present clause specifies security of UE onboarding.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "I.9.2\tAuthentication",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.9.2.1\tRequirements",
                            "text_content": "The primary authentication shall be performed before UE onboarding is allowed. For primary authentication, the UE shall use Default UE credentials for primary authentication. Credentials or means used to authenticate the UE based on Default UE credentials for primary authentication may be stored within the ON-SNPN or in a Default Credentials Server (DCS) that is external to the ON-SNPN.\nThe UE shall use Onboarding SUPI and Onboarding SUCI as specified in TS 24.501 [35] during Onboarding Registration.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.9.2.2\tPrimary authentication without using DCS",
                            "text_content": "When the primary authentication is performed between the UE and the ON-SNPN, any one of the existing authentication methods defined in the present document may be used, i.e., 5G AKA, EAP-AKA’ or any other key-generating EAP authentication method (e.g., EAP-TLS).\nThe choice of primary authentication method used is left to the decision of the ON-SNPN.\nCredentials required to authenticate the UE using default UE credentials for primary authentication, are provisioned at the AUSF or AUSF/UDM of the ON-SNPN. The provisioning of this information is out of scope of this document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.9.2.3\tPrimary authentication using DCS",
                            "text_content": "When the primary authentication is performed between the UE and the DCS, the authentication requirements and procedures defined in clause I.2 for Credential Holder shall apply with the DCS taking the role of the Credentials Holder. When the DCS uses AAA Server for primary authentication, AUSF directly selects the NSSAAF as specified in 23.501 [2]. In this case, the UDM is not involved in the procedure defined in clause I.2.2.2.2, and the step 3 to step 5 shall be skipped. When 5G AKA or EAP-AKA’ is used, the DCS shall act as a AUSF/UDM.\nThe choice of primary authentication method used between the UE and the DCS is left to the decision of the DCS.\nWhen the primary authentication is performed between the UE and the DCS via the AUSF using EAP-TTLS, Annex U can be used.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.9.2.4\tSecondary authentication",
                            "text_content": "After successful primary authentication as described in I.9.2.2 (i.e. primary authentication without using DCS), upon the establishment of the Onboarding PDU Session, the ON-SNPN may trigger secondary authentication procedure with the DCS using  Default UE credentials for secondary authentication, as described in clause 11.1.\nNOTE:\tIf both primary and secondary authentication use a certificate-based authentication method like e.g. EAP-TLS, and if required by the use case, it is possible to configure the UE with the same client certificates for Default UE credentials for secondary authentication as for the Default UE credentials for primary authentication.\nAfter successful primary authentication as described in I.9.2.2 or I.9.2.3, upon the establishment of the Onboarding PDU Session, the ON-SNPN may trigger secondary authentication procedure with a DN-AAA server using Default UE credentials for secondary authentication, as described in clause 11.1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "I.10\tSecurity for access to SNPN services via Non-3GPP access",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "I.10.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "Access to SNPN services via Non-3GPP access is described in TS 23.501 [2], sub-clauses of clause 5.30.2. Security for non-3GPP access to the 5G core network of PLMN is described in clause 7 and Annex S of this specification. The present clause describes changes and additions that apply in the SNPN case.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "I.10.2\tSecurity for access to SNPN services via Untrusted non-3GPP access",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.10.2.0\tGeneral",
                            "text_content": "The decision to use a Credentials Holder using AAA is taken by the UDM. The selection criteria is described in step 4 of Annex I.2.2.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.2.1\tUntrusted non-3GPP access support in SNPN without CH",
                            "text_content": "Procedures for untrusted non-3GPP access authentication are described in clause 7.2.1. For SNPN the procedures are modified as follows:\nSteps 1-4 are performed as described in clause 7.2.1.\nIn step 5, the SUCI can be an onboarding SUCI.\nFurther in step 5, the SUCI can be of type anonymous SUCI if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy.\nStep 6 is performed as described in clause 7.2.1.\nIn step 7 of clause 7.2.1, in case the AUSF receives an onboarding indication, the AUSF shall perform steps 6-10 and 14-17 as described in Annex I.2.2.2.\nIn the selection of UE authentication method in step 7 of clause 7.2.1, 5G AKA, EAP-AKA’, or any other key-generating EAP authentication method apply. When the \"username\" part of the SUPI is \"anonymous\" or omitted, the UDM may select an authentication method based on the \"realm\" part of the SUPI or on the UDM local policy.\nIn case the AUSF received an anonymous SUCI in step 7 (but no onboarding indication was received) the AUSF shall perform steps 11-13 of Annex I.2.2.2 after a successful authentication to inform the UDM of the actual SUPI. In case anonymous SUCI and onboarding indication was received in step 7, steps 11-13 of Annex I.2.2.2 can be skipped.\nIn step 8 of clause 7.2.1 in case an EAP method is used for primary authentication, the AMF shall encapsulate the EAP-Success received from AUSF within the SMC message.\nSteps 9-16 are performed as described in clause 7.2.1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.2.2\tUntrusted non-3GPP access support in SNPN with CH",
                            "text_content": "UE may use the credentials from a Credentials Holder AAA server to access SNPN services via Untrusted non-3GPP access.\nThe figure depicts a procedure for accessing a non-3GPP network using a Credentials Holder AAA Server. The diagram illustrates the steps involved in obtaining credentials, including obtaining a certificate from a trusted authority, configuring the server, and establishing a connection. The figure is crucial for understanding the authentication process and ensuring secure communication.\nFigure I.10.2.2-1: Procedure for Untrusted non-3GPP Access using Credentials Holder AAA Server\n0  prior conditions and assumptions are described in step 0 in clause I.2.2.2.2.\n1a-6b as specified in clause 7.2.1. In addition, if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy, the UE may send an anonymous SUPI based on configuration.\n7  authentication and key agreement procedure between the UE and the AAA server, as specified in steps 2-15 in clause I.2.2.2.2.\n8-17  as specified in clause I.10.2.1 .\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "I.10.3\tSecurity for access to SNPN services via Trusted non-3GPP access",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.10.3.0\tGeneral",
                            "text_content": "The decision to use a Credentials Holder using AAA is taken by the UDM. The selection criteria is described in step 4 of Annex I.2.2.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.3.1\tTrusted non-3GPP access support in SNPN without CH",
                            "text_content": "Procedures for trusted non-3GPP access authentication are described in clause 7A.2.1. For SNPN the procedures are re-used with the following modifications:\nSteps 0-4 are performed as described in clause 7A.2.1.\nIn step 5, the SUCI can be an onboarding SUCI.\nFurther in step 5, the SUCI carried in AN parameter and NAS-PDU can be of type anonymous SUCI if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy. If anonymous SUCI is used, the UE shall send a 64-bit random number as a key identifier in the AN parameters. The random number generation should follow the recommendations given in SP 800-90A [110] or equivalent. If the UE provides a key identifier already allocated in the TNGF, the UE will be rejected.\nEditor's Note: Whether also the anonymous SUCI is sent in the AN parameter is ffs.\nStep 6-7 is performed as described in clause 7A.2.1.\nIn step 8 of clause 7A.2.1, in case the AUSF receives an onboarding indication, the AUSF shall perform steps 6-10 and 14-17 as described in Annex I.2.2.2.\nIn the selection of UE authentication method in step 8 of clause 7A.2.1, 5G AKA, EAP-AKA’, or any other key-generating EAP authentication method apply. When the \"username\" part of the SUPI is \"anonymous\" or omitted, the UDM may select an authentication method based on the \"realm\" part of the SUPI or on the UDM local policy.\nIn case the AUSF received an anonymous SUCI in step 7 (but no onboarding indication was received) the AUSF shall perform steps 11-13 of Annex I.2.2.2 after a successful authentication to inform the UDM of the actual SUPI. In case anonymous SUCI and onboarding indication was received in step 7, steps 11-13 of Annex I.2.2.2 can be skipped.\nSteps 9-12 are performed as described in clause 7A.2.1.\nIn step 13, in case anonymous SUCI was used in step 5,  the key identifier sent in the AN parameters is  used in the IDi payload. If the key identifier is not the same as the one sent in step 5, the IPsec setup will fail and the UE will be rejected.\nSteps 14-19 are performed as described in clause 7A.2.1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.3.2\tTrusted non-3GPP access support in SNPN with CH",
                            "text_content": "UE may use the credentials from a Credentials Holder AAA server to access SNPN services via Trusted Non-3GPP access.\nThe figure depicts a procedure for trusted non-3GPP access using a Credentials Holder AAA Server. It illustrates the steps involved in establishing a secure connection between a client and a server, ensuring that only authorized parties can access the server. The figure includes a diagram of the server's components, such as the Credentials Holder AAA Server, the client, and the server's network interface. The diagram also shows the connection between the client and the server, with the client's IP address and the server's IP address being shown. The figure is important for understanding the security measures used in the system and for implementing a secure connection between the client and the server.\nFigure I.10.3.2-1: Procedure for Trusted Non-3GPP Access using Credentials Holder AAA Server\n0  prior conditions and assumptions are described in step 0 in clause I.2.2.2.2.\n1-7a as specified in clause 7A.2.1. In addition, if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy, the UE may send an anonymous SUPI based on configuration.\n8  authentication and key agreement procedure between the UE and the AAA server, as specified in steps 2-15 in clause I.2.2.2.2.\n9-19  as specified in clause I.10.3.1.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "I.10.4\tSecurity for access to SNPN services for N5CW devices",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.10.4.0\tGeneral",
                            "text_content": "The decision to use a Credentials Holder using AAA is taken by the UDM. The selection criteria is described in step 4 of Annex I.2.2.2.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.4.1\tSupport for N5CW devices in SNPN without CH",
                            "text_content": "Procedures for authentication for devices that do not support 5GC NAS over WLAN access are described in clause 7A.2.4. For SNPN the procedures are modified as follows:\nSteps 0-1 are performed as described in clause 7A.2.4.\nIn step 2 of clause 7A.2.4 the SUCI can be of type anonymous SUCI if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy.\nStep 3-6 is performed as described in clause 7A.2.4.\nIn the selection of UE authentication method in step 7 of clause 7A.2.4, any key-generating EAP authentication method apply. When the \"username\" part of the SUPI is \"anonymous\" or omitted, the UDM may select an authentication method based on the \"realm\" part of the SUPI or on the UDM local policy.\nIn step 8 of clause 7A.2.4, in case the AUSF received an anonymous SUCI in step 7, the AUSF shall perform steps 11-13 of Annex I.2.2.2 after a successful authentication to inform the UDM of the actual SUPI.\nSteps 9-14 are performed as described in clause 7A.2.4.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.4.2\tSupport for N5CW devices in SNPN with CH",
                            "text_content": "N5CW devices may use the credentials from a Credentials Holder AAA server to access SNPN services via trusted WLAN access.\nThe figure depicts a procedure for trusted WLAN access using a Credentials Holder AAA Server, which is a key component in the WLAN security model. The figure illustrates the steps involved in obtaining and storing credentials, as well as the process of authenticating and authorizing access to the WLAN. The use of a Credentials Holder AAA Server ensures that only authorized users can access the WLAN, reducing the risk of unauthorized access and data breaches.\nFigure I.10.4.2-1: Procedure for trusted WLAN access using Credentials Holder AAA Server\n0  prior conditions and assumptions are described in step 0 in clauses 7A.2.4 and I.2.2.2.2.\n1-5 as specified in clause 7A.2.4. In addition, if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy, the UE may send an anonymous SUCI based on configuration..\n6-8  are replaced by the steps 3-15 in clause I.2.2.2.2.\n9-14  as specified in clause 7A.2.4.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "I.10.5\tSecurity for NSWO support in SNPN",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "I.10.5.1\tNSWO support in SNPN using CH with AAA server",
                            "text_content": "The reference architecture to support authentication for Non-seamless WLAN offload using SNPN credentials from Credentials Holder using AAA Server is specified in Figure 4.2.15-3b of TS 23.501 [2].\nThis clause applies to UEs that support NSWO in SNPN with any key generating EAP method by using the SNPN credentials with CH AAA server (i.e., the MSK indication described in step 0 of clause I.2.2.2.2 is configured on the UE). The UE shall reuse 5G NSWO procedures defined in Annex S.3.2 with WLAN access network for NSWO authentication with the same key generating EAP method that is used by the SNPN over 3GPP access with the following exception:\n-\t The EAP authentication is performed between the UE and the CH AAA with no involvement of NSWOF/AUSF/UDM.\n-\tThe construction of SUCI described in this document is not applicable.\nNOTE: The requirement to use the same key generating EAP method includes the EAP identity privacy mechanism used by the SNPN over 3GPP access. This implies that for NSWO support in SNPN using CH with AAA server the identity privacy is achieved at the EAP layer via EAP method specific means.\nThe figure depicts a procedure for NSWO authentication using CH with AAA server via 5GC. It illustrates the steps involved in authenticating a user using the CH protocol, which is a key component of the 5G network. The figure includes a diagram of the network setup, including the 5GC server, the CH server, and the AAA server. The steps are clearly labeled and numbered, making it easy to follow the procedure.\nFigure I.10.5.1.2-1 - Procedure for NSWO authentication using CH with AAA server via 5GC\n1-5. Same as steps 1-5 of clause S.3.2, except that SUCI is replaced with SUPI. If the EAP method supports privacy and the UE is configured to use anonymous SUPI, the UE sends an anonymous SUPI.\n6. Same as steps 3 of clause I.2.2.2, except that SUCI is replaced with SUPI and NSWO_indicator is also sent to the UDM by the AUSF.\n7-16. Same as steps 4-13 of clause I.2.2.2.2.\nRemaining steps are performed as described in steps 16-18d of clause S.3.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.5.2\tNSWO support in SNPN without CH",
                            "text_content": "5G NSWO procedures are defined in Annex S.3.2. For SNPN the procedures are extended to usage of any key-generating EAP-method as follows:\n5G NSWO procedures are defined in Annex S.3.2. For SNPN the procedures are extended to usage of any key-generating EAP-method as follows:\nSteps 1-2 are performed as described in Annex S.3.2.\nIn step 3, the SUCI can be of type anonymous SUCI if the construction of SUCI as described in clause 6.12 cannot be used and if the employed EAP method supports SUPI privacy.\nSteps 4-6 are performed as described in Annex S.3.2.\n7. Upon reception of the Nudm_UEAuthentication_Get Request, the UDM invokes SIDF to de-conceal SUCI to gain SUPI if the received SUCI is not an anonymous SUCI. For selection of authentication methods, the statements in Annex I.2.2.1 apply. In case of SNPN, the UDM selects authentication method based on the NSWO indicator, subscription data and/or local configuration. The authentication method may include EAP-AKA’ or any other key-generating EAP authentication method. The UDM returns the selected authentication method to the AUSF.\n8. Authentication is performed between the AUSF and UE using the selected EAP method. After a successful authentication the AUSF derives the MSK key and does not generate the KAUSF, as indicated by the NSWO indicator and as described for the PLMN case in Annex S.3.2.\nSteps 9-11 are performed as described in steps 16-18 of Annex S.3.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "I.10.5.3\tNSWO support in SNPN using CH with AUSF/UDM",
                            "text_content": "The architecture for 5G NSWO in SNPN using CH AUSF/UDM is defined in clause 4.2.15 of TS 23.501 [2].\nThe procedures are the same as those defined in Annex I.10.5.2.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "I.11\tSecurity for accessing a localised service",
            "description": "Accessing a localized service is specified in Annex N of TS 23.501 [1]. Existing authentication procedures, as described in this specification, for either primary authentication, secondary authentication, slice specific authentication or onboarding procedures can be used. The authentication methods include any key-generating EAP method when applicable.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "J.1 \tSRVCC from NR to UTRAN",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "J.2\tEmergency call in SRVCC from NR to UTRAN",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "K.1\tGeneral",
            "description": "5GLAN services are described in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [8].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "K.2\tAuthentication and authorization",
            "description": "For authentication and authorization of a UE in 5G LAN communication, the secondary authentication procedures between UE and external data networks via the 5G Network as described in clause 11 shall apply.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "K.3\tHandling of UP security policy",
            "description": "To reduce incremental complexity added by security, all PDU sessions associated with a specific 5G LAN group should have the same UP security policy.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "L.1\tGeneral",
            "description": "The 5G TSC service is described in 3GPP TS 23.501 [2]. It allows the 5G System to be integrated transparently as a bridge in an IEEE TSN network [75], where the 5GS system acts as one or more TSN Bridges of a TSN network.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "L.2\tAccess security for a 5GS TSC-enabled UE",
            "description": "A 5GS TSC-enabled UE accesses the 5G network as described in this document except where differences are provided in the following clauses.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "L.3\tProtection of user plane data in TSC including (g)PTP control messages in bridge mode",
            "description": "After the 5GS TSC-enabled UE is authenticated and data connection is set up, any data received from a TSC bridge or another 5GS TSC-enabled UE shall be transported between DS-TT (in the UE) and NW-TT (in the UPF) in a protected way using the mechanisms for UP security as described in clause 6.6.\nThe UP security enforcement information shall be set to \"required\" for data transferred from gNB to a 5GS TSC-enabled UE. This is also applicable to the (g)PTP messages sent in the user plane.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "L.4\tExposure of time synchronisation",
            "description": "Any AF that has knowledge of deterministic application requirements is able to request TSC services from the 5GS by interfacing with NEF, and as authorized, can be notified of pertinent network events. The security solution as described in clause 12 shall apply.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "M.1\tGeneral",
            "description": "This Annex provides the security procedures applied to NR IAB architecture and functional entities for supporting wireless backhauling of NR base stations.\nThe overall stage 2 description for IAB architecture and functional entities are described in 3GPP TS 23.501 [2] and 3GPP TS 38.401 [78].\nThe security requirements and security procedures applied to IAB in EN-DC architecture are defined in both TS 33.401 [10] and in the present document. The security requirements and security procedures between the IAB-node and the MeNB (i.e., when the IAB-node connects via E-UTRA to a MeNB), are defined in TS 33.401 [10] and between the IAB-node and the SgNB (F1 interface) are defined in this clause.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "M.2\tSecurity requirements and features",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "M.2.1\tRequirements on the IAB-node (IAB-UE)",
                    "description": "",
                    "summary": "",
                    "text_content": "The IAB-node (IAB-UE) shall support ciphering, integrity protection and replay protection of NAS-signalling between the IAB-node (IAB-UE) and the 5GC supporting IAB architecture.\nThe IAB-node (IAB-UE) shall support ciphering, integrity protection and replay protection of RRC-signalling between the IAB-node (IAB-UE) and the IAB donor.\nMutual authentication between the IAB-node (IAB-UE) and the 5GC supporting IAB architecture shall be supported.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.2.2\tRequirements on the IAB donor",
                    "description": "",
                    "summary": "",
                    "text_content": "The IAB donor shall support ciphering, integrity protection and replay protection of RRC-signalling between the IAB donor and the IAB-node (IAB-UE).\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.2.3\tRequirements on the 5GC supporting IAB architecture",
                    "description": "",
                    "summary": "",
                    "text_content": "The 5GC supporting IAB architecture shall support ciphering, integrity protection and replay protection of NAS-signalling between the 5GC supporting IAB architecture and the IAB-node (IAB-UE).\nMutual authentication between the 5GC supporting IAB architecture and the IAB-node (IAB-UE) shall be supported.\nThe 5GC shall decide whether the IAB-node is authorized to operate as IAB-node (gNB-DU).\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.2.4\tRequirements for secure environment",
                    "description": "",
                    "summary": "",
                    "text_content": "The security requirements for secure environment of the IAB-node (gNB-DU) and the IAB-donor are described in clause 5.3.8 of this document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.2.5\tRequirements on the F1 interface",
                    "description": "",
                    "summary": "",
                    "text_content": "The security requirements on the F1 interface between the IAB-node (gNB-DU) and the IAB-donor-CU are described in clause 5.3.9 of this document.\n\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "M.3\tIAB-node Integration Procedure",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "M.3.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "IAB-node, consists of a UE function (referred to as IAB-UE) and gNB-DU function [2]. IAB integration procedure consists of 3 phases detailed in TS 38.401 [78].\nPhase-1: IAB-UE part setup:\nThe IAB-UE performs registration procedure to the network as a UE as described in TS 23.501 [2] and TS 23.502 [8] in order to register to the 5GC and consequently, the NAS and AS security are established between the IAB-node and 5GC.\nPhase-2: BH RLC channel establishment and routing update:\nThe BH RLC channels and the BAP layer are established and configured in the IAB-node by the IAB-donor using the secured RRC signalling to support routing between the IAB-node and the IAB-donor.\nPhase-3: gNB -DU part setup:\nF1 security establishment for IAB is performed over the RLC channel.\nThe Phase-1 results in IAB-UE registration and consequently, AS security establishment between the IAB donor and IAB-node, Phase-2 results in configuration of the IAB-node securely using the established AS security and Phase-3 results in the establishment of secure F1 interface between the IAB-donor and IAB-node.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.3.2\tAuthentication and Authorization of IAB-node (Phase-1)",
                    "description": "",
                    "summary": "",
                    "text_content": "The IAB-UE function shall behave as a UE, and shall reuse the UE procedures specified in this document for the primary authentication (see clause 6), key derivation and distribution scheme, subscription credential(s) storage requirements, NAS security and AS security.\nNOTE 1: For isolated deployment scenarios, Annex B describes how additional EAP methods can be used.\nNOTE 2: Storage of subscription credentials for EAP AKA’ and 5G AKA is described in clause 6 of the present document.\nAuthorization of IAB-nodes shall be performed by the 5G core network supporting IAB architecture as described in TS 23.501 [2].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "M.3.3\tSecurity mechanisms for F1 interface between the IAB-node (gNB-DU) and the IAB-donor-CU (Phase-3)",
                    "description": "",
                    "summary": "",
                    "text_content": "\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "M.3.3.1\tGeneral",
                            "text_content": "The following clause applies to F1 interface between the IAB-node (gNB-DU) and the IAB-donor-CU.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "M.3.3.2\tSecurity mechanisms for the F1 interface",
                            "text_content": "The F1 interface connects the IAB-node (gNB-DU) to the IAB-donor-CU. It consists of the F1-C for control plane and the F1-U for the user plane.\nF1 security for IAB is established using the security mechanisms for the F1 interface as specified in clause 9.8.2 of the present document, with IAB node taking the role of gNB-DU and IAB-donor-CU taking the role of gNB-CU.\nIn addition to the security mechanisms specified in clause 9.8.2 of the present document for the F1 interface, the IKEv2 Pre-shared Secret Key (PSK) authentication shall be supported. When IKEv2 performs a PSK authentication, in the IKE_AUTH request message, the IAB node shall set the ID type to ID_KEY-ID and set its value to PSK ID.\nNOTE 1:\tThe PSK and PSK ID (for IKEv2 PSK authentication) can be preconfigured at the IAB node and IAB donor. Pre-configuration of the PSK(s) is out of the scope of the present document.\nAdditionally, to support a flexible plug and play of IAB-node and IAB-donor without a pre-configuration of the PSK(s), dynamic PSK computation for IKEv2 PSK authentication may also be supported. When dynamic PSK is used, the IAB-node and the IAB-donor shall calculate the PSK (KIAB) as specified in the Annex A.23 of this document. The IAB-donor shall uniquely identify the IAB-node’s security context (KgNB) using the IAB-node DU IP address. The IAB-donor shall use KIAB as PSK for IKEv2 between IAB-node and the IAB-donor. KIAB is stored in the IAB-node and in the IAB-donor. This key KIAB and the IPsec SA cryptographic keys are taken into use with the establishment of IPsec Security Association (SA) between the IAB-node and the IAB-donor. KIAB remains valid as long as the IAB-node is connected to the IAB-donor or until the IAB-node is re-authenticated. The KIAB is associated with the IAB-node DU IP address in the IAB-donor. In the IKE_AUTH request message, the IAB node shall set the ID type to ID_IPV4_ADDR/ID_IPV6_ADDR and set its value to the IAB-node DU IP address in the Idi payload. In case of CP-UP separation of IAB-donor-CU (IAB-donor-CU contains IAB-donor-CU-CP and IAB-donor-CU-UP that use different IP address) then, IAB-donor-CU-CP and IAB-node DU shall generate KIAB-CU-CP and KIAB-CU-UP as specified in the Annex A.23 of this document. The key KIAB-CU-CP shall be used for establishment of secure F1 interface between the IAB-node DU and IAB-donor-CU-CP. The IAB-donor-CU-CP shall provide KIAB-CU-UP to the IAB-donor-CU-UP via E1 interface and KIAB-CU-UP shall be used for establishment of secure F1 interface between the IAB-node DU and IAB-donor-CU-UP.\nNOTE 2:\tKIAB is used as the PSK for IKEv2 authentication, the interface between the IAB-donor-CU and the SEG to provision the key KIAB in the SEG is implementation specific and out of the scope of the present document.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "M.4\tProtection of management traffic between IAB-node and OAM",
            "description": "If management traffic uses the user plane via PDU session, it shall be protected using the user plane security mechanism as specified in clause 6.6.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "M.5\tIAB inter-CU topology adaptation and backhaul RLF recovery procedure",
            "description": "In case of the inter-CU migration as specified in TS 38.401 [78], the IAB-MT is migrated from a source IAB-donor-CU to a target IAB-donor-CU. The migrating IAB-node becomes a boundary IAB-node since its IAB-DU retains F1AP with the source IAB-donor-CU after its IAB-MT obtains RRC connectivity with the target IAB-donor-CU (c.f. TS 38.401 [78]).\nIn case IPsec tunnel mode is used for F1 interface protection, the migrating/descendant/Recovery IAB-node may use MOBIKE (IETF RFC 4555 [111]) to migrate the IPsec tunnel to the new IP outer addresses as specified in TS 38.401 [78].\nIn IPsec transport mode for the non-dynamic PSK case, the establishment of the IPsec SAs follows the procedures in Annex M.3.3.2 of the present document. In IPsec transport mode for the dynamic PSK case, the establishment of the IPsec SAs may be performed by initiating new IKEv2 procedure using the stored KIAB associated with the old IP address as the PSK for the corresponding new IP address. The identical mapping between the old IP address with the new IP address between the IAB-node and the IAB-donor-CU is performed using the old IP address present in the IDi payload and the new IP address in the IP header of the IKEv2_AUTH request message or provided by the target/new IAB-donor-CU. In case of multiple IP addresses for IAB-node, the IKEv2 procedure is performed for each IP address. Once the IKEv2 authentication is successful, the KIAB is associated with the new IAB-node DU IP address in the IAB-donor.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "N.1\tGeneral",
            "description": "This clause describes the security requirements, procedures and handling for Ultra-Reliable Low-Latency Communication (URLLC). The procedures and handling include the enforcing the security policy for data transmission. The general features for URLLC are described in 23.501 [2], 38.300 [52] and TS 23.502 [8].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "N.2\tSecurity support on redundant transmission",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "N.2.1\tRedundant user plane paths based on dual connectivity",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "N.2.1.1\tIntroduction",
                            "text_content": "In order to support URLLC services, a UE sets up two redundant PDU sessions over the 5G network, such that the 5GS sets up the user plane paths of the two redundant PDU Sessions to be disjoint as described in clause 5.33 in TS 23.501 [2]. However, NG-RAN may realize redundant user plane resources for the two PDU sessions with a single NG-RAN node, or by Dual Connectivity with two NG-RAN nodes, i.e. one PDU session spans from the UE via the MN to a first UPF and the second PDU session spans from the same UE via the SN to a second UPF. Based on the two PDU sessions, the redundant data sent between the UE and the DN takes different paths in the 3GPP network.\nThe security aspects for redundant PDU sessions transmission by Dual Connectivity are based on the security procedures and description described in clause 6.10 of the present specification. This clause only describes the additional security features.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "N.2.2.2\tSecurity policy aspects",
                            "text_content": "When dual connectivity is used for redundant transmission, both of the two PDU sessions are initially established via the MN. The SMF(s) shall provide a UP security policy for each of the two PDU sessions to the MN during the PDU session establishment procedure as described in clause 6.6.1. The UP security policy from the SMF(s) for the two PDU sessions used for redundant data transmission shall have the same setting for encryption and for integrity protection. The network (UDM and/or SMF) shall ensure that all the redundant PDU sessions based on the information sent by the UE as described in TS 23.501 [2] shall have same UP security policy setting.\nThe MN shall be preconfigured or shall have access to the supported security capabilities in the available SN(s), (i.e. to whether UP integrity protection is supported in the SN or not). The MN shall take the received UP security policy into account when selecting the SN.\nMN shall ensure that the first and the redundant PDU sessions shall have the same UP security activation status. If the \"Preferred\" option of the UP security policy is not allowed to be used for URLLC service at the SMF or UDM, which means the SMF or UDM can guaranteethe UP security policy for the first and the redundant PDU sessions are the same and only contains \"Not needed\", or \"Required\", then the MN shall forward the UP security policy to the SN as described in clause 6.10.\nIf the \"Preferred\" option of the UP security policy is allowed to be used for URLLC services, the following enhancements for the mechanism as described in clause 6.10 for Dual Connectivity shall be applied：\n-\tThe MN shall make the decision on UP encryption protection and integrity protection according to the UP security policy for these two redundant data transmissions. The MN shall store the applied UP security activation status used for the DRB’s established for the first PDU session between the MN and the UE. Then, the MN shall provide the UP security activation status applied for the first PDU session to the SN, when offloading the DRB’s for the second PDU session to the SN.\n-\tThe SN shall use the UP security activation status received from the MN to activate the UP security for the DRB’s established for the redundant PDU session between the SN and the UE.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "N.2.2\tRedundant transmission on N3/N9 interfaces",
                    "description": "",
                    "summary": "",
                    "text_content": "If the user data redundancy is fulfilled by means of two duplicated N3 tunnels, the redundant packets will be transferred between UPF and RAN via two independent N3 tunnels, which are associated with a single PDU Session, over different transport layer path to enhance the reliability of service.\nThe figure depicts a redundant transmission system with two N3 tunnels between the UPF (User Peripheral Facility) and a single NG-RAN (Next-Generation Radio Access Network) node. This system ensures reliable communication by providing redundancy in case of network failures or disruptions.\nFigure N.2.2-1: Redundant transmission with two N3 tunnels between the UPF and a single NG-RAN node\nIn order to protect the redundant traffic on the N3 reference point, the current mechanism defined in clause 9.3 of the present document shall be reused. The added path for redundancy shall provide equal level of security compared to single path.\nIn case two N9 tunnels are involved to fulfil the redundancy for one NG-RAN, the security mechanism defined in clause 9.9 shall be used for protecting the redundant data transferring via two N9 tunnels as described above.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "O.1\tGeneral",
            "description": "This annex describes the authentication procedure, using EAP-TLS as an example, for Non-5G Capable (N5GC) devices behind Residential Gateways (RGs) in private networks or in isolated deployment scenarios (i.e., roaming is not considered) with wireline access. The registration procedure of N5GC devices behind Cable RGs is described in clause 4.10a of TS 23.316 [79].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "O.2\tBaseline for using non-5G capable devices with 5GC",
            "description": "N5GC devices lack some key 5G capabilities, including NAS and the derivation of 5G key hierarchy. Those devices exist in wireline networks and need to be able to access the converged 5G core. The authentication of N5GC devices can be based on additional EAP methods other than EAP-AKA’. The procedure in O.3 uses EAP-TLS as in Annex B as an example, but it differs from the Annex B in the following:\na) the W-AGF creates the registration request on behalf of the N5GC device,\nb) 5G related parameters (including ngKSI and ABBA) are not sent to the N5GC device. When received from the AMF, these parameters are ignored by the W-AGF, and\nc) Neither the N5GC device nor the AUSF derives any 5G related keys after EAP authentication.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "O.3\tAuthentication procedure",
            "description": "Figure O.3-1 shows the details of the authentication procedure as part of the initial registration procedure specified in clause 4.10a of TS 23.316 [79] following the principles listed in clause O.2. It uses EAP-TLS as an example, but other EAP methods can also be supported. The W-AGF acts on behalf of the N5GC device during the registration process. The link between the N5GC device and the RG, and between the RG and the W-AGF can be any data link (L2) that supports EAP encapsulation.\n\nThe figure depicts a registration and authentication process for a non-5G capable device to connect to a 5G network. It illustrates the steps involved in ensuring the device is compatible with the 5G network, including the use of registration and authentication protocols.\nFigure O.3-1: Registration and authentication of a non-5G capable device to the 5GC\n\nIn the following, the procedure for registration and authentication of an N5GC device to the 5GC is described:\n1.  The N5GC device connects to the W-AGF via a RG which is configured as a layer 2 bridge. The W-AGF is associated with a 5GC and acts on behalf of the N5GC device during its registration process.\n2a. The W-AGF initiates the EAP authentication procedure by sending an EAP request/Identity to the N5GC device via the RG, which acts as an L2 bridge device and forwards the ethernet frame to the N5GC device. The EAP message is encapsualted inside an L2 frame (e.g., EAPOL).\n2b. In response, the N5GC device sends back an EAP response/Identity including its Network Access Identifier (NAI) in the form of username@realm.\nNOTE 1: If TLS subscription identifier privacy protection is supported , as in \"Section 2.1.4. Privacy\" of RFC 5216 [38] for TLS 1.2 or in RFC 8446 [60] for TLS 1.3, the \"username\" part must be is either omitted or \"anonymous\".\n3. The W-AGF creates a registration request on behalf of the N5GC device with an indication that the registration is on behalf of an N5GC device. The SUPI of the N5GC device is the NAI as received from the device, and the W-AGF constructs the SUCI from this SUPI using the NULL scheme.\n4a. The W-AGF selects the AMF/SEAF.\n4b. The W-AGF sends to the AMF/SEAF a registration request on behalf of the N5GC device. The registration request includes the NAI SUCI, wireline network name if available, and a device capability indicator (e.g., the device is non-5G capable).\n4c. The AMF/SEAF selects the AUSF based on the SUCI in the received registration request and sends a Nausf_UEAuthentication_Authenticate Request message to the AUSF. It contains the SUCI of the N5GC device, and an indicator that the request is on behalf of the N5GC device.\n5a. The AUSF sends a Nudm_UEAuthentication_Get Request to the UDM. It contains the SUCI of the N5GC device and the N5GC device indicator.\n5b. The UDM invokes the SIDF to map the SUCI to the SUPI and selects an authentication method, e.g., EAP-TLS, based on the SUPI. When the \"username\" part of the SUPI is \"anonymous\" or omitted, the UDM may select an authentication method based on the “realm” part of the SUPI, the N5GC device indicator, a combination of the \"realm\" part and the N5GC device indicator, or the UDM local policy.\n5c. The UDM sends a Nudm_UEAuthentication_Get Response to the AUSF, which contains the SUPI of the N5GC device and an indicator of the selected authentication method, e.g., EAP-TLS. According to the N5GC device subscription data, the UDM shall also send the MSK indicator to the AUSF to indicate that the N5GC device does not support the 5G key hirerachy.\nNOTE 2: Steps 6a-14c describe the exchange of EAP-TLS between the AUSF and the N5GC device, based on TLS 1.2 without subscription identifier privacy protection. If the operator determines to provide subscription identifier privacy for the N5GC in TLS layer, the EAP TLS server needs to support privacy either inherently (e.g., in TLS 1.3) or via separate privacy option (e.g., in TLS 1.2). When TLS 1.2 is used, the N5GC device would need to behave as described in \"Section 2.1.4. Privacy\" of RFC 5216 [38] where instead of sending the client certificate in cleartext over the air, the N5GC device sends TLS certificate (no cert) during the first TLS handshake and sends TLS certificate (client certificate) during the second TLS handshake within the TLS session negotiated form the first TLS handshake.\n6a.  The AUSF starts EAP-TLS by sending to the AMF/SEAF a Nausf_UEAuthentication_Authenticate Response message containing an EAP-Request message of EAP-type=EAP-TLS with the Start (S) bit set, denoted as EAP-Request/EAP-TLS [TLS start].\n6b.\tThe AMF/SEAF forwards the EAP-Request/EAP-TLS [TLS start] in the Authentication Request message to the W-AGF.\n6c. After receiving the EAP-Request/EAP-TLS [TLS start] message from AMF/SEAF, the W-AGF forwards the EAP-Request/EAP-TLS [TLS start] message to the N5GC device in an L2 message, leaving out the ABBA and ngKSI parameters.\n7a. After receiving the EAP-Request/EAP-TLS [TLS start] message from the W-AGF, the N5GC device replies to the W-AGF with an EAP-Response/EAP-TLS message whose data field encapsulates a TLS client_hello message. Such EAP-Response message, denoted as EAP-Response/EAP-TLS [client_hello], is encapsulated in an L2 message.\n7b.\tThe W-AGF forwards the EAP-Response/EAP-TLS [client_hello] to the AMF/SEAF in an Authentication Response message.\n7c.\tThe AMF/SEAF forwards the EAP-Response/EAP-TLS [client_hello] message to the AUSF in a Nausf_UEAuthentication_Authenticate Request message.\n8a.\tThe AUSF replies to the AMF/SEAF with EAP-Request/EAP-TLS message whose data field encapsulates a TLS server_hello message, a TLS server certificate message, a TLS server_key_exchange message, a TLS client certificate_request message, and a TLS server_hello_done message. Such EAP-Request message, denoted as EAP-Request/EAP-TLS [server_hello], is encapsulated in a Nausf_UEAuthentication_Authenticate Response message.\n8b.\tThe AMF/SEAF forwards the EAP-Request/EAP-TLS [server_hello] message to the W-AGF in an Authentication Request message.\n8c. The W-AGF forwards the EAP-Request/EAP-TLS [server_hello] to the N5GC device in an L2 message.\n9.\tThe N5GC device authenticates the AUSF by validating the server certificate included in the EAP-Request/EAP-TLS [server_hello] message received in step 8c. The N5GC device needs to be provisioned with certificates of a trust anchor to validate the AUSF server certificate. In addition, the N5GC device also needs to be provisioned with its own client certificate.\n10a. If the TLS server authentication is successful, then the N5GC device replies to the W-AGF with EAP-Response/EAP-TLS in an L2 message. The data field of the EAP-Response/EAP-TLS message contains a TLS client certificate message, a TLS client_key_exchange message, a TLS certificate_verify message, a TLS change_cipher_spec message, and TLS finished message. This EAP-Response message is denoted as EAP-Response/EAP-TLS [client_certificate].\n10b. The W-AGF forwards to the AMF/SEAF the EAP-Response/EAP-TLS [client_certificate] in an Authentication Response message.\n10c. The AMF/SEAF forwards the EAP-Response/EAP-TLS [client_certificate] message to the AUSF in a Nausf_UEAuthentication_Authenticate Request message.\n11.\tThe AUSF authenticates the N5GC device by verifying the client certificate received in the EAP-Response/EAP-TLS [client_certificate] message. Among other validations, the AUSF verifies that the client certificate is issued by a certificate authority trusted by the AUSF. If the client certificate is verified successfully, the AUSF continues to step 12a. Otherwise the AUSF returns an EAP-failure message. The AUSF needs to be provisioned with certificates of trust anchor to verify client certificates.\n12a. The AUSF sends to the AMF/SEAF an EAP-Request/EAP-TLS message with its data field encapsulating a TLS change_cipher_spec message and a TLS server finished. This EAP-Request message, denoted as EAP-Request/EAP-TLS [server_finished], is encapsulated in a Nausf_UEAuthentication_Authenticate Response message.\n12b. The AMF/SEAF forwards EAP-Request/EAP-TLS [server_finished] message to the W-AGF in an Authentication Request message.\n12c. The W-AGF forwards EAP-Request/EAP-TLS [server_finished] message to the N5GC device in an L2 message.\n13a. The N5GC sends to the W-AGF an EAP-Response/EAP-TLS message with its data field set to empty, denoted as EAP-Response/EAP-TLS [empty], in an L2 message\n13b. The W-AGF forwards to the AMF/SEAF the EAP-Response/EAP-TLS [empty] message in an Authentication Response message.\n13c. The AMF/SEAF forwards the EAP-Response/EAP-TLS [empty] message to the AUSF in a Nausf_UEAuthentication_Authenticate Request message.\n14a. The AUSF sends to the AMF/SEAF an EAP-Success message and the MSK along with the SUPI in a Nausf_UEAuthentication_Authenticate Response message. If the SUPI received from the UDM in step 5c is anonymous, the AUSF derives the SUPI from the client identifier in the TLS client certificate. AUSF does not perform the derivation of KAUSF nor KSEAF based on the MSK indicator received in step 5c.\nNOTE 2a:\tIt is left to implementation if the AUSF verifies that the SUPI derived from the client certificate belongs to a valid susbcription in the network and returns an EAP-failure message if there is a miss-match.\n14b. The AMF/SEAF forwards to the W-AGF the EAP-Success message and the MSK in an Authentication Result message or a Security Mode Command message.\n14c. The W-AGF forwards to the N5GC device the EAP-Success message in an L2 message, and the authentication procedure is finished.\nNOTE 3:\tNeither the AUSF nor the N5GC device performs further 5G related key derivation from EMSK, since neither 5G AS nor 5G NAS security is used in this setting.\n15. The AUSF sends a UDM_Nudm_UEAuthentication_ResultConfirmation Request message to the UDM, including the SUPI obtained from the TLS client certificate, SN-name, the authentication method (i.e., EAP-TLS), the authentication result, and a timestamp.\n16. The UDM stores the authentication result accordingly.\n17. The UDM sends a UDM_Nudm_UEAuthentication_ResultConfirmation Response message to the AUSF.\n18. The AMF sends a Nudm_UEContextManagement_Registration Request message to the UDM.\n19. The UDM authorizes the registration request based on authentication result stored in step 16 and other information (e.g., UE subscription profile).\n20. The UDM sends a Nudm_UEContextManagement_Registration Response message to the AMF.\n21. The AMF sends Registration Accept message to the W-AGF\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "P.1\tGeneral",
            "description": "This annex specifies security measures to protect DNS and ICMP messages. These security measures are intended when integrity protection over the user plane can not be used.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "P.2\tSecurity aspects of DNS",
            "description": "It is recommended that the UE and DNS server(s) support DNS over (D)TLS as specified in RFC 7858 [83] and RFC 8310 [84]. The DNS server(s) that are deployed within the 3GPP network can enforce the use of DNS over (D)TLS. The UE can be pre-configured with the DNS server security information (out-of-band configurations specified in the IETF RFCs like, credentials to authenticate the DNS server, supported security mechanisms, port number, etc.), or the core network can configure the DNS server security information to the UE.\nNOTE:\tThe use of DNS over (D)TLS with DNS server(s) that are deployed outside the 3GPP network is outside the scope of this document.\nWhen DNS over (D)TLS is used, a TLS cipher suite that supports integrity protection needs to be negotiated.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "P.3\tSecurity aspects of ICMP",
            "description": "ICMP (Internet Control Message Protocol) is part of the internet protocol (IP) suite. The lack of security in ICMP may be exploited to launch further attacks on the 3GPP system. To mitigate such attacks, it is recommended that the use of ICMP is restricted in the UE and the UPF (e.g., by default, use of ICMP is not allowed). In scenarios where the use of ICMP is required, it is recommended that one or more of following mitigations be enforced:\n-\tDisable the UE from responding to ICMP requests received over 3GPP network interface(s).\n-\tInstall IP filter(s) at the UPF in order to block ICMP messages. This filter can be activated either on a per N4 Session basis or on a UPF basis. For ICMPv6, the recommendations in RFC 4890 [85] can be used for filtering ICMPv6 messages.\n-\tLimit the maximum size of ICMP messages (e.g., to 64 bytes). Any ICMP messages that are greater than this limit needs to be dropped by the UE as well as by the UPF.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Q.1\tGeneral",
            "description": "For security and privacy in 5GS LCS (5G System Location Services), the mechanisms defined in TS 23.273 [86] and TS 38.305 [87] apply.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Q.2\tSecurity in 5G system location services to support user plane positioning",
            "description": "The UE establishes a user plane connection to the LMF or AF as specified in TS 23.273 [86].\nFor the protection of the interface, a TLS based mechanism shall be supported.\nTS 23.501 [2], Annex E, summarizes the different communication models that NF and NF services can use to interact with each other.\nFigures R-1 and R-2 provide an overview of the authorization aspects in the different models, as described in detail in clause 13.\n\nThe figure depicts a simplified representation of direct deployment models, illustrating the authorization aspects in the context of direct deployment. It shows the various roles and permissions required for different users, such as the network administrator, network operator, and end-user, to access and control the network. The figure also highlights the importance of user authentication and authorization in ensuring secure network operations.\nFigure R-1: Illustration of authorization aspects in direct deployment models\n\nThe figure depicts a simplified representation of the authorization aspects in indirect deployment models, illustrating the various stages of authorization processes. It shows the stages of authorization, including authorization request, authorization decision, and authorization execution. The figure also includes a flowchart to illustrate the flow of authorization, with different stages represented by different colored lines. The figure is a visual aid to understand the authorization process in indirect deployment models and can be used to guide the design and implementation of authorization systems.\nFigure R-2: Illustration of authorization aspects in indirect deployment models\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "S.1\tIntroduction",
            "description": "Non-seamless WLAN offload (NSWO) is an optional capability of a UE supporting WLAN radio access. A UE supporting non-seamless WLAN offload may, while connected to WLAN access, route specific IP flows via the WLAN access without traversing the 3GPP core network.\nThe present annex specifies the support for authentication for NSWO in 5GS (5G NSWO).\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "S.2\tGeneral",
            "description": "5G NSWO shall use EAP-AKA’, as specified in RFC 5448 [12], for authentication. The EAP-AKA’ implementations shall comply with the EAP-AKA’ profile specified in Annex F of the present document.\nA new network function, called NSWOF, is introduced to support authentication for NSWO in 5GS. The NSWOF interfaces to the WLAN access network using SWa interface and interfaces to the AUSF using Service Based Interface (SBI).\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "S.3\tAuthentication procedure",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "S.3.1\t5G NSWO co-existence with EPS NSWO",
                    "description": "",
                    "summary": "",
                    "text_content": "An HPLMN that supports 5G NWSO and wants the UE to use 5G NSWO shall configure the UE to use 5G NSWO. This configuration shall be either on the USIM or ME, with configuration on the USIM taking precedence over the ME.\nA UE that supports 5G NSWO and is configured to use 5G NSWO shall always use 5G NSWO as described in clause S.3.2 (i.e., it shall not use EPS NSWO defined in TS 23.402[97]). Otherwise, the UE may use EPS NSWO (e.g., UE does not support 5G NSWO or not configured to use 5G NSWO).\nNOTE: Such a configuration ensures that the UE supporting 5G NSWO cannot be downgraded to use EPS NSWO.\nThe network may support both 5G NSWO and EPS NSWO. In such a case, the routing of the AAA messages is determined by the network based on the realm part of the UE Identity (e.g., realm contains epc.mnc<MNC>.mcc<MCC>.3gppnetwork.org (EPS NSWO) or 5gc-nswo.mnc<MNC>.mcc<MCC>.3gppnetwork.org (5G NSWO)). Which entities in the network perform this routing decision is dependent on the network configuration.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "S.3.2\t5G NSWO procedures",
                    "description": "",
                    "summary": "",
                    "text_content": "The figure depicts the authentication procedure for NSWO in a 5G system, showing the steps involved in verifying the identity of a user. The authentication process is crucial for ensuring secure communication, as it prevents unauthorized access to sensitive data.\nFigure: S.3-1: Authentication procedure for NSWO in 5GS\n1. The UE establishes a WLAN connection between the UE and the WLAN Access Network (AN), using procedures specified in IEEE 802.11[80].\n2. The WLAN AN sends an EAP Identity/Request to the UE.\n3. The UE sends an EAP Response/Identity message. If the UE determines to use the NSWO service, the UE shall use the SUCI in NAI format (as specified in TS 23.003 [19], clause 28.7.12 and clause 28.7.9.2) as its identity irrespective of whether SUPI Type configured on the USIM is IMSI or NAI. If the SUPI Type configured on the USIM is IMSI, the UE shall construct the SUCI in NAI format with username containing the encrypted MSIN and the realm part containing the MCC/MNC.\n4. The EAP Response/Identity message shall be routed over the SWa interface towards the NSWOF based on the realm part of the SUCI.\nNOTE 1: NSWOF acts as SBI/AAA proxy between the AUSF and the WLAN Access Network.\n5. The NSWOF shall send the message Nausf_UEAuthentication_Authenticate Request with SUCI, Access Network Identity and NSWO indicator towards the AUSF. NSWO_indicator is used to indicate to the AUSF that the authentication request is for Non-seamless WLAN offload purposes. The NSWOF shall set the Access Network Identity to \"5G:NSWO\".\n6. Based on the NSWO_indicator, the AUSF (acting as the EAP authentication server) shall send a Nudm_UEAuthentication_Get Request to the UDM, including SUCI and the Access Network Identity and NSWO indicator.\n7. Upon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke SIDF. SIDF shall de-conceal SUCI to gain SUPI before UDM can process the request. Based on the NSWO indicator, the UDM/ARPF shall select the EAP-AKA´ authentication method and generate an authentication vector using the Access Network Identity as the KDF input parameter. The UDM shall include the EAP-AKA’ authentication vector (RAND, AUTN, XRES, CK´ and IK´) and may include SUPI to AUSF in a Nudm_UEAuthentication_Get Response message.\n8. The AUSF shall store XRES for future verification. The AUSF shall send the EAP-Request/AKA'-Challenge message to the NSWOF in a Nausf_UEAuthentication_Authenticate Response message.\nNOTE:\tThe Access Network Identity is carried in the AT_KDF_INPUT attribute in EAP-AKA' as defined in RFC 5448 [12].\n9. The NSWOF shall send the EAP-Request/AKA'-Challenge message to the WLAN AN over the SWa interface.\n10. The WLAN AN forwards the EAP-Request/AKA'-Challenge message to the UE.\n11. At receipt of the RAND and AUTN in the EAP-Request/AKA'-Challenge message, the ME shall obtain the Access Network Identity from the EAP signalling and the USIM in the UE shall verify the freshness of the AV' by checking whether AUTN can be accepted as described in TS 33.102 [40]. If so, the USIM computes a response RES. The USIM shall return RES, CK, IK to the ME. The ME shall derive CK' and IK' using the Access Network Identity as the KDF input parameter. If the verification of the AUTN fails on the USIM, then the USIM and ME shall proceed as described in sub-clause 6.1.3.3. The UE may derive MSK from CK’ and IK’ as per Annex F and as described in RFC 5448[12]. When the UE is performing NSWO authentication, the KAUSF shall not be generated by the UE.\n12. The UE shall send the EAP-Response/AKA'-Challenge message to the WLAN AN.\n13. The WLAN AN forwards the EAP-Response/AKA'-Challenge message over the SWa interface to the NSWOF.\n14. The NSWOF shall send the Nausf_UEAuthentication_Authenticate Request with EAP-Response/AKA'-Challenge message to AUSF.\n15. The AUSF shall verify if the received response RES matches the stored and expected response XRES. If the AUSF has successfully verified, it continues as follows to step 16, otherwise it returns an error to the NSWOF. The AUSF shall derive the required MSK key from CK’ and IK’ as per Annex F and as described in RFC 5448[12], based on the NSWO indicator received in step 5. The AUSF shall not generate the KAUSF.\n16. The AUSF shall send Nausf_UEAuthentication_Authenticate Response message with EAP-Success and MSK key to NSWOF. The AUSF may optionally provide the SUPI to NSWOF. The AUSF/UDM shall not perform the linking increased home control to subsequent procedures (as stated in present document clause 6.1.4).\n17. The NSWOF shall send the EAP-success and MSK to WLAN AN over the SWa interface. The EAP-Success message is forwarded from WLAN AN to the UE.\n18. Upon receiving the EAP-Success message, the UE derives the MSK as specified in step 11, if it has not derived the MSK earlier. The UE uses the first 256-bit of MSK as PMK to perform 4-way handshake to establish a secure connection with the WLAN AN.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "S.4\tRoaming",
            "description": "The HPLMN may have a roaming agreement with a VPLMN for NSWO roaming. A roaming UE configured by the HPLMN to use 5G NSWO may try to register onto a WLAN AN that may advertise the HPLMN or a VPLMN (with which the HPLMN has a roaming agreement for NSWO roaming). The roaming architecture options are described in clause 4.2.15 in TS 23.501 [2].\n\nNOTE: \tVoid\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "T.1\tGeneral",
            "description": "The 5G Edge computing service is described in 3GPP TS 23.548 [98]. It defines the enhancements of 5G System to support Edge Computing.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "T.2\tSecurity of network exposure to edge application server",
            "description": "It is defined in the TS 23.548 [98] clause 6.4 that the network could expose network information to the local AF with two scenarios, i.e.\n-\tCase 1: L-PSA UPF may expose the network information to local AF via Local NEF,\n-\tCase 2: or L-PSA UPF may expose the network information to local AF directly. However, How to deliver the information on N6 is out of scope.\nFor the Case 1, the Security aspects of Network Exposure Function specified in clause 12 shall be used for the network information exposure.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "T.3\tSecurity of EAS discovery procedure via EASDF in non-roaming Scenario",
            "description": "Annex P of the present document should be followed, with the following additions, to protect the discovery messages between the UE and the EASDF which is used as the DNS server for EAS discovery in the non-roaming case. If the core network is used to configure the security information, the SMF is preconfigured with the EASDF security information (credentials to authenticate the EASDF, supported security mechanisms, port number, etc.) and provides the security information to the UE as follows:\nThe SMF provides the EASDF security information to the UE via PCO.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "T.4\tSecurity of EAS discovery procedure via V-EASDF in roaming Scenario",
                    "description": "",
                    "summary": "",
                    "text_content": "Annex P of the present document should be followed, with the following additions, to protect the discovery messages between the UE and the V-EASDF which is used as the DNS server for EAS discovery in the roaming case.  If the core network is used to configure the security information, the V-SMF is preconfigured with the V-EASDF security information (credentials to authenticate the V-EASDF, supported security mechanisms, port number, etc.) and provides the security information to the UE as follows:\n-\tIn the case of LBO roaming, the V-SMF provides the V-EASDF security information to the UE via PCO.\n-\tIn the case of HR with Session Breakout (HR-SBO) roaming scenarios, during the PDU session establishment or modification procedure, the V-SMF provides the V-EASDF security information via Nsmf_PDUSession_Create/ Nsmf_PDUSession_Update to H-SMF when the V-SMF determines to use a V-EASDF for EAS discovery, and the H-SMF provides the V-EASDF security information to UE via PCO if HR SBO is authorized.\nNOTE: The security information of V-EASDF provided to the UE is only related with the VPLMN parameter.\n\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "U.1\tIntroduction",
            "description": "In SNPN, when a credential holder is located outside of the 5GC of the SNPN, EAP-TTLS can be used to authenticate the UE.  EAP-TTLS consists of two phases of authentication. In the first phase, a TLS tunnel is established between the UE and the EAP-TTLS server on AUSF. In the second phase, a legacy authentication protocol can be run between the UE and the credential holder (namely AAA) through the established TLS tunnel.\nAfter the successful completion of EAP-TTLS, the AUSF and the UE derive the KAUSF from the EMSK.\nUE is provisioned with a trust anchor to enable verification of the EAP-TTLS server certificate. The provisioning of trust anchor on the UE is outside the scope of this document.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "U.2\tProcedure",
            "description": "\nThe figure depicts a primary authentication method using EAP-TTLS and AAA (Authentication, Authorization, and Accounting) protocols. It illustrates the steps involved in authenticating a user, including the use of EAP-TTLS for secure data transmission and the use of AAA for managing user access rights. The figure also includes a visual representation of the network topology, showing the connection between the primary authentication server and the user's device.\nFigure: U.2-1: Primary authentication using EAP-TTLS and AAA\n0.\tThe UE is configured with the trust anchor needed to authenticate the certificate of the EAP-TTLS server running on the AUSF. Further, the UE is configured with the credentials required to authenticate with the AAA server.\nSteps 1-17 are same as the steps 1-17 in clause B.2.2.1 in Annex B, except in the following steps:\n1.\tThe SUPI in the NAI format, i.e., username@realm, is used.\n5.\tEAP-TTLS is selected by the UDM as the authentication method.\n6-17. EAP-TTLS phase 1 is executed between the AUSF and the UE. EAP-Type is set to EAP-TTLS and the authentication of the UE using TLS client certificate is skipped. Since TLS client certificate is not used in EAP-TTLS, the UE need not be configured with UE certificate.\n18-27.  After EAP-TTLS phase 1 is successfully completed, the UE runs EAP-TTLS phase 2 authentication with the AAA as specified in RFC 5281 [99] via NSSAAF. The phase 2 authentication method used is outside the scope of the present document but MS-CHAPv2 is depicted here as an example to show that the Nnssaaf_AIW_Authentication service offered by NSSAAF carries AVPs if the phase 2 authentication method is non-EAP.NOTE: \tAs referenced in section 14.1.11 of RFC 5281 [99], allowing the use of phase 2 (inner) authentication method outside of tunnelled protocol leads to Man-in-the-Middle (MitM) vulnerability. Thus, it is assumed that the UE does not allow the use of phase 2 authentication method outside of TLS tunnel (i.e., the UE does not respond to requests for phase 2 authentication outside of the TLS tunnel). In environments where the use of phase 2 authentication outside of the tunnelled protocol cannot be prevented, EAP-TTLS implementations need to address this vulnerability by using EAP channel binding or cryptographic binding described in RFC 6678 [100].\n28-31. After EAP-TTLS phase 2 authentication is successfully completed, the rest of the procedures are same as steps 18- 21 described in clause B.2.1.1, except that the EAP-Type is set to EAP-TTLS in the EAP Response message from the UE to the AUSF.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "V.1\tGeneral",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "V.1.1\tScope",
                    "description": "",
                    "summary": "",
                    "text_content": "User consent can be required for 3GPP features depending on local regulations. Therefore, this annex describes the generic security requirements and procedures to support user consent enforcement in 3GPP services. While the use cases can differ, the annex focuses on the common and generic aspects related to the storage, checking and revocation of the user consent.\nThe user consent related requirements and mechanism in the present document are applicable only when it is required by regional regulations or operator’s local policy, not otherwise.\nThe term data processing in this annex is used to convey the same meaning as in [101].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "V.1.2\tRelationship between end-users and subscriber",
                    "description": "",
                    "summary": "",
                    "text_content": "It is assumed that the user consent is obtained from the end-users. The end-user(s) is the subscriber itself or authorize the subscriber to provide consent on behalf of the end-users. Alternatively, the end-users are authorized by the subscriber to provide the consent. That means user consent is always tied to the subscription information. How authorization is provided between the subscriber and the end-users is out-of-scope of this specification.\nNOTE: The term end-user is defined in TR 21.905 [1].\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "V.2\tRequirements",
            "description": "The UDM shall support the following services related to the user consent.\n-\tRetrieval of user consent parameters.\n-\tNotification of user consent parameters change.\nThe user consent parameters shall be stored in the UDM/UDR as subscription data.\nThe user consent parameters shall be bound to a SUPI/GPSI.\nThe user consent parameters shall be bound to the purpose of data processing.\nThe user consent parameters shall include whether the user consent is granted or not.\nThe user consent shall be effective only after the point in time that user consent was given.The user consent shall be effective until revoked. It means that there is no expiry/validity timer for the user consent parameters stored in the subscription data.\nNOTE:\tUDM does not provide user consent revocation service, it only provides notifications of user consent parameter changes.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "V.3\tUser consent check",
            "description": "Any NF that is deemed an enforcement point for user consent shall support to retrieve the user consent parameters from the UDM.\nAny NF that is deemed an enforcement point for user consent shall not accept any services or requests for data processing unless user consent is granted.\nAny NF that is deemed an enforcement point for user consent shall determine the purpose of data processing prior to the data processing. If the purpose of data processing is not implicitly known from the service request, the user consent enforcement point shall request it or otherwise deny the service.\nNFs obtaining or checking the user consent parameters shall consider the user consent parameters as effective until revoked.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "V.4\tUser consent revocation",
            "description": "Any NF that is deemed an enforcement point for user consent shall support subscription to the user consent parameter change notification provided by the UDM.\nConsumer NFs (processing the data pertaining to user consent) shall subscribe to UDM for user consent parameter change notification, except if the consent enforcement NF that is deemed an enforcement point is tracking of those NFs and is actively informing those consumer NFs in case of user consent revocation.\nNOTE: \tWhen authorization consumer NFs for data processing subject to user consent, care needs to be taken to not authorize requests by those consumers that do not support the necessary services or related parameters for revocation. This is important because the user consent may change in the future.\nUpon notification of user consent revocation, any NF that is deemed an enforcement point for user consent shall no longer accept any service request for data processing subject to a revoked user consent.\nUpon notification of user consent revocation, any NF that is deemed an enforcement point for user consent may notify other NFs to halt the processing of the data subject to the revoked user consent.\nUpon notification of user consent revocation, NFs (processing the data pertaining to the revoked consent) shall halt processing and collection of the data.\nUpon notification of user consent revocation, NFs may delete, quarantine, or temporarily retain the data pertaining to the revoked user consent based on local policies and legal constraints.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "W.1\tGeneral",
            "description": "This clause describes the security requirements, procedures and handling for 5G Multicast/Broadcast Service (MBS).The general features for 5G MBS are described in TS 23.247 [103].\nNOTE: Security for Multicast-broadcast service for roaming is not supported.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "W.2\tSecurity requirements",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "W.2.1\tRequirements of MBSF",
                    "description": "",
                    "summary": "",
                    "text_content": "The security requirements on the NEF described in clause 5.9.2.3 of present document also apply to MBSF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "W.2.2\tRequirements of MBSTF",
                    "description": "",
                    "summary": "",
                    "text_content": "The security requirements on the NEF described in clause 5.9.2.3 of present document also apply to MBSTF.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "W.3\tSecurity mechanisms for xMB-C/MB2-C and xMB-U/MB2-U interface",
            "description": "The security aspects defined in clause 12 in present document is applicable for both MBSF and MBSTF. TLS based solution are reused to protect the interface xMB-C/MB2-C and xMB-U/MB2-U between AF and 5GC in MBS.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "W.4\tSecurity mechanisms for MBS traffic transmission",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "W.4.1\tKey derivation, management and distribution",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "W.4.1.1\tGeneral",
                            "text_content": "If the security protection of MBS traffic is required, confidentiality and integrity protection as specified in clause 5.3 of TS 33.246 [102] apply. The control-plane procedure and user-plane procedure are optionally supported in service layer. The control-plane procedure is only applicable for multicast sessions, while the user-plane procedure is applicable for both multicast sessions and broadcast sessions. The user plane  security between UE and RAN shall be deactivated  when 5GC shared MBS traffic delivery method for MBS data transmission is used to avoid redundant protection.\nThe MBS Security Function (MBSSF) is a logical function, which needs to be collocated with either MBSF or MBSTF and the according interfaces are up to the implementation of the deployment options. In case of the control-plane procedure, the key derivation, management and distribution in MBSF and MBSTF can be achieved in MBSSF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "W.4.1.2\tControl-plane procedure",
                            "text_content": "The multicast session security context consists of the MBS session ID, MBS keys and the corresponding key ID. The MBS keys include MBS Service Key (MSK) and MBS Traffic Key (MTK). MBS traffic is protected with the MTK. The MSK is used to protect the MTK when the MTK is delivered to the UE. The identification for every MSK and MTK are determined as specified in Clause 6.3.2.1 and clause 6.3.3.1 of TS 33.246 [102].\nThe MBSF determines whether security protection to be applied or not for the MBS session based on locally configured policy or based on the information provided by the AF. If security protection to be applied, then the MBSF shall create the multicast session security context by generating the MSK and its key ID for a MBS session. Afterwards, the MBSF distributes the MSK with MBS session ID and its key ID to the MB-SMF and MBSTF. The MBSF shall also distribute them to MB-SMF either upon request by the MB-SMF (i.e., pull) or when a new MSK is generated (i.e., push). The MBSF may also include the MSK lifetime when it distributes the MSK to MBSTF.\nUpon receiving the MSK from the MBSF, the MBSTF generates the MTK and its key ID for the MBS traffic protection. A new MTK may be generated based on the MBS session security policy. When the MBSTF generates a new MTK, the MBSTF shall multicast the MTK and its key ID after protecting it using the MSK as specified in TS 33.246 [102]. The MBSTF shall also provide the new MTK and its key ID to the MBSF.\nDuring the MBS session creation for multicast communication as specified in clause 7.1.1 of TS 23.247 [103], after receiving the description for an MBS session from the AF of content provider, the MBSF shall create the multicast session security context by generating an MSK and acquiring an MTK from the MBSTF. Afterwards, the MBSF distributes the muticast session security context to the MB-SMF via the Nmbsmf_MBSSession_Create Request message.\nIn the multicast session join and session establishment procedure, the SMF interacts with the MB-SMF to obtain the multicast session security context with Nmbsmf_MBSSession_ContextStatusSubscribe service. Absence of the multicast security context indicates that security protection is not applied for the MBS session. The SMF shall provide the multicast session security context in the N1 SM container (PDU Session Modification Command) to the UE if received from the MB-SMF and the UE is authorized to use the required multicast service. The UE shall use the MTK in the received multicast session security context, to process the protected MBS traffic until it receives a new MTK update over the user-plane.\nThe MSK update may be triggered by MB-SMF based on the request from AS or based on the local policy (e.g., key lifetime expiration). When the MSK is updated, the MBSF shall send the new MSK with MBS session ID and its key ID to the MB-SMF and then the MB-SMF shall trigger the session update as specified in clause 7.2.6 in TS 23.247 [103]. The MSK with MBS session ID and the corresponding key ID are delivered to the UEs that has joined the multicast session.  The MBSF shall also send the new MSK with MBS session ID and its key ID to the MBSTF. The MBSTF may request a MSK to the MBSF when it does not have a valid MSK (e.g., due to the current MSK expiration).\nNOTE 1: For an inactive MBS session, MBSTF defers MSK distribution until the MBS session is re-activated.\nThe MTK may be updated based on the change of the authorization information or based on the local policy (e.g. key lifetime expiration). In such cases, the MBSF or MB-SMF may trigger the MTK update to the MBSTF. The key update request message shall include the MBS session ID. If the MBSTF has generated a new MTK, the MBSTF shall provide the new MTK to the MBSF. To improve the efficiency of MTK update, the updated MTK is delivered from MBSTF to the UE using MIKEY over UDP as specified in clause 6.3.3.2 in TS 33.246 [102]. The MSK is used to protect the updated MTK. The UE shall not send an error message to the MBSTF as a result of receiving an MTK message.\nNOTE 2: For an inactive MBS session, MBSTF defers the MTK distribution until the session in re-activated.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "W.4.1.3\tUser-plane procedure",
                            "text_content": "The UE registers to the MBS service and receives the MBS traffic as specified in TS 33.246 [102] with the following changes.\n-\tMBSSF takes the role of the BM-SC in TS 33.246 [102].\n-\tThe UE authenticates to the MBSSF (i.e. MBSF or MBSTF) based on the GBA as in MBMS security (see TS 33.246 [102]) or based on the AKMA (see TS 33.535 [104]). When the AKMA is used, the MRK is derived from the KAF as specified in Annex F of TS 33.246 [102] by replacing the Ks_NAF for the GBA_ME run with KAF. Furthermore, when the AKMA is used, the MUK is set to KAF. When the authorization of MBS service to the UE is required, the user id (e.g., GPSI) provided to the MBSSF by the AAnF shall be used.\nNOTE a:\tVoid\n-\tThe identifier(s) of MBS user service(s) in TS 26.502[108] is included in local configuration in MBSSF or in UDM as part of MBS subscription data for a UE, which identifies the user service(s) that the UE is allowed to join. After receiving the HTTP POST message (see clause 6.3.2 of TS 33.246 [102]) that] includes the identifier(s) of MBS user service(s), MBSSF shall authorize the UE based on local configuration if available. If no local configuration is available, the MBSSF should send verification request with user id (e.g., IMPI in GBA or GPSI in AKMA) and identifier(s) of MBS user service(s) to UDM to acquire the authorization result. If the UE is authorized, the MBSSF registers the UE to the MBS user service(s).\nNOTE: the local configuration in MBSSF may be preconfigured or provided by AF.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                },
                {
                    "title": "W.4.2\tProtection of the traffic transmission",
                    "description": "",
                    "summary": "",
                    "text_content": "The traffic may require some protection depending on the sensitivity of the data being transmitted. For example, it is possible that the data being transmitted is actually protected by the application layer security and hence might not require additional protection. However, the protection in service layer is independent of application layer security.\nThe service protection description in the Service Announcement implies the protection requirement of the traffic transmission in case the security protection is provided in service layer. It may include indications for which security procedures are supported by the network: control-plane procedure or user-plane procedure. If the support for user-plane procedure is indicated then the description should include also an indication of whether GBA or/and AKMA is supported.\nNOTE: If the security protection in service layer is not required, the service protection description is not present in the Service Announcement. If the UE does not support the network selected MBS security procedure at the service layer, then the UE can obtain the service via unicast delivery.\nThe actual method of protection may vary depending on the type of data being transmitted, e.g. media streaming application or file download. Clause 6.6.2 and clause 6.6.3 in TS 33.246 [102] apply to the protection of streaming data and protection of download data, respectively.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "W.4.3\tAuthentication and authorization aspects for the multicast session",
                    "description": "",
                    "summary": "",
                    "text_content": "The support for the optional-to-use authentication and authorization procedure for a 5G multicast session is specified in this clause.\nAKMA/GBA is supported for authentication and authorization in user-plane procedure for security protection of MBS traffic, as specified in clause W.4.1.3 of the present document.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "W.4.4\tSecurity handling in network sharing scenario",
                    "description": "",
                    "summary": "",
                    "text_content": "In Multiple-Operator Core Network (MOCN) network sharing scenarios, if MBS content protection is needed, then the content may be protected at the application layer (c.f., W.4.2).\nNOTE 1:\tThe content protection mechanism used at the application layer is outside the scope of 3GPP.\nIf service-layer security specified in clause W.4.1.3 of the present document is used in MOCN network sharing scenarios, the AF may be required to generate the MSK, MSK ID, MTK and MTK ID common to the participating PLMNs. The AF provides the generated MSK, MSK ID, MTK and MTK ID to the MBSSF(s) of the participating PLMNs, when creating broadcast MBS sessions and also when key update is required. Furthermore, it is up to the AF to select a MCC and MNC among the PLMNs for the Key Domain ID. As mentioned in clause 6.3.2.1 of TS 33.246 [102], the UE should not try to use the MCC and MNC in another context, e.g., the UE should not compare the received MCC || MNC to parameters in radio level.\nNOTE 2: Security aspects between the AF and the MBSSF(s) is outside the scope of 3GPP.\nNOTE 3: If the MBSSF uses MSK and MTK generated by itself to protect the traffic, the resource sharing during network sharing will not be used.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                }
            ]
        },
        {
            "title": "W.5\tSecurity protection for interworking between 5MBS and eMBMS",
            "description": "Interworking between 5G MBS and eMBMS is supported at service layer.  The procedures for inter system mobility with interworking at service layer is specified in clause 7.4 in TS 23.247 [103].\nThe joint BM-SC+MBSF/MBSTF functionality provides the security protection for MBS traffic. During inter-system mobility, when the target system is EPS, the security protection specified in TS 33.246 [102] applies. The security protection specified in present document applies to the case when the target system is 5GS.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "X.1\tGeneral",
            "description": "This Annex provides security requirements and procedures for the Network Automation features.\nThe feature for enablers for Network Automation by 5GS is described in 3GPP TS23.501[2] and 3GPP TS23.288 [105].\nX.2\tAuthorization of NF Service Consumers for data access via DCCF\nThe detailed procedure for NF Service Consumer to receive data from Service Producers via DCCF is depicted in Figure X.2-1:\n\nThe figure depicts a simplified representation of NF Service Consumer Authorization (SCA) to receive data from NF Service Producers (NSP) via Data Center Connectivity (DCCF). It illustrates the process of authorization, including the authorization request, authorization response, and authorization confirmation. The figure is a simplified representation, with the NF Service Producers (NSP) represented as a single entity, and the Data Center Connectivity (DCCF) as a separate entity. The figure is used to illustrate the authorization process in a NF Service environment, where NF Service Producers (NSP) are responsible for providing data to NF Service Consumers (SCs) through DCCF.\nFigure X.2-1: NF Service Consumer Authorization to receive data from NF Service Producers via DCCF\n1-3. NF Service Consumer shall send a request to the NRF to receive an access token to request services of DCCF, to be used for data collection request. NRF after verifying shall generate access token and sends it to the NF Service Consumer.\n4.\tThe NF Service Consumer initiates a NF service request to the DCCF which includes the access_token_nwdaf. The NF Service Consumer shall also generate a Client Credentials Assertion (CCA) token (CCA_NWDAF) as described in the clause 13.3.8 and includes it in the request message in order to authenticate itself towards the NF Service Producers.\nNOTE 0: The procedure of NF Service Consumer (e.g. NWDAF) requesting the services provided by NF Service Producer via DCCF is defined in Clause 6.2.6.3 of TS 23.288 [105].\n5.\tThe DCCF shall verify if the access_token_nwdaf is valid and executes the service. If the NRF does not support authorization of the source NF (e.g. NWDAF) for data access via the DCCF (e.g. if the NRF is Rel-16), the DCCF authorizes the data access of the NF Service Consumer.\n6.\tThe DCCF determines the NF Service Producer(s) from where the data is to be collected (as specified in Clause 6.2.6.3.2 in TS 23.288[105]).\nNOTE 1: \tIf the NF Service Consumer sends the NF Service Producer information (i.e. NF Service Producer type and Instance ID) along with the service request in Step 4, then DCCF does not determine the NF Service Producer, but requests an access token from the NRF using the NF Service Producer details sent by the NF Service Consumer (as described in Step 7).\n7.\tThe DCCF sends a Nnrf_AccessToken_Get request to NRF including the information to identify the target NF (NF Service Producer), the source NF (NF Service Consumer e.g. NWDAF), the NF Instance ID of DCCF and the CCA_NWDAF provided by the NF Service Consumer. The nfInstanceId IE attribute in the access token request (Nnrf_AccessToken_Get) indicates the NF instance ID of the DCCF as intermediate NF Service Consumer, whereas the sourceNfInstanceId IE attribute indicates the source NF instance ID (NF Service Consumer e.g., NWDAF).\nNOTE 1a: Void\n8.\tThe NRF shall check whether the DCCF and the NF Service Consumer (e.g. NWDAF) are allowed to access the service provided by the identified NF Service Producers, and the DCCF as the proxy is allowed to request the service from the identified NF Service Producers on behalf the NF Service Consumer. NRF authenticates both DCCF and NWDAF based on one of the SBA methods described in clause 13.3.1.2.\nNOTE 2: A Rel-16 NRF only authenticates and authorizes the DCCF, i.e., after the NRF receives Nnrf_AccessToken_Get request, the NRF validates whether the intermediate NF Service Consumer (e.g., DCCF) is authorized to receive the requested service from the NF Service Producer. The NRF from Rel-16 or earlier does not validate whether the source NF Service Consumer (e.g., NWDAF) is authorized to receive the requested service.\nNOTE 3: Void\n9.\tThe NRF after successful verification then generates and provides an access token to the DCCF as described in the clause 13.4.1.1.2, with NF Instance ID of the DCCF (subject), and an additional access token claim containing the identity ofthe source NF Service Consumer, in order to authorize both DCCF and NF Service Consumer (e.g.. NWDAF) to consume the services of NF Service Producer.\nNOTE 4: In the case the NRF is from Rel-16 or earlier, the NRF generates an OAuth2.0 access token with “subject” claim mapped to the intermediate NF Service Consumer, i.e., in this case DCCF,  and no additional claim for the source NF Service Consumer (e.g., NWDAF) identity is added.\n10.\tThe DCCF requests service from the NF Service Producer. The request also contains the content of the CCA_NWDAF, so that the NF Service Producer(s) authenticates the NF Service Consumer (e.g. NWDAF) , i.e.,the NF Service Producer shall check the subject claim of CCA_NWDAF with the access token claim conveying the source NF Instance ID, when this claim is present in the access token.\n11.\tThe NF Service Producer(s) authenticates the NF Service Consumer and ensures that the source NF Service Consumer identity is included as an access token additional claim. The NF Service Producer authenticates and authorizes the DCCF following clauses 13.3.2 and 13.4.1. After authentication and authorization is successful, the NF Service Producer(s) executes the service.\nNOTE 5: Rel-16 NF Service Producer  only authenticates and authorizes the DCCF.\n12. The NF Service Producer(s) shall provide requested data to the DCCF.\n13. The DCCF forwards the received data to the NF Service Consumer(s).\nNOTE 6: In the case a new NF Service Consumer comes at a later stage to request the data, which is already being collected by DCCF, steps 1-10 apply. When the request is received by the NF Service Producer (i.e. the data producer), it authenticates the NF Service Consumer and verifies the access token provided along with the service request and sends to DCCF the access token verification response. DCCF based upon the response received, either updates the subscription info to include the new NF Service Consumer as well and sends the data to both the consumers (as specified in Clause 6.2.6.3.2 in TS 23.288 [105]), or in the case of access token verification failure, the DCCF rejects the request received by the NF Service Consumer.\nNOTE 7: Void\nX.3\tAuthorization of NF Service Consumers for data access via DCCF when notification sent via MFAF\nThe detailed procedure for NF Service Consumer to receive data from Service Producers via DCCF when notification is sent via MFAF is depicted in Figure X.3-1:\nThe figure depicts a simplified representation of the Service Consumer Authorization (SCA) process in the context of Multi-Access Edge Computing (MEC) and Federated Learning (FL). It illustrates the steps involved in obtaining data from Service Producers (SPs) and transmitting it to the Service Consumer (SC). The figure includes a Service Consumer (SC), Service Producer (SP), and a Service Consumer Authorization (SCA) process. The SC is authorized to receive data from SPs, while the SCA process ensures that the SC receives the necessary data. The figure also includes a Service Producer Authorization (SPA) process, which is used to authorize SPs to transmit data to the SC. The figure is a simplified representation and may not fully capture the complexity of the SCA process.\nFigure X.3-1: Service Consumer Authorization to receive data from Service Producers via MFAF\nSteps 1-9 are same as Steps 1 – 9 of Annex X.2.\n10-11. The DCCF sends an access token request to the NRF to request service from MFAF. NRF after verifying sends access_token_dccf to DCCF to consume the services of MFAF.\n12. DCCF shall then send the Nmfaf_3daDataManagement_Configure request to MFAF (as specified in the Clause 6.2.6.3.2 in TS 23.288[105]) along with the access_token_dccf.\nSteps 13 – 14 are same as Steps 10 – 11 of Annex X.2\n15. The NF Service Producer(s) shall provide requested data to the MFAF.\n16. The MFAF forwards the received data to the data consumer(s).\nNOTE 1: In the case a new data consumer comes at a later stage to request the data, which is already being collected by DCCF, steps 1-9 and 13 apply. When the request is received by the NF Service Producer (i.e. the data producer), it authenticates the NF Service Consumer and verifies the access token provided along with the service request and sends to DCCF the access token verification response. DCCF based upon the response received, either updates the subscription info at the MFAF to include the new data consumer as well and MFAF sends the data to both the consumers (as specified in Clause 6.2.6.3.2 in TS 23.288 [105]), or in the case of access token verification failure, the DCCF rejects the request received by the data consumer and does not update the subscription at the MFAF.\nNOTE 2: Void\nX.4\tSecurity protection of data via messaging framework\nThe transfer of the data between the data source and data consumer via the messaging framework shall be confidentiality, integrity, and replay protected.\nConfidentiality protection, integrity protection, and replay-protection shall be supported on the new interfaces between 3GPP entities and MFAF by reusing the existing security mechanism defined for SBA in Clause 13.\nX.5\tProtection of data transferred between AF and NWDAF\nAs specified in TS 23.288[105], the NWDAF may interact with an AF to collect data from UE Application(s) as an input for analytics generation. The AF can be in the MNO domain or an AF external to MNO domain. To enhance the 5GS to support collection and utilisation of UE related data for providing the inputs to generate analytics information (to be consumed by other NFs), the communication between AF and NWDAF needs to be secured.\nThe NWDAF interacts with the 5GC NFs and the AF using Service-based Interfaces. The existing 5G security mechanism can be reused for the transfer of UE data over the SBA interface between AF and NWDAF. When the AF is located in the operator’s network, the NWDAF uses Service-Based Interface as depicted in clause 13 to communicate with the AF directly. When the AF is located outside the operator’s network, the NEF is used to exchange the messages between the AF and the NWDAF. The security aspects of NEF is specified in clause 12.\nX.6\tProtection of UE data in transit between NFs\nAccording to clause 13.1.0, all network functions shall support mutually authenticated TLS and HTTPS. TLS shall be used for transport protection within a PLMN unless network security is provided by other means. Thus, communication between NFs is integrity, confidentiality and replay protected.\nNFs shall obtain an access token from NRF for requesting analytics from an analytics function or providing analytics data to the analytics function.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "X.7\tUser consent requirements",
            "description": "The user consent requirements for enablers of network automation shall comply with Annex V of the present document and TS 23.288 [105].\nFor scenarios where local regulations permit, for example vPLMN and hPLMN subject to the same regulatory requirements, the NWDAF shall be deemed to be the enforcement point and shall be subject to the requirement specified in Annex V.\nNOTE: \tDepending on the use case and the data source, the enforcement point could be the vNWDAF or the hNWDAF. This is however left to the involved PLMNs to determine.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "X.8\tProtection of data and analytics exchange in roaming case",
            "description": "",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": [
                {
                    "title": "X.8.1\tGeneral",
                    "description": "",
                    "summary": "",
                    "text_content": "The protection of data and analytics exchange in roaming case including authorization and anonymization of data/analytics:\n-\tAuthorization at data and analytics level is enforced by the roaming entry NWDAF producer. The parameters used by NWDAF service consumer to request/subscribe to the services provided by NWDAF producer are defined in TS 23.288 [105], clause 6.1.5. Accordingly, the operator authorization policies can be configured locally in the NWDAF producer.  Also, when the NWDAF in one PLMN requests an access token from the NRF in the peer PLMN, the access token request and the access token claims may contain the Analytics ID.\n-\tThe roaming entry NWDAF producer is responsible to control the amount of exposed data/analytics and to abstract or hide internal network aspects in the exposed data/analytics. The corresponding mechanisms used to restrict the data/analytics and/or anonymization are subject to the implementation.\n",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": []
                },
                {
                    "title": "X.8.2\tProcedure for protection of analytics exchange in roaming case",
                    "description": "",
                    "summary": "",
                    "text_content": "",
                    "tables": [],
                    "figures_meta_data": [],
                    "subsubsections": [
                        {
                            "title": "X.8.2.1\tPolicies configured locally in Roaming entry NWDAF producer",
                            "text_content": "The figure depicts a flowchart illustrating the process of data exchange between analytics and roaming entry in a network. It shows the steps involved in configuring policies locally in the roaming entry NWDAF, which is a crucial step in ensuring efficient data exchange and roaming capabilities.\nFigure X.8.2.1-1: Protection of analytics exchange when policies configured locally in Roaming entry NWDAF\nPre-requisites:\n-\tRoaming entry NWDAF producer, i.e. NWDAFp shall be pre-configured with a list of allowed analytics per PLMN.\n-\tIf token-based authorization is used, NWDAFc shall have acquired an access token from the PLMN2 to consume the services exposed in Nwdaf_RoamingAnalytics_Subscribe/Request APIs.\nStep 1: NWDAFc sends Nnwdaf_RoamingAnalytics_Subscribe/Request message to NWDAFp to request analytics.\nStep 2: The roaming entry NWDAFp shall verify the service request, including verifying token and the visited PLMN ID and determine whether the requested analytics are allowed to be exposed to NWDAFc in PLMN1 by pre-configured policies.\nStep 3: The roaming entry NWDAFp shall apply the security policies per consumer (PLMN) to the requested analytics and decide on their anonymization, restriction or desensitization based on operator’s policy.\nNOTE: The anonymization, restriction or desensitization mechanisms of analytics are left for implementation.\nStep 4: NWDAFp returns the requested and processed analytics to NWDAFc.\n",
                            "figures_meta_data": [],
                            "tables": []
                        },
                        {
                            "title": "X.8.2.2\tPolicies configured as extended claims in access token",
                            "text_content": "The figure depicts a flowchart illustrating the process of policy enforcement in an access token, with the policy configured as extended claims. The flowchart includes steps such as validation, enforcement, and notification, ensuring that the policy is enforced correctly.\nFigure X.8.2.2-1: Protection of analytics exchange when policies configured as extended claims in access token\nPre-requisite:\n-\tThe producer NRF has the NF profile of the NF Service Producer including the list of allowed Analytics ID(s) per PLMN. According to TS 29.510 [68] clause 5.2.1, the NF profile can be configured in the NRF by other means such as O&M.\nStep 1: NWDAFc sends an access token get request to the consumer NRF as specified in clause 13.4.1. The access token request may contain the Analytics ID.\nStep 2: vNRF forwards the token request message to hNRF as specified in clause 13.4.1.\nStep 3: The home network hNRF shall verify the access token get request as specified 13.4.1, and determine whether the requested analytics implied by the Analytics ID(s) can be obtained by the visited PLMN according to the allowed analytics ID(s) of the visited PLMN.\nStep 4: If the verification success, hNRF issues the token as specified in clause 13.4.1. The allowed Analytics ID(s) of the visited PLMN may be included in the token.\nStep 5: The vNRF forwards the Token_Get Response to NWDAFc as specified in clause 13.4.1.\nStep 6: If the requested analytics is within the claim of token, the NWDAFc sends Nnwdaf_RoamingAnalytics_Subscribe/Request with the issued token to NWDAFp.\nStep 7: The roaming entry NWDAFp verifies the service request, including verifying token as specified in clause 13.4.1, and whether the requested analytics is within the Analytics ID(s) in the token.\nStep 8: The roaming entry NWDAFp shall apply the security policies per consumer (PLMN) to the requested analytics and decide on their anonymization, restriction or desensitization based on operator’s policy.\nNOTE: The anonymization, restriction or desensitization mechanisms of data / analytics are left for implementation.\nStep 9: Roaming entry NWDAFp returns the requested and processed analytics to NWDAFc.\n",
                            "figures_meta_data": [],
                            "tables": []
                        }
                    ]
                }
            ]
        },
        {
            "title": "X.9\tAuthorization of selection of participant NWDAF instances in the Federated Learning group",
            "description": "The authorization for selecting participant NWDAF instances in the Federated Learning (FL) group uses token-based authorization as specified in clause 13.4.1, with the following additions.\nFigure X.9-1 depicts the authorization mechanism for NWDAF containing MTLF acting as FL Server to initiate the Federated Learning process on the NWDAF containing MTLF(s) acting as FL Client(s). The authorization is based upon the FL capability type (FL server or FL client) provided by the NWDAF containing MTLF acting as FL server during registration, and the Analytics ID and Interoperability Indicator per Analytics ID provided by the NWDAF containing MTLF acting as FL client during registration.\nEditor’s note: The use of Service area and Availability time requirement for authorization is FFS.\n\nThe figure depicts a flowchart illustrating the authorization process for selecting participant NWDAF instances in a FL (Federated Learning) system. The flowchart includes steps such as selecting the participant, defining the NWDAF instance, and selecting the learning algorithm. The figure provides a visual representation of the process, making it easier to understand and follow.\nFigure X.9-1: FL Authorization for selecting participant NWDAF instances\nStep 1a. The NWDAF containing MTLF acting as FL client registers to the NRF with its FL related information, including supported FL capability (FL client), Analytics ID(s) and Interoperability Indicator per Analytics ID as described in clause 5.2 of TS 23.288.\nStep 1b. The NWDAF containing MTLF acting as FL server registers to the NRF with its FL capability (FL Server).\nStep 2. The NWDAF containing MTLF acting as FL server (NF Service Consumer) sends a discovery request to NRF and receives the available NWDAFs containing MTLF acting as FL client(s) (NF Service Producer) as a response, as specified in clause 6.2C.2.1 of TS 23.288 [105].\nStep 3. The NWDAF containing MTLF acting as FL server (NF Service Consumer) sends an access token request to the NRF  as specified in clause 13.4.1. The access token request may contain the Analytics ID for the requested Federated Learning process.\nStep 4. The NRF authorizes the NWDAF containing MTLF acting as FL server (NF Consumer) based upon the information received in Step 1b, and after verifying that the Server NWDAF’s Vendor ID is included in the Interoperability Indicator for the requested Analytics ID provided in Step 1a. If the authorization succeeds, NRF generates the access token(s) as specified in clause 13.4.1. The access token claims may include the Analytics ID for the request Federated Learning process.\nNOTE: Fine-grained authorization can be done locally at the NWDAFs containing MTLF acting as FL client(s) (NF Service Producer).\nStep 5a, 5b. The NRF sends the access token to the NWDAF containing MTLF acting as FL Server, or rejects the request in case of failed authorization, as described in clause 13.4.1.\nStep 6. The NWDAF containing MTLF acting as FL server sends the service request to the NWDAF(s) containing MTLF acting as FL client with the access token received in Step 5a. along with the Analytics ID information for which the FL process is to be performed, as described in TS 23.288 [105].\nStep 7, 8. The NWDAF containing MTLF acting as FL client (NF Service Producer) verifies the received access token as specified in clause 13.4.1. In case of successful access token verification, the NWDAF containing MTLF acting as FL client sends a success response to the NWDAF containing MTLF acting as FL server, as described in TS 23.288 [105].\nStep 9. After a successful response from the NWDAF(s) containing MTLF acting as FL client, the NWDAF containing MTLF acting as FL server initiates the Federated Learning process as described in TS 23.288 [105].\nAuthorization of the NWDAF containing MTLF acting as FL client is implicit, since it can join a Federated Learning group only when selected by the NWDAF containing MTLF acting as FL server.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "X.10\tSecurity for AI/ML model storage and sharing",
            "description": "The detailed procedure for secured and authorized AI/ML model sharing between different vendors is depicted in Figure X.10-1:\nThe figure depicts a secure and authorized AI/ML model sharing platform, showcasing various vendors' AI/ML models. It highlights the importance of data security and privacy, as well as the need for vendor collaboration to ensure the model's effectiveness and reliability.\nFigure X.10-1: Secured and authorized AI/ML model sharing between different vendors\n\n0a. NF Service producer i.e. NWDAF containing MTLF registers its NF profile in the NRF with ML Model Interoperability indicator per Analytics ID as described in clause 5.2 of TS 23.288 [105]. The ML Model Interoperability indicator is a list of NWDAF providers (vendors) that are allowed to retrieve ML models from this NWDAF containing MTLF.\n0b. NF Service consumer e.g., NWDAF containing AnLF registers at the NRF including its Vendor ID,\n0c. The model is stored in encrypted format unless both the AI/ML model producer (NWDAF MTLF) and storage platform (ADRF) are part of the same system and belong to the same vendor and operator security domain.\nStorage of the model in encrypted format can be required by the trust model established to store and share AI/ML models. The trust model between AI/ML NF producer (NWDAF MTLF), storage platform (ADRF) and NF consumer (e.g., AnLF) is to be determined during the implementation phase among operator and the providers of the different platforms (MTLF, AnLF, ADRF). How the model is encrypted is vendor specific. Key distribution is not specified in this document.\n1. \tIf NWDAF containing MTLF determines to store ML model in ADRF, NWDAF containing MTLF triggers the Nadrf_MLModelManagement_StorageRequest as described in TS 23.288 [105], optionally including an allowed NFc list. The absence of allowed NFc list indicates that only the MTLF which stored the model is allowed to retrieve the model.\n2. \tADRF sends the response to NWDAF containing MTLF as described in TS 23.288 [105].\n3. \tNF Service consumer e.g., NWDAF containing AnLF performs Nnrf_NFDiscovery_Request operation with the requested Analytics ID to select a suitable NF Service Producer e.g., NWDAF containing MTLF.\n4a. NF Service consumer e.g., NWDAF containing AnLF requests an access token from the NRF using the Nnrf_AccessToken_Get request operation. The token request message contains, besides the parameters described in clause 13.4.1.1.2, the Vendor ID of NWDAF containing AnLF and the Analytics ID.\n4b. NRF checks whether the NWDAF containing AnLF is authorized to access the requested service in NWDAF containing MTLF and verifies that the NF Consumer's Vendor ID is included in the NWADF containing MTLF 's interoperability indicator for the Analytics ID and grants the token (token1), based on the vendor ID provided by the NF consumer during registration.\n5. \tNF Service Consumer performs Nnwdaf_MLModelProvision (Analytics ID, Vendor ID and token1) service operation at the NWDAF containing MTLF to retrieve ML models for the Analytics ID.\n6a. The NWDAF containing MTLF authenticates the NF Service Consumer and verifies the access token as specified in the clause 13.4.1.1.2 and ensures that the Analytics ID is included in the access token. If verification is successful, NWDAF containing MTLF determines the ML model to be shared for the requested Analytics ID and stored the NF instance ID of NWDAF containing AnLF as part of allowed NF instance list for the ML model.\n6b. If the determined ML model is stored in ADRF, and if the NF Service Consumer is not yet in the allowed NFc list stored at the ADRF, the NWDAF containing MTLF triggers the update of Nadrf_MLModelManagement_StorageRequest at the ADRF, with NF ID of NWDAF containing MTLF and Model ID, adding the NF Service Consumer to the allowed NFc list. The ADRF verifies that the requesting NWDAF containing MTLF is same as the one that stored the model. Then, ADRF stores the allowed NF instance list for the ML model referenced by the Model ID.\n6c. ADRF sends the response to NWDAF containing MTLF which contains Model ID.\nEditor's Note: How the AnLF retrieve the model via MTLF should be align with SA2 and the diagram should be update accordingly.\n7. NWDAF containing MTLF sends Nnwdaf_MLModelProvision Notify to the NF Service Consumer with Model ID, the address of the determined ML model, which can be either the one stored in NWDAF containing MTLF or in ADRF,or ADRF(set) ID.  If the address of the determined ML model is provided, steps 8a to 10 are skipped.\nIf theADRF(set) ID is provided , the following steps are applied:\n8a. NF Service Consumer requests an access token from the NRF to be authorized to retrieve the model stored in ADRF as specified in clause 13.4.1.\n8b. NRF verifies that the NF Service consumer e.g., NWDAF containing AnLF is authorized to access the service provided by the ADRF. If verification is successful, NRF grants the token (token2), based on the information provided in ADRF's NF profile.\n9.  NF Service consumer e.g., NWDAF containing AnLF requests to retrieve the target model by sending   Nadrf_MLModelManagement_Retrieval Request as described in clause 10.3.4 TS 23.288 [105], including token2.\n10. ADRF authenticates the NF Service Consumer and verifies the access token (token2) as specified in the clause 13.4.1.1.2. ADRF verifies also the NF Service Consumer’s NF ID is included in the allowed NF instance list for the ML model and/or is same as the NF ID of the MTLF that stored the model. If verification is successful, ADRF sends Nadrf_MLModelManagement_Retrieval  Response to the NF Service Consumer, which contains the address of the stored model in ADRF.\n11. NF Service Consumer retrieves the ML model from NWDAF containing MTLF or ADRF based on the ML model file address and decrypts the model per the vendor’s  implementation.\nNOTE:\tAs per TS 23.288 [105] clause 10.3.2, how the NF Service Consumer downloads the ML Model is left for implementation.\n\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Y.1\tGeneral",
            "description": "This Annex specifies the security aspects of Message Service for MIoT over the 5G System (MSGin5G). The general features of MSGin5G are described in 23.554 [106], 22.262 [107].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Y.2\tAuthentication and authorization between MSGin5G client and MSGin5G Server",
            "description": "The Authentication and authorization between MSGin5G Client and MSGin5G Server shall be based on AKMA, which is specified in TS 33.535 [91]. Before initiating communication with MSGin5G Server, the UE needs to have performed primary authentication and registered with the 5GC, resulting in the successful generation of KAKMA and A-KID at both MSGin5G Client and the 5GC as specified in clause 6.1, TS 33.535 [91].\nOnce the UE is registered in 5GC, the MSGin5G Client in the UE and the MSGin5G Server may use TLS for authentication as specified in Annex B of TS 33.535 [91] with the MSGin5G Server taking the role of AKMA AF.\nMethods other than TLS with AKMA may be used for authentication between the MSGin5G Client and MSGin5G Server, depending on the Ua* protocols.\nWhen MSGin5G service is used with SEAL, the application architecture described in TS 23.554 [106] is followed. In this case, authorization of the MSGin5G UE by the MSGin5G server is performed by validating the association between the UE service ID and UE ID (SUPI/GPSI). The UE service ID is acquired via the MSGin5G registration request, as specified in TS 23.554 [106]. The Configuration Management server or MSGin5G Configuration Function maintains association of the assigned UE service ID with the UE ID. The MSGin5G server retrieves the association from the Configuration Management server or MSGin5G Configuration Function using the UE ID received from the AAnF and verifies whether the UE service ID received in the registration request message is associated with the UE ID in the retrieved association information.\nFor constrained UE, the Gateway/Proxy UE shall perform authentication and authorization on behalf of the constrained UE with MSgin5G Server based on AKMA as specified above.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Y.3\tTransport security protection for MSGin5G interfaces",
            "description": "The MSGin5G-1 interface may be protected by TLS based on KAF established by AKMA as specified in TS 33.535 [91]. The MSGin5G Client and the MSGin5G Server establish the TLS session following the procedures defined in Annex B of TS 33.535 [91].\nThe MSGin5G-1 interface may be protected using mechanisms other than TLS with AKMA, depending on the Ua* protocols.\nFor the data protection over MSGin5G-3 interface between MSGin5G Server and Application Server, if the Application Server is inside the operator domain, the transport security protection on SBI interface shall be reused as specified in clause 13. If the Application Server is outside the operator domain, the Application Server shall connect to the MSGin5G Server via NEF, clause 12.3 in the present document is applicable with the Appplication Server taking the role of the AF.\nFor MSGin5G-2, MSGin5G-4 and MSGin5G-7 interfaces, TLS shall be used for transport protection unless network security is provided by other means.\nThe interconnection between the two MSGin5G Servers shall be protected by TLS as specified in TS 33.210 [3].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Y.4\tAuthentication and Authorization between Application Server and MSGin5G Server",
            "description": "The authentication and authorization between Application Server and MSGin5G is based on the transport security protection. TLS should be used as specified in TS 33.210 [3].\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Y.5\tAuthentication and Authorization between message Gateway and MSGin5G Server",
            "description": "The authentication and authorization between Message Gateway and the MSGin5G Server can reuse the authentication and authorization between network functions in 13.3.2 in this document.\nIn direct communication, authentication between message gateway and MSGin5GServer shall use one of the following methods:\n-\tIf the PLMN uses protection at the transport layer as described in clause 13.1, authentication provided by the transport layer protection solution shall be used for authentication between message gateway and MSGin5GServer.\n-\tIf the PLMN does not use protection at the transport layer, authentication between message gateway and MSGin5GServer may be implicit by NDS/IP or physical security.\nIf the PLMN uses token-based authorization, the network shall use protection at the transport layer as described in clause 13.1.\nIn indirect communication scenarios, 13.3.2 in this document also applies.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Z.1\t\tGeneral",
            "description": "This annex describes the authentication procedure for AUN3 devices behind 5G-RG in private networks or in isolated deployment scenarios (i.e., roaming is not supported) using any key generating EAP method.\nNOTE: if EAP-AKA’ and 3GPP credentials are used, the storage of 3GPP credentials is defined in clause 6.\nAn AUN3 device may be authenticated by the 5GC or a Credential Holder using a AAA server.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Z.2\tAuthentication of AUN3 devices by 5GC",
            "description": "\nThe figure depicts the authentication procedure for AUN3 devices by 5GC using the key-generating EAP method. It illustrates the steps involved in authenticating devices, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method, which is a secure method for exchanging authentication keys between devices. The figure also shows the steps for generating the key, including the use of a key-generating EAP method,\nFigure Z.2-1 Authentication Procedure for AUN3 devices by 5GC using key-generating EAP method\nThis authentication procedure is based on clause 7B.7.3 but differs in some steps.\nSteps 1-6 are the same as steps 1-6 in clause 7B.7.3.\n7.  Upon reception of the Nudm_UEAuthentication_Get Request, the UDM shall invoke the SIDF to map the SUCI to the SUPI and select an authentication method based on the SUPI and the AUN3 device indicator. When the \"username\" part of the SUPI is \"anonymous\" or omitted, the UDM may select an authentication method based on the “realm” part of the SUPI, the AUN3 device indicator, a combination of the \"realm\" part and the AUN3 device indicator, or the UDM local policy. When EAP-AKA´ authentication method is selected, the UDM/ARPF shall generate an authentication vector using the Access Network Identity as the KDF input parameter.\n8. The UDM shall send to the AUSF a Nudm_UEAuthentication_Get Response message, including the SUPI and EAP-AKA’ authentication vector if EAP-AKA’ is selected or the selected authentication method if other key generating EAP method (e.g., EAP-TLS, EAP-TTLS, etc) is selected. According to the AUN3 subscription data, the UDM shall also send the MSK indicator to AUSF.\n9. The AUN3 device and the AUSF perform the selected EAP authentication method.\nSteps 10-15 are the same as steps 17-22 in clause 7B.7.3.\n",
            "summary": "",
            "tables": [],
            "figures_meta_data": [],
            "subsections": []
        },
        {
            "title": "Z.3\tAuthentication of AUN3 devices by AAA server",
            "description": "The figure depicts the authentication procedure for AUN3 devices by AAA using the key-generating EAP method. It illustrates the steps involved in authenticating devices using the EAP method, which is a key-generating method used in the AUN3 protocol. The figure shows the authentication process, including the generation of a key, the use of the key to encrypt the authentication request, and the decryption of the encrypted request to verify the authenticity of the device. The figure is important for understanding the authentication process in AUN3 devices and for implementing the EAP method in a secure manner.\nFigure Z.3-1 Authentication Procedure for AUN3 devices by AAA using key-generating EAP method\nThis authentication procedure is based on clause 7B.7 and I.2.2.2.2.\nSteps 1-6 are the same as steps 1-6 in clause 7B.7.\nSteps 7-16 are the same as steps 4-13 in clause I.2.2.2.2.\nSteps 17-22 are the same as steps 17-22 in clause 7B.7.\n\n\n",
            "summary": "",
            "tables": [
                {
                    "description": "",
                    "table number": 13,
                    "summary": "",
                    "name": ""
                }
            ],
            "figures_meta_data": [],
            "subsections": []
        }
    ]
}